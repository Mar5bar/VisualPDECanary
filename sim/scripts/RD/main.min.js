import{drawShaderTop as e,drawShaderBotReplace as t,drawShaderBotAdd as n,drawShaderShapeDisc as i,drawShaderShapeVLine as o,drawShaderShapeHLine as a,drawShaderFactorSharp as r,drawShaderFactorSmooth as s}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as l,computeDisplayFunShaderMid as u,postGenericShaderBot as c,postShaderDomainIndicator as d,interpolationShader as h}from"./post_shaders.js";import{copyShader as f}from"../copy_shader.js";import{RDShaderTop as m,RDShaderBot as p,RDShaderDirichletX as g,RDShaderDirichletY as b,RDShaderDirichletIndicatorFun as v,RDShaderRobinX as w,RDShaderRobinY as _,RDShaderRobinCustomDomainX as y,RDShaderRobinCustomDomainY as S,RDShaderUpdateNormal as C,RDShaderUpdateCross as D,RDShaderAlgebraicSpecies as x,RDShaderEnforceDirichletTop as F,RDShaderAdvectionPreBC as E,RDShaderAdvectionPostBC as T,RDShaderDiffusionPreBC as A,RDShaderDiffusionPostBC as P,RDShaderGhostX as V,RDShaderGhostY as k,RDShaderMain as U}from"./simulation_shaders.js";import{randShader as q,randNShader as M}from"../rand_shader.js";import{fiveColourDisplayTop as R,fiveColourDisplayBot as I,embossShader as L,contourShader as N,surfaceVertexShaderColour as B,surfaceVertexShaderCustom as O,overlayShader as W}from"./display_shaders.js";import{getColours as j}from"../colourmaps.js";import{genericVertexShader as Q}from"../generic_shaders.js";import{getPreset as z,getUserTextFields as G,getFieldsInView as H,getListOfPresets as Y,getOldPresetFieldsToNew as J,getListOfPresetNames as X}from"./presets.js";import{clearShaderBot as Z,clearShaderTop as K}from"./clear_shader.js";import*as ee from"../three.module.min.js";import{OrbitControls as te}from"../OrbitControls.js";import{Line2 as ne}from"../lines/Line2.js";import{LineMaterial as ie}from"../lines/LineMaterial.js";import{LineGeometry as oe}from"../lines/LineGeometry.js";import{minifyPreset as ae,maxifyPreset as re}from"./minify_preset.js";import{LZString as se}from"../lz-string.min.js";import{equationTEXFun as le,getDefaultTeXLabelsDiffusion as ue,getDefaultTeXLabelsReaction as ce,getDefaultTeXLabelsBCsICs as de,substituteGreek as he}from"./TEX.js";import{closestMatch as fe}from"../../../assets/js/closest-match.js";!async function(){let me,pe,ge,be,ve,we,_e,ye,Se,Ce,De,xe,Fe,Ee,$e,Te,Ae,Pe,Ve,ke,Ue,qe,Me,Re,Ie,Le,Ne,Be,Oe,We,je,Qe,ze,Ge,He,Ye,Je,Xe,Ze,Ke,et,tt,nt,it,ot,at,rt,st,lt,ut,ct,dt,ht,ft,mt,pt,gt,bt,vt,wt,_t,yt,St,Ct,Dt,xt,Ft,Et,$t,Tt,At,Pt,Vt,kt=[],Ut={},qt=[],Mt=[],Rt=[],It=new Set,Lt=!0,Nt=!1,Bt=!0,Ot=!0,Wt=!1,jt=!1,Qt=!1,zt=!1,Gt=!1,Ht=!1,Yt=0,Jt=performance.now(),Xt=!1,Zt=!0,Kt=1,en=1,tn=.15,nn={},on=[],an={},rn=0;const sn="GrayScott",ln=["u","v","w","q"],un=["UFUN","VFUN","WFUN","QFUN"],cn=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"];let dn,hn,fn,mn,pn,gn,bn,vn=!1,wn=!1;const _n=["zero","one","two","three","four","five","six","seven","eight","nine"];let yn,Sn,Cn,Dn=le(),xn={...ue(),...ce(),...de()};const Fn=H();let En=new exprEval.Parser;En.consts.pi=Math.PI,En.consts.Pi=Math.PI,En.consts.e=Math.exp(1),tt={};const $n=G();var Tn,An;it={reset:function(){si()},toggleRunning:function(){gt?ai():ri()},copyConfigAsURL:function(){ba(ga())},saveSimState:function(){No()},exportSimState:function(){Bo()},clearCheckpoints:function(){Ht&&(Te.dispose(),Te=null,Ht=!1)}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(Tn=Array.prototype.push,An=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,Tn.apply(this,An.call(this,0,e)),this}),me=document.getElementById("simCanvas"),console.error=function(e){zt=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),zo(t.toString().trim()+". Click <a href='/user-guide/FAQ#undeclared' target='blank'>here</a> for more information.")},zi()||$("#logo").hide();const Pn=new URLSearchParams(window.location.search);Pn.has("no_ui")?($(".ui").addClass("hidden"),Gt=!0):$(".ui").removeClass("hidden");const Vn=Pn.has("logo_only");Vn&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),Gt=!0),Pn.has("sf")&&(en=parseFloat(Pn.get("sf")),(isNaN(en)||en<=0)&&(en=1)),gi("default"),function(){nt={brushCoords:{type:"v2",value:new ee.Vector2(.5,.5)},colour1:{type:"v4",value:new ee.Vector4(0,0,0,0)},colour2:{type:"v4",value:new ee.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new ee.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new ee.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new ee.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},overlayLine:{type:"bool",value:!0},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},vectorField:{type:"bool",value:!1}},bt=!1,De=new ee.Raycaster,xe=new ee.Vector2,ye=new ee.WebGLRenderer({canvas:me,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),ye.autoClear=!0,pe=ye.getContext(),Tt=pe.getParameter(pe.MAX_TEXTURE_SIZE),ge=!(pe.getExtension("OES_texture_float_linear")&&pe.getExtension("EXT_float_blend")),$e={format:ee.RGBAFormat,type:ee.FloatType,minFilter:ee.NearestFilter},ge|=/android/i.test(navigator.userAgent),$e.magFilter=ge?ee.NearestFilter:ee.LinearFilter,kt.push(new ee.WebGLRenderTarget(tt.maxDisc,tt.maxDisc,$e)),kt.push(kt[0].clone()),kt.push(kt[0].clone()),kt.push(kt[0].clone()),kt.push(kt[0].clone()),Fe=kt[0].clone(),Ee=kt[0].clone(),kt.forEach((e=>{e.texture.wrapS=ee.RepeatWrapping,e.texture.wrapT=ee.RepeatWrapping})),Fe.texture.wrapS=ee.ClampToEdgeWrapping,Fe.texture.wrapT=ee.ClampToEdgeWrapping,Ee.texture.wrapS=ee.ClampToEdgeWrapping,Ee.texture.wrapT=ee.ClampToEdgeWrapping,be=new ee.OrthographicCamera(-.5,.5,.5,-.5,-1,10),Ce=new te(be,me),Ce.listenToKeyEvents(document),Ce.addEventListener("change",(function(){"surface"==tt.plotType&&(tt.cameraTheta=90-180*Math.acos(be.position.y)/Math.PI,tt.cameraPhi=-180*Math.atan2(be.position.x,be.position.z)/Math.PI,tt.cameraZoom=be.zoom,Ko("cameraTheta"),Ko("cameraPhi"),Ko("cameraZoom"),bi(st),Da())})),ve=new ee.OrthographicCamera(-.5,.5,.5,-.5,-1,10),ve.position.z=1,we=new ee.Scene,_e=new ee.Scene,we.add(be),we.background=new ee.Color(tt.backgroundColour),Ae=new ee.MeshBasicMaterial({side:ee.DoubleSide}),Pe=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q(),transparent:!0,side:ee.DoubleSide}),Me=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q()}),Ne=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q(),fragmentShader:h()}),Ve=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q()}),Ut.FE=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q()}),Ut.AB2=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q()});for(let e=1;e<3;e++)Ut["Mid"+e.toString()]=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q()});for(let e=1;e<5;e++)Ut["RK4"+e.toString()]=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q()});qe=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q(),fragmentShader:f()}),Ue=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q()}),ke=new ee.ShaderMaterial({uniforms:nt,vertexShader:Q()}),Re=new ie({vertexColors:!0,linewidth:.01}),Ie=new ie({color:0,linewidth:.01}),Le=new ee.MeshBasicMaterial({color:tt.arrowColour,side:ee.DoubleSide}),Be=new ee.MeshBasicMaterial,Oe=new ee.CylinderGeometry(.008,.008,.1),We=new ee.ConeGeometry(.04,.04,4);const e=new ee.PlaneGeometry(1,1);Qe=new ee.Mesh(e,Ut[0]),Qe.position.z=0,Qe.matrixWorldAutoUpdate=!1,_e.add(Qe),Wn(),jn(),Nn(),zn(),In(),Gn(),ki(),qi(),Yn(),Hn(),Di(),so(),si(),me.addEventListener("pointerdown",ei),me.addEventListener("pointerup",ti),me.addEventListener("pointermove",ni),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(it.toggleRunning(),e.preventDefault()),"h"===e.key&&(Gt?(Gt=!1,$(".ui").removeClass("hidden"),ft.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",St),gt?ri():ai(),ro(),go(),Fo()):(Gt=!0,$(".ui").addClass("hidden"))),"s"==e.key&&No(),"c"==e.key&&(tt.resetFromCheckpoints=!tt.resetFromCheckpoints,xa($("#checkpointButton")[0])))})),window.addEventListener("resize",(function(){In(),Da()}),!1),window.addEventListener("message",va),$("#checkpointInput").change((function(){Oo(this.files[0]),this.value=null}))}();let kn=!0;if(Pn.has("preset")&&(pi(Pn.get("preset")),kn=!1),Pn.has("options")){var Un=JSON.parse(se.decompressFromEncodedURIComponent(Pn.get("options")));Un.hasOwnProperty("p")&&(Un=re(Un)),pi(Un),kn=!1}kn&&pi(sn),Wt=Pn.has("story"),Wt&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),ft.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),Yi(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#play_pause_placeholder").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),St=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),$("#settings").click((function(){ca(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&fa(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&ma(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&da(),$("#views_ui").is(":visible")&&ha()),$("#left_ui").is(":visible")&&Fo()})),$("#equations").click((function(){da(),Fo(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&ca(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&ha()})),$("#pause").click((function(){ai()})),$("#play").click((function(){ri()})),$("#erase").click((function(){si()})),$("#share").click((function(){ma(),$("#help_panel").is(":visible")&&fa()})),$("#help").click((function(){fa(),$("#share_panel").is(":visible")&&ma()})),$("#screenshot").click((function(){vn=!0,Zn(),ma()})),$("#link").click((function(){it.copyConfigAsURL(),ma()})),$("#embed").click((function(){!function(){let e=ga();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}ba('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),ma()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){fa()})),$("#views").click((function(){ha(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&ca(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&da()})),$("#error_close_button").click((function(){Hi("#error")})),$("#preset_error_close_button").click((function(){Hi("#error")})),$("#oops_hit_nan_close").click((function(){Hi("#oops_hit_nan"),Ot=!0})),$("#start_tour").click((function(){$("#welcome").css("display","none"),qn.start()})),$(document).on("click","#add_view",(function(){!function(){let e=Zo();e.name=++Yt,tt.views.push(e),tt.activeViewInd=tt.views.length-1,Ho()}()}));const qn=new Shepherd.Tour({useModalOverlay:!0,defaultStepOptions:{classes:"shadow-md bg-purple-dark",scrollTo:!1,cancelIcon:{enabled:!0},buttons:[{action(){return this.back()},classes:"shepherd-button-secondary",text:"Back"},{action(){return this.next()},text:"Next"}],when:{show(){La()}}}});let Mn="Interactivity is at the heart of VisualPDE. In most simulations, clicking on the screen allows you to interact directly with the solution.<br><video autoplay loop playsinline muted disableRemotePlayback poster=\"../assets/images/demo.webp\" width=\"128\" style=\"margin-top:10px\"><source src='../assets/ani/demo.mp4' type='video/mp4'><source src='../assets/ani/demo.webm' type='video/webm'></video><br>This can even kickstart pattern formation or other exciting phenomena.";pa()&&(Mn=Mn.replaceAll("clicking","tapping"),Mn=Mn.replaceAll("click","tap"),Mn=Mn.replaceAll("Clicking","Tapping"),Mn=Mn.replaceAll("Click","Tap")),qn.addStep({title:"Playing with PDEs",text:Mn,buttons:[{action(){return this.next()},text:"Next"}]}),qn.addStep({title:"Equations and definitions",text:"Customise the equations, parameters, boundary and initial conditions of the simulation.<br><video autoplay loop playsinline muted disableRemotePlayback width=\"216\" style=\"margin-top:10px\"><source src='../assets/ani/params.mp4' type='video/mp4'><source src='../assets/ani/params.webm' type='video/webm'></video>",attachTo:{element:"#equations",on:"right"},when:{show(){La(),Na("/user-guide/advanced-options.html#equations")}}}),qn.addStep({title:"Play/pause",text:"Play or pause the simulation. You can still draw when paused.",attachTo:{element:"#play_pause_placeholder",on:"right"}}),qn.addStep({title:"Reset",text:"Click to restart the simulation. You can change the initial conditions in the equations menu.",attachTo:{element:"#erase",on:"right"},when:{show(){La(),Na("/user-guide/advanced-options.html#checkpoints","Advanced")}}}),qn.addStep({title:"Views",text:"The Views menu lets you customise your view of the solution. This includes everything from contours to colour bars.<br><div class=views_pics><img src='../assets/images/FHNTuringWave.webp'><img src='../assets/images/midnight_soliton.webp'><img src='../assets/images/complexGinzburgLandau.webp'></div>",attachTo:{element:"#views",on:"right"},when:{show(){La(),Na("/user-guide/advanced-options.html#views")}}}),qn.addStep({title:"Settings",text:"Tweak advanced options such as the equation type, the domain resolution and the timestepping scheme.",attachTo:{element:"#settings",on:"right"},when:{show(){La(),Na("/user-guide/advanced-options.html#settings")}}}),qn.addStep({title:"Sharing",text:"VisualPDE is built for sharing. Copy a link that leads straight to the current simulation, download snapshots of your solution or even embed your simulation in your own site.",attachTo:{element:"#share",on:"right"},when:{show(){La(),Na("/user-guide/FAQ.html#sharing")}}}),qn.addStep({title:"Help",text:"Help is always at hand. Access FAQs, detailed documentation and guides explaining how to do everything that's possible in VisualPDE. You can even restart this tour.",attachTo:{element:"#help",on:"right"},buttons:[{action(){return this.back()},classes:"shepherd-button-secondary",text:"Back"},{action(){return this.complete()},text:"Finish"}]});const Rn=!(Wt||Gt);if((!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("visited"==e[t].split("=")[0].trim())return!0}return!1}()||Rn&&!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("seenFullWelcome"==e[t].split("=")[0].trim())return!0}return!1}())&&"Banner"!=tt.preset&&!Vn){let e=gt;ai();let t="welcome_no";Rn||($("#tour_question").hide(),$("#lets_go_cont").show(),t="lets_go"),$("#welcome").css("display","block");const n=await Promise.race([uo(document.getElementById("welcome_ok"),"click",!0),uo(document.getElementById(t),"click",!1)]);$("#welcome").css("display","none"),function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="visited=true;"+t+";path=/"}(),Rn&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="seenFullWelcome=true;"+t+";path=/"}(),n&&await new Promise((function(e){["complete","cancel"].forEach((function(t){Shepherd.once(t,(()=>e()))})),qn.start()})),$("#help").is(":visible")&&($("#get_help").fadeIn(1e3),setTimeout((()=>$("#get_help").fadeOut(1e3)),4e3)),e&&ri()}function In(){Wn(),function(){Qe.material=qe;for(let e=1;e<kt.length;e++)nt.textureSource.value=kt[e].texture,kt[e-1].setSize(Dt,xt),ye.setRenderTarget(kt[e-1]),ye.render(_e,ve);kt.rotate(-1),kt[0].dispose(),kt[0]=kt[1].clone(),Fe.setSize(Dt,xt),Kn(),Ee.setSize(Math.round(devicePixelRatio*At),Math.round(devicePixelRatio*Pt))}(),Wo(Te),Bn(),Ln(),Va(),Nn(),go(),Fo()}function Ln(){je.geometry.dispose(),we.remove(je),ze.geometry.dispose(),we.remove(ze),Ge.geometry.dispose(),we.remove(Ge),He.geometry.dispose(),we.remove(He),jn()}function Nn(){switch(On(),tt.plotType){case"line":Ce.enabled=!1,be.zoom=1,po(),Pe.vertexShader=B();break;case"plane":Ce.enabled=!1,Ce.reset(),Pe.vertexShader=Q();break;case"surface":Ce.enabled=!0,be.zoom=tt.cameraZoom,po(),Ea()}Pe.needsUpdate=!0,be.left=-Ft/(2*$t),be.right=Ft/(2*$t),be.top=Et/(2*$t),be.bottom=-Et/(2*$t),be.updateProjectionMatrix(),Qn()}function Bn(){nt.L.value=Kt,nt.L_y.value=Et,nt.L_x.value=Ft,nt.L_min.value=Math.min(Et,Ft),nt.dt.value=tt.dt,nt.dx.value=Ct,nt.dy.value=Ct,nt.heightScale.value=tt.threeDHeightScale,nt.maxColourValue.value=tt.maxColourValue,nt.minColourValue.value=tt.minColourValue,nt.customSurface.value=tt.customSurface,nt.vectorField.value=tt.vectorField,wa(),Ci()}function On(){try{Kt=En.evaluate(tt.domainScale)}catch(e){zo("Unable to evaluate the domain length. Please check the definition."),Kt=100}At=Math.round(me.getBoundingClientRect().width),Pt=Math.round(me.getBoundingClientRect().height),Se=Pt/At,Se<=0&&(Se=.1),Se>=1?(Et=Kt,Ft=Et/Se):(Ft=Kt,Et=Ft*Se),1==tt.dimension&&(Ft=Kt),nt.L_x.value=Ft,nt.L_y.value=Et,$t=Math.max(Ft,Et)}function Wn(){On(),Ct=Kt/100;try{Ct=En.evaluate(tt.spatialStep)}catch(e){zo("Unable to evaluate the spatial step. Please check the definition.")}Ct<=0&&(zo("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),Ct=Kt/100),Dt=Math.floor(Ft/Ct),xt=Math.floor(Et/Ct),(Dt>Tt||xt>Tt)&&(zo("Your device does not support a discretisation this fine (maximum "+Tt+"). Please increase the space step to at least "+(Math.ceil(1e4*Kt/Tt)/1e4).toPrecision(4)+" or reduce the domain size to at most "+(Math.floor(1e4*Tt*Ct)/1e4).toPrecision(4)+"."),Dt=Math.min(Dt,Tt),xt=Math.min(xt,Tt)),0==Dt&&(Dt=1),0==xt&&(xt=1),1==tt.dimension&&(xt=1),nt.nXDisc.value=Dt,nt.nYDisc.value=xt,Ye=new Array(Dt),Je=new Array(Dt);let e=-.5,t=Dt>1?1/(Dt-1):.5;for(let n=0;n<Ye.length;n++)Ye[n]=e,e+=t;Ye=Ye.map((e=>e*Ft/$t)),Qo(),pn=new Float32Array(Dt*xt*4),wn=!1}function jn(){On();let e=[1,1];Zt||(e=[Dt,xt]);const t=new ee.PlaneGeometry(Ft/$t,Et/$t,e[0],e[1]);je=new ee.Mesh(t,Pe),je.position.z=0,je.visible="line"!=tt.plotType,je.matrixAutoUpdate=!1,we.add(je);const n=new ee.PlaneGeometry(Ft/$t,Et/$t,1,1);ze=new ee.Mesh(n,Ae),ze.position.z=0,ze.visible=!1,ze.matrixAutoUpdate=!1,we.add(ze),Qn();const i=new oe;Xe=Math.round(2*devicePixelRatio*At);const o=new Array(3*Xe).fill(0),a=new Array(o.length).fill(0);i.setPositions(o),i.setColors(a),Ge=new ne(i,Re),Ge.scale.set(1,1,1),Ge.visible="line"==tt.plotType,we.add(Ge);const r=new oe,s=new Array(3*Xe).fill(0);r.setPositions(s),He=new ne(r,Ie),He.scale.set(1,1,1),He.visible="line"==tt.plotType&&tt.overlay,we.add(He)}function Qn(){switch(tt.plotType){case"plane":je.rotation.x=0,ze.rotation.x=0;break;case"surface":je.rotation.x=-Math.PI/2,ze.rotation.x=-Math.PI/2}je.updateMatrix(),ze.updateMatrix()}function zn(){tt.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Gn(e){at=new dat.GUI({closeOnTop:!0,autoPlace:!1}),at.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(at.domElement),rt=new dat.GUI({closeOnTop:!0,autoPlace:!1}),rt.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(rt.domElement),st=new dat.GUI({closeOnTop:!0,autoPlace:!1}),st.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(st.domElement),at.open(),rt.open(),st.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),lt=rt.addFolder("Brush");ra(oa(lt),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',Ra,null,"Toggle the brush on or off"),qt.brushAction=lt.add(tt,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange((function(){Yn(),document.activeElement.blur()})),qt.brushType=lt.add(tt,"brushType",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange((function(){Yn(),document.activeElement.blur()})),lt.add(tt,"brushValue").name("Value").onFinishChange(Yn),lt.add(tt,"brushRadius").name("Radius").onFinishChange(Yn),qt.whatToDraw=lt.add(tt,"whatToDraw",yn).name("Species").onChange(Yn),lt=rt.addFolder("Domain"),lt.add(tt,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){mo(),document.activeElement.blur(),Da()})),lt.add(tt,"domainScale").name("Largest side").onFinishChange((function(){In(),Da()})),lt.add(tt,"spatialStep").name("Space step").onFinishChange((function(){In(),Da()})),lt.add(tt,"minX").name("Min. $x$").onFinishChange((function(){qi(),si()})),qt.minY=lt.add(tt,"minY").name("Min. $y$").onFinishChange((function(){qi(),si()}));const t=oa(lt);ra(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){zn(),In(),Nn(),Da()}),null,"Use a square domain"),ra(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Custom',(function(){Ui(),ki(),hi(),Pi(),Da()}),null,"Specify a custom domain"),qt.domainIndicatorFun=lt.add(tt,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){Ui(),ki(),hi(),$i(),Da()})),lt=rt.addFolder("Timestepping"),qt.numTimestepsPerFrame=lt.add(tt,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),_a(qt.numTimestepsPerFrame,1,400,1),qt.dt=lt.add(tt,"dt").name("Timestep").onChange((function(){Bn()})),qt.dt.__precision=12,qt.dt.min(0),qt.dt.updateDisplay(),lt.add(tt,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme").onChange((function(){document.activeElement.blur()}));const n=oa(lt);ra(n,"timeDisplay",'<i class="fa-regular fa-hourglass-half"></i> Elapsed time',Ki,null,"Show/hide time display"),ra(n,"autoPause",'<i class="fa-regular fa-hourglass-end"></i> Auto pause',(function(){Bt=nt.t.value<tt.autoPauseAt,ki()}),null,"Toggle automatic pausing"),qt.autoPauseAt=lt.add(tt,"autoPauseAt").name("Pause at $t=$").onFinishChange((function(){Bt=nt.t.value<tt.autoPauseAt,qt.autoPauseAt.domElement.blur()})),lt=rt.addFolder("Equations"),lt.add(tt,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange((function(){document.activeElement.blur(),qi(),si()})),qt.algebraicSpecies=lt.add(tt,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Xt=!0,qi(),Xt=!1,si()})),lt.add(tt,"speciesNames").name("Species names").onFinishChange((function(){Ao()}));ra(oa(lt),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',(function(){qi()}),"cross_diffusion_controller","Toggle cross diffusion"),lt=at.addFolder("Definitions");ra(oa(lt),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',Mi,null,"Typeset the specified equations"),qt.Duu=lt.add(tt,"diffusionStr_1_1").onFinishChange((function(){hi(),Mi()})),Mo(qt.Duu,Io,["U","UU"]),Ro(qt.Duu,Lo,["U","UU"]),qt.Duv=lt.add(tt,"diffusionStr_1_2").onFinishChange((function(){hi(),Mi()})),Mo(qt.Duv,Io,["UV"]),Ro(qt.Duv,Lo,["UV"]),qt.Duw=lt.add(tt,"diffusionStr_1_3").onFinishChange((function(){hi(),Mi()})),Mo(qt.Duw,Io,["UW"]),Ro(qt.Duw,Lo,["UW"]),qt.Duq=lt.add(tt,"diffusionStr_1_4").onFinishChange((function(){hi(),Mi()})),Mo(qt.Duq,Io,["UQ"]),Ro(qt.Duq,Lo,["UQ"]),qt.Dvu=lt.add(tt,"diffusionStr_2_1").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dvu,Io,["VU"]),Ro(qt.Dvu,Lo,["VU"]),qt.Dvv=lt.add(tt,"diffusionStr_2_2").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dvv,Io,["V","VV"]),Ro(qt.Dvv,Lo,["V","VV"]),qt.Dvw=lt.add(tt,"diffusionStr_2_3").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dvw,Io,["VW"]),Ro(qt.Dvw,Lo,["VW"]),qt.Dvq=lt.add(tt,"diffusionStr_2_4").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dvq,Io,["VQ"]),Ro(qt.Dvq,Lo,["VQ"]),qt.Dwu=lt.add(tt,"diffusionStr_3_1").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dwu,Io,["WU"]),Ro(qt.Dwu,Lo,["WU"]),qt.Dwv=lt.add(tt,"diffusionStr_3_2").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dwv,Io,["WV"]),Ro(qt.Dwv,Lo,["WV"]),qt.Dww=lt.add(tt,"diffusionStr_3_3").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dww,Io,["W","WW"]),Ro(qt.Dww,Lo,["W","WW"]),qt.Dwq=lt.add(tt,"diffusionStr_3_4").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dwq,Io,["WQ"]),Ro(qt.Dwq,Lo,["WQ"]),qt.Dqu=lt.add(tt,"diffusionStr_4_1").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dqu,Io,["QU"]),Ro(qt.Dqu,Lo,["QU"]),qt.Dqv=lt.add(tt,"diffusionStr_4_2").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dqv,Io,["QV"]),Ro(qt.Dqv,Lo,["QV"]),qt.Dqw=lt.add(tt,"diffusionStr_4_3").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dqw,Io,["QW"]),Ro(qt.Dqw,Lo,["QW"]),qt.Dqq=lt.add(tt,"diffusionStr_4_4").onFinishChange((function(){hi(),Mi()})),Mo(qt.Dqq,Io,["Q","QQ"]),Ro(qt.Dqq,Lo,["Q","QQ"]),qt.f=lt.add(tt,"reactionStr_1").onFinishChange((function(){hi(),Mi()})),Mo(qt.f,Io,["UFUN"]),Ro(qt.f,Lo,["UFUN"]),qt.g=lt.add(tt,"reactionStr_2").onFinishChange((function(){hi(),Mi()})),Mo(qt.g,Io,["VFUN"]),Ro(qt.g,Lo,["VFUN"]),qt.h=lt.add(tt,"reactionStr_3").onFinishChange((function(){hi(),Mi()})),Mo(qt.h,Io,["WFUN"]),Ro(qt.h,Lo,["WFUN"]),qt.j=lt.add(tt,"reactionStr_4").onFinishChange((function(){hi(),Mi()})),Mo(qt.j,Io,["QFUN"]),Ro(qt.j,Lo,["QFUN"]),Vt=at.addFolder("Parameters"),function(){let e,t,n=[],i=tt.kineticParams.split(";");for(var o=0;o<i.length;o++)t=Wi(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+rn,rn+=1,on.push(e),nn[e]=t,n.push(e));for(const e of n)ji(e,!1);e="param"+rn,on.push(e),nn[e]=t,ji(e,!0)}(),lt=at.addFolder("Boundary conditions"),qt.uBCs=lt.add(tt,"boundaryConditions_1",{}).onChange((function(){hi(),Si(),document.activeElement.blur()})),qt.dirichletU=lt.add(tt,"dirichletStr_1").onFinishChange(hi),qt.neumannU=lt.add(tt,"neumannStr_1").onFinishChange(hi),qt.robinU=lt.add(tt,"robinStr_1").onFinishChange(hi),qt.comboU=lt.add(tt,"comboStr_1").name("Details").onFinishChange(hi),qt.vBCs=lt.add(tt,"boundaryConditions_2",{}).onChange((function(){hi(),Si(),document.activeElement.blur()})),qt.dirichletV=lt.add(tt,"dirichletStr_2").onFinishChange(hi),qt.neumannV=lt.add(tt,"neumannStr_2").onFinishChange(hi),qt.robinV=lt.add(tt,"robinStr_2").onFinishChange(hi),qt.comboV=lt.add(tt,"comboStr_2").name("Details").onFinishChange(hi),qt.wBCs=lt.add(tt,"boundaryConditions_3",{}).onChange((function(){hi(),Si(),document.activeElement.blur()})),qt.dirichletW=lt.add(tt,"dirichletStr_3").onFinishChange(hi),qt.neumannW=lt.add(tt,"neumannStr_3").onFinishChange(hi),qt.robinW=lt.add(tt,"robinStr_3").onFinishChange(hi),qt.comboW=lt.add(tt,"comboStr_3").name("Details").onFinishChange(hi),qt.qBCs=lt.add(tt,"boundaryConditions_4",{}).name("$q$").onChange((function(){hi(),Si(),document.activeElement.blur()})),qt.dirichletQ=lt.add(tt,"dirichletStr_4").onFinishChange(hi),qt.neumannQ=lt.add(tt,"neumannStr_4").onFinishChange(hi),qt.robinQ=lt.add(tt,"robinStr_4").onFinishChange(hi),qt.comboQ=lt.add(tt,"comboStr_4").name("Details").onFinishChange(hi),lt=at.addFolder("Initial conditions"),qt.initCond_1=lt.add(tt,"initCond_1").onFinishChange(Di),qt.initCond_2=lt.add(tt,"initCond_2").onFinishChange(Di),qt.initCond_3=lt.add(tt,"initCond_3").onFinishChange(Di),qt.initCond_4=lt.add(tt,"initCond_4").onFinishChange(Di),ct=rt.addFolder("Images"),lt=ct,Ei(),lt=rt.addFolder("Checkpoints");const i=oa(lt);ra(i,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),sa(i),aa(i,'<i class="fa-regular fa-flag"></i> Set',No,null,"Set a checkpoint at the current state",["narrow"]),aa(i,'<i class="fa-regular fa-file-arrow-down"></i> Export',Bo,null,"Download the last checkpoint as a file",["narrow"]),aa(i,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),lt.add(tt,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize").onChange((function(){document.activeElement.blur()})),lt=rt.addFolder("Misc."),lt.addColor(tt,"backgroundColour").name("Background").onChange((function(){we.background=new ee.Color(tt.backgroundColour),Da()}));const o=oa(lt);ra(o,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){to(),Da()}),null,"Compute the integral of the plotted expression over the domain"),ra(o,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',(function(){so(),Da()}),"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),ra(o,"setSeed",'<i class="fa-regular fa-shuffle"></i> Set seed',(function(){tt.setSeed&&(Jt=tt.randSeed),Ci(),ki()}),null,"Set the seed for random number generation"),qt.randSeed=lt.add(tt,"randSeed").name("Random seed").onFinishChange((function(){Ci()})),lt=lt.addFolder("Dev");const a=oa(lt);aa(a,'<i class="fa-regular fa-copy"></i> Copy code',la,null,"Copy the simulation configuration as JSON to the clipboard"),aa(a,'<i class="fa-regular fa-bug"></i> Copy debug',ua,null,"Copy debug information to the clipboard");let r=Y();var s;Object.keys(r).forEach((function(e){r[e]=e})),r.default=null,lt.add(tt,"parent",(s=r,Object.keys(s).sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})).reduce((function(e,t){return e[t]=s[t],e}),{}))).name("Parent preset").onChange((function(){document.activeElement.blur()}));const l=document.createElement("div");l.innerHTML="Settings",l.classList.add("ui_title"),rt.domElement.prepend(l);const u=document.createElement("div");u.innerHTML="Equations",u.classList.add("ui_title"),at.domElement.prepend(u);const c=document.createElement("div");c.id="views_list",st.domElement.prepend(c);const d=document.createElement("div");d.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",d.classList.add("ui_title"),st.domElement.prepend(d),ft=st.addFolder("Edit view"),lt=ft;const h=oa(lt,"edit_view_buttons");aa(h,'<i class="fa-solid fa-pen-nib"></i> Rename',Jo,null,"Rename the current view"),aa(h,'<i class="fa-solid fa-xmark"></i> Delete',Xo,"deleteViewButton","Delete view"),qt.whatToPlot=lt.add(tt,"whatToPlot").name("Expression: ").onFinishChange((function(){$i(),Da(),Ko(this.property)})),lt.add(tt,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){fo(),document.activeElement.blur(),Da(),Ko(this.property)})),lt.add(tt,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){Jn(),Yi(),document.activeElement.blur(),Da(),Ko(this.property)})).name("Colour map"),qt.minColourValue=lt.add(tt,"minColourValue").name("Min value").onChange((function(){Bn(),Ji(),Da(),Ko(this.property)})),qt.minColourValue.__precision=2,qt.maxColourValue=lt.add(tt,"maxColourValue").name("Max value").onChange((function(){Bn(),Ji(),Da(),Ko(this.property)})),qt.maxColourValue.__precision=2;const f=oa(lt,"colour_map_buttons");aa(f,'<i class="fa-regular fa-arrows-rotate"></i> Flip',(function(){tt.flippedColourmap=!tt.flippedColourmap,Jn(),Yi(),Da(),Ko("flippedColourmap")}),null,"Reverse colour map",["narrow"]),aa(f,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){$o(),Zn(),Ko("minColourValue"),Ko("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),ra(f,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){Yi(),Ko("colourbar")}),null,"Display the colourbar",null,["narrow"]),sa(f),ra(f,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){tt.autoSetColourRange&&($o(),Zn()),Ko("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),ra(f,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){Jn(),Da(),Ko("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),ra(f,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){Jn(),Da(),Ko("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),ra(f,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){Jn(),Da(),Ko("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),ra(f,"vectorField",'<i class="fa-solid fa-arrow-right-arrow-left"></i> Vector field',(function(){Va(),Da(),Ko("vectorField")}),"vectorFieldButton","Toggle vector field","vectorFieldFolder",["wide"]),lt=ft.addFolder("Contours"),lt.domElement.id="contoursFolder",qt.contourColour=lt.addColor(tt,"contourColour").name("Colour").onChange((function(){Sa(),Da(),Ko(this.property)})),qt.contourNum=lt.add(tt,"contourNum").name("Number").onChange((function(){Sa(),Da(),Ko(this.property)})),_a(qt.contourNum,1,20,1),Mt.push(qt.contourNum),qt.contourEpsilon=lt.add(tt,"contourEpsilon").name("Threshold").onChange((function(){Sa(),Da(),Ko(this.property)})),_a(qt.contourEpsilon,.001,.05,.001),Mt.push(qt.contourEpsilon),lt=ft.addFolder("Lighting"),lt.domElement.id="embossFolder",qt.embossSmoothness=lt.add(tt,"embossSmoothness").name("Smoothness").onChange((function(){wa(),Da(),Ko(this.property)})),_a(qt.embossSmoothness,0,2,.001),Rt.push(qt.embossSmoothness),qt.embossAmbient=lt.add(tt,"embossAmbient").name("Ambient").onChange((function(){wa(),Da(),Ko(this.property)})),_a(qt.embossAmbient,0,1,.001),Rt.push(qt.embossAmbient),qt.embossDiffuse=lt.add(tt,"embossDiffuse").name("Diffuse").onChange((function(){wa(),Da(),Ko(this.property)})),_a(qt.embossDiffuse,0,1,.001),Rt.push(qt.embossDiffuse),qt.embossSpecular=lt.add(tt,"embossSpecular").name("Specular").onChange((function(){wa(),Da(),Ko(this.property)})),_a(qt.embossSpecular,0,1,.001),Rt.push(qt.embossSpecular),qt.embossShiny=lt.add(tt,"embossShiny").name("Precision").onChange((function(){wa(),Da(),Ko(this.property)})),_a(qt.embossShiny,0,100,1),Rt.push(qt.embossShiny),qt.embossTheta=lt.add(tt,"embossTheta").name("Inclination").onChange((function(){wa(),Da(),Ko(this.property)})),_a(qt.embossTheta,0,1.5708,.001),Rt.push(qt.embossTheta),qt.embossPhi=lt.add(tt,"embossPhi").name("Direction").onChange((function(){wa(),Da(),Ko(this.property)})),_a(qt.embossPhi,0,3.1456,.001),Rt.push(qt.embossPhi),lt=ft.addFolder("Overlay"),lt.domElement.id="overlayFolder",lt.addColor(tt,"overlayColour").name("Colour").onChange((function(){Ca(),Da(),Ko(this.property)})),lt.add(tt,"overlayExpr").name("Expression").onFinishChange((function(){Jn(),"line"==tt.plotType&&Pi(),Da(),Ko(this.property)})),qt.overlayEpsilon=lt.add(tt,"overlayEpsilon").name("Threshold").onChange((function(){Ca(),Da(),Ko(this.property)})),qt.overlayLineWidthMul=lt.add(tt,"overlayLineWidthMul",.1,2).name("Thickness").onChange((function(){qo(),Da(),Ko(this.property)})),mt=ft.addFolder("3D"),lt=mt,ut=oa(lt),ra(ut,"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){nt.customSurface.value=tt.customSurface,Ea(),$a(),Da(),Ko("customSurface")}),null,"Plot the solution on a custom surface"),qt.surfaceFun=lt.add(tt,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){$i(),Da(),Ko(this.property)})),qt.threeDHeightScale=lt.add(tt,"threeDHeightScale").name("Height scale").onChange((function(){Bn(),Da(),Ko(this.property)})),qt.cameraTheta=lt.add(tt,"cameraTheta").name("View $\\theta$").onChange((function(){Nn(),Da(),Ko(this.property)})),qt.cameraPhi=lt.add(tt,"cameraPhi").name("View $\\phi$").onChange((function(){Nn(),Da(),Ko(this.property)})),qt.cameraZoom=lt.add(tt,"cameraZoom").name("Zoom").onChange((function(){Nn(),Da(),Ko(this.property)})),qt.lineWidthMul=lt.add(tt,"lineWidthMul",.1,2).name("Thickness").onChange((function(){qo(),Da(),Ko(this.property)})),pt=ft.addFolder("Vector field"),lt=pt,lt.domElement.id="vectorFieldFolder",lt.addColor(tt,"arrowColour").name("Colour").onChange((function(){ka(),Da(),Ko(this.property)})),lt.add(tt,"arrowX").onFinishChange((function(){Pi(),Da(),Ko(this.property)})).name("$x$ component"),lt.add(tt,"arrowY").onFinishChange((function(){Pi(),Da(),Ko(this.property)})).name("$y$ component"),qt.arrowDensity=lt.add(tt,"arrowDensity").onChange((function(){Va(),Da(),Ko(this.property)})).name("Density"),qt.arrowDensity.__precision=2,_a(qt.arrowDensity,0,1,.001),lt.add(tt,"arrowScale",{None:"none",Relative:"relative",Auto:"auto"}).onFinishChange((function(){ki(),Da(),Ko(this.property)})).name("Scaling"),qt.arrowLengthMax=lt.add(tt,"arrowLengthMax").onFinishChange((function(){Va(),Da(),Ko(this.property)})).name("Max length");document.querySelectorAll("input").forEach((e=>Fa(e)))}function Hn(){Jn(),Yi(),$i(),Yn()}function Yn(){let l=So()+e(),u="float brushRadius = "+ci(tt.brushRadius.toString())+";\n";switch(u=u.replace(/\buvwq\./g,"uvwqBrush."),u=u.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(tt.brushValue)&&(l+=q()),/\bRANDN\b/.test(tt.brushValue)&&(l+=M()),l+="float brushValue = "+ci(tt.brushValue)+";\n",l+=u,tt.brushType){case"circle":l+=i();break;case"hline":l+=a();break;case"vline":l+=o()}switch(tt.brushAction){case"replace":l+=r(),l+=t();break;case"add":l+=r(),l+=n();break;case"smoothreplace":l+=s(),l+=t();break;case"smoothadd":l+=s(),l+=n()}Ra(),l=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,yi(tt.whatToDraw)),e}(l),l=qa(l),Ve.fragmentShader=l,Ve.needsUpdate=!0}function Jn(){Ke=j(tt.colourmap),tt.flippedColourmap&&(Ke.reverse(),Ke=Ke.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),nt.colour1.value=new ee.Vector4(...Ke[0]),nt.colour2.value=new ee.Vector4(...Ke[1]),nt.colour3.value=new ee.Vector4(...Ke[2]),nt.colour4.value=new ee.Vector4(...Ke[3]),nt.colour5.value=new ee.Vector4(...Ke[4]);let e=So()+R();tt.emboss&&(e+=L(),wa()),tt.contours&&(e+=N(),Sa()),tt.overlay&&(e+=W().replaceAll("OVERLAYEXPR",ci(tt.overlayExpr)),e=qa(e),Ca()),He.visible=tt.overlay&&"line"==tt.plotType,e+=I(),Pe.fragmentShader=e,Pe.needsUpdate=!0,Me.needsUpdate=!0,et=Ke.map((e=>e[3])),Ke=Ke.map((e=>e.slice(0,-1)))}function Xn(){switch(tt.timesteppingScheme){case"Euler":Qe.material=Ut.FE,nt.textureSource.value=kt[1].texture,nt.textureSource1.value=kt[2].texture,nt.dt.value=tt.dt,ye.setRenderTarget(kt[0]),ye.render(_e,ve),kt.rotate(-1),nt.t.value+=tt.dt;break;case"AB2":Qe.material=Ut.AB2,nt.textureSource.value=kt[1].texture,nt.textureSource1.value=kt[2].texture,nt.dt.value=tt.dt,ye.setRenderTarget(kt[0]),ye.render(_e,ve),kt.rotate(-1),nt.t.value+=tt.dt;break;case"Mid":Qe.material=Ut.Mid1,nt.textureSource.value=kt[1].texture,ye.setRenderTarget(kt[2]),ye.render(_e,ve),Qe.material=Ut.Mid2,nt.textureSource1.value=kt[2].texture,nt.t.value+=.5*tt.dt,ye.setRenderTarget(kt[0]),ye.render(_e,ve),kt.rotate(-1),nt.t.value+=.5*tt.dt;break;case"RK4":Qe.material=Ut.RK41,nt.textureSource.value=kt[1].texture,ye.setRenderTarget(kt[2]),ye.render(_e,ve),Qe.material=Ut.RK42,nt.textureSource1.value=kt[2].texture,nt.t.value+=.5*tt.dt,ye.setRenderTarget(kt[3]),ye.render(_e,ve),Qe.material=Ut.RK43,nt.textureSource2.value=kt[3].texture,ye.setRenderTarget(kt[4]),ye.render(_e,ve),Qe.material=Ut.RK44,nt.textureSource3.value=kt[4].texture,nt.t.value+=.5*tt.dt,ye.setRenderTarget(kt[0]),ye.render(_e,ve),kt.rotate(-1)}}function Zn(){if(Kn(),tt.autoSetColourRange&&$o(),tt.brushEnabled&&"surface"==tt.plotType){let e=0;tt.maxColourValue-tt.minColourValue>0&&(e=(function(){ao();let e=0;for(let t=0;t<pn.length;t+=4)e+=pn[t];return e/(Dt*xt)}()-tt.minColourValue)/(tt.maxColourValue-tt.minColourValue)-.5,e=e.clamp(-.5,.5)),ze.position.y=tt.threeDHeightScale*e,ze.updateWorldMatrix()}if("line"==tt.plotType){ao();let t=0;var e=tt.maxColourValue-tt.minColourValue;e=0==e?.5:e;for(let n=0;n<pn.length;n+=4)Je[t++]=(pn[n]-tt.minColourValue)/e-.5;let n=new ee.SplineCurve(Ye.map(((e,t)=>new ee.Vector2(e,Je[t])))),i=n.getSpacedPoints(Xe);if(Vo(Ge,i),function(e,t){let n,i=e.geometry.attributes.instanceColorStart,o=e.geometry.attributes.instanceColorEnd;for(let e=0;e<t.length;e++)n=ko(t[e].toArray()[1]+.5),e<t.length&&i.setXYZ(e,n[0],n[1],n[2]),e>0&&o.setXYZ(e-1,n[0],n[1],n[2]);i.needsUpdate=!0}(Ge,i),tt.overlay){t=0;for(let n=2;n<4*Dt;n+=4)Je[t++]=(pn[n]-tt.minColourValue)/e-.5;n=new ee.SplineCurve(Ye.map(((e,t)=>new ee.Vector2(e,Je[t])))),i=n.getSpacedPoints(Xe),Vo(He,i)}}if(tt.vectorField&&Ze){bn=new Float32Array(Dt*xt*4),ye.readRenderTargetPixels(Fe,0,0,Dt,xt,bn);let e,t,n,i=[];for(const o of Ze.children)e=4*o.ind,t=bn[e+2],n=bn[e+3],o.visible=bn[e+1]<=.5,o.lookAt(o.position.x+t,o.position.y+n,o.position.z),o.size=t**2+n**2,i.push(o.size);let o=1;switch(tt.arrowScale){case"auto":o=Math.sqrt(Math.max(...i)),0==o&&(o=1);for(const e of Ze.children){const t=tn*Uo(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"relative":o=Ze.customMax>0?Ze.customMax:1;for(const e of Ze.children){const t=tn*Uo(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"none":for(const e of Ze.children)e.scale.set(tn,tn,tn)}}if(tt.timeDisplay&&eo(),tt.integrate&&function(){if(tt.integrate){let e;ao(),1==tt.dimension?e=nt.dx.value:2==tt.dimension&&(e=nt.dx.value*nt.dy.value);let t=0;for(let e=0;e<pn.length;e+=4)t+=pn[e]*(1-pn[e+1]);t*=e,$("#integralValue").html(Xi(t,4)),ro()}}(),lo()?(Qe.material=Ne,ye.setRenderTarget(Ee),ye.render(_e,ve),nt.textureSource.value=Ee.texture,nt.dxUpscaledScale.value=devicePixelRatio*At/Dt,nt.dyUpscaledScale.value=devicePixelRatio*Pt/xt):(nt.dxUpscaledScale.value=1,nt.dyUpscaledScale.value=1),ye.setRenderTarget(null),ye.render(we,be),vn){vn=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",ye.render(we,be),t.href=ye.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Wn(),Zn()}}function Kn(){Qe.material=Me,nt.textureSource.value=kt[1].texture,ye.setRenderTarget(Fe),ye.render(_e,ve),nt.textureSource.value=Fe.texture,wn=!1,nt.textureSource1.value=kt[1].texture}function ei(e){bt=ii(e,me),bt&&(tt.brushEnabled&&"surface"==tt.plotType?Ce.enabled=!1:tt.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),Gi("#top_message"),window.clearTimeout(yt),yt=setTimeout((function(){$("#top_message").hasClass("fading_out")||Hi("#top_message")}),3e3)))}function ti(e){bt=!1,"surface"==tt.plotType&&(Ce.enabled=!0)}function ni(e){ii(e,me)}function ii(e,t){var n=t.getBoundingClientRect();let i=(e.clientX-n.x)/n.width,o=1-(e.clientY-n.y)/n.height;if("surface"==tt.plotType){xe.x=2*i-1,xe.y=2*o-1,De.setFromCamera(xe,be);var a=De.intersectObject(ze,!1);a.length>0?(i=a[0].uv.x,o=a[0].uv.y):(i=-1,o=-1)}else"line"==tt.plotType&&(i=(i-.5)/be.zoom+.5,o=.5);return i=Math.round(i*Dt)/Dt,o=Math.round(o*xt)/xt,nt.brushCoords.value=new ee.Vector2(i,o),0<=i&&i<=1&&0<=o&&o<=1}function oi(){ye.setSize(Dt,xt,!1),Ht&&tt.resetFromCheckpoints?Qe.material=Be:Qe.material=Ue,kt.forEach((e=>{ye.setRenderTarget(e),ye.render(_e,ve)})),Qo(),Zn()}function ai(){Gt||($("#pause").hide(),$("#play").show()),gt=!1}function ri(){Gt||($("#play").hide(),$("#pause").show()),Ot=!0,window.clearTimeout(_t),_t=setTimeout(oo,1e3),gt=!0}function si(){tt.setSeed&&(Jt=tt.randSeed),Ci(),nt.t.value=0,Bt=!0,eo(),oi(),Zn(),Ot=!0,window.clearTimeout(_t),oo()}function li(){let e="";return e+="float UFUN = "+ci(tt.reactionStr_1)+";\n",e+="float VFUN = "+ci(tt.reactionStr_2)+";\n",e+="float WFUN = "+ci(tt.reactionStr_3)+";\n",e+="float QFUN = "+ci(tt.reactionStr_4)+";\n",e}function ui(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function ci(e){if(!Go(e=" "+e+" ")||Ia(e))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])?\b/g);let i,o,a,r,s,l,u,c,d,h,f,m,p,g=0;const b={S:"One",T:"Two"},v={R:"r",G:"g",B:"b",A:"a"};for(const w of n){for(i=w.index,m=b[w[1]],o=i+w[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,s=t.slice(o+g+1,a+g),s=xo(s),l=s.split(","),1!=l.length&&0!=l[1].trim().length||(l[1]="0"),l[0]="("+l[0]+"-MINX)/L_x",l[1]="("+l[1]+"-MINY)/L_y",h="texture(imageSource"+m+",vec2("+l.join(",")+")).",null!=w[2]?(p=v[w[2]],f=h+p):(p=["r","g","b"],f="("+p.map((e=>h+e)).join("+")+")/3.0 "),t=Bi(t,f,i+g,a+1+g),g+=f.length-a+i-1)}return t}(e=(e=vo(e=(e=(e=(e=di(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){if("0"==n)return"1";const i=Number(n);return Number.isInteger(i&&i>0&&i<101)?"(("+t+")"+("*("+t+")").repeat(i-1)+")":"safepow("+t+","+n+")"}))).replaceAll(RegExp("\\b("+Cn[0]+")\\b","g"),(function(e,t){return"uvwq."+yi(t)}))).replaceAll(RegExp("\\b("+Cn[0]+")_([xy][fb]?2?)\\b","g"),(function(e,t,n){return n.includes("2")&&(n=n.slice(0,-1).repeat(2)),"uvwq"+n.toUpperCase()+"."+yi(t)}))).replaceAll(RegExp("\\b("+Cn[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+yi(t)})))).replaceAll(/\b(I_[ST][RBGA]?\b)\s*(?!\()/g,"$1(x,y) "));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e=e.replaceAll(/\bind\b/g,"float")}function di(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function hi(){let e="",t="",n="",i="",o="",a="";const r=[tt.boundaryConditions_1,tt.boundaryConditions_2,tt.boundaryConditions_3,tt.boundaryConditions_4],s=[tt.neumannStr_1,tt.neumannStr_2,tt.neumannStr_3,tt.neumannStr_4],l=[tt.comboStr_1,tt.comboStr_2,tt.comboStr_3,tt.comboStr_4].map((e=>e+";")),u=[tt.dirichletStr_1,tt.dirichletStr_2,tt.dirichletStr_3,tt.dirichletStr_4],c=[tt.robinStr_1,tt.robinStr_2,tt.robinStr_3,tt.robinStr_4];r.forEach((function(t,n){"neumann"==t?(e+=fi(s[n],yn[n]),tt.domainViaIndicatorFun?e+=na(n):e+=ta(n)):"combo"==t&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=fi(t[2],yn[n],i),e+=ta(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=_i(V(t),yn[e]),tt.dimension>1&&(i+=_i(k(t),yn[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,ci(e[2]))}))})),r.forEach((function(e,t){if("dirichlet"==e)if(tt.domainViaIndicatorFun){let e=v().replace(/indicatorFun/g,ci(tt.domainIndicatorFun));n+=_i(e,yn[t])+ci(u[t])+";\n}\n"}else n+=mi(u[t],yn[t]),n+=ea(t);else if("combo"==e)[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=mi(e[2],yn[t],i),n+=ea(t,i)}));else if(tt.domainViaIndicatorFun){let e=v().replace(/indicatorFun/g,ci(tt.domainIndicatorFun));n+=_i(e,yn[t])+"0.0;\n}\n"}})),r.forEach((function(e,t){"robin"==e?(i+=fi(c[t],yn[t]),tt.domainViaIndicatorFun?i+=na(t):i+=ta(t)):"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=fi(e[2],yn[t],n),i+=ta(t,n)}))}));let d=So();if(o=function(){let e="";return e+=ui(ci(tt.diffusionStr_1_1)+";\n","uu"),e+=ui(ci(tt.diffusionStr_2_2)+";\n","vv"),e+=ui(ci(tt.diffusionStr_3_3)+";\n","ww"),e+=ui(ci(tt.diffusionStr_4_4)+";\n","qq"),e}()+"\n",tt.crossDiffusion?o+=function(){let e="";return e+=ui(ci(tt.diffusionStr_1_2)+";\n","uv"),e+=ui(ci(tt.diffusionStr_1_3)+";\n","uw"),e+=ui(ci(tt.diffusionStr_1_4)+";\n","uq"),e+=ui(ci(tt.diffusionStr_2_1)+";\n","vu"),e+=ui(ci(tt.diffusionStr_2_3)+";\n","vw"),e+=ui(ci(tt.diffusionStr_2_4)+";\n","vq"),e+=ui(ci(tt.diffusionStr_3_1)+";\n","wu"),e+=ui(ci(tt.diffusionStr_3_2)+";\n","wv"),e+=ui(ci(tt.diffusionStr_3_4)+";\n","wq"),e+=ui(ci(tt.diffusionStr_4_1)+";\n","qu"),e+=ui(ci(tt.diffusionStr_4_2)+";\n","qv"),e+=ui(ci(tt.diffusionStr_4_3)+";\n","qw"),e}()+"\n"+D():o+=C(),tt.numAlgebraicSpecies>=2){const e=tt.numSpecies-tt.numAlgebraicSpecies;let t={};for(let n=e;n<tt.numSpecies;n++){let i=[],o=tt["reactionStr_"+(n+1).toString()];for(let t=e;t<tt.numSpecies;t++)o=[o,tt["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()]].join(" ");for(let t=e;t<tt.numSpecies;t++){(new RegExp("\\b"+yn[t]+"(_(x|xb|xf|xb2|xf2|xx|y|yb|yf|yb2|yf2|yy))?\\b").test(o)||"0"!=tt["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()])&&i.push(yn[t])}i!=[]&&(t[yn[n]]=i)}let n={},i=[],o=[];for(let a of yn.slice(e,tt.numSpecies))Ma(a,n,i,t,o);if(o.length>0)return void zo("Cyclic variables detected. Please check the definition(s) of "+o.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.")}if(hn&&tt.crossDiffusion&&(a+=_i(x(),yn[1])),fn&&tt.crossDiffusion&&(a+=_i(x(),yn[2])),mn&&tt.crossDiffusion&&(a+=_i(x(),yn[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void zo("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let h=[E(),A(),e,t,i,T(),P(),li(),o].join(" "),f=/\bRAND\b/.test(h),g=/\bRANDN\b/.test(h);f&&(h=q()+h),g&&(h=M()+h),jt=f||g;let b=[n,a,p()].join(" "),w="FE";Ut[w].fragmentShader=qa([d,m(w),h,U(w),b].join(" ")),w="AB2",Ut[w].fragmentShader=qa([d,m(w),h,U(w),b].join(" ")),w="Mid";for(let e=1;e<3;e++)Ut[w+e.toString()].fragmentShader=qa([d,m(w+e.toString()),h,U(w+e.toString()),b].join(" "));w="RK4";for(let e=1;e<5;e++)Ut[w+e.toString()].fragmentShader=qa([d,m(w+e.toString()),h,U(w+e.toString()),b].join(" "));if(Object.keys(Ut).forEach((e=>Ut[e].needsUpdate=!0)),wt=tt.domainViaIndicatorFun||"dirichlet"==tt.boundaryConditions_1||"dirichlet"==tt.boundaryConditions_2||"dirichlet"==tt.boundaryConditions_3||"dirichlet"==tt.boundaryConditions_4||/Dirichlet/.test(tt.comboStr_1)||/Dirichlet/.test(tt.comboStr_2)||/Dirichlet/.test(tt.comboStr_3)||/Dirichlet/.test(tt.comboStr_4),wt){if(n=d+F(),tt.domainViaIndicatorFun){let e=v().replace(/indicatorFun/,ci(tt.domainIndicatorFun)).replace(/updated/,"gl_FragColor");u.forEach((function(t,i){"dirichlet"==r[i]?n+=_i(e,yn[i])+ci(t)+";\n}\n":n+=_i(e,yn[i])+"0.0;\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=mi(u[t],yn[t]),n+=ia(t)):"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=mi(e[2],yn[t],i),n+=ia(t,i)}))}));n+="}",n=qa(n),ke.fragmentShader=n,ke.needsUpdate=!0}}function fi(e,t,n){return null==n?["L","R","T","B"].map((n=>fi(e,t,n))).join(""):"float robinRHS"+t+n+" = "+ci(e)+";\n"}function mi(e,t,n){return null==n?["L","R","T","B"].map((n=>mi(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+ci(e)+";\n"}function pi(e){gi("default"),gi(e),null!=tt.threeD&&(tt.threeD&&(tt.dimension=2,null==tt.plotType&&(tt.plotType="surface")),delete tt.threeD),null!=tt.oneDimensional&&(tt.oneDimensional&&(tt.dimension=1,tt.plotType="line"),delete tt.oneDimensional),Kt*=en,function(){if(0==tt.views.length){let e=Zo();e.name="1",tt.views.push(e)}else tt.views=tt.views.map((function(e){let t=Zo();return Object.assign(t,e),t}))}(),vi(at,!0),vi(rt,!0),vi(st,!0),Gn(),tt.activeViewInd>=tt.views.length&&(tt.activeViewInd=tt.views.length-1),Yo(tt.views[tt.activeViewInd],!1),qi(),zn(),In(),Bn(),we.background=new ee.Color(tt.backgroundColour),""!=tt.initialState?fetch(tt.initialState).then((e=>e.blob())).then((e=>Oo(e))):si(),Nn(),dt.remove(),ht.remove(),Ei(),so()}function gi(e){let t;const n=X(),i=n.map((e=>e.toLowerCase()));if(null==e)t=z(tt.preset);else if("string"==typeof e)if(i.includes(e.toLowerCase()))t=z(e);else{const i=fe(e,n,!1);o="We couldn't find a preset called '"+e+"'."+(null!=i?" We've loaded the closest match, '"+i+"'.":"")+" Please check the preset specified in the URL.",ai(),$("#preset_description").html(o),Gi("#bad_preset"),t=z(i||sn)}else t="object"==typeof e?e:z(sn);var o;t.hasOwnProperty("parent")&&null!=t.parent&&gi(t.parent),rn=0,on=[],nn={},Object.assign(tt,t),gt=tt.runningOnLoad,Ao(),gt?ri():ai(),pa()?tt.tryClickingText=tt.tryClickingText.replaceAll("clicking","tapping"):tt.tryClickingText=tt.tryClickingText.replaceAll("tapping","clicking"),tt.brushRadius=tt.brushRadius.toString(),tt.hasOwnProperty("drawIn3D")&&(tt.brushEnabled=tt.drawIn3D);var a=0;a+=tt.hasOwnProperty("algebraicV"),a+=tt.hasOwnProperty("algebraicW"),(a+=tt.hasOwnProperty("algebraicQ"))&&!tt.numAlgebraicSpecies&&(tt.numAlgebraicSpecies=a),delete tt.algebraicV,delete tt.algebraicW,delete tt.algebraicQ;const r=J();Object.keys(r).forEach((function(e){tt.hasOwnProperty(e)&&(t.hasOwnProperty(r[e])||(tt[r[e]]=tt[e]),delete tt[e])})),null==tt.minColourValue&&(tt.minColourValue=0),null==tt.maxColourValue&&(tt.maxColourValue=1),tt.domainScale=tt.domainScale.toString(),tt.spatialStep=tt.spatialStep.toString(),ot=JSON.parse(JSON.stringify(tt));let s=[tt.initCond_1,tt.initCond_2,tt.initCond_3,tt.initCond_4,tt.domainIndicatorFun,tt.reactionStr_1,tt.reactionStr_2,tt.reactionStr_3,tt.reactionStr_4,tt.diffusionStr_1_1,tt.diffusionStr_1_2,tt.diffusionStr_1_3,tt.diffusionStr_1_4,tt.diffusionStr_2_1,tt.diffusionStr_2_2,tt.diffusionStr_2_3,tt.diffusionStr_2_4,tt.diffusionStr_3_1,tt.diffusionStr_3_2,tt.diffusionStr_3_3,tt.diffusionStr_3_4,tt.diffusionStr_4_1,tt.diffusionStr_4_2,tt.diffusionStr_4_3,tt.diffusionStr_4_4,tt.dirichletStr_1,tt.dirichletStr_2,tt.dirichletStr_3,tt.dirichletStr_4,tt.robinStr_1,tt.robinStr_2,tt.robinStr_3,tt.robinStr_4,tt.comboStr_1,tt.comboStr_2,tt.comboStr_3,tt.comboStr_4,tt.neumannStr_1,tt.neumannStr_2,tt.neumannStr_3,tt.neumannStr_4,tt.brushValue,tt.whatToPlot].join(" ");tt.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(s)}function bi(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)bi(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function vi(e,t){if(null!=e){for(let t in e.__folders)vi(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function wi(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function _i(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=yi(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function yi(e){return"rgba"[function(e){return yn.indexOf(e)}(e)]}function Si(){"dirichlet"==tt.boundaryConditions_1?qt.dirichletU.show():qt.dirichletU.hide(),"dirichlet"==tt.boundaryConditions_2?qt.dirichletV.show():qt.dirichletV.hide(),"dirichlet"==tt.boundaryConditions_3?qt.dirichletW.show():qt.dirichletW.hide(),"dirichlet"==tt.boundaryConditions_4?qt.dirichletQ.show():qt.dirichletQ.hide(),"neumann"==tt.boundaryConditions_1?qt.neumannU.show():qt.neumannU.hide(),"neumann"==tt.boundaryConditions_2?qt.neumannV.show():qt.neumannV.hide(),"neumann"==tt.boundaryConditions_3?qt.neumannW.show():qt.neumannW.hide(),"neumann"==tt.boundaryConditions_4?qt.neumannQ.show():qt.neumannQ.hide(),"robin"==tt.boundaryConditions_1?qt.robinU.show():qt.robinU.hide(),"robin"==tt.boundaryConditions_2?qt.robinV.show():qt.robinV.hide(),"robin"==tt.boundaryConditions_3?qt.robinW.show():qt.robinW.hide(),"robin"==tt.boundaryConditions_4?qt.robinQ.show():qt.robinQ.hide(),"combo"==tt.boundaryConditions_1?qt.comboU.show():qt.comboU.hide(),"combo"==tt.boundaryConditions_2?qt.comboV.show():qt.comboV.hide(),"combo"==tt.boundaryConditions_3?qt.comboW.show():qt.comboW.hide(),"combo"==tt.boundaryConditions_4?qt.comboQ.show():qt.comboQ.hide();const e=[qt.uBCs,qt.vBCs,qt.wBCs,qt.qBCs];tt.domainViaIndicatorFun?e.forEach((e=>To(e,["Dirichlet","Neumann","Robin"],["dirichlet","neumann","robin"]))):e.forEach((e=>To(e,["Periodic","Dirichlet","Neumann","Robin","Combination"],["periodic","dirichlet","neumann","robin","combo"]))),bi(at)}function Ci(){Jt=(Jt+123456789)%1e9,nt.seed.value=Jt/1e6}function Di(){let e=So()+K(),t=[tt.initCond_1,tt.initCond_2,tt.initCond_3,tt.initCond_4].join(" ");/\bRAND\b/.test(t)&&(e+=q()),/\bRANDN\b/.test(t)&&(e+=M()),e+="float u = "+ci(tt.initCond_1)+";\n",e+="float v = "+ci(tt.initCond_2)+";\n",e+="float w = "+ci(tt.initCond_3)+";\n",e+="float q = "+ci(tt.initCond_4)+";\n",e+=Z(),e=qa(e),Ue.fragmentShader=e,Ue.needsUpdate=!0}function xi(){let e=new Image;e.src=dt.__image.src;let t=new ee.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,nt.imageSourceOne.value=t,tt.resetOnImageLoad&&si()}}function Fi(){let e=new Image;e.src=ht.__image.src;let t=new ee.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,nt.imageSourceTwo.value=t,tt.resetOnImageLoad&&si()},t.dispose()}function Ei(){lt=ct,dt=lt.addImage(tt,"imagePathOne").name("$I_S(x,y)$").onChange(xi),ht=lt.addImage(tt,"imagePathTwo").name("$I_T(x,y)$").onChange(Fi),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function $i(){wn=!1,Pi(),qt.minColourValue.show(),qt.maxColourValue.show(),Yi(),to()}function Ti(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function Ai(){ao();let e=1/0,t=-1/0;for(let n=0;n<pn.length;n+=4)e=Math.min(e,pn[n]),t=Math.max(t,pn[n]);return[e,t]}function Pi(){let e=So()+l();e+=u().replace(/\bXVECFUN\b/,ci(tt.arrowX)).replace(/\bYVECFUN\b/,ci(tt.arrowY)),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,ci(tt.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,ci(tt.surfaceFun))}(e),tt.domainViaIndicatorFun&&(e+=d().replace(/indicatorFun/g,ci(tt.domainIndicatorFun))),e=e.replaceAll("OVERLAYEXPR",ci(tt.overlayExpr)),e=qa(e),Ca(),Me.fragmentShader=e+c(),Me.needsUpdate=!0}function Vi(){tt.numAlgebraicSpecies=Math.min(parseInt(tt.numAlgebraicSpecies),parseInt(tt.numSpecies)-1),hn=tt.numAlgebraicSpecies>=tt.numSpecies-1,fn=tt.numAlgebraicSpecies>=tt.numSpecies-2&&tt.numSpecies>=3,mn=tt.numAlgebraicSpecies>=tt.numSpecies-3&&tt.numSpecies>=4}function ki(){let e="function of "+yn.slice(0,tt.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+yn[1]+",",""),n=e.replace(" "+yn[2]+",",""),i=e.replace(" "+yn[3]+",","");switch(1==tt.dimension?(e=e.replace(" y,",""),qt.minY.hide()):qt.minY.show(),tt.crossDiffusion&&parseInt(tt.numSpecies)>1?(Xt||To(qt.algebraicSpecies,Array.from(Array(parseInt(tt.numSpecies)).keys())),qt.algebraicSpecies.show()):qt.algebraicSpecies.hide(),tt.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),qt.Duv.hide(),qt.Dvu.hide(),qt.Dvv.hide(),qt.g.hide(),qt.initCond_2.hide(),qt.vBCs.hide(),qt.Duw.hide(),qt.Dvw.hide(),qt.Dwu.hide(),qt.Dwv.hide(),qt.Dww.hide(),qt.h.hide(),qt.initCond_3.hide(),qt.wBCs.hide(),qt.Duq.hide(),qt.Dvq.hide(),qt.Dwq.hide(),qt.Dqu.hide(),qt.Dqv.hide(),qt.Dqw.hide(),qt.Dqq.hide(),qt.j.hide(),qt.initCond_4.hide(),qt.qBCs.hide(),parseInt(tt.numSpecies)){case 4:tt.crossDiffusion?(qt.Duq.show(),qt.Dvq.show(),qt.Dwq.show(),qt.Dqu.show(),qt.Dqv.show(),qt.Dqw.show()):(qt.Dwq.hide(),qt.Dqu.hide(),qt.Dvq.hide(),qt.Duq.hide(),qt.Dqv.hide(),qt.Dqw.hide()),qt.Dqq.show(),qt.j.show(),qt.initCond_4.show(),qt.qBCs.show();case 3:tt.crossDiffusion?(qt.Duw.show(),qt.Dvw.show(),qt.Dwu.show(),qt.Dwv.show()):(qt.Duw.hide(),qt.Dvw.hide(),qt.Dwu.hide(),qt.Dwv.hide()),qt.Dww.show(),qt.h.show(),qt.initCond_3.show(),qt.wBCs.show();case 2:tt.crossDiffusion?(qt.Duv.show(),qt.Dvu.show()):(qt.Duv.hide(),qt.Dvu.hide()),qt.Dvv.show(),qt.g.show(),qt.initCond_2.show(),qt.vBCs.show()}tt.crossDiffusion?(wi(qt.Duu,xn.Duu,e),wi(qt.Duv,xn.Duv,e),wi(qt.Duw,xn.Duw,e),wi(qt.Duq,xn.Duq,e),wi(qt.Dvu,xn.Dvu,e),wi(qt.Dvv,xn.Dvv,e),wi(qt.Dvw,xn.Dvw,e),wi(qt.Dvq,xn.Dvq,e),wi(qt.Dwu,xn.Dwu,e),wi(qt.Dwv,xn.Dwv,e),wi(qt.Dww,xn.Dww,e),wi(qt.Dwq,xn.Dwq,e),wi(qt.Dqu,xn.Dqu,e),wi(qt.Dqv,xn.Dqv,e),wi(qt.Dqw,xn.Dqw,e),wi(qt.Dqq,xn.Dqq,e)):(wi(qt.Duu,xn.Du,e),wi(qt.Dvv,xn.Dv,e),wi(qt.Dww,xn.Dw,e),wi(qt.Dqq,xn.Dq,e)),wi(qt.f,xn.UFUN,e),wi(qt.g,xn.VFUN,e),wi(qt.h,xn.WFUN,e),wi(qt.j,xn.QFUN,e),hn&&(wi(qt.Dvu,xn.Dvu,t),wi(qt.Dvw,xn.Dvw,t),wi(qt.Dvq,xn.Dvq,t),wi(qt.g,xn.VFUN,t),qt.Dvv.hide()),fn&&(wi(qt.Dwu,xn.Dwu,i),wi(qt.Dwv,xn.Dwv,i),wi(qt.Dwq,xn.Dwq,i),wi(qt.h,xn.WFUN,i),qt.Dww.hide()),mn&&(wi(qt.Dqu,xn.Dqu,n),wi(qt.Dqv,xn.Dqv,n),wi(qt.Dqw,xn.Dqw,n),wi(qt.j,xn.QFUN,n),qt.Dqq.hide()),wi(qt.uBCs,xn.u),wi(qt.vBCs,xn.v),wi(qt.wBCs,xn.w),wi(qt.qBCs,xn.q),wi(qt.dirichletU,xn.uD),wi(qt.dirichletV,xn.vD),wi(qt.dirichletW,xn.wD),wi(qt.dirichletQ,xn.qD),wi(qt.neumannU,xn.uN),wi(qt.neumannV,xn.vN),wi(qt.neumannW,xn.wN),wi(qt.neumannQ,xn.qN),wi(qt.robinU,xn.uN),wi(qt.robinV,xn.vN),wi(qt.robinW,xn.wN),wi(qt.robinQ,xn.qN),wi(qt.initCond_1,xn.uInit),wi(qt.initCond_2,xn.vInit),wi(qt.initCond_3,xn.wInit),wi(qt.initCond_4,xn.qInit),tt.domainViaIndicatorFun?qt.domainIndicatorFun.show():qt.domainIndicatorFun.hide(),Si(),"surface"==tt.plotType?($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").hide(),mt.name="3D options",mt.domElement.classList.remove("hidden"),qt.lineWidthMul.hide(),qt.threeDHeightScale.show(),qt.cameraTheta.show(),qt.cameraPhi.show(),qt.cameraZoom.show()):"line"==tt.plotType?($("#contourButton").hide(),$("#embossButton").hide(),$("#vectorFieldButton").hide(),mt.name="Line options",mt.domElement.classList.remove("hidden"),qt.lineWidthMul.show(),qt.threeDHeightScale.show(),qt.cameraTheta.hide(),qt.cameraPhi.hide(),qt.cameraZoom.hide()):($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").show(),mt.domElement.classList.add("hidden"),qt.lineWidthMul.hide(),qt.threeDHeightScale.hide(),qt.cameraTheta.hide(),qt.cameraPhi.hide(),qt.cameraZoom.hide()),1==tt.dimension&&$("#vectorFieldButton").hide(),Yi(),Ki(),to(),$("#dataContainer").show(),$a(),"line"==tt.plotType?(qt.brushType.hide(),$(":root").css("--ui-button-outline","black")):(qt.brushType.show(),$(":root").css("--ui-button-outline","white")),ge?$("#interpController").hide():$("#interpController").show(),"relative"==tt.arrowScale?qt.arrowLengthMax.show():qt.arrowLengthMax.hide(),To(qt.whatToDraw,yn.slice(0,tt.numSpecies)),ya(),tt.autoPause?qt.autoPauseAt.show():qt.autoPauseAt.hide(),"line"==tt.plotType?(qt.overlayEpsilon.hide(),qt.overlayLineWidthMul.show()):(qt.overlayEpsilon.show(),qt.overlayLineWidthMul.hide()),tt.setSeed?qt.randSeed.show():qt.randSeed.hide(),$(".toggle_button").each((function(){xa(this)})),Ho(),bi(at),bi(rt),bi(st)}function Ui(){let e;switch(Vi(),tt.domainViaIndicatorFun&&(["dirichlet","neumann"].includes(tt.boundaryConditions_1)||(tt.boundaryConditions_1="dirichlet"),["dirichlet","neumann"].includes(tt.boundaryConditions_2)||(tt.boundaryConditions_2="dirichlet"),["dirichlet","neumann"].includes(tt.boundaryConditions_3)||(tt.boundaryConditions_3="dirichlet"),["dirichlet","neumann"].includes(tt.boundaryConditions_4)||(tt.boundaryConditions_4="dirichlet")),parseInt(tt.numSpecies)){case 1:tt.crossDiffusion=!1,tt.whatToDraw=yn[0],new RegExp("\\b("+Cn[1]+")\\b").test(tt.whatToPlot)&&(tt.whatToPlot=yn[0]),tt.diffusionStr_1_2="0",tt.diffusionStr_1_3="0",tt.diffusionStr_1_4="0",tt.diffusionStr_2_1="0",tt.diffusionStr_2_2="0",tt.diffusionStr_2_3="0",tt.diffusionStr_2_4="0",tt.diffusionStr_3_1="0",tt.diffusionStr_3_2="0",tt.diffusionStr_3_3="0",tt.diffusionStr_3_4="0",tt.diffusionStr_4_1="0",tt.diffusionStr_4_2="0",tt.diffusionStr_4_3="0",tt.diffusionStr_4_4="0",tt.boundaryConditions_2="periodic",tt.initCond_2="0",tt.reactionStr_2="0",tt.boundaryConditions_3="periodic",tt.initCond_3="0",tt.reactionStr_3="0",tt.boundaryConditions_4="periodic",tt.initCond_4="0",tt.reactionStr_4="0",e=new RegExp("\\b("+Cn[1]+")\\b"),e.test(tt.reactionStr_1)&&(tt.reactionStr_1="0");break;case 2:tt.whatToDraw==yn[2]|tt.whatToDraw==yn[3]&&(tt.whatToDraw=yn[0]),new RegExp("\\b("+Cn[2]+")\\b").test(tt.whatToPlot)&&(tt.whatToPlot=yn[0]),tt.diffusionStr_1_3="0",tt.diffusionStr_1_4="0",tt.diffusionStr_2_3="0",tt.diffusionStr_2_4="0",tt.diffusionStr_3_1="0",tt.diffusionStr_3_2="0",tt.diffusionStr_3_3="0",tt.diffusionStr_3_4="0",tt.diffusionStr_4_1="0",tt.diffusionStr_4_2="0",tt.diffusionStr_4_3="0",tt.diffusionStr_4_4="0",tt.boundaryConditions_3="periodic",tt.initCond_3="0",tt.reactionStr_3="0",tt.boundaryConditions_4="periodic",tt.initCond_4="0",tt.reactionStr_4="0",e=new RegExp("\\b("+Cn[2]+")\\b"),e.test(tt.reactionStr_1)&&(tt.reactionStr_1="0"),e.test(tt.reactionStr_2)&&(tt.reactionStr_2="0");break;case 3:tt.whatToDraw==yn[3]&&(tt.whatToDraw=yn[0]),new RegExp("\\b("+Cn[3]+")\\b").test(tt.whatToPlot)&&(tt.whatToPlot=yn[0]),tt.diffusionStr_1_4="0",tt.diffusionStr_2_4="0",tt.diffusionStr_3_4="0",tt.diffusionStr_4_1="0",tt.diffusionStr_4_2="0",tt.diffusionStr_4_3="0",tt.diffusionStr_4_4="0",tt.boundaryConditions_4="periodic",tt.initCond_4="0",tt.reactionStr_4="0",e=new RegExp("\\b("+Cn[3]+")\\b"),e.test(tt.reactionStr_1)&&(tt.reactionStr_1="0"),e.test(tt.reactionStr_2)&&(tt.reactionStr_2="0"),e.test(tt.reactionStr_3)&&(tt.reactionStr_3="0")}switch(dn){case 3:tt.diffusionStr_2_2="0";break;case 6:tt.diffusionStr_3_3="0";break;case 7:tt.diffusionStr_2_2="0",tt.diffusionStr_3_3="0";break;case 10:tt.diffusionStr_4_4="0";break;case 11:tt.diffusionStr_3_3="0",tt.diffusionStr_4_4="0";break;case 12:tt.diffusionStr_2_2="0",tt.diffusionStr_3_3="0",tt.diffusionStr_4_4="0"}bi(at),bi(rt)}function qi(){!function(){switch(Vi(),parseInt(tt.numSpecies)){case 1:dn=0;break;case 2:dn=tt.crossDiffusion?1==tt.numAlgebraicSpecies?3:2:1;break;case 3:if(tt.crossDiffusion)switch(tt.numAlgebraicSpecies){case 0:dn=5;break;case 1:dn=6;break;case 2:dn=7}else dn=4;break;case 4:if(tt.crossDiffusion)switch(tt.numAlgebraicSpecies){case 0:dn=9;break;case 1:dn=10;break;case 2:dn=11;break;case 3:dn=12}else dn=8}}(),fo(),mo(),Ui(),ki(),_o(),Do(),Mi()}function Mi(){let e,t=Dn[dn];const n={U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(tt.typesetCustomEqs){let o={};o.U=tt.diffusionStr_1_1,o.UU=tt.diffusionStr_1_1,o.V=tt.diffusionStr_2_2,o.VV=tt.diffusionStr_2_2,o.W=tt.diffusionStr_3_3,o.WW=tt.diffusionStr_3_3,o.Q=tt.diffusionStr_4_4,o.QQ=tt.diffusionStr_4_4,o.UV=tt.diffusionStr_1_2,o.UW=tt.diffusionStr_1_3,o.UQ=tt.diffusionStr_1_4,o.VU=tt.diffusionStr_2_1,o.VW=tt.diffusionStr_2_3,o.VQ=tt.diffusionStr_2_4,o.WU=tt.diffusionStr_3_1,o.WV=tt.diffusionStr_3_2,o.WQ=tt.diffusionStr_3_4,o.QU=tt.diffusionStr_4_1,o.QV=tt.diffusionStr_4_2,o.QW=tt.diffusionStr_4_3,o.UFUN=tt.reactionStr_1,o.VFUN=tt.reactionStr_2,o.WFUN=tt.reactionStr_3,o.QFUN=tt.reactionStr_4,Object.keys(o).forEach((function(e){Ia(o[e])&&(o[e]="0")}));var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!Go(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=Po(o[e],yn,ln,"_(?:[xy][xybf]?)")})),It.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){un.includes(e)||(t=function(e,t,n,i){null==i&&(i="  ");let o=n.replace(/\s+/g,"  ").trim();return["0","0.0","-0","-0.0","+0","+0.0"].includes(o)?e.replaceAll(t,""):"1"==o||"1.0"==o?e.replaceAll(t,"$2"):"-1"==o||"-1.0"==o?e.replaceAll(t,i[0]+"-"+i[1]+"$2"):e.replaceAll(t,i[0]+n+i[1]+"$2")}(t,n[e],o[e],"[]"))})),t=ho(t,n.UFUN,o.UFUN),t=ho(t,n.VFUN,o.VFUN),t=ho(t,n.WFUN,o.WFUN),t=ho(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}\(\)]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\(\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"\\lap $1"),e=/\\vnabla\s*\\cdot\s*\(\s*((?!\\vnabla).*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b(?:[xy]|[uvwq](?:_[xy])?|(?:I_[ST][RGBA]?))\b/g.test(t)?e:t.trim()+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])[fb]?2?\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else It.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{ "+t+" ";return"string"==typeof n&&(i+=n),i+" }"}))})),t=Po(t,["UFUN","VFUN","WFUN","QFUN"],un);1==tt.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=Po(t,ln.concat(un),yn.concat(Sn),"_(?:[xy][xybf]?)"),t=Ri(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(Fo)}function Ri(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Ii(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Ii(e,"cos",!0),e=Ii(e,"tan",!0),e=Ii(e,"exp",!0),e=Ii(e,"log",!0),e=Ii(e,"sqrt",!1),e=Ii(e,"sinh",!0),e=Ii(e,"cosh",!0),e=Ii(e,"tanh",!0),e=Ii(e,"max",!0),e=Ii(e,"min",!0),e=di(e=(e=Ii(e,"ind",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",s="";for(var l=0;l<e.length;l++)t.includes(e[l])?(i+=1,o+=1):n.includes(e[l])&&(i-=1),0==i&&o>0&&(r=e.slice(a,l+1),s+=Li(r,o),o=0,a=l+1);return s+=e.slice(a),s}(e=he(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")).replaceAll(/<=/g," \\leq ")).replaceAll(/>=/g," \\geq ")).replaceAll(/([<>])/g," $1 ")}function Ii(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,s,l,u,c,d,h=0;for(const f of o){for(a=f.index,r=a+t.length,l=e.slice(r),d=0,u=0,c=!1;d<=l.length&(!c|!(c&&0==u));)u+=["(","["].includes(l[d]),u-=[")","]"].includes(l[d]),c|=u,d+=1;c&&0==u&&(s=d-1+r,i=Oi(i,"\\",a+h),h+=1,n?(i=Oi(i,"{",r+h),h+=1,i=Oi(i,"}",s+1+h),h+=1):(i=Bi(i,"{",r+h),i=Bi(i,"}",s+h)))}return i}function Li(e,t){const n=["(","["],i=[")","]"];let o=Ni(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=Bi(e,n[o],a),o+=1,o=Ni(o,n.length)):i.includes(e[a])&&(o-=1,o=Ni(o,n.length),e=Bi(e,i[o],a));return e}function Ni(e,t){return(e%t+t)%t}function Bi(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function Oi(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Wi(e){return e=e.replace(/\s+/g,"  ").trim()}function ji(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=nn[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);nn[e]=nn[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),bi(Vt),Qi(),Zn(),(_o()||zt)&&(zt=!1,Do())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)on.push(e),nn[e]="",n=Vt.add(nn,e).name(""),Fa(n.domElement.firstChild),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=on.indexOf(e);let n=Wi(nn[on.at(t)]);if(""==n);else{let e=ji(on.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);if(i){let t=i[1];Ua(t),e.lastName=t,an[t]=e}rn+=1;let o="params"+rn;this.remove(),ji(o,!0),Qi(),(_o()||zt)&&(zt=!1,Do())}}));else{n=Vt.add(nn,e).name(""),Fa(n.domElement.firstChild),n.domElement.classList.add("params");const t=nn[e].match(/\s*(\w+)\s*=/);if(t){let e=t[1];Ua(e),n.lastName=e,an[e]=n}n.onFinishChange((function(){let t=Wi(nn[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=on.indexOf(e);on.splice(t,1),delete nn[e],n.hasOwnProperty("lastName")&&!co(n.lastName)&&delete nt[n.lastName]}else{i();const e=xo(t).match(/\s*(\w+)\s*=/);if(e){let t=e[1];Ua(t),n.hasOwnProperty("lastName")&&n.lastName!=t&&!co(n.lastName)&&(delete nt[n.lastName],n.lastName=t,an[t]=n)}}Qi(),_o()&&Do()}))}return i(),Fa(n.domElement.firstChild),n}function Qi(){tt.kineticParams=Object.values(nn).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function zi(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function Gi(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function Hi(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function Yi(){if(tt.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+ko(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==tt.whatToPlot?($("#minLabel").html("$"+yn[0]+"$"),$("#midLabel").html("$"+yn[1]+"$"),$("#maxLabel").html("$"+yn[2]+"$")):Wt?$("#midLabel").html(tt.views[tt.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+Ri(tt.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),go(),Ji()}else $("#colourbar").hide()}function Ji(){if("MAX"!=tt.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[Zi(e,n),Zi(t,n)]}(tt.minColourValue,tt.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=Eo(ko(0)),t=Eo(ko(.5)),n=Eo(ko(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function Xi(e,t){return e.toPrecision(t)}function Zi(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function Ki(){tt.timeDisplay?($("#timeDisplay").show(),eo()):$("#timeDisplay").hide(),io()}function eo(){if(tt.timeDisplay){let e=Xi(nt.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/,"  10<sup>$2$3<sup>"),$("#timeValue").html(e),ro()}}function to(){if(tt.integrate){$("#integralDisplay").show();let e="";1==tt.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+Ri(tt.whatToPlot)+"\\,\\d x",1==tt.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();io()}function no(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function io(){tt.integrate&&tt.timeDisplay?no("#timeDisplay",10):no("#timeDisplay",0)}function oo(){let e=Ai();!Ot||isFinite(e[0])&&isFinite(e[1])?_t=setTimeout(oo,1e3):(Ot=!1,Gi("#oops_hit_nan"),ai(),$("#erase").one("pointerdown",(function(){Hi("#oops_hit_nan"),Ot=!0,window.clearTimeout(_t),_t=setTimeout(oo,1e3)})))}function ao(){if(!wn){try{ye.readRenderTargetPixels(Fe,0,0,Dt,xt,pn)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}wn=!0}}function ro(){if(tt.colourbar&&(tt.integrate||tt.timeDisplay)){let e,t=$("#colourbar")[0].getBoundingClientRect();e=tt.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(no("#dataContainer",40),Qt=!0):Qt&&(no("#dataContainer",0),Qt=!1)}}function so(){lo()?(kt.forEach((e=>{e.texture.magFilter=ee.NearestFilter})),Fe.texture.magFilter=ee.NearestFilter,Ee.texture.magFilter=ee.NearestFilter):(kt.forEach((e=>{e.texture.magFilter=ee.LinearFilter})),Fe.texture.magFilter=ee.LinearFilter,Ee.texture.magFilter=ee.LinearFilter),ki()}function lo(){return ge||tt.forceManualInterpolation}function uo(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function co(e,t){return null==t&&(t=[]),function(e){return[...(m()+D()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e).concat(["I_T","I_TR","I_TG","I_TB","I_TA","I_S","I_SR","I_SG","I_SB","I_SA"])}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function ho(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function fo(){"line"==tt.plotType?(qo(),tt.brushType="vline",Yn(),bi(rt),je.visible=!1,Ge.visible=!0,tt.contours=!1,tt.emboss=!1,tt.vectorField=!1,Va()):(je.visible=!0,Ge.visible=!1,"surface"==tt.plotType?($("#simCanvas").css("outline","2px #000 solid"),Zt&&(Zt=!1,Ln()),tt.vectorField=!1,Va()):$("#simCanvas").css("outline","")),He.visible=tt.overlay&&"line"==tt.plotType,Jn(),Nn(),ki(),Ra()}function mo(){Lt||(1!=tt.dimension&&"line"==tt.plotType&&(tt.plotType="plane",Ko("plotType"),fo()),1==tt.dimension&&"line"!=tt.plotType&&(tt.plotType="line",tt.vectorField=!1,Ko("plotType"),fo())),1==tt.dimension&&(tt.minY="0.0"),In(),hi(),Mi(),ki(),to()}function po(){const e="line"==tt.plotType?0:tt.cameraTheta,t="line"==tt.plotType?0:tt.cameraPhi,n=(new ee.Vector3).setFromSphericalCoords(1,Math.PI/2-e*Math.PI/180,-t*Math.PI/180);be.position.set(n.x,n.y,n.z),be.lookAt(0,0,0)}function go(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function bo(){return tt.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function vo(e){return xo(e)}function wo(){const e=/^\s*([a-zA-Z]\w*)\b/;let t=[];return bo().split(";").filter((e=>e.length>0)).forEach((function(n){n.match(e)&&t.push(n.match(e)[1].trim())})),t}function _o(){bo().split(";").filter((e=>e.length>0));const e=function(e){let t={},n={},i=[];const o=function(){const e=/^\s*([a-zA-Z]\w*)\b\s*=\s*(.*)/;let t=[];return bo().split(";").filter((e=>e.length>0)).forEach((function(n){const i=n.match(e);i?t.push([i[1].trim(),i[2].trim()]):zo("Unable to evaluate the parameter definition '"+n+"'. Please check for syntax errors.")})),t}(),a=o.map((e=>e[0]));o.forEach((e=>t[e[0]]=e[1]));for(const e of o){let[o,r]=e;o in n||([n,,i]=Co(o,t,n,[o],a,[]))}i.length>0&&zo("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.");return Object.keys(n).map((e=>[e,n[e]]))}(),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}(wo());if(t.length>0)return zo("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=yo(t[0],t[1]);n|=e,i|=o}return n&&!i}function yo(e,t){let n=!1,i=!1;const o=vo(e);return co(o)?(zo("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!nt.hasOwnProperty(o),nt[o]={type:"float",value:t}),[n,i]}function So(){return vo(wo().map((e=>"uniform float "+e+";")).join("\n"))}function Co(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const s of o)r=new RegExp("\\b"+s+"\\b","g"),r.test(t[e])&&(i.includes(s)?(n[s]=0,t[s]="0",t[e]="0",a.push(i.slice(i.indexOf(s)))):([n,,a]=Co(s,t,n,[...i,s],o,a),t[e]=t[e].replaceAll(r,n[s].toString())));try{n[e]=En.evaluate(t[e])}catch(t){zo("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function Do(){hi(),Di(),Yn(),$i(),Hn(),Pi()}function xo(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+_n[e])););return n}function Fo(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function Eo(e){return e.reduce(((e,t)=>e+t),0)/3}function $o(){let e=Ai();tt.minColourValue=e[0],tt.maxColourValue=e[1],nt.maxColourValue.value=tt.maxColourValue,nt.minColourValue.value=tt.minColourValue,qt.maxColourValue.updateDisplay(),qt.minColourValue.updateDisplay(),Ji()}function To(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function Ao(){let e;null!=yn&&(e=yn);const t=tt.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,ln.length),n=t.concat(cn.slice(t.length)),i=wo();let o;for(var a=0;a<n.length;a++)if(co(n[a],i))return o=i.includes(n[a])?"as a parameter":"under the hood",void zo("The name '"+n[a]+"' is used "+o+", so can't be used as a species name. Please use a different name for "+n[a]+".");yn=n,Sn=yn.map((e=>"f_{"+e+"}")),function(){Cn=[];for(let e=0;e<yn.length;e++)Cn.push("(?:"+yn.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let r={...ue(),...de()};if(Object.keys(r).forEach((function(e){xn[e]=Ri(Po(r[e],ln,yn,"_(?:[xy][xybf]?)"))})),r=ce(),Object.keys(r).forEach((function(e){xn[e]=Ri(Po(r[e],un,Sn))})),Lt)return;const s=["initCond_1","initCond_2","initCond_3","initCond_4","kineticParams"];Object.keys(tt).forEach((function(t){$n.includes(t)&&(s.includes(t)||(tt[t]=Po(tt[t],e,yn,"_(?:[xy][xybf]?)")))})),tt.views=tt.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){$n.includes(i)&&(n[i]=Po(t[i],e,yn,"_(?:[xy][xybf]?)"))})),n})),Object.keys(ot).forEach((function(t){$n.includes(t)&&(s.includes(t)||(ot[t]=Po(ot[t],e,yn,"_(?:[xy][xybf]?)")))})),ot.views=ot.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){$n.includes(i)&&(n[i]=Po(t[i],e,yn,"_(?:[xy][xybf]?)"))})),n})),Ui(),ki(),Do(),Mi()}function Po(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function Vo(e,t){let n,i=e.geometry.attributes.instanceStart,o=e.geometry.attributes.instanceEnd;for(let e=0;e<t.length;e++)n=t[e].toArray(),n[1]*=tt.threeDHeightScale*Et/$t,e<t.length&&i.setXYZ(e,n[0],n[1],0),e>0&&o.setXYZ(e-1,n[0],n[1],0);i.needsUpdate=!0,o.needsUpdate=!0}function ko(e){e=e.clamp(0,1);let t=0;for(;e>=et[t+1]&&t<Ke.length-2;)t+=1;return et[t+1]==et[t]?Ke[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=Uo(e[o],t[o],n);return i}(Ke[t],Ke[t+1],(e-et[t])/(et[t+1]-et[t])).map((e=>e.clamp(0,1)))}function Uo(e,t,n){return(1-(n=n.clamp(0,1)))*e+n*t}function qo(){Re.linewidth=.01*tt.lineWidthMul,Ie.linewidth=.01*tt.overlayLineWidthMul,Re.needsUpdate=!0,Ie.needsUpdate=!0}function Mo(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function Ro(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function Io(e){e.forEach((function(e){It.add(e)})),Mi()}function Lo(e){e.forEach((function(e){It.delete(e)})),Mi()}function No(){gn=new Float32Array(Dt*xt*4),ye.readRenderTargetPixels(kt[1],0,0,Dt,xt,gn),jo(gn),Ht=!0}function Bo(){Ht||No();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([Dt,xt]),gn])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function Oo(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);jo(e.slice(2),e.slice(0,2)),Wo(Te),Ht=!0,si()},t.readAsArrayBuffer(e)}function Wo(e){if(null!=e)if("crop"==tt.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=Se/t;i>1&&(n=t/Se,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function jo(e,t){null!=Te&&Te.dispose(),null==t&&(t=[Dt,xt]),Te=new ee.DataTexture(e,t[0],t[1],ee.RGBAFormat,ee.FloatType),Te.needsUpdate=!0,Te.magFilter=ge?ee.NearestFilter:ee.LinearFilter,null!=Be&&(Be.map=Te,Be.needsUpdate)}function Qo(){ye.setSize(Math.round(devicePixelRatio*At),Math.round(devicePixelRatio*Pt),!1)}function zo(e){ai(),Lt&&Nt||(Nt=!0,$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),Gi("#error")))}function Go(e){if(/\(\s*\)/.test(e))return zo("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(zo("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(zo("A binary operator is missing an operand in "+e.trim()+"."),!1)}function Ho(){let e;$("#views_list").empty();for(let t=0;t<tt.views.length;t++)e=document.createElement("a"),e.onclick=function(){tt.activeViewInd=t,Yo(tt.views[t])},e.innerHTML="<div class='view_label'>"+tt.views[t].name+"</div>",t==tt.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);Yt=Math.max(tt.views.length,Yt),tt.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),tt.views.length}function Yo(e,t){Object.assign(tt,e),delete tt.name,bi(st),(null==t||t)&&($i(),fo(),Jn(),Bn(),Ji(),Yi(),Va(),ya(),Zn())}function Jo(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",tt.views[tt.activeViewInd].name);null!=e&&(tt.views[tt.activeViewInd].name=e,Ho(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function Xo(){tt.views.length>1?(tt.views.splice(tt.activeViewInd,1),tt.activeViewInd<1?tt.activeViewInd=0:tt.activeViewInd-=1):tt.views[tt.activeViewInd].name="Custom",Yo(tt.views[tt.activeViewInd])}function Zo(){let e={};return Fn.forEach((function(t){e[t]=ot[t]})),e}function Ko(e){tt.activeViewInd<tt.views.length&&(tt.views[tt.activeViewInd][e]=tt[e])}function ea(e,t){let n="";return n+=_i(g(t),yn[e]),tt.dimension>1&&(n+=_i(b(t),yn[e])),n}function ta(e,t){let n="";return n+=_i(w(t),yn[e]),tt.dimension>1&&(n+=_i(_(t),yn[e])),n}function na(e,t){let n="";return n+=_i(y(t,ci(tt.domainIndicatorFun)),yn[e]),tt.dimension>1&&(n+=_i(S(t,ci(tt.domainIndicatorFun)),yn[e])),n}function ia(e,t){let n="";return n+=_i(g(t).replaceAll(/updated/g,"gl_FragColor"),yn[e]),tt.dimension>1&&(n+=_i(b(t).replaceAll(/updated/g,"gl_FragColor"),yn[e])),n}function oa(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function aa(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function ra(e,t,n,i,o,a,r,s){const l=document.createElement("a");if(l.classList.add("toggle_button"),l.setAttribute("property",t),null==i&&(i=()=>{}),l.onclick=function(){tt[l.getAttribute("property")]=!tt[l.getAttribute("property")],xa(l),i()},null!=o&&(l.id=o),null!=a&&(l.title=a),null!=n&&(l.innerHTML=n),null!=r&&l.setAttribute("folderID",r),null!=s)for(const e of s)l.classList.add(e);return e.appendChild(l),xa(l),l}function sa(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function la(){const e=Object.assign(z("default"),z(tt.parent));let t=Ti(tt,e);1==tt.views.length&&"1"==tt.views[0].name&&delete t.views;for(const e of Object.keys(tt.views[0]))tt.hasOwnProperty(e)&&tt.views.map((t=>t[e])).every((t=>t==tt[e]))&&tt.views.forEach((t=>delete t[e]));t.preset="PRESETNAME";let n=JSON.stringify(t).replaceAll(/(:[^:]*),/g,"$1,\n\t").replaceAll(":",": ").replaceAll("  "," ").replaceAll("{","{\n\t").replaceAll("}",",\n}");n='listOfPresets["PRESETNAME"] = '+n+";\n",navigator.clipboard.writeText(n)}function ua(){let e="";e+=JSON.stringify(tt),e+=JSON.stringify(nt),e+=JSON.stringify({nXDisc:Dt,nYDisc:xt,domainHeight:Et,domainWidth:Ft,aspectRatio:Se,canvas:me.getBoundingClientRect()}),navigator.clipboard.writeText(e)}function ca(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function da(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function ha(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function fa(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function ma(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function pa(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function ga(){let e=Ti(tt,z("default"));return e.preset="Custom",e=ae(e),[location.href.replace(location.search,""),"?options=",se.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function ba(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function va(e){const t=an[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function wa(){nt.embossAmbient.value=tt.embossAmbient,nt.embossDiffuse.value=tt.embossDiffuse,nt.embossShiny.value=tt.embossShiny,nt.embossSmoothness.value=tt.embossSmoothness,nt.embossSpecular.value=tt.embossSpecular,nt.embossLightDir.value=new ee.Vector3(Math.sin(tt.embossTheta)*Math.cos(tt.embossPhi),Math.sin(tt.embossTheta)*Math.sin(tt.embossPhi),Math.cos(tt.embossTheta))}function _a(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function ya(){for(const e of[...Rt,...Mt]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function Sa(){nt.contourColour.value=new ee.Color(tt.contourColour),nt.contourEpsilon.value=tt.contourEpsilon,nt.contourStep.value=1/(tt.contourNum+1)}function Ca(){nt.overlayColour.value=new ee.Color(tt.overlayColour),nt.overlayEpsilon.value=tt.overlayEpsilon,nt.overlayLine.value=tt.overlay&&"line"==tt.plotType,Ie.color=new ee.Color(tt.overlayColour),Ie.needsUpdate=!0}function Da(){gt||Zn()}function xa(e){tt[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function Fa(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function Ea(){tt.customSurface?Pe.vertexShader=O():Pe.vertexShader=B(),Pe.needsUpdate=!0}function $a(){"surface"==tt.plotType?($(ut).show(),tt.customSurface?(qt.surfaceFun.show(),qt.threeDHeightScale.hide()):(qt.surfaceFun.hide(),qt.threeDHeightScale.show())):($(ut).hide(),qt.surfaceFun.hide())}function Ta(){Ze=new ee.Group,we.add(Ze);const e=Math.max(Dt,xt),t=Math.round(Uo(3,window.width<629?20:64,tt.arrowDensity));let n=Math.max(Math.floor(e/t),1);const i=Math.floor(Dt/n),o=Math.floor(xt/n),a=Math.floor((Dt-n*(i-1))/2),r=Math.floor((xt-n*(o-1))/2);let s,l,u,c,d,h;for(let e=0;e<o;e++){l=r+e*n,h=((l+.5)/xt-.5)*je.geometry.parameters.height;for(let e=0;e<i;e++)u=a+e*n,d=((u+.5)/Dt-.5)*je.geometry.parameters.width,s=u+l*Dt,c=Aa([d,h,1],[0,0,0]),c.ind=s,Ze.add(c)}}function Aa(e,t){const n=new ee.Group,i=new ee.Mesh(Oe,Le);i.rotation.x=Math.PI/2;const o=new ee.Mesh(We,Le);return o.rotation.x=Math.PI/2,o.rotation.y=Math.PI/4,o.position.z=Oe.parameters.height/2,n.add(i),n.add(o),n.scale.multiplyScalar(tn),n.position.set(e[0],e[1],e[2]),n.lookAt(e[0]+t[0],e[1]+t[1],e[2]+t[2]),n}function Pa(){if(Ze)for(we.remove(Ze);Ze.children.length;)Ze.remove(Ze.children[0])}function Va(){if(nt.vectorField.value=tt.vectorField,tt.vectorField){if(Pa(),Ta(),ka(),"relative"==tt.arrowScale)try{Ze.customMax=En.evaluate(tt.arrowLengthMax)}catch(e){zo("Unable to evaluate the maximum arrow length. Please check the definition."),Ze.customMax=1}}else Pa()}function ka(){Le.color=new ee.Color(tt.arrowColour)}function Ua(e){const t=co(e,yn.concat(Sn));return t&&zo("The name '"+e+"' is already in use, so can't be used as a parameter name. Please use a different name for "+e+"."),!t}function qa(e){return e=(e=e.replaceAll(/\bMINX\b/g,(()=>ci(tt.minX)))).replaceAll(/\bMINY\b/g,(()=>ci(tt.minY)))}function Ma(e,t,n,i,o){if(e in t)return[t,n.slice(0,-1),o];for(const a of i[e])n.includes(a)?o.push(n.slice(n.indexOf(a))):[t,,o]=Ma(a,t,[...n,a],i,o);return t[e]=!0,[t,n.slice(0,-1),o]}function Ra(){if($("#simCanvas").css("cursor","auto"),tt.brushEnabled&&"surface"!=tt.plotType&&"line"!=tt.plotType)switch(tt.brushType){case"circle":$("#simCanvas").css("cursor","url('images/cursor-circle.svg') 12 12, auto");break;case"hline":$("#simCanvas").css("cursor","url('images/cursor-hline.svg') 32 32, auto");break;case"vline":$("#simCanvas").css("cursor","url('images/cursor-vline.svg') 32 32, auto")}}function Ia(e){return/^\s*$/.test(e)}function La(){const e=Shepherd.activeTour?.getCurrentStep(),t=e?.getElement(),n=t?.querySelector(".shepherd-header"),i=document.createElement("span");i.classList.add("shepherd-progress"),i.innerText=`${Shepherd.activeTour?.steps.indexOf(e)+1} / ${Shepherd.activeTour?.steps.length}`,n?.insertBefore(i,t.querySelector(".shepherd-cancel-icon"))}function Na(e,t){const n=Shepherd.activeTour?.getCurrentStep(),i=n?.getElement(),o=i?.querySelector(".shepherd-footer"),a=document.createElement("a");a.setAttribute("href",e),a.setAttribute("target","_blank"),a.classList.add("shepherd-more-info"),a.innerText=t||"More info.",o?.insertBefore(a,o.firstChild)}(zi()||kn||tt.forceTryClickingPopup)&&!tt.suppressTryClickingPopup&&tt.brushEnabled&&($("#top_message").html("<p>"+tt.tryClickingText+"</p>"),Gi("#top_message"),setTimeout((()=>Hi("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>Hi("#top_message")))),Lt=!1,function e(){requestAnimationFrame(e),vt=bt,bt&&tt.brushEnabled&&function(){!tt.setSeed&&tt.brushValue.includes("RAND")&&Ci();Qe.material=Ve;for(let e=1;e<kt.length;e++)nt.textureSource.value=kt[e].texture,ye.setRenderTarget(kt[e-1]),ye.render(_e,ve);kt.rotate(-1)}();if(gt){!wt||function(){Qe.material=ke;for(let e=1;e<kt.length;e++)nt.textureSource.value=kt[e].texture,ye.setRenderTarget(kt[e-1]),ye.render(_e,ve);kt.rotate(-1)}();for(let e=0;e<tt.numTimestepsPerFrame;e++){if(tt.autoPause&&Bt&&nt.t.value>=tt.autoPauseAt){Bt=!1,ai();break}jt&&!tt.setSeed&&Ci(),Xn()}}(vt||gt)&&Zn()}()}();