import{drawShaderTop as e,drawShaderBotReplace as t,drawShaderBotAdd as n,drawShaderShapeDisc as i,drawShaderShapeVLine as o,drawShaderShapeHLine as a,drawShaderFactorSharp as r,drawShaderFactorSmooth as s}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as l,computeDisplayFunShaderMid as u,postGenericShaderBot as c,postShaderDomainIndicator as d,interpolationShader as h,minMaxShader as f}from"./post_shaders.js";import{copyShader as m}from"../copy_shader.js";import{RDShaderTop as p,RDShaderBot as g,RDShaderDirichletX as b,RDShaderDirichletY as v,RDShaderDirichletIndicatorFun as w,RDShaderRobinX as _,RDShaderRobinY as y,RDShaderRobinCustomDomainX as S,RDShaderRobinCustomDomainY as C,RDShaderUpdateNormal as x,RDShaderUpdateCross as D,RDShaderAlgebraicSpecies as F,RDShaderEnforceDirichletTop as E,RDShaderAdvectionPreBC as T,RDShaderAdvectionPostBC as A,RDShaderDiffusionPreBC as P,RDShaderDiffusionPostBC as U,RDShaderGhostX as V,RDShaderGhostY as k,RDShaderMain as q}from"./simulation_shaders.js";import{randShader as M,randNShader as R}from"../rand_shader.js";import{fiveColourDisplayTop as I,fiveColourDisplayBot as L,embossShader as N,contourShader as B,surfaceVertexShaderColour as O,surfaceVertexShaderCustom as W,overlayShader as j}from"./display_shaders.js";import{getColours as Q}from"../colourmaps.js";import{genericVertexShader as G}from"../generic_shaders.js";import{getPreset as z,getUserTextFields as H,getFieldsInView as Y,getListOfPresets as J,getOldPresetFieldsToNew as X,getListOfPresetNames as Z}from"./presets.js";import{clearShaderBot as K,clearShaderTop as ee}from"./clear_shader.js";import*as te from"../three.module.min.js";import{OrbitControls as ne}from"../OrbitControls.js";import{Line2 as ie}from"../lines/Line2.js";import{LineMaterial as oe}from"../lines/LineMaterial.js";import{LineGeometry as ae}from"../lines/LineGeometry.js";import{minifyPreset as re,maxifyPreset as se}from"./minify_preset.js";import{LZString as le}from"../lz-string.min.js";import{equationTEXFun as ue,getDefaultTeXLabelsDiffusion as ce,getDefaultTeXLabelsReaction as de,getDefaultTeXLabelsBCsICs as he,substituteGreek as fe}from"./TEX.js";import{closestMatch as me}from"../../../assets/js/closest-match.js";import{Stats as pe}from"../stats.min.js";!async function(){let ge,be,ve,we,_e,ye,Se,Ce,xe,De,Fe,Ee,$e,Te,Ae,Pe,Ue,Ve,ke,qe,Me,Re,Ie,Le,Ne,Be,Oe,We,je,Qe,Ge,ze,He,Ye,Je,Xe,Ze,Ke,et,tt,nt,it,ot,at,rt,st,lt,ut,ct,dt,ht,ft,mt,pt,gt,bt,vt,wt,_t,yt,St,Ct,xt,Dt,Ft,Et,$t,Tt,At,Pt,Ut,Vt,kt,qt,Mt,Rt=[],It=[],Lt={},Nt=[],Bt=[],Ot=[],Wt=new Set,jt=!0,Qt=!1,Gt=!0,zt=!0,Ht=!1,Yt=!1,Jt=!1,Xt=!1,Zt=!1,Kt=!1,en=0,tn=0,nn=performance.now(),on=!1,an=null,rn=!0,sn=1,ln=1,un=.15,cn={},dn=[],hn={},fn=0;const mn="GrayScott",pn=["u","v","w","q"],gn=["UFUN","VFUN","WFUN","QFUN"],bn=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"];let vn,wn,_n,yn,Sn,Cn,xn,Dn=!1,Fn=!1;const En=["zero","one","two","three","four","five","six","seven","eight","nine"];let $n,Tn,An,Pn=ue(),Un={...ce(),...de(),...he()};const Vn=Y();let kn=new exprEval.Parser;kn.consts.pi=Math.PI,kn.consts.Pi=Math.PI,kn.consts.e=Math.exp(1);const qn=new pe;qn.showPanel(0),qn.dom.id="stats",document.body.appendChild(qn.dom),ot={};const Mn=H();var Rn,In;st={reset:function(){pi()},toggleRunning:function(){_t?fi():mi()},copyConfigAsURL:function(){Ea(Fa())},saveSimState:function(){Yo()},exportSimState:function(){Jo()},clearCheckpoints:function(){Kt&&(Pe.dispose(),Pe=null,Kt=!1)}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(Rn=Array.prototype.push,In=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,Rn.apply(this,In.call(this,0,e)),this}),ge=document.getElementById("simCanvas"),console.error=function(e){Xt=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),ta(t.toString().trim()+". Click <a href='/user-guide/FAQ#undeclared' target='blank'>here</a> for more information.")},eo()||$("#logo").hide();const Ln=new URLSearchParams(window.location.search);Ln.has("no_ui")?($(".ui").addClass("hidden"),Zt=!0):$(".ui").removeClass("hidden");const Nn=Ln.has("logo_only");Nn&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),Zt=!0),Ln.has("sf")&&(ln=parseFloat(Ln.get("sf")),(isNaN(ln)||ln<=0)&&(ln=1)),Di("default"),function(){at={brushCoords:{type:"v2",value:new te.Vector2(.5,.5)},colour1:{type:"v4",value:new te.Vector4(0,0,0,0)},colour2:{type:"v4",value:new te.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new te.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new te.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new te.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},overlayLine:{type:"bool",value:!0},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},vectorField:{type:"bool",value:!1}},rt={firstFlag:{type:"bool"},srcResolution:{type:"v2"},textureSource:{type:"t"}},yt=!1,Fe=new te.Raycaster,Ee=new te.Vector2,Ce=new te.WebGLRenderer({canvas:ge,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),Ce.autoClear=!0,be=Ce.getContext(),Vt=be.getParameter(be.MAX_TEXTURE_SIZE),ve=!(be.getExtension("OES_texture_float_linear")&&be.getExtension("EXT_float_blend")),Ae={format:te.RGBAFormat,type:te.FloatType,minFilter:te.NearestFilter},ve|=/android/i.test(navigator.userAgent),Ae.magFilter=ve?te.NearestFilter:te.LinearFilter,Rt.push(new te.WebGLRenderTarget(ot.maxDisc,ot.maxDisc,Ae)),Rt.push(Rt[0].clone()),Rt.push(Rt[0].clone()),Rt.push(Rt[0].clone()),Rt.push(Rt[0].clone()),$e=Rt[0].clone(),Te=Rt[0].clone(),Rt.forEach((e=>{e.texture.wrapS=te.RepeatWrapping,e.texture.wrapT=te.RepeatWrapping})),$e.texture.wrapS=te.ClampToEdgeWrapping,$e.texture.wrapT=te.ClampToEdgeWrapping,Te.texture.wrapS=te.ClampToEdgeWrapping,Te.texture.wrapT=te.ClampToEdgeWrapping,we=new te.OrthographicCamera(-.5,.5,.5,-.5,-1,10),De=new ne(we,ge),De.listenToKeyEvents(document),De.addEventListener("change",(function(){"surface"==ot.plotType&&(ot.cameraTheta=90-180*Math.acos(we.position.y)/Math.PI,ot.cameraPhi=-180*Math.atan2(we.position.x,we.position.z)/Math.PI,ot.cameraZoom=we.zoom,la("cameraTheta"),la("cameraPhi"),la("cameraZoom"),Fi(dt),ka())})),_e=new te.OrthographicCamera(-.5,.5,.5,-.5,-1,10),_e.position.z=1,ye=new te.Scene,Se=new te.Scene,ye.add(we),ye.background=new te.Color(ot.backgroundColour),Ue=new te.MeshBasicMaterial({side:te.DoubleSide}),Ve=new te.ShaderMaterial({uniforms:at,vertexShader:G(),transparent:!0,side:te.DoubleSide}),Ie=new te.ShaderMaterial({uniforms:at,vertexShader:G()}),Oe=new te.ShaderMaterial({uniforms:at,vertexShader:G(),fragmentShader:h()}),ke=new te.ShaderMaterial({uniforms:at,vertexShader:G()}),Lt.FE=new te.ShaderMaterial({uniforms:at,vertexShader:G()}),Lt.AB2=new te.ShaderMaterial({uniforms:at,vertexShader:G()});for(let e=1;e<3;e++)Lt["Mid"+e.toString()]=new te.ShaderMaterial({uniforms:at,vertexShader:G()});for(let e=1;e<5;e++)Lt["RK4"+e.toString()]=new te.ShaderMaterial({uniforms:at,vertexShader:G()});Re=new te.ShaderMaterial({uniforms:at,vertexShader:G(),fragmentShader:m()}),Me=new te.ShaderMaterial({uniforms:at,vertexShader:G()}),qe=new te.ShaderMaterial({uniforms:at,vertexShader:G()}),Le=new oe({vertexColors:!0,linewidth:.01}),Ne=new oe({color:0,linewidth:.01}),Be=new te.MeshBasicMaterial({color:ot.arrowColour,side:te.DoubleSide}),We=new te.MeshBasicMaterial,je=new te.ShaderMaterial({uniforms:rt,vertexShader:G(),fragmentShader:f()}),Qe=new te.CylinderGeometry(.008,.008,.1),Ge=new te.ConeGeometry(.04,.04,4);const e=new te.PlaneGeometry(1,1);He=new te.Mesh(e,Lt[0]),He.position.z=0,He.matrixWorldAutoUpdate=!1,Se.add(He),Xn(),Zn(),Hn(),ei(),Gn(),ti(),Bi(),Wi(),ii(),ni(),Vi(),bo(),pi(),ge.addEventListener("pointerdown",li),ge.addEventListener("pointerup",ui),ge.addEventListener("pointermove",ci),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(st.toggleRunning(),e.preventDefault()),"h"===e.key&&(Zt?(Zt=!1,$(".ui").removeClass("hidden"),bt.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",Ft),_t?mi():fi(),go(),Do(),qo()):(Zt=!0,$(".ui").addClass("hidden"))),"s"==e.key&&Yo(),"c"==e.key&&(ot.resetFromCheckpoints=!ot.resetFromCheckpoints,qa($("#checkpointButton")[0])))})),window.addEventListener("resize",(function(){Gn(),ka()}),!1),window.addEventListener("message",$a),$("#checkpointInput").change((function(){Xo(this.files[0]),this.value=null}))}();let Bn=!0;if(Ln.has("preset")&&(xi(Ln.get("preset")),Bn=!1),Ln.has("options")){var On=JSON.parse(le.decompressFromEncodedURIComponent(Ln.get("options")));On.hasOwnProperty("p")&&(On=se(On)),xi(On),Bn=!1}Bn&&xi(mn),Ht=Ln.has("story"),Ht&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),bt.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),io(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#play_pause_placeholder").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),Ft=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),$("#settings").click((function(){_a(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&Ca(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&xa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&ya(),$("#views_ui").is(":visible")&&Sa()),$("#left_ui").is(":visible")&&qo()})),$("#equations").click((function(){ya(),qo(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&_a(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&Sa()})),$("#pause").click((function(){fi()})),$("#play").click((function(){mi()})),$("#erase").click((function(){pi()})),$("#share").click((function(){xa(),$("#help_panel").is(":visible")&&Ca()})),$("#help").click((function(){Ca(),$("#share_panel").is(":visible")&&xa()})),$("#screenshot").click((function(){Dn=!0,ri(),xa()})),$("#link").click((function(){st.copyConfigAsURL(),xa()})),$("#embed").click((function(){!function(){let e=Fa();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}Ea('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),xa()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){Ca()})),$("#views").click((function(){Sa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&_a(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&ya()})),$("#error_close_button").click((function(){no("#error")})),$("#preset_error_close_button").click((function(){no("#bad_preset")})),$("#oops_hit_nan_close").click((function(){no("#oops_hit_nan"),zt=!0})),$("#start_tour").click((function(){$("#welcome").css("display","none"),Wn.start()})),$(document).on("click","#add_view",(function(){!function(){let e=sa();e.name=++en,ot.views.push(e),ot.activeViewInd=ot.views.length-1,ia()}()}));const Wn=new Shepherd.Tour({useModalOverlay:!0,defaultStepOptions:{classes:"shadow-md bg-purple-dark",scrollTo:!1,cancelIcon:{enabled:!0},buttons:[{action(){return this.back()},classes:"shepherd-button-secondary",text:"Back"},{action(){return this.next()},text:"Next"}],when:{show(){Ya()}}}});let jn="Interactivity is at the heart of VisualPDE. In most simulations, clicking on the screen allows you to interact directly with the solution.<br><video autoplay loop playsinline muted disableRemotePlayback poster=\"../assets/images/demo.webp\" width=\"128\" style=\"margin-top:10px\"><source src='../assets/ani/demo.mp4' type='video/mp4'><source src='../assets/ani/demo.webm' type='video/webm'></video><br>This can even kickstart pattern formation or other exciting phenomena.";Da()&&(jn=jn.replaceAll("clicking","tapping"),jn=jn.replaceAll("click","tap"),jn=jn.replaceAll("Clicking","Tapping"),jn=jn.replaceAll("Click","Tap")),Wn.addStep({title:"Playing with PDEs",text:jn,buttons:[{action(){return this.next()},text:"Next"}]}),Wn.addStep({title:"Equations and definitions",text:"Customise the equations, parameters, boundary and initial conditions of the simulation.<br><video autoplay loop playsinline muted disableRemotePlayback width=\"216\" style=\"margin-top:10px\"><source src='../assets/ani/params.mp4' type='video/mp4'><source src='../assets/ani/params.webm' type='video/webm'></video>",attachTo:{element:"#equations",on:"right"},when:{show(){Ya(),Ja("/user-guide/advanced-options.html#equations")}}}),Wn.addStep({title:"Play/pause",text:"Play or pause the simulation. You can still draw when paused.",attachTo:{element:"#play_pause_placeholder",on:"right"}}),Wn.addStep({title:"Reset",text:"Click to restart the simulation. You can change the initial conditions in the equations menu.",attachTo:{element:"#erase",on:"right"},when:{show(){Ya(),Ja("/user-guide/advanced-options.html#checkpoints","Advanced")}}}),Wn.addStep({title:"Views",text:"The Views menu lets you customise your view of the solution. This includes everything from contours to colour bars.<br><div class=views_pics><img src='../assets/images/FHNTuringWave.webp'><img src='../assets/images/midnight_soliton.webp'><img src='../assets/images/complexGinzburgLandau.webp'></div>",attachTo:{element:"#views",on:"right"},when:{show(){Ya(),Ja("/user-guide/advanced-options.html#views")}}}),Wn.addStep({title:"Settings",text:"Tweak advanced options such as the equation type, the domain resolution and the timestepping scheme.",attachTo:{element:"#settings",on:"right"},when:{show(){Ya(),Ja("/user-guide/advanced-options.html#settings")}}}),Wn.addStep({title:"Sharing",text:"VisualPDE is built for sharing. Copy a link that leads straight to the current simulation, download snapshots of your solution or even embed your simulation in your own site.",attachTo:{element:"#share",on:"right"},when:{show(){Ya(),Ja("/user-guide/FAQ.html#sharing")}}}),Wn.addStep({title:"Help",text:"Help is always at hand. Access FAQs, detailed documentation and guides explaining how to do everything that's possible in VisualPDE. You can even restart this tour.",attachTo:{element:"#help",on:"right"},buttons:[{action(){return this.back()},classes:"shepherd-button-secondary",text:"Back"},{action(){return this.complete()},text:"Finish"}]});const Qn=!(Ht||Zt);if((!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("visited"==e[t].split("=")[0].trim())return!0}return!1}()||Qn&&!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("seenFullWelcome"==e[t].split("=")[0].trim())return!0}return!1}())&&"Banner"!=ot.preset&&!Nn){let e=_t;fi();let t="welcome_no";Qn||($("#tour_question").hide(),$("#lets_go_cont").show(),t="lets_go"),$("#welcome").css("display","block");const n=await Promise.race([wo(document.getElementById("welcome_ok"),"click",!0),wo(document.getElementById(t),"click",!1)]);$("#welcome").css("display","none"),function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="visited=true;"+t+";path=/"}(),Qn&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="seenFullWelcome=true;"+t+";path=/"}(),n&&await new Promise((function(e){["complete","cancel"].forEach((function(t){Shepherd.once(t,(()=>e()))})),Wn.start()})),$("#help").is(":visible")&&($("#get_help").fadeIn(1e3),setTimeout((()=>$("#get_help").fadeOut(1e3)),4e3)),e&&mi()}function Gn(){Xn(),function(){He.material=Re;for(let e=1;e<Rt.length;e++)at.textureSource.value=Rt[e].texture,Rt[e-1].setSize($t,Tt),Ce.setRenderTarget(Rt[e-1]),Ce.render(Se,_e);Rt.rotate(-1),Rt[0].dispose(),Rt[0]=Rt[1].clone(),$e.setSize($t,Tt),si(),It.forEach((e=>e.dispose())),It=[];let e=$t,t=Tt;const n={format:te.RGBAFormat,type:te.FloatType,minFilter:te.NearestFilter,magFilter:te.NearestFilter,wrapS:te.ClampToEdgeWrapping,wrapT:te.ClampToEdgeWrapping};for(;e>1||t>1;)e=Math.max(1,Math.ceil(e/2)),t=Math.max(1,Math.ceil(t/2)),It.push(new te.WebGLRenderTarget(e,t,n));Te.setSize(Math.round(devicePixelRatio*kt),Math.round(devicePixelRatio*qt))}(),Zo(Pe),Yn(),zn(),Oa(),Hn(),Do(),qo()}function zn(){ze.geometry.dispose(),ye.remove(ze),Ye.geometry.dispose(),ye.remove(Ye),Je.geometry.dispose(),ye.remove(Je),Xe.geometry.dispose(),ye.remove(Xe),Zn()}function Hn(){switch(Jn(),ot.plotType){case"line":De.enabled=!1,we.zoom=1,xo(),Ve.vertexShader=O();break;case"plane":De.enabled=!1,De.reset(),Ve.vertexShader=G();break;case"surface":De.enabled=!0,we.zoom=ot.cameraZoom,xo(),Ra()}Ve.needsUpdate=!0,we.left=-At/(2*Ut),we.right=At/(2*Ut),we.top=Pt/(2*Ut),we.bottom=-Pt/(2*Ut),we.updateProjectionMatrix(),Kn()}function Yn(){at.L.value=sn,at.L_y.value=Pt,at.L_x.value=At,at.L_min.value=Math.min(Pt,At),at.dt.value=ot.dt,at.dx.value=Et,at.dy.value=Et,at.heightScale.value=ot.threeDHeightScale,at.maxColourValue.value=ot.maxColourValue,at.minColourValue.value=ot.minColourValue,at.customSurface.value=ot.customSurface,at.vectorField.value=ot.vectorField,Ta(),Ui()}function Jn(){try{sn=kn.evaluate(ot.domainScale)}catch(e){ta("Unable to evaluate the domain length. Please check the definition."),sn=100}kt=Math.round(ge.getBoundingClientRect().width),qt=Math.round(ge.getBoundingClientRect().height),xe=qt/kt,xe<=0&&(xe=.1),xe>=1?(Pt=sn,At=Pt/xe):(At=sn,Pt=At*xe),1==ot.dimension&&(At=sn),at.L_x.value=At,at.L_y.value=Pt,Ut=Math.max(At,Pt)}function Xn(){Jn(),Et=sn/100;try{Et=kn.evaluate(ot.spatialStep)}catch(e){ta("Unable to evaluate the spatial step. Please check the definition.")}Et<=0&&(ta("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),Et=sn/100),$t=Math.floor(At/Et),Tt=Math.floor(Pt/Et),($t>Vt||Tt>Vt)&&(ta("Your device does not support a discretisation this fine (maximum "+Vt+"). Please increase the space step to at least "+(Math.ceil(1e4*sn/Vt)/1e4).toPrecision(4)+" or reduce the domain size to at most "+(Math.floor(1e4*Vt*Et)/1e4).toPrecision(4)+"."),$t=Math.min($t,Vt),Tt=Math.min(Tt,Vt)),0==$t&&($t=1),0==Tt&&(Tt=1),1==ot.dimension&&(Tt=1),at.nXDisc.value=$t,at.nYDisc.value=Tt,Ze=new Array($t),Ke=new Array($t);let e=-.5,t=$t>1?1/($t-1):.5;for(let n=0;n<Ze.length;n++)Ze[n]=e,e+=t;Ze=Ze.map((e=>e*At/Ut)),ea(),Sn=new Float32Array($t*Tt*4),Fn=!1}function Zn(){Jn();let e=[1,1];rn||(e=[$t,Tt]);const t=new te.PlaneGeometry(At/Ut,Pt/Ut,e[0],e[1]);ze=new te.Mesh(t,Ve),ze.position.z=0,ze.visible="line"!=ot.plotType,ze.matrixAutoUpdate=!1,ye.add(ze);const n=new te.PlaneGeometry(At/Ut,Pt/Ut,1,1);Ye=new te.Mesh(n,Ue),Ye.position.z=0,Ye.visible=!1,Ye.matrixAutoUpdate=!1,ye.add(Ye),Kn();const i=new ae;et=Math.round(2*devicePixelRatio*kt);const o=new Array(3*et).fill(0),a=new Array(o.length).fill(0);i.setPositions(o),i.setColors(a),Je=new ie(i,Le),Je.scale.set(1,1,1),Je.visible="line"==ot.plotType,ye.add(Je);const r=new ae,s=new Array(3*et).fill(0);r.setPositions(s),Xe=new ie(r,Ne),Xe.scale.set(1,1,1),Xe.visible="line"==ot.plotType&&ot.overlay,ye.add(Xe)}function Kn(){switch(ot.plotType){case"plane":ze.rotation.x=0,Ye.rotation.x=0;break;case"surface":ze.rotation.x=-Math.PI/2,Ye.rotation.x=-Math.PI/2}ze.updateMatrix(),Ye.updateMatrix()}function ei(){ot.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function ti(e){ut=new dat.GUI({closeOnTop:!0,autoPlace:!1}),ut.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(ut.domElement),ct=new dat.GUI({closeOnTop:!0,autoPlace:!1}),ct.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(ct.domElement),dt=new dat.GUI({closeOnTop:!0,autoPlace:!1}),dt.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(dt.domElement),ut.open(),ct.open(),dt.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),ht=ct.addFolder("Brush");pa(fa(ht),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',za,null,"Toggle the brush on or off"),Nt.brushAction=ht.add(ot,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange((function(){ii(),document.activeElement.blur()})),Nt.brushType=ht.add(ot,"brushType",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange((function(){ii(),document.activeElement.blur()})),ht.add(ot,"brushValue").name("Value").onFinishChange(ii),ht.add(ot,"brushRadius").name("Radius").onFinishChange(ii),Nt.whatToDraw=ht.add(ot,"whatToDraw",$n).name("Species").onChange(ii),ht=ct.addFolder("Domain"),ht.add(ot,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){Co(),document.activeElement.blur(),ka()})),ht.add(ot,"domainScale").name("Largest side").onFinishChange((function(){Gn(),ka()})),ht.add(ot,"spatialStep").name("Space step").onFinishChange((function(){Gn(),ka()})),ht.add(ot,"minX").name("Min. $x$").onFinishChange((function(){Wi(),pi()})),Nt.minY=ht.add(ot,"minY").name("Min. $y$").onFinishChange((function(){Wi(),pi()}));const t=fa(ht);pa(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){ei(),Gn(),Hn(),ka()}),null,"Use a square domain"),pa(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Custom',(function(){Oi(),Bi(),yi(),Li(),ka()}),null,"Specify a custom domain"),Nt.domainIndicatorFun=ht.add(ot,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){Oi(),Bi(),yi(),Ri(),ka()})),ht=ct.addFolder("Timestepping"),Nt.numTimestepsPerFrame=ht.add(ot,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),Aa(Nt.numTimestepsPerFrame,1,400,1),Nt.dt=ht.add(ot,"dt").name("Timestep").onChange((function(){Yn()})),Nt.dt.__precision=12,Nt.dt.min(0),Nt.dt.updateDisplay(),ht.add(ot,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme").onChange((function(){document.activeElement.blur()}));const n=fa(ht);pa(n,"timeDisplay",'<i class="fa-regular fa-hourglass-half"></i> Elapsed time',so,null,"Show/hide time display"),pa(n,"autoPause",'<i class="fa-regular fa-hourglass-end"></i> Auto pause',(function(){Gt=at.t.value<ot.autoPauseAt,Bi()}),null,"Toggle automatic pausing"),Nt.autoPauseAt=ht.add(ot,"autoPauseAt").name("Pause at $t=$").onFinishChange((function(){Gt=at.t.value<ot.autoPauseAt,Nt.autoPauseAt.domElement.blur()})),ht=ct.addFolder("Equations"),ht.add(ot,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange((function(){document.activeElement.blur(),Wi(),pi()})),Nt.algebraicSpecies=ht.add(ot,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){on=!0,Wi(),on=!1,pi()})),ht.add(ot,"speciesNames").name("Species names").onFinishChange((function(){Lo()}));pa(fa(ht),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',(function(){Wi()}),"cross_diffusion_controller","Toggle cross diffusion"),ht=ut.addFolder("Definitions");pa(fa(ht),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',ji,null,"Typeset the specified equations"),Nt.Duu=ht.add(ot,"diffusionStr_1_1").onFinishChange((function(){yi(),ji()})),Qo(Nt.Duu,zo,["U","UU"]),Go(Nt.Duu,Ho,["U","UU"]),Nt.Duv=ht.add(ot,"diffusionStr_1_2").onFinishChange((function(){yi(),ji()})),Qo(Nt.Duv,zo,["UV"]),Go(Nt.Duv,Ho,["UV"]),Nt.Duw=ht.add(ot,"diffusionStr_1_3").onFinishChange((function(){yi(),ji()})),Qo(Nt.Duw,zo,["UW"]),Go(Nt.Duw,Ho,["UW"]),Nt.Duq=ht.add(ot,"diffusionStr_1_4").onFinishChange((function(){yi(),ji()})),Qo(Nt.Duq,zo,["UQ"]),Go(Nt.Duq,Ho,["UQ"]),Nt.Dvu=ht.add(ot,"diffusionStr_2_1").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dvu,zo,["VU"]),Go(Nt.Dvu,Ho,["VU"]),Nt.Dvv=ht.add(ot,"diffusionStr_2_2").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dvv,zo,["V","VV"]),Go(Nt.Dvv,Ho,["V","VV"]),Nt.Dvw=ht.add(ot,"diffusionStr_2_3").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dvw,zo,["VW"]),Go(Nt.Dvw,Ho,["VW"]),Nt.Dvq=ht.add(ot,"diffusionStr_2_4").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dvq,zo,["VQ"]),Go(Nt.Dvq,Ho,["VQ"]),Nt.Dwu=ht.add(ot,"diffusionStr_3_1").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dwu,zo,["WU"]),Go(Nt.Dwu,Ho,["WU"]),Nt.Dwv=ht.add(ot,"diffusionStr_3_2").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dwv,zo,["WV"]),Go(Nt.Dwv,Ho,["WV"]),Nt.Dww=ht.add(ot,"diffusionStr_3_3").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dww,zo,["W","WW"]),Go(Nt.Dww,Ho,["W","WW"]),Nt.Dwq=ht.add(ot,"diffusionStr_3_4").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dwq,zo,["WQ"]),Go(Nt.Dwq,Ho,["WQ"]),Nt.Dqu=ht.add(ot,"diffusionStr_4_1").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dqu,zo,["QU"]),Go(Nt.Dqu,Ho,["QU"]),Nt.Dqv=ht.add(ot,"diffusionStr_4_2").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dqv,zo,["QV"]),Go(Nt.Dqv,Ho,["QV"]),Nt.Dqw=ht.add(ot,"diffusionStr_4_3").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dqw,zo,["QW"]),Go(Nt.Dqw,Ho,["QW"]),Nt.Dqq=ht.add(ot,"diffusionStr_4_4").onFinishChange((function(){yi(),ji()})),Qo(Nt.Dqq,zo,["Q","QQ"]),Go(Nt.Dqq,Ho,["Q","QQ"]),Nt.f=ht.add(ot,"reactionStr_1").onFinishChange((function(){yi(),ji()})),Qo(Nt.f,zo,["UFUN"]),Go(Nt.f,Ho,["UFUN"]),Nt.g=ht.add(ot,"reactionStr_2").onFinishChange((function(){yi(),ji()})),Qo(Nt.g,zo,["VFUN"]),Go(Nt.g,Ho,["VFUN"]),Nt.h=ht.add(ot,"reactionStr_3").onFinishChange((function(){yi(),ji()})),Qo(Nt.h,zo,["WFUN"]),Go(Nt.h,Ho,["WFUN"]),Nt.j=ht.add(ot,"reactionStr_4").onFinishChange((function(){yi(),ji()})),Qo(Nt.j,zo,["QFUN"]),Go(Nt.j,Ho,["QFUN"]),Mt=ut.addFolder("Parameters"),function(){let e,t,n=[],i=ot.kineticParams.split(";");for(var o=0;o<i.length;o++)t=Xi(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+fn,fn+=1,dn.push(e),cn[e]=t,n.push(e));for(const e of n)Zi(e,!1);e="param"+fn,dn.push(e),cn[e]=t,Zi(e,!0)}(),ht=ut.addFolder("Boundary conditions"),Nt.uBCs=ht.add(ot,"boundaryConditions_1",{}).onChange((function(){yi(),Pi(),document.activeElement.blur()})),Nt.dirichletU=ht.add(ot,"dirichletStr_1").onFinishChange(yi),Nt.neumannU=ht.add(ot,"neumannStr_1").onFinishChange(yi),Nt.robinU=ht.add(ot,"robinStr_1").onFinishChange(yi),Nt.comboU=ht.add(ot,"comboStr_1").name("Details").onFinishChange(yi),Nt.vBCs=ht.add(ot,"boundaryConditions_2",{}).onChange((function(){yi(),Pi(),document.activeElement.blur()})),Nt.dirichletV=ht.add(ot,"dirichletStr_2").onFinishChange(yi),Nt.neumannV=ht.add(ot,"neumannStr_2").onFinishChange(yi),Nt.robinV=ht.add(ot,"robinStr_2").onFinishChange(yi),Nt.comboV=ht.add(ot,"comboStr_2").name("Details").onFinishChange(yi),Nt.wBCs=ht.add(ot,"boundaryConditions_3",{}).onChange((function(){yi(),Pi(),document.activeElement.blur()})),Nt.dirichletW=ht.add(ot,"dirichletStr_3").onFinishChange(yi),Nt.neumannW=ht.add(ot,"neumannStr_3").onFinishChange(yi),Nt.robinW=ht.add(ot,"robinStr_3").onFinishChange(yi),Nt.comboW=ht.add(ot,"comboStr_3").name("Details").onFinishChange(yi),Nt.qBCs=ht.add(ot,"boundaryConditions_4",{}).name("$q$").onChange((function(){yi(),Pi(),document.activeElement.blur()})),Nt.dirichletQ=ht.add(ot,"dirichletStr_4").onFinishChange(yi),Nt.neumannQ=ht.add(ot,"neumannStr_4").onFinishChange(yi),Nt.robinQ=ht.add(ot,"robinStr_4").onFinishChange(yi),Nt.comboQ=ht.add(ot,"comboStr_4").name("Details").onFinishChange(yi),ht=ut.addFolder("Initial conditions"),Nt.initCond_1=ht.add(ot,"initCond_1").onFinishChange(Vi),Nt.initCond_2=ht.add(ot,"initCond_2").onFinishChange(Vi),Nt.initCond_3=ht.add(ot,"initCond_3").onFinishChange(Vi),Nt.initCond_4=ht.add(ot,"initCond_4").onFinishChange(Vi),mt=ct.addFolder("Images"),ht=mt,Mi(),ht=ct.addFolder("Checkpoints");const i=fa(ht);pa(i,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),ga(i),ma(i,'<i class="fa-regular fa-flag"></i> Set',Yo,null,"Set a checkpoint at the current state",["narrow"]),ma(i,'<i class="fa-regular fa-file-arrow-down"></i> Export',Jo,null,"Download the last checkpoint as a file",["narrow"]),ma(i,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),ht.add(ot,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize").onChange((function(){document.activeElement.blur()})),ht=ct.addFolder("Misc."),ht.addColor(ot,"backgroundColour").name("Background").onChange((function(){ye.background=new te.Color(ot.backgroundColour),ka()}));const o=fa(ht);pa(o,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){uo(),ka()}),null,"Compute the integral of the plotted expression over the domain"),pa(o,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',(function(){bo(),ka()}),"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),pa(o,"setSeed",'<i class="fa-regular fa-shuffle"></i> Set seed',(function(){ot.setSeed&&(nn=ot.randSeed),Ui(),Bi()}),null,"Set the seed for random number generation"),Nt.randSeed=ht.add(ot,"randSeed").name("Random seed").onFinishChange((function(){Ui()})),ht=ht.addFolder("Dev");const a=fa(ht);ma(a,'<i class="fa-regular fa-copy"></i> Copy code',ba,null,"Copy the simulation configuration as JSON to the clipboard"),ma(a,'<i class="fa-regular fa-bug"></i> Copy debug',va,null,"Copy debug information to the clipboard"),pa(a,"showStats",'<i class="fa-regular fa-chart-line"></i> Show stats',(function(){wa()}),"interpController","Show performance statistics");let r=J();var s;Object.keys(r).forEach((function(e){r[e]=e})),r.default=null,ht.add(ot,"parent",(s=r,Object.keys(s).sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})).reduce((function(e,t){return e[t]=s[t],e}),{}))).name("Parent preset").onChange((function(){document.activeElement.blur()})),ht.add(ot,"guiUpdatePeriod").name("GUI update period)");const l=document.createElement("div");l.innerHTML="Settings",l.classList.add("ui_title"),ct.domElement.prepend(l);const u=document.createElement("div");u.innerHTML="Equations",u.classList.add("ui_title"),ut.domElement.prepend(u);const c=document.createElement("div");c.id="views_list",dt.domElement.prepend(c);const d=document.createElement("div");d.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",d.classList.add("ui_title"),dt.domElement.prepend(d),bt=dt.addFolder("Edit view"),ht=bt;const h=fa(ht,"edit_view_buttons");ma(h,'<i class="fa-solid fa-pen-nib"></i> Rename',aa,null,"Rename the current view"),ma(h,'<i class="fa-solid fa-xmark"></i> Delete',ra,"deleteViewButton","Delete view"),Nt.whatToPlot=ht.add(ot,"whatToPlot").name("Expression: ").onFinishChange((function(){Ri(),ka(),la(this.property)})),ht.add(ot,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){So(),document.activeElement.blur(),ka(),la(this.property)})),ht.add(ot,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){oi(),io(),document.activeElement.blur(),ka(),la(this.property)})).name("Colour map"),Nt.minColourValue=ht.add(ot,"minColourValue").name("Min value").onChange((function(){Yn(),oo(),ka(),la(this.property)})),Nt.minColourValue.__precision=2,Nt.maxColourValue=ht.add(ot,"maxColourValue").name("Max value").onChange((function(){Yn(),oo(),ka(),la(this.property)})),Nt.maxColourValue.__precision=2;const f=fa(ht,"colour_map_buttons");ma(f,'<i class="fa-regular fa-arrows-rotate"></i> Flip',(function(){ot.flippedColourmap=!ot.flippedColourmap,oi(),io(),ka(),la("flippedColourmap")}),null,"Reverse colour map",["narrow"]),ma(f,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){Ro(),ri(),la("minColourValue"),la("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),pa(f,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){io(),la("colourbar")}),null,"Display the colourbar",null,["narrow"]),ga(f),pa(f,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){ot.autoSetColourRange&&(Ro(),ri()),la("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),pa(f,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){oi(),ka(),la("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),pa(f,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){oi(),ka(),la("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),pa(f,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){oi(),ka(),la("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),pa(f,"vectorField",'<i class="fa-solid fa-arrow-right-arrow-left"></i> Vector field',(function(){Oa(),ka(),la("vectorField")}),"vectorFieldButton","Toggle vector field","vectorFieldFolder",["wide"]),ht=bt.addFolder("Contours"),ht.domElement.id="contoursFolder",Nt.contourColour=ht.addColor(ot,"contourColour").name("Colour").onChange((function(){Ua(),ka(),la(this.property)})),Nt.contourNum=ht.add(ot,"contourNum").name("Number").onChange((function(){Ua(),ka(),la(this.property)})),Aa(Nt.contourNum,1,20,1),Bt.push(Nt.contourNum),Nt.contourEpsilon=ht.add(ot,"contourEpsilon").name("Threshold").onChange((function(){Ua(),ka(),la(this.property)})),Aa(Nt.contourEpsilon,.001,.05,.001),Bt.push(Nt.contourEpsilon),ht=bt.addFolder("Lighting"),ht.domElement.id="embossFolder",Nt.embossSmoothness=ht.add(ot,"embossSmoothness").name("Smoothness").onChange((function(){Ta(),ka(),la(this.property)})),Aa(Nt.embossSmoothness,0,2,.001),Ot.push(Nt.embossSmoothness),Nt.embossAmbient=ht.add(ot,"embossAmbient").name("Ambient").onChange((function(){Ta(),ka(),la(this.property)})),Aa(Nt.embossAmbient,0,1,.001),Ot.push(Nt.embossAmbient),Nt.embossDiffuse=ht.add(ot,"embossDiffuse").name("Diffuse").onChange((function(){Ta(),ka(),la(this.property)})),Aa(Nt.embossDiffuse,0,1,.001),Ot.push(Nt.embossDiffuse),Nt.embossSpecular=ht.add(ot,"embossSpecular").name("Specular").onChange((function(){Ta(),ka(),la(this.property)})),Aa(Nt.embossSpecular,0,1,.001),Ot.push(Nt.embossSpecular),Nt.embossShiny=ht.add(ot,"embossShiny").name("Precision").onChange((function(){Ta(),ka(),la(this.property)})),Aa(Nt.embossShiny,0,100,1),Ot.push(Nt.embossShiny),Nt.embossTheta=ht.add(ot,"embossTheta").name("Inclination").onChange((function(){Ta(),ka(),la(this.property)})),Aa(Nt.embossTheta,0,1.5708,.001),Ot.push(Nt.embossTheta),Nt.embossPhi=ht.add(ot,"embossPhi").name("Direction").onChange((function(){Ta(),ka(),la(this.property)})),Aa(Nt.embossPhi,0,3.1456,.001),Ot.push(Nt.embossPhi),ht=bt.addFolder("Overlay"),ht.domElement.id="overlayFolder",ht.addColor(ot,"overlayColour").name("Colour").onChange((function(){Va(),ka(),la(this.property)})),ht.add(ot,"overlayExpr").name("Expression").onFinishChange((function(){oi(),"line"==ot.plotType&&Li(),ka(),la(this.property)})),Nt.overlayEpsilon=ht.add(ot,"overlayEpsilon").name("Threshold").onChange((function(){Va(),ka(),la(this.property)})),Nt.overlayLineWidthMul=ht.add(ot,"overlayLineWidthMul",.1,2).name("Thickness").onChange((function(){jo(),ka(),la(this.property)})),vt=bt.addFolder("3D"),ht=vt,ft=fa(ht),pa(ft,"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){at.customSurface.value=ot.customSurface,Ra(),Ia(),ka(),la("customSurface")}),null,"Plot the solution on a custom surface"),Nt.surfaceFun=ht.add(ot,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){Ri(),ka(),la(this.property)})),Nt.threeDHeightScale=ht.add(ot,"threeDHeightScale").name("Height scale").onChange((function(){Yn(),ka(),la(this.property)})),Nt.cameraTheta=ht.add(ot,"cameraTheta").name("View $\\theta$").onChange((function(){Hn(),ka(),la(this.property)})),Nt.cameraPhi=ht.add(ot,"cameraPhi").name("View $\\phi$").onChange((function(){Hn(),ka(),la(this.property)})),Nt.cameraZoom=ht.add(ot,"cameraZoom").name("Zoom").onChange((function(){Hn(),ka(),la(this.property)})),Nt.lineWidthMul=ht.add(ot,"lineWidthMul",.1,2).name("Thickness").onChange((function(){jo(),ka(),la(this.property)})),wt=bt.addFolder("Vector field"),ht=wt,ht.domElement.id="vectorFieldFolder",ht.addColor(ot,"arrowColour").name("Colour").onChange((function(){Wa(),ka(),la(this.property)})),ht.add(ot,"arrowX").onFinishChange((function(){Li(),ka(),la(this.property)})).name("$x$ component"),ht.add(ot,"arrowY").onFinishChange((function(){Li(),ka(),la(this.property)})).name("$y$ component"),Nt.arrowDensity=ht.add(ot,"arrowDensity").onChange((function(){Oa(),ka(),la(this.property)})).name("Density"),Nt.arrowDensity.__precision=2,Aa(Nt.arrowDensity,0,1,.001),ht.add(ot,"arrowScale",{None:"none",Relative:"relative",Auto:"auto"}).onFinishChange((function(){Bi(),ka(),la(this.property)})).name("Scaling"),Nt.arrowLengthMax=ht.add(ot,"arrowLengthMax").onFinishChange((function(){Oa(),ka(),la(this.property)})).name("Max length");document.querySelectorAll("input").forEach((e=>Ma(e)))}function ni(){oi(),io(),Ri(),ii()}function ii(){let l=Po()+e(),u="float brushRadius = "+wi(ot.brushRadius.toString())+";\n";switch(u=u.replace(/\buvwq\./g,"uvwqBrush."),u=u.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(ot.brushValue)&&(l+=M()),/\bRANDN\b/.test(ot.brushValue)&&(l+=R()),l+="float brushValue = "+wi(ot.brushValue)+";\n",l+=u,ot.brushType){case"circle":l+=i();break;case"hline":l+=a();break;case"vline":l+=o()}switch(ot.brushAction){case"replace":l+=r(),l+=t();break;case"add":l+=r(),l+=n();break;case"smoothreplace":l+=s(),l+=t();break;case"smoothadd":l+=s(),l+=n()}za(),l=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,Ai(ot.whatToDraw)),e}(l),l=Qa(l),ke.fragmentShader=l,ke.needsUpdate=!0}function oi(){nt=Q(ot.colourmap),ot.flippedColourmap&&(nt.reverse(),nt=nt.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),at.colour1.value=new te.Vector4(...nt[0]),at.colour2.value=new te.Vector4(...nt[1]),at.colour3.value=new te.Vector4(...nt[2]),at.colour4.value=new te.Vector4(...nt[3]),at.colour5.value=new te.Vector4(...nt[4]);let e=Po()+I();ot.emboss&&(e+=N(),Ta()),ot.contours&&(e+=B(),Ua()),ot.overlay&&(e+=j().replaceAll("OVERLAYEXPR",wi(ot.overlayExpr)),e=Qa(e),Va()),Xe.visible=ot.overlay&&"line"==ot.plotType,e+=L(),Ve.fragmentShader=e,Ve.needsUpdate=!0,Ie.needsUpdate=!0,it=nt.map((e=>e[3])),nt=nt.map((e=>e.slice(0,-1)))}function ai(){switch(ot.timesteppingScheme){case"Euler":He.material=Lt.FE,at.textureSource.value=Rt[1].texture,at.textureSource1.value=Rt[2].texture,at.dt.value=ot.dt,Ce.setRenderTarget(Rt[0]),Ce.render(Se,_e),Rt.rotate(-1),at.t.value+=ot.dt;break;case"AB2":He.material=Lt.AB2,at.textureSource.value=Rt[1].texture,at.textureSource1.value=Rt[2].texture,at.dt.value=ot.dt,Ce.setRenderTarget(Rt[0]),Ce.render(Se,_e),Rt.rotate(-1),at.t.value+=ot.dt;break;case"Mid":He.material=Lt.Mid1,at.textureSource.value=Rt[1].texture,Ce.setRenderTarget(Rt[2]),Ce.render(Se,_e),He.material=Lt.Mid2,at.textureSource1.value=Rt[2].texture,at.t.value+=.5*ot.dt,Ce.setRenderTarget(Rt[0]),Ce.render(Se,_e),Rt.rotate(-1),at.t.value+=.5*ot.dt;break;case"RK4":He.material=Lt.RK41,at.textureSource.value=Rt[1].texture,Ce.setRenderTarget(Rt[2]),Ce.render(Se,_e),He.material=Lt.RK42,at.textureSource1.value=Rt[2].texture,at.t.value+=.5*ot.dt,Ce.setRenderTarget(Rt[3]),Ce.render(Se,_e),He.material=Lt.RK43,at.textureSource2.value=Rt[3].texture,Ce.setRenderTarget(Rt[4]),Ce.render(Se,_e),He.material=Lt.RK44,at.textureSource3.value=Rt[4].texture,at.t.value+=.5*ot.dt,Ce.setRenderTarget(Rt[0]),Ce.render(Se,_e),Rt.rotate(-1)}}function ri(){if(si(),!ot.autoSetColourRange||tn%ot.guiUpdatePeriod||Ro(),ot.brushEnabled&&"surface"==ot.plotType){let e=0;ot.maxColourValue-ot.minColourValue>0&&(e=(function(){mo();let e=0;for(let t=0;t<Sn.length;t+=4)e+=Sn[t];return e/($t*Tt)}()-ot.minColourValue)/(ot.maxColourValue-ot.minColourValue)-.5,e=e.clamp(-.5,.5)),Ye.position.y=ot.threeDHeightScale*e,Ye.updateWorldMatrix()}if("line"==ot.plotType){mo();let t=0;var e=ot.maxColourValue-ot.minColourValue;e=0==e?.5:e;for(let n=0;n<Sn.length;n+=4)Ke[t++]=(Sn[n]-ot.minColourValue)/e-.5;let n=new te.SplineCurve(Ze.map(((e,t)=>new te.Vector2(e,Ke[t])))),i=n.getSpacedPoints(et);if(Bo(Je,i),function(e,t){let n,i=e.geometry.attributes.instanceColorStart,o=e.geometry.attributes.instanceColorEnd;for(let e=0;e<t.length;e++)n=Oo(t[e].toArray()[1]+.5),e<t.length&&i.setXYZ(e,n[0],n[1],n[2]),e>0&&o.setXYZ(e-1,n[0],n[1],n[2]);i.needsUpdate=!0}(Je,i),ot.overlay){t=0;for(let n=2;n<4*$t;n+=4)Ke[t++]=(Sn[n]-ot.minColourValue)/e-.5;n=new te.SplineCurve(Ze.map(((e,t)=>new te.Vector2(e,Ke[t])))),i=n.getSpacedPoints(et),Bo(Xe,i)}}if(ot.vectorField&&tt&&!(tn%ot.guiUpdatePeriod)){xn=new Float32Array($t*Tt*4),Ce.readRenderTargetPixels($e,0,0,$t,Tt,xn);let e,t,n,i=[];for(const o of tt.children)e=4*o.ind,t=xn[e+2],n=xn[e+3],o.visible=xn[e+1]<=.5,o.lookAt(o.position.x+t,o.position.y+n,o.position.z),o.size=t**2+n**2,i.push(o.size);let o=1;switch(ot.arrowScale){case"auto":o=Math.sqrt(Math.max(...i)),0==o&&(o=1);for(const e of tt.children){const t=un*Wo(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"relative":o=tt.customMax>0?tt.customMax:1;for(const e of tt.children){const t=un*Wo(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"none":for(const e of tt.children)e.scale.set(un,un,un)}}if(!ot.timeDisplay||tn%ot.guiUpdatePeriod||lo(),!ot.integrate||tn%ot.guiUpdatePeriod||function(){if(ot.integrate){let e;mo(),1==ot.dimension?e=at.dx.value:2==ot.dimension&&(e=at.dx.value*at.dy.value);let t=0;for(let e=0;e<Sn.length;e+=4)t+=Sn[e]*(1-Sn[e+1]);t*=e,$("#integralValue").html(ao(t,4)),go()}}(),vo()?(He.material=Oe,Ce.setRenderTarget(Te),Ce.render(Se,_e),at.textureSource.value=Te.texture,at.dxUpscaledScale.value=devicePixelRatio*kt/$t,at.dyUpscaledScale.value=devicePixelRatio*qt/Tt):(at.dxUpscaledScale.value=1,at.dyUpscaledScale.value=1),Ce.setRenderTarget(null),Ce.render(ye,we),Dn){Dn=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",Ce.render(ye,we),t.href=Ce.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Xn(),ri()}tn=(tn+1)%ot.guiUpdatePeriod}function si(){an=null,He.material=Ie,at.textureSource.value=Rt[1].texture,Ce.setRenderTarget($e),Ce.render(Se,_e),at.textureSource.value=$e.texture,Fn=!1,at.textureSource1.value=Rt[1].texture}function li(e){yt=di(e,ge),yt&&(ot.brushEnabled&&"surface"==ot.plotType?De.enabled=!1:ot.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),to("#top_message"),window.clearTimeout(Dt),Dt=setTimeout((function(){$("#top_message").hasClass("fading_out")||no("#top_message")}),3e3)))}function ui(e){yt=!1,"surface"==ot.plotType&&(De.enabled=!0)}function ci(e){di(e,ge)}function di(e,t){var n=t.getBoundingClientRect();let i=(e.clientX-n.x)/n.width,o=1-(e.clientY-n.y)/n.height;if("surface"==ot.plotType){Ee.x=2*i-1,Ee.y=2*o-1,Fe.setFromCamera(Ee,we);var a=Fe.intersectObject(Ye,!1);a.length>0?(i=a[0].uv.x,o=a[0].uv.y):(i=-1,o=-1)}else"line"==ot.plotType&&(i=(i-.5)/we.zoom+.5,o=.5);return i=Math.round(i*$t)/$t,o=Math.round(o*Tt)/Tt,at.brushCoords.value=new te.Vector2(i,o),0<=i&&i<=1&&0<=o&&o<=1}function hi(){Ce.setSize($t,Tt,!1),Kt&&ot.resetFromCheckpoints?He.material=We:He.material=Me,Rt.forEach((e=>{Ce.setRenderTarget(e),Ce.render(Se,_e)})),ea(),ri()}function fi(){Zt||($("#pause").hide(),$("#play").show()),_t=!1}function mi(){Zt||($("#play").hide(),$("#pause").show()),zt=!0,window.clearTimeout(xt),xt=setTimeout(fo,1e3),_t=!0}function pi(){ot.setSeed&&(nn=ot.randSeed),Ui(),at.t.value=0,Gt=!0,lo(),hi(),ri(),zt=!0,window.clearTimeout(xt),fo()}function gi(){let e="";return e+="float UFUN = "+wi(ot.reactionStr_1)+";\n",e+="float VFUN = "+wi(ot.reactionStr_2)+";\n",e+="float WFUN = "+wi(ot.reactionStr_3)+";\n",e+="float QFUN = "+wi(ot.reactionStr_4)+";\n",e}function bi(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function vi(e){let t="";return t+="float D"+e+"y = D"+e+"x;\n",t+="float D"+e+"yL = D"+e+"xL;\n",t+="float D"+e+"yR = D"+e+"xR;\n",t+="float D"+e+"yT = D"+e+"xT;\n",t+="float D"+e+"yB = D"+e+"xB;\n",t}function wi(e){if(!na(e=" "+e+" ")||Ha(e))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])?\b/g);let i,o,a,r,s,l,u,c,d,h,f,m,p,g=0;const b={S:"One",T:"Two"},v={R:"r",G:"g",B:"b",A:"a"};for(const w of n){for(i=w.index,m=b[w[1]],o=i+w[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,s=t.slice(o+g+1,a+g),s=ko(s),l=s.split(","),1!=l.length&&0!=l[1].trim().length||(l[1]="0"),l[0]="("+l[0]+"-MINX)/L_x",l[1]="("+l[1]+"-MINY)/L_y",h="texture(imageSource"+m+",vec2("+l.join(",")+")).",null!=w[2]?(p=v[w[2]],f=h+p):(p=["r","g","b"],f="("+p.map((e=>h+e)).join("+")+")/3.0 "),t=Yi(t,f,i+g,a+1+g),g+=f.length-a+i-1)}return t}(e=(e=Eo(e=(e=(e=(e=_i(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){if("0"==n)return"1";const i=Number(n);return Number.isInteger(i&&i>0&&i<101)?"(("+t+")"+("*("+t+")").repeat(i-1)+")":"safepow("+t+","+n+")"}))).replaceAll(RegExp("\\b("+An[0]+")\\b","g"),(function(e,t){return"uvwq."+Ai(t)}))).replaceAll(RegExp("\\b("+An[0]+")_([xy][fb]?2?)\\b","g"),(function(e,t,n){return n.includes("2")&&(n=n.slice(0,-1).repeat(2)),"uvwq"+n.toUpperCase()+"."+Ai(t)}))).replaceAll(RegExp("\\b("+An[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+Ai(t)})))).replaceAll(/\b(I_[ST][RBGA]?\b)\s*(?!\()/g,"$1(x,y) "));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e=e.replaceAll(/\bind\b/g,"float")}function _i(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function yi(){let e="",t="",n="",i="",o="",a="";const r=[ot.boundaryConditions_1,ot.boundaryConditions_2,ot.boundaryConditions_3,ot.boundaryConditions_4],s=[ot.neumannStr_1,ot.neumannStr_2,ot.neumannStr_3,ot.neumannStr_4],l=[ot.comboStr_1,ot.comboStr_2,ot.comboStr_3,ot.comboStr_4].map((e=>e+";")),u=[ot.dirichletStr_1,ot.dirichletStr_2,ot.dirichletStr_3,ot.dirichletStr_4],c=[ot.robinStr_1,ot.robinStr_2,ot.robinStr_3,ot.robinStr_4];r.forEach((function(t,n){"neumann"==t?(e+=Si(s[n],$n[n]),ot.domainViaIndicatorFun?e+=da(n):e+=ca(n)):"combo"==t&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=Si(t[2],$n[n],i),e+=ca(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=Ti(V(t),$n[e]),ot.dimension>1&&(i+=Ti(k(t),$n[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,wi(e[2]))}))})),r.forEach((function(e,t){if("dirichlet"==e)if(ot.domainViaIndicatorFun){let e=w().replace(/indicatorFun/g,wi(ot.domainIndicatorFun));n+=Ti(e,$n[t])+wi(u[t])+";\n}\n"}else n+=Ci(u[t],$n[t]),n+=ua(t);else if("combo"==e)[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=Ci(e[2],$n[t],i),n+=ua(t,i)}));else if(ot.domainViaIndicatorFun){let e=w().replace(/indicatorFun/g,wi(ot.domainIndicatorFun));n+=Ti(e,$n[t])+"0.0;\n}\n"}})),r.forEach((function(e,t){"robin"==e?(i+=Si(c[t],$n[t]),ot.domainViaIndicatorFun?i+=da(t):i+=ca(t)):"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=Si(e[2],$n[t],n),i+=ca(t,n)}))}));let d=Po();if(o=function(){let e="";const t=[[ot.diffusionStr_1_1,"uu"],[ot.diffusionStr_2_2,"vv"],[ot.diffusionStr_3_3,"ww"],[ot.diffusionStr_4_4,"qq"]];for(let[n,i]of t){let t;if(n.includes(";")){let e=n.split(";").filter((e=>e));n=e[0],e.length>1&&ot.dimension>1&&(t=e[1])}e+=bi(wi(n)+";\n",i+"x"),e+=t?bi(wi(t)+";\n",i+"y"):vi(i)}return e}()+"\n",ot.crossDiffusion?o+=function(){let e="";const t=[[ot.diffusionStr_1_2,"uv"],[ot.diffusionStr_1_3,"uw"],[ot.diffusionStr_1_4,"uq"],[ot.diffusionStr_2_1,"vu"],[ot.diffusionStr_2_3,"vw"],[ot.diffusionStr_2_4,"vq"],[ot.diffusionStr_3_1,"wu"],[ot.diffusionStr_3_2,"wv"],[ot.diffusionStr_3_4,"wq"],[ot.diffusionStr_4_1,"qu"],[ot.diffusionStr_4_2,"qv"],[ot.diffusionStr_4_3,"qw"]];for(let[n,i]of t){let t;if(n.includes(";")){let e=n.split(";").filter((e=>e));n=e[0],e.length>1&&ot.dimension>1&&(t=e[1])}e+=bi(wi(n)+";\n",i+"x"),e+=t?bi(wi(t)+";\n",i+"y"):vi(i)}return e}()+"\n"+D():o+=x(),ot.numAlgebraicSpecies>=2){const e=ot.numSpecies-ot.numAlgebraicSpecies;let t={};for(let n=e;n<ot.numSpecies;n++){let i=[],o=ot["reactionStr_"+(n+1).toString()];for(let t=e;t<ot.numSpecies;t++)o=[o,ot["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()]].join(" ");for(let t=e;t<ot.numSpecies;t++){(new RegExp("\\b"+$n[t]+"(_(x|xb|xf|xb2|xf2|xx|y|yb|yf|yb2|yf2|yy))?\\b").test(o)||"0"!=ot["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()])&&i.push($n[t])}i!=[]&&(t[$n[n]]=i)}let n={},i=[],o=[];for(let a of $n.slice(e,ot.numSpecies))Ga(a,n,i,t,o);if(o.length>0)return void ta("Cyclic variables detected. Please check the definition(s) of "+o.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.")}if(wn&&ot.crossDiffusion&&(a+=Ti(F(),$n[1])),_n&&ot.crossDiffusion&&(a+=Ti(F(),$n[2])),yn&&ot.crossDiffusion&&(a+=Ti(F(),$n[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void ta("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let h=[T(),P(),e,t,i,A(),U(),gi(),o].join(" "),f=/\bRAND\b/.test(h),m=/\bRANDN\b/.test(h);f&&(h=M()+h),m&&(h=R()+h),Yt=f||m;let b=[n,a,g()].join(" "),v="FE";Lt[v].fragmentShader=Qa([d,p(v),h,q(v),b].join(" ")),v="AB2",Lt[v].fragmentShader=Qa([d,p(v),h,q(v),b].join(" ")),v="Mid";for(let e=1;e<3;e++)Lt[v+e.toString()].fragmentShader=Qa([d,p(v+e.toString()),h,q(v+e.toString()),b].join(" "));v="RK4";for(let e=1;e<5;e++)Lt[v+e.toString()].fragmentShader=Qa([d,p(v+e.toString()),h,q(v+e.toString()),b].join(" "));if(Object.keys(Lt).forEach((e=>Lt[e].needsUpdate=!0)),Ct=ot.domainViaIndicatorFun||"dirichlet"==ot.boundaryConditions_1||"dirichlet"==ot.boundaryConditions_2||"dirichlet"==ot.boundaryConditions_3||"dirichlet"==ot.boundaryConditions_4||/Dirichlet/.test(ot.comboStr_1)||/Dirichlet/.test(ot.comboStr_2)||/Dirichlet/.test(ot.comboStr_3)||/Dirichlet/.test(ot.comboStr_4),Ct){if(n=d+E(),ot.domainViaIndicatorFun){let e=w().replace(/indicatorFun/,wi(ot.domainIndicatorFun)).replace(/updated/,"gl_FragColor");u.forEach((function(t,i){"dirichlet"==r[i]?n+=Ti(e,$n[i])+wi(t)+";\n}\n":n+=Ti(e,$n[i])+"0.0;\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=Ci(u[t],$n[t]),n+=ha(t)):"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=Ci(e[2],$n[t],i),n+=ha(t,i)}))}));n+="}",n=Qa(n),qe.fragmentShader=n,qe.needsUpdate=!0}}function Si(e,t,n){return null==n?["L","R","T","B"].map((n=>Si(e,t,n))).join(""):"float robinRHS"+t+n+" = "+wi(e)+";\n"}function Ci(e,t,n){return null==n?["L","R","T","B"].map((n=>Ci(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+wi(e)+";\n"}function xi(e){Di("default"),Di(e),null!=ot.threeD&&(ot.threeD&&(ot.dimension=2,null==ot.plotType&&(ot.plotType="surface")),delete ot.threeD),null!=ot.oneDimensional&&(ot.oneDimensional&&(ot.dimension=1,ot.plotType="line"),delete ot.oneDimensional),sn*=ln,function(){if(0==ot.views.length){let e=sa();e.name="1",ot.views.push(e)}else ot.views=ot.views.map((function(e){let t=sa();return Object.assign(t,e),t}))}(),Ei(ut,!0),Ei(ct,!0),Ei(dt,!0),ti(),ot.activeViewInd>=ot.views.length&&(ot.activeViewInd=ot.views.length-1),oa(ot.views[ot.activeViewInd],!1),Wi(),ei(),Gn(),Yn(),ye.background=new te.Color(ot.backgroundColour),""!=ot.initialState?fetch(ot.initialState).then((e=>e.blob())).then((e=>Xo(e))):pi(),Hn(),pt.remove(),gt.remove(),Mi(),bo()}function Di(e){let t;const n=Z(),i=n.map((e=>e.toLowerCase()));if(null==e)t=z(ot.preset);else if("string"==typeof e)if(i.includes(e.toLowerCase()))t=z(e);else{const i=me(e,n,!1);o="We couldn't find a preset called '"+e+"'."+(null!=i?" We've loaded the closest match, '"+i+"'.":"")+" Please check the preset specified in the URL.",fi(),$("#preset_description").html(o),to("#bad_preset"),t=z(i||mn)}else t="object"==typeof e?e:z(mn);var o;t.hasOwnProperty("parent")&&null!=t.parent&&Di(t.parent),fn=0,dn=[],cn={},Object.assign(ot,t),_t=ot.runningOnLoad,Lo(),_t?mi():fi(),Da()?(ot.guiUpdatePeriod=Math.max(ot.guiUpdatePeriod,3),ot.tryClickingText=ot.tryClickingText.replaceAll("clicking","tapping")):ot.tryClickingText=ot.tryClickingText.replaceAll("tapping","clicking"),ot.brushRadius=ot.brushRadius.toString(),ot.hasOwnProperty("drawIn3D")&&(ot.brushEnabled=ot.drawIn3D);var a=0;a+=ot.hasOwnProperty("algebraicV"),a+=ot.hasOwnProperty("algebraicW"),(a+=ot.hasOwnProperty("algebraicQ"))&&!ot.numAlgebraicSpecies&&(ot.numAlgebraicSpecies=a),delete ot.algebraicV,delete ot.algebraicW,delete ot.algebraicQ;const r=X();Object.keys(r).forEach((function(e){ot.hasOwnProperty(e)&&(t.hasOwnProperty(r[e])||(ot[r[e]]=ot[e]),delete ot[e])})),null==ot.minColourValue&&(ot.minColourValue=0),null==ot.maxColourValue&&(ot.maxColourValue=1),ot.domainScale=ot.domainScale.toString(),ot.spatialStep=ot.spatialStep.toString(),lt=JSON.parse(JSON.stringify(ot));let s=[ot.initCond_1,ot.initCond_2,ot.initCond_3,ot.initCond_4,ot.domainIndicatorFun,ot.reactionStr_1,ot.reactionStr_2,ot.reactionStr_3,ot.reactionStr_4,ot.diffusionStr_1_1,ot.diffusionStr_1_2,ot.diffusionStr_1_3,ot.diffusionStr_1_4,ot.diffusionStr_2_1,ot.diffusionStr_2_2,ot.diffusionStr_2_3,ot.diffusionStr_2_4,ot.diffusionStr_3_1,ot.diffusionStr_3_2,ot.diffusionStr_3_3,ot.diffusionStr_3_4,ot.diffusionStr_4_1,ot.diffusionStr_4_2,ot.diffusionStr_4_3,ot.diffusionStr_4_4,ot.dirichletStr_1,ot.dirichletStr_2,ot.dirichletStr_3,ot.dirichletStr_4,ot.robinStr_1,ot.robinStr_2,ot.robinStr_3,ot.robinStr_4,ot.comboStr_1,ot.comboStr_2,ot.comboStr_3,ot.comboStr_4,ot.neumannStr_1,ot.neumannStr_2,ot.neumannStr_3,ot.neumannStr_4,ot.brushValue,ot.whatToPlot].join(" ");ot.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(s)}function Fi(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)Fi(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Ei(e,t){if(null!=e){for(let t in e.__folders)Ei(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function $i(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function Ti(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=Ai(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function Ai(e){return"rgba"[function(e){return $n.indexOf(e)}(e)]}function Pi(){"dirichlet"==ot.boundaryConditions_1?Nt.dirichletU.show():Nt.dirichletU.hide(),"dirichlet"==ot.boundaryConditions_2?Nt.dirichletV.show():Nt.dirichletV.hide(),"dirichlet"==ot.boundaryConditions_3?Nt.dirichletW.show():Nt.dirichletW.hide(),"dirichlet"==ot.boundaryConditions_4?Nt.dirichletQ.show():Nt.dirichletQ.hide(),"neumann"==ot.boundaryConditions_1?Nt.neumannU.show():Nt.neumannU.hide(),"neumann"==ot.boundaryConditions_2?Nt.neumannV.show():Nt.neumannV.hide(),"neumann"==ot.boundaryConditions_3?Nt.neumannW.show():Nt.neumannW.hide(),"neumann"==ot.boundaryConditions_4?Nt.neumannQ.show():Nt.neumannQ.hide(),"robin"==ot.boundaryConditions_1?Nt.robinU.show():Nt.robinU.hide(),"robin"==ot.boundaryConditions_2?Nt.robinV.show():Nt.robinV.hide(),"robin"==ot.boundaryConditions_3?Nt.robinW.show():Nt.robinW.hide(),"robin"==ot.boundaryConditions_4?Nt.robinQ.show():Nt.robinQ.hide(),"combo"==ot.boundaryConditions_1?Nt.comboU.show():Nt.comboU.hide(),"combo"==ot.boundaryConditions_2?Nt.comboV.show():Nt.comboV.hide(),"combo"==ot.boundaryConditions_3?Nt.comboW.show():Nt.comboW.hide(),"combo"==ot.boundaryConditions_4?Nt.comboQ.show():Nt.comboQ.hide();const e=[Nt.uBCs,Nt.vBCs,Nt.wBCs,Nt.qBCs];ot.domainViaIndicatorFun?e.forEach((e=>Io(e,["Dirichlet","Neumann","Robin"],["dirichlet","neumann","robin"]))):e.forEach((e=>Io(e,["Periodic","Dirichlet","Neumann","Robin","Combination"],["periodic","dirichlet","neumann","robin","combo"]))),Fi(ut)}function Ui(){nn=(nn+123456789)%1e9,at.seed.value=nn/1e6}function Vi(){let e=Po()+ee(),t=[ot.initCond_1,ot.initCond_2,ot.initCond_3,ot.initCond_4].join(" ");/\bRAND\b/.test(t)&&(e+=M()),/\bRANDN\b/.test(t)&&(e+=R()),e+="float u = "+wi(ot.initCond_1)+";\n",e+="float v = "+wi(ot.initCond_2)+";\n",e+="float w = "+wi(ot.initCond_3)+";\n",e+="float q = "+wi(ot.initCond_4)+";\n",e+=K(),e=Qa(e),Me.fragmentShader=e,Me.needsUpdate=!0}function ki(){let e=new Image;e.src=pt.__image.src;let t=new te.Texture;t.magFilter=te.NearestFilter,t.minFilter=te.NearestFilter,t.image=e,e.onload=function(){t.needsUpdate=!0,at.imageSourceOne.value=t,ot.resetOnImageLoad&&pi()}}function qi(){let e=new Image;e.src=gt.__image.src;let t=new te.Texture;t.magFilter=te.NearestFilter,t.minFilter=te.NearestFilter,t.image=e,e.onload=function(){t.needsUpdate=!0,at.imageSourceTwo.value=t,ot.resetOnImageLoad&&pi()},t.dispose()}function Mi(){ht=mt,pt=ht.addImage(ot,"imagePathOne").name("$I_S(x,y)$").onChange(ki),gt=ht.addImage(ot,"imagePathTwo").name("$I_T(x,y)$").onChange(qi),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Ri(){Fn=!1,Li(),Nt.minColourValue.show(),Nt.maxColourValue.show(),io(),uo()}function Ii(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function Li(){let e=Po()+l();e+=u().replace(/\bXVECFUN\b/,wi(ot.arrowX)).replace(/\bYVECFUN\b/,wi(ot.arrowY)),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,wi(ot.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,wi(ot.surfaceFun))}(e),ot.domainViaIndicatorFun&&(e+=d().replace(/indicatorFun/g,wi(ot.domainIndicatorFun))),e=e.replaceAll("OVERLAYEXPR",wi(ot.overlayExpr)),e=Qa(e),Va(),Ie.fragmentShader=e+c(),Ie.needsUpdate=!0}function Ni(){ot.numAlgebraicSpecies=Math.min(parseInt(ot.numAlgebraicSpecies),parseInt(ot.numSpecies)-1),wn=ot.numAlgebraicSpecies>=ot.numSpecies-1,_n=ot.numAlgebraicSpecies>=ot.numSpecies-2&&ot.numSpecies>=3,yn=ot.numAlgebraicSpecies>=ot.numSpecies-3&&ot.numSpecies>=4}function Bi(){let e="function of "+$n.slice(0,ot.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+$n[1]+",",""),n=e.replace(" "+$n[2]+",",""),i=e.replace(" "+$n[3]+",","");switch(1==ot.dimension?(e=e.replace(" y,",""),Nt.minY.hide()):Nt.minY.show(),ot.crossDiffusion&&parseInt(ot.numSpecies)>1?(on||Io(Nt.algebraicSpecies,Array.from(Array(parseInt(ot.numSpecies)).keys())),Nt.algebraicSpecies.show()):Nt.algebraicSpecies.hide(),ot.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),Nt.Duv.hide(),Nt.Dvu.hide(),Nt.Dvv.hide(),Nt.g.hide(),Nt.initCond_2.hide(),Nt.vBCs.hide(),Nt.Duw.hide(),Nt.Dvw.hide(),Nt.Dwu.hide(),Nt.Dwv.hide(),Nt.Dww.hide(),Nt.h.hide(),Nt.initCond_3.hide(),Nt.wBCs.hide(),Nt.Duq.hide(),Nt.Dvq.hide(),Nt.Dwq.hide(),Nt.Dqu.hide(),Nt.Dqv.hide(),Nt.Dqw.hide(),Nt.Dqq.hide(),Nt.j.hide(),Nt.initCond_4.hide(),Nt.qBCs.hide(),parseInt(ot.numSpecies)){case 4:ot.crossDiffusion?(Nt.Duq.show(),Nt.Dvq.show(),Nt.Dwq.show(),Nt.Dqu.show(),Nt.Dqv.show(),Nt.Dqw.show()):(Nt.Dwq.hide(),Nt.Dqu.hide(),Nt.Dvq.hide(),Nt.Duq.hide(),Nt.Dqv.hide(),Nt.Dqw.hide()),Nt.Dqq.show(),Nt.j.show(),Nt.initCond_4.show(),Nt.qBCs.show();case 3:ot.crossDiffusion?(Nt.Duw.show(),Nt.Dvw.show(),Nt.Dwu.show(),Nt.Dwv.show()):(Nt.Duw.hide(),Nt.Dvw.hide(),Nt.Dwu.hide(),Nt.Dwv.hide()),Nt.Dww.show(),Nt.h.show(),Nt.initCond_3.show(),Nt.wBCs.show();case 2:ot.crossDiffusion?(Nt.Duv.show(),Nt.Dvu.show()):(Nt.Duv.hide(),Nt.Dvu.hide()),Nt.Dvv.show(),Nt.g.show(),Nt.initCond_2.show(),Nt.vBCs.show()}ot.crossDiffusion?($i(Nt.Duu,Un.Duu,e),$i(Nt.Duv,Un.Duv,e),$i(Nt.Duw,Un.Duw,e),$i(Nt.Duq,Un.Duq,e),$i(Nt.Dvu,Un.Dvu,e),$i(Nt.Dvv,Un.Dvv,e),$i(Nt.Dvw,Un.Dvw,e),$i(Nt.Dvq,Un.Dvq,e),$i(Nt.Dwu,Un.Dwu,e),$i(Nt.Dwv,Un.Dwv,e),$i(Nt.Dww,Un.Dww,e),$i(Nt.Dwq,Un.Dwq,e),$i(Nt.Dqu,Un.Dqu,e),$i(Nt.Dqv,Un.Dqv,e),$i(Nt.Dqw,Un.Dqw,e),$i(Nt.Dqq,Un.Dqq,e)):($i(Nt.Duu,Un.Du,e),$i(Nt.Dvv,Un.Dv,e),$i(Nt.Dww,Un.Dw,e),$i(Nt.Dqq,Un.Dq,e)),$i(Nt.f,Un.UFUN,e),$i(Nt.g,Un.VFUN,e),$i(Nt.h,Un.WFUN,e),$i(Nt.j,Un.QFUN,e),wn&&($i(Nt.Dvu,Un.Dvu,t),$i(Nt.Dvw,Un.Dvw,t),$i(Nt.Dvq,Un.Dvq,t),$i(Nt.g,Un.VFUN,t),Nt.Dvv.hide()),_n&&($i(Nt.Dwu,Un.Dwu,i),$i(Nt.Dwv,Un.Dwv,i),$i(Nt.Dwq,Un.Dwq,i),$i(Nt.h,Un.WFUN,i),Nt.Dww.hide()),yn&&($i(Nt.Dqu,Un.Dqu,n),$i(Nt.Dqv,Un.Dqv,n),$i(Nt.Dqw,Un.Dqw,n),$i(Nt.j,Un.QFUN,n),Nt.Dqq.hide()),$i(Nt.uBCs,Un.u),$i(Nt.vBCs,Un.v),$i(Nt.wBCs,Un.w),$i(Nt.qBCs,Un.q),$i(Nt.dirichletU,Un.uD),$i(Nt.dirichletV,Un.vD),$i(Nt.dirichletW,Un.wD),$i(Nt.dirichletQ,Un.qD),$i(Nt.neumannU,Un.uN),$i(Nt.neumannV,Un.vN),$i(Nt.neumannW,Un.wN),$i(Nt.neumannQ,Un.qN),$i(Nt.robinU,Un.uN),$i(Nt.robinV,Un.vN),$i(Nt.robinW,Un.wN),$i(Nt.robinQ,Un.qN),$i(Nt.initCond_1,Un.uInit),$i(Nt.initCond_2,Un.vInit),$i(Nt.initCond_3,Un.wInit),$i(Nt.initCond_4,Un.qInit),ot.domainViaIndicatorFun?Nt.domainIndicatorFun.show():Nt.domainIndicatorFun.hide(),Pi(),"surface"==ot.plotType?($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").hide(),vt.name="3D options",vt.domElement.classList.remove("hidden"),Nt.lineWidthMul.hide(),Nt.threeDHeightScale.show(),Nt.cameraTheta.show(),Nt.cameraPhi.show(),Nt.cameraZoom.show()):"line"==ot.plotType?($("#contourButton").hide(),$("#embossButton").hide(),$("#vectorFieldButton").hide(),vt.name="Line options",vt.domElement.classList.remove("hidden"),Nt.lineWidthMul.show(),Nt.threeDHeightScale.show(),Nt.cameraTheta.hide(),Nt.cameraPhi.hide(),Nt.cameraZoom.hide()):($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").show(),vt.domElement.classList.add("hidden"),Nt.lineWidthMul.hide(),Nt.threeDHeightScale.hide(),Nt.cameraTheta.hide(),Nt.cameraPhi.hide(),Nt.cameraZoom.hide()),1==ot.dimension&&$("#vectorFieldButton").hide(),io(),so(),uo(),$("#dataContainer").show(),Ia(),"line"==ot.plotType?(Nt.brushType.hide(),$(":root").css("--ui-button-outline","black")):(Nt.brushType.show(),$(":root").css("--ui-button-outline","white")),ve?$("#interpController").hide():$("#interpController").show(),"relative"==ot.arrowScale?Nt.arrowLengthMax.show():Nt.arrowLengthMax.hide(),Io(Nt.whatToDraw,$n.slice(0,ot.numSpecies)),Pa(),ot.autoPause?Nt.autoPauseAt.show():Nt.autoPauseAt.hide(),"line"==ot.plotType?(Nt.overlayEpsilon.hide(),Nt.overlayLineWidthMul.show()):(Nt.overlayEpsilon.show(),Nt.overlayLineWidthMul.hide()),ot.setSeed?Nt.randSeed.show():Nt.randSeed.hide(),$(".toggle_button").each((function(){qa(this)})),ia(),wa(),Fi(ut),Fi(ct),Fi(dt)}function Oi(){let e;switch(Ni(),ot.domainViaIndicatorFun&&(["dirichlet","neumann"].includes(ot.boundaryConditions_1)||(ot.boundaryConditions_1="dirichlet"),["dirichlet","neumann"].includes(ot.boundaryConditions_2)||(ot.boundaryConditions_2="dirichlet"),["dirichlet","neumann"].includes(ot.boundaryConditions_3)||(ot.boundaryConditions_3="dirichlet"),["dirichlet","neumann"].includes(ot.boundaryConditions_4)||(ot.boundaryConditions_4="dirichlet")),parseInt(ot.numSpecies)){case 1:ot.crossDiffusion=!1,ot.whatToDraw=$n[0],new RegExp("\\b("+An[1]+")\\b").test(ot.whatToPlot)&&(ot.whatToPlot=$n[0]),ot.diffusionStr_1_2="0",ot.diffusionStr_1_3="0",ot.diffusionStr_1_4="0",ot.diffusionStr_2_1="0",ot.diffusionStr_2_2="0",ot.diffusionStr_2_3="0",ot.diffusionStr_2_4="0",ot.diffusionStr_3_1="0",ot.diffusionStr_3_2="0",ot.diffusionStr_3_3="0",ot.diffusionStr_3_4="0",ot.diffusionStr_4_1="0",ot.diffusionStr_4_2="0",ot.diffusionStr_4_3="0",ot.diffusionStr_4_4="0",ot.boundaryConditions_2="periodic",ot.initCond_2="0",ot.reactionStr_2="0",ot.boundaryConditions_3="periodic",ot.initCond_3="0",ot.reactionStr_3="0",ot.boundaryConditions_4="periodic",ot.initCond_4="0",ot.reactionStr_4="0",e=new RegExp("\\b("+An[1]+")\\b"),e.test(ot.reactionStr_1)&&(ot.reactionStr_1="0");break;case 2:ot.whatToDraw==$n[2]|ot.whatToDraw==$n[3]&&(ot.whatToDraw=$n[0]),new RegExp("\\b("+An[2]+")\\b").test(ot.whatToPlot)&&(ot.whatToPlot=$n[0]),ot.diffusionStr_1_3="0",ot.diffusionStr_1_4="0",ot.diffusionStr_2_3="0",ot.diffusionStr_2_4="0",ot.diffusionStr_3_1="0",ot.diffusionStr_3_2="0",ot.diffusionStr_3_3="0",ot.diffusionStr_3_4="0",ot.diffusionStr_4_1="0",ot.diffusionStr_4_2="0",ot.diffusionStr_4_3="0",ot.diffusionStr_4_4="0",ot.boundaryConditions_3="periodic",ot.initCond_3="0",ot.reactionStr_3="0",ot.boundaryConditions_4="periodic",ot.initCond_4="0",ot.reactionStr_4="0",e=new RegExp("\\b("+An[2]+")\\b"),e.test(ot.reactionStr_1)&&(ot.reactionStr_1="0"),e.test(ot.reactionStr_2)&&(ot.reactionStr_2="0");break;case 3:ot.whatToDraw==$n[3]&&(ot.whatToDraw=$n[0]),new RegExp("\\b("+An[3]+")\\b").test(ot.whatToPlot)&&(ot.whatToPlot=$n[0]),ot.diffusionStr_1_4="0",ot.diffusionStr_2_4="0",ot.diffusionStr_3_4="0",ot.diffusionStr_4_1="0",ot.diffusionStr_4_2="0",ot.diffusionStr_4_3="0",ot.diffusionStr_4_4="0",ot.boundaryConditions_4="periodic",ot.initCond_4="0",ot.reactionStr_4="0",e=new RegExp("\\b("+An[3]+")\\b"),e.test(ot.reactionStr_1)&&(ot.reactionStr_1="0"),e.test(ot.reactionStr_2)&&(ot.reactionStr_2="0"),e.test(ot.reactionStr_3)&&(ot.reactionStr_3="0")}switch(vn){case 3:ot.diffusionStr_2_2="0";break;case 6:ot.diffusionStr_3_3="0";break;case 7:ot.diffusionStr_2_2="0",ot.diffusionStr_3_3="0";break;case 10:ot.diffusionStr_4_4="0";break;case 11:ot.diffusionStr_3_3="0",ot.diffusionStr_4_4="0";break;case 12:ot.diffusionStr_2_2="0",ot.diffusionStr_3_3="0",ot.diffusionStr_4_4="0"}Fi(ut),Fi(ct)}function Wi(){!function(){switch(Ni(),parseInt(ot.numSpecies)){case 1:vn=0;break;case 2:vn=ot.crossDiffusion?1==ot.numAlgebraicSpecies?3:2:1;break;case 3:if(ot.crossDiffusion)switch(ot.numAlgebraicSpecies){case 0:vn=5;break;case 1:vn=6;break;case 2:vn=7}else vn=4;break;case 4:if(ot.crossDiffusion)switch(ot.numAlgebraicSpecies){case 0:vn=9;break;case 1:vn=10;break;case 2:vn=11;break;case 3:vn=12}else vn=8}}(),So(),Co(),Oi(),Bi(),To(),Vo(),ji()}function ji(){let e,t=Pn[vn];const n={U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(ot.typesetCustomEqs){let o={};o.U=ot.diffusionStr_1_1,o.UU=ot.diffusionStr_1_1,o.V=ot.diffusionStr_2_2,o.VV=ot.diffusionStr_2_2,o.W=ot.diffusionStr_3_3,o.WW=ot.diffusionStr_3_3,o.Q=ot.diffusionStr_4_4,o.QQ=ot.diffusionStr_4_4,o.UV=ot.diffusionStr_1_2,o.UW=ot.diffusionStr_1_3,o.UQ=ot.diffusionStr_1_4,o.VU=ot.diffusionStr_2_1,o.VW=ot.diffusionStr_2_3,o.VQ=ot.diffusionStr_2_4,o.WU=ot.diffusionStr_3_1,o.WV=ot.diffusionStr_3_2,o.WQ=ot.diffusionStr_3_4,o.QU=ot.diffusionStr_4_1,o.QV=ot.diffusionStr_4_2,o.QW=ot.diffusionStr_4_3,o.UFUN=ot.reactionStr_1,o.VFUN=ot.reactionStr_2,o.WFUN=ot.reactionStr_3,o.QFUN=ot.reactionStr_4,Object.keys(o).forEach((function(e){Ha(o[e])&&(o[e]="0")}));var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!na(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=No(o[e],$n,pn,"_(?:[xy][xybf]?)")})),Object.keys(o).forEach((function(e){o[e]=o[e].trim()})),Object.keys(o).forEach((function(e){if(!gn.includes(e)&&o[e].includes(";")){let t=o[e].split(";").filter((e=>e));t.length>1&&ot.dimension>1?o[e]="\\dmat{"+t.slice(0,2).join("}{")+"}":o[e]=t[0]}})),Wt.forEach((function(e){o[e]="\\selected{"+o[e]+"}"})),Object.keys(o).forEach((function(e){if(!gn.includes(e)){let i=o[e].includes("\\dmat")?"  ":"[]";t=function(e,t,n,i){null==i&&(i="  ");let o=n.replace(/\s+/g,"  ").trim();return["0","0.0","-0","-0.0","+0","+0.0"].includes(o)?e.replaceAll(t,""):"1"==o||"1.0"==o?e.replaceAll(t,"$2"):"-1"==o||"-1.0"==o?e.replaceAll(t,i[0]+"-"+i[1]+"$2"):e.replaceAll(t,i[0]+n+i[1]+"$2")}(t,n[e],o[e],i)}})),t=yo(t,n.UFUN,o.UFUN),t=yo(t,n.VFUN,o.VFUN),t=yo(t,n.WFUN,o.WFUN),t=yo(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}\(\)]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\(\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"\\lap $1"),e=/\\vnabla\s*\\cdot\s*\(\s*((?!\\vnabla).*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b(?:[xy]|[uvwq](?:_[xy])?|(?:I_[ST][RGBA]?))\b/g.test(t)||t.includes("\\dmat")?e:t.trim()+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])[fb]?2?\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else Wt.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{"+t+" ";return"string"==typeof n&&(i+=n),i+"}"}))})),t=No(t,["UFUN","VFUN","WFUN","QFUN"],gn);1==ot.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=No(t,pn.concat(gn),$n.concat(Tn),"_(?:[xy][xybf]?)"),t=Qi(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(qo)}function Qi(e){for(e=e.replaceAll(/\[([^\+\/\[\]-]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Gi(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Gi(e,"cos",!0),e=Gi(e,"tan",!0),e=Gi(e,"exp",!0),e=Gi(e,"log",!0),e=Gi(e,"sqrt",!1),e=Gi(e,"sinh",!0),e=Gi(e,"cosh",!0),e=Gi(e,"tanh",!0),e=Gi(e,"max",!0),e=Gi(e,"min",!0),e=_i(e=(e=Gi(e,"ind",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",s="";for(var l=0;l<e.length;l++)t.includes(e[l])?(i+=1,o+=1):n.includes(e[l])&&(i-=1),0==i&&o>0&&(r=e.slice(a,l+1),s+=zi(r,o),o=0,a=l+1);return s+=e.slice(a),s}(e=fe(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")).replaceAll(/<=/g," \\leq ")).replaceAll(/>=/g," \\geq ")).replaceAll(/([<>])/g," $1 ")}function Gi(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,s,l,u,c,d,h=0;for(const f of o){for(a=f.index,r=a+t.length,l=e.slice(r),d=0,u=0,c=!1;d<=l.length&(!c|!(c&&0==u));)u+=["(","["].includes(l[d]),u-=[")","]"].includes(l[d]),c|=u,d+=1;c&&0==u&&(s=d-1+r,i=Ji(i,"\\",a+h),h+=1,n?(i=Ji(i,"{",r+h),h+=1,i=Ji(i,"}",s+1+h),h+=1):(i=Yi(i,"{",r+h),i=Yi(i,"}",s+h)))}return i}function zi(e,t){const n=["(","["],i=[")","]"];let o=Hi(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=Yi(e,n[o],a),o+=1,o=Hi(o,n.length)):i.includes(e[a])&&(o-=1,o=Hi(o,n.length),e=Yi(e,i[o],a));return e}function Hi(e,t){return(e%t+t)%t}function Yi(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function Ji(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Xi(e){return e=e.replace(/\s+/g,"  ").trim()}function Zi(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=cn[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);cn[e]=cn[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),Fi(Mt),Ki(),ri(),(To()||Xt)&&(Xt=!1,Vo())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)dn.push(e),cn[e]="",n=Mt.add(cn,e).name(""),Ma(n.domElement.firstChild),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=dn.indexOf(e);let n=Xi(cn[dn.at(t)]);if(""==n);else{let e=Zi(dn.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);if(i){let t=i[1];ja(t),e.lastName=t,hn[t]=e}fn+=1;let o="params"+fn;this.remove(),Zi(o,!0),Ki(),(To()||Xt)&&(Xt=!1,Vo())}}));else{n=Mt.add(cn,e).name(""),Ma(n.domElement.firstChild),n.domElement.classList.add("params");const t=cn[e].match(/\s*(\w+)\s*=/);if(t){let e=t[1];ja(e),n.lastName=e,hn[e]=n}n.onFinishChange((function(){let t=Xi(cn[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=dn.indexOf(e);dn.splice(t,1),delete cn[e],n.hasOwnProperty("lastName")&&!_o(n.lastName)&&delete at[n.lastName]}else{i();const e=ko(t).match(/\s*(\w+)\s*=/);if(e){let t=e[1];ja(t),n.hasOwnProperty("lastName")&&n.lastName!=t&&!_o(n.lastName)&&(delete at[n.lastName],n.lastName=t,hn[t]=n)}}Ki(),To()&&Vo()}))}return i(),Ma(n.domElement.firstChild),n}function Ki(){ot.kineticParams=Object.values(cn).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function eo(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function to(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function no(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function io(){if(ot.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+Oo(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==ot.whatToPlot?($("#minLabel").html("$"+$n[0]+"$"),$("#midLabel").html("$"+$n[1]+"$"),$("#maxLabel").html("$"+$n[2]+"$")):Ht?$("#midLabel").html(ot.views[ot.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+Qi(ot.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),Do(),oo()}else $("#colourbar").hide()}function oo(){if("MAX"!=ot.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[ro(e,n),ro(t,n)]}(ot.minColourValue,ot.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=Mo(Oo(0)),t=Mo(Oo(.5)),n=Mo(Oo(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function ao(e,t){return e.toPrecision(t)}function ro(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function so(){ot.timeDisplay?($("#timeDisplay").show(),lo()):$("#timeDisplay").hide(),ho()}function lo(){if(ot.timeDisplay){let e=ao(at.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/,"  10<sup>$2$3<sup>"),$("#timeValue").html(e),go()}}function uo(){if(ot.integrate){$("#integralDisplay").show();let e="";1==ot.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+Qi(ot.whatToPlot)+"\\,\\d x",1==ot.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();ho()}function co(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function ho(){ot.integrate&&ot.timeDisplay?co("#timeDisplay",10):co("#timeDisplay",0)}function fo(){po(),zt&&(!isFinite(an[0])||Math.abs(an[0])>1e37||!isFinite(an[1]))||Math.abs(an[1])>1e37?(zt=!1,to("#oops_hit_nan"),fi(),$("#erase").one("pointerdown",(function(){no("#oops_hit_nan"),zt=!0,window.clearTimeout(xt),xt=setTimeout(fo,1e3)}))):xt=setTimeout(fo,1e3)}function mo(){if(!Fn){try{Ce.readRenderTargetPixels($e,0,0,$t,Tt,Sn)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}Fn=!0}}function po(){He.material=je,rt.textureSource.value=$e.texture,rt.srcResolution.value=new te.Vector2($t,Tt),rt.firstFlag.value=!0;for(const e of It)Ce.setRenderTarget(e),Ce.render(He,_e),rt.textureSource.value=e.texture,rt.srcResolution.value=new te.Vector2(e.width,e.height),rt.firstFlag.value=!1;try{const e=new Float32Array(4);Ce.readRenderTargetPixels(It.slice(-1)[0],0,0,1,1,e),an=[e[0],e[1]]}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}}function go(){if(ot.colourbar&&(ot.integrate||ot.timeDisplay)){let e,t=$("#colourbar")[0].getBoundingClientRect();e=ot.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(co("#dataContainer",40),Jt=!0):Jt&&(co("#dataContainer",0),Jt=!1)}}function bo(){vo()?(Rt.forEach((e=>{e.texture.magFilter=te.NearestFilter})),$e.texture.magFilter=te.NearestFilter,Te.texture.magFilter=te.NearestFilter):(Rt.forEach((e=>{e.texture.magFilter=te.LinearFilter})),$e.texture.magFilter=te.LinearFilter,Te.texture.magFilter=te.LinearFilter),Bi()}function vo(){return ve||ot.forceManualInterpolation}function wo(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function _o(e,t){return null==t&&(t=[]),function(e){return[...(p()+D()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e).concat(["I_T","I_TR","I_TG","I_TB","I_TA","I_S","I_SR","I_SG","I_SB","I_SA"])}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function yo(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function So(){"line"==ot.plotType?(jo(),ot.brushType="vline",ii(),Fi(ct),ze.visible=!1,Je.visible=!0,ot.contours=!1,ot.emboss=!1,ot.vectorField=!1,Oa()):(ze.visible=!0,Je.visible=!1,"surface"==ot.plotType?($("#simCanvas").css("outline","2px #000 solid"),rn&&(rn=!1,zn()),ot.vectorField=!1,Oa()):$("#simCanvas").css("outline","")),Xe.visible=ot.overlay&&"line"==ot.plotType,oi(),Hn(),Bi(),za()}function Co(){jt||(1!=ot.dimension&&"line"==ot.plotType&&(ot.plotType="plane",la("plotType"),So()),1==ot.dimension&&"line"!=ot.plotType&&(ot.plotType="line",ot.vectorField=!1,la("plotType"),So())),1==ot.dimension&&(ot.minY="0.0"),Gn(),yi(),ji(),Bi(),uo()}function xo(){const e="line"==ot.plotType?0:ot.cameraTheta,t="line"==ot.plotType?0:ot.cameraPhi,n=(new te.Vector3).setFromSphericalCoords(1,Math.PI/2-e*Math.PI/180,-t*Math.PI/180);we.position.set(n.x,n.y,n.z),we.lookAt(0,0,0)}function Do(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function Fo(){return ot.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function Eo(e){return ko(e)}function $o(){const e=/^\s*([a-zA-Z]\w*)\b/;let t=[];return Fo().split(";").filter((e=>e.length>0)).forEach((function(n){n.match(e)&&t.push(n.match(e)[1].trim())})),t}function To(){Fo().split(";").filter((e=>e.length>0));const e=function(e){let t={},n={},i=[];const o=function(){const e=/^\s*([a-zA-Z]\w*)\b\s*=\s*(.*)/;let t=[];return Fo().split(";").filter((e=>e.length>0)).forEach((function(n){const i=n.match(e);i?t.push([i[1].trim(),i[2].trim()]):ta("Unable to evaluate the parameter definition '"+n+"'. Please check for syntax errors.")})),t}(),a=o.map((e=>e[0]));o.forEach((e=>t[e[0]]=e[1]));for(const e of o){let[o,r]=e;o in n||([n,,i]=Uo(o,t,n,[o],a,[]))}i.length>0&&ta("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.");return Object.keys(n).map((e=>[e,n[e]]))}(),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}($o());if(t.length>0)return ta("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=Ao(t[0],t[1]);n|=e,i|=o}return n&&!i}function Ao(e,t){let n=!1,i=!1;const o=Eo(e);return _o(o)?(ta("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!at.hasOwnProperty(o),at[o]={type:"float",value:t}),[n,i]}function Po(){return Eo($o().map((e=>"uniform float "+e+";")).join("\n"))}function Uo(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const s of o)r=new RegExp("\\b"+s+"\\b","g"),r.test(t[e])&&(i.includes(s)?(n[s]=0,t[s]="0",t[e]="0",a.push(i.slice(i.indexOf(s)))):([n,,a]=Uo(s,t,n,[...i,s],o,a),t[e]=t[e].replaceAll(r,n[s].toString())));try{n[e]=kn.evaluate(t[e])}catch(t){ta("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function Vo(){yi(),Vi(),ii(),Ri(),ni(),Li()}function ko(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+En[e])););return n}function qo(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function Mo(e){return e.reduce(((e,t)=>e+t),0)/3}function Ro(){po(),ot.minColourValue=an[0],ot.maxColourValue=an[1],at.maxColourValue.value=ot.maxColourValue,at.minColourValue.value=ot.minColourValue,Nt.maxColourValue.updateDisplay(),Nt.minColourValue.updateDisplay(),oo()}function Io(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function Lo(){let e;null!=$n&&(e=$n);const t=ot.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,pn.length),n=t.concat(bn.slice(t.length)),i=$o();let o;for(var a=0;a<n.length;a++)if(_o(n[a],i))return o=i.includes(n[a])?"as a parameter":"under the hood",void ta("The name '"+n[a]+"' is used "+o+", so can't be used as a species name. Please use a different name for "+n[a]+".");$n=n,Tn=$n.map((e=>"f_{"+e+"}")),function(){An=[];for(let e=0;e<$n.length;e++)An.push("(?:"+$n.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let r={...ce(),...he()};if(Object.keys(r).forEach((function(e){Un[e]=Qi(No(r[e],pn,$n,"_(?:[xy][xybf]?)"))})),r=de(),Object.keys(r).forEach((function(e){Un[e]=Qi(No(r[e],gn,Tn))})),jt)return;const s=["initCond_1","initCond_2","initCond_3","initCond_4","kineticParams"];Object.keys(ot).forEach((function(t){Mn.includes(t)&&(s.includes(t)||(ot[t]=No(ot[t],e,$n,"_(?:[xy][xybf]?)")))})),ot.views=ot.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){Mn.includes(i)&&(n[i]=No(t[i],e,$n,"_(?:[xy][xybf]?)"))})),n})),Object.keys(lt).forEach((function(t){Mn.includes(t)&&(s.includes(t)||(lt[t]=No(lt[t],e,$n,"_(?:[xy][xybf]?)")))})),lt.views=lt.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){Mn.includes(i)&&(n[i]=No(t[i],e,$n,"_(?:[xy][xybf]?)"))})),n})),Oi(),Bi(),Vo(),ji()}function No(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function Bo(e,t){let n,i=e.geometry.attributes.instanceStart,o=e.geometry.attributes.instanceEnd;for(let e=0;e<t.length;e++)n=t[e].toArray(),n[1]*=ot.threeDHeightScale*Pt/Ut,e<t.length&&i.setXYZ(e,n[0],n[1],0),e>0&&o.setXYZ(e-1,n[0],n[1],0);i.needsUpdate=!0,o.needsUpdate=!0}function Oo(e){e=e.clamp(0,1);let t=0;for(;e>=it[t+1]&&t<nt.length-2;)t+=1;return it[t+1]==it[t]?nt[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=Wo(e[o],t[o],n);return i}(nt[t],nt[t+1],(e-it[t])/(it[t+1]-it[t])).map((e=>e.clamp(0,1)))}function Wo(e,t,n){return(1-(n=n.clamp(0,1)))*e+n*t}function jo(){Le.linewidth=.01*ot.lineWidthMul,Ne.linewidth=.01*ot.overlayLineWidthMul,Le.needsUpdate=!0,Ne.needsUpdate=!0}function Qo(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function Go(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function zo(e){e.forEach((function(e){Wt.add(e)})),ji()}function Ho(e){e.forEach((function(e){Wt.delete(e)})),ji()}function Yo(){Cn=new Float32Array($t*Tt*4),Ce.readRenderTargetPixels(Rt[1],0,0,$t,Tt,Cn),Ko(Cn),Kt=!0}function Jo(){Kt||Yo();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([$t,Tt]),Cn])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function Xo(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);Ko(e.slice(2),e.slice(0,2)),Zo(Pe),Kt=!0,pi()},t.readAsArrayBuffer(e)}function Zo(e){if(null!=e)if("crop"==ot.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=xe/t;i>1&&(n=t/xe,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function Ko(e,t){null!=Pe&&Pe.dispose(),null==t&&(t=[$t,Tt]),Pe=new te.DataTexture(e,t[0],t[1],te.RGBAFormat,te.FloatType),Pe.needsUpdate=!0,Pe.magFilter=ve?te.NearestFilter:te.LinearFilter,null!=We&&(We.map=Pe,We.needsUpdate)}function ea(){Ce.setSize(Math.round(devicePixelRatio*kt),Math.round(devicePixelRatio*qt),!1)}function ta(e){fi(),jt&&Qt||(Qt=!0,$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),to("#error")))}function na(e){if(/\(\s*\)/.test(e))return ta("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(ta("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(ta("A binary operator is missing an operand in "+e.trim()+"."),!1)}function ia(){let e;$("#views_list").empty();for(let t=0;t<ot.views.length;t++)e=document.createElement("a"),e.onclick=function(){ot.activeViewInd=t,oa(ot.views[t])},e.innerHTML="<div class='view_label'>"+ot.views[t].name+"</div>",t==ot.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);en=Math.max(ot.views.length,en),ot.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),ot.views.length}function oa(e,t){Object.assign(ot,e),delete ot.name,Fi(dt),(null==t||t)&&(Ri(),So(),oi(),Yn(),oo(),io(),Oa(),Pa(),ri())}function aa(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",ot.views[ot.activeViewInd].name);null!=e&&(ot.views[ot.activeViewInd].name=e,ia(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function ra(){ot.views.length>1?(ot.views.splice(ot.activeViewInd,1),ot.activeViewInd<1?ot.activeViewInd=0:ot.activeViewInd-=1):ot.views[ot.activeViewInd].name="Custom",oa(ot.views[ot.activeViewInd])}function sa(){let e={};return Vn.forEach((function(t){e[t]=lt[t]})),e}function la(e){ot.activeViewInd<ot.views.length&&(ot.views[ot.activeViewInd][e]=ot[e])}function ua(e,t){let n="";return n+=Ti(b(t),$n[e]),ot.dimension>1&&(n+=Ti(v(t),$n[e])),n}function ca(e,t){let n="";return n+=Ti(_(t),$n[e]),ot.dimension>1&&(n+=Ti(y(t),$n[e])),n}function da(e,t){let n="";return n+=Ti(S(t,wi(ot.domainIndicatorFun)),$n[e]),ot.dimension>1&&(n+=Ti(C(t,wi(ot.domainIndicatorFun)),$n[e])),n}function ha(e,t){let n="";return n+=Ti(b(t).replaceAll(/updated/g,"gl_FragColor"),$n[e]),ot.dimension>1&&(n+=Ti(v(t).replaceAll(/updated/g,"gl_FragColor"),$n[e])),n}function fa(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function ma(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function pa(e,t,n,i,o,a,r,s){const l=document.createElement("a");if(l.classList.add("toggle_button"),l.setAttribute("property",t),null==i&&(i=()=>{}),l.onclick=function(){ot[l.getAttribute("property")]=!ot[l.getAttribute("property")],qa(l),i()},null!=o&&(l.id=o),null!=a&&(l.title=a),null!=n&&(l.innerHTML=n),null!=r&&l.setAttribute("folderID",r),null!=s)for(const e of s)l.classList.add(e);return e.appendChild(l),qa(l),l}function ga(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function ba(){const e=Object.assign(z("default"),z(ot.parent));let t=Ii(ot,e);1==ot.views.length&&"1"==ot.views[0].name&&delete t.views;for(const e of Object.keys(ot.views[0]))ot.hasOwnProperty(e)&&ot.views.map((t=>t[e])).every((t=>t==ot[e]))&&ot.views.forEach((t=>delete t[e]));t.preset="PRESETNAME";let n=JSON.stringify(t).replaceAll(/(:[^:]*),/g,"$1,\n\t").replaceAll(":",": ").replaceAll("  "," ").replaceAll("{","{\n\t").replaceAll("}",",\n}");n='listOfPresets["PRESETNAME"] = '+n+";\n",navigator.clipboard.writeText(n)}function va(){let e="";e+=JSON.stringify(ot),e+=JSON.stringify(at),e+=JSON.stringify({nXDisc:$t,nYDisc:Tt,domainHeight:Pt,domainWidth:At,aspectRatio:xe,canvas:ge.getBoundingClientRect()}),navigator.clipboard.writeText(e)}function wa(){ot.showStats?qn.domElement.style.visibility="":qn.domElement.style.visibility="hidden"}function _a(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function ya(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function Sa(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function Ca(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function xa(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function Da(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function Fa(){let e=Ii(ot,z("default"));return e.preset="Custom",e=re(e),[location.href.replace(location.search,""),"?options=",le.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function Ea(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function $a(e){const t=hn[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function Ta(){at.embossAmbient.value=ot.embossAmbient,at.embossDiffuse.value=ot.embossDiffuse,at.embossShiny.value=ot.embossShiny,at.embossSmoothness.value=ot.embossSmoothness,at.embossSpecular.value=ot.embossSpecular,at.embossLightDir.value=new te.Vector3(Math.sin(ot.embossTheta)*Math.cos(ot.embossPhi),Math.sin(ot.embossTheta)*Math.sin(ot.embossPhi),Math.cos(ot.embossTheta))}function Aa(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function Pa(){for(const e of[...Ot,...Bt]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function Ua(){at.contourColour.value=new te.Color(ot.contourColour),at.contourEpsilon.value=ot.contourEpsilon,at.contourStep.value=1/(ot.contourNum+1)}function Va(){at.overlayColour.value=new te.Color(ot.overlayColour),at.overlayEpsilon.value=ot.overlayEpsilon,at.overlayLine.value=ot.overlay&&"line"==ot.plotType,Ne.color=new te.Color(ot.overlayColour),Ne.needsUpdate=!0}function ka(){tn=0,_t||ri()}function qa(e){ot[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function Ma(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function Ra(){ot.customSurface?Ve.vertexShader=W():Ve.vertexShader=O(),Ve.needsUpdate=!0}function Ia(){"surface"==ot.plotType?($(ft).show(),ot.customSurface?(Nt.surfaceFun.show(),Nt.threeDHeightScale.hide()):(Nt.surfaceFun.hide(),Nt.threeDHeightScale.show())):($(ft).hide(),Nt.surfaceFun.hide())}function La(){tt=new te.Group,ye.add(tt);const e=Math.max($t,Tt),t=Math.round(Wo(3,window.width<629?20:64,ot.arrowDensity));let n=Math.max(Math.floor(e/t),1);const i=Math.floor($t/n),o=Math.floor(Tt/n),a=Math.floor(($t-n*(i-1))/2),r=Math.floor((Tt-n*(o-1))/2);let s,l,u,c,d,h;for(let e=0;e<o;e++){l=r+e*n,h=((l+.5)/Tt-.5)*ze.geometry.parameters.height;for(let e=0;e<i;e++)u=a+e*n,d=((u+.5)/$t-.5)*ze.geometry.parameters.width,s=u+l*$t,c=Na([d,h,1],[0,0,0]),c.ind=s,tt.add(c)}}function Na(e,t){const n=new te.Group,i=new te.Mesh(Qe,Be);i.rotation.x=Math.PI/2;const o=new te.Mesh(Ge,Be);return o.rotation.x=Math.PI/2,o.rotation.y=Math.PI/4,o.position.z=Qe.parameters.height/2,n.add(i),n.add(o),n.scale.multiplyScalar(un),n.position.set(e[0],e[1],e[2]),n.lookAt(e[0]+t[0],e[1]+t[1],e[2]+t[2]),n}function Ba(){if(tt)for(ye.remove(tt);tt.children.length;)tt.remove(tt.children[0])}function Oa(){if(at.vectorField.value=ot.vectorField,ot.vectorField){if(Ba(),La(),Wa(),"relative"==ot.arrowScale)try{tt.customMax=kn.evaluate(ot.arrowLengthMax)}catch(e){ta("Unable to evaluate the maximum arrow length. Please check the definition."),tt.customMax=1}}else Ba()}function Wa(){Be.color=new te.Color(ot.arrowColour)}function ja(e){const t=_o(e,$n.concat(Tn));return t&&ta("The name '"+e+"' is already in use, so can't be used as a parameter name. Please use a different name for "+e+"."),!t}function Qa(e){return e=(e=e.replaceAll(/\bMINX\b/g,(()=>wi(ot.minX)))).replaceAll(/\bMINY\b/g,(()=>wi(ot.minY)))}function Ga(e,t,n,i,o){if(e in t)return[t,n.slice(0,-1),o];for(const a of i[e])n.includes(a)?o.push(n.slice(n.indexOf(a))):[t,,o]=Ga(a,t,[...n,a],i,o);return t[e]=!0,[t,n.slice(0,-1),o]}function za(){if($("#simCanvas").css("cursor","auto"),ot.brushEnabled&&"surface"!=ot.plotType&&"line"!=ot.plotType)switch(ot.brushType){case"circle":$("#simCanvas").css("cursor","url('images/cursor-circle.svg') 12 12, auto");break;case"hline":$("#simCanvas").css("cursor","url('images/cursor-hline.svg') 32 32, auto");break;case"vline":$("#simCanvas").css("cursor","url('images/cursor-vline.svg') 32 32, auto")}}function Ha(e){return/^\s*$/.test(e)}function Ya(){const e=Shepherd.activeTour?.getCurrentStep(),t=e?.getElement(),n=t?.querySelector(".shepherd-header"),i=document.createElement("span");i.classList.add("shepherd-progress"),i.innerText=`${Shepherd.activeTour?.steps.indexOf(e)+1} / ${Shepherd.activeTour?.steps.length}`,n?.insertBefore(i,t.querySelector(".shepherd-cancel-icon"))}function Ja(e,t){const n=Shepherd.activeTour?.getCurrentStep(),i=n?.getElement(),o=i?.querySelector(".shepherd-footer"),a=document.createElement("a");a.setAttribute("href",e),a.setAttribute("target","_blank"),a.classList.add("shepherd-more-info"),a.innerText=t||"More info.",o?.insertBefore(a,o.firstChild)}(eo()||Bn||ot.forceTryClickingPopup)&&!ot.suppressTryClickingPopup&&ot.brushEnabled&&($("#top_message").html("<p>"+ot.tryClickingText+"</p>"),to("#top_message"),setTimeout((()=>no("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>no("#top_message")))),jt=!1,function e(){ot.showStats&&qn.begin();St=yt,yt&&ot.brushEnabled&&function(){!ot.setSeed&&ot.brushValue.includes("RAND")&&Ui();He.material=ke;for(let e=1;e<Rt.length;e++)at.textureSource.value=Rt[e].texture,Ce.setRenderTarget(Rt[e-1]),Ce.render(Se,_e);Rt.rotate(-1)}();if(_t){!Ct||function(){He.material=qe;for(let e=1;e<Rt.length;e++)at.textureSource.value=Rt[e].texture,Ce.setRenderTarget(Rt[e-1]),Ce.render(Se,_e);Rt.rotate(-1)}();for(let e=0;e<ot.numTimestepsPerFrame;e++){if(ot.autoPause&&Gt&&at.t.value>=ot.autoPauseAt){Gt=!1,fi();break}Yt&&!ot.setSeed&&Ui(),ai()}}(St||_t)&&ri();ot.showStats&&qn.end();requestAnimationFrame(e)}()}();