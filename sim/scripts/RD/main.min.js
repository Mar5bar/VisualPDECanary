let e,n,t,i,o,a,r,s,l,c,u,d,f,m,p,h,g,b,v,S,w,y,C,V,U,_,F,x,E,D,W,T,Q,A,P,R,k,N,I,L,M,q,O,B,j,G,z,J,H,X,Y,Z,K,ee,ne,te,ie,oe,ae,re,se,le,ce,ue,de,fe,me,pe,he,ge,be,ve,Se,we,ye,Ce,Ve,Ue,_e,Fe,$e,xe,Ee,De,We,Te,Qe,Ae,Pe,Re,ke,Ne,Ie,Le,Me,qe,Oe,Be,je,Ge,ze,Je,He,Xe,Ye,Ze,Ke,en,nn,tn,on,an,rn,sn,ln,cn,un,dn,fn,mn,pn,hn,gn,bn,vn,Sn,wn,yn,Cn,Vn,Un,_n,Fn,$n,xn,En,Dn=[],Wn=new Set,Tn=!1,Qn=!1,An=!1,Pn=!1,Rn=!1,kn=!0,Nn=1,In={},Ln=[],Mn={},qn=0;const On=["u","v","w","q"],Bn=["UFUN","VFUN","WFUN","QFUN"],jn=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"],Gn=["REACT1","REACT2","REACT3","REACT4"];let zn,Jn,Hn,Xn,Yn,Zn,Kn=!1,et=!1;const nt=["zero","one","two","three","four","five","six","seven","eight","nine"];import{drawShaderTop as tt,drawShaderBotReplace as it,drawShaderBotAdd as ot,drawShaderShapeDisc as at,drawShaderShapeVLine as rt,drawShaderShapeHLine as st,drawShaderFactorSharp as lt,drawShaderFactorSmooth as ct}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as ut,computeDisplayFunShaderMid as dt,computeMaxSpeciesShaderMid as ft,postGenericShaderBot as mt,postShaderDomainIndicator as pt,interpolationShader as ht}from"./post_shaders.js";import{copyShader as gt}from"../copy_shader.js";import{RDShaderTop as bt,RDShaderBot as vt,RDShaderDirichletX as St,RDShaderDirichletY as wt,RDShaderDirichletIndicatorFun as yt,RDShaderRobinX as Ct,RDShaderRobinY as Vt,RDShaderUpdateNormal as Ut,RDShaderUpdateCross as _t,RDShaderAlgebraicV as Ft,RDShaderAlgebraicW as $t,RDShaderAlgebraicQ as xt,RDShaderEnforceDirichletTop as Et,RDShaderAdvectionPreBC as Dt,RDShaderAdvectionPostBC as Wt,RDShaderDiffusionPreBC as Tt,RDShaderDiffusionPostBC as Qt,RDShaderGhostX as At,RDShaderGhostY as Pt}from"./simulation_shaders.js";import{randShader as Rt}from"../rand_shader.js";import{fiveColourDisplayTop as kt,fiveColourDisplayBot as Nt,embossShader as It,contourShader as Lt,surfaceVertexShader as Mt}from"./display_shaders.js";import{getColours as qt}from"../colourmaps.js";import{genericVertexShader as Ot}from"../generic_shaders.js";import{getPreset as Bt,getUserTextFields as jt,getFieldsInView as Gt}from"./presets.js";import{clearShaderBot as zt,clearShaderTop as Jt}from"./clear_shader.js";import*as Ht from"../three.module.min.js";import{OrbitControls as Xt}from"../OrbitControls.js";import{Line2 as Yt}from"../lines/Line2.js";import{LineMaterial as Zt}from"../lines/LineMaterial.js";import{LineGeometry as Kt}from"../lines/LineGeometry.js";import{minifyPreset as ei,maxifyPreset as ni}from"./minify_preset.js";import{LZString as ti}from"../lz-string.min.js";import{equationTEXFun as ii,getDefaultTeXLabelsDiffusion as oi,getDefaultTeXLabelsReaction as ai,getDefaultTeXLabelsBCsICs as ri,substituteGreek as si}from"./TEX.js";let li,ci,ui,di=ii(),fi={...oi(),...ai(),...ri()};const mi=Gt();k={};const pi=jt();var hi,gi;I={reset:function(){Oi()},toggleRunning:function(){pn?Mi():qi()},copyConfigAsURL:function(){Ga(ja())},saveSimState:function(){Sa()},exportSimState:function(){wa()},clearCheckpoints:function(){Pn&&(h.dispose(),h=null,Pn=!1)},restoreCurrentView:function(){var e;k.activeViewInd<k.views.length&&(e=k.activeViewInd,k.views[e]=wn[e],xa(k.views[e]))}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,n){return Math.min(Math.max(this,e),n)},Array.prototype.rotate=(hi=Array.prototype.push,gi=Array.prototype.splice,function(e){var n=this.length>>>0;return e=((e>>=0)%n+n)%n,hi.apply(this,gi.call(this,0,e)),this}),e=document.getElementById("simCanvas"),console.error=function(e){Qn=!0;let n=e.toString();console.log(n);let t=/ERROR.*/;!t.test(n)||(n=n.match(t)),_a(n)},Wo()||$("#logo").hide();const bi=new URLSearchParams(window.location.search);if(bi.has("no_ui")?($(".ui").addClass("hidden"),An=!0):$(".ui").removeClass("hidden"),bi.has("sf")&&(Nn=parseFloat(bi.get("sf")),(isNaN(Nn)||Nn<=0)&&(Nn=1)),bi.has("story")&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),yn=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),!function(){for(var e=document.cookie.split(";"),n=0;n<e.length;n++){if("warning"==e[n].split("=")[0].trim())return!0}return!1}()&&!An){$("#warning").css("display","block");await Promise.race([Jo(document.getElementById("warning_ok"),"click",!0),Jo(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let n="expires="+e.toUTCString();document.cookie="warning=true;"+n+";path=/"}(),$("#warning").css("display","none")}Zi("default"),function(){N={brushCoords:{type:"v2",value:new Ht.Vector2(.5,.5)},colour1:{type:"v4",value:new Ht.Vector4(0,0,0,0)},colour2:{type:"v4",value:new Ht.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new Ht.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new Ht.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new Ht.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dy:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},seed:{type:"f",value:0},smoothingScale:{type:"f",value:k.smoothingScale+1},textureSource:{type:"t"},t:{type:"f",value:0}},hn=!1,u=new Ht.Raycaster,d=new Ht.Vector2,s=new Ht.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),s.autoClear=!0,n=s.getContext(),t=!(n.getExtension("OES_texture_float_linear")&&n.getExtension("EXT_float_blend")),p={format:Ht.RGBAFormat,type:Ht.FloatType,minFilter:Ht.NearestFilter},t|=/android/i.test(navigator.userAgent),p.magFilter=t?Ht.NearestFilter:Ht.LinearFilter,Dn.push(new Ht.WebGLRenderTarget(k.maxDisc,k.maxDisc,p)),Dn.push(Dn[0].clone()),f=Dn[0].clone(),m=Dn[0].clone(),Dn.forEach((e=>{e.texture.wrapS=Ht.RepeatWrapping,e.texture.wrapT=Ht.RepeatWrapping})),f.texture.wrapS=Ht.ClampToEdgeWrapping,f.texture.wrapT=Ht.ClampToEdgeWrapping,m.texture.wrapS=Ht.ClampToEdgeWrapping,m.texture.wrapT=Ht.ClampToEdgeWrapping,i=new Ht.OrthographicCamera(-.5,.5,.5,-.5,-1,10),c=new Xt(i,e),c.listenToKeyEvents(document),c.addEventListener("change",(function(){"surface"==k.plotType&&(k.cameraTheta=90-180*Math.atan2(i.position.z,i.position.y)/Math.PI,k.cameraPhi=180*Math.atan2(i.position.x,i.position.z)/Math.PI,k.cameraZoom=i.zoom,Ki(q),Pi())})),o=new Ht.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new Ht.Scene,r=new Ht.Scene,a.add(i),a.background=new Ht.Color(k.backgroundColour),g=new Ht.MeshBasicMaterial({side:Ht.DoubleSide}),b=new Ht.ShaderMaterial({uniforms:N,vertexShader:Ot(),transparent:!0,side:Ht.DoubleSide}),V=new Ht.ShaderMaterial({uniforms:N,vertexShader:Ot()}),_=new Ht.ShaderMaterial({uniforms:N,vertexShader:Ot(),fragmentShader:ht()}),v=new Ht.ShaderMaterial({uniforms:N,vertexShader:Ot()}),S=new Ht.ShaderMaterial({uniforms:N,vertexShader:Ot()}),C=new Ht.ShaderMaterial({uniforms:N,vertexShader:Ot(),fragmentShader:gt()}),y=new Ht.ShaderMaterial({uniforms:N,vertexShader:Ot()}),w=new Ht.ShaderMaterial({uniforms:N,vertexShader:Ot()}),U=new Zt({vertexColors:!0,linewidth:.01}),F=new Ht.MeshBasicMaterial;const l=new Ht.PlaneGeometry(1,1);E=new Ht.Mesh(l,S),E.position.z=0,r.add(E),_i(),Fi(),Ci(),xi(),wi(),Di(),vo(),wo(),Ti(),Wi(),lo(),Go(),Oi(),e.addEventListener("pointerdown",Ri),e.addEventListener("pointerup",ki),e.addEventListener("pointermove",Ni),document.addEventListener("keypress",(function(e){var n=(e=e||window.event).target,t=1==n.nodeType?n.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(t)||("r"===e.key&&$("#erase").click()," "===e.key&&I.toggleRunning(),"h"===e.key&&(An?(An=!1,$(".ui").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",yn),pn?qi():Mi(),jo(),ea(),ra()):(An=!0,$(".ui").addClass("hidden"))),"s"==e.key&&Sa(),"c"==e.key&&(k.resetFromCheckpoints=!k.resetFromCheckpoints,Ki(q)))})),window.addEventListener("resize",wi,!1),window.addEventListener("message",za),$("#checkpointInput").change((function(){ya(this.files[0]),this.value=null}))}();let vi=!0;if(bi.has("preset")&&(Yi(bi.get("preset")),vi=!1),bi.has("options")){var Si=JSON.parse(ti.decompressFromEncodedURIComponent(bi.get("options")));Si.hasOwnProperty("p")&&(Si=ni(Si)),Yi(Si),vi=!1}function wi(){_i(),Ei(),Ca(h),Vi(),yi(),Ci(),ea(),ra(),Pi()}function yi(){x.geometry.dispose(),a.remove(x),D.geometry.dispose(),a.remove(D),W.geometry.dispose(),a.remove(W),Fi()}function Ci(){switch(Ui(),k.plotType){case"line":k.cameraTheta=0,k.cameraPhi=0,c.enabled=!1,i.zoom=1,Ko(),b.vertexShader=Mt();break;case"plane":c.enabled=!1,c.reset(),b.vertexShader=Ot();break;case"surface":c.enabled=!0,i.zoom=k.cameraZoom,Ko(),b.vertexShader=Mt()}b.needsUpdate=!0,i.left=-Un/(2*Fn),i.right=Un/(2*Fn),i.top=_n/(2*Fn),i.bottom=-_n/(2*Fn),i.updateProjectionMatrix(),$i()}function Vi(){N.L.value=k.domainScale,N.L_y.value=_n,N.L_x.value=Un,N.L_min.value=Math.min(_n,Un),N.dt.value=k.dt,N.dx.value=Un/Cn,N.dy.value=_n/Vn,N.heightScale.value=k.threeDHeightScale,N.maxColourValue.value=k.maxColourValue,N.minColourValue.value=k.minColourValue,Ja(),k.fixRandSeed||so()}function Ui(){$n=Math.round(e.getBoundingClientRect().width),xn=Math.round(e.getBoundingClientRect().height),l=xn/$n,l<=0&&(l=.1),l>=1?(_n=k.domainScale,Un=_n/l):(Un=k.domainScale,_n=Un*l),1==k.dimension&&(Un=k.domainScale),N.L_x.value=Un,N.L_y.value=_n,Fn=Math.max(Un,_n)}function _i(){Ui(),0==k.spatialStep&&(alert("Oops! A spatial step of 0 would almost certainly crash your device. We've reset it to 1% of the maximum domain length to prevent this."),k.spatialStep=k.domainScale/100),Cn=Math.floor(Un/k.spatialStep),Vn=Math.floor(_n/k.spatialStep),0==Cn&&(Cn=1),0==Vn&&(Vn=1),1==k.dimension&&(Vn=1),N.nXDisc.value=Cn,N.nYDisc.value=Vn,T=new Array(Cn),Q=new Array(Cn);let e=-.5,n=1/Cn;for(let t=0;t<T.length;t++)T[t]=e,e+=n;Ua(),Yn=new Float32Array(Cn*Vn*4),et=!1}function Fi(){Ui();let e=[1,1];kn||(e=[Cn,Vn]);const n=new Ht.PlaneGeometry(Un/Fn,_n/Fn,e[0],e[1]);x=new Ht.Mesh(n,b),x.position.z=0,x.visible="line"!=k.plotType,x.matrixAutoUpdate=!1,a.add(x);const t=new Ht.PlaneGeometry(Un/Fn,_n/Fn,1,1);D=new Ht.Mesh(t,g),D.position.z=0,D.visible=!1,D.matrixAutoUpdate=!1,a.add(D),$i();const i=new Kt;A=Math.round(devicePixelRatio*$n);const o=new Array(3*A).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),W=new Yt(i,U),W.scale.set(1,1,1),W.visible="line"==k.plotType,a.add(W)}function $i(){switch(k.plotType){case"plane":x.rotation.x=0,D.rotation.x=0;break;case"surface":x.rotation.x=-Math.PI/2,D.rotation.x=-Math.PI/2}x.updateMatrix(),D.updateMatrix()}function xi(){k.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Ei(){E.material=C;for(let e=1;e<Dn.length;e++)N.textureSource.value=Dn[e].texture,Dn[e-1].setSize(Cn,Vn),s.setRenderTarget(Dn[e-1]),s.render(r,o);Dn.rotate(-1),Dn[0].dispose(),Dn[0]=Dn[1].clone(),f.setSize(Cn,Vn),m.setSize((k.smoothingScale+1)*Cn,(k.smoothingScale+1)*Vn)}function Di(e){M=new dat.GUI({closeOnTop:!0,autoPlace:!1}),M.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(M.domElement),q=new dat.GUI({closeOnTop:!0,autoPlace:!1}),q.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(q.domElement),O=new dat.GUI({closeOnTop:!0,autoPlace:!1}),O.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(O.domElement),M.open(),q.open(),O.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),B=q.addFolder("Brush"),B.add(k,"brushEnabled").name("Enabled"),B.add(k,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange(Ti),j=B.add(k,"typeOfBrush",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange(Ti),B.add(k,"brushValue").name("Value").onFinishChange(Ti),B.add(k,"brushRadius").name("Radius").onChange(Ti),ge=B.add(k,"whatToDraw",li).name("Species").onChange(Ti),B=q.addFolder("Domain"),B.add(k,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){Zo(),Pi()})),B.add(k,"domainScale").name("Largest side").onChange(wi);const n=B.add(k,"spatialStep").name("Space step").onChange((function(){wi()}));n.__precision=12,n.min(0),n.updateDisplay(),B.add(k,"squareCanvas").name("Square").onFinishChange((function(){xi(),wi(),Ci()})),B.add(k,"domainViaIndicatorFun").name("Implicit").onFinishChange((function(){So(),vo(),Ji(),go()})),Z=B.add(k,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){So(),vo(),Ji(),mo()})),B=q.addFolder("Timestepping"),B.add(k,"numTimestepsPerFrame",1,400,1).name("Steps/frame"),he=B.add(k,"dt").name("Timestep").onChange((function(){Vi()})),he.__precision=12,he.min(0),he.updateDisplay(),B.add(k,"timeDisplay").name("Show time").onChange(No),B=q.addFolder("Equations"),B.add(k,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange(wo),Y=B.add(k,"crossDiffusion").name("Cross diffusion").onChange(wo),X=B.add(k,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Rn=!0,wo(),Rn=!1})),B.add(k,"speciesNames").name("Species names").onFinishChange((function(){ua()})),B.add(k,"reactionNames").name("Reactions").onFinishChange((function(){ua()})),B=M.addFolder("Definitions"),B.add(k,"typesetCustomEqs").name("Typeset").onChange(yo),K=B.add(k,"diffusionStrUU").onFinishChange((function(){Ji(),yo()})),ha(K,ba,["D","U","UU"]),ga(K,va,["D","U","UU"]),ee=B.add(k,"diffusionStrUV").onFinishChange((function(){Ji(),yo()})),ha(ee,ba,["UV"]),ga(ee,va,["UV"]),ne=B.add(k,"diffusionStrUW").onFinishChange((function(){Ji(),yo()})),ha(ne,ba,["UW"]),ga(ne,va,["UW"]),te=B.add(k,"diffusionStrUQ").onFinishChange((function(){Ji(),yo()})),ha(te,ba,["UQ"]),ga(te,va,["UQ"]),ie=B.add(k,"diffusionStrVU").onFinishChange((function(){Ji(),yo()})),ha(ie,ba,["VU"]),ga(ie,va,["VU"]),oe=B.add(k,"diffusionStrVV").onFinishChange((function(){Ji(),yo()})),ha(oe,ba,["V","VV"]),ga(oe,va,["V","VV"]),ae=B.add(k,"diffusionStrVW").onFinishChange((function(){Ji(),yo()})),ha(ae,ba,["VW"]),ga(ae,va,["VW"]),re=B.add(k,"diffusionStrVQ").onFinishChange((function(){Ji(),yo()})),ha(re,ba,["VQ"]),ga(re,va,["VQ"]),se=B.add(k,"diffusionStrWU").onFinishChange((function(){Ji(),yo()})),ha(se,ba,["WU"]),ga(se,va,["WU"]),le=B.add(k,"diffusionStrWV").onFinishChange((function(){Ji(),yo()})),ha(le,ba,["WV"]),ga(le,va,["WV"]),ce=B.add(k,"diffusionStrWW").onFinishChange((function(){Ji(),yo()})),ha(ce,ba,["W","WW"]),ga(ce,va,["W","WW"]),ue=B.add(k,"diffusionStrWQ").onFinishChange((function(){Ji(),yo()})),ha(ue,ba,["WQ"]),ga(ue,va,["WQ"]),de=B.add(k,"diffusionStrQU").onFinishChange((function(){Ji(),yo()})),ha(de,ba,["QU"]),ga(de,va,["QU"]),fe=B.add(k,"diffusionStrQV").onFinishChange((function(){Ji(),yo()})),ha(fe,ba,["QV"]),ga(fe,va,["QV"]),me=B.add(k,"diffusionStrQW").onFinishChange((function(){Ji(),yo()})),ha(me,ba,["QW"]),ga(me,va,["QW"]),pe=B.add(k,"diffusionStrQQ").onFinishChange((function(){Ji(),yo()})),ha(pe,ba,["Q","QQ"]),ga(pe,va,["Q","QQ"]),G=B.add(k,"reactionStrU").onFinishChange((function(){Ji(),yo()})),ha(G,ba,["UFUN"]),ga(G,va,["UFUN"]),z=B.add(k,"reactionStrV").onFinishChange((function(){Ji(),yo()})),ha(z,ba,["VFUN"]),ga(z,va,["VFUN"]),J=B.add(k,"reactionStrW").onFinishChange((function(){Ji(),yo()})),ha(J,ba,["WFUN"]),ga(J,va,["WFUN"]),H=B.add(k,"reactionStrQ").onFinishChange((function(){Ji(),yo()})),ha(H,ba,["QFUN"]),ga(H,va,["QFUN"]),En=M.addFolder("Parameters"),function(){let e,n,t=k.kineticParams.split(";");for(var i=0;i<t.length;i++)n=xo(t[i]),""==n||(n=n.replace(/(\S)=/,"$1 ="),n=n.replace(/=(\S)/,"= $1"),n=n.replaceAll(/,(\S)/g,", $1"),e="param"+qn,qn+=1,Ln.push(e),In[e]=n,Eo(e,!1));e="param"+qn,Ln.push(e),In[e]=n,Eo(e,!0)}(),B=M.addFolder("Boundary conditions"),Oe=B.add(k,"boundaryConditionsU",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){Ji(),ro()})),ze=B.add(k,"dirichletStrU").onFinishChange(Ji),nn=B.add(k,"neumannStrU").onFinishChange(Ji),rn=B.add(k,"robinStrU").onFinishChange(Ji),Ye=B.add(k,"comboStrU").name("Details").onFinishChange(Ji),Be=B.add(k,"boundaryConditionsV",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){Ji(),ro()})),Je=B.add(k,"dirichletStrV").onFinishChange(Ji),tn=B.add(k,"neumannStrV").onFinishChange(Ji),sn=B.add(k,"robinStrV").onFinishChange(Ji),Ze=B.add(k,"comboStrV").name("Details").onFinishChange(Ji),je=B.add(k,"boundaryConditionsW",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){Ji(),ro()})),He=B.add(k,"dirichletStrW").onFinishChange(Ji),on=B.add(k,"neumannStrW").onFinishChange(Ji),ln=B.add(k,"robinStrW").onFinishChange(Ji),Ke=B.add(k,"comboStrW").name("Details").onFinishChange(Ji),Ge=B.add(k,"boundaryConditionsQ",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).name("$q$").onChange((function(){Ji(),ro()})),Xe=B.add(k,"dirichletStrQ").onFinishChange(Ji),an=B.add(k,"neumannStrQ").onFinishChange(Ji),cn=B.add(k,"robinStrQ").onFinishChange(Ji),en=B.add(k,"comboStrQ").name("Details").onFinishChange(Ji),B=M.addFolder("Initial conditions"),Ie=B.add(k,"clearValueU").onFinishChange(lo),Le=B.add(k,"clearValueV").onFinishChange(lo),Me=B.add(k,"clearValueW").onFinishChange(lo),qe=B.add(k,"clearValueQ").onFinishChange(lo),B=q.addFolder("Plotting"),be=B.add(k,"lineWidthMul",.1,2).name("Thickness").onChange((function(){pa(),Pi()})),ve=B.add(k,"threeDHeightScale").name("Max height").onChange(Vi),Se=B.add(k,"cameraTheta").name("View $\\theta$").onChange(Ci),we=B.add(k,"cameraPhi").name("View $\\phi$").onChange(Ci),ye=B.add(k,"cameraZoom").name("Zoom").onChange(Ci),Ce=B.add(k,"forceManualInterpolation").name("Man. smooth").onChange(Go),Ve=B.add(k,"smoothingScale",0,16,1).name("Smoothing").onChange((function(){Ei(),N.smoothingScale.value=k.smoothingScale+1,Pi()})),B=B.addFolder("Contours"),$e=B.add(k,"contourNum").name("Number").onChange((function(){Xa(),Ya()})),Ha($e,1,20,1),Fe=B.add(k,"contourEpsilon").name("Threshold").onChange((function(){Xa(),Ya()})),Ha(Fe,.001,.05,.001),B.addColor(k,"contourColour").name("Colour").onChange((function(){Xa(),Ya()})),B=q.addFolder("Colour"),B.add(k,"colourbar").name("Colour bar").onChange(Ao),B.addColor(k,"backgroundColour").name("Background").onChange((function(){a.background=new Ht.Color(k.backgroundColour),Pi()})),B=B.addFolder("Lighting"),Qe=B.add(k,"embossSmoothness").name("Smoothness").onChange((function(){Ja(),Ya()})),Ha(Qe,0,10,.001),Ae=B.add(k,"embossAmbient").name("Ambient").onChange((function(){Ja(),Ya()})),Ha(Ae,0,1,.001),Pe=B.add(k,"embossDiffuse").name("Diffuse").onChange((function(){Ja(),Ya()})),Ha(Pe,0,1,.001),Re=B.add(k,"embossSpecular").name("Specular").onChange((function(){Ja(),Ya()})),Ha(Re,0,1,.001),Te=B.add(k,"embossShiny").name("Precision").onChange((function(){Ja(),Ya()})),Ha(Te,0,100,1),ke=B.add(k,"embossTheta").name("Inclination").onChange((function(){Ja(),Ya()})),Ha(ke,0,1.5708,.001),Ne=B.add(k,"embossPhi").name("Direction").onChange((function(){Ja(),Ya()})),Ha(Ne,0,3.1456,.001),un=q.addFolder("Images"),B=un,fo(),B=q.addFolder("Checkpoints"),B.add(k,"resetFromCheckpoints").name("Enabled"),B.add(k,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize");const t=document.createElement("li");t.classList.add("button_list"),B.domElement.children[0].appendChild(t),ka(t,"Set",Sa),ka(t,"Export",wa),ka(t,"Import",(function(){$("#checkpointInput").click()})),B=q.addFolder("Misc."),B.add(k,"integrate").name("Integrate").onChange((function(){Lo(),Pi()})),B.add(k,"fixRandSeed").name("Fix random seed");const i=document.createElement("li");i.classList.add("button_list"),B.domElement.children[0].appendChild(i),ka(i,'<i class="fa-regular fa-copy"></i> Copy code',Na),B=B.addFolder("Debug");const o=document.createElement("li");o.classList.add("button_list"),B.domElement.children[0].appendChild(o),ka(o,"Copy debug information",Ia);const r=document.createElement("div");r.innerHTML="Settings",r.classList.add("ui_title"),q.domElement.prepend(r);const s=document.createElement("div");s.innerHTML="Equations",s.classList.add("ui_title"),M.domElement.prepend(s);const l=document.createElement("div");l.id="views_list",O.domElement.prepend(l);const c=document.createElement("div");c.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",c.classList.add("ui_title"),O.domElement.prepend(c),B=O.addFolder("Edit view");const u=document.createElement("li");u.id="edit_view_buttons",u.classList.add("button_list"),B.domElement.children[0].appendChild(u),ka(u,'<i class="fa-solid fa-pen-nib"></i> Rename',Ea,null,"Rename view"),ka(u,'<i class="fa-solid fa-xmark"></i> Delete',Da,"deleteViewButton","Delete view"),mn=B.add(k,"whatToPlot").name("Expression: ").onFinishChange((function(){mo(),Pi(),Ta(this.property)})),B.add(k,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){Yo(),document.activeElement.blur(),Pi(),Ta(this.property)})),B.add(k,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){Qi(),Ao(),Ta(this.property)})).name("Colour map"),xe=B.add(k,"minColourValue").name("Min value").onChange((function(){Vi(),Po(),Pi(),Ta(this.property)})),xe.__precision=2,Ee=B.add(k,"maxColourValue").name("Max value").onChange((function(){Vi(),Po(),Pi(),Ta(this.property)})),Ee.__precision=2,We=B.add(k,"autoSetColourRange").name("Auto snap").onChange((function(){k.autoSetColourRange&&(la(),Pi()),Ta(this.property)})),_e=B.add(k,"contours").name("Contours").onChange((function(){Qi(),Ta(this.property)})),Ue=B.add(k,"emboss").name("Lighting").onChange((function(){Qi(),Ta(this.property)}));const d=document.createElement("li");d.id="colour_map_buttons",d.classList.add("button_list"),B.domElement.children[0].appendChild(d),ka(d,'<i class="fa-solid fa-arrow-right-arrow-left"></i> Reverse',(function(){k.flippedColourmap=!k.flippedColourmap,Qi(),Ao(),Ta("flippedColourmap")}),null,"Reverse colour map"),ka(d,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){la(),Pi(),Ta("minColourValue"),Ta("maxColourValue")}),null,"Snap min/max to visible")}function Wi(){Qi(),Ao(),mo(),Ti()}function Ti(){let e=ia()+tt(),n="float brushRadius = "+Gi(k.brushRadius.toString())+";\n";switch(n=n.replace(/\buvwq\./g,"uvwqBrush."),n=n.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),k.brushValue.includes("RAND")&&(e+=Rt()),e+="float brushValue = "+Gi(k.brushValue)+";\n",e+=n,k.typeOfBrush){case"circle":e+=at();break;case"hline":e+=st();break;case"vline":e+=rt()}switch(k.brushAction){case"replace":e+=lt(),e+=it();break;case"add":e+=lt(),e+=ot();break;case"smoothreplace":e+=ct(),e+=it();break;case"smoothadd":e+=ct(),e+=ot()}e=function(e){let n=/COLOURSPEC/g;return e=e.replace(n,ao(k.whatToDraw)),e}(e),v.fragmentShader=e,v.needsUpdate=!0}function Qi(){P=qt(k.colourmap),k.flippedColourmap&&(P.reverse(),P=P.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),N.colour1.value=new Ht.Vector4(...P[0]),N.colour2.value=new Ht.Vector4(...P[1]),N.colour3.value=new Ht.Vector4(...P[2]),N.colour4.value=new Ht.Vector4(...P[3]),N.colour5.value=new Ht.Vector4(...P[4]);let e=kt();k.emboss&&(e+=It(),Ja()),k.contours&&(e+=Lt(),Xa()),e+=Nt(),b.fragmentShader=e,b.needsUpdate=!0,V.needsUpdate=!0,R=P.map((e=>e[3])),P=P.map((e=>e.slice(0,-1))),Pi()}function Ai(){E.material=S,N.textureSource.value=Dn[1].texture,s.setRenderTarget(Dn[0]),s.render(r,o),Dn.rotate(-1)}function Pi(){if(k.autoSetColourRange&&la(),k.brushEnabled&&"surface"==k.plotType){let e=(function(){Bo();let e=0;for(let n=0;n<Yn.length;n+=4)e+=Yn[n];return e/(Cn*Vn)}()-k.minColourValue)/(k.maxColourValue-k.minColourValue)-.5;D.position.y=k.threeDHeightScale*e.clamp(-.5,.5),D.updateWorldMatrix()}if(E.material=V,N.textureSource.value=Dn[1].texture,s.setRenderTarget(f),s.render(r,o),N.textureSource.value=f.texture,et=!1,"line"==k.plotType){Bo();let e,n=0;for(let t=0;t<Yn.length;t+=4)e=(Yn[t]-k.minColourValue)/(k.maxColourValue-k.minColourValue)-.5,Q[n++]=e.clamp(-.5,.5);const t=new Ht.SplineCurve(T.map(((e,n)=>new Ht.Vector2(e,Q[n])))),i=t.getSpacedPoints(A);!function(e){let n,t=W.geometry.attributes.instanceStart,i=W.geometry.attributes.instanceEnd;for(let o=0;o<e.length;o++)n=e[o].toArray(),n[1]*=k.threeDHeightScale,o<e.length&&t.setXYZ(o,n[0],n[1],0),o>0&&i.setXYZ(o-1,n[0],n[1],0);t.needsUpdate=!0,i.needsUpdate=!0}(i),function(e){let n,t=W.geometry.attributes.instanceColorStart,i=W.geometry.attributes.instanceColorEnd;for(let o=0;o<e.length;o++)n=fa(e[o].toArray()[1]+.5),o<e.length&&t.setXYZ(o,n[0],n[1],n[2]),o>0&&i.setXYZ(o-1,n[0],n[1],n[2]);t.needsUpdate=!0}(i)}if(k.timeDisplay&&Io(),k.integrate&&function(){if(k.integrate){let e;Bo(),1==k.dimension?e=N.dx.value:2==k.dimension&&(e=N.dx.value*N.dy.value);let n=0;for(let e=0;e<Yn.length;e+=4)n+=Yn[e];n*=e,$("#integralValue").html(Ro(n,4)),jo()}}(),zo()&&(E.material=_,s.setRenderTarget(m),s.render(r,o),N.textureSource.value=m.texture),s.setRenderTarget(null),s.render(a,i),Kn){Kn=!1;var e=document.createElement("a");e.download="VisualPDEScreenshot",s.render(a,i),e.href=s.domElement.toDataURL(),document.body.appendChild(e),e.click(),document.body.removeChild(e),_i(),Pi()}}function Ri(n){hn=Ii(n,e),hn&&(k.brushEnabled&&"surface"==k.plotType?c.enabled=!1:k.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),To("#top_message"),window.clearTimeout(Sn),Sn=setTimeout((function(){$("#top_message").hasClass("fading_out")||Qo("#top_message")}),3e3)))}function ki(e){hn=!1,"surface"==k.plotType&&(c.enabled=!0)}function Ni(n){Ii(n,e)}function Ii(e,n){var t=n.getBoundingClientRect();let o=(e.clientX-t.x)/t.width,a=1-(e.clientY-t.y)/t.height;if("surface"==k.plotType){d.x=2*o-1,d.y=2*a-1,u.setFromCamera(d,i);var r=u.intersectObject(D,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==k.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*Cn)/Cn,a=Math.round(a*Vn)/Vn,N.brushCoords.value=new Ht.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function Li(){s.setSize(Cn,Vn,!1),k.fixRandSeed||so(),Pn&&k.resetFromCheckpoints?E.material=F:E.material=y,Dn.forEach((e=>{s.setRenderTarget(e),s.render(r,o)})),Ua(),Pi()}function Mi(){An||($("#pause").hide(),$("#play").show()),pn=!1}function qi(){An||($("#play").hide(),$("#pause").show()),pn=!0}function Oi(){Li(),N.t.value=0,Io(),Pi(),window.clearTimeout(vn),Oo()}function Bi(){let e="";return e+="float UFUN = "+Gi(k.reactionStrU)+";\n",e+="float VFUN = "+Gi(k.reactionStrV)+";\n",e+="float WFUN = "+Gi(k.reactionStrW)+";\n",e+="float QFUN = "+Gi(k.reactionStrQ)+";\n",e}function ji(e,n){let t="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return t+="float D"+n+" = "+e,t+="float D"+n+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),t+="float D"+n+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),t+="float D"+n+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),t+="float D"+n+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),t}function Gi(e){if(!Fa(e=" "+e+" "))return" 0.0 ";for(e=aa(e=(e=(e=(e=zi(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,n,t){switch(t){case"0":return"1";case"1":return"("+n+")";case"2":return"(("+n+")*("+n+"))";case"3":return"(("+n+")*("+n+")*("+n+"))";case"4":return"(("+n+")*("+n+")*("+n+")*("+n+"))";case"5":return"(("+n+")*("+n+")*("+n+")*("+n+")*("+n+"))";default:return"safepow("+n+","+t+")"}}))).replaceAll(RegExp("\\b("+ui[0]+")\\b","g"),(function(e,n){return"uvwq."+ao(n)}))).replaceAll(RegExp("\\b("+ui[0]+")_([xy])\\b","g"),(function(e,n,t){return"uvwq"+t.toUpperCase()+"."+ao(n)}))).replaceAll(RegExp("\\b("+ui[0]+")_(xx|yy)\\b","g"),(function(e,n,t){return"uvwq"+t.toUpperCase()+"."+ao(n)})));e!=(e=e.replace(/([^.0-9])(\d+)([^.0-9])/g,"$1$2.$3")););return e}function zi(e,n,t){const i="^*".includes(n);if(e.indexOf(n)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,n){return a.push(n),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+n+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+n+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,n){return a[n].replace(o,t)}))}return e}function Ji(){let e="",n="",t="",i="",o="";const a=[k.boundaryConditionsU,k.boundaryConditionsV,k.boundaryConditionsW,k.boundaryConditionsQ],r=[k.neumannStrU,k.neumannStrV,k.neumannStrW,k.neumannStrQ],s=[k.comboStrU,k.comboStrV,k.comboStrW,k.comboStrQ].map((e=>e+";")),l=[k.dirichletStrU,k.dirichletStrV,k.dirichletStrW,k.dirichletStrQ],c=[k.robinStrU,k.robinStrV,k.robinStrW,k.robinStrQ];if(a.forEach((function(n,t){"neumann"==n?(e+=Hi(r[t],li[t]),e+=Qa(t)):"combo"==n&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(n){const i=n[1][0].toUpperCase();e+=Hi(n[2],li[t],i),e+=Qa(t,i)}))})),a.forEach((function(e,t){"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=function(e,n,t){let i="";i+=oo(At(n),li[e]),k.dimension>1&&(i+=oo(Pt(n),li[e]));return i=i.replaceAll("GHOSTSPECIES",t),i}(t,i,Gi(e[2]))}))})),k.domainViaIndicatorFun){let e=yt().replace(/indicatorFun/g,Gi(k.domainIndicatorFun));l.forEach((function(n,i){t+=oo(e,li[i])+Gi(n)+";\n}\n"}))}else a.forEach((function(e,n){"dirichlet"==e?(t+=Xi(l[n],li[n]),t+=Aa(n)):"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=Xi(e[2],li[n],i),t+=Aa(n,i)}))}));a.forEach((function(e,n){"robin"==e?(i+=Hi(c[n],li[n]),i+=Pa(n)):"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const t=e[1][0].toUpperCase();i+=Hi(e[2],li[n],t),i+=Pa(n,t)}))}));let u=ia();if(o=function(){let e="";return e+=ji(Gi(k.diffusionStrUU)+";\n","uu"),e+=ji(Gi(k.diffusionStrVV)+";\n","vv"),e+=ji(Gi(k.diffusionStrWW)+";\n","ww"),e+=ji(Gi(k.diffusionStrQQ)+";\n","qq"),e}()+"\n",k.crossDiffusion?o+=function(){let e="";return e+=ji(Gi(k.diffusionStrUV)+";\n","uv"),e+=ji(Gi(k.diffusionStrUW)+";\n","uw"),e+=ji(Gi(k.diffusionStrUQ)+";\n","uq"),e+=ji(Gi(k.diffusionStrVU)+";\n","vu"),e+=ji(Gi(k.diffusionStrVW)+";\n","vw"),e+=ji(Gi(k.diffusionStrVQ)+";\n","vq"),e+=ji(Gi(k.diffusionStrWU)+";\n","wu"),e+=ji(Gi(k.diffusionStrWV)+";\n","wv"),e+=ji(Gi(k.diffusionStrWQ)+";\n","wq"),e+=ji(Gi(k.diffusionStrQU)+";\n","qu"),e+=ji(Gi(k.diffusionStrQV)+";\n","qv"),e+=ji(Gi(k.diffusionStrQW)+";\n","qw"),e}()+"\n"+_t():o+=Ut(),Jn&&k.crossDiffusion&&(o+=oo(Ft(),li[1])),Hn&&k.crossDiffusion&&(o+=oo($t(),li[2])),Xn&&k.crossDiffusion&&(o+=oo(xt(),li[3])),o.match(/\buvwq[XY]\.[rgba]\b/))alert("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");else if(S.fragmentShader=[u,bt(),Dt(),Tt(),e,n,i,Wt(),Qt(),Bi(),o,t,vt()].join(" "),S.needsUpdate=!0,bn=k.domainViaIndicatorFun||"dirichlet"==k.boundaryConditionsU||"dirichlet"==k.boundaryConditionsV||"dirichlet"==k.boundaryConditionsW||"dirichlet"==k.boundaryConditionsQ||/Dirichlet/.test(k.comboStrU)||/Dirichlet/.test(k.comboStrV)||/Dirichlet/.test(k.comboStrW)||/Dirichlet/.test(k.comboStrQ),bn){if(t=u+Et(),k.domainViaIndicatorFun){let e=yt().replace(/indicatorFun/g,Gi(k.domainIndicatorFun)).replace(/updated/g,"gl_FragColor");l.forEach((function(n,i){t+=oo(e,li[i])+Gi(n)+";\n}\n"}))}else a.forEach((function(e,n){"dirichlet"==e?(t+=Xi(l[n],li[n]),t+=Ra(n)):"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=Xi(e[2],li[n],i),t+=Ra(n,i)}))}));t+="}",w.fragmentShader=t,w.needsUpdate=!0}}function Hi(e,n,t){return null==t?["L","R","T","B"].map((t=>Hi(e,n,t))).join(""):"float robinRHS"+n+t+" = "+Gi(e)+";\n"}function Xi(e,n,t){return null==t?["L","R","T","B"].map((t=>Xi(e,n,t))).join(""):"float dirichletRHS"+n+t+" = "+Gi(e)+";\n"}function Yi(e){Zi("default"),Zi(e),null!=k.threeD&&(k.threeD&&(k.dimension=2,k.plotType="surface"),delete k.threeD),null!=k.oneDimensional&&(k.oneDimensional&&(k.dimension=1,k.plotType="line"),delete k.oneDimensional),k.domainScale*=Nn,function(){if(0==k.views.length){let e=Wa();e.name="1",k.views.push(e)}else k.views=k.views.map((function(e){let n=Wa();return Object.assign(n,e),n}));wn=k.views}(),eo(M,!0),eo(q,!0),eo(O,!0),Di(),k.activeViewInd<k.views.length?xa(k.views[k.activeViewInd],!1):xa({},!0),wo(),xi(),wi(),Vi(),a.background=new Ht.Color(k.backgroundColour),""!=k.initialState?fetch(k.initialState).then((e=>e.blob())).then((e=>ya(e))):Oi(),Ci(),dn.remove(),fn.remove(),fo(),Go()}function Zi(e){let n;if(n=null==e?Bt(k.preset):"string"==typeof e?Bt(e):"object"==typeof e?e:Bt("default"),n.hasOwnProperty("parent")&&null!=n.parent&&Zi(n.parent),qn=0,Ln=[],In={},Object.assign(k,n),ua(!0),pn=k.runningOnLoad,pn?qi():Mi(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?k.tryClickingText=k.tryClickingText.replaceAll("clicking","tapping"):k.tryClickingText=k.tryClickingText.replaceAll("tapping","clicking"),k.brushRadius=k.brushRadius.toString(),k.hasOwnProperty("drawIn3D")&&(k.brushEnabled=k.drawIn3D),li.includes("T")||Object.keys(k).forEach((function(e){pi.includes(e)&&(k[e]=da(k[e],["T"],["I_T"],"[RGBA]"))})),!li.includes("S")){Object.keys(k).forEach((function(e){pi.includes(e)&&(k[e]=da(k[e],["S"],["I_S"],"[RGBA]"))}));var t=0;t+=k.hasOwnProperty("algebraicV"),t+=k.hasOwnProperty("algebraicW"),(t+=k.hasOwnProperty("algebraicQ"))&&!k.numAlgebraicSpecies&&(k.numAlgebraicSpecies=t),delete k.algebraicV,delete k.algebraicW,delete k.algebraicQ,L=k}let i=[k.clearValueU,k.clearValueV,k.clearValueW,k.clearValueQ,k.domainIndicatorFun,k.reactionStrU,k.reactionStrV,k.reactionStrW,k.reactionStrQ,k.diffusionStrUU,k.diffusionStrUV,k.diffusionStrUW,k.diffusionStrUQ,k.diffusionStrVU,k.diffusionStrVV,k.diffusionStrVW,k.diffusionStrVQ,k.diffusionStrWU,k.diffusionStrWV,k.diffusionStrWW,k.diffusionStrWQ,k.diffusionStrQU,k.diffusionStrQV,k.diffusionStrQW,k.diffusionStrQQ,k.dirichletStrU,k.dirichletStrV,k.dirichletStrW,k.dirichletStrQ,k.robinStrU,k.robinStrV,k.robinStrW,k.robinStrQ,k.comboStrU,k.comboStrV,k.comboStrW,k.comboStrQ,k.neumannStrU,k.neumannStrV,k.neumannStrW,k.neumannStrQ,k.brushValue,k.whatToPlot].join(" ");k.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(i)}function Ki(e,n){if(null==n&&(n=!0),null!=e){for(let n in e.__folders)Ki(e.__folders[n],!1);for(let n=0;n<e.__controllers.length;n++)e.__controllers[n].updateDisplay()}n&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function eo(e,n){if(null!=e){for(let n in e.__folders)eo(e.__folders[n]),e.removeFolder(e.__folders[n]);for(let n=0;n<e.__controllers.length;n++)e.__controllers[n].remove();null!=n&&n&&(e.domElement.remove(),e.destroy())}}function no(e){null!=e&&(e.__li.style.display="none")}function to(e){null!=e&&(e.__li.style.display="")}function io(e,n,t){null!=e&&(e.name(n),null!=t&&e.title(t))}function oo(e,n){if(0==n.length)return"";let t=/\bSPECIES\b/g,i=ao(n);return e=e.replace(t,i),t=/\brobinRHSSPECIES/g,e=e.replace(t,"robinRHS"+n),t=/\bdirichletRHSSPECIES/g,e=e.replace(t,"dirichletRHS"+n)}function ao(e){return"rgba"[function(e){return li.indexOf(e)}(e)]}function ro(){"dirichlet"==k.boundaryConditionsU?to(ze):no(ze),"dirichlet"==k.boundaryConditionsV?to(Je):no(Je),"dirichlet"==k.boundaryConditionsW?to(He):no(He),"dirichlet"==k.boundaryConditionsQ?to(Xe):no(Xe),"neumann"==k.boundaryConditionsU?to(nn):no(nn),"neumann"==k.boundaryConditionsV?to(tn):no(tn),"neumann"==k.boundaryConditionsW?to(on):no(on),"neumann"==k.boundaryConditionsQ?to(an):no(an),"robin"==k.boundaryConditionsU?to(rn):no(rn),"robin"==k.boundaryConditionsV?to(sn):no(sn),"robin"==k.boundaryConditionsW?to(ln):no(ln),"robin"==k.boundaryConditionsQ?to(cn):no(cn),"combo"==k.boundaryConditionsU?to(Ye):no(Ye),"combo"==k.boundaryConditionsV?to(Ze):no(Ze),"combo"==k.boundaryConditionsW?to(Ke):no(Ke),"combo"==k.boundaryConditionsQ?to(en):no(en),k.domainViaIndicatorFun?(no(Oe),no(Be),no(je),no(Ge)):to(Oe)}function so(){N.seed.value=performance.now()%1e3}function lo(){let e=ia()+Jt();(k.clearValueU.includes("RAND")||k.clearValueV.includes("RAND")||k.clearValueW.includes("RAND")||k.clearValueQ.includes("RAND"))&&(e+=Rt()),e+="float u = "+Gi(k.clearValueU)+";\n",e+="float v = "+Gi(k.clearValueV)+";\n",e+="float w = "+Gi(k.clearValueW)+";\n",e+="float q = "+Gi(k.clearValueQ)+";\n",e+=zt(),y.fragmentShader=e,y.needsUpdate=!0}function co(){let e=new Image;e.src=dn.__image.src;let n=new Ht.Texture;n.image=e,e.onload=function(){n.needsUpdate=!0,N.imageSourceOne.value=n,k.resetOnImageLoad&&Oi()}}function uo(){let e=new Image;e.src=fn.__image.src;let n=new Ht.Texture;n.image=e,e.onload=function(){n.needsUpdate=!0,N.imageSourceTwo.value=n,k.resetOnImageLoad&&Oi()},n.dispose()}function fo(){B=un,dn=B.addImage(k,"imagePathOne").name("$I_S(x,y)$").onChange(co),fn=B.addImage(k,"imagePathTwo").name("$I_T(x,y)$").onChange(uo),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function mo(){"MAX"==k.whatToPlot?(V.fragmentShader=ft()+pt().replace(/indicatorFun/g,Gi(k.domainIndicatorFun))+mt(),V.needsUpdate=!0,k.minColourValue=0,k.maxColourValue=1,Vi(),no(xe),no(Ee),no(De),no(We),k.autoSetColourRange=!1,Ki(q)):(go(),to(xe),to(Ee),to(De),to(We)),Ao(),Lo(),Pi()}function po(e,n){return Object.fromEntries(Object.entries(e).filter((([e,t])=>JSON.stringify(n[e])!==JSON.stringify(t))))}function ho(){Bo();let e=1/0,n=-1/0;for(let t=0;t<Yn.length;t+=4)e=Math.min(e,Yn[t]),n=Math.max(n,Yn[t]);return[e,n]}function go(){let e=ia()+ut();e+=dt(),e=function(e){return e.replace(/FUN/g,Gi(k.whatToPlot))}(e),k.domainViaIndicatorFun&&(e+=pt().replace(/indicatorFun/g,Gi(k.domainIndicatorFun))),V.fragmentShader=e+mt(),V.needsUpdate=!0}function bo(){k.numAlgebraicSpecies=Math.min(parseInt(k.numAlgebraicSpecies),parseInt(k.numSpecies)-1),Jn=k.numAlgebraicSpecies>=k.numSpecies-1,Hn=k.numAlgebraicSpecies>=k.numSpecies-2,Xn=k.numAlgebraicSpecies>=k.numSpecies-3}function vo(){let e="function of "+li.slice(0,k.numSpecies).join(", ")+", x, y, t",n=e.replace(" "+li[1]+",",""),i=e.replace(" "+li[2]+",",""),o=e.replace(" "+li[3]+",","");switch(1==k.dimension&&(e=e.replace(" y,","")),k.crossDiffusion&&parseInt(k.numSpecies)>1?(Rn||ca(X,Array.from(Array(parseInt(k.numSpecies)).keys())),to(X)):no(X),k.numSpecies>1?to(Y):no(Y),no(ee),no(ie),no(oe),no(z),no(Le),no(Be),no(ne),no(ae),no(se),no(le),no(ce),no(J),no(Me),no(je),no(te),no(re),no(ue),no(de),no(fe),no(me),no(pe),no(H),no(qe),no(Ge),parseInt(k.numSpecies)){case 4:k.crossDiffusion?(to(te),to(re),to(ue),to(de),to(fe),to(me)):(no(ue),no(de),no(re),no(te),no(fe),no(me)),to(pe),to(H),to(qe),to(Ge);case 3:k.crossDiffusion?(to(ne),to(ae),to(se),to(le)):(no(ne),no(ae),no(se),no(le)),to(ce),to(J),to(Me),to(je);case 2:k.crossDiffusion?(to(ee),to(ie)):(no(ee),no(ie)),to(oe),to(z),to(Le),to(Be)}1==k.numSpecies?io(K,fi.D,e):k.crossDiffusion?(io(K,fi.Duu,e),io(ee,fi.Duv,e),io(ne,fi.Duw,e),io(te,fi.Duq,e),io(ie,fi.Dvu,e),io(oe,fi.Dvv,e),io(ae,fi.Dvw,e),io(re,fi.Dvq,e),io(se,fi.Dwu,e),io(le,fi.Dwv,e),io(ce,fi.Dww,e),io(ue,fi.Dwq,e),io(de,fi.Dqu,e),io(fe,fi.Dqv,e),io(me,fi.Dqw,e),io(pe,fi.Dqq,e)):(io(K,fi.Du,e),io(oe,fi.Dv,e),io(ce,fi.Dw,e),io(pe,fi.Dq,e)),io(G,fi.UFUN,e),io(z,fi.VFUN,e),io(J,fi.WFUN,e),io(H,fi.QFUN,e),Jn&&(io(ie,fi.Dvu,n),io(ae,fi.Dvw,n),io(re,fi.Dvq,n),io(z,fi.VFUN,n),no(oe)),Hn&&(io(se,fi.Dwu,o),io(le,fi.Dwv,o),io(ue,fi.Dwq,o),io(J,fi.WFUN,o),no(ce)),Xn&&(io(de,fi.Dqu,i),io(fe,fi.Dqv,i),io(me,fi.Dqw,i),io(H,fi.QFUN,i),no(pe)),io(Oe,fi.u),io(Be,fi.v),io(je,fi.w),io(Ge,fi.q),io(ze,fi.uD),io(Je,fi.vD),io(He,fi.wD),io(Xe,fi.qD),io(nn,fi.uN),io(tn,fi.vN),io(on,fi.wN),io(an,fi.qN),io(rn,fi.uN),io(sn,fi.vN),io(ln,fi.wN),io(cn,fi.qN),io(Ie,fi.uInit),io(Le,fi.vInit),io(Me,fi.wInit),io(qe,fi.qInit),k.domainViaIndicatorFun?to(Z):no(Z),ro(),"surface"==k.plotType?(no(_e),to(Ue),no(be),to(ve),to(Se),to(we),to(ye)):"line"==k.plotType?(no(_e),no(Ue),to(be),to(ve),no(Se),no(we),no(ye)):(to(_e),to(Ue),no(be),no(ve),no(Se),no(we),no(ye)),Ao(),No(),Lo(),$("#dataContainer").show(),"line"==k.plotType?(no(j),$(":root").css("--ui-button-outline","black")):(to(j),$(":root").css("--ui-button-outline","white")),t?no(Ce):to(Ce),zo()?to(Ve):no(Ve),ca(ge,li.slice(0,k.numSpecies)),Te.slider.style.setProperty("--value",k.embossShiny),Qe.slider.style.setProperty("--value",k.embossSmoothness),Ae.slider.style.setProperty("--value",k.embossAmbient),Pe.slider.style.setProperty("--value",k.embossDiffuse),Re.slider.style.setProperty("--value",k.embossSpecular),ke.slider.style.setProperty("--value",k.embossTheta),Ne.slider.style.setProperty("--value",k.embossPhi),$a(),Ki(M),Ki(q),Ki(O)}function So(){let e;switch(bo(),k.domainViaIndicatorFun&&(k.boundaryConditionsU="dirichlet",k.boundaryConditionsV="dirichlet",k.boundaryConditionsW="dirichlet",k.boundaryConditionsQ="dirichlet"),parseInt(k.numSpecies)){case 1:k.crossDiffusion=!1,k.whatToDraw=li[0],k.whatToPlot=li[0],k.diffusionStrUV="0",k.diffusionStrUW="0",k.diffusionStrUQ="0",k.diffusionStrVU="0",k.diffusionStrVV="0",k.diffusionStrVW="0",k.diffusionStrVQ="0",k.diffusionStrWU="0",k.diffusionStrWV="0",k.diffusionStrWW="0",k.diffusionStrWQ="0",k.diffusionStrQU="0",k.diffusionStrQV="0",k.diffusionStrQW="0",k.diffusionStrQQ="0",k.boundaryConditionsV="periodic",k.clearValueV="0",k.reactionStrV="0",k.boundaryConditionsW="periodic",k.clearValueW="0",k.reactionStrW="0",k.boundaryConditionsQ="periodic",k.clearValueQ="0",k.reactionStrQ="0",e=new RegExp("\\b("+ui[1]+")\\b"),e.test(k.reactionStrU)&&(k.reactionStrU="0");break;case 2:k.whatToDraw==li[2]|k.whatToDraw==li[3]&&(k.whatToDraw=li[0]),k.whatToPlot==li[2]|k.whatToPlot==li[3]&&(k.whatToPlot=li[0]),k.diffusionStrUW="0",k.diffusionStrUQ="0",k.diffusionStrVW="0",k.diffusionStrVQ="0",k.diffusionStrWU="0",k.diffusionStrWV="0",k.diffusionStrWW="0",k.diffusionStrWQ="0",k.diffusionStrQU="0",k.diffusionStrQV="0",k.diffusionStrQW="0",k.diffusionStrQQ="0",k.boundaryConditionsW="periodic",k.clearValueW="0",k.reactionStrW="0",k.boundaryConditionsQ="periodic",k.clearValueQ="0",k.reactionStrQ="0",e=new RegExp("\\b("+ui[2]+")\\b"),e.test(k.reactionStrU)&&(k.reactionStrU="0"),e.test(k.reactionStrV)&&(k.reactionStrV="0");break;case 3:k.whatToDraw==li[3]&&(k.whatToDraw=li[0]),k.whatToPlot==li[3]&&(k.whatToPlot=li[0]),k.diffusionStrUQ="0",k.diffusionStrVQ="0",k.diffusionStrWQ="0",k.diffusionStrQU="0",k.diffusionStrQV="0",k.diffusionStrQW="0",k.diffusionStrQQ="0",k.boundaryConditionsQ="periodic",k.clearValueQ="0",k.reactionStrQ="0",e=new RegExp("\\b("+ui[3]+")\\b"),e.test(k.reactionStrU)&&(k.reactionStrU="0"),e.test(k.reactionStrV)&&(k.reactionStrV="0"),e.test(k.reactionStrW)&&(k.reactionStrW="0")}switch(zn){case 3:k.diffusionStrVV="0";break;case 6:k.diffusionStrWW="0";break;case 7:k.diffusionStrVV="0",k.diffusionStrWW="0";break;case 10:k.diffusionStrQQ="0";break;case 11:k.diffusionStrWW="0",k.diffusionStrQQ="0";break;case 12:k.diffusionStrVV="0",k.diffusionStrWW="0",k.diffusionStrQQ="0"}Ki(M),Ki(q)}function wo(){!function(){switch(bo(),parseInt(k.numSpecies)){case 1:zn=0;break;case 2:zn=k.crossDiffusion?1==k.numAlgebraicSpecies?3:2:1;break;case 3:if(k.crossDiffusion)switch(k.numAlgebraicSpecies){case 0:zn=5;break;case 1:zn=6;break;case 2:zn=7}else zn=4;break;case 4:if(k.crossDiffusion)switch(k.numAlgebraicSpecies){case 0:zn=9;break;case 1:zn=10;break;case 2:zn=11;break;case 3:zn=12}else zn=8}}(),Yo(),Zo(),So(),vo(),function(){const e=na().split(";");let n=!1;for(const t of e)n|=ta(t)}(),oa(),yo(),Oi()}function yo(){let e,n=di[zn];const t={D:/\b(D) (\\vnabla u)/g,U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(k.typesetCustomEqs){let o={};o.D=k.diffusionStrUU,o.U=k.diffusionStrUU,o.UU=k.diffusionStrUU,o.V=k.diffusionStrVV,o.VV=k.diffusionStrVV,o.W=k.diffusionStrWW,o.WW=k.diffusionStrWW,o.Q=k.diffusionStrQQ,o.QQ=k.diffusionStrQQ,o.UV=k.diffusionStrUV,o.UW=k.diffusionStrUW,o.UQ=k.diffusionStrUQ,o.VU=k.diffusionStrVU,o.VW=k.diffusionStrVW,o.VQ=k.diffusionStrVQ,o.WU=k.diffusionStrWU,o.WV=k.diffusionStrWV,o.WQ=k.diffusionStrWQ,o.QU=k.diffusionStrQU,o.QV=k.diffusionStrQV,o.QW=k.diffusionStrQW,o.UFUN=k.reactionStrU,o.VFUN=k.reactionStrV,o.WFUN=k.reactionStrW,o.QFUN=k.reactionStrQ;var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!Fa(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=da(o[e],li,On,"_[xy]")})),Wn.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){Bn.includes(e)||(n=function(e,n,t,i){let o=t.replace(/\s+/g,"  ").trim();if("0"==o||"0.0"==o)return e.replaceAll(n,"");if("1"==o||"1.0"==o)return e.replaceAll(n,"$2");if("-1"==o||"-1.0"==o)return e.replaceAll(n,"-$2");if(t.match(/[a-zA-Z]/))return t.match(/[\+-]/)&&null!=i?e.replaceAll(n,i[0]+t+i[1]+"$2"):e.replaceAll(n,t+"$2");return e}(n,t[e],o[e],"[]"))})),n=Xo(n,t.UFUN,o.UFUN),n=Xo(n,t.VFUN,o.VFUN),n=Xo(n,t.WFUN,o.WFUN),n=Xo(n,t.QFUN,o.QFUN),e=/\(\s*\+/g;n!=(n=n.replace(e,"(")););for(e=/\[\s*\+/g;n!=(n=n.replace(e,"[")););for(e=/\+\s*\)/g;n!=(n=n.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,n=n.replaceAll(e,""),e=/=\s*\+/g,n=n.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,n=n.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,n=n.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,n=n.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\((D_\{\w+(?: \w+)?\})\s*\\vnabla\s*([uvwq])\s*\)/g,n=n.replaceAll(e,"$1 \\lap $2"),e=/\\vnabla\s*\\cdot\s*\(([\w\{\}\*\^]*)\s*\\vnabla\s*([uvwq])\s*\)/g,n=n.replaceAll(e,(function(e,n,t){return/\b[xy]|[uvwq]\b/g.test(n)?e:n+" \\lap "+t})),e=/\b([uvwq])_([xy])\b/g,n=n.replaceAll(e,"\\textstyle \\pd{$1}{$2}"),e=/\b([uvwq])_(xx|yy)\b/g,n=n.replaceAll(e,(function(e,n,t){return"\\textstyle \\pdd{"+n+"}{"+t[0]+"}"}))}else Wn.forEach((function(e){n=n.replaceAll(t[e],(function(e,n,t){let i="\\selected{ "+n+" ";return"string"==typeof t&&(i+=t),i+" }"}))})),n=da(n,["UFUN","VFUN","WFUN","QFUN"],ci,"_[xy]");1==k.dimension&&(n=n.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,n=n.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,n=n.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),n=da(n,On.concat(Bn),li.concat(ci),"_[xy]"),n=Co(n),$("#typeset_equation").html(n),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(ra)}function Co(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Vo(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Vo(e,"cos",!0),e=Vo(e,"tan",!0),e=Vo(e,"exp",!0),e=Vo(e,"log",!0),e=Vo(e,"sqrt",!1),e=Vo(e,"sinh",!0),e=Vo(e,"cosh",!0),e=Vo(e,"tanh",!0),e=Vo(e,"max",!0),e=zi(e=(e=Vo(e,"min",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=function(e){const n=["(","["],t=[")","]"];let i=0,o=0,a=0,r="",s="";for(var l=0;l<e.length;l++)n.includes(e[l])?(i+=1,o+=1):t.includes(e[l])&&(i-=1),0==i&&o>0&&(r=e.slice(a,l+1),s+=Uo(r,o),o=0,a=l+1);return s+=e.slice(a),s}(e=si(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")}function Vo(e,n,t){var i=e;const o=e.matchAll(new RegExp("\\b"+n+"\\b","g"));let a,r,s,l,c,u,d,f=0;for(const m of o){for(a=m.index,r=a+n.length,l=e.slice(r),d=0,c=0,u=!1;d<=l.length&(!u|!(u&&0==c));)c+=["(","["].includes(l[d]),c-=[")","]"].includes(l[d]),u|=c,d+=1;u&&0==c&&(s=d-1+r,i=$o(i,"\\",a+f),f+=1,t?(i=$o(i,"{",r+f),f+=1,i=$o(i,"}",s+1+f),f+=1):(i=Fo(i,"{",r+f),i=Fo(i,"}",s+f)))}return i}function Uo(e,n){const t=["(","["],i=[")","]"];let o=_o(1-n,t.length);for(var a=0;a<e.length;a++)t.includes(e[a])?(e=Fo(e,t[o],a),o+=1,o=_o(o,t.length)):i.includes(e[a])&&(o-=1,o=_o(o,t.length),e=Fo(e,i[o],a));return e}function _o(e,n){return(e%n+n)%n}function Fo(e,n,t){return e.slice(0,t)+n+e.slice(t+1,e.length)}function $o(e,n,t){return e.slice(0,t)+n+e.slice(t,e.length)}function xo(e){return e=e.replace(/\s+/g,"  ").trim()}function Eo(e,n){let t;function i(){t.hasOwnProperty("slider")&&(t.slider.remove(),delete t.slider,t.domElement.closest("li").classList.remove("parameterSlider"));let n=In[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(n){let i;t.domElement.parentElement.parentElement.classList.add("parameterSlider"),t.slider=document.createElement("input"),t.slider.classList.add("styled-slider"),t.slider.classList.add("slider-progress"),t.slider.type="range",t.slider.min=n[3],t.slider.max=n[5],null==n[4]?(n[4]="",!In[e].includes(".")&parseFloat(n[5])-parseFloat(n[3])>1?i=1:(t.slider.precision=Math.max(parseFloat(n[2]).countDecimals(),parseFloat(n[3]).countDecimals(),parseFloat(n[5]).countDecimals())+1,i=Math.min((parseFloat(n[5])-parseFloat(n[3]))/20,10**-t.slider.precision))):(t.slider.precision=Math.max(parseFloat(n[2]).countDecimals(),parseFloat(n[3]).countDecimals(),parseFloat(n[4]).countDecimals(),parseFloat(n[5]).countDecimals())+1,i=n[4],n[4]+=", "),t.slider.step=i.toString(),t.slider.value=n[2],t.slider.addEventListener("input",(function(){t.slider.style.setProperty("--value",t.slider.value);In[e]=In[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,n[1]+" = "+parseFloat(t.slider.value).toFixed(t.slider.precision).toString()+" "),Ki(En),Do(),Pi(),(ta(In[e])||Qn)&&(Qn=!1,oa())})),t.__oldOnFinishChange=t.onFinishChange,t.onFinishChange=function(){t.__oldOnFinishChange(),t.slider.value=n[2]},t.slider.style.setProperty("--value",t.slider.value),t.slider.style.setProperty("--min",t.slider.min),t.slider.style.setProperty("--max",t.slider.max),t.domElement.appendChild(t.slider)}}if(n)Ln.push(e),In[e]="",t=En.add(In,e).name(""),t.domElement.classList.add("params"),t.onFinishChange((function(){const n=Ln.indexOf(e);let t=xo(In[Ln.at(n)]);if(""==t);else{let e=Eo(Ln.at(n),!1);const i=t.match(/\s*(\w+)\s*=/);i&&(e.lastName=i[1],Mn[e.lastName]=e),qn+=1;let o="params"+qn;this.remove(),Eo(o,!0),Do(),(ta(t)||Qn)&&(Qn=!1,oa())}}));else{t=En.add(In,e).name(""),t.domElement.classList.add("params");const n=In[e].match(/\s*(\w+)\s*=/);n&&(t.lastName=n[1],Mn[t.lastName]=t),t.onFinishChange((function(){let n=xo(In[e]);if(""==n){t.domElement.closest("li").hasOwnProperty("parameterSlider")&&(t.slider.remove(),t.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const n=Ln.indexOf(e);Ln.splice(n,1),delete In[e],t.hasOwnProperty("lastName")&&delete N[t.lastName]}else{i();const e=aa(n).match(/\s*(\w+)\s*=/);e&&t.hasOwnProperty("lastName")&&t.lastName!=e[1]&&(delete N[t.lastName],t.lastName=e[1],Mn[t.lastName]=t)}Do(),ta(n)&&oa()}))}return i(),t}function Do(){k.kineticParams=Object.values(In).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function Wo(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function To(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function Qo(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function Ao(){if(k.colourbar){$("#colourbar").show();let n="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)n+="rgb("+fa(e).map((e=>255*e))+") "+100*e+"%,";n=n.slice(0,-1)+")",$("#colourbar").css("background",n),"MAX"==k.whatToPlot?($("#minLabel").html("$"+li[0]+"$"),$("#midLabel").html("$"+li[1]+"$"),$("#maxLabel").html("$"+li[2]+"$")):$("#midLabel").html("$"+Co(k.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),ea(),Po()}else $("#colourbar").hide()}function Po(){if("MAX"!=k.whatToPlot){let e,n;[e,n]=function(e,n){const t=3;if(Math.abs(e)<.001&&Math.abs(n)<.001)return[e.toExponential(t-1),n.toExponential(t-1)];return[ko(e,t),ko(n,t)]}(k.minColourValue,k.maxColourValue);const t=/[1-9]/;t.test(e)||(e="0"),t.test(n)||(n="0"),$("#minLabel").html(e),$("#maxLabel").html(n)}let e=sa(fa(0)),n=sa(fa(.5)),t=sa(fa(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),n<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),t<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function Ro(e,n){return e.toPrecision(n)}function ko(e,n){const t=e.toFixed(n),i=e.toPrecision(n);return t.length<i.length?t:i}function No(){k.timeDisplay?($("#timeDisplay").show(),Io()):$("#timeDisplay").hide(),qo()}function Io(){if(k.timeDisplay){let e=Ro(N.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/,"  10<sup>$2$3<sup>"),$("#timeValue").html(e),jo()}}function Lo(){if(k.integrate){$("#integralDisplay").show();let e="";1==k.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+Co(k.whatToPlot)+"\\,\\d x",1==k.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();qo()}function Mo(e,n){$(e).css("bottom",""),$(e).css("bottom","+="+n.toString())}function qo(){k.integrate&&k.timeDisplay?Mo("#timeDisplay",10):Mo("#timeDisplay",0)}function Oo(){let e=ho();isFinite(e[0])&&isFinite(e[1])?vn=setTimeout(Oo,1e3):(To("#oops_hit_nan"),$("#erase").one("click",(()=>Qo("#oops_hit_nan"))))}function Bo(){if(!et){try{s.readRenderTargetPixels(f,0,0,Cn,Vn,Yn)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}et=!0}}function jo(){if(k.colourbar&&k.integrate|k.timeDisplay){let e,n=$("#colourbar")[0].getBoundingClientRect();e=k.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let t=e.getBoundingClientRect();n.right>=t.left?n.top<=t.bottom&&(Mo("#dataContainer",40),Tn=!0):Tn&&(Mo("#dataContainer",0),Tn=!1)}}function Go(){zo()?(Dn[0].texture.magFilter=Ht.NearestFilter,Dn[1].texture.magFilter=Ht.NearestFilter,f.texture.magFilter=Ht.NearestFilter,m.texture.magFilter=Ht.NearestFilter):(Dn[0].texture.magFilter=Ht.LinearFilter,Dn[1].texture.magFilter=Ht.LinearFilter,f.texture.magFilter=Ht.LinearFilter,m.texture.magFilter=Ht.LinearFilter),vo()}function zo(){return t||k.forceManualInterpolation}function Jo(e,n,t){return new Promise((function(i,o){var a=o=>{e.removeEventListener(n,a),i(t)};e.addEventListener(n,a)}))}function Ho(e,n){return null==n&&(n=[]),function(e){return[...(bt()+_t()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e)}(n).some((function(n){return new RegExp("\\b"+n+"\\b","g").test(e)}))}function Xo(e,n,t){return"0"==t.replace(/\s+/g,"  ").trim()?e.replaceAll(n,""):t.match(/[a-zA-Z]/)?e.replaceAll(n,t):e}function Yo(){"line"==k.plotType?(pa(),k.typeOfBrush="vline",Ti(),Ki(q),x.visible=!1,W.visible=!0,k.contours=!1,k.emboss=!1):(x.visible=!0,W.visible=!1,"surface"==k.plotType?(k.contours=!1,$("#simCanvas").css("outline","2px #000 solid"),kn&&(kn=!1,yi())):$("#simCanvas").css("outline","")),Qi(),Ci(),vo()}function Zo(){1!=k.dimension&&"line"==k.plotType&&(k.plotType="plane",Yo()),1==k.dimension&&"line"!=k.plotType&&(k.plotType="line",Yo()),wi(),Ji(),yo(),vo(),Lo()}function Ko(){const e=(new Ht.Vector3).setFromSphericalCoords(1,Math.PI/2-k.cameraTheta*Math.PI/180,k.cameraPhi*Math.PI/180);i.position.set(e.x,e.y,e.z),i.lookAt(0,0,0)}function ea(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function na(){let e=k.kineticParams.replaceAll(/\bin[^;]*;?/g,";");return e=aa(e),e}function ta(e){const n=e.match(/(\w+)\s*=\s*([\+\-]?)\s*([0-9\.]+)/);let t=!1;return n&&(n[1]=aa(n[1]),Ho(n[1])?alert("The name '"+n[1]+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+n[1]+"."):(t=!N.hasOwnProperty(n[1]),N[n[1]]={type:"float",value:parseFloat(n[2]+n[3])})),t}function ia(){return aa(na().replaceAll(/;?\s*(\w+)\s*=\s*[\+\-]?\s*([0-9\.]+)\s*;?/g,"uniform float $1;\n"))}function oa(){Ji(),lo(),Ti(),mo(),Wi(),go()}function aa(e){let n,t=e;for(let e=0;e<10;e++)for(n=new RegExp("([a-zA-Z_]+)("+e.toString()+")","g");t!=(t=t.replace(n,"$1"+nt[e])););return t}function ra(){const e=$("#equation_display div mjx-container").children("mjx-math");var n;e.css("font-size","");var t=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);t<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)n=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",n),t+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function sa(e){return e.reduce(((e,n)=>e+n),0)/3}function la(){let e=ho();if(Math.abs(e[0]-e[1])<.005){const n=(e[0]+e[1])/2;e[0]=n-.0025,e[1]=n+.0025}k.minColourValue=e[0],k.maxColourValue=e[1],N.maxColourValue.value=k.maxColourValue,N.minColourValue.value=k.minColourValue,Ee.updateDisplay(),xe.updateDisplay(),Po()}function ca(e,n,t){null==t&&(t=n);let i="";for(var o=0;o<n.length;o++){i+="<option value='"+t[o].toString()+"'>"+n[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function ua(e){let n;null!=li&&(n=li);const t=k.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,On.length),i=k.reactionNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,Bn.length),o=t.concat(jn.slice(t.length)),a=i.concat(Gn.slice(i.length)),r=function(){const e=/(\w+)\s*=\s*([\+\-]?)\s*([0-9\.]+)/;return na().split(";").filter((e=>e.length>0)).map((n=>n.replace(e,"$1").trim()))}();let s;for(var l=0;l<o.length;l++)if(Ho(o[l],r.concat(a)))return s=r.includes(o[l])?"as a parameter":a.includes(o[l])?"as a reaction":"under the hood",void alert("The name '"+o[l]+"' is used "+s+", so can't be used as a species name. Please use a different name for "+o[l]+".");for(l=0;l<a.length;l++)if(Ho(a[l],r.concat(o[l])))return s=r.includes(a[l])?"as a parameter":o.includes(a[l])?"as a reaction":"under the hood",void alert("The name '"+a[l]+"' is used "+s+", so can't be used as a function name. Please use a different name for "+a[l]+".");li=o,ci=a,function(){ui=[];for(let e=0;e<li.length;e++)ui.push("(?:"+li.slice(e).sort(((e,n)=>n.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let c={...oi(),...ri()};Object.keys(c).forEach((function(e){fi[e]=Co(da(c[e],On,li,"_[xy]"))})),c=ai(),Object.keys(c).forEach((function(e){fi[e]=Co(da(c[e],Bn,ci))})),e||(Object.keys(k).forEach((function(e){pi.includes(e)&&(k[e]=da(k[e],n,li,"_[xy]"))})),k.views=k.views.map((function(e){let t={};return t.name=e.name,Object.keys(e).forEach((function(i){pi.includes(i)&&(t[i]=da(e[i],n,li,"_[xy]"))})),t})),Object.keys(L).forEach((function(e){pi.includes(e)&&(L[e]=da(L[e],n,li,"_[xy]"))})),L.views=L.views.map((function(e){let t={};return t.name=e.name,Object.keys(e).forEach((function(i){pi.includes(i)&&(t[i]=da(e[i],n,li,"_[xy]"))})),t})),So(),vo(),oa(),yo())}function da(e,n,t,i){null==i&&(i="");const o=new Array(n.length).fill(0).map(((e,n)=>"PLACE"+n.toString()));let a;for(var r=0;r<n.length;r++)a=new RegExp("\\b("+n[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,t[r]+"$2");return e}function fa(e){e=e.clamp(0,1);let n=0;for(;e>=R[n+1]&&n<P.length-2;)n+=1;return R[n+1]==R[n]?P[n]:function(e,n,t){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=ma(e[o],n[o],t);return i}(P[n],P[n+1],(e-R[n])/(R[n+1]-R[n])).map((e=>e.clamp(0,1)))}function ma(e,n,t){return(1-t)*e+t*n}function pa(){U.linewidth=.01*k.lineWidthMul,U.needsUpdate=!0}function ha(e,n,t){e.domElement.firstChild.onfocus=()=>n(t)}function ga(e,n,t){e.domElement.firstChild.onblur=()=>n(t)}function ba(e){e.forEach((function(e){Wn.add(e)})),yo()}function va(e){e.forEach((function(e){Wn.delete(e)})),yo()}function Sa(){Zn=new Float32Array(Cn*Vn*4),s.readRenderTargetPixels(Dn[1],0,0,Cn,Vn,Zn),Va(Zn),Pn=!0}function wa(){Pn||Sa();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([Cn,Vn]),Zn])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function ya(e){const n=new FileReader;n.onload=function(){const e=new Float32Array(n.result);Va(e.slice(2),e.slice(0,2)),Ca(h),Pn=!0,Oi()},n.readAsArrayBuffer(e)}function Ca(e){if(null!=e)if("crop"==k.resizeCheckpoints){let n=e.source.data.height/e.source.data.width,t=1,i=l/n;i>1&&(t=n/l,i=1),e.repeat.set(t,i),e.offset.set((1-t)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function Va(e,n){null!=h&&h.dispose(),null==n&&(n=[Cn,Vn]),h=new Ht.DataTexture(e,n[0],n[1],Ht.RGBAFormat,Ht.FloatType),h.needsUpdate=!0,h.magFilter=t?Ht.NearestFilter:Ht.LinearFilter,null!=F&&(F.map=h,F.needsUpdate)}function Ua(){s.setSize(Math.round(devicePixelRatio*$n),Math.round(devicePixelRatio*xn),!1)}function _a(e){$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),To("#error"),$("#error").one("click",(function(){Qo("#error")})))}function Fa(e){if(/\(\s*\)/.test(e))return _a("Empty parentheses in "+e.trim()+"."),!1;let n=0;for(var t=0;t<e.length;t++)"("==e[t]?n+=1:")"==e[t]&&(n-=1);return 0!=n?(_a("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(_a("A binary operator is missing an operand in "+e.trim()+"."),!1)}function $a(){let e;$("#views_list").empty();for(let n=0;n<k.views.length;n++)e=document.createElement("a"),e.onclick=function(){k.activeViewInd=n,xa(k.views[n])},e.innerHTML="<div class='view_label'>"+k.views[n].name+"</div>",n==k.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);k.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),k.views.length}function xa(e,n){Object.assign(k,e),delete k.name,Ki(O),(null==n||n)&&(mo(),Yo(),Qi(),Vi(),Po(),Ao(),Pi())}function Ea(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",k.views[k.activeViewInd].name);null!=e&&(k.views[k.activeViewInd].name=e,$a(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function Da(){k.views.length>1?(k.views.splice(k.activeViewInd,1),k.activeViewInd<1?k.activeViewInd=0:k.activeViewInd-=1):k.views[k.activeViewInd].name="Custom",$a()}function Wa(){let e={};return mi.forEach((function(n){e[n]=L[n]})),e}function Ta(e){k.activeViewInd<k.views.length&&(k.views[k.activeViewInd][e]=k[e])}function Qa(e,n){let t="";return t+=oo(Ct(n),li[e]),k.dimension>1&&(t+=oo(Vt(n),li[e])),t}function Aa(e,n){let t="";return t+=oo(St(n),li[e]),k.dimension>1&&(t+=oo(wt(n),li[e])),t}function Pa(e,n){let t="";return t+=oo(Ct(n),li[e]),k.dimension>1&&(t+=oo(Vt(n),li[e])),t}function Ra(e,n){let t="";return t+=oo(St(n).replaceAll(/updated/g,"gl_FragColor"),li[e]),k.dimension>1&&(t+=oo(wt(n).replaceAll(/updated/g,"gl_FragColor"),li[e])),t}function ka(e,n,t,i,o){const a=document.createElement("a");null!=t&&(a.onclick=t),null!=i&&(a.id=i),null!=o&&(a.title=o),null!=n&&(a.innerHTML=n),e.appendChild(a)}function Na(){let e=po(k,Bt("default"));e.preset="PRESETNAME";let n=JSON.stringify(e).replaceAll(/\s*,\s*([^0-9-\.\s])/g,",\n\t$1").replaceAll(":",": ").replaceAll("  "," ").replace("{","{\n\t").replace("}",",\n}");n='case "PRESETNAME":\n\toptions = '+n+";\nbreak;",navigator.clipboard.writeText(n)}function Ia(){let n="";n+=JSON.stringify(k),n+=JSON.stringify(N),n+=JSON.stringify({nXDisc:Cn,nYDisc:Vn,domainHeight:_n,domainWidth:Un,aspectRatio:l,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(n)}function La(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function Ma(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function qa(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function Oa(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function Ba(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function ja(){let e=po(k,Bt("default"));return e.preset="Custom",e=ei(e),[location.href.replace(location.search,""),"?options=",ti.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function Ga(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function za(e){const n=Mn[e.data.name];if(null!=n)if(null!=n.slider)n.slider.value=e.data.value,n.slider.dispatchEvent(new Event("input"));else{const t=n.object[n.property].split("=")[0]+"= "+e.data.value.toString();n.setValue(t),n.__onFinishChange(n,t)}}function Ja(){N.embossAmbient.value=k.embossAmbient,N.embossDiffuse.value=k.embossDiffuse,N.embossShiny.value=k.embossShiny,N.embossSmoothness.value=k.embossSmoothness,N.embossSpecular.value=k.embossSpecular,N.embossLightDir.value=new Ht.Vector3(Math.sin(k.embossTheta)*Math.cos(k.embossPhi),Math.sin(k.embossTheta)*Math.sin(k.embossPhi),Math.cos(k.embossTheta))}function Ha(e,n,t,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=n,e.slider.max=t,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))})),null!=e.__onChange&&(e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function Xa(){N.contourColour.value=new Ht.Color(k.contourColour),N.contourEpsilon.value=k.contourEpsilon,N.contourStep.value=1/(k.contourNum+1)}function Ya(){pn||Pi()}vi&&Yi("GrayScott"),(Wo()||vi||k.forceTryClickingPopup)&&!k.suppressTryClickingPopup&&k.brushEnabled&&($("#top_message").html("<p>"+k.tryClickingText+"</p>"),To("#top_message"),setTimeout((()=>Qo("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>Qo("#top_message")))),$("#settings").click((function(){La(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&Oa(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&Ba(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&Ma(),$("#views_ui").is(":visible")&&qa()),$("#left_ui").is(":visible")&&ra()})),$("#equations").click((function(){Ma(),ra(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&La(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&qa()})),$("#pause").click((function(){Mi()})),$("#play").click((function(){qi()})),$("#erase").click((function(){Oi()})),$("#warning_restart").click((function(){$("#oops_hit_nan").hide(),Oi()})),$("#share").click((function(){Ba(),$("#help_panel").is(":visible")&&Oa()})),$("#help").click((function(){Oa(),$("#share_panel").is(":visible")&&Ba()})),$("#screenshot").click((function(){Kn=!0,Pi(),Ba()})),$("#link").click((function(){I.copyConfigAsURL(),Ba()})),$("#embed").click((function(){!function(){let e=ja();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&no_ui"}Ga('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0" loading="lazy"></iframe>')}(),Ba()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){Oa()})),$("#views").click((function(){qa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&La(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&Ma()})),$(document).on("click","#add_view",(function(){!function(){let e=Wa();e.name=k.views.length+1,k.views.push(e),k.activeViewInd=k.views.length-1,$a()}()})),function e(){requestAnimationFrame(e),gn=hn,hn&&k.brushEnabled&&function(){!k.fixRandSeed&&k.brushValue.includes("RAND")&&so();E.material=v;for(let e=1;e<Dn.length;e++)N.textureSource.value=Dn[e].texture,s.setRenderTarget(Dn[e-1]),s.render(r,o);Dn.rotate(-1)}();if(pn){!bn||function(){E.material=w;for(let e=1;e<Dn.length;e++)N.textureSource.value=Dn[e].texture,s.setRenderTarget(Dn[e-1]),s.render(r,o);Dn.rotate(-1)}();for(let e=0;e<k.numTimestepsPerFrame;e++)Ai(),N.t.value+=k.dt}(gn||pn)&&Pi()}();