import{drawShaderTop,drawShaderBotReplace,drawShaderBotAdd,drawShaderShapeDisc,drawShaderShapeVLine,drawShaderShapeHLine,drawShaderFactorSharp,drawShaderFactorSmooth}from"./drawing_shaders.js";import{computeDisplayFunShaderTop,computeDisplayFunShaderMid,postGenericShaderBot,postShaderDomainIndicator,interpolationShader}from"./post_shaders.js";import{copyShader}from"../copy_shader.js";import{RDShaderTop,RDShaderBot,RDShaderDirichletX,RDShaderDirichletY,RDShaderDirichletIndicatorFun,RDShaderRobinX,RDShaderRobinY,RDShaderRobinCustomDomainX,RDShaderRobinCustomDomainY,RDShaderUpdateNormal,RDShaderUpdateCross,RDShaderAlgebraicSpecies,RDShaderEnforceDirichletTop,RDShaderAdvectionPreBC,RDShaderAdvectionPostBC,RDShaderDiffusionPreBC,RDShaderDiffusionPostBC,RDShaderGhostX,RDShaderGhostY,RDShaderMain}from"./simulation_shaders.js";import{randShader,randNShader}from"../rand_shader.js";import{fiveColourDisplayTop,fiveColourDisplayBot,embossShader,contourShader,surfaceVertexShaderColour,surfaceVertexShaderCustom,overlayShader}from"./display_shaders.js";import{getColours}from"../colourmaps.js";import{genericVertexShader}from"../generic_shaders.js";import{getPreset,getUserTextFields,getFieldsInView,getListOfPresets,getOldPresetFieldsToNew}from"./presets.js";import{clearShaderBot,clearShaderTop}from"./clear_shader.js";import*as THREE from"../three.module.min.js";import{OrbitControls}from"../OrbitControls.js";import{Line2}from"../lines/Line2.js";import{LineMaterial}from"../lines/LineMaterial.js";import{LineGeometry}from"../lines/LineGeometry.js";import{minifyPreset,maxifyPreset}from"./minify_preset.js";import{LZString}from"../lz-string.min.js";import{equationTEXFun,getDefaultTeXLabelsDiffusion,getDefaultTeXLabelsReaction,getDefaultTeXLabelsBCsICs,substituteGreek}from"./TEX.js";!async function(){let e,t,n,i,o,a,r,s,l,u,c,d,h,f,m,p,g,b,v,S,w,_,y,C,E,D,T,x,R,F,A,V,P,U,M,k,q,I,L,N,B,H,O,W,j,Q,G,X,z,Y,J,Z,K,ee,te,ne,ie,oe,ae,re,se,le,ue,ce,de,he,fe,me,pe,ge,be,ve,Se,we=[],_e={},ye=[],Ce=[],Ee=[],De=new Set,Te=!0,xe=!1,Re=!0,Fe=!0,$e=!1,Ae=!1,Ve=!1,Pe=!1,Ue=!1,Me=!1,ke=0,qe=performance.now(),Ie=!1,Le=!0,Ne=1,Be=1,He=.15,Oe={},We=[],je={},Qe=0;const Ge=["u","v","w","q"],Xe=["UFUN","VFUN","WFUN","QFUN"],ze=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"];let Ye,Je,Ze,Ke,et,tt,nt,it=!1,ot=!1;const at=["zero","one","two","three","four","five","six","seven","eight","nine"];let rt,st,lt,ut=equationTEXFun(),ct={...getDefaultTeXLabelsDiffusion(),...getDefaultTeXLabelsReaction(),...getDefaultTeXLabelsBCsICs()};const dt=getFieldsInView();let ht=new exprEval.Parser;ht.consts.pi=Math.PI,ht.consts.Pi=Math.PI,ht.consts.e=Math.exp(1),H={};const ft=getUserTextFields();var mt,pt;W={reset:function(){Ht()},toggleRunning:function(){ie?Nt():Bt()},copyConfigAsURL:function(){Ji(Yi())},saveSimState:function(){_i()},exportSimState:function(){yi()},clearCheckpoints:function(){Me&&(p.dispose(),p=null,Me=!1)}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(mt=Array.prototype.push,pt=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,mt.apply(this,pt.call(this,0,e)),this}),e=document.getElementById("simCanvas"),console.error=function(e){Pe=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),xi(t.toString().trim()+". Click <a href='/user-guide/FAQ#undeclared' target='blank'>here</a> for more information.")},Rn()||$("#logo").hide();const gt=new URLSearchParams(window.location.search);if(gt.has("no_ui")?($(".ui").addClass("hidden"),Ue=!0):$(".ui").removeClass("hidden"),gt.has("logo_only")&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),Ue=!0),gt.has("sf")&&(Be=parseFloat(gt.get("sf")),(isNaN(Be)||Be<=0)&&(Be=1)),!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("warning"==e[t].split("=")[0].trim())return!0}return!1}()&&!Ue){$("#warning").css("display","block");await Promise.race([jn(document.getElementById("warning_ok"),"click",!0),jn(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="warning=true;"+t+";path=/"}(),$("#warning").css("display","none")}Jt("default"),function(){O={brushCoords:{type:"v2",value:new THREE.Vector2(.5,.5)},colour1:{type:"v4",value:new THREE.Vector4(0,0,0,0)},colour2:{type:"v4",value:new THREE.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new THREE.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new THREE.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new THREE.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},overlayLine:{type:"bool",value:!0},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},vectorField:{type:"bool",value:!1}},oe=!1,c=new THREE.Raycaster,d=new THREE.Vector2,s=new THREE.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),s.autoClear=!0,t=s.getContext(),ge=t.getParameter(t.MAX_TEXTURE_SIZE),n=!(t.getExtension("OES_texture_float_linear")&&t.getExtension("EXT_float_blend")),m={format:THREE.RGBAFormat,type:THREE.FloatType,minFilter:THREE.NearestFilter},n|=/android/i.test(navigator.userAgent),m.magFilter=n?THREE.NearestFilter:THREE.LinearFilter,we.push(new THREE.WebGLRenderTarget(H.maxDisc,H.maxDisc,m)),we.push(we[0].clone()),we.push(we[0].clone()),we.push(we[0].clone()),we.push(we[0].clone()),h=we[0].clone(),f=we[0].clone(),we.forEach((e=>{e.texture.wrapS=THREE.RepeatWrapping,e.texture.wrapT=THREE.RepeatWrapping})),h.texture.wrapS=THREE.ClampToEdgeWrapping,h.texture.wrapT=THREE.ClampToEdgeWrapping,f.texture.wrapS=THREE.ClampToEdgeWrapping,f.texture.wrapT=THREE.ClampToEdgeWrapping,i=new THREE.OrthographicCamera(-.5,.5,.5,-.5,-1,10),u=new OrbitControls(i,e),u.listenToKeyEvents(document),u.addEventListener("change",(function(){"surface"==H.plotType&&(H.cameraTheta=90-180*Math.acos(i.position.y)/Math.PI,H.cameraPhi=-180*Math.atan2(i.position.x,i.position.z)/Math.PI,H.cameraZoom=i.zoom,Ui("cameraTheta"),Ui("cameraPhi"),Ui("cameraZoom"),Zt(X),oo())})),o=new THREE.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new THREE.Scene,r=new THREE.Scene,a.add(i),a.background=new THREE.Color(H.backgroundColour),g=new THREE.MeshBasicMaterial({side:THREE.DoubleSide}),b=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader(),transparent:!0,side:THREE.DoubleSide}),y=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader()}),T=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader(),fragmentShader:interpolationShader()}),v=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader()}),_e.FE=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader()}),_e.AB2=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader()});for(let e=1;e<3;e++)_e["Mid"+e.toString()]=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader()});for(let e=1;e<5;e++)_e["RK4"+e.toString()]=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader()});_=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader(),fragmentShader:copyShader()}),w=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader()}),S=new THREE.ShaderMaterial({uniforms:O,vertexShader:genericVertexShader()}),C=new LineMaterial({vertexColors:!0,linewidth:.01}),E=new LineMaterial({color:0,linewidth:.01}),D=new THREE.MeshBasicMaterial({color:H.arrowColour,side:THREE.DoubleSide}),x=new THREE.MeshBasicMaterial,R=new THREE.CylinderGeometry(.008,.008,.1),F=new THREE.ConeGeometry(.04,.04,4);const l=new THREE.PlaneGeometry(1,1);V=new THREE.Mesh(l,_e[0]),V.position.z=0,V.matrixWorldAutoUpdate=!1,r.add(V),Et(),Dt(),_t(),xt(),St(),Rt(),pn(),bn(),$t(),Ft(),rn(),On(),Ht(),e.addEventListener("pointerdown",Mt),e.addEventListener("pointerup",kt),e.addEventListener("pointermove",qt),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(W.toggleRunning(),e.preventDefault()),"h"===e.key&&(Ue?(Ue=!1,$(".ui").removeClass("hidden"),ee.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",ue),ie?Bt():Nt(),Hn(),Jn(),si()):(Ue=!0,$(".ui").addClass("hidden"))),"s"==e.key&&_i(),"c"==e.key&&(H.resetFromCheckpoints=!H.resetFromCheckpoints,ao($("#checkpointButton")[0])))})),window.addEventListener("resize",(function(){St(),oo()}),!1),window.addEventListener("message",Zi),$("#checkpointInput").change((function(){Ci(this.files[0]),this.value=null}))}();let bt=!0;if(gt.has("preset")&&(Yt(gt.get("preset")),bt=!1),gt.has("options")){var vt=JSON.parse(LZString.decompressFromEncodedURIComponent(gt.get("options")));vt.hasOwnProperty("p")&&(vt=maxifyPreset(vt)),Yt(vt),bt=!1}function St(){Et(),function(){V.material=_;for(let e=1;e<we.length;e++)O.textureSource.value=we[e].texture,we[e-1].setSize(de,he),s.setRenderTarget(we[e-1]),s.render(r,o);we.rotate(-1),we[0].dispose(),we[0]=we[1].clone(),h.setSize(de,he),Ut(),f.setSize(Math.round(devicePixelRatio*be),Math.round(devicePixelRatio*ve))}(),Ei(p),yt(),wt(),fo(),_t(),Jn(),si()}function wt(){A.geometry.dispose(),a.remove(A),P.geometry.dispose(),a.remove(P),U.geometry.dispose(),a.remove(U),M.geometry.dispose(),a.remove(M),Dt()}function _t(){switch(Ct(),H.plotType){case"line":u.enabled=!1,i.zoom=1,Yn(),b.vertexShader=surfaceVertexShaderColour();break;case"plane":u.enabled=!1,u.reset(),b.vertexShader=genericVertexShader();break;case"surface":u.enabled=!0,i.zoom=H.cameraZoom,Yn(),so()}b.needsUpdate=!0,i.left=-fe/(2*pe),i.right=fe/(2*pe),i.top=me/(2*pe),i.bottom=-me/(2*pe),i.updateProjectionMatrix(),Tt()}function yt(){O.L.value=Ne,O.L_y.value=me,O.L_x.value=fe,O.L_min.value=Math.min(me,fe),O.dt.value=H.dt,O.dx.value=ce,O.dy.value=ce,O.heightScale.value=H.threeDHeightScale,O.maxColourValue.value=H.maxColourValue,O.minColourValue.value=H.minColourValue,O.customSurface.value=H.customSurface,O.vectorField.value=H.vectorField,Ki(),an()}function Ct(){try{Ne=ht.evaluate(H.domainScale)}catch(e){xi("Unable to evaluate the domain length. Please check the definition."),Ne=100}be=Math.round(e.getBoundingClientRect().width),ve=Math.round(e.getBoundingClientRect().height),l=ve/be,l<=0&&(l=.1),l>=1?(me=Ne,fe=me/l):(fe=Ne,me=fe*l),1==H.dimension&&(fe=Ne),O.L_x.value=fe,O.L_y.value=me,pe=Math.max(fe,me)}function Et(){Ct(),ce=Ne/100;try{ce=ht.evaluate(H.spatialStep)}catch(e){xi("Unable to evaluate the spatial step. Please check the definition.")}ce<=0&&(xi("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),ce=Ne/100),de=Math.floor(fe/ce),he=Math.floor(me/ce),(de>ge||he>ge)&&(xi("Your device does not support a discretisation this fine (maximum "+ge+"). Please increase the space step to at least "+(Math.ceil(1e4*Ne/ge)/1e4).toPrecision(4)+" or reduce the domain size to at most "+(Math.floor(1e4*ge*ce)/1e4).toPrecision(4)+"."),de=Math.min(de,ge),he=Math.min(he,ge)),0==de&&(de=1),0==he&&(he=1),1==H.dimension&&(he=1),O.nXDisc.value=de,O.nYDisc.value=he,k=new Array(de),q=new Array(de);let e=-.5,t=de>1?1/(de-1):.5;for(let n=0;n<k.length;n++)k[n]=e,e+=t;k=k.map((e=>e*fe/pe)),Ti(),et=new Float32Array(de*he*4),ot=!1}function Dt(){Ct();let e=[1,1];Le||(e=[de,he]);const t=new THREE.PlaneGeometry(fe/pe,me/pe,e[0],e[1]);A=new THREE.Mesh(t,b),A.position.z=0,A.visible="line"!=H.plotType,A.matrixAutoUpdate=!1,a.add(A);const n=new THREE.PlaneGeometry(fe/pe,me/pe,1,1);P=new THREE.Mesh(n,g),P.position.z=0,P.visible=!1,P.matrixAutoUpdate=!1,a.add(P),Tt();const i=new LineGeometry;I=Math.round(2*devicePixelRatio*be);const o=new Array(3*I).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),U=new Line2(i,C),U.scale.set(1,1,1),U.visible="line"==H.plotType,a.add(U);const s=new LineGeometry,l=new Array(3*I).fill(0);s.setPositions(l),M=new Line2(s,E),M.scale.set(1,1,1),M.visible="line"==H.plotType&&H.overlay,a.add(M)}function Tt(){switch(H.plotType){case"plane":A.rotation.x=0,P.rotation.x=0;break;case"surface":A.rotation.x=-Math.PI/2,P.rotation.x=-Math.PI/2}A.updateMatrix(),P.updateMatrix()}function xt(){H.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Rt(e){Q=new dat.GUI({closeOnTop:!0,autoPlace:!1}),Q.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(Q.domElement),G=new dat.GUI({closeOnTop:!0,autoPlace:!1}),G.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(G.domElement),X=new dat.GUI({closeOnTop:!0,autoPlace:!1}),X.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(X.domElement),Q.open(),G.open(),X.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),z=G.addFolder("Brush");Bi(Li(z),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',vo,null,"Toggle the brush on or off"),ye.brushAction=z.add(H,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange((function(){$t(),document.activeElement.blur()})),ye.brushType=z.add(H,"brushType",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange((function(){$t(),document.activeElement.blur()})),z.add(H,"brushValue").name("Value").onFinishChange($t),z.add(H,"brushRadius").name("Radius").onFinishChange($t),ye.whatToDraw=z.add(H,"whatToDraw",rt).name("Species").onChange($t),z=G.addFolder("Domain"),z.add(H,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){zn(),document.activeElement.blur(),oo()})),z.add(H,"domainScale").name("Largest side").onFinishChange((function(){St(),oo()})),z.add(H,"spatialStep").name("Space step").onFinishChange((function(){St(),oo()})),z.add(H,"minX").name("Min. $x$").onFinishChange((function(){bn(),Ht()})),ye.minY=z.add(H,"minY").name("Min. $y$").onFinishChange((function(){bn(),Ht()}));const t=Li(z);Bi(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){xt(),St(),_t(),oo()}),null,"Use a square domain"),Bi(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Custom',(function(){gn(),pn(),Gt(),fn(),oo()}),null,"Specify a custom domain"),ye.domainIndicatorFun=z.add(H,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){gn(),pn(),Gt(),cn(),oo()})),z=G.addFolder("Timestepping"),ye.numTimestepsPerFrame=z.add(H,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),eo(ye.numTimestepsPerFrame,1,400,1),ye.dt=z.add(H,"dt").name("Timestep").onChange((function(){yt()})),ye.dt.__precision=12,ye.dt.min(0),ye.dt.updateDisplay(),z.add(H,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme").onChange((function(){document.activeElement.blur()}));const n=Li(z);Bi(n,"timeDisplay",'<i class="fa-regular fa-hourglass-half"></i> Elapsed time',Mn,null,"Show/hide time display"),Bi(n,"autoPause",'<i class="fa-regular fa-hourglass-end"></i> Auto pause',(function(){Re=O.t.value<H.autoPauseAt,pn()}),null,"Toggle automatic pausing"),ye.autoPauseAt=z.add(H,"autoPauseAt").name("Pause at $t=$").onFinishChange((function(){Re=O.t.value<H.autoPauseAt,ye.autoPauseAt.domElement.blur()})),z=G.addFolder("Equations"),z.add(H,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange((function(){document.activeElement.blur(),bn(),Ht()})),ye.algebraicSpecies=z.add(H,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Ie=!0,bn(),Ie=!1,Ht()})),z.add(H,"speciesNames").name("Species names").onFinishChange((function(){di()}));Bi(Li(z),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',(function(){bn()}),"cross_diffusion_controller","Toggle cross diffusion"),z=Q.addFolder("Definitions");Bi(Li(z),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',vn,null,"Typeset the specified equations"),ye.Duu=z.add(H,"diffusionStr_1_1").onFinishChange((function(){Gt(),vn()})),bi(ye.Duu,Si,["U","UU"]),vi(ye.Duu,wi,["U","UU"]),ye.Duv=z.add(H,"diffusionStr_1_2").onFinishChange((function(){Gt(),vn()})),bi(ye.Duv,Si,["UV"]),vi(ye.Duv,wi,["UV"]),ye.Duw=z.add(H,"diffusionStr_1_3").onFinishChange((function(){Gt(),vn()})),bi(ye.Duw,Si,["UW"]),vi(ye.Duw,wi,["UW"]),ye.Duq=z.add(H,"diffusionStr_1_4").onFinishChange((function(){Gt(),vn()})),bi(ye.Duq,Si,["UQ"]),vi(ye.Duq,wi,["UQ"]),ye.Dvu=z.add(H,"diffusionStr_2_1").onFinishChange((function(){Gt(),vn()})),bi(ye.Dvu,Si,["VU"]),vi(ye.Dvu,wi,["VU"]),ye.Dvv=z.add(H,"diffusionStr_2_2").onFinishChange((function(){Gt(),vn()})),bi(ye.Dvv,Si,["V","VV"]),vi(ye.Dvv,wi,["V","VV"]),ye.Dvw=z.add(H,"diffusionStr_2_3").onFinishChange((function(){Gt(),vn()})),bi(ye.Dvw,Si,["VW"]),vi(ye.Dvw,wi,["VW"]),ye.Dvq=z.add(H,"diffusionStr_2_4").onFinishChange((function(){Gt(),vn()})),bi(ye.Dvq,Si,["VQ"]),vi(ye.Dvq,wi,["VQ"]),ye.Dwu=z.add(H,"diffusionStr_3_1").onFinishChange((function(){Gt(),vn()})),bi(ye.Dwu,Si,["WU"]),vi(ye.Dwu,wi,["WU"]),ye.Dwv=z.add(H,"diffusionStr_3_2").onFinishChange((function(){Gt(),vn()})),bi(ye.Dwv,Si,["WV"]),vi(ye.Dwv,wi,["WV"]),ye.Dww=z.add(H,"diffusionStr_3_3").onFinishChange((function(){Gt(),vn()})),bi(ye.Dww,Si,["W","WW"]),vi(ye.Dww,wi,["W","WW"]),ye.Dwq=z.add(H,"diffusionStr_3_4").onFinishChange((function(){Gt(),vn()})),bi(ye.Dwq,Si,["WQ"]),vi(ye.Dwq,wi,["WQ"]),ye.Dqu=z.add(H,"diffusionStr_4_1").onFinishChange((function(){Gt(),vn()})),bi(ye.Dqu,Si,["QU"]),vi(ye.Dqu,wi,["QU"]),ye.Dqv=z.add(H,"diffusionStr_4_2").onFinishChange((function(){Gt(),vn()})),bi(ye.Dqv,Si,["QV"]),vi(ye.Dqv,wi,["QV"]),ye.Dqw=z.add(H,"diffusionStr_4_3").onFinishChange((function(){Gt(),vn()})),bi(ye.Dqw,Si,["QW"]),vi(ye.Dqw,wi,["QW"]),ye.Dqq=z.add(H,"diffusionStr_4_4").onFinishChange((function(){Gt(),vn()})),bi(ye.Dqq,Si,["Q","QQ"]),vi(ye.Dqq,wi,["Q","QQ"]),ye.f=z.add(H,"reactionStr_1").onFinishChange((function(){Gt(),vn()})),bi(ye.f,Si,["UFUN"]),vi(ye.f,wi,["UFUN"]),ye.g=z.add(H,"reactionStr_2").onFinishChange((function(){Gt(),vn()})),bi(ye.g,Si,["VFUN"]),vi(ye.g,wi,["VFUN"]),ye.h=z.add(H,"reactionStr_3").onFinishChange((function(){Gt(),vn()})),bi(ye.h,Si,["WFUN"]),vi(ye.h,wi,["WFUN"]),ye.j=z.add(H,"reactionStr_4").onFinishChange((function(){Gt(),vn()})),bi(ye.j,Si,["QFUN"]),vi(ye.j,wi,["QFUN"]),Se=Q.addFolder("Parameters"),function(){let e,t,n=[],i=H.kineticParams.split(";");for(var o=0;o<i.length;o++)t=Dn(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+Qe,Qe+=1,We.push(e),Oe[e]=t,n.push(e));for(const e of n)Tn(e,!1);e="param"+Qe,We.push(e),Oe[e]=t,Tn(e,!0)}(),z=Q.addFolder("Boundary conditions"),ye.uBCs=z.add(H,"boundaryConditions_1",{}).onChange((function(){Gt(),on(),document.activeElement.blur()})),ye.dirichletU=z.add(H,"dirichletStr_1").onFinishChange(Gt),ye.neumannU=z.add(H,"neumannStr_1").onFinishChange(Gt),ye.robinU=z.add(H,"robinStr_1").onFinishChange(Gt),ye.comboU=z.add(H,"comboStr_1").name("Details").onFinishChange(Gt),ye.vBCs=z.add(H,"boundaryConditions_2",{}).onChange((function(){Gt(),on(),document.activeElement.blur()})),ye.dirichletV=z.add(H,"dirichletStr_2").onFinishChange(Gt),ye.neumannV=z.add(H,"neumannStr_2").onFinishChange(Gt),ye.robinV=z.add(H,"robinStr_2").onFinishChange(Gt),ye.comboV=z.add(H,"comboStr_2").name("Details").onFinishChange(Gt),ye.wBCs=z.add(H,"boundaryConditions_3",{}).onChange((function(){Gt(),on(),document.activeElement.blur()})),ye.dirichletW=z.add(H,"dirichletStr_3").onFinishChange(Gt),ye.neumannW=z.add(H,"neumannStr_3").onFinishChange(Gt),ye.robinW=z.add(H,"robinStr_3").onFinishChange(Gt),ye.comboW=z.add(H,"comboStr_3").name("Details").onFinishChange(Gt),ye.qBCs=z.add(H,"boundaryConditions_4",{}).name("$q$").onChange((function(){Gt(),on(),document.activeElement.blur()})),ye.dirichletQ=z.add(H,"dirichletStr_4").onFinishChange(Gt),ye.neumannQ=z.add(H,"neumannStr_4").onFinishChange(Gt),ye.robinQ=z.add(H,"robinStr_4").onFinishChange(Gt),ye.comboQ=z.add(H,"comboStr_4").name("Details").onFinishChange(Gt),z=Q.addFolder("Initial conditions"),ye.initCond_1=z.add(H,"initCond_1").onFinishChange(rn),ye.initCond_2=z.add(H,"initCond_2").onFinishChange(rn),ye.initCond_3=z.add(H,"initCond_3").onFinishChange(rn),ye.initCond_4=z.add(H,"initCond_4").onFinishChange(rn),J=G.addFolder("Images"),z=J,un(),z=G.addFolder("Checkpoints");const i=Li(z);Bi(i,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),Hi(i),Ni(i,'<i class="fa-regular fa-flag"></i> Set',_i,null,"Set a checkpoint at the current state",["narrow"]),Ni(i,'<i class="fa-regular fa-file-arrow-down"></i> Export',yi,null,"Download the last checkpoint as a file",["narrow"]),Ni(i,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),z.add(H,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize").onChange((function(){document.activeElement.blur()})),z=G.addFolder("Misc."),z.addColor(H,"backgroundColour").name("Background").onChange((function(){a.background=new THREE.Color(H.backgroundColour),oo()}));const o=Li(z);Bi(o,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){qn(),oo()}),null,"Compute the integral of the plotted expression over the domain"),Bi(o,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',(function(){On(),oo()}),"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),Bi(o,"setSeed",'<i class="fa-regular fa-shuffle"></i> Set seed',(function(){H.setSeed&&(qe=H.randSeed),an(),pn()}),null,"Set the seed for random number generation"),ye.randSeed=z.add(H,"randSeed").name("Random seed").onFinishChange((function(){an()})),z=z.addFolder("Dev");const r=Li(z);Ni(r,'<i class="fa-regular fa-copy"></i> Copy code',Oi,null,"Copy the simulation configuration as JSON to the clipboard"),Ni(r,'<i class="fa-regular fa-bug"></i> Copy debug',Wi,null,"Copy debug information to the clipboard");let s=getListOfPresets();var l;Object.keys(s).forEach((function(e){s[e]=e})),s.default=null,z.add(H,"parent",(l=s,Object.keys(l).sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})).reduce((function(e,t){return e[t]=l[t],e}),{}))).name("Parent preset").onChange((function(){document.activeElement.blur()}));const u=document.createElement("div");u.innerHTML="Settings",u.classList.add("ui_title"),G.domElement.prepend(u);const c=document.createElement("div");c.innerHTML="Equations",c.classList.add("ui_title"),Q.domElement.prepend(c);const d=document.createElement("div");d.id="views_list",X.domElement.prepend(d);const h=document.createElement("div");h.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",h.classList.add("ui_title"),X.domElement.prepend(h),ee=X.addFolder("Edit view"),z=ee;const f=Li(z,"edit_view_buttons");Ni(f,'<i class="fa-solid fa-pen-nib"></i> Rename',Ai,null,"Rename the current view"),Ni(f,'<i class="fa-solid fa-xmark"></i> Delete',Vi,"deleteViewButton","Delete view"),ye.whatToPlot=z.add(H,"whatToPlot").name("Expression: ").onFinishChange((function(){cn(),oo(),Ui(this.property)})),z.add(H,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){Xn(),document.activeElement.blur(),oo(),Ui(this.property)})),z.add(H,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){At(),An(),document.activeElement.blur(),oo(),Ui(this.property)})).name("Colour map"),ye.minColourValue=z.add(H,"minColourValue").name("Min value").onChange((function(){yt(),Vn(),oo(),Ui(this.property)})),ye.minColourValue.__precision=2,ye.maxColourValue=z.add(H,"maxColourValue").name("Max value").onChange((function(){yt(),Vn(),oo(),Ui(this.property)})),ye.maxColourValue.__precision=2;const m=Li(z,"colour_map_buttons");Ni(m,'<i class="fa-regular fa-arrows-rotate"></i> Flip',(function(){H.flippedColourmap=!H.flippedColourmap,At(),An(),oo(),Ui("flippedColourmap")}),null,"Reverse colour map",["narrow"]),Ni(m,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){ui(),Pt(),Ui("minColourValue"),Ui("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),Bi(m,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){An(),Ui("colourbar")}),null,"Display the colourbar",null,["narrow"]),Hi(m),Bi(m,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){H.autoSetColourRange&&(ui(),Pt()),Ui("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),Bi(m,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){At(),oo(),Ui("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),Bi(m,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){At(),oo(),Ui("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),Bi(m,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){At(),oo(),Ui("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),Bi(m,"vectorField",'<i class="fa-solid fa-arrow-right-arrow-left"></i> Vector field',(function(){fo(),oo(),Ui("vectorField")}),"vectorFieldButton","Toggle vector field","vectorFieldFolder",["wide"]),z=ee.addFolder("Contours"),z.domElement.id="contoursFolder",ye.contourColour=z.addColor(H,"contourColour").name("Colour").onChange((function(){no(),oo(),Ui(this.property)})),ye.contourNum=z.add(H,"contourNum").name("Number").onChange((function(){no(),oo(),Ui(this.property)})),eo(ye.contourNum,1,20,1),Ce.push(ye.contourNum),ye.contourEpsilon=z.add(H,"contourEpsilon").name("Threshold").onChange((function(){no(),oo(),Ui(this.property)})),eo(ye.contourEpsilon,.001,.05,.001),Ce.push(ye.contourEpsilon),z=ee.addFolder("Lighting"),z.domElement.id="embossFolder",ye.embossSmoothness=z.add(H,"embossSmoothness").name("Smoothness").onChange((function(){Ki(),oo(),Ui(this.property)})),eo(ye.embossSmoothness,0,2,.001),Ee.push(ye.embossSmoothness),ye.embossAmbient=z.add(H,"embossAmbient").name("Ambient").onChange((function(){Ki(),oo(),Ui(this.property)})),eo(ye.embossAmbient,0,1,.001),Ee.push(ye.embossAmbient),ye.embossDiffuse=z.add(H,"embossDiffuse").name("Diffuse").onChange((function(){Ki(),oo(),Ui(this.property)})),eo(ye.embossDiffuse,0,1,.001),Ee.push(ye.embossDiffuse),ye.embossSpecular=z.add(H,"embossSpecular").name("Specular").onChange((function(){Ki(),oo(),Ui(this.property)})),eo(ye.embossSpecular,0,1,.001),Ee.push(ye.embossSpecular),ye.embossShiny=z.add(H,"embossShiny").name("Precision").onChange((function(){Ki(),oo(),Ui(this.property)})),eo(ye.embossShiny,0,100,1),Ee.push(ye.embossShiny),ye.embossTheta=z.add(H,"embossTheta").name("Inclination").onChange((function(){Ki(),oo(),Ui(this.property)})),eo(ye.embossTheta,0,1.5708,.001),Ee.push(ye.embossTheta),ye.embossPhi=z.add(H,"embossPhi").name("Direction").onChange((function(){Ki(),oo(),Ui(this.property)})),eo(ye.embossPhi,0,3.1456,.001),Ee.push(ye.embossPhi),z=ee.addFolder("Overlay"),z.domElement.id="overlayFolder",z.addColor(H,"overlayColour").name("Colour").onChange((function(){io(),oo(),Ui(this.property)})),z.add(H,"overlayExpr").name("Expression").onFinishChange((function(){At(),"line"==H.plotType&&fn(),oo(),Ui(this.property)})),ye.overlayEpsilon=z.add(H,"overlayEpsilon").name("Threshold").onChange((function(){io(),oo(),Ui(this.property)})),ye.overlayLineWidthMul=z.add(H,"overlayLineWidthMul",.1,2).name("Thickness").onChange((function(){gi(),oo(),Ui(this.property)})),te=ee.addFolder("3D"),z=te,Y=Li(z),Bi(Y,"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){O.customSurface.value=H.customSurface,so(),lo(),oo(),Ui("customSurface")}),null,"Plot the solution on a custom surface"),ye.surfaceFun=z.add(H,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){cn(),oo(),Ui(this.property)})),ye.threeDHeightScale=z.add(H,"threeDHeightScale").name("Height scale").onChange((function(){yt(),oo(),Ui(this.property)})),ye.cameraTheta=z.add(H,"cameraTheta").name("View $\\theta$").onChange((function(){_t(),oo(),Ui(this.property)})),ye.cameraPhi=z.add(H,"cameraPhi").name("View $\\phi$").onChange((function(){_t(),oo(),Ui(this.property)})),ye.cameraZoom=z.add(H,"cameraZoom").name("Zoom").onChange((function(){_t(),oo(),Ui(this.property)})),ye.lineWidthMul=z.add(H,"lineWidthMul",.1,2).name("Thickness").onChange((function(){gi(),oo(),Ui(this.property)})),ne=ee.addFolder("Vector field"),z=ne,z.domElement.id="vectorFieldFolder",z.addColor(H,"arrowColour").name("Colour").onChange((function(){mo(),oo(),Ui(this.property)})),z.add(H,"arrowX").onFinishChange((function(){fn(),oo(),Ui(this.property)})).name("$x$ component"),z.add(H,"arrowY").onFinishChange((function(){fn(),oo(),Ui(this.property)})).name("$y$ component"),ye.arrowDensity=z.add(H,"arrowDensity").onChange((function(){fo(),oo(),Ui(this.property)})).name("Density"),ye.arrowDensity.__precision=2,eo(ye.arrowDensity,0,1,.001),z.add(H,"arrowScale",{None:"none",Relative:"relative",Auto:"auto"}).onFinishChange((function(){pn(),oo(),Ui(this.property)})).name("Scaling"),ye.arrowLengthMax=z.add(H,"arrowLengthMax").onFinishChange((function(){fo(),oo(),Ui(this.property)})).name("Max length");document.querySelectorAll("input").forEach((e=>ro(e)))}function Ft(){At(),An(),cn(),$t()}function $t(){let e=ii()+drawShaderTop(),t="float brushRadius = "+jt(H.brushRadius.toString())+";\n";switch(t=t.replace(/\buvwq\./g,"uvwqBrush."),t=t.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(H.brushValue)&&(e+=randShader()),/\bRANDN\b/.test(H.brushValue)&&(e+=randNShader()),e+="float brushValue = "+jt(H.brushValue)+";\n",e+=t,H.brushType){case"circle":e+=drawShaderShapeDisc();break;case"hline":e+=drawShaderShapeHLine();break;case"vline":e+=drawShaderShapeVLine()}switch(H.brushAction){case"replace":e+=drawShaderFactorSharp(),e+=drawShaderBotReplace();break;case"add":e+=drawShaderFactorSharp(),e+=drawShaderBotAdd();break;case"smoothreplace":e+=drawShaderFactorSmooth(),e+=drawShaderBotReplace();break;case"smoothadd":e+=drawShaderFactorSmooth(),e+=drawShaderBotAdd()}vo(),e=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,nn(H.whatToDraw)),e}(e),e=go(e),v.fragmentShader=e,v.needsUpdate=!0}function At(){N=getColours(H.colourmap),H.flippedColourmap&&(N.reverse(),N=N.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),O.colour1.value=new THREE.Vector4(...N[0]),O.colour2.value=new THREE.Vector4(...N[1]),O.colour3.value=new THREE.Vector4(...N[2]),O.colour4.value=new THREE.Vector4(...N[3]),O.colour5.value=new THREE.Vector4(...N[4]);let e=ii()+fiveColourDisplayTop();H.emboss&&(e+=embossShader(),Ki()),H.contours&&(e+=contourShader(),no()),H.overlay&&(e+=overlayShader().replaceAll("OVERLAYEXPR",jt(H.overlayExpr)),e=go(e),io()),M.visible=H.overlay&&"line"==H.plotType,e+=fiveColourDisplayBot(),b.fragmentShader=e,b.needsUpdate=!0,y.needsUpdate=!0,B=N.map((e=>e[3])),N=N.map((e=>e.slice(0,-1)))}function Vt(){switch(H.timesteppingScheme){case"Euler":V.material=_e.FE,O.textureSource.value=we[1].texture,O.textureSource1.value=we[2].texture,O.dt.value=H.dt,s.setRenderTarget(we[0]),s.render(r,o),we.rotate(-1),O.t.value+=H.dt;break;case"AB2":V.material=_e.AB2,O.textureSource.value=we[1].texture,O.textureSource1.value=we[2].texture,O.dt.value=H.dt,s.setRenderTarget(we[0]),s.render(r,o),we.rotate(-1),O.t.value+=H.dt;break;case"Mid":V.material=_e.Mid1,O.textureSource.value=we[1].texture,s.setRenderTarget(we[2]),s.render(r,o),V.material=_e.Mid2,O.textureSource1.value=we[2].texture,O.t.value+=.5*H.dt,s.setRenderTarget(we[0]),s.render(r,o),we.rotate(-1),O.t.value+=.5*H.dt;break;case"RK4":V.material=_e.RK41,O.textureSource.value=we[1].texture,s.setRenderTarget(we[2]),s.render(r,o),V.material=_e.RK42,O.textureSource1.value=we[2].texture,O.t.value+=.5*H.dt,s.setRenderTarget(we[3]),s.render(r,o),V.material=_e.RK43,O.textureSource2.value=we[3].texture,s.setRenderTarget(we[4]),s.render(r,o),V.material=_e.RK44,O.textureSource3.value=we[4].texture,O.t.value+=.5*H.dt,s.setRenderTarget(we[0]),s.render(r,o),we.rotate(-1)}}function Pt(){if(Ut(),H.autoSetColourRange&&ui(),H.brushEnabled&&"surface"==H.plotType){let e=0;H.maxColourValue-H.minColourValue>0&&(e=(function(){Bn();let e=0;for(let t=0;t<et.length;t+=4)e+=et[t];return e/(de*he)}()-H.minColourValue)/(H.maxColourValue-H.minColourValue)-.5,e=e.clamp(-.5,.5)),P.position.y=H.threeDHeightScale*e,P.updateWorldMatrix()}if("line"==H.plotType){Bn();let t=0;var e=H.maxColourValue-H.minColourValue;e=0==e?.5:e;for(let n=0;n<et.length;n+=4)q[t++]=(et[n]-H.minColourValue)/e-.5;let n=new THREE.SplineCurve(k.map(((e,t)=>new THREE.Vector2(e,q[t])))),i=n.getSpacedPoints(I);if(fi(U,i),function(e,t){let n,i=e.geometry.attributes.instanceColorStart,o=e.geometry.attributes.instanceColorEnd;for(let e=0;e<t.length;e++)n=mi(t[e].toArray()[1]+.5),e<t.length&&i.setXYZ(e,n[0],n[1],n[2]),e>0&&o.setXYZ(e-1,n[0],n[1],n[2]);i.needsUpdate=!0}(U,i),H.overlay){t=0;for(let n=2;n<4*de;n+=4)q[t++]=(et[n]-H.minColourValue)/e-.5;n=new THREE.SplineCurve(k.map(((e,t)=>new THREE.Vector2(e,q[t])))),i=n.getSpacedPoints(I),fi(M,i)}}if(H.vectorField&&L){nt=new Float32Array(de*he*4),s.readRenderTargetPixels(h,0,0,de,he,nt);let e,t,n,i=[];for(const o of L.children)e=4*o.ind,t=nt[e+2],n=nt[e+3],o.visible=nt[e+1]<=.5,o.lookAt(o.position.x+t,o.position.y+n,o.position.z),o.size=t**2+n**2,i.push(o.size);let o=1;switch(H.arrowScale){case"auto":o=Math.sqrt(Math.max(...i)),0==o&&(o=1);for(const e of L.children){const t=He*pi(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"relative":o=L.customMax>0?L.customMax:1;for(const e of L.children){const t=He*pi(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"none":for(const e of L.children)e.scale.set(He,He,He)}}if(H.timeDisplay&&kn(),H.integrate&&function(){if(H.integrate){let e;Bn(),1==H.dimension?e=O.dx.value:2==H.dimension&&(e=O.dx.value*O.dy.value);let t=0;for(let e=0;e<et.length;e+=4)t+=et[e]*(1-et[e+1]);t*=e,$("#integralValue").html(Pn(t,4)),Hn()}}(),Wn()?(V.material=T,s.setRenderTarget(f),s.render(r,o),O.textureSource.value=f.texture,O.dxUpscaledScale.value=devicePixelRatio*be/de,O.dyUpscaledScale.value=devicePixelRatio*ve/he):(O.dxUpscaledScale.value=1,O.dyUpscaledScale.value=1),s.setRenderTarget(null),s.render(a,i),it){it=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",s.render(a,i),t.href=s.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Et(),Pt()}}function Ut(){V.material=y,O.textureSource.value=we[1].texture,s.setRenderTarget(h),s.render(r,o),O.textureSource.value=h.texture,ot=!1,O.textureSource1.value=we[1].texture}function Mt(t){oe=It(t,e),oe&&(H.brushEnabled&&"surface"==H.plotType?u.enabled=!1:H.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),Fn("#top_message"),window.clearTimeout(le),le=setTimeout((function(){$("#top_message").hasClass("fading_out")||$n("#top_message")}),3e3)))}function kt(e){oe=!1,"surface"==H.plotType&&(u.enabled=!0)}function qt(t){It(t,e)}function It(e,t){var n=t.getBoundingClientRect();let o=(e.clientX-n.x)/n.width,a=1-(e.clientY-n.y)/n.height;if("surface"==H.plotType){d.x=2*o-1,d.y=2*a-1,c.setFromCamera(d,i);var r=c.intersectObject(P,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==H.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*de)/de,a=Math.round(a*he)/he,O.brushCoords.value=new THREE.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function Lt(){s.setSize(de,he,!1),Me&&H.resetFromCheckpoints?V.material=x:V.material=w,we.forEach((e=>{s.setRenderTarget(e),s.render(r,o)})),Ti(),Pt()}function Nt(){Ue||($("#pause").hide(),$("#play").show()),ie=!1}function Bt(){Ue||($("#play").hide(),$("#pause").show()),Fe=!0,window.clearTimeout(se),se=setTimeout(Nn,1e3),ie=!0}function Ht(){H.setSeed&&(qe=H.randSeed),an(),O.t.value=0,Re=!0,kn(),Lt(),Pt(),Fe=!0,window.clearTimeout(se),Nn()}function Ot(){let e="";return e+="float UFUN = "+jt(H.reactionStr_1)+";\n",e+="float VFUN = "+jt(H.reactionStr_2)+";\n",e+="float WFUN = "+jt(H.reactionStr_3)+";\n",e+="float QFUN = "+jt(H.reactionStr_4)+";\n",e}function Wt(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function jt(e){if(!Ri(e=" "+e+" ")||So(e))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])?\b/g);let i,o,a,r,s,l,u,c,d,h,f,m,p,g=0;const b={S:"One",T:"Two"},v={R:"r",G:"g",B:"b",A:"a"};for(const S of n){for(i=S.index,m=b[S[1]],o=i+S[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,s=t.slice(o+g+1,a+g),s=ri(s),l=s.split(","),1!=l.length&&0!=l[1].trim().length||(l[1]="0"),l[0]="("+l[0]+"-MINX)/L_x",l[1]="("+l[1]+"-MINY)/L_y",h="texture(imageSource"+m+",vec2("+l.join(",")+")).",null!=S[2]?(p=v[S[2]],f=h+p):(p=["r","g","b"],f="("+p.map((e=>h+e)).join("+")+")/3.0 "),t=Cn(t,f,i+g,a+1+g),g+=f.length-a+i-1)}return t}(e=(e=Kn(e=(e=(e=(e=Qt(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){if("0"==n)return"1";const i=Number(n);return Number.isInteger(i&&i>0&&i<101)?"(("+t+")"+("*("+t+")").repeat(i-1)+")":"safepow("+t+","+n+")"}))).replaceAll(RegExp("\\b("+lt[0]+")\\b","g"),(function(e,t){return"uvwq."+nn(t)}))).replaceAll(RegExp("\\b("+lt[0]+")_([xy][fb]?2?)\\b","g"),(function(e,t,n){return n.includes("2")&&(n=n.slice(0,-1).repeat(2)),"uvwq"+n.toUpperCase()+"."+nn(t)}))).replaceAll(RegExp("\\b("+lt[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+nn(t)})))).replaceAll(/\b(I_[ST][RBGA]?\b)\s*(?!\()/g,"$1(x,y) "));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e=e.replaceAll(/\bind\b/g,"float")}function Qt(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function Gt(){let e="",t="",n="",i="",o="",a="";const r=[H.boundaryConditions_1,H.boundaryConditions_2,H.boundaryConditions_3,H.boundaryConditions_4],s=[H.neumannStr_1,H.neumannStr_2,H.neumannStr_3,H.neumannStr_4],l=[H.comboStr_1,H.comboStr_2,H.comboStr_3,H.comboStr_4].map((e=>e+";")),u=[H.dirichletStr_1,H.dirichletStr_2,H.dirichletStr_3,H.dirichletStr_4],c=[H.robinStr_1,H.robinStr_2,H.robinStr_3,H.robinStr_4];r.forEach((function(t,n){"neumann"==t?(e+=Xt(s[n],rt[n]),H.domainViaIndicatorFun?e+=qi(n):e+=ki(n)):"combo"==t&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=Xt(t[2],rt[n],i),e+=ki(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=tn(RDShaderGhostX(t),rt[e]),H.dimension>1&&(i+=tn(RDShaderGhostY(t),rt[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,jt(e[2]))}))})),r.forEach((function(e,t){if("dirichlet"==e)if(H.domainViaIndicatorFun){let e=RDShaderDirichletIndicatorFun().replace(/indicatorFun/g,jt(H.domainIndicatorFun));n+=tn(e,rt[t])+jt(u[t])+";\n}\n"}else n+=zt(u[t],rt[t]),n+=Mi(t);else if("combo"==e)[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=zt(e[2],rt[t],i),n+=Mi(t,i)}));else if(H.domainViaIndicatorFun){let e=RDShaderDirichletIndicatorFun().replace(/indicatorFun/g,jt(H.domainIndicatorFun));n+=tn(e,rt[t])+"0.0;\n}\n"}})),r.forEach((function(e,t){"robin"==e?(i+=Xt(c[t],rt[t]),H.domainViaIndicatorFun?i+=qi(t):i+=ki(t)):"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=Xt(e[2],rt[t],n),i+=ki(t,n)}))}));let d=ii();if(o=function(){let e="";return e+=Wt(jt(H.diffusionStr_1_1)+";\n","uu"),e+=Wt(jt(H.diffusionStr_2_2)+";\n","vv"),e+=Wt(jt(H.diffusionStr_3_3)+";\n","ww"),e+=Wt(jt(H.diffusionStr_4_4)+";\n","qq"),e}()+"\n",H.crossDiffusion?o+=function(){let e="";return e+=Wt(jt(H.diffusionStr_1_2)+";\n","uv"),e+=Wt(jt(H.diffusionStr_1_3)+";\n","uw"),e+=Wt(jt(H.diffusionStr_1_4)+";\n","uq"),e+=Wt(jt(H.diffusionStr_2_1)+";\n","vu"),e+=Wt(jt(H.diffusionStr_2_3)+";\n","vw"),e+=Wt(jt(H.diffusionStr_2_4)+";\n","vq"),e+=Wt(jt(H.diffusionStr_3_1)+";\n","wu"),e+=Wt(jt(H.diffusionStr_3_2)+";\n","wv"),e+=Wt(jt(H.diffusionStr_3_4)+";\n","wq"),e+=Wt(jt(H.diffusionStr_4_1)+";\n","qu"),e+=Wt(jt(H.diffusionStr_4_2)+";\n","qv"),e+=Wt(jt(H.diffusionStr_4_3)+";\n","qw"),e}()+"\n"+RDShaderUpdateCross():o+=RDShaderUpdateNormal(),H.numAlgebraicSpecies>=2){const e=H.numSpecies-H.numAlgebraicSpecies;let t={};for(let n=e;n<H.numSpecies;n++){let i=[],o=H["reactionStr_"+(n+1).toString()];for(let t=e;t<H.numSpecies;t++)o=[o,H["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()]].join(" ");for(let t=e;t<H.numSpecies;t++){(new RegExp("\\b"+rt[t]+"(_(x|xb|xf|xb2|xf2|xx|y|yb|yf|yb2|yf2|yy))?\\b").test(o)||"0"!=H["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()])&&i.push(rt[t])}i!=[]&&(t[rt[n]]=i)}let n={},i=[],o=[];for(let a of rt.slice(e,H.numSpecies))bo(a,n,i,t,o);if(o.length>0)return void xi("Cyclic variables detected. Please check the definition(s) of "+o.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.")}if(Je&&H.crossDiffusion&&(a+=tn(RDShaderAlgebraicSpecies(),rt[1])),Ze&&H.crossDiffusion&&(a+=tn(RDShaderAlgebraicSpecies(),rt[2])),Ke&&H.crossDiffusion&&(a+=tn(RDShaderAlgebraicSpecies(),rt[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void xi("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let h=[RDShaderAdvectionPreBC(),RDShaderDiffusionPreBC(),e,t,i,RDShaderAdvectionPostBC(),RDShaderDiffusionPostBC(),Ot(),o].join(" "),f=/\bRAND\b/.test(h),m=/\bRANDN\b/.test(h);f&&(h=randShader()+h),m&&(h=randNShader()+h),Ae=f||m;let p=[n,a,RDShaderBot()].join(" "),g="FE";_e[g].fragmentShader=go([d,RDShaderTop(g),h,RDShaderMain(g),p].join(" ")),g="AB2",_e[g].fragmentShader=go([d,RDShaderTop(g),h,RDShaderMain(g),p].join(" ")),g="Mid";for(let e=1;e<3;e++)_e[g+e.toString()].fragmentShader=go([d,RDShaderTop(g+e.toString()),h,RDShaderMain(g+e.toString()),p].join(" "));g="RK4";for(let e=1;e<5;e++)_e[g+e.toString()].fragmentShader=go([d,RDShaderTop(g+e.toString()),h,RDShaderMain(g+e.toString()),p].join(" "));if(Object.keys(_e).forEach((e=>_e[e].needsUpdate=!0)),re=H.domainViaIndicatorFun||"dirichlet"==H.boundaryConditions_1||"dirichlet"==H.boundaryConditions_2||"dirichlet"==H.boundaryConditions_3||"dirichlet"==H.boundaryConditions_4||/Dirichlet/.test(H.comboStr_1)||/Dirichlet/.test(H.comboStr_2)||/Dirichlet/.test(H.comboStr_3)||/Dirichlet/.test(H.comboStr_4),re){if(n=d+RDShaderEnforceDirichletTop(),H.domainViaIndicatorFun){let e=RDShaderDirichletIndicatorFun().replace(/indicatorFun/,jt(H.domainIndicatorFun)).replace(/updated/,"gl_FragColor");u.forEach((function(t,i){"dirichlet"==r[i]?n+=tn(e,rt[i])+jt(t)+";\n}\n":n+=tn(e,rt[i])+"0.0;\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=zt(u[t],rt[t]),n+=Ii(t)):"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=zt(e[2],rt[t],i),n+=Ii(t,i)}))}));n+="}",n=go(n),S.fragmentShader=n,S.needsUpdate=!0}}function Xt(e,t,n){return null==n?["L","R","T","B"].map((n=>Xt(e,t,n))).join(""):"float robinRHS"+t+n+" = "+jt(e)+";\n"}function zt(e,t,n){return null==n?["L","R","T","B"].map((n=>zt(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+jt(e)+";\n"}function Yt(e){Jt("default"),Jt(e),null!=H.threeD&&(H.threeD&&(H.dimension=2,null==H.plotType&&(H.plotType="surface")),delete H.threeD),null!=H.oneDimensional&&(H.oneDimensional&&(H.dimension=1,H.plotType="line"),delete H.oneDimensional),Ne*=Be,function(){if(0==H.views.length){let e=Pi();e.name="1",H.views.push(e)}else H.views=H.views.map((function(e){let t=Pi();return Object.assign(t,e),t}))}(),Kt(Q,!0),Kt(G,!0),Kt(X,!0),Rt(),H.activeViewInd>=H.views.length&&(H.activeViewInd=H.views.length-1),$i(H.views[H.activeViewInd],!1),bn(),xt(),St(),yt(),a.background=new THREE.Color(H.backgroundColour),""!=H.initialState?fetch(H.initialState).then((e=>e.blob())).then((e=>Ci(e))):Ht(),_t(),Z.remove(),K.remove(),un(),On()}function Jt(e){let t;t=null==e?getPreset(H.preset):"string"==typeof e?getPreset(e):"object"==typeof e?e:getPreset("default"),t.hasOwnProperty("parent")&&null!=t.parent&&Jt(t.parent),Qe=0,We=[],Oe={},Object.assign(H,t),ie=H.runningOnLoad,di(),ie?Bt():Nt(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?H.tryClickingText=H.tryClickingText.replaceAll("clicking","tapping"):H.tryClickingText=H.tryClickingText.replaceAll("tapping","clicking"),H.brushRadius=H.brushRadius.toString(),H.hasOwnProperty("drawIn3D")&&(H.brushEnabled=H.drawIn3D);var n=0;n+=H.hasOwnProperty("algebraicV"),n+=H.hasOwnProperty("algebraicW"),(n+=H.hasOwnProperty("algebraicQ"))&&!H.numAlgebraicSpecies&&(H.numAlgebraicSpecies=n),delete H.algebraicV,delete H.algebraicW,delete H.algebraicQ;const i=getOldPresetFieldsToNew();Object.keys(i).forEach((function(e){H.hasOwnProperty(e)&&(t.hasOwnProperty(i[e])||(H[i[e]]=H[e]),delete H[e])})),null==H.minColourValue&&(H.minColourValue=0),null==H.maxColourValue&&(H.maxColourValue=1),H.domainScale=H.domainScale.toString(),H.spatialStep=H.spatialStep.toString(),j=JSON.parse(JSON.stringify(H));let o=[H.initCond_1,H.initCond_2,H.initCond_3,H.initCond_4,H.domainIndicatorFun,H.reactionStr_1,H.reactionStr_2,H.reactionStr_3,H.reactionStr_4,H.diffusionStr_1_1,H.diffusionStr_1_2,H.diffusionStr_1_3,H.diffusionStr_1_4,H.diffusionStr_2_1,H.diffusionStr_2_2,H.diffusionStr_2_3,H.diffusionStr_2_4,H.diffusionStr_3_1,H.diffusionStr_3_2,H.diffusionStr_3_3,H.diffusionStr_3_4,H.diffusionStr_4_1,H.diffusionStr_4_2,H.diffusionStr_4_3,H.diffusionStr_4_4,H.dirichletStr_1,H.dirichletStr_2,H.dirichletStr_3,H.dirichletStr_4,H.robinStr_1,H.robinStr_2,H.robinStr_3,H.robinStr_4,H.comboStr_1,H.comboStr_2,H.comboStr_3,H.comboStr_4,H.neumannStr_1,H.neumannStr_2,H.neumannStr_3,H.neumannStr_4,H.brushValue,H.whatToPlot].join(" ");H.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(o)}function Zt(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)Zt(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Kt(e,t){if(null!=e){for(let t in e.__folders)Kt(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function en(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function tn(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=nn(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function nn(e){return"rgba"[function(e){return rt.indexOf(e)}(e)]}function on(){"dirichlet"==H.boundaryConditions_1?ye.dirichletU.show():ye.dirichletU.hide(),"dirichlet"==H.boundaryConditions_2?ye.dirichletV.show():ye.dirichletV.hide(),"dirichlet"==H.boundaryConditions_3?ye.dirichletW.show():ye.dirichletW.hide(),"dirichlet"==H.boundaryConditions_4?ye.dirichletQ.show():ye.dirichletQ.hide(),"neumann"==H.boundaryConditions_1?ye.neumannU.show():ye.neumannU.hide(),"neumann"==H.boundaryConditions_2?ye.neumannV.show():ye.neumannV.hide(),"neumann"==H.boundaryConditions_3?ye.neumannW.show():ye.neumannW.hide(),"neumann"==H.boundaryConditions_4?ye.neumannQ.show():ye.neumannQ.hide(),"robin"==H.boundaryConditions_1?ye.robinU.show():ye.robinU.hide(),"robin"==H.boundaryConditions_2?ye.robinV.show():ye.robinV.hide(),"robin"==H.boundaryConditions_3?ye.robinW.show():ye.robinW.hide(),"robin"==H.boundaryConditions_4?ye.robinQ.show():ye.robinQ.hide(),"combo"==H.boundaryConditions_1?ye.comboU.show():ye.comboU.hide(),"combo"==H.boundaryConditions_2?ye.comboV.show():ye.comboV.hide(),"combo"==H.boundaryConditions_3?ye.comboW.show():ye.comboW.hide(),"combo"==H.boundaryConditions_4?ye.comboQ.show():ye.comboQ.hide();const e=[ye.uBCs,ye.vBCs,ye.wBCs,ye.qBCs];H.domainViaIndicatorFun?e.forEach((e=>ci(e,["Dirichlet","Neumann","Robin"],["dirichlet","neumann","robin"]))):e.forEach((e=>ci(e,["Periodic","Dirichlet","Neumann","Robin","Combination"],["periodic","dirichlet","neumann","robin","combo"]))),Zt(Q)}function an(){qe=(qe+123456789)%1e9,O.seed.value=qe/1e6}function rn(){let e=ii()+clearShaderTop(),t=[H.initCond_1,H.initCond_2,H.initCond_3,H.initCond_4].join(" ");/\bRAND\b/.test(t)&&(e+=randShader()),/\bRANDN\b/.test(t)&&(e+=randNShader()),e+="float u = "+jt(H.initCond_1)+";\n",e+="float v = "+jt(H.initCond_2)+";\n",e+="float w = "+jt(H.initCond_3)+";\n",e+="float q = "+jt(H.initCond_4)+";\n",e+=clearShaderBot(),e=go(e),w.fragmentShader=e,w.needsUpdate=!0}function sn(){let e=new Image;e.src=Z.__image.src;let t=new THREE.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,O.imageSourceOne.value=t,H.resetOnImageLoad&&Ht()}}function ln(){let e=new Image;e.src=K.__image.src;let t=new THREE.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,O.imageSourceTwo.value=t,H.resetOnImageLoad&&Ht()},t.dispose()}function un(){z=J,Z=z.addImage(H,"imagePathOne").name("$I_S(x,y)$").onChange(sn),K=z.addImage(H,"imagePathTwo").name("$I_T(x,y)$").onChange(ln),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function cn(){ot=!1,fn(),ye.minColourValue.show(),ye.maxColourValue.show(),An(),qn()}function dn(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function hn(){Bn();let e=1/0,t=-1/0;for(let n=0;n<et.length;n+=4)e=Math.min(e,et[n]),t=Math.max(t,et[n]);return[e,t]}function fn(){let e=ii()+computeDisplayFunShaderTop();e+=computeDisplayFunShaderMid().replace(/\bXVECFUN\b/,jt(H.arrowX)).replace(/\bYVECFUN\b/,jt(H.arrowY)),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,jt(H.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,jt(H.surfaceFun))}(e),H.domainViaIndicatorFun&&(e+=postShaderDomainIndicator().replace(/indicatorFun/g,jt(H.domainIndicatorFun))),e=e.replaceAll("OVERLAYEXPR",jt(H.overlayExpr)),e=go(e),io(),y.fragmentShader=e+postGenericShaderBot(),y.needsUpdate=!0}function mn(){H.numAlgebraicSpecies=Math.min(parseInt(H.numAlgebraicSpecies),parseInt(H.numSpecies)-1),Je=H.numAlgebraicSpecies>=H.numSpecies-1,Ze=H.numAlgebraicSpecies>=H.numSpecies-2&&H.numSpecies>=3,Ke=H.numAlgebraicSpecies>=H.numSpecies-3&&H.numSpecies>=4}function pn(){let e="function of "+rt.slice(0,H.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+rt[1]+",",""),i=e.replace(" "+rt[2]+",",""),o=e.replace(" "+rt[3]+",","");switch(1==H.dimension?(e=e.replace(" y,",""),ye.minY.hide()):ye.minY.show(),H.crossDiffusion&&parseInt(H.numSpecies)>1?(Ie||ci(ye.algebraicSpecies,Array.from(Array(parseInt(H.numSpecies)).keys())),ye.algebraicSpecies.show()):ye.algebraicSpecies.hide(),H.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),ye.Duv.hide(),ye.Dvu.hide(),ye.Dvv.hide(),ye.g.hide(),ye.initCond_2.hide(),ye.vBCs.hide(),ye.Duw.hide(),ye.Dvw.hide(),ye.Dwu.hide(),ye.Dwv.hide(),ye.Dww.hide(),ye.h.hide(),ye.initCond_3.hide(),ye.wBCs.hide(),ye.Duq.hide(),ye.Dvq.hide(),ye.Dwq.hide(),ye.Dqu.hide(),ye.Dqv.hide(),ye.Dqw.hide(),ye.Dqq.hide(),ye.j.hide(),ye.initCond_4.hide(),ye.qBCs.hide(),parseInt(H.numSpecies)){case 4:H.crossDiffusion?(ye.Duq.show(),ye.Dvq.show(),ye.Dwq.show(),ye.Dqu.show(),ye.Dqv.show(),ye.Dqw.show()):(ye.Dwq.hide(),ye.Dqu.hide(),ye.Dvq.hide(),ye.Duq.hide(),ye.Dqv.hide(),ye.Dqw.hide()),ye.Dqq.show(),ye.j.show(),ye.initCond_4.show(),ye.qBCs.show();case 3:H.crossDiffusion?(ye.Duw.show(),ye.Dvw.show(),ye.Dwu.show(),ye.Dwv.show()):(ye.Duw.hide(),ye.Dvw.hide(),ye.Dwu.hide(),ye.Dwv.hide()),ye.Dww.show(),ye.h.show(),ye.initCond_3.show(),ye.wBCs.show();case 2:H.crossDiffusion?(ye.Duv.show(),ye.Dvu.show()):(ye.Duv.hide(),ye.Dvu.hide()),ye.Dvv.show(),ye.g.show(),ye.initCond_2.show(),ye.vBCs.show()}H.crossDiffusion?(en(ye.Duu,ct.Duu,e),en(ye.Duv,ct.Duv,e),en(ye.Duw,ct.Duw,e),en(ye.Duq,ct.Duq,e),en(ye.Dvu,ct.Dvu,e),en(ye.Dvv,ct.Dvv,e),en(ye.Dvw,ct.Dvw,e),en(ye.Dvq,ct.Dvq,e),en(ye.Dwu,ct.Dwu,e),en(ye.Dwv,ct.Dwv,e),en(ye.Dww,ct.Dww,e),en(ye.Dwq,ct.Dwq,e),en(ye.Dqu,ct.Dqu,e),en(ye.Dqv,ct.Dqv,e),en(ye.Dqw,ct.Dqw,e),en(ye.Dqq,ct.Dqq,e)):(en(ye.Duu,ct.Du,e),en(ye.Dvv,ct.Dv,e),en(ye.Dww,ct.Dw,e),en(ye.Dqq,ct.Dq,e)),en(ye.f,ct.UFUN,e),en(ye.g,ct.VFUN,e),en(ye.h,ct.WFUN,e),en(ye.j,ct.QFUN,e),Je&&(en(ye.Dvu,ct.Dvu,t),en(ye.Dvw,ct.Dvw,t),en(ye.Dvq,ct.Dvq,t),en(ye.g,ct.VFUN,t),ye.Dvv.hide()),Ze&&(en(ye.Dwu,ct.Dwu,o),en(ye.Dwv,ct.Dwv,o),en(ye.Dwq,ct.Dwq,o),en(ye.h,ct.WFUN,o),ye.Dww.hide()),Ke&&(en(ye.Dqu,ct.Dqu,i),en(ye.Dqv,ct.Dqv,i),en(ye.Dqw,ct.Dqw,i),en(ye.j,ct.QFUN,i),ye.Dqq.hide()),en(ye.uBCs,ct.u),en(ye.vBCs,ct.v),en(ye.wBCs,ct.w),en(ye.qBCs,ct.q),en(ye.dirichletU,ct.uD),en(ye.dirichletV,ct.vD),en(ye.dirichletW,ct.wD),en(ye.dirichletQ,ct.qD),en(ye.neumannU,ct.uN),en(ye.neumannV,ct.vN),en(ye.neumannW,ct.wN),en(ye.neumannQ,ct.qN),en(ye.robinU,ct.uN),en(ye.robinV,ct.vN),en(ye.robinW,ct.wN),en(ye.robinQ,ct.qN),en(ye.initCond_1,ct.uInit),en(ye.initCond_2,ct.vInit),en(ye.initCond_3,ct.wInit),en(ye.initCond_4,ct.qInit),H.domainViaIndicatorFun?ye.domainIndicatorFun.show():ye.domainIndicatorFun.hide(),on(),"surface"==H.plotType?($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").hide(),te.name="3D options",te.domElement.classList.remove("hidden"),ye.lineWidthMul.hide(),ye.threeDHeightScale.show(),ye.cameraTheta.show(),ye.cameraPhi.show(),ye.cameraZoom.show()):"line"==H.plotType?($("#contourButton").hide(),$("#embossButton").hide(),$("#vectorFieldButton").hide(),te.name="Line options",te.domElement.classList.remove("hidden"),ye.lineWidthMul.show(),ye.threeDHeightScale.show(),ye.cameraTheta.hide(),ye.cameraPhi.hide(),ye.cameraZoom.hide()):($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").show(),te.domElement.classList.add("hidden"),ye.lineWidthMul.hide(),ye.threeDHeightScale.hide(),ye.cameraTheta.hide(),ye.cameraPhi.hide(),ye.cameraZoom.hide()),1==H.dimension&&$("#vectorFieldButton").hide(),An(),Mn(),qn(),$("#dataContainer").show(),lo(),"line"==H.plotType?(ye.brushType.hide(),$(":root").css("--ui-button-outline","black")):(ye.brushType.show(),$(":root").css("--ui-button-outline","white")),n?$("#interpController").hide():$("#interpController").show(),"relative"==H.arrowScale?ye.arrowLengthMax.show():ye.arrowLengthMax.hide(),ci(ye.whatToDraw,rt.slice(0,H.numSpecies)),to(),H.autoPause?ye.autoPauseAt.show():ye.autoPauseAt.hide(),"line"==H.plotType?(ye.overlayEpsilon.hide(),ye.overlayLineWidthMul.show()):(ye.overlayEpsilon.show(),ye.overlayLineWidthMul.hide()),H.setSeed?ye.randSeed.show():ye.randSeed.hide(),$(".toggle_button").each((function(){ao(this)})),Fi(),Zt(Q),Zt(G),Zt(X)}function gn(){let e;switch(mn(),H.domainViaIndicatorFun&&(["dirichlet","neumann"].includes(H.boundaryConditions_1)||(H.boundaryConditions_1="dirichlet"),["dirichlet","neumann"].includes(H.boundaryConditions_2)||(H.boundaryConditions_2="dirichlet"),["dirichlet","neumann"].includes(H.boundaryConditions_3)||(H.boundaryConditions_3="dirichlet"),["dirichlet","neumann"].includes(H.boundaryConditions_4)||(H.boundaryConditions_4="dirichlet")),parseInt(H.numSpecies)){case 1:H.crossDiffusion=!1,H.whatToDraw=rt[0],H.whatToPlot=rt[0],H.diffusionStr_1_2="0",H.diffusionStr_1_3="0",H.diffusionStr_1_4="0",H.diffusionStr_2_1="0",H.diffusionStr_2_2="0",H.diffusionStr_2_3="0",H.diffusionStr_2_4="0",H.diffusionStr_3_1="0",H.diffusionStr_3_2="0",H.diffusionStr_3_3="0",H.diffusionStr_3_4="0",H.diffusionStr_4_1="0",H.diffusionStr_4_2="0",H.diffusionStr_4_3="0",H.diffusionStr_4_4="0",H.boundaryConditions_2="periodic",H.initCond_2="0",H.reactionStr_2="0",H.boundaryConditions_3="periodic",H.initCond_3="0",H.reactionStr_3="0",H.boundaryConditions_4="periodic",H.initCond_4="0",H.reactionStr_4="0",e=new RegExp("\\b("+lt[1]+")\\b"),e.test(H.reactionStr_1)&&(H.reactionStr_1="0");break;case 2:H.whatToDraw==rt[2]|H.whatToDraw==rt[3]&&(H.whatToDraw=rt[0]),H.whatToPlot==rt[2]|H.whatToPlot==rt[3]&&(H.whatToPlot=rt[0]),H.diffusionStr_1_3="0",H.diffusionStr_1_4="0",H.diffusionStr_2_3="0",H.diffusionStr_2_4="0",H.diffusionStr_3_1="0",H.diffusionStr_3_2="0",H.diffusionStr_3_3="0",H.diffusionStr_3_4="0",H.diffusionStr_4_1="0",H.diffusionStr_4_2="0",H.diffusionStr_4_3="0",H.diffusionStr_4_4="0",H.boundaryConditions_3="periodic",H.initCond_3="0",H.reactionStr_3="0",H.boundaryConditions_4="periodic",H.initCond_4="0",H.reactionStr_4="0",e=new RegExp("\\b("+lt[2]+")\\b"),e.test(H.reactionStr_1)&&(H.reactionStr_1="0"),e.test(H.reactionStr_2)&&(H.reactionStr_2="0");break;case 3:H.whatToDraw==rt[3]&&(H.whatToDraw=rt[0]),H.whatToPlot==rt[3]&&(H.whatToPlot=rt[0]),H.diffusionStr_1_4="0",H.diffusionStr_2_4="0",H.diffusionStr_3_4="0",H.diffusionStr_4_1="0",H.diffusionStr_4_2="0",H.diffusionStr_4_3="0",H.diffusionStr_4_4="0",H.boundaryConditions_4="periodic",H.initCond_4="0",H.reactionStr_4="0",e=new RegExp("\\b("+lt[3]+")\\b"),e.test(H.reactionStr_1)&&(H.reactionStr_1="0"),e.test(H.reactionStr_2)&&(H.reactionStr_2="0"),e.test(H.reactionStr_3)&&(H.reactionStr_3="0")}switch(Ye){case 3:H.diffusionStr_2_2="0";break;case 6:H.diffusionStr_3_3="0";break;case 7:H.diffusionStr_2_2="0",H.diffusionStr_3_3="0";break;case 10:H.diffusionStr_4_4="0";break;case 11:H.diffusionStr_3_3="0",H.diffusionStr_4_4="0";break;case 12:H.diffusionStr_2_2="0",H.diffusionStr_3_3="0",H.diffusionStr_4_4="0"}Zt(Q),Zt(G)}function bn(){!function(){switch(mn(),parseInt(H.numSpecies)){case 1:Ye=0;break;case 2:Ye=H.crossDiffusion?1==H.numAlgebraicSpecies?3:2:1;break;case 3:if(H.crossDiffusion)switch(H.numAlgebraicSpecies){case 0:Ye=5;break;case 1:Ye=6;break;case 2:Ye=7}else Ye=4;break;case 4:if(H.crossDiffusion)switch(H.numAlgebraicSpecies){case 0:Ye=9;break;case 1:Ye=10;break;case 2:Ye=11;break;case 3:Ye=12}else Ye=8}}(),Xn(),zn(),gn(),pn(),ti(),ai(),vn()}function vn(){let e,t=ut[Ye];const n={U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(H.typesetCustomEqs){let o={};o.U=H.diffusionStr_1_1,o.UU=H.diffusionStr_1_1,o.V=H.diffusionStr_2_2,o.VV=H.diffusionStr_2_2,o.W=H.diffusionStr_3_3,o.WW=H.diffusionStr_3_3,o.Q=H.diffusionStr_4_4,o.QQ=H.diffusionStr_4_4,o.UV=H.diffusionStr_1_2,o.UW=H.diffusionStr_1_3,o.UQ=H.diffusionStr_1_4,o.VU=H.diffusionStr_2_1,o.VW=H.diffusionStr_2_3,o.VQ=H.diffusionStr_2_4,o.WU=H.diffusionStr_3_1,o.WV=H.diffusionStr_3_2,o.WQ=H.diffusionStr_3_4,o.QU=H.diffusionStr_4_1,o.QV=H.diffusionStr_4_2,o.QW=H.diffusionStr_4_3,o.UFUN=H.reactionStr_1,o.VFUN=H.reactionStr_2,o.WFUN=H.reactionStr_3,o.QFUN=H.reactionStr_4,Object.keys(o).forEach((function(e){So(o[e])&&(o[e]="0")}));var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!Ri(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=hi(o[e],rt,Ge,"_(?:[xy][xybf]?)")})),De.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){Xe.includes(e)||(t=function(e,t,n,i){null==i&&(i="  ");let o=n.replace(/\s+/g,"  ").trim();return["0","0.0","-0","-0.0","+0","+0.0"].includes(o)?e.replaceAll(t,""):"1"==o||"1.0"==o?e.replaceAll(t,"$2"):"-1"==o||"-1.0"==o?e.replaceAll(t,i[0]+"-"+i[1]+"$2"):e.replaceAll(t,i[0]+n+i[1]+"$2")}(t,n[e],o[e],"[]"))})),t=Gn(t,n.UFUN,o.UFUN),t=Gn(t,n.VFUN,o.VFUN),t=Gn(t,n.WFUN,o.WFUN),t=Gn(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}\(\)]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\(\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"\\lap $1"),e=/\\vnabla\s*\\cdot\s*\(\s*((?!\\vnabla).*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b(?:[xy]|[uvwq](?:_[xy])?|(?:I_[ST][RGBA]?))\b/g.test(t)?e:t.trim()+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])[fb]?2?\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else De.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{ "+t+" ";return"string"==typeof n&&(i+=n),i+" }"}))})),t=hi(t,["UFUN","VFUN","WFUN","QFUN"],Xe);1==H.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=hi(t,Ge.concat(Xe),rt.concat(st),"_(?:[xy][xybf]?)"),t=Sn(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(si)}function Sn(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=wn(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=wn(e,"cos",!0),e=wn(e,"tan",!0),e=wn(e,"exp",!0),e=wn(e,"log",!0),e=wn(e,"sqrt",!1),e=wn(e,"sinh",!0),e=wn(e,"cosh",!0),e=wn(e,"tanh",!0),e=wn(e,"max",!0),e=wn(e,"min",!0),e=Qt(e=(e=wn(e,"ind",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",s="";for(var l=0;l<e.length;l++)t.includes(e[l])?(i+=1,o+=1):n.includes(e[l])&&(i-=1),0==i&&o>0&&(r=e.slice(a,l+1),s+=_n(r,o),o=0,a=l+1);return s+=e.slice(a),s}(e=substituteGreek(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")).replaceAll(/<=/g," \\leq ")).replaceAll(/>=/g," \\geq ")).replaceAll(/([<>])/g," $1 ")}function wn(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,s,l,u,c,d,h=0;for(const f of o){for(a=f.index,r=a+t.length,l=e.slice(r),d=0,u=0,c=!1;d<=l.length&(!c|!(c&&0==u));)u+=["(","["].includes(l[d]),u-=[")","]"].includes(l[d]),c|=u,d+=1;c&&0==u&&(s=d-1+r,i=En(i,"\\",a+h),h+=1,n?(i=En(i,"{",r+h),h+=1,i=En(i,"}",s+1+h),h+=1):(i=Cn(i,"{",r+h),i=Cn(i,"}",s+h)))}return i}function _n(e,t){const n=["(","["],i=[")","]"];let o=yn(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=Cn(e,n[o],a),o+=1,o=yn(o,n.length)):i.includes(e[a])&&(o-=1,o=yn(o,n.length),e=Cn(e,i[o],a));return e}function yn(e,t){return(e%t+t)%t}function Cn(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function En(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Dn(e){return e=e.replace(/\s+/g,"  ").trim()}function Tn(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=Oe[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);Oe[e]=Oe[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),Zt(Se),xn(),Pt(),(ti()||Pe)&&(Pe=!1,ai())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)We.push(e),Oe[e]="",n=Se.add(Oe,e).name(""),ro(n.domElement),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=We.indexOf(e);let n=Dn(Oe[We.at(t)]);if(""==n);else{let e=Tn(We.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);if(i){let t=i[1];po(t),e.lastName=t,je[t]=e}Qe+=1;let o="params"+Qe;this.remove(),Tn(o,!0),xn(),(ti()||Pe)&&(Pe=!1,ai())}}));else{n=Se.add(Oe,e).name(""),ro(n.domElement),n.domElement.classList.add("params");const t=Oe[e].match(/\s*(\w+)\s*=/);if(t){let e=t[1];po(e),n.lastName=e,je[e]=n}n.onFinishChange((function(){let t=Dn(Oe[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=We.indexOf(e);We.splice(t,1),delete Oe[e],n.hasOwnProperty("lastName")&&!Qn(n.lastName)&&delete O[n.lastName]}else{i();const e=ri(t).match(/\s*(\w+)\s*=/);if(e){let t=e[1];po(t),n.hasOwnProperty("lastName")&&n.lastName!=t&&!Qn(n.lastName)&&(delete O[n.lastName],n.lastName=t,je[t]=n)}}xn(),ti()&&ai()})),xn(),ti()&&ai()}return i(),n}function xn(){H.kineticParams=Object.values(Oe).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function Rn(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function Fn(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function $n(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function An(){if(H.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+mi(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==H.whatToPlot?($("#minLabel").html("$"+rt[0]+"$"),$("#midLabel").html("$"+rt[1]+"$"),$("#maxLabel").html("$"+rt[2]+"$")):$e?$("#midLabel").html(H.views[H.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+Sn(H.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),Jn(),Vn()}else $("#colourbar").hide()}function Vn(){if("MAX"!=H.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[Un(e,n),Un(t,n)]}(H.minColourValue,H.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=li(mi(0)),t=li(mi(.5)),n=li(mi(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function Pn(e,t){return e.toPrecision(t)}function Un(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function Mn(){H.timeDisplay?($("#timeDisplay").show(),kn()):$("#timeDisplay").hide(),Ln()}function kn(){if(H.timeDisplay){let e=Pn(O.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/,"  10<sup>$2$3<sup>"),$("#timeValue").html(e),Hn()}}function qn(){if(H.integrate){$("#integralDisplay").show();let e="";1==H.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+Sn(H.whatToPlot)+"\\,\\d x",1==H.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();Ln()}function In(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function Ln(){H.integrate&&H.timeDisplay?In("#timeDisplay",10):In("#timeDisplay",0)}function Nn(){let e=hn();!Fe||isFinite(e[0])&&isFinite(e[1])?se=setTimeout(Nn,1e3):(Fe=!1,Fn("#oops_hit_nan"),Nt(),$("#erase").one("pointerdown",(function(){$n("#oops_hit_nan"),Fe=!0,window.clearTimeout(se),se=setTimeout(Nn,1e3)})))}function Bn(){if(!ot){try{s.readRenderTargetPixels(h,0,0,de,he,et)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}ot=!0}}function Hn(){if(H.colourbar&&(H.integrate||H.timeDisplay)){let e,t=$("#colourbar")[0].getBoundingClientRect();e=H.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(In("#dataContainer",40),Ve=!0):Ve&&(In("#dataContainer",0),Ve=!1)}}function On(){Wn()?(we.forEach((e=>{e.texture.magFilter=THREE.NearestFilter})),h.texture.magFilter=THREE.NearestFilter,f.texture.magFilter=THREE.NearestFilter):(we.forEach((e=>{e.texture.magFilter=THREE.LinearFilter})),h.texture.magFilter=THREE.LinearFilter,f.texture.magFilter=THREE.LinearFilter),pn()}function Wn(){return n||H.forceManualInterpolation}function jn(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function Qn(e,t){return null==t&&(t=[]),function(e){return[...(RDShaderTop()+RDShaderUpdateCross()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e).concat(["I_T","I_TR","I_TG","I_TB","I_TA","I_S","I_SR","I_SG","I_SB","I_SA"])}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function Gn(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function Xn(){"line"==H.plotType?(gi(),H.brushType="vline",$t(),Zt(G),A.visible=!1,U.visible=!0,H.contours=!1,H.emboss=!1,H.vectorField=!1,fo()):(A.visible=!0,U.visible=!1,"surface"==H.plotType?($("#simCanvas").css("outline","2px #000 solid"),Le&&(Le=!1,wt()),H.vectorField=!1,fo()):$("#simCanvas").css("outline","")),M.visible=H.overlay&&"line"==H.plotType,At(),_t(),pn(),vo()}function zn(){Te||(1!=H.dimension&&"line"==H.plotType&&(H.plotType="plane",Ui("plotType"),Xn()),1==H.dimension&&"line"!=H.plotType&&(H.plotType="line",H.vectorField=!1,Ui("plotType"),Xn())),1==H.dimension&&(H.minY="0.0"),St(),Gt(),vn(),pn(),qn()}function Yn(){const e="line"==H.plotType?0:H.cameraTheta,t="line"==H.plotType?0:H.cameraPhi,n=(new THREE.Vector3).setFromSphericalCoords(1,Math.PI/2-e*Math.PI/180,-t*Math.PI/180);i.position.set(n.x,n.y,n.z),i.lookAt(0,0,0)}function Jn(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function Zn(){return H.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function Kn(e){return ri(e)}function ei(){const e=/^\s*([a-zA-Z]\w*)\b/;let t=[];return Zn().split(";").filter((e=>e.length>0)).forEach((function(n){n.match(e)&&t.push(n.match(e)[1].trim())})),t}function ti(){Zn().split(";").filter((e=>e.length>0));const e=function(e){let t={},n={},i=[];const o=function(){const e=/^\s*([a-zA-Z]\w*)\b\s*=\s*(.*)/;let t=[];return Zn().split(";").filter((e=>e.length>0)).forEach((function(n){const i=n.match(e);i?t.push([i[1].trim(),i[2].trim()]):xi("Unable to evaluate the parameter definition '"+n+"'. Please check for syntax errors.")})),t}(),a=o.map((e=>e[0]));o.forEach((e=>t[e[0]]=e[1]));for(const e of o){let[o,r]=e;o in n||([n,,i]=oi(o,t,n,[o],a,[]))}i.length>0&&xi("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.");return Object.keys(n).map((e=>[e,n[e]]))}(),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}(ei());if(t.length>0)return xi("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=ni(t[0],t[1]);n|=e,i|=o}return n&&!i}function ni(e,t){let n=!1,i=!1;const o=Kn(e);return Qn(o)?(xi("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!O.hasOwnProperty(o),O[o]={type:"float",value:t}),[n,i]}function ii(){return Kn(ei().map((e=>"uniform float "+e+";")).join("\n"))}function oi(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const s of o)r=new RegExp("\\b"+s+"\\b","g"),r.test(t[e])&&(i.includes(s)?(n[s]=0,t[s]="0",t[e]="0",a.push(i.slice(i.indexOf(s)))):([n,,a]=oi(s,t,n,[...i,s],o,a),t[e]=t[e].replaceAll(r,n[s].toString())));try{n[e]=ht.evaluate(t[e])}catch(t){xi("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function ai(){Gt(),rn(),$t(),cn(),Ft(),fn()}function ri(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+at[e])););return n}function si(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function li(e){return e.reduce(((e,t)=>e+t),0)/3}function ui(){let e=hn();H.minColourValue=e[0],H.maxColourValue=e[1],O.maxColourValue.value=H.maxColourValue,O.minColourValue.value=H.minColourValue,ye.maxColourValue.updateDisplay(),ye.minColourValue.updateDisplay(),Vn()}function ci(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function di(){let e;null!=rt&&(e=rt);const t=H.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,Ge.length),n=t.concat(ze.slice(t.length)),i=ei();let o;for(var a=0;a<n.length;a++)if(Qn(n[a],i))return o=i.includes(n[a])?"as a parameter":"under the hood",void xi("The name '"+n[a]+"' is used "+o+", so can't be used as a species name. Please use a different name for "+n[a]+".");rt=n,st=rt.map((e=>"f_{"+e+"}")),function(){lt=[];for(let e=0;e<rt.length;e++)lt.push("(?:"+rt.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let r={...getDefaultTeXLabelsDiffusion(),...getDefaultTeXLabelsBCsICs()};if(Object.keys(r).forEach((function(e){ct[e]=Sn(hi(r[e],Ge,rt,"_(?:[xy][xybf]?)"))})),r=getDefaultTeXLabelsReaction(),Object.keys(r).forEach((function(e){ct[e]=Sn(hi(r[e],Xe,st))})),Te)return;const s=["initCond_1","initCond_2","initCond_3","initCond_4","kineticParams"];Object.keys(H).forEach((function(t){ft.includes(t)&&(s.includes(t)||(H[t]=hi(H[t],e,rt,"_(?:[xy][xybf]?)")))})),H.views=H.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){ft.includes(i)&&(n[i]=hi(t[i],e,rt,"_(?:[xy][xybf]?)"))})),n})),Object.keys(j).forEach((function(t){ft.includes(t)&&(s.includes(t)||(j[t]=hi(j[t],e,rt,"_(?:[xy][xybf]?)")))})),j.views=j.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){ft.includes(i)&&(n[i]=hi(t[i],e,rt,"_(?:[xy][xybf]?)"))})),n})),gn(),pn(),ai(),vn()}function hi(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function fi(e,t){let n,i=e.geometry.attributes.instanceStart,o=e.geometry.attributes.instanceEnd;for(let e=0;e<t.length;e++)n=t[e].toArray(),n[1]*=H.threeDHeightScale*me/pe,e<t.length&&i.setXYZ(e,n[0],n[1],0),e>0&&o.setXYZ(e-1,n[0],n[1],0);i.needsUpdate=!0,o.needsUpdate=!0}function mi(e){e=e.clamp(0,1);let t=0;for(;e>=B[t+1]&&t<N.length-2;)t+=1;return B[t+1]==B[t]?N[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=pi(e[o],t[o],n);return i}(N[t],N[t+1],(e-B[t])/(B[t+1]-B[t])).map((e=>e.clamp(0,1)))}function pi(e,t,n){return(1-(n=n.clamp(0,1)))*e+n*t}function gi(){C.linewidth=.01*H.lineWidthMul,E.linewidth=.01*H.overlayLineWidthMul,C.needsUpdate=!0,E.needsUpdate=!0}function bi(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function vi(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function Si(e){e.forEach((function(e){De.add(e)})),vn()}function wi(e){e.forEach((function(e){De.delete(e)})),vn()}function _i(){tt=new Float32Array(de*he*4),s.readRenderTargetPixels(we[1],0,0,de,he,tt),Di(tt),Me=!0}function yi(){Me||_i();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([de,he]),tt])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function Ci(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);Di(e.slice(2),e.slice(0,2)),Ei(p),Me=!0,Ht()},t.readAsArrayBuffer(e)}function Ei(e){if(null!=e)if("crop"==H.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=l/t;i>1&&(n=t/l,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function Di(e,t){null!=p&&p.dispose(),null==t&&(t=[de,he]),p=new THREE.DataTexture(e,t[0],t[1],THREE.RGBAFormat,THREE.FloatType),p.needsUpdate=!0,p.magFilter=n?THREE.NearestFilter:THREE.LinearFilter,null!=x&&(x.map=p,x.needsUpdate)}function Ti(){s.setSize(Math.round(devicePixelRatio*be),Math.round(devicePixelRatio*ve),!1)}function xi(e){Nt(),Te&&xe||(xe=!0,$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),Fn("#error")))}function Ri(e){if(/\(\s*\)/.test(e))return xi("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(xi("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(xi("A binary operator is missing an operand in "+e.trim()+"."),!1)}function Fi(){let e;$("#views_list").empty();for(let t=0;t<H.views.length;t++)e=document.createElement("a"),e.onclick=function(){H.activeViewInd=t,$i(H.views[t])},e.innerHTML="<div class='view_label'>"+H.views[t].name+"</div>",t==H.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);ke=Math.max(H.views.length,ke),H.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),H.views.length}function $i(e,t){Object.assign(H,e),delete H.name,Zt(X),(null==t||t)&&(cn(),Xn(),At(),yt(),Vn(),An(),fo(),to(),Pt())}function Ai(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",H.views[H.activeViewInd].name);null!=e&&(H.views[H.activeViewInd].name=e,Fi(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function Vi(){H.views.length>1?(H.views.splice(H.activeViewInd,1),H.activeViewInd<1?H.activeViewInd=0:H.activeViewInd-=1):H.views[H.activeViewInd].name="Custom",$i(H.views[H.activeViewInd])}function Pi(){let e={};return dt.forEach((function(t){e[t]=j[t]})),e}function Ui(e){H.activeViewInd<H.views.length&&(H.views[H.activeViewInd][e]=H[e])}function Mi(e,t){let n="";return n+=tn(RDShaderDirichletX(t),rt[e]),H.dimension>1&&(n+=tn(RDShaderDirichletY(t),rt[e])),n}function ki(e,t){let n="";return n+=tn(RDShaderRobinX(t),rt[e]),H.dimension>1&&(n+=tn(RDShaderRobinY(t),rt[e])),n}function qi(e,t){let n="";return n+=tn(RDShaderRobinCustomDomainX(t,jt(H.domainIndicatorFun)),rt[e]),H.dimension>1&&(n+=tn(RDShaderRobinCustomDomainY(t,jt(H.domainIndicatorFun)),rt[e])),n}function Ii(e,t){let n="";return n+=tn(RDShaderDirichletX(t).replaceAll(/updated/g,"gl_FragColor"),rt[e]),H.dimension>1&&(n+=tn(RDShaderDirichletY(t).replaceAll(/updated/g,"gl_FragColor"),rt[e])),n}function Li(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function Ni(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function Bi(e,t,n,i,o,a,r,s){const l=document.createElement("a");if(l.classList.add("toggle_button"),l.setAttribute("property",t),null==i&&(i=()=>{}),l.onclick=function(){H[l.getAttribute("property")]=!H[l.getAttribute("property")],ao(l),i()},null!=o&&(l.id=o),null!=a&&(l.title=a),null!=n&&(l.innerHTML=n),null!=r&&l.setAttribute("folderID",r),null!=s)for(const e of s)l.classList.add(e);return e.appendChild(l),ao(l),l}function Hi(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function Oi(){const e=Object.assign(getPreset("default"),getPreset(H.parent));let t=dn(H,e);1==H.views.length&&"1"==H.views[0].name&&delete t.views;for(const e of Object.keys(H.views[0]))H.hasOwnProperty(e)&&H.views.map((t=>t[e])).every((t=>t==H[e]))&&H.views.forEach((t=>delete t[e]));t.preset="PRESETNAME";let n=JSON.stringify(t).replaceAll(/(:[^:]*),/g,"$1,\n\t").replaceAll(":",": ").replaceAll("  "," ").replaceAll("{","{\n\t").replaceAll("}",",\n}");n='listOfPresets["PRESETNAME"] = '+n+";\n",navigator.clipboard.writeText(n)}function Wi(){let t="";t+=JSON.stringify(H),t+=JSON.stringify(O),t+=JSON.stringify({nXDisc:de,nYDisc:he,domainHeight:me,domainWidth:fe,aspectRatio:l,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(t)}function ji(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function Qi(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function Gi(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function Xi(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function zi(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function Yi(){let e=dn(H,getPreset("default"));return e.preset="Custom",e=minifyPreset(e),[location.href.replace(location.search,""),"?options=",LZString.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function Ji(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function Zi(e){const t=je[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function Ki(){O.embossAmbient.value=H.embossAmbient,O.embossDiffuse.value=H.embossDiffuse,O.embossShiny.value=H.embossShiny,O.embossSmoothness.value=H.embossSmoothness,O.embossSpecular.value=H.embossSpecular,O.embossLightDir.value=new THREE.Vector3(Math.sin(H.embossTheta)*Math.cos(H.embossPhi),Math.sin(H.embossTheta)*Math.sin(H.embossPhi),Math.cos(H.embossTheta))}function eo(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function to(){for(const e of[...Ee,...Ce]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function no(){O.contourColour.value=new THREE.Color(H.contourColour),O.contourEpsilon.value=H.contourEpsilon,O.contourStep.value=1/(H.contourNum+1)}function io(){O.overlayColour.value=new THREE.Color(H.overlayColour),O.overlayEpsilon.value=H.overlayEpsilon,O.overlayLine.value=H.overlay&&"line"==H.plotType,E.color=new THREE.Color(H.overlayColour),E.needsUpdate=!0}function oo(){ie||Pt()}function ao(e){H[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function ro(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function so(){H.customSurface?b.vertexShader=surfaceVertexShaderCustom():b.vertexShader=surfaceVertexShaderColour(),b.needsUpdate=!0}function lo(){"surface"==H.plotType?($(Y).show(),H.customSurface?(ye.surfaceFun.show(),ye.threeDHeightScale.hide()):(ye.surfaceFun.hide(),ye.threeDHeightScale.show())):($(Y).hide(),ye.surfaceFun.hide())}function uo(){L=new THREE.Group,a.add(L);const e=Math.max(de,he),t=Math.round(pi(3,window.width<629?20:64,H.arrowDensity));let n=Math.max(Math.floor(e/t),1);const i=Math.floor(de/n),o=Math.floor(he/n),r=Math.floor((de-n*(i-1))/2),s=Math.floor((he-n*(o-1))/2);let l,u,c,d,h,f;for(let e=0;e<o;e++){u=s+e*n,f=((u+.5)/he-.5)*A.geometry.parameters.height;for(let e=0;e<i;e++)c=r+e*n,h=((c+.5)/de-.5)*A.geometry.parameters.width,l=c+u*de,d=co([h,f,1],[0,0,0]),d.ind=l,L.add(d)}}function co(e,t){const n=new THREE.Group,i=new THREE.Mesh(R,D);i.rotation.x=Math.PI/2;const o=new THREE.Mesh(F,D);return o.rotation.x=Math.PI/2,o.rotation.y=Math.PI/4,o.position.z=R.parameters.height/2,n.add(i),n.add(o),n.scale.multiplyScalar(He),n.position.set(e[0],e[1],e[2]),n.lookAt(e[0]+t[0],e[1]+t[1],e[2]+t[2]),n}function ho(){if(L)for(a.remove(L);L.children.length;)L.remove(L.children[0])}function fo(){if(O.vectorField.value=H.vectorField,H.vectorField){if(ho(),uo(),mo(),"relative"==H.arrowScale)try{L.customMax=ht.evaluate(H.arrowLengthMax)}catch(e){xi("Unable to evaluate the maximum arrow length. Please check the definition."),L.customMax=1}}else ho()}function mo(){D.color=new THREE.Color(H.arrowColour)}function po(e){const t=Qn(e,rt.concat(st));return t&&xi("The name '"+e+"' is already in use, so can't be used as a parameter name. Please use a different name for "+e+"."),!t}function go(e){return e=(e=e.replaceAll(/\bMINX\b/g,(()=>jt(H.minX)))).replaceAll(/\bMINY\b/g,(()=>jt(H.minY)))}function bo(e,t,n,i,o){if(e in t)return[t,n.slice(0,-1),o];for(const a of i[e])n.includes(a)?o.push(n.slice(n.indexOf(a))):[t,,o]=bo(a,t,[...n,a],i,o);return t[e]=!0,[t,n.slice(0,-1),o]}function vo(){if($("#simCanvas").css("cursor","auto"),H.brushEnabled&&"surface"!=H.plotType&&"line"!=H.plotType)switch(H.brushType){case"circle":$("#simCanvas").css("cursor","url('images/cursor-circle.svg') 12 12, auto");break;case"hline":$("#simCanvas").css("cursor","url('images/cursor-hline.svg') 32 32, auto");break;case"vline":$("#simCanvas").css("cursor","url('images/cursor-vline.svg') 32 32, auto")}}function So(e){return/^\s*$/.test(e)}bt&&Yt("GrayScott"),$e=gt.has("story"),$e&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),ee.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),An(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),ue=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),(Rn()||bt||H.forceTryClickingPopup)&&!H.suppressTryClickingPopup&&H.brushEnabled&&($("#top_message").html("<p>"+H.tryClickingText+"</p>"),Fn("#top_message"),setTimeout((()=>$n("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>$n("#top_message")))),$("#settings").click((function(){ji(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&Xi(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&zi(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&Qi(),$("#views_ui").is(":visible")&&Gi()),$("#left_ui").is(":visible")&&si()})),$("#equations").click((function(){Qi(),si(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&ji(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&Gi()})),$("#pause").click((function(){Nt()})),$("#play").click((function(){Bt()})),$("#erase").click((function(){Ht()})),$("#share").click((function(){zi(),$("#help_panel").is(":visible")&&Xi()})),$("#help").click((function(){Xi(),$("#share_panel").is(":visible")&&zi()})),$("#screenshot").click((function(){it=!0,Pt(),zi()})),$("#link").click((function(){W.copyConfigAsURL(),zi()})),$("#embed").click((function(){!function(){let e=Yi();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}Ji('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),zi()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){Xi()})),$("#views").click((function(){Gi(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&ji(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&Qi()})),$("#error_close_button").click((function(){$n("#error")})),$("#oops_hit_nan_close").click((function(){$n("#oops_hit_nan"),Fe=!0})),$(document).on("click","#add_view",(function(){!function(){let e=Pi();e.name=++ke,H.views.push(e),H.activeViewInd=H.views.length-1,Fi()}()})),Te=!1,function e(){requestAnimationFrame(e),ae=oe,oe&&H.brushEnabled&&function(){!H.setSeed&&H.brushValue.includes("RAND")&&an();V.material=v;for(let e=1;e<we.length;e++)O.textureSource.value=we[e].texture,s.setRenderTarget(we[e-1]),s.render(r,o);we.rotate(-1)}();if(ie){!re||function(){V.material=S;for(let e=1;e<we.length;e++)O.textureSource.value=we[e].texture,s.setRenderTarget(we[e-1]),s.render(r,o);we.rotate(-1)}();for(let e=0;e<H.numTimestepsPerFrame;e++){if(H.autoPause&&Re&&O.t.value>=H.autoPauseAt){Re=!1,Nt();break}Ae&&!H.setSeed&&an(),Vt()}}(ae||ie)&&Pt()}()}();