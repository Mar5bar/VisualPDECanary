let e,t,n,i,o,a,r,l,s,u,c,d,f,p,m,h,g,b,v,S,y,w,C,V,x,U,_,F,E,D,A,T,W,R,Q,k,P,I,N,L,M,O,q,B,j,G,z,J,H,X,Z,Y,K,ee,te,ne,ie,oe,ae,re,le,se,ue,ce,de,fe,pe,me,he,ge,be,ve,Se,ye,we,Ce,Ve,xe,Ue,$e,_e,Fe,Ee,De,Ae,Te,We,Re,Qe,ke,Pe,Ie,Ne,Le,Me,Oe,qe,Be,je,Ge,ze,Je,He,Xe,Ze,Ye,Ke,et,tt,nt,it,ot,at,rt,lt,st,ut,ct,dt,ft,pt,mt,ht,gt,bt,vt=[],St={},yt=[],wt=[],Ct=new Set,Vt=!1,xt=!1,Ut=!1,$t=!1,_t=!1,Ft=!1,Et=0,Dt=!1,At=!0,Tt=1,Wt=1,Rt={},Qt=[],kt={},Pt=0;const It=["u","v","w","q"],Nt=["UFUN","VFUN","WFUN","QFUN"],Lt=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"],Mt=["REACT1","REACT2","REACT3","REACT4"];let Ot,qt,Bt,jt,Gt,zt,Jt=!1,Ht=!1;const Xt=["zero","one","two","three","four","five","six","seven","eight","nine"];import{drawShaderTop as Zt,drawShaderBotReplace as Yt,drawShaderBotAdd as Kt,drawShaderShapeDisc as en,drawShaderShapeVLine as tn,drawShaderShapeHLine as nn,drawShaderFactorSharp as on,drawShaderFactorSmooth as an}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as rn,computeDisplayFunShaderMid as ln,computeMaxSpeciesShaderMid as sn,postGenericShaderBot as un,postShaderDomainIndicator as cn,interpolationShader as dn}from"./post_shaders.js";import{copyShader as fn}from"../copy_shader.js";import{RDShaderTop as pn,RDShaderBot as mn,RDShaderDirichletX as hn,RDShaderDirichletY as gn,RDShaderDirichletIndicatorFun as bn,RDShaderRobinX as vn,RDShaderRobinY as Sn,RDShaderUpdateNormal as yn,RDShaderUpdateCross as wn,RDShaderAlgebraicSpecies as Cn,RDShaderEnforceDirichletTop as Vn,RDShaderAdvectionPreBC as xn,RDShaderAdvectionPostBC as Un,RDShaderDiffusionPreBC as $n,RDShaderDiffusionPostBC as _n,RDShaderGhostX as Fn,RDShaderGhostY as En,RDShaderMain as Dn}from"./simulation_shaders.js";import{randShader as An,randNShader as Tn}from"../rand_shader.js";import{fiveColourDisplayTop as Wn,fiveColourDisplayBot as Rn,embossShader as Qn,contourShader as kn,surfaceVertexShaderColour as Pn,surfaceVertexShaderCustom as In,overlayShader as Nn}from"./display_shaders.js";import{getColours as Ln}from"../colourmaps.js";import{genericVertexShader as Mn}from"../generic_shaders.js";import{getPreset as On,getUserTextFields as qn,getFieldsInView as Bn}from"./presets.js";import{clearShaderBot as jn,clearShaderTop as Gn}from"./clear_shader.js";import*as zn from"../three.module.min.js";import{OrbitControls as Jn}from"../OrbitControls.js";import{Line2 as Hn}from"../lines/Line2.js";import{LineMaterial as Xn}from"../lines/LineMaterial.js";import{LineGeometry as Zn}from"../lines/LineGeometry.js";import{minifyPreset as Yn,maxifyPreset as Kn}from"./minify_preset.js";import{LZString as ei}from"../lz-string.min.js";import{equationTEXFun as ti,getDefaultTeXLabelsDiffusion as ni,getDefaultTeXLabelsReaction as ii,getDefaultTeXLabelsBCsICs as oi,substituteGreek as ai}from"./TEX.js";let ri,li,si,ui=ti(),ci={...ni(),...ii(),...oi()};const di=Bn();let fi=new exprEval.Parser;fi.consts.pi=Math.PI,fi.consts.Pi=Math.PI,fi.consts.e=Math.exp(1),k={};const pi=qn();var mi,hi;I={reset:function(){Oi()},toggleRunning:function(){nt?Li():Mi()},copyConfigAsURL:function(){Ya(Za())},saveSimState:function(){Ca()},exportSimState:function(){Va()},clearCheckpoints:function(){Ft&&(h.dispose(),h=null,Ft=!1)},restoreCurrentView:function(){var e;k.activeViewInd<k.views.length&&(e=k.activeViewInd,k.views[e]=st[e],Aa(k.views[e]))}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(mi=Array.prototype.push,hi=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,mi.apply(this,hi.call(this,0,e)),this}),Array.prototype.last=function(){return this[this.length-1]},e=document.getElementById("simCanvas"),console.error=function(e){$t=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),Fa(t)},Do()||$("#logo").hide();const gi=new URLSearchParams(window.location.search);if(gi.has("no_ui")?($(".ui").addClass("hidden"),_t=!0):$(".ui").removeClass("hidden"),gi.has("logo_only")&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),_t=!0),gi.has("sf")&&(Wt=parseFloat(gi.get("sf")),(isNaN(Wt)||Wt<=0)&&(Wt=1)),!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("warning"==e[t].split("=")[0].trim())return!0}return!1}()&&!_t){$("#warning").css("display","block");await Promise.race([zo(document.getElementById("warning_ok"),"click",!0),zo(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="warning=true;"+t+";path=/"}(),$("#warning").css("display","none")}Zi("default"),function(){P={brushCoords:{type:"v2",value:new zn.Vector2(.5,.5)},colour1:{type:"v4",value:new zn.Vector4(0,0,0,0)},colour2:{type:"v4",value:new zn.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new zn.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new zn.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new zn.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0}},it=!1,c=new zn.Raycaster,d=new zn.Vector2,l=new zn.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),l.autoClear=!0,t=l.getContext(),n=!(t.getExtension("OES_texture_float_linear")&&t.getExtension("EXT_float_blend")),m={format:zn.RGBAFormat,type:zn.FloatType,minFilter:zn.NearestFilter},n|=/android/i.test(navigator.userAgent),m.magFilter=n?zn.NearestFilter:zn.LinearFilter,vt.push(new zn.WebGLRenderTarget(k.maxDisc,k.maxDisc,m)),vt.push(vt[0].clone()),vt.push(vt[0].clone()),vt.push(vt[0].clone()),vt.push(vt[0].clone()),f=vt[0].clone(),p=vt[0].clone(),vt.forEach((e=>{e.texture.wrapS=zn.RepeatWrapping,e.texture.wrapT=zn.RepeatWrapping})),f.texture.wrapS=zn.ClampToEdgeWrapping,f.texture.wrapT=zn.ClampToEdgeWrapping,p.texture.wrapS=zn.ClampToEdgeWrapping,p.texture.wrapT=zn.ClampToEdgeWrapping,i=new zn.OrthographicCamera(-.5,.5,.5,-.5,-1,10),u=new Jn(i,e),u.listenToKeyEvents(document),u.addEventListener("change",(function(){"surface"==k.plotType&&(k.cameraTheta=90-180*Math.acos(i.position.y)/Math.PI,k.cameraPhi=-180*Math.atan2(i.position.x,i.position.z)/Math.PI,k.cameraZoom=i.zoom,Qa("cameraTheta"),Qa("cameraPhi"),Qa("cameraZoom"),Yi(O),ar())})),o=new zn.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new zn.Scene,r=new zn.Scene,a.add(i),a.background=new zn.Color(k.backgroundColour),g=new zn.MeshBasicMaterial({side:zn.DoubleSide}),b=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn(),transparent:!0,side:zn.DoubleSide}),C=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn()}),x=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn(),fragmentShader:dn()}),v=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn()}),St.FE=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn()}),St.AB2=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn()});for(let e=1;e<3;e++)St["Mid"+e.toString()]=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn()});for(let e=1;e<5;e++)St["RK4"+e.toString()]=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn()});w=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn(),fragmentShader:fn()}),y=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn()}),S=new zn.ShaderMaterial({uniforms:P,vertexShader:Mn()}),V=new Xn({vertexColors:!0,linewidth:.01}),U=new zn.MeshBasicMaterial;const s=new zn.PlaneGeometry(1,1);F=new zn.Mesh(s,St[0]),F.position.z=0,r.add(F),xi(),Ui(),wi(),_i(),Si(),Fi(),bo(),So(),Di(),Ei(),lo(),jo(),Oi(),e.addEventListener("pointerdown",Qi),e.addEventListener("pointerup",ki),e.addEventListener("pointermove",Pi),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(I.toggleRunning(),e.preventDefault()),"h"===e.key&&(_t?(_t=!1,$(".ui").removeClass("hidden"),Ke.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",ut),nt?Mi():Li(),Bo(),Ko(),ua()):(_t=!0,$(".ui").addClass("hidden"))),"s"==e.key&&Ca(),"c"==e.key&&(k.resetFromCheckpoints=!k.resetFromCheckpoints,rr($("#checkpointButton")[0])))})),window.addEventListener("resize",Si,!1),window.addEventListener("message",Ka),$("#checkpointInput").change((function(){xa(this.files[0]),this.value=null}))}();let bi=!0;if(gi.has("preset")&&(Xi(gi.get("preset")),bi=!1),gi.has("options")){var vi=JSON.parse(ei.decompressFromEncodedURIComponent(gi.get("options")));vi.hasOwnProperty("p")&&(vi=Kn(vi)),Xi(vi),bi=!1}function Si(){xi(),function(){F.material=w;for(let e=1;e<vt.length;e++)P.textureSource.value=vt[e].texture,vt[e-1].setSize(ct,dt),l.setRenderTarget(vt[e-1]),l.render(r,o);vt.rotate(-1),vt[0].dispose(),vt[0]=vt[1].clone(),f.setSize(ct,dt),Ri(),p.setSize(Math.round(devicePixelRatio*ht),Math.round(devicePixelRatio*gt))}(),Ua(h),Ci(),yi(),wi(),Ko(),ua(),Wi()}function yi(){_.geometry.dispose(),a.remove(_),E.geometry.dispose(),a.remove(E),D.geometry.dispose(),a.remove(D),Ui()}function wi(){switch(Vi(),k.plotType){case"line":k.cameraTheta=0,k.cameraPhi=0,u.enabled=!1,i.zoom=1,Yo(),b.vertexShader=Pn();break;case"plane":u.enabled=!1,u.reset(),b.vertexShader=Mn();break;case"surface":u.enabled=!0,i.zoom=k.cameraZoom,Yo(),sr()}b.needsUpdate=!0,i.left=-ft/(2*mt),i.right=ft/(2*mt),i.top=pt/(2*mt),i.bottom=-pt/(2*mt),i.updateProjectionMatrix(),$i()}function Ci(){P.L.value=Tt,P.L_y.value=pt,P.L_x.value=ft,P.L_min.value=Math.min(pt,ft),P.dt.value=k.dt,P.dx.value=ft/ct,P.dy.value=pt/dt,P.heightScale.value=k.threeDHeightScale,P.maxColourValue.value=k.maxColourValue,P.minColourValue.value=k.minColourValue,P.customSurface.value=k.customSurface,er(),k.fixRandSeed||ro()}function Vi(){try{Tt=fi.evaluate(k.domainScale)}catch(e){Fa("Unable to evaluate the domain length. Please check the definition."),Tt=100}ht=Math.round(e.getBoundingClientRect().width),gt=Math.round(e.getBoundingClientRect().height),s=gt/ht,s<=0&&(s=.1),s>=1?(pt=Tt,ft=pt/s):(ft=Tt,pt=ft*s),1==k.dimension&&(ft=Tt),P.L_x.value=ft,P.L_y.value=pt,mt=Math.max(ft,pt)}function xi(){Vi();let e=Tt/100;try{e=fi.evaluate(k.spatialStep)}catch(e){Fa("Unable to evaluate the spatial step. Please check the definition.")}e<=0&&(Fa("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),e=Tt/100),ct=Math.floor(ft/e),dt=Math.floor(pt/e),0==ct&&(ct=1),0==dt&&(dt=1),1==k.dimension&&(dt=1),P.nXDisc.value=ct,P.nYDisc.value=dt,A=new Array(ct),T=new Array(ct);let t=-.5,n=1/ct;for(let e=0;e<A.length;e++)A[e]=t,t+=n;_a(),Gt=new Float32Array(ct*dt*4),Ht=!1}function Ui(){Vi();let e=[1,1];At||(e=[ct,dt]);const t=new zn.PlaneGeometry(ft/mt,pt/mt,e[0],e[1]);_=new zn.Mesh(t,b),_.position.z=0,_.visible="line"!=k.plotType,_.matrixAutoUpdate=!1,a.add(_);const n=new zn.PlaneGeometry(ft/mt,pt/mt,1,1);E=new zn.Mesh(n,g),E.position.z=0,E.visible=!1,E.matrixAutoUpdate=!1,a.add(E),$i();const i=new Zn;W=Math.round(devicePixelRatio*ht);const o=new Array(3*W).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),D=new Hn(i,V),D.scale.set(1,1,1),D.visible="line"==k.plotType,a.add(D)}function $i(){switch(k.plotType){case"plane":_.rotation.x=0,E.rotation.x=0;break;case"surface":_.rotation.x=-Math.PI/2,E.rotation.x=-Math.PI/2}_.updateMatrix(),E.updateMatrix()}function _i(){k.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Fi(e){L=new dat.GUI({closeOnTop:!0,autoPlace:!1}),L.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(L.domElement),M=new dat.GUI({closeOnTop:!0,autoPlace:!1}),M.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(M.domElement),O=new dat.GUI({closeOnTop:!0,autoPlace:!1}),O.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(O.domElement),L.open(),M.open(),O.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),q=M.addFolder("Brush");Oa(La(q),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',null,null,"Toggle the brush on or off"),q.add(k,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange(Di),B=q.add(k,"typeOfBrush",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange(Di),q.add(k,"brushValue").name("Value").onFinishChange(Di),q.add(k,"brushRadius").name("Radius").onFinishChange(Di),me=q.add(k,"whatToDraw",ri).name("Species").onChange(Di),q=M.addFolder("Domain"),q.add(k,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){Zo(),ar()})),q.add(k,"domainScale").name("Largest side").onFinishChange(Si),q.add(k,"spatialStep").name("Space step").onFinishChange(Si);const t=La(q);Oa(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){_i(),Si(),wi()}),null,"Use a square domain"),Oa(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Implicit',(function(){vo(),bo(),zi(),ho()}),null,"Determine the domain implicitly"),X=q.add(k,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){vo(),bo(),zi(),fo()})),q=M.addFolder("Timestepping"),je=q.add(k,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),tr(je,1,400,1),pe=q.add(k,"dt").name("Timestep").onChange((function(){Ci()})),pe.__precision=12,pe.min(0),pe.updateDisplay(),q.add(k,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme");Oa(La(q),"timeDisplay",'<i class="fa-regular fa-stopwatch"></i> Elapsed time',Po,null,"Show/hide time display"),q=M.addFolder("Equations"),q.add(k,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange(So),H=q.add(k,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Dt=!0,So(),Dt=!1})),q.add(k,"speciesNames").name("Species names").onFinishChange((function(){pa()})),q.add(k,"reactionNames").name("Reactions").onFinishChange((function(){pa()}));Oa(La(q),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',So,"cross_diffusion_controller","Toggle cross diffusion"),q=L.addFolder("Definitions");Oa(La(q),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',yo,null,"Typeset the specified equations"),Z=q.add(k,"diffusionStrUU").onFinishChange((function(){zi(),yo()})),va(Z,ya,["D","U","UU"]),Sa(Z,wa,["D","U","UU"]),Y=q.add(k,"diffusionStrUV").onFinishChange((function(){zi(),yo()})),va(Y,ya,["UV"]),Sa(Y,wa,["UV"]),K=q.add(k,"diffusionStrUW").onFinishChange((function(){zi(),yo()})),va(K,ya,["UW"]),Sa(K,wa,["UW"]),ee=q.add(k,"diffusionStrUQ").onFinishChange((function(){zi(),yo()})),va(ee,ya,["UQ"]),Sa(ee,wa,["UQ"]),te=q.add(k,"diffusionStrVU").onFinishChange((function(){zi(),yo()})),va(te,ya,["VU"]),Sa(te,wa,["VU"]),ne=q.add(k,"diffusionStrVV").onFinishChange((function(){zi(),yo()})),va(ne,ya,["V","VV"]),Sa(ne,wa,["V","VV"]),ie=q.add(k,"diffusionStrVW").onFinishChange((function(){zi(),yo()})),va(ie,ya,["VW"]),Sa(ie,wa,["VW"]),oe=q.add(k,"diffusionStrVQ").onFinishChange((function(){zi(),yo()})),va(oe,ya,["VQ"]),Sa(oe,wa,["VQ"]),ae=q.add(k,"diffusionStrWU").onFinishChange((function(){zi(),yo()})),va(ae,ya,["WU"]),Sa(ae,wa,["WU"]),re=q.add(k,"diffusionStrWV").onFinishChange((function(){zi(),yo()})),va(re,ya,["WV"]),Sa(re,wa,["WV"]),le=q.add(k,"diffusionStrWW").onFinishChange((function(){zi(),yo()})),va(le,ya,["W","WW"]),Sa(le,wa,["W","WW"]),se=q.add(k,"diffusionStrWQ").onFinishChange((function(){zi(),yo()})),va(se,ya,["WQ"]),Sa(se,wa,["WQ"]),ue=q.add(k,"diffusionStrQU").onFinishChange((function(){zi(),yo()})),va(ue,ya,["QU"]),Sa(ue,wa,["QU"]),ce=q.add(k,"diffusionStrQV").onFinishChange((function(){zi(),yo()})),va(ce,ya,["QV"]),Sa(ce,wa,["QV"]),de=q.add(k,"diffusionStrQW").onFinishChange((function(){zi(),yo()})),va(de,ya,["QW"]),Sa(de,wa,["QW"]),fe=q.add(k,"diffusionStrQQ").onFinishChange((function(){zi(),yo()})),va(fe,ya,["Q","QQ"]),Sa(fe,wa,["Q","QQ"]),j=q.add(k,"reactionStrU").onFinishChange((function(){zi(),yo()})),va(j,ya,["UFUN"]),Sa(j,wa,["UFUN"]),G=q.add(k,"reactionStrV").onFinishChange((function(){zi(),yo()})),va(G,ya,["VFUN"]),Sa(G,wa,["VFUN"]),z=q.add(k,"reactionStrW").onFinishChange((function(){zi(),yo()})),va(z,ya,["WFUN"]),Sa(z,wa,["WFUN"]),J=q.add(k,"reactionStrQ").onFinishChange((function(){zi(),yo()})),va(J,ya,["QFUN"]),Sa(J,wa,["QFUN"]),bt=L.addFolder("Parameters"),function(){let e,t,n=[],i=k.kineticParams.split(";");for(var o=0;o<i.length;o++)t=_o(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+Pt,Pt+=1,Qt.push(e),Rt[e]=t,n.push(e));for(const e of n)Fo(e,!1);e="param"+Pt,Qt.push(e),Rt[e]=t,Fo(e,!0)}(),q=L.addFolder("Boundary conditions"),Ee=q.add(k,"boundaryConditionsU",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){zi(),ao()})),We=q.add(k,"dirichletStrU").onFinishChange(zi),Me=q.add(k,"neumannStrU").onFinishChange(zi),Ge=q.add(k,"robinStrU").onFinishChange(zi),Pe=q.add(k,"comboStrU").name("Details").onFinishChange(zi),De=q.add(k,"boundaryConditionsV",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){zi(),ao()})),Re=q.add(k,"dirichletStrV").onFinishChange(zi),Oe=q.add(k,"neumannStrV").onFinishChange(zi),ze=q.add(k,"robinStrV").onFinishChange(zi),Ie=q.add(k,"comboStrV").name("Details").onFinishChange(zi),Ae=q.add(k,"boundaryConditionsW",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){zi(),ao()})),Qe=q.add(k,"dirichletStrW").onFinishChange(zi),qe=q.add(k,"neumannStrW").onFinishChange(zi),Je=q.add(k,"robinStrW").onFinishChange(zi),Ne=q.add(k,"comboStrW").name("Details").onFinishChange(zi),Te=q.add(k,"boundaryConditionsQ",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).name("$q$").onChange((function(){zi(),ao()})),ke=q.add(k,"dirichletStrQ").onFinishChange(zi),Be=q.add(k,"neumannStrQ").onFinishChange(zi),He=q.add(k,"robinStrQ").onFinishChange(zi),Le=q.add(k,"comboStrQ").name("Details").onFinishChange(zi),q=L.addFolder("Initial conditions"),Ue=q.add(k,"clearValueU").onFinishChange(lo),$e=q.add(k,"clearValueV").onFinishChange(lo),_e=q.add(k,"clearValueW").onFinishChange(lo),Fe=q.add(k,"clearValueQ").onFinishChange(lo),Xe=M.addFolder("Images"),q=Xe,co(),q=M.addFolder("Checkpoints");const n=La(q);Oa(n,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),qa(n),Ma(n,'<i class="fa-regular fa-flag"></i> Set',Ca,null,"Set a checkpoint at the current state",["narrow"]),Ma(n,'<i class="fa-regular fa-file-arrow-down"></i> Export',Va,null,"Download the last checkpoint as a file",["narrow"]),Ma(n,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),q.add(k,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize"),q=M.addFolder("Misc."),q.addColor(k,"backgroundColour").name("Background").onChange((function(){a.background=new zn.Color(k.backgroundColour),ar()}));const i=La(q);Oa(i,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){No(),ar()}),null,"Compute the integral of the plotted expression over the domain"),Oa(i,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',jo,"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),Oa(i,"fixRandSeed",'<i class="fa-regular fa-shuffle"></i> Fix seed',null,null,"Fix the random seed"),Ma(i,'<i class="fa-regular fa-copy"></i> Copy code',Ba,null,"Copy the simulation configuration as JSON"),q=q.addFolder("Debug");Ma(La(q),"Copy debug information",ja);const o=document.createElement("div");o.innerHTML="Settings",o.classList.add("ui_title"),M.domElement.prepend(o);const r=document.createElement("div");r.innerHTML="Equations",r.classList.add("ui_title"),L.domElement.prepend(r);const l=document.createElement("div");l.id="views_list",O.domElement.prepend(l);const s=document.createElement("div");s.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",s.classList.add("ui_title"),O.domElement.prepend(s),Ke=O.addFolder("Edit view"),q=Ke;const u=La(q,"edit_view_buttons");Ma(u,'<i class="fa-solid fa-pen-nib"></i> Rename',Ta,null,"Rename the current view"),Ma(u,'<i class="fa-solid fa-xmark"></i> Delete',Wa,"deleteViewButton","Delete view"),tt=q.add(k,"whatToPlot").name("Expression: ").onFinishChange((function(){fo(),ar(),Qa(this.property)})),q.add(k,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){Xo(),document.activeElement.blur(),ar(),Qa(this.property)})),q.add(k,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){Ai(),Wo(),Qa(this.property)})).name("Colour map"),we=q.add(k,"minColourValue").name("Min value").onChange((function(){Ci(),Ro(),ar(),Qa(this.property)})),we.__precision=2,Ce=q.add(k,"maxColourValue").name("Max value").onChange((function(){Ci(),Ro(),ar(),Qa(this.property)})),Ce.__precision=2;const c=La(q,"colour_map_buttons");Ma(c,'<i class="fa-solid fa-arrow-right-arrow-left"></i> Flip',(function(){k.flippedColourmap=!k.flippedColourmap,Ai(),Wo(),Qa("flippedColourmap")}),null,"Reverse colour map",["narrow"]),Ma(c,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){da(),Wi(),Qa("minColourValue"),Qa("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),Oa(c,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){Wo(),Qa("colourbar")}),null,"Display the colourbar",null,["narrow"]),qa(c),Oa(c,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){k.autoSetColourRange&&(da(),Wi()),Qa("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),Oa(c,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){Ai(),Qa("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),Oa(c,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){Ai(),Qa("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),Oa(c,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){Ai(),Qa("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),q=Ke.addFolder("Contours"),q.domElement.id="contoursFolder",q.addColor(k,"contourColour").name("Colour").onChange((function(){ir(),ar(),Qa(this.property)})),yt.push(q.add(k,"contourNum").name("Number").onChange((function(){ir(),ar(),Qa(this.property)}))),tr(yt.last(),1,20,1),yt.push(q.add(k,"contourEpsilon").name("Threshold").onChange((function(){ir(),ar(),Qa(this.property)}))),tr(yt.last(),.001,.05,.001),q=Ke.addFolder("Lighting"),q.domElement.id="embossFolder",wt.push(q.add(k,"embossSmoothness").name("Smoothness").onChange((function(){er(),ar(),Qa(this.property)}))),tr(wt.last(),0,2,.001),wt.push(q.add(k,"embossAmbient").name("Ambient").onChange((function(){er(),ar(),Qa(this.property)}))),tr(wt.last(),0,1,.001),wt.push(q.add(k,"embossDiffuse").name("Diffuse").onChange((function(){er(),ar(),Qa(this.property)}))),tr(wt.last(),0,1,.001),wt.push(q.add(k,"embossSpecular").name("Specular").onChange((function(){er(),ar(),Qa(this.property)}))),tr(wt.last(),0,1,.001),wt.push(q.add(k,"embossShiny").name("Precision").onChange((function(){er(),ar(),Qa(this.property)}))),tr(wt.last(),0,100,1),wt.push(q.add(k,"embossTheta").name("Inclination").onChange((function(){er(),ar(),Qa(this.property)}))),tr(wt.last(),0,1.5708,.001),wt.push(q.add(k,"embossPhi").name("Direction").onChange((function(){er(),ar(),Qa(this.property)}))),tr(wt.last(),0,3.1456,.001),q=Ke.addFolder("Overlay"),q.domElement.id="overlayFolder",q.addColor(k,"overlayColour").name("Colour").onChange((function(){or(),ar(),Qa(this.property)})),q.add(k,"overlayExpr").name("Expression").onFinishChange((function(){Ai(),Qa(this.property)})),q.add(k,"overlayEpsilon").name("Threshold").onChange((function(){or(),ar(),Qa(this.property)})),et=Ke.addFolder("3D"),q=et;Oa(La(q),"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){P.customSurface.value=k.customSurface,sr(),ur(),ar(),Qa("customSurface")}),"customSurfaceToggle","Plot the solution on a custom surface"),be=q.add(k,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){fo(),ar(),Qa(this.property)})),ge=q.add(k,"threeDHeightScale").name("Max height").onChange((function(){Ci(),Qa(this.property)})),ve=q.add(k,"cameraTheta").name("View $\\theta$").onChange((function(){wi(),Qa(this.property)})),Se=q.add(k,"cameraPhi").name("View $\\phi$").onChange((function(){wi(),Qa(this.property)})),ye=q.add(k,"cameraZoom").name("Zoom").onChange((function(){wi(),Qa(this.property)})),he=q.add(k,"lineWidthMul",.1,2).name("Thickness").onChange((function(){ba(),Wi(),Qa(this.property)}));document.querySelectorAll("input").forEach((e=>lr(e)))}function Ei(){Ai(),Wo(),fo(),Di()}function Di(){let e=aa()+Zt(),t="float brushRadius = "+ji(k.brushRadius.toString())+";\n";switch(t=t.replace(/\buvwq\./g,"uvwqBrush."),t=t.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(k.brushValue)&&(e+=An()),/\bRANDN\b/.test(k.brushValue)&&(e+=Tn()),e+="float brushValue = "+ji(k.brushValue)+";\n",e+=t,k.typeOfBrush){case"circle":e+=en();break;case"hline":e+=nn();break;case"vline":e+=tn()}switch(k.brushAction){case"replace":e+=on(),e+=Yt();break;case"add":e+=on(),e+=Kt();break;case"smoothreplace":e+=an(),e+=Yt();break;case"smoothadd":e+=an(),e+=Kt()}e=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,oo(k.whatToDraw)),e}(e),v.fragmentShader=e,v.needsUpdate=!0}function Ai(){R=Ln(k.colourmap),k.flippedColourmap&&(R.reverse(),R=R.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),P.colour1.value=new zn.Vector4(...R[0]),P.colour2.value=new zn.Vector4(...R[1]),P.colour3.value=new zn.Vector4(...R[2]),P.colour4.value=new zn.Vector4(...R[3]),P.colour5.value=new zn.Vector4(...R[4]);let e=aa()+Wn();k.emboss&&(e+=Qn(),er()),k.contours&&(e+=kn(),ir()),k.overlay&&(e+=Nn().replaceAll("OVERLAYEXPR",ji(k.overlayExpr)),or()),e+=Rn(),b.fragmentShader=e,b.needsUpdate=!0,C.needsUpdate=!0,Q=R.map((e=>e[3])),R=R.map((e=>e.slice(0,-1))),Wi()}function Ti(){switch(k.timesteppingScheme){case"Euler":F.material=St.FE,P.textureSource.value=vt[1].texture,P.textureSource1.value=vt[2].texture,P.dt.value=k.dt,l.setRenderTarget(vt[0]),l.render(r,o),vt.rotate(-1),P.t.value+=k.dt;break;case"AB2":F.material=St.AB2,P.textureSource.value=vt[1].texture,P.textureSource1.value=vt[2].texture,P.dt.value=k.dt,l.setRenderTarget(vt[0]),l.render(r,o),vt.rotate(-1),P.t.value+=k.dt;break;case"Mid":F.material=St.Mid1,P.textureSource.value=vt[1].texture,l.setRenderTarget(vt[2]),l.render(r,o),F.material=St.Mid2,P.textureSource1.value=vt[2].texture,P.t.value+=.5*k.dt,l.setRenderTarget(vt[0]),l.render(r,o),vt.rotate(-1),P.t.value+=.5*k.dt;break;case"RK4":F.material=St.RK41,P.textureSource.value=vt[1].texture,l.setRenderTarget(vt[2]),l.render(r,o),F.material=St.RK42,P.textureSource1.value=vt[2].texture,P.t.value+=.5*k.dt,l.setRenderTarget(vt[3]),l.render(r,o),F.material=St.RK43,P.textureSource2.value=vt[3].texture,l.setRenderTarget(vt[4]),l.render(r,o),F.material=St.RK44,P.textureSource3.value=vt[4].texture,P.t.value+=.5*k.dt,l.setRenderTarget(vt[0]),l.render(r,o),vt.rotate(-1)}}function Wi(){if(k.autoSetColourRange&&da(),k.brushEnabled&&"surface"==k.plotType){let e=0;k.maxColourValue-k.minColourValue>0&&(e=(function(){qo();let e=0;for(let t=0;t<Gt.length;t+=4)e+=Gt[t];return e/(ct*dt)}()-k.minColourValue)/(k.maxColourValue-k.minColourValue)-.5,e=e.clamp(-.5,.5)),E.position.y=k.threeDHeightScale*e,E.updateWorldMatrix()}if(Ri(),"line"==k.plotType){qo();let t,n=0;var e=k.maxColourValue-k.minColourValue;e=0==e?.5:e;for(let i=0;i<Gt.length;i+=4)t=(Gt[i]-k.minColourValue)/e-.5,T[n++]=t.clamp(-.5,.5);const i=new zn.SplineCurve(A.map(((e,t)=>new zn.Vector2(e,T[t])))),o=i.getSpacedPoints(W);!function(e){let t,n=D.geometry.attributes.instanceStart,i=D.geometry.attributes.instanceEnd;for(let o=0;o<e.length;o++)t=e[o].toArray(),t[1]*=k.threeDHeightScale,o<e.length&&n.setXYZ(o,t[0],t[1],0),o>0&&i.setXYZ(o-1,t[0],t[1],0);n.needsUpdate=!0,i.needsUpdate=!0}(o),function(e){let t,n=D.geometry.attributes.instanceColorStart,i=D.geometry.attributes.instanceColorEnd;for(let o=0;o<e.length;o++)t=ha(e[o].toArray()[1]+.5),o<e.length&&n.setXYZ(o,t[0],t[1],t[2]),o>0&&i.setXYZ(o-1,t[0],t[1],t[2]);n.needsUpdate=!0}(o)}if(k.timeDisplay&&Io(),k.integrate&&function(){if(k.integrate){let e;qo(),1==k.dimension?e=P.dx.value:2==k.dimension&&(e=P.dx.value*P.dy.value);let t=0;for(let e=0;e<Gt.length;e+=4)t+=Gt[e];t*=e,$("#integralValue").html(Qo(t,4)),Bo()}}(),Go()?(F.material=x,l.setRenderTarget(p),l.render(r,o),P.textureSource.value=p.texture,P.dxUpscaledScale.value=devicePixelRatio*ht/ct,P.dyUpscaledScale.value=devicePixelRatio*gt/dt):(P.dxUpscaledScale.value=1,P.dyUpscaledScale.value=1),l.setRenderTarget(null),l.render(a,i),Jt){Jt=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",l.render(a,i),t.href=l.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),xi(),Wi()}}function Ri(){F.material=C,P.textureSource.value=vt[1].texture,l.setRenderTarget(f),l.render(r,o),P.textureSource.value=f.texture,Ht=!1,P.textureSource1.value=vt[1].texture}function Qi(t){it=Ii(t,e),it&&(k.brushEnabled&&"surface"==k.plotType?u.enabled=!1:k.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),Ao("#top_message"),window.clearTimeout(lt),lt=setTimeout((function(){$("#top_message").hasClass("fading_out")||To("#top_message")}),3e3)))}function ki(e){it=!1,"surface"==k.plotType&&(u.enabled=!0)}function Pi(t){Ii(t,e)}function Ii(e,t){var n=t.getBoundingClientRect();let o=(e.clientX-n.x)/n.width,a=1-(e.clientY-n.y)/n.height;if("surface"==k.plotType){d.x=2*o-1,d.y=2*a-1,c.setFromCamera(d,i);var r=c.intersectObject(E,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==k.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*ct)/ct,a=Math.round(a*dt)/dt,P.brushCoords.value=new zn.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function Ni(){l.setSize(ct,dt,!1),k.fixRandSeed||ro(),Ft&&k.resetFromCheckpoints?F.material=U:F.material=y,vt.forEach((e=>{l.setRenderTarget(e),l.render(r,o)})),_a(),Wi()}function Li(){_t||($("#pause").hide(),$("#play").show()),nt=!1}function Mi(){_t||($("#play").hide(),$("#pause").show()),nt=!0}function Oi(){Ni(),P.t.value=0,Io(),Wi(),window.clearTimeout(rt),Oo()}function qi(){let e="";return e+="float UFUN = "+ji(k.reactionStrU)+";\n",e+="float VFUN = "+ji(k.reactionStrV)+";\n",e+="float WFUN = "+ji(k.reactionStrW)+";\n",e+="float QFUN = "+ji(k.reactionStrQ)+";\n",e}function Bi(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function ji(e){if(!Ea(e=" "+e+" "))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])\b/g);let i,o,a,r,l,s,u,c,d,f,p,m,h=0;const g={S:"One",T:"Two"},b={R:"x",G:"y",B:"z",A:"w"};for(const v of n){for(i=v.index,p=g[v[1]],m=b[v[2]],o=i+v[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,l=t.slice(o+h+1,a+h),l=sa(l),s=l.split(","),1!=s.length&&0!=s[1].trim().length||(s[1]="0"),s[0]="("+s[0]+")/L_x",s[1]="("+s[1]+")/L_y",f="texture(imageSource"+p+",vec2("+s.join(",")+"))."+m,t=Uo(t,f,i+h,a+1+h),h+=f.length-a+i-1)}return t}(e=ta(e=(e=(e=(e=Gi(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){switch(n){case"0":return"1";case"1":return"("+t+")";case"2":return"(("+t+")*("+t+"))";case"3":return"(("+t+")*("+t+")*("+t+"))";case"4":return"(("+t+")*("+t+")*("+t+")*("+t+"))";case"5":return"(("+t+")*("+t+")*("+t+")*("+t+")*("+t+"))";default:return"safepow("+t+","+n+")"}}))).replaceAll(RegExp("\\b("+si[0]+")\\b","g"),(function(e,t){return"uvwq."+oo(t)}))).replaceAll(RegExp("\\b("+si[0]+")_([xy])\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+oo(t)}))).replaceAll(RegExp("\\b("+si[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+oo(t)}))));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e}function Gi(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function zi(){let e="",t="",n="",i="",o="",a="";const r=[k.boundaryConditionsU,k.boundaryConditionsV,k.boundaryConditionsW,k.boundaryConditionsQ],l=[k.neumannStrU,k.neumannStrV,k.neumannStrW,k.neumannStrQ],s=[k.comboStrU,k.comboStrV,k.comboStrW,k.comboStrQ].map((e=>e+";")),u=[k.dirichletStrU,k.dirichletStrV,k.dirichletStrW,k.dirichletStrQ],c=[k.robinStrU,k.robinStrV,k.robinStrW,k.robinStrQ];if(r.forEach((function(t,n){"neumann"==t?(e+=Ji(l[n],ri[n]),e+=ka(n)):"combo"==t&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=Ji(t[2],ri[n],i),e+=ka(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=io(Fn(t),ri[e]),k.dimension>1&&(i+=io(En(t),ri[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,ji(e[2]))}))})),k.domainViaIndicatorFun){let e=bn().replace(/indicatorFun/g,ji(k.domainIndicatorFun));u.forEach((function(t,i){n+=io(e,ri[i])+ji(t)+";\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=Hi(u[t],ri[t]),n+=Pa(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=Hi(e[2],ri[t],i),n+=Pa(t,i)}))}));r.forEach((function(e,t){"robin"==e?(i+=Ji(c[t],ri[t]),i+=Ia(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=Ji(e[2],ri[t],n),i+=Ia(t,n)}))}));let d=aa();if(o=function(){let e="";return e+=Bi(ji(k.diffusionStrUU)+";\n","uu"),e+=Bi(ji(k.diffusionStrVV)+";\n","vv"),e+=Bi(ji(k.diffusionStrWW)+";\n","ww"),e+=Bi(ji(k.diffusionStrQQ)+";\n","qq"),e}()+"\n",k.crossDiffusion?o+=function(){let e="";return e+=Bi(ji(k.diffusionStrUV)+";\n","uv"),e+=Bi(ji(k.diffusionStrUW)+";\n","uw"),e+=Bi(ji(k.diffusionStrUQ)+";\n","uq"),e+=Bi(ji(k.diffusionStrVU)+";\n","vu"),e+=Bi(ji(k.diffusionStrVW)+";\n","vw"),e+=Bi(ji(k.diffusionStrVQ)+";\n","vq"),e+=Bi(ji(k.diffusionStrWU)+";\n","wu"),e+=Bi(ji(k.diffusionStrWV)+";\n","wv"),e+=Bi(ji(k.diffusionStrWQ)+";\n","wq"),e+=Bi(ji(k.diffusionStrQU)+";\n","qu"),e+=Bi(ji(k.diffusionStrQV)+";\n","qv"),e+=Bi(ji(k.diffusionStrQW)+";\n","qw"),e}()+"\n"+wn():o+=yn(),qt&&k.crossDiffusion&&(a+=io(Cn(),ri[1])),Bt&&k.crossDiffusion&&(a+=io(Cn(),ri[2])),jt&&k.crossDiffusion&&(a+=io(Cn(),ri[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void Fa("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let f=[xn(),$n(),e,t,i,Un(),_n(),qi(),o].join(" "),p=/\bRAND\b/.test(f),m=/\bRANDN\b/.test(f);p&&(f=An()+f),m&&(f=Tn()+f),xt=p||m;let h=[n,a,mn()].join(" "),g="FE";St[g].fragmentShader=[d,pn(g),f,Dn(g),h].join(" "),g="AB2",St[g].fragmentShader=[d,pn(g),f,Dn(g),h].join(" "),g="Mid";for(let e=1;e<3;e++)St[g+e.toString()].fragmentShader=[d,pn(g+e.toString()),f,Dn(g+e.toString()),h].join(" ");g="RK4";for(let e=1;e<5;e++)St[g+e.toString()].fragmentShader=[d,pn(g+e.toString()),f,Dn(g+e.toString()),h].join(" ");if(Object.keys(St).forEach((e=>St[e].needsUpdate=!0)),at=k.domainViaIndicatorFun||"dirichlet"==k.boundaryConditionsU||"dirichlet"==k.boundaryConditionsV||"dirichlet"==k.boundaryConditionsW||"dirichlet"==k.boundaryConditionsQ||/Dirichlet/.test(k.comboStrU)||/Dirichlet/.test(k.comboStrV)||/Dirichlet/.test(k.comboStrW)||/Dirichlet/.test(k.comboStrQ),at){if(n=d+Vn(),k.domainViaIndicatorFun){let e=bn().replace(/indicatorFun/g,ji(k.domainIndicatorFun)).replace(/updated/g,"gl_FragColor");u.forEach((function(t,i){n+=io(e,ri[i])+ji(t)+";\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=Hi(u[t],ri[t]),n+=Na(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=Hi(e[2],ri[t],i),n+=Na(t,i)}))}));n+="}",S.fragmentShader=n,S.needsUpdate=!0}}function Ji(e,t,n){return null==n?["L","R","T","B"].map((n=>Ji(e,t,n))).join(""):"float robinRHS"+t+n+" = "+ji(e)+";\n"}function Hi(e,t,n){return null==n?["L","R","T","B"].map((n=>Hi(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+ji(e)+";\n"}function Xi(e){Zi("default"),Zi(e),null!=k.threeD&&(k.threeD&&(k.dimension=2,k.plotType="surface"),delete k.threeD),null!=k.oneDimensional&&(k.oneDimensional&&(k.dimension=1,k.plotType="line"),delete k.oneDimensional),Tt*=Wt,function(){if(0==k.views.length){let e=Ra();e.name="1",k.views.push(e)}else k.views=k.views.map((function(e){let t=Ra();return Object.assign(t,e),t}));st=k.views}(),Ki(L,!0),Ki(M,!0),Ki(O,!0),Fi(),k.activeViewInd<k.views.length?Aa(k.views[k.activeViewInd],!1):Aa({},!0),So(),_i(),Si(),Ci(),a.background=new zn.Color(k.backgroundColour),""!=k.initialState?fetch(k.initialState).then((e=>e.blob())).then((e=>xa(e))):Oi(),wi(),Ze.remove(),Ye.remove(),co(),jo()}function Zi(e){let t;if(t=null==e?On(k.preset):"string"==typeof e?On(e):"object"==typeof e?e:On("default"),t.hasOwnProperty("parent")&&null!=t.parent&&Zi(t.parent),Pt=0,Qt=[],Rt={},Object.assign(k,t),pa(!0),nt=k.runningOnLoad,nt?Mi():Li(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?k.tryClickingText=k.tryClickingText.replaceAll("clicking","tapping"):k.tryClickingText=k.tryClickingText.replaceAll("tapping","clicking"),k.brushRadius=k.brushRadius.toString(),k.hasOwnProperty("drawIn3D")&&(k.brushEnabled=k.drawIn3D),ri.includes("T")||Object.keys(k).forEach((function(e){pi.includes(e)&&(k[e]=ma(k[e],["T"],["I_T"],"[RGBA]"))})),!ri.includes("S")){Object.keys(k).forEach((function(e){pi.includes(e)&&(k[e]=ma(k[e],["S"],["I_S"],"[RGBA]"))}));var n=0;n+=k.hasOwnProperty("algebraicV"),n+=k.hasOwnProperty("algebraicW"),(n+=k.hasOwnProperty("algebraicQ"))&&!k.numAlgebraicSpecies&&(k.numAlgebraicSpecies=n),delete k.algebraicV,delete k.algebraicW,delete k.algebraicQ,null==k.minColourValue&&(k.minColourValue=0),null==k.maxColourValue&&(k.maxColourValue=1),k.domainScale=k.domainScale.toString(),k.spatialStep=k.spatialStep.toString(),N=k}let i=[k.clearValueU,k.clearValueV,k.clearValueW,k.clearValueQ,k.domainIndicatorFun,k.reactionStrU,k.reactionStrV,k.reactionStrW,k.reactionStrQ,k.diffusionStrUU,k.diffusionStrUV,k.diffusionStrUW,k.diffusionStrUQ,k.diffusionStrVU,k.diffusionStrVV,k.diffusionStrVW,k.diffusionStrVQ,k.diffusionStrWU,k.diffusionStrWV,k.diffusionStrWW,k.diffusionStrWQ,k.diffusionStrQU,k.diffusionStrQV,k.diffusionStrQW,k.diffusionStrQQ,k.dirichletStrU,k.dirichletStrV,k.dirichletStrW,k.dirichletStrQ,k.robinStrU,k.robinStrV,k.robinStrW,k.robinStrQ,k.comboStrU,k.comboStrV,k.comboStrW,k.comboStrQ,k.neumannStrU,k.neumannStrV,k.neumannStrW,k.neumannStrQ,k.brushValue,k.whatToPlot].join(" ");k.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(i)}function Yi(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)Yi(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Ki(e,t){if(null!=e){for(let t in e.__folders)Ki(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function eo(e){null!=e&&(e.__li.style.display="none")}function to(e){null!=e&&(e.__li.style.display="")}function no(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function io(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=oo(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function oo(e){return"rgba"[function(e){return ri.indexOf(e)}(e)]}function ao(){"dirichlet"==k.boundaryConditionsU?to(We):eo(We),"dirichlet"==k.boundaryConditionsV?to(Re):eo(Re),"dirichlet"==k.boundaryConditionsW?to(Qe):eo(Qe),"dirichlet"==k.boundaryConditionsQ?to(ke):eo(ke),"neumann"==k.boundaryConditionsU?to(Me):eo(Me),"neumann"==k.boundaryConditionsV?to(Oe):eo(Oe),"neumann"==k.boundaryConditionsW?to(qe):eo(qe),"neumann"==k.boundaryConditionsQ?to(Be):eo(Be),"robin"==k.boundaryConditionsU?to(Ge):eo(Ge),"robin"==k.boundaryConditionsV?to(ze):eo(ze),"robin"==k.boundaryConditionsW?to(Je):eo(Je),"robin"==k.boundaryConditionsQ?to(He):eo(He),"combo"==k.boundaryConditionsU?to(Pe):eo(Pe),"combo"==k.boundaryConditionsV?to(Ie):eo(Ie),"combo"==k.boundaryConditionsW?to(Ne):eo(Ne),"combo"==k.boundaryConditionsQ?to(Le):eo(Le),k.domainViaIndicatorFun?(eo(Ee),eo(De),eo(Ae),eo(Te)):to(Ee)}function ro(){P.seed.value=performance.now()%1e6/1e6}function lo(){let e=aa()+Gn(),t=[k.clearValueU,k.clearValueV,k.clearValueW,k.clearValueQ].join(" ");/\bRAND\b/.test(t)&&(e+=An()),/\bRANDN\b/.test(t)&&(e+=Tn()),e+="float u = "+ji(k.clearValueU)+";\n",e+="float v = "+ji(k.clearValueV)+";\n",e+="float w = "+ji(k.clearValueW)+";\n",e+="float q = "+ji(k.clearValueQ)+";\n",e+=jn(),y.fragmentShader=e,y.needsUpdate=!0}function so(){let e=new Image;e.src=Ze.__image.src;let t=new zn.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,P.imageSourceOne.value=t,k.resetOnImageLoad&&Oi()}}function uo(){let e=new Image;e.src=Ye.__image.src;let t=new zn.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,P.imageSourceTwo.value=t,k.resetOnImageLoad&&Oi()},t.dispose()}function co(){q=Xe,Ze=q.addImage(k,"imagePathOne").name("$I_S(x,y)$").onChange(so),Ye=q.addImage(k,"imagePathTwo").name("$I_T(x,y)$").onChange(uo),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function fo(){"MAX"==k.whatToPlot?(C.fragmentShader=sn()+cn().replace(/indicatorFun/g,ji(k.domainIndicatorFun))+un(),C.needsUpdate=!0,k.minColourValue=0,k.maxColourValue=1,Ci(),eo(we),eo(Ce),eo(Ve),eo(xe),k.autoSetColourRange=!1,Yi(M)):(ho(),to(we),to(Ce),to(Ve),to(xe)),Wo(),No(),Wi()}function po(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function mo(){qo();let e=1/0,t=-1/0;for(let n=0;n<Gt.length;n+=4)e=Math.min(e,Gt[n]),t=Math.max(t,Gt[n]);return[e,t]}function ho(){let e=aa()+rn();e+=ln(),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,ji(k.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,ji(k.surfaceFun))}(e),k.domainViaIndicatorFun&&(e+=cn().replace(/indicatorFun/g,ji(k.domainIndicatorFun))),C.fragmentShader=e+un(),C.needsUpdate=!0}function go(){k.numAlgebraicSpecies=Math.min(parseInt(k.numAlgebraicSpecies),parseInt(k.numSpecies)-1),qt=k.numAlgebraicSpecies>=k.numSpecies-1,Bt=k.numAlgebraicSpecies>=k.numSpecies-2&&k.numSpecies>=3,jt=k.numAlgebraicSpecies>=k.numSpecies-3&&k.numSpecies>=4}function bo(){let e="function of "+ri.slice(0,k.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+ri[1]+",",""),i=e.replace(" "+ri[2]+",",""),o=e.replace(" "+ri[3]+",","");switch(1==k.dimension&&(e=e.replace(" y,","")),k.crossDiffusion&&parseInt(k.numSpecies)>1?(Dt||fa(H,Array.from(Array(parseInt(k.numSpecies)).keys())),to(H)):eo(H),k.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),eo(Y),eo(te),eo(ne),eo(G),eo($e),eo(De),eo(K),eo(ie),eo(ae),eo(re),eo(le),eo(z),eo(_e),eo(Ae),eo(ee),eo(oe),eo(se),eo(ue),eo(ce),eo(de),eo(fe),eo(J),eo(Fe),eo(Te),parseInt(k.numSpecies)){case 4:k.crossDiffusion?(to(ee),to(oe),to(se),to(ue),to(ce),to(de)):(eo(se),eo(ue),eo(oe),eo(ee),eo(ce),eo(de)),to(fe),to(J),to(Fe),to(Te);case 3:k.crossDiffusion?(to(K),to(ie),to(ae),to(re)):(eo(K),eo(ie),eo(ae),eo(re)),to(le),to(z),to(_e),to(Ae);case 2:k.crossDiffusion?(to(Y),to(te)):(eo(Y),eo(te)),to(ne),to(G),to($e),to(De)}1==k.numSpecies?no(Z,ci.D,e):k.crossDiffusion?(no(Z,ci.Duu,e),no(Y,ci.Duv,e),no(K,ci.Duw,e),no(ee,ci.Duq,e),no(te,ci.Dvu,e),no(ne,ci.Dvv,e),no(ie,ci.Dvw,e),no(oe,ci.Dvq,e),no(ae,ci.Dwu,e),no(re,ci.Dwv,e),no(le,ci.Dww,e),no(se,ci.Dwq,e),no(ue,ci.Dqu,e),no(ce,ci.Dqv,e),no(de,ci.Dqw,e),no(fe,ci.Dqq,e)):(no(Z,ci.Du,e),no(ne,ci.Dv,e),no(le,ci.Dw,e),no(fe,ci.Dq,e)),no(j,ci.UFUN,e),no(G,ci.VFUN,e),no(z,ci.WFUN,e),no(J,ci.QFUN,e),qt&&(no(te,ci.Dvu,t),no(ie,ci.Dvw,t),no(oe,ci.Dvq,t),no(G,ci.VFUN,t),eo(ne)),Bt&&(no(ae,ci.Dwu,o),no(re,ci.Dwv,o),no(se,ci.Dwq,o),no(z,ci.WFUN,o),eo(le)),jt&&(no(ue,ci.Dqu,i),no(ce,ci.Dqv,i),no(de,ci.Dqw,i),no(J,ci.QFUN,i),eo(fe)),no(Ee,ci.u),no(De,ci.v),no(Ae,ci.w),no(Te,ci.q),no(We,ci.uD),no(Re,ci.vD),no(Qe,ci.wD),no(ke,ci.qD),no(Me,ci.uN),no(Oe,ci.vN),no(qe,ci.wN),no(Be,ci.qN),no(Ge,ci.uN),no(ze,ci.vN),no(Je,ci.wN),no(He,ci.qN),no(Ue,ci.uInit),no($e,ci.vInit),no(_e,ci.wInit),no(Fe,ci.qInit),k.domainViaIndicatorFun?to(X):eo(X),ao(),"surface"==k.plotType?($("#contourButton").show(),$("#embossButton").show(),et.name="3D options",et.domElement.classList.remove("hidden"),k.customSurface&&to(be),eo(he),to(ge),to(ve),to(Se),to(ye)):"line"==k.plotType?($("#contourButton").hide(),$("#embossButton").hide(),et.name="Line options",et.domElement.classList.remove("hidden"),to(he),to(ge),eo(ve),eo(Se),eo(ye)):($("#contourButton").show(),$("#embossButton").show(),et.domElement.classList.add("hidden"),eo(he),eo(ge),eo(ve),eo(Se),eo(ye)),Wo(),Po(),No(),$("#dataContainer").show(),ur(),"line"==k.plotType?(eo(B),$(":root").css("--ui-button-outline","black")):(to(B),$(":root").css("--ui-button-outline","white")),n?$("#interpController").hide():$("#interpController").show(),fa(me,ri.slice(0,k.numSpecies)),nr(),$(".toggle_button").each((function(){rr(this)})),Da(),Yi(L),Yi(M),Yi(O)}function vo(){let e;switch(go(),k.domainViaIndicatorFun&&(k.boundaryConditionsU="dirichlet",k.boundaryConditionsV="dirichlet",k.boundaryConditionsW="dirichlet",k.boundaryConditionsQ="dirichlet"),parseInt(k.numSpecies)){case 1:k.crossDiffusion=!1,k.whatToDraw=ri[0],k.whatToPlot=ri[0],k.diffusionStrUV="0",k.diffusionStrUW="0",k.diffusionStrUQ="0",k.diffusionStrVU="0",k.diffusionStrVV="0",k.diffusionStrVW="0",k.diffusionStrVQ="0",k.diffusionStrWU="0",k.diffusionStrWV="0",k.diffusionStrWW="0",k.diffusionStrWQ="0",k.diffusionStrQU="0",k.diffusionStrQV="0",k.diffusionStrQW="0",k.diffusionStrQQ="0",k.boundaryConditionsV="periodic",k.clearValueV="0",k.reactionStrV="0",k.boundaryConditionsW="periodic",k.clearValueW="0",k.reactionStrW="0",k.boundaryConditionsQ="periodic",k.clearValueQ="0",k.reactionStrQ="0",e=new RegExp("\\b("+si[1]+")\\b"),e.test(k.reactionStrU)&&(k.reactionStrU="0");break;case 2:k.whatToDraw==ri[2]|k.whatToDraw==ri[3]&&(k.whatToDraw=ri[0]),k.whatToPlot==ri[2]|k.whatToPlot==ri[3]&&(k.whatToPlot=ri[0]),k.diffusionStrUW="0",k.diffusionStrUQ="0",k.diffusionStrVW="0",k.diffusionStrVQ="0",k.diffusionStrWU="0",k.diffusionStrWV="0",k.diffusionStrWW="0",k.diffusionStrWQ="0",k.diffusionStrQU="0",k.diffusionStrQV="0",k.diffusionStrQW="0",k.diffusionStrQQ="0",k.boundaryConditionsW="periodic",k.clearValueW="0",k.reactionStrW="0",k.boundaryConditionsQ="periodic",k.clearValueQ="0",k.reactionStrQ="0",e=new RegExp("\\b("+si[2]+")\\b"),e.test(k.reactionStrU)&&(k.reactionStrU="0"),e.test(k.reactionStrV)&&(k.reactionStrV="0");break;case 3:k.whatToDraw==ri[3]&&(k.whatToDraw=ri[0]),k.whatToPlot==ri[3]&&(k.whatToPlot=ri[0]),k.diffusionStrUQ="0",k.diffusionStrVQ="0",k.diffusionStrWQ="0",k.diffusionStrQU="0",k.diffusionStrQV="0",k.diffusionStrQW="0",k.diffusionStrQQ="0",k.boundaryConditionsQ="periodic",k.clearValueQ="0",k.reactionStrQ="0",e=new RegExp("\\b("+si[3]+")\\b"),e.test(k.reactionStrU)&&(k.reactionStrU="0"),e.test(k.reactionStrV)&&(k.reactionStrV="0"),e.test(k.reactionStrW)&&(k.reactionStrW="0")}switch(Ot){case 3:k.diffusionStrVV="0";break;case 6:k.diffusionStrWW="0";break;case 7:k.diffusionStrVV="0",k.diffusionStrWW="0";break;case 10:k.diffusionStrQQ="0";break;case 11:k.diffusionStrWW="0",k.diffusionStrQQ="0";break;case 12:k.diffusionStrVV="0",k.diffusionStrWW="0",k.diffusionStrQQ="0"}Yi(L),Yi(M)}function So(){!function(){switch(go(),parseInt(k.numSpecies)){case 1:Ot=0;break;case 2:Ot=k.crossDiffusion?1==k.numAlgebraicSpecies?3:2:1;break;case 3:if(k.crossDiffusion)switch(k.numAlgebraicSpecies){case 0:Ot=5;break;case 1:Ot=6;break;case 2:Ot=7}else Ot=4;break;case 4:if(k.crossDiffusion)switch(k.numAlgebraicSpecies){case 0:Ot=9;break;case 1:Ot=10;break;case 2:Ot=11;break;case 3:Ot=12}else Ot=8}}(),Xo(),Zo(),vo(),bo(),ia(),la(),yo(),Oi()}function yo(){let e,t=ui[Ot];const n={D:/\b(D) (\\vnabla u)/g,U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(k.typesetCustomEqs){let o={};o.D=k.diffusionStrUU,o.U=k.diffusionStrUU,o.UU=k.diffusionStrUU,o.V=k.diffusionStrVV,o.VV=k.diffusionStrVV,o.W=k.diffusionStrWW,o.WW=k.diffusionStrWW,o.Q=k.diffusionStrQQ,o.QQ=k.diffusionStrQQ,o.UV=k.diffusionStrUV,o.UW=k.diffusionStrUW,o.UQ=k.diffusionStrUQ,o.VU=k.diffusionStrVU,o.VW=k.diffusionStrVW,o.VQ=k.diffusionStrVQ,o.WU=k.diffusionStrWU,o.WV=k.diffusionStrWV,o.WQ=k.diffusionStrWQ,o.QU=k.diffusionStrQU,o.QV=k.diffusionStrQV,o.QW=k.diffusionStrQW,o.UFUN=k.reactionStrU,o.VFUN=k.reactionStrV,o.WFUN=k.reactionStrW,o.QFUN=k.reactionStrQ;var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!Ea(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=ma(o[e],ri,It,"_[xy]")})),Ct.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){Nt.includes(e)||(t=function(e,t,n,i){let o=n.replace(/\s+/g,"  ").trim();if("0"==o||"0.0"==o)return e.replaceAll(t,"");if("1"==o||"1.0"==o)return e.replaceAll(t,"$2");if("-1"==o||"-1.0"==o)return e.replaceAll(t,"-$2");if(n.match(/[a-zA-Z]/))return n.match(/[\+-]/)&&null!=i?e.replaceAll(t,i[0]+n+i[1]+"$2"):e.replaceAll(t,n+"$2");return e}(t,n[e],o[e],"[]"))})),t=Ho(t,n.UFUN,o.UFUN),t=Ho(t,n.VFUN,o.VFUN),t=Ho(t,n.WFUN,o.WFUN),t=Ho(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\((D_\{\w+(?: \w+)?\})\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"$1 \\lap $2"),e=/\\vnabla\s*\\cdot\s*\(([\w\{\}\*\^]*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b[xy]|[uvwq]\b/g.test(t)?e:t+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else Ct.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{ "+t+" ";return"string"==typeof n&&(i+=n),i+" }"}))})),t=ma(t,["UFUN","VFUN","WFUN","QFUN"],li,"_[xy]");1==k.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=ma(t,It.concat(Nt),ri.concat(li),"_[xy]"),t=wo(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(ua)}function wo(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Co(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Co(e,"cos",!0),e=Co(e,"tan",!0),e=Co(e,"exp",!0),e=Co(e,"log",!0),e=Co(e,"sqrt",!1),e=Co(e,"sinh",!0),e=Co(e,"cosh",!0),e=Co(e,"tanh",!0),e=Co(e,"max",!0),e=Gi(e=(e=Co(e,"min",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",l="";for(var s=0;s<e.length;s++)t.includes(e[s])?(i+=1,o+=1):n.includes(e[s])&&(i-=1),0==i&&o>0&&(r=e.slice(a,s+1),l+=Vo(r,o),o=0,a=s+1);return l+=e.slice(a),l}(e=ai(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")}function Co(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,l,s,u,c,d,f=0;for(const p of o){for(a=p.index,r=a+t.length,s=e.slice(r),d=0,u=0,c=!1;d<=s.length&(!c|!(c&&0==u));)u+=["(","["].includes(s[d]),u-=[")","]"].includes(s[d]),c|=u,d+=1;c&&0==u&&(l=d-1+r,i=$o(i,"\\",a+f),f+=1,n?(i=$o(i,"{",r+f),f+=1,i=$o(i,"}",l+1+f),f+=1):(i=Uo(i,"{",r+f),i=Uo(i,"}",l+f)))}return i}function Vo(e,t){const n=["(","["],i=[")","]"];let o=xo(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=Uo(e,n[o],a),o+=1,o=xo(o,n.length)):i.includes(e[a])&&(o-=1,o=xo(o,n.length),e=Uo(e,i[o],a));return e}function xo(e,t){return(e%t+t)%t}function Uo(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function $o(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function _o(e){return e=e.replace(/\s+/g,"  ").trim()}function Fo(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=Rt[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);Rt[e]=Rt[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),Yi(bt),Eo(),Wi(),(ia()||$t)&&($t=!1,la())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)Qt.push(e),Rt[e]="",n=bt.add(Rt,e).name(""),lr(n.domElement),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=Qt.indexOf(e);let n=_o(Rt[Qt.at(t)]);if(""==n);else{let e=Fo(Qt.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);i&&(e.lastName=i[1],kt[e.lastName]=e),Pt+=1;let o="params"+Pt;this.remove(),Fo(o,!0),Eo(),(ia()||$t)&&($t=!1,la())}}));else{n=bt.add(Rt,e).name(""),lr(n.domElement),n.domElement.classList.add("params");const t=Rt[e].match(/\s*(\w+)\s*=/);t&&(n.lastName=t[1],kt[n.lastName]=n),n.onFinishChange((function(){let t=_o(Rt[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=Qt.indexOf(e);Qt.splice(t,1),delete Rt[e],n.hasOwnProperty("lastName")&&!Jo(n.lastName)&&delete P[n.lastName]}else{i();const e=sa(t).match(/\s*(\w+)\s*=/);e&&n.hasOwnProperty("lastName")&&n.lastName!=e[1]&&!Jo(n.lastName)&&(delete P[n.lastName],n.lastName=e[1],kt[n.lastName]=n)}Eo(),ia()&&la()})),Eo(),ia()&&la()}return i(),n}function Eo(){k.kineticParams=Object.values(Rt).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function Do(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function Ao(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function To(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function Wo(){if(k.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+ha(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==k.whatToPlot?($("#minLabel").html("$"+ri[0]+"$"),$("#midLabel").html("$"+ri[1]+"$"),$("#maxLabel").html("$"+ri[2]+"$")):Vt?$("#midLabel").html(k.views[k.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+wo(k.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),Ko(),Ro()}else $("#colourbar").hide()}function Ro(){if("MAX"!=k.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[ko(e,n),ko(t,n)]}(k.minColourValue,k.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=ca(ha(0)),t=ca(ha(.5)),n=ca(ha(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function Qo(e,t){return e.toPrecision(t)}function ko(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function Po(){k.timeDisplay?($("#timeDisplay").show(),Io()):$("#timeDisplay").hide(),Mo()}function Io(){if(k.timeDisplay){let e=Qo(P.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/,"  10<sup>$2$3<sup>"),$("#timeValue").html(e),Bo()}}function No(){if(k.integrate){$("#integralDisplay").show();let e="";1==k.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+wo(k.whatToPlot)+"\\,\\d x",1==k.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();Mo()}function Lo(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function Mo(){k.integrate&&k.timeDisplay?Lo("#timeDisplay",10):Lo("#timeDisplay",0)}function Oo(){let e=mo();isFinite(e[0])&&isFinite(e[1])?rt=setTimeout(Oo,1e3):(Ao("#oops_hit_nan"),Li(),$("#erase").one("click",(()=>To("#oops_hit_nan"))))}function qo(){if(!Ht){try{l.readRenderTargetPixels(f,0,0,ct,dt,Gt)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}Ht=!0}}function Bo(){if(k.colourbar&&k.integrate|k.timeDisplay){let e,t=$("#colourbar")[0].getBoundingClientRect();e=k.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(Lo("#dataContainer",40),Ut=!0):Ut&&(Lo("#dataContainer",0),Ut=!1)}}function jo(){Go()?(vt.forEach((e=>{e.texture.magFilter=zn.NearestFilter})),f.texture.magFilter=zn.NearestFilter,p.texture.magFilter=zn.NearestFilter):(vt.forEach((e=>{e.texture.magFilter=zn.LinearFilter})),f.texture.magFilter=zn.LinearFilter,p.texture.magFilter=zn.LinearFilter),bo(),Wi()}function Go(){return n||k.forceManualInterpolation}function zo(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function Jo(e,t){return null==t&&(t=[]),function(e){return[...(pn()+wn()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e)}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function Ho(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function Xo(){"line"==k.plotType?(ba(),k.typeOfBrush="vline",Di(),Yi(M),_.visible=!1,D.visible=!0,k.contours=!1,k.emboss=!1):(_.visible=!0,D.visible=!1,"surface"==k.plotType?($("#simCanvas").css("outline","2px #000 solid"),At&&(At=!1,yi())):$("#simCanvas").css("outline","")),Ai(),wi(),bo()}function Zo(){1!=k.dimension&&"line"==k.plotType&&(k.plotType="plane",Xo()),1==k.dimension&&"line"!=k.plotType&&(k.plotType="line",Xo()),Si(),zi(),yo(),bo(),No()}function Yo(){const e=(new zn.Vector3).setFromSphericalCoords(1,Math.PI/2-k.cameraTheta*Math.PI/180,-k.cameraPhi*Math.PI/180);i.position.set(e.x,e.y,e.z),i.lookAt(0,0,0)}function Ko(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function ea(){return k.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function ta(e){return sa(e)}function na(){const e=/(\w+)\s*=/;return ea().split(";").filter((e=>e.length>0)).map((t=>t.match(e)[1].trim()))}function ia(){const e=function(e){let t={},n={},i=[];e.forEach((function(e){const[n,i]=e.split("=").map((e=>e.trim()));t[n]=i}));const o=e.map((e=>e.split("=").map((e=>e.trim())))),a=o.map((e=>e[0]));for(const e of o){let[o,r]=e;o in n||([n,,i]=ra(o,t,n,[o],a,[]))}i.length>0&&Fa("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+".");return Object.keys(n).map((e=>[e,n[e]]))}(ea().split(";").filter((e=>e.length>0))),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}(na());if(t.length>0)return Fa("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=oa(t[0],t[1]);n|=n,i|=o}return n&&!i}function oa(e,t){let n=!1,i=!1;const o=ta(e);return Jo(o)?(Fa("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!P.hasOwnProperty(o),P[o]={type:"float",value:t}),[n,i]}function aa(){return ta(na().map((e=>"uniform float "+e+";")).join("\n"))}function ra(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const l of o)r=new RegExp("\\b"+l+"\\b","g"),r.test(t[e])&&(i.includes(l)?(n[l]=0,t[l]="0",t[e]="0",a.push(l)):([n,,a]=ra(l,t,n,[...i,l],o,a),t[e]=t[e].replaceAll(r,n[l].toString())));try{n[e]=fi.evaluate(t[e])}catch(t){Fa("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function la(){zi(),lo(),Di(),fo(),Ei(),ho()}function sa(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+Xt[e])););return n}function ua(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function ca(e){return e.reduce(((e,t)=>e+t),0)/3}function da(){let e=mo();k.minColourValue=e[0],k.maxColourValue=e[1],P.maxColourValue.value=k.maxColourValue,P.minColourValue.value=k.minColourValue,Ce.updateDisplay(),we.updateDisplay(),Ro()}function fa(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function pa(e){let t;null!=ri&&(t=ri);const n=k.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,It.length),i=k.reactionNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,Nt.length),o=n.concat(Lt.slice(n.length)),a=i.concat(Mt.slice(i.length)),r=na();let l;for(var s=0;s<o.length;s++)if(Jo(o[s],r.concat(a)))return l=r.includes(o[s])?"as a parameter":a.includes(o[s])?"as a reaction":"under the hood",void alert("The name '"+o[s]+"' is used "+l+", so can't be used as a species name. Please use a different name for "+o[s]+".");for(s=0;s<a.length;s++)if(Jo(a[s],r.concat(o[s])))return l=r.includes(a[s])?"as a parameter":o.includes(a[s])?"as a reaction":"under the hood",void alert("The name '"+a[s]+"' is used "+l+", so can't be used as a function name. Please use a different name for "+a[s]+".");ri=o,li=a,function(){si=[];for(let e=0;e<ri.length;e++)si.push("(?:"+ri.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let u={...ni(),...oi()};Object.keys(u).forEach((function(e){ci[e]=wo(ma(u[e],It,ri,"_[xy]"))})),u=ii(),Object.keys(u).forEach((function(e){ci[e]=wo(ma(u[e],Nt,li))})),e||(Object.keys(k).forEach((function(e){pi.includes(e)&&(k[e]=ma(k[e],t,ri,"_[xy]"))})),k.views=k.views.map((function(e){let n={};return n.name=e.name,Object.keys(e).forEach((function(i){pi.includes(i)&&(n[i]=ma(e[i],t,ri,"_[xy]"))})),n})),Object.keys(N).forEach((function(e){pi.includes(e)&&(N[e]=ma(N[e],t,ri,"_[xy]"))})),N.views=N.views.map((function(e){let n={};return n.name=e.name,Object.keys(e).forEach((function(i){pi.includes(i)&&(n[i]=ma(e[i],t,ri,"_[xy]"))})),n})),vo(),bo(),la(),yo())}function ma(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function ha(e){e=e.clamp(0,1);let t=0;for(;e>=Q[t+1]&&t<R.length-2;)t+=1;return Q[t+1]==Q[t]?R[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=ga(e[o],t[o],n);return i}(R[t],R[t+1],(e-Q[t])/(Q[t+1]-Q[t])).map((e=>e.clamp(0,1)))}function ga(e,t,n){return(1-n)*e+n*t}function ba(){V.linewidth=.01*k.lineWidthMul,V.needsUpdate=!0}function va(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function Sa(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function ya(e){e.forEach((function(e){Ct.add(e)})),yo()}function wa(e){e.forEach((function(e){Ct.delete(e)})),yo()}function Ca(){zt=new Float32Array(ct*dt*4),l.readRenderTargetPixels(vt[1],0,0,ct,dt,zt),$a(zt),Ft=!0}function Va(){Ft||Ca();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([ct,dt]),zt])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function xa(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);$a(e.slice(2),e.slice(0,2)),Ua(h),Ft=!0,Oi()},t.readAsArrayBuffer(e)}function Ua(e){if(null!=e)if("crop"==k.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=s/t;i>1&&(n=t/s,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function $a(e,t){null!=h&&h.dispose(),null==t&&(t=[ct,dt]),h=new zn.DataTexture(e,t[0],t[1],zn.RGBAFormat,zn.FloatType),h.needsUpdate=!0,h.magFilter=n?zn.NearestFilter:zn.LinearFilter,null!=U&&(U.map=h,U.needsUpdate)}function _a(){l.setSize(Math.round(devicePixelRatio*ht),Math.round(devicePixelRatio*gt),!1)}function Fa(e){Li(),$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),Ao("#error"),$("#error").one("click",(function(){To("#error")})))}function Ea(e){if(/\(\s*\)/.test(e))return Fa("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(Fa("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(Fa("A binary operator is missing an operand in "+e.trim()+"."),!1)}function Da(){let e;$("#views_list").empty();for(let t=0;t<k.views.length;t++)e=document.createElement("a"),e.onclick=function(){k.activeViewInd=t,Aa(k.views[t])},e.innerHTML="<div class='view_label'>"+k.views[t].name+"</div>",t==k.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);Et=Math.max(k.views.length,Et),k.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),k.views.length}function Aa(e,t){Object.assign(k,e),delete k.name,Yi(O),(null==t||t)&&(fo(),Xo(),Ai(),Ci(),Ro(),Wo(),nr(),Wi())}function Ta(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",k.views[k.activeViewInd].name);null!=e&&(k.views[k.activeViewInd].name=e,Da(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function Wa(){k.views.length>1?(k.views.splice(k.activeViewInd,1),k.activeViewInd<1?k.activeViewInd=0:k.activeViewInd-=1):k.views[k.activeViewInd].name="Custom",Aa(k.views[k.activeViewInd])}function Ra(){let e={};return di.forEach((function(t){e[t]=N[t]})),e}function Qa(e){k.activeViewInd<k.views.length&&(k.views[k.activeViewInd][e]=k[e])}function ka(e,t){let n="";return n+=io(vn(t),ri[e]),k.dimension>1&&(n+=io(Sn(t),ri[e])),n}function Pa(e,t){let n="";return n+=io(hn(t),ri[e]),k.dimension>1&&(n+=io(gn(t),ri[e])),n}function Ia(e,t){let n="";return n+=io(vn(t),ri[e]),k.dimension>1&&(n+=io(Sn(t),ri[e])),n}function Na(e,t){let n="";return n+=io(hn(t).replaceAll(/updated/g,"gl_FragColor"),ri[e]),k.dimension>1&&(n+=io(gn(t).replaceAll(/updated/g,"gl_FragColor"),ri[e])),n}function La(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function Ma(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function Oa(e,t,n,i,o,a,r,l){const s=document.createElement("a");if(s.classList.add("toggle_button"),s.setAttribute("property",t),null==i&&(i=()=>{}),s.onclick=function(){k[s.getAttribute("property")]=!k[s.getAttribute("property")],rr(s),i()},null!=o&&(s.id=o),null!=a&&(s.title=a),null!=n&&(s.innerHTML=n),null!=r&&s.setAttribute("folderID",r),null!=l)for(const e of l)s.classList.add(e);return e.appendChild(s),rr(s),s}function qa(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function Ba(){let e=po(k,On("default"));1==k.views.length&&"1"==k.views[0].name&&delete e.views;for(const e of Object.keys(k.views[0]))k.hasOwnProperty(e)&&k.views.map((t=>t[e])).every((t=>t==k[e]))&&k.views.forEach((t=>delete t[e]));e.preset="PRESETNAME";let t=JSON.stringify(e).replaceAll(/\s*,\s*([^0-9-\.\s])/g,",\n\t$1").replaceAll(":",": ").replaceAll("  "," ").replace("{","{\n\t").replace("}",",\n}");t='case "PRESETNAME":\n\toptions = '+t+";\nbreak;",navigator.clipboard.writeText(t)}function ja(){let t="";t+=JSON.stringify(k),t+=JSON.stringify(P),t+=JSON.stringify({nXDisc:ct,nYDisc:dt,domainHeight:pt,domainWidth:ft,aspectRatio:s,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(t)}function Ga(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function za(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function Ja(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function Ha(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function Xa(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function Za(){let e=po(k,On("default"));return e.preset="Custom",e=Yn(e),[location.href.replace(location.search,""),"?options=",ei.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function Ya(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function Ka(e){const t=kt[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function er(){P.embossAmbient.value=k.embossAmbient,P.embossDiffuse.value=k.embossDiffuse,P.embossShiny.value=k.embossShiny,P.embossSmoothness.value=k.embossSmoothness,P.embossSpecular.value=k.embossSpecular,P.embossLightDir.value=new zn.Vector3(Math.sin(k.embossTheta)*Math.cos(k.embossPhi),Math.sin(k.embossTheta)*Math.sin(k.embossPhi),Math.cos(k.embossTheta))}function tr(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function nr(){for(const e of[...wt,...yt]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function ir(){P.contourColour.value=new zn.Color(k.contourColour),P.contourEpsilon.value=k.contourEpsilon,P.contourStep.value=1/(k.contourNum+1)}function or(){P.overlayColour.value=new zn.Color(k.overlayColour),P.overlayEpsilon.value=k.overlayEpsilon}function ar(){nt||Wi()}function rr(e){k[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function lr(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function sr(){k.customSurface?b.vertexShader=In():b.vertexShader=Pn(),b.needsUpdate=!0}function ur(){"surface"==k.plotType?($("#customSurfaceToggle").show(),k.customSurface?(to(be),eo(ge)):(eo(be),to(ge))):($("#customSurfaceToggle").hide(),eo(be))}bi&&Xi("GrayScott"),Vt=gi.has("story"),Vt&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),Ke.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),Wo(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),ut=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),(Do()||bi||k.forceTryClickingPopup)&&!k.suppressTryClickingPopup&&k.brushEnabled&&($("#top_message").html("<p>"+k.tryClickingText+"</p>"),Ao("#top_message"),setTimeout((()=>To("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>To("#top_message")))),$("#settings").click((function(){Ga(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&Ha(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&Xa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&za(),$("#views_ui").is(":visible")&&Ja()),$("#left_ui").is(":visible")&&ua()})),$("#equations").click((function(){za(),ua(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&Ga(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&Ja()})),$("#pause").click((function(){Li()})),$("#play").click((function(){Mi()})),$("#erase").click((function(){Oi()})),$("#warning_restart").click((function(){$("#oops_hit_nan").hide(),Oi()})),$("#share").click((function(){Xa(),$("#help_panel").is(":visible")&&Ha()})),$("#help").click((function(){Ha(),$("#share_panel").is(":visible")&&Xa()})),$("#screenshot").click((function(){Jt=!0,Wi(),Xa()})),$("#link").click((function(){I.copyConfigAsURL(),Xa()})),$("#embed").click((function(){!function(){let e=Za();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}Ya('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),Xa()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){Ha()})),$("#views").click((function(){Ja(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&Ga(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&za()})),$(document).on("click","#add_view",(function(){!function(){let e=Ra();e.name=++Et,k.views.push(e),k.activeViewInd=k.views.length-1,Da()}()})),function e(){requestAnimationFrame(e),ot=it,it&&k.brushEnabled&&function(){!k.fixRandSeed&&k.brushValue.includes("RAND")&&ro();F.material=v;for(let e=1;e<vt.length;e++)P.textureSource.value=vt[e].texture,l.setRenderTarget(vt[e-1]),l.render(r,o);vt.rotate(-1)}();if(nt){!at||function(){F.material=S;for(let e=1;e<vt.length;e++)P.textureSource.value=vt[e].texture,l.setRenderTarget(vt[e-1]),l.render(r,o);vt.rotate(-1)}();for(let e=0;e<k.numTimestepsPerFrame;e++)xt&&!k.fixRandSeed&&ro(),Ti()}(ot||nt)&&Wi()}();