let e,t,n,i,o,a,r,l,s,u,c,d,f,p,m,h,g,_,b,v,y,S,w,C,x,F,E,A,T,D,U,P,V,k,R,M,I,N,L,O,q,B,W,j,Q,z,G,J,X,H,Y,Z,K,ee,te,ne,ie,oe,ae,re,le,se,ue,ce,de,fe,pe,me,he,ge,_e,be,ve,ye,Se,we,Ce,xe,Fe,$e,Ee,Ae,Te,De,Ue,Pe,Ve,ke,Re,Me,Ie,Ne,Le,Oe,qe,Be,We,je,Qe,ze,Ge,Je,Xe,He,Ye,Ze,Ke,et,tt,nt,it,ot,at,rt,lt,st,ut,ct,dt,ft,pt,mt,ht,gt,_t,bt,vt,yt,St,wt,Ct,xt,Ft,$t,Et,At,Tt,Dt,Ut,Pt,Vt,kt,Rt=[],Mt={},It=[],Nt=[],Lt=new Set,Ot=!0,qt=!1,Bt=!0,Wt=!0,jt=!1,Qt=!1,zt=!1,Gt=!1,Jt=!1,Xt=!1,Ht=0,Yt=!1,Zt=!0,Kt=1,en=1,tn=.15,nn={},on=[],an={},rn=0;const ln=["u","v","w","q"],sn=["UFUN","VFUN","WFUN","QFUN"],un=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"];let cn,dn,fn,pn,mn,hn,gn,_n=!1,bn=!1;const vn=["zero","one","two","three","four","five","six","seven","eight","nine"];import{drawShaderTop as yn,drawShaderBotReplace as Sn,drawShaderBotAdd as wn,drawShaderShapeDisc as Cn,drawShaderShapeVLine as xn,drawShaderShapeHLine as Fn,drawShaderFactorSharp as $n,drawShaderFactorSmooth as En}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as An,computeDisplayFunShaderMid as Tn,postGenericShaderBot as Dn,postShaderDomainIndicator as Un,interpolationShader as Pn}from"./post_shaders.js";import{copyShader as Vn}from"../copy_shader.js";import{RDShaderTop as kn,RDShaderBot as Rn,RDShaderDirichletX as Mn,RDShaderDirichletY as In,RDShaderDirichletIndicatorFun as Nn,RDShaderRobinX as Ln,RDShaderRobinY as On,RDShaderRobinCustomDomainX as qn,RDShaderRobinCustomDomainY as Bn,RDShaderUpdateNormal as Wn,RDShaderUpdateCross as jn,RDShaderAlgebraicSpecies as Qn,RDShaderEnforceDirichletTop as zn,RDShaderAdvectionPreBC as Gn,RDShaderAdvectionPostBC as Jn,RDShaderDiffusionPreBC as Xn,RDShaderDiffusionPostBC as Hn,RDShaderGhostX as Yn,RDShaderGhostY as Zn,RDShaderMain as Kn}from"./simulation_shaders.js";import{randShader as ei,randNShader as ti}from"../rand_shader.js";import{fiveColourDisplayTop as ni,fiveColourDisplayBot as ii,embossShader as oi,contourShader as ai,surfaceVertexShaderColour as ri,surfaceVertexShaderCustom as li,overlayShader as si}from"./display_shaders.js";import{getColours as ui}from"../colourmaps.js";import{genericVertexShader as ci}from"../generic_shaders.js";import{getPreset as di,getUserTextFields as fi,getFieldsInView as pi,getListOfPresets as mi,getOldPresetFieldsToNew as hi}from"./presets.js";import{clearShaderBot as gi,clearShaderTop as _i}from"./clear_shader.js";import*as bi from"../three.module.min.js";import{OrbitControls as vi}from"../OrbitControls.js";import{Line2 as yi}from"../lines/Line2.js";import{LineMaterial as Si}from"../lines/LineMaterial.js";import{LineGeometry as wi}from"../lines/LineGeometry.js";import{minifyPreset as Ci,maxifyPreset as xi}from"./minify_preset.js";import{LZString as Fi}from"../lz-string.min.js";import{equationTEXFun as $i,getDefaultTeXLabelsDiffusion as Ei,getDefaultTeXLabelsReaction as Ai,getDefaultTeXLabelsBCsICs as Ti,substituteGreek as Di}from"./TEX.js";let Ui,Pi,Vi,ki=$i(),Ri={...Ei(),...Ai(),...Ti()};const Mi=pi();let Ii=new exprEval.Parser;Ii.consts.pi=Math.PI,Ii.consts.Pi=Math.PI,Ii.consts.e=Math.exp(1),B={};const Ni=fi();var Li,Oi;j={reset:function(){mo()},toggleRunning:function(){_t?fo():po()},copyConfigAsURL:function(){xr(Cr())},saveSimState:function(){Ja()},exportSimState:function(){Xa()},clearCheckpoints:function(){Xt&&(h.dispose(),h=null,Xt=!1)},restoreCurrentView:function(){var e;B.activeViewInd<B.views.length&&(e=B.activeViewInd,B.views[e]=Ct[e],ir(B.views[e]))}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(Li=Array.prototype.push,Oi=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,Li.apply(this,Oi.call(this,0,e)),this}),Array.prototype.last=function(){return this[this.length-1]},e=document.getElementById("simCanvas"),console.error=function(e){Gt=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),er(t.toString().trim()+". Click <a href='/user-guide/FAQ#undeclared' target='blank'>here</a> for more information.")},ta()||$("#logo").hide();const qi=new URLSearchParams(window.location.search);if(qi.has("no_ui")?($(".ui").addClass("hidden"),Jt=!0):$(".ui").removeClass("hidden"),qi.has("logo_only")&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),Jt=!0),qi.has("sf")&&(en=parseFloat(qi.get("sf")),(isNaN(en)||en<=0)&&(en=1)),!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("warning"==e[t].split("=")[0].trim())return!0}return!1}()&&!Jt){$("#warning").css("display","block");await Promise.race([ba(document.getElementById("warning_ok"),"click",!0),ba(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="warning=true;"+t+";path=/"}(),$("#warning").css("display","none")}Co("default"),function(){W={brushCoords:{type:"v2",value:new bi.Vector2(.5,.5)},colour1:{type:"v4",value:new bi.Vector4(0,0,0,0)},colour2:{type:"v4",value:new bi.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new bi.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new bi.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new bi.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},overlayLine:{type:"bool",value:!0},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},vectorField:{type:"bool",value:!1}},bt=!1,c=new bi.Raycaster,d=new bi.Vector2,l=new bi.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),l.autoClear=!0,t=l.getContext(),Ut=t.getParameter(t.MAX_TEXTURE_SIZE),n=!(t.getExtension("OES_texture_float_linear")&&t.getExtension("EXT_float_blend")),m={format:bi.RGBAFormat,type:bi.FloatType,minFilter:bi.NearestFilter},n|=/android/i.test(navigator.userAgent),m.magFilter=n?bi.NearestFilter:bi.LinearFilter,Rt.push(new bi.WebGLRenderTarget(B.maxDisc,B.maxDisc,m)),Rt.push(Rt[0].clone()),Rt.push(Rt[0].clone()),Rt.push(Rt[0].clone()),Rt.push(Rt[0].clone()),f=Rt[0].clone(),p=Rt[0].clone(),Rt.forEach((e=>{e.texture.wrapS=bi.RepeatWrapping,e.texture.wrapT=bi.RepeatWrapping})),f.texture.wrapS=bi.ClampToEdgeWrapping,f.texture.wrapT=bi.ClampToEdgeWrapping,p.texture.wrapS=bi.ClampToEdgeWrapping,p.texture.wrapT=bi.ClampToEdgeWrapping,i=new bi.OrthographicCamera(-.5,.5,.5,-.5,-1,10),u=new vi(i,e),u.listenToKeyEvents(document),u.addEventListener("change",(function(){"surface"==B.plotType&&(B.cameraTheta=90-180*Math.acos(i.position.y)/Math.PI,B.cameraPhi=-180*Math.atan2(i.position.x,i.position.z)/Math.PI,B.cameraZoom=i.zoom,lr("cameraTheta"),lr("cameraPhi"),lr("cameraZoom"),xo(J),Ur())})),o=new bi.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new bi.Scene,r=new bi.Scene,a.add(i),a.background=new bi.Color(B.backgroundColour),g=new bi.MeshBasicMaterial({side:bi.DoubleSide}),_=new bi.ShaderMaterial({uniforms:W,vertexShader:ci(),transparent:!0,side:bi.DoubleSide}),w=new bi.ShaderMaterial({uniforms:W,vertexShader:ci()}),E=new bi.ShaderMaterial({uniforms:W,vertexShader:ci(),fragmentShader:Pn()}),b=new bi.ShaderMaterial({uniforms:W,vertexShader:ci()}),Mt.FE=new bi.ShaderMaterial({uniforms:W,vertexShader:ci()}),Mt.AB2=new bi.ShaderMaterial({uniforms:W,vertexShader:ci()});for(let e=1;e<3;e++)Mt["Mid"+e.toString()]=new bi.ShaderMaterial({uniforms:W,vertexShader:ci()});for(let e=1;e<5;e++)Mt["RK4"+e.toString()]=new bi.ShaderMaterial({uniforms:W,vertexShader:ci()});S=new bi.ShaderMaterial({uniforms:W,vertexShader:ci(),fragmentShader:Vn()}),y=new bi.ShaderMaterial({uniforms:W,vertexShader:ci()}),v=new bi.ShaderMaterial({uniforms:W,vertexShader:ci()}),C=new Si({vertexColors:!0,linewidth:.01}),x=new Si({color:0,linewidth:.01}),F=new bi.MeshBasicMaterial({color:B.arrowColour,side:bi.DoubleSide}),A=new bi.MeshBasicMaterial,T=new bi.CylinderGeometry(.008,.008,.1),D=new bi.ConeGeometry(.04,.04,4);const s=new bi.PlaneGeometry(1,1);P=new bi.Mesh(s,Mt[0]),P.position.z=0,P.matrixWorldAutoUpdate=!1,r.add(P),Xi(),Hi(),zi(),Zi(),ji(),Ki(),Bo(),jo(),to(),eo(),Vo(),ga(),mo(),e.addEventListener("pointerdown",ro),e.addEventListener("pointerup",lo),e.addEventListener("pointermove",so),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(j.toggleRunning(),e.preventDefault()),"h"===e.key&&(Jt?(Jt=!1,$(".ui").removeClass("hidden"),pt.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",xt),_t?po():fo(),ha(),xa(),ka()):(Jt=!0,$(".ui").addClass("hidden"))),"s"==e.key&&Ja(),"c"==e.key&&(B.resetFromCheckpoints=!B.resetFromCheckpoints,Pr($("#checkpointButton")[0])))})),window.addEventListener("resize",(function(){ji(),Ur()}),!1),window.addEventListener("message",Fr),$("#checkpointInput").change((function(){Ha(this.files[0]),this.value=null}))}();let Bi=!0;if(qi.has("preset")&&(wo(qi.get("preset")),Bi=!1),qi.has("options")){var Wi=JSON.parse(Fi.decompressFromEncodedURIComponent(qi.get("options")));Wi.hasOwnProperty("p")&&(Wi=xi(Wi)),wo(Wi),Bi=!1}function ji(){Xi(),function(){P.material=S;for(let e=1;e<Rt.length;e++)W.textureSource.value=Rt[e].texture,Rt[e-1].setSize($t,Et),l.setRenderTarget(Rt[e-1]),l.render(r,o);Rt.rotate(-1),Rt[0].dispose(),Rt[0]=Rt[1].clone(),f.setSize($t,Et),ao(),p.setSize(Math.round(devicePixelRatio*Pt),Math.round(devicePixelRatio*Vt))}(),Ya(h),Gi(),Qi(),Lr(),zi(),xa(),ka()}function Qi(){U.geometry.dispose(),a.remove(U),V.geometry.dispose(),a.remove(V),k.geometry.dispose(),a.remove(k),R.geometry.dispose(),a.remove(R),Hi()}function zi(){switch(Ji(),B.plotType){case"line":u.enabled=!1,i.zoom=1,Ca(),_.vertexShader=ri();break;case"plane":u.enabled=!1,u.reset(),_.vertexShader=ci();break;case"surface":u.enabled=!0,i.zoom=B.cameraZoom,Ca(),kr()}_.needsUpdate=!0,i.left=-At/(2*Dt),i.right=At/(2*Dt),i.top=Tt/(2*Dt),i.bottom=-Tt/(2*Dt),i.updateProjectionMatrix(),Yi()}function Gi(){W.L.value=Kt,W.L_y.value=Tt,W.L_x.value=At,W.L_min.value=Math.min(Tt,At),W.dt.value=B.dt,W.dx.value=Ft,W.dy.value=Ft,W.heightScale.value=B.threeDHeightScale,W.maxColourValue.value=B.maxColourValue,W.minColourValue.value=B.minColourValue,W.customSurface.value=B.customSurface,W.vectorField.value=B.vectorField,$r(),Po()}function Ji(){try{Kt=Ii.evaluate(B.domainScale)}catch(e){er("Unable to evaluate the domain length. Please check the definition."),Kt=100}Pt=Math.round(e.getBoundingClientRect().width),Vt=Math.round(e.getBoundingClientRect().height),s=Vt/Pt,s<=0&&(s=.1),s>=1?(Tt=Kt,At=Tt/s):(At=Kt,Tt=At*s),1==B.dimension&&(At=Kt),W.L_x.value=At,W.L_y.value=Tt,Dt=Math.max(At,Tt)}function Xi(){Ji(),Ft=Kt/100;try{Ft=Ii.evaluate(B.spatialStep)}catch(e){er("Unable to evaluate the spatial step. Please check the definition.")}Ft<=0&&(er("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),Ft=Kt/100),$t=Math.floor(At/Ft),Et=Math.floor(Tt/Ft),($t>Ut||Et>Ut)&&(er("Your device does not support a discretisation this fine (maximum "+Ut+"). Please increase the space step to at least "+(Math.ceil(1e4*Kt/Ut)/1e4).toPrecision(4)+" or reduce the domain size to at most "+(Math.floor(1e4*Ut*Ft)/1e4).toPrecision(4)+"."),$t=Math.min($t,Ut),Et=Math.min(Et,Ut)),0==$t&&($t=1),0==Et&&(Et=1),1==B.dimension&&(Et=1),W.nXDisc.value=$t,W.nYDisc.value=Et,M=new Array($t),I=new Array($t);let e=-.5,t=$t>1?1/($t-1):.5;for(let n=0;n<M.length;n++)M[n]=e,e+=t;M=M.map((e=>e*At/Dt)),Ka(),mn=new Float32Array($t*Et*4),bn=!1}function Hi(){Ji();let e=[1,1];Zt||(e=[$t,Et]);const t=new bi.PlaneGeometry(At/Dt,Tt/Dt,e[0],e[1]);U=new bi.Mesh(t,_),U.position.z=0,U.visible="line"!=B.plotType,U.matrixAutoUpdate=!1,a.add(U);const n=new bi.PlaneGeometry(At/Dt,Tt/Dt,1,1);V=new bi.Mesh(n,g),V.position.z=0,V.visible=!1,V.matrixAutoUpdate=!1,a.add(V),Yi();const i=new wi;N=Math.round(2*devicePixelRatio*Pt);const o=new Array(3*N).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),k=new yi(i,C),k.scale.set(1,1,1),k.visible="line"==B.plotType,a.add(k);const l=new wi,s=new Array(3*N).fill(0);l.setPositions(s),R=new yi(l,x),R.scale.set(1,1,1),R.visible="line"==B.plotType&&B.overlay,a.add(R)}function Yi(){switch(B.plotType){case"plane":U.rotation.x=0,V.rotation.x=0;break;case"surface":U.rotation.x=-Math.PI/2,V.rotation.x=-Math.PI/2}U.updateMatrix(),V.updateMatrix()}function Zi(){B.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Ki(e){z=new dat.GUI({closeOnTop:!0,autoPlace:!1}),z.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(z.domElement),G=new dat.GUI({closeOnTop:!0,autoPlace:!1}),G.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(G.domElement),J=new dat.GUI({closeOnTop:!0,autoPlace:!1}),J.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(J.domElement),z.open(),G.open(),J.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),X=G.addFolder("Brush");mr(fr(X),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',jr,null,"Toggle the brush on or off");X.add(B,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange((function(){to(),document.activeElement.blur()}));H=X.add(B,"brushType",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange((function(){to(),document.activeElement.blur()})),X.add(B,"brushValue").name("Value").onFinishChange(to),X.add(B,"brushRadius").name("Radius").onFinishChange(to),Ce=X.add(B,"whatToDraw",Ui).name("Species").onChange(to),X=G.addFolder("Domain"),X.add(B,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){wa(),document.activeElement.blur(),Ur()})),X.add(B,"domainScale").name("Largest side").onFinishChange((function(){ji(),Ur()})),X.add(B,"spatialStep").name("Space step").onFinishChange((function(){ji(),Ur()})),X.add(B,"minX").name("Min. $x$").onFinishChange((function(){jo(),mo()})),ne=X.add(B,"minY").name("Min. $y$").onFinishChange((function(){jo(),mo()}));const t=fr(X);mr(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){Zi(),ji(),zi(),Ur()}),null,"Use a square domain"),mr(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Custom',(function(){Wo(),Bo(),vo(),Oo(),Ur()}),null,"Specify a custom domain"),ie=X.add(B,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){Wo(),Bo(),vo(),Io(),Ur()})),X=G.addFolder("Timestepping"),tt=X.add(B,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),Er(tt,1,400,1),ye=X.add(B,"dt").name("Timestep").onChange((function(){Gi()})),ye.__precision=12,ye.min(0),ye.updateDisplay(),X.add(B,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme").onChange((function(){document.activeElement.blur()}));const n=fr(X);mr(n,"timeDisplay",'<i class="fa-regular fa-hourglass-half"></i> Elapsed time',sa,null,"Show/hide time display"),mr(n,"autoPause",'<i class="fa-regular fa-hourglass-end"></i> Auto pause',(function(){Bt=W.t.value<B.autoPauseAt,Bo()}),null,"Toggle automatic pausing"),Se=X.add(B,"autoPauseAt").name("Pause at $t=$").onFinishChange((function(){Bt=W.t.value<B.autoPauseAt,Se.domElement.blur()})),X=G.addFolder("Equations"),X.add(B,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange((function(){document.activeElement.blur(),jo(),mo()})),te=X.add(B,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Yt=!0,jo(),Yt=!1,mo()})),X.add(B,"speciesNames").name("Species names").onFinishChange((function(){Na()}));mr(fr(X),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',(function(){jo()}),"cross_diffusion_controller","Toggle cross diffusion"),X=z.addFolder("Definitions");mr(fr(X),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',Qo,null,"Typeset the specified equations"),oe=X.add(B,"diffusionStr_1_1").onFinishChange((function(){vo(),Qo()})),ja(oe,za,["U","UU"]),Qa(oe,Ga,["U","UU"]),ae=X.add(B,"diffusionStr_1_2").onFinishChange((function(){vo(),Qo()})),ja(ae,za,["UV"]),Qa(ae,Ga,["UV"]),re=X.add(B,"diffusionStr_1_3").onFinishChange((function(){vo(),Qo()})),ja(re,za,["UW"]),Qa(re,Ga,["UW"]),le=X.add(B,"diffusionStr_1_4").onFinishChange((function(){vo(),Qo()})),ja(le,za,["UQ"]),Qa(le,Ga,["UQ"]),se=X.add(B,"diffusionStr_2_1").onFinishChange((function(){vo(),Qo()})),ja(se,za,["VU"]),Qa(se,Ga,["VU"]),ue=X.add(B,"diffusionStr_2_2").onFinishChange((function(){vo(),Qo()})),ja(ue,za,["V","VV"]),Qa(ue,Ga,["V","VV"]),ce=X.add(B,"diffusionStr_2_3").onFinishChange((function(){vo(),Qo()})),ja(ce,za,["VW"]),Qa(ce,Ga,["VW"]),de=X.add(B,"diffusionStr_2_4").onFinishChange((function(){vo(),Qo()})),ja(de,za,["VQ"]),Qa(de,Ga,["VQ"]),fe=X.add(B,"diffusionStr_3_1").onFinishChange((function(){vo(),Qo()})),ja(fe,za,["WU"]),Qa(fe,Ga,["WU"]),pe=X.add(B,"diffusionStr_3_2").onFinishChange((function(){vo(),Qo()})),ja(pe,za,["WV"]),Qa(pe,Ga,["WV"]),me=X.add(B,"diffusionStr_3_3").onFinishChange((function(){vo(),Qo()})),ja(me,za,["W","WW"]),Qa(me,Ga,["W","WW"]),he=X.add(B,"diffusionStr_3_4").onFinishChange((function(){vo(),Qo()})),ja(he,za,["WQ"]),Qa(he,Ga,["WQ"]),ge=X.add(B,"diffusionStr_4_1").onFinishChange((function(){vo(),Qo()})),ja(ge,za,["QU"]),Qa(ge,Ga,["QU"]),_e=X.add(B,"diffusionStr_4_2").onFinishChange((function(){vo(),Qo()})),ja(_e,za,["QV"]),Qa(_e,Ga,["QV"]),be=X.add(B,"diffusionStr_4_3").onFinishChange((function(){vo(),Qo()})),ja(be,za,["QW"]),Qa(be,Ga,["QW"]),ve=X.add(B,"diffusionStr_4_4").onFinishChange((function(){vo(),Qo()})),ja(ve,za,["Q","QQ"]),Qa(ve,Ga,["Q","QQ"]),Y=X.add(B,"reactionStr_1").onFinishChange((function(){vo(),Qo()})),ja(Y,za,["UFUN"]),Qa(Y,Ga,["UFUN"]),Z=X.add(B,"reactionStr_2").onFinishChange((function(){vo(),Qo()})),ja(Z,za,["VFUN"]),Qa(Z,Ga,["VFUN"]),K=X.add(B,"reactionStr_3").onFinishChange((function(){vo(),Qo()})),ja(K,za,["WFUN"]),Qa(K,Ga,["WFUN"]),ee=X.add(B,"reactionStr_4").onFinishChange((function(){vo(),Qo()})),ja(ee,za,["QFUN"]),Qa(ee,Ga,["QFUN"]),kt=z.addFolder("Parameters"),function(){let e,t,n=[],i=B.kineticParams.split(";");for(var o=0;o<i.length;o++)t=Zo(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+rn,rn+=1,on.push(e),nn[e]=t,n.push(e));for(const e of n)Ko(e,!1);e="param"+rn,on.push(e),nn[e]=t,Ko(e,!0)}(),X=z.addFolder("Boundary conditions"),Le=X.add(B,"boundaryConditions_1",{}).onChange((function(){vo(),Uo(),document.activeElement.blur()})),We=X.add(B,"dirichletStr_1").onFinishChange(vo),Ye=X.add(B,"neumannStr_1").onFinishChange(vo),nt=X.add(B,"robinStr_1").onFinishChange(vo),Ge=X.add(B,"comboStr_1").name("Details").onFinishChange(vo),Oe=X.add(B,"boundaryConditions_2",{}).onChange((function(){vo(),Uo(),document.activeElement.blur()})),je=X.add(B,"dirichletStr_2").onFinishChange(vo),Ze=X.add(B,"neumannStr_2").onFinishChange(vo),it=X.add(B,"robinStr_2").onFinishChange(vo),Je=X.add(B,"comboStr_2").name("Details").onFinishChange(vo),qe=X.add(B,"boundaryConditions_3",{}).onChange((function(){vo(),Uo(),document.activeElement.blur()})),Qe=X.add(B,"dirichletStr_3").onFinishChange(vo),Ke=X.add(B,"neumannStr_3").onFinishChange(vo),ot=X.add(B,"robinStr_3").onFinishChange(vo),Xe=X.add(B,"comboStr_3").name("Details").onFinishChange(vo),Be=X.add(B,"boundaryConditions_4",{}).name("$q$").onChange((function(){vo(),Uo(),document.activeElement.blur()})),ze=X.add(B,"dirichletStr_4").onFinishChange(vo),et=X.add(B,"neumannStr_4").onFinishChange(vo),at=X.add(B,"robinStr_4").onFinishChange(vo),He=X.add(B,"comboStr_4").name("Details").onFinishChange(vo),X=z.addFolder("Initial conditions"),Re=X.add(B,"initCond_1").onFinishChange(Vo),Me=X.add(B,"initCond_2").onFinishChange(Vo),Ie=X.add(B,"initCond_3").onFinishChange(Vo),Ne=X.add(B,"initCond_4").onFinishChange(Vo),rt=G.addFolder("Images"),X=rt,Mo(),X=G.addFolder("Checkpoints");const i=fr(X);mr(i,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),hr(i),pr(i,'<i class="fa-regular fa-flag"></i> Set',Ja,null,"Set a checkpoint at the current state",["narrow"]),pr(i,'<i class="fa-regular fa-file-arrow-down"></i> Export',Xa,null,"Download the last checkpoint as a file",["narrow"]),pr(i,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),X.add(B,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize").onChange((function(){document.activeElement.blur()})),X=G.addFolder("Misc."),X.addColor(B,"backgroundColour").name("Background").onChange((function(){a.background=new bi.Color(B.backgroundColour),Ur()}));const o=fr(X);mr(o,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){ca(),Ur()}),null,"Compute the integral of the plotted expression over the domain"),mr(o,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',(function(){ga(),Ur()}),"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),mr(o,"fixRandSeed",'<i class="fa-regular fa-shuffle"></i> Fix seed',(function(){Bo(),Po()}),null,"Fix the random seed"),we=X.add(B,"randSeed").name("Random seed").onChange(Po),X=X.addFolder("Dev");const r=fr(X);pr(r,'<i class="fa-regular fa-copy"></i> Copy code',gr,null,"Copy the simulation configuration as JSON to the clipboard"),pr(r,'<i class="fa-regular fa-bug"></i> Copy debug',_r,null,"Copy debug information to the clipboard");let l=mi();var s;Object.keys(l).forEach((function(e){l[e]=e})),l.default=null,X.add(B,"parent",(s=l,Object.keys(s).sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})).reduce((function(e,t){return e[t]=s[t],e}),{}))).name("Parent preset").onChange((function(){document.activeElement.blur()}));const u=document.createElement("div");u.innerHTML="Settings",u.classList.add("ui_title"),G.domElement.prepend(u);const c=document.createElement("div");c.innerHTML="Equations",c.classList.add("ui_title"),z.domElement.prepend(c);const d=document.createElement("div");d.id="views_list",J.domElement.prepend(d);const f=document.createElement("div");f.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",f.classList.add("ui_title"),J.domElement.prepend(f),pt=J.addFolder("Edit view"),X=pt;const p=fr(X,"edit_view_buttons");pr(p,'<i class="fa-solid fa-pen-nib"></i> Rename',or,null,"Rename the current view"),pr(p,'<i class="fa-solid fa-xmark"></i> Delete',ar,"deleteViewButton","Delete view"),gt=X.add(B,"whatToPlot").name("Expression: ").onFinishChange((function(){Io(),Ur(),lr(this.property)})),X.add(B,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){Sa(),document.activeElement.blur(),Ur(),lr(this.property)})),X.add(B,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){no(),oa(),document.activeElement.blur(),Ur(),lr(this.property)})).name("Colour map"),Ue=X.add(B,"minColourValue").name("Min value").onChange((function(){Gi(),aa(),Ur(),lr(this.property)})),Ue.__precision=2,Pe=X.add(B,"maxColourValue").name("Max value").onChange((function(){Gi(),aa(),Ur(),lr(this.property)})),Pe.__precision=2;const m=fr(X,"colour_map_buttons");pr(m,'<i class="fa-regular fa-arrows-rotate"></i> Flip',(function(){B.flippedColourmap=!B.flippedColourmap,no(),oa(),Ur(),lr("flippedColourmap")}),null,"Reverse colour map",["narrow"]),pr(m,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){Ma(),oo(),lr("minColourValue"),lr("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),mr(m,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){oa(),lr("colourbar")}),null,"Display the colourbar",null,["narrow"]),hr(m),mr(m,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){B.autoSetColourRange&&(Ma(),oo()),lr("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),mr(m,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){no(),Ur(),lr("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),mr(m,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){no(),Ur(),lr("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),mr(m,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){no(),Ur(),lr("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),mr(m,"vectorField",'<i class="fa-solid fa-arrow-right-arrow-left"></i> Vector field',(function(){Lr(),Ur(),lr("vectorField")}),"vectorFieldButton","Toggle vector field","vectorFieldFolder",["wide"]),X=pt.addFolder("Contours"),X.domElement.id="contoursFolder",X.addColor(B,"contourColour").name("Colour").onChange((function(){Tr(),Ur(),lr(this.property)})),It.push(X.add(B,"contourNum").name("Number").onChange((function(){Tr(),Ur(),lr(this.property)}))),Er(It.last(),1,20,1),It.push(X.add(B,"contourEpsilon").name("Threshold").onChange((function(){Tr(),Ur(),lr(this.property)}))),Er(It.last(),.001,.05,.001),X=pt.addFolder("Lighting"),X.domElement.id="embossFolder",Nt.push(X.add(B,"embossSmoothness").name("Smoothness").onChange((function(){$r(),Ur(),lr(this.property)}))),Er(Nt.last(),0,2,.001),Nt.push(X.add(B,"embossAmbient").name("Ambient").onChange((function(){$r(),Ur(),lr(this.property)}))),Er(Nt.last(),0,1,.001),Nt.push(X.add(B,"embossDiffuse").name("Diffuse").onChange((function(){$r(),Ur(),lr(this.property)}))),Er(Nt.last(),0,1,.001),Nt.push(X.add(B,"embossSpecular").name("Specular").onChange((function(){$r(),Ur(),lr(this.property)}))),Er(Nt.last(),0,1,.001),Nt.push(X.add(B,"embossShiny").name("Precision").onChange((function(){$r(),Ur(),lr(this.property)}))),Er(Nt.last(),0,100,1),Nt.push(X.add(B,"embossTheta").name("Inclination").onChange((function(){$r(),Ur(),lr(this.property)}))),Er(Nt.last(),0,1.5708,.001),Nt.push(X.add(B,"embossPhi").name("Direction").onChange((function(){$r(),Ur(),lr(this.property)}))),Er(Nt.last(),0,3.1456,.001),X=pt.addFolder("Overlay"),X.domElement.id="overlayFolder",X.addColor(B,"overlayColour").name("Colour").onChange((function(){Dr(),Ur(),lr(this.property)})),X.add(B,"overlayExpr").name("Expression").onFinishChange((function(){no(),"line"==B.plotType&&Oo(),Ur(),lr(this.property)})),dt=X.add(B,"overlayEpsilon").name("Threshold").onChange((function(){Dr(),Ur(),lr(this.property)})),ft=X.add(B,"overlayLineWidthMul",.1,2).name("Thickness").onChange((function(){Wa(),Ur(),lr(this.property)})),mt=pt.addFolder("3D"),X=mt,Ee=fr(X),mr(Ee,"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){W.customSurface.value=B.customSurface,kr(),Rr(),Ur(),lr("customSurface")}),null,"Plot the solution on a custom surface"),$e=X.add(B,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){Io(),Ur(),lr(this.property)})),Fe=X.add(B,"threeDHeightScale").name("Height scale").onChange((function(){Gi(),Ur(),lr(this.property)})),Ae=X.add(B,"cameraTheta").name("View $\\theta$").onChange((function(){zi(),Ur(),lr(this.property)})),Te=X.add(B,"cameraPhi").name("View $\\phi$").onChange((function(){zi(),Ur(),lr(this.property)})),De=X.add(B,"cameraZoom").name("Zoom").onChange((function(){zi(),Ur(),lr(this.property)})),xe=X.add(B,"lineWidthMul",.1,2).name("Thickness").onChange((function(){Wa(),Ur(),lr(this.property)})),ht=pt.addFolder("Vector field"),X=ht,X.domElement.id="vectorFieldFolder",X.addColor(B,"arrowColour").name("Colour").onChange((function(){Or(),Ur(),lr(this.property)})),X.add(B,"arrowX").onFinishChange((function(){Oo(),Ur(),lr(this.property)})).name("$x$ component"),X.add(B,"arrowY").onFinishChange((function(){Oo(),Ur(),lr(this.property)})).name("$y$ component"),ut=X.add(B,"arrowDensity").onChange((function(){Lr(),Ur(),lr(this.property)})).name("Density"),ut.__precision=2,Er(ut,0,1,.001),X.add(B,"arrowScale",{None:"none",Relative:"relative",Auto:"auto"}).onFinishChange((function(){Bo(),Ur(),lr(this.property)})).name("Scaling"),ct=X.add(B,"arrowLengthMax").onFinishChange((function(){Lr(),Ur(),lr(this.property)})).name("Max length");document.querySelectorAll("input").forEach((e=>Vr(e)))}function eo(){no(),oa(),Io(),to()}function to(){let e=Da()+yn(),t="float brushRadius = "+_o(B.brushRadius.toString())+";\n";switch(t=t.replace(/\buvwq\./g,"uvwqBrush."),t=t.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(B.brushValue)&&(e+=ei()),/\bRANDN\b/.test(B.brushValue)&&(e+=ti()),e+="float brushValue = "+_o(B.brushValue)+";\n",e+=t,B.brushType){case"circle":e+=Cn();break;case"hline":e+=Fn();break;case"vline":e+=xn()}switch(B.brushAction){case"replace":e+=$n(),e+=Sn();break;case"add":e+=$n(),e+=wn();break;case"smoothreplace":e+=En(),e+=Sn();break;case"smoothadd":e+=En(),e+=wn()}jr(),e=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,Do(B.whatToDraw)),e}(e),e=Br(e),b.fragmentShader=e,b.needsUpdate=!0}function no(){O=ui(B.colourmap),B.flippedColourmap&&(O.reverse(),O=O.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),W.colour1.value=new bi.Vector4(...O[0]),W.colour2.value=new bi.Vector4(...O[1]),W.colour3.value=new bi.Vector4(...O[2]),W.colour4.value=new bi.Vector4(...O[3]),W.colour5.value=new bi.Vector4(...O[4]);let e=Da()+ni();B.emboss&&(e+=oi(),$r()),B.contours&&(e+=ai(),Tr()),B.overlay&&(e+=si().replaceAll("OVERLAYEXPR",_o(B.overlayExpr)),e=Br(e),Dr()),R.visible=B.overlay&&"line"==B.plotType,e+=ii(),_.fragmentShader=e,_.needsUpdate=!0,w.needsUpdate=!0,q=O.map((e=>e[3])),O=O.map((e=>e.slice(0,-1)))}function io(){switch(B.timesteppingScheme){case"Euler":P.material=Mt.FE,W.textureSource.value=Rt[1].texture,W.textureSource1.value=Rt[2].texture,W.dt.value=B.dt,l.setRenderTarget(Rt[0]),l.render(r,o),Rt.rotate(-1),W.t.value+=B.dt;break;case"AB2":P.material=Mt.AB2,W.textureSource.value=Rt[1].texture,W.textureSource1.value=Rt[2].texture,W.dt.value=B.dt,l.setRenderTarget(Rt[0]),l.render(r,o),Rt.rotate(-1),W.t.value+=B.dt;break;case"Mid":P.material=Mt.Mid1,W.textureSource.value=Rt[1].texture,l.setRenderTarget(Rt[2]),l.render(r,o),P.material=Mt.Mid2,W.textureSource1.value=Rt[2].texture,W.t.value+=.5*B.dt,l.setRenderTarget(Rt[0]),l.render(r,o),Rt.rotate(-1),W.t.value+=.5*B.dt;break;case"RK4":P.material=Mt.RK41,W.textureSource.value=Rt[1].texture,l.setRenderTarget(Rt[2]),l.render(r,o),P.material=Mt.RK42,W.textureSource1.value=Rt[2].texture,W.t.value+=.5*B.dt,l.setRenderTarget(Rt[3]),l.render(r,o),P.material=Mt.RK43,W.textureSource2.value=Rt[3].texture,l.setRenderTarget(Rt[4]),l.render(r,o),P.material=Mt.RK44,W.textureSource3.value=Rt[4].texture,W.t.value+=.5*B.dt,l.setRenderTarget(Rt[0]),l.render(r,o),Rt.rotate(-1)}}function oo(){if(ao(),B.autoSetColourRange&&Ma(),B.brushEnabled&&"surface"==B.plotType){let e=0;B.maxColourValue-B.minColourValue>0&&(e=(function(){ma();let e=0;for(let t=0;t<mn.length;t+=4)e+=mn[t];return e/($t*Et)}()-B.minColourValue)/(B.maxColourValue-B.minColourValue)-.5,e=e.clamp(-.5,.5)),V.position.y=B.threeDHeightScale*e,V.updateWorldMatrix()}if("line"==B.plotType){ma();let t=0;var e=B.maxColourValue-B.minColourValue;e=0==e?.5:e;for(let n=0;n<mn.length;n+=4)I[t++]=(mn[n]-B.minColourValue)/e-.5;let n=new bi.SplineCurve(M.map(((e,t)=>new bi.Vector2(e,I[t])))),i=n.getSpacedPoints(N);if(Oa(k,i),function(e,t){let n,i=e.geometry.attributes.instanceColorStart,o=e.geometry.attributes.instanceColorEnd;for(let e=0;e<t.length;e++)n=qa(t[e].toArray()[1]+.5),e<t.length&&i.setXYZ(e,n[0],n[1],n[2]),e>0&&o.setXYZ(e-1,n[0],n[1],n[2]);i.needsUpdate=!0}(k,i),B.overlay){t=0;for(let n=2;n<4*$t;n+=4)I[t++]=(mn[n]-B.minColourValue)/e-.5;n=new bi.SplineCurve(M.map(((e,t)=>new bi.Vector2(e,I[t])))),i=n.getSpacedPoints(N),Oa(R,i)}}if(B.vectorField&&L){gn=new Float32Array($t*Et*4),l.readRenderTargetPixels(f,0,0,$t,Et,gn);let e,t,n,i=[];for(const o of L.children)e=4*o.ind,t=gn[e+2],n=gn[e+3],o.visible=gn[e+1]<=.5,o.lookAt(o.position.x+t,o.position.y+n,o.position.z),o.size=t**2+n**2,i.push(o.size);let o=1;switch(B.arrowScale){case"auto":o=Math.sqrt(Math.max(...i)),0==o&&(o=1);for(const e of L.children){const t=tn*Ba(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"relative":o=L.customMax>0?L.customMax:1;for(const e of L.children){const t=tn*Ba(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"none":for(const e of L.children)e.scale.set(tn,tn,tn)}}if(B.timeDisplay&&ua(),B.integrate&&function(){if(B.integrate){let e;ma(),1==B.dimension?e=W.dx.value:2==B.dimension&&(e=W.dx.value*W.dy.value);let t=0;for(let e=0;e<mn.length;e+=4)t+=mn[e]*(1-mn[e+1]);t*=e,$("#integralValue").html(ra(t,4)),ha()}}(),_a()?(P.material=E,l.setRenderTarget(p),l.render(r,o),W.textureSource.value=p.texture,W.dxUpscaledScale.value=devicePixelRatio*Pt/$t,W.dyUpscaledScale.value=devicePixelRatio*Vt/Et):(W.dxUpscaledScale.value=1,W.dyUpscaledScale.value=1),l.setRenderTarget(null),l.render(a,i),_n){_n=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",l.render(a,i),t.href=l.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Xi(),oo()}}function ao(){P.material=w,W.textureSource.value=Rt[1].texture,l.setRenderTarget(f),l.render(r,o),W.textureSource.value=f.texture,bn=!1,W.textureSource1.value=Rt[1].texture}function ro(t){bt=uo(t,e),bt&&(B.brushEnabled&&"surface"==B.plotType?u.enabled=!1:B.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),na("#top_message"),window.clearTimeout(wt),wt=setTimeout((function(){$("#top_message").hasClass("fading_out")||ia("#top_message")}),3e3)))}function lo(e){bt=!1,"surface"==B.plotType&&(u.enabled=!0)}function so(t){uo(t,e)}function uo(e,t){var n=t.getBoundingClientRect();let o=(e.clientX-n.x)/n.width,a=1-(e.clientY-n.y)/n.height;if("surface"==B.plotType){d.x=2*o-1,d.y=2*a-1,c.setFromCamera(d,i);var r=c.intersectObject(V,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==B.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*$t)/$t,a=Math.round(a*Et)/Et,W.brushCoords.value=new bi.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function co(){l.setSize($t,Et,!1),B.fixRandSeed||Po(),Xt&&B.resetFromCheckpoints?P.material=A:P.material=y,Rt.forEach((e=>{l.setRenderTarget(e),l.render(r,o)})),Ka(),oo()}function fo(){Jt||($("#pause").hide(),$("#play").show()),_t=!1}function po(){Jt||($("#play").hide(),$("#pause").show()),Wt=!0,window.clearTimeout(St),St=setTimeout(pa,1e3),_t=!0}function mo(){co(),W.t.value=0,Po(),Bt=!0,ua(),oo(),Wt=!0,window.clearTimeout(St),pa()}function ho(){let e="";return e+="float UFUN = "+_o(B.reactionStr_1)+";\n",e+="float VFUN = "+_o(B.reactionStr_2)+";\n",e+="float WFUN = "+_o(B.reactionStr_3)+";\n",e+="float QFUN = "+_o(B.reactionStr_4)+";\n",e}function go(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function _o(e){if(!tr(e=" "+e+" "))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])?\b/g);let i,o,a,r,l,s,u,c,d,f,p,m,h,g=0;const _={S:"One",T:"Two"},b={R:"r",G:"g",B:"b",A:"a"};for(const v of n){for(i=v.index,m=_[v[1]],o=i+v[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,l=t.slice(o+g+1,a+g),l=Va(l),s=l.split(","),1!=s.length&&0!=s[1].trim().length||(s[1]="0"),s[0]="("+s[0]+"-MINX)/L_x",s[1]="("+s[1]+"-MINY)/L_y",f="texture(imageSource"+m+",vec2("+s.join(",")+")).",null!=v[2]?(h=b[v[2]],p=f+h):(h=["r","g","b"],p="("+h.map((e=>f+e)).join("+")+")/3.0 "),t=Ho(t,p,i+g,a+1+g),g+=p.length-a+i-1)}return t}(e=(e=$a(e=(e=(e=(e=bo(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){if("0"==n)return"1";const i=Number(n);return Number.isInteger(i&&i>0&&i<101)?"(("+t+")"+("*("+t+")").repeat(i-1)+")":"safepow("+t+","+n+")"}))).replaceAll(RegExp("\\b("+Vi[0]+")\\b","g"),(function(e,t){return"uvwq."+Do(t)}))).replaceAll(RegExp("\\b("+Vi[0]+")_([xy][fb]?2?)\\b","g"),(function(e,t,n){return n.includes("2")&&(n=n.slice(0,-1).repeat(2)),"uvwq"+n.toUpperCase()+"."+Do(t)}))).replaceAll(RegExp("\\b("+Vi[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+Do(t)})))).replaceAll(/\b(I_[ST][RBGA]?\b)\s*(?!\()/g,"$1(x,y) "));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e=e.replaceAll(/\bind\b/g,"float")}function bo(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function vo(){let e="",t="",n="",i="",o="",a="";const r=[B.boundaryConditions_1,B.boundaryConditions_2,B.boundaryConditions_3,B.boundaryConditions_4],l=[B.neumannStr_1,B.neumannStr_2,B.neumannStr_3,B.neumannStr_4],s=[B.comboStr_1,B.comboStr_2,B.comboStr_3,B.comboStr_4].map((e=>e+";")),u=[B.dirichletStr_1,B.dirichletStr_2,B.dirichletStr_3,B.dirichletStr_4],c=[B.robinStr_1,B.robinStr_2,B.robinStr_3,B.robinStr_4];r.forEach((function(t,n){"neumann"==t?(e+=yo(l[n],Ui[n]),B.domainViaIndicatorFun?e+=cr(n):e+=ur(n)):"combo"==t&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=yo(t[2],Ui[n],i),e+=ur(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=To(Yn(t),Ui[e]),B.dimension>1&&(i+=To(Zn(t),Ui[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,_o(e[2]))}))})),r.forEach((function(e,t){if("dirichlet"==e)if(B.domainViaIndicatorFun){let e=Nn().replace(/indicatorFun/g,_o(B.domainIndicatorFun));n+=To(e,Ui[t])+_o(u[t])+";\n}\n"}else n+=So(u[t],Ui[t]),n+=sr(t);else if("combo"==e)[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=So(e[2],Ui[t],i),n+=sr(t,i)}));else if(B.domainViaIndicatorFun){let e=Nn().replace(/indicatorFun/g,_o(B.domainIndicatorFun));n+=To(e,Ui[t])+"0.0;\n}\n"}})),r.forEach((function(e,t){"robin"==e?(i+=yo(c[t],Ui[t]),B.domainViaIndicatorFun?i+=cr(t):i+=ur(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=yo(e[2],Ui[t],n),i+=ur(t,n)}))}));let d=Da();if(o=function(){let e="";return e+=go(_o(B.diffusionStr_1_1)+";\n","uu"),e+=go(_o(B.diffusionStr_2_2)+";\n","vv"),e+=go(_o(B.diffusionStr_3_3)+";\n","ww"),e+=go(_o(B.diffusionStr_4_4)+";\n","qq"),e}()+"\n",B.crossDiffusion?o+=function(){let e="";return e+=go(_o(B.diffusionStr_1_2)+";\n","uv"),e+=go(_o(B.diffusionStr_1_3)+";\n","uw"),e+=go(_o(B.diffusionStr_1_4)+";\n","uq"),e+=go(_o(B.diffusionStr_2_1)+";\n","vu"),e+=go(_o(B.diffusionStr_2_3)+";\n","vw"),e+=go(_o(B.diffusionStr_2_4)+";\n","vq"),e+=go(_o(B.diffusionStr_3_1)+";\n","wu"),e+=go(_o(B.diffusionStr_3_2)+";\n","wv"),e+=go(_o(B.diffusionStr_3_4)+";\n","wq"),e+=go(_o(B.diffusionStr_4_1)+";\n","qu"),e+=go(_o(B.diffusionStr_4_2)+";\n","qv"),e+=go(_o(B.diffusionStr_4_3)+";\n","qw"),e}()+"\n"+jn():o+=Wn(),B.numAlgebraicSpecies>=2){const e=B.numSpecies-B.numAlgebraicSpecies;let t={};for(let n=e;n<B.numSpecies;n++){let i=[],o=B["reactionStr_"+(n+1).toString()];for(let t=e;t<B.numSpecies;t++)o=[o,B["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()]].join(" ");for(let t=e;t<B.numSpecies;t++){(new RegExp("\\b"+Ui[t]+"(_(x|xb|xf|xb2|xf2|xx|y|yb|yf|yb2|yf2|yy))?\\b").test(o)||"0"!=B["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()])&&i.push(Ui[t])}i!=[]&&(t[Ui[n]]=i)}let n={},i=[],o=[];for(let a of Ui.slice(e,B.numSpecies))Wr(a,n,i,t,o);if(o.length>0)return void er("Cyclic variables detected. Please check the definition(s) of "+o.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.")}if(dn&&B.crossDiffusion&&(a+=To(Qn(),Ui[1])),fn&&B.crossDiffusion&&(a+=To(Qn(),Ui[2])),pn&&B.crossDiffusion&&(a+=To(Qn(),Ui[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void er("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let f=[Gn(),Xn(),e,t,i,Jn(),Hn(),ho(),o].join(" "),p=/\bRAND\b/.test(f),m=/\bRANDN\b/.test(f);p&&(f=ei()+f),m&&(f=ti()+f),Qt=p||m;let h=[n,a,Rn()].join(" "),g="FE";Mt[g].fragmentShader=Br([d,kn(g),f,Kn(g),h].join(" ")),g="AB2",Mt[g].fragmentShader=Br([d,kn(g),f,Kn(g),h].join(" ")),g="Mid";for(let e=1;e<3;e++)Mt[g+e.toString()].fragmentShader=Br([d,kn(g+e.toString()),f,Kn(g+e.toString()),h].join(" "));g="RK4";for(let e=1;e<5;e++)Mt[g+e.toString()].fragmentShader=Br([d,kn(g+e.toString()),f,Kn(g+e.toString()),h].join(" "));if(Object.keys(Mt).forEach((e=>Mt[e].needsUpdate=!0)),yt=B.domainViaIndicatorFun||"dirichlet"==B.boundaryConditions_1||"dirichlet"==B.boundaryConditions_2||"dirichlet"==B.boundaryConditions_3||"dirichlet"==B.boundaryConditions_4||/Dirichlet/.test(B.comboStr_1)||/Dirichlet/.test(B.comboStr_2)||/Dirichlet/.test(B.comboStr_3)||/Dirichlet/.test(B.comboStr_4),yt){if(n=d+zn(),B.domainViaIndicatorFun){let e=Nn().replace(/indicatorFun/,_o(B.domainIndicatorFun)).replace(/updated/,"gl_FragColor");u.forEach((function(t,i){"dirichlet"==r[i]?n+=To(e,Ui[i])+_o(t)+";\n}\n":n+=To(e,Ui[i])+"0.0;\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=So(u[t],Ui[t]),n+=dr(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=So(e[2],Ui[t],i),n+=dr(t,i)}))}));n+="}",n=Br(n),v.fragmentShader=n,v.needsUpdate=!0}}function yo(e,t,n){return null==n?["L","R","T","B"].map((n=>yo(e,t,n))).join(""):"float robinRHS"+t+n+" = "+_o(e)+";\n"}function So(e,t,n){return null==n?["L","R","T","B"].map((n=>So(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+_o(e)+";\n"}function wo(e){Co("default"),Co(e),null!=B.threeD&&(B.threeD&&(B.dimension=2,null==B.plotType&&(B.plotType="surface")),delete B.threeD),null!=B.oneDimensional&&(B.oneDimensional&&(B.dimension=1,B.plotType="line"),delete B.oneDimensional),Kt*=en,function(){if(0==B.views.length){let e=rr();e.name="1",B.views.push(e)}else B.views=B.views.map((function(e){let t=rr();return Object.assign(t,e),t}));Ct=B.views}(),Fo(z,!0),Fo(G,!0),Fo(J,!0),Ki(),B.activeViewInd>=B.views.length&&(B.activeViewInd=B.views.length-1),ir(B.views[B.activeViewInd],!1),jo(),Zi(),ji(),Gi(),a.background=new bi.Color(B.backgroundColour),""!=B.initialState?fetch(B.initialState).then((e=>e.blob())).then((e=>Ha(e))):mo(),zi(),lt.remove(),st.remove(),Mo(),ga()}function Co(e){let t;t=null==e?di(B.preset):"string"==typeof e?di(e):"object"==typeof e?e:di("default"),t.hasOwnProperty("parent")&&null!=t.parent&&Co(t.parent),rn=0,on=[],nn={},Object.assign(B,t),_t=B.runningOnLoad,Na(),_t?po():fo(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?B.tryClickingText=B.tryClickingText.replaceAll("clicking","tapping"):B.tryClickingText=B.tryClickingText.replaceAll("tapping","clicking"),B.brushRadius=B.brushRadius.toString(),B.hasOwnProperty("drawIn3D")&&(B.brushEnabled=B.drawIn3D);var n=0;n+=B.hasOwnProperty("algebraicV"),n+=B.hasOwnProperty("algebraicW"),(n+=B.hasOwnProperty("algebraicQ"))&&!B.numAlgebraicSpecies&&(B.numAlgebraicSpecies=n),delete B.algebraicV,delete B.algebraicW,delete B.algebraicQ;const i=hi();Object.keys(i).forEach((function(e){B.hasOwnProperty(e)&&(t.hasOwnProperty(i[e])||(B[i[e]]=B[e]),delete B[e])})),null==B.minColourValue&&(B.minColourValue=0),null==B.maxColourValue&&(B.maxColourValue=1),B.domainScale=B.domainScale.toString(),B.spatialStep=B.spatialStep.toString(),Q=JSON.parse(JSON.stringify(B));let o=[B.initCond_1,B.initCond_2,B.initCond_3,B.initCond_4,B.domainIndicatorFun,B.reactionStr_1,B.reactionStr_2,B.reactionStr_3,B.reactionStr_4,B.diffusionStr_1_1,B.diffusionStr_1_2,B.diffusionStr_1_3,B.diffusionStr_1_4,B.diffusionStr_2_1,B.diffusionStr_2_2,B.diffusionStr_2_3,B.diffusionStr_2_4,B.diffusionStr_3_1,B.diffusionStr_3_2,B.diffusionStr_3_3,B.diffusionStr_3_4,B.diffusionStr_4_1,B.diffusionStr_4_2,B.diffusionStr_4_3,B.diffusionStr_4_4,B.dirichletStr_1,B.dirichletStr_2,B.dirichletStr_3,B.dirichletStr_4,B.robinStr_1,B.robinStr_2,B.robinStr_3,B.robinStr_4,B.comboStr_1,B.comboStr_2,B.comboStr_3,B.comboStr_4,B.neumannStr_1,B.neumannStr_2,B.neumannStr_3,B.neumannStr_4,B.brushValue,B.whatToPlot].join(" ");B.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(o)}function xo(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)xo(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Fo(e,t){if(null!=e){for(let t in e.__folders)Fo(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function $o(e){null!=e&&(e.__li.style.display="none")}function Eo(e){null!=e&&(e.__li.style.display="")}function Ao(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function To(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=Do(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function Do(e){return"rgba"[function(e){return Ui.indexOf(e)}(e)]}function Uo(){"dirichlet"==B.boundaryConditions_1?Eo(We):$o(We),"dirichlet"==B.boundaryConditions_2?Eo(je):$o(je),"dirichlet"==B.boundaryConditions_3?Eo(Qe):$o(Qe),"dirichlet"==B.boundaryConditions_4?Eo(ze):$o(ze),"neumann"==B.boundaryConditions_1?Eo(Ye):$o(Ye),"neumann"==B.boundaryConditions_2?Eo(Ze):$o(Ze),"neumann"==B.boundaryConditions_3?Eo(Ke):$o(Ke),"neumann"==B.boundaryConditions_4?Eo(et):$o(et),"robin"==B.boundaryConditions_1?Eo(nt):$o(nt),"robin"==B.boundaryConditions_2?Eo(it):$o(it),"robin"==B.boundaryConditions_3?Eo(ot):$o(ot),"robin"==B.boundaryConditions_4?Eo(at):$o(at),"combo"==B.boundaryConditions_1?Eo(Ge):$o(Ge),"combo"==B.boundaryConditions_2?Eo(Je):$o(Je),"combo"==B.boundaryConditions_3?Eo(Xe):$o(Xe),"combo"==B.boundaryConditions_4?Eo(He):$o(He);const e=[Le,Oe,qe,Be];B.domainViaIndicatorFun?e.forEach((e=>Ia(e,["Dirichlet","Neumann","Robin"],["dirichlet","neumann","robin"]))):e.forEach((e=>Ia(e,["Periodic","Dirichlet","Neumann","Robin","Combination"],["periodic","dirichlet","neumann","robin","combo"]))),xo(z)}function Po(){const e=B.fixRandSeed?B.randSeed:performance.now();W.seed.value=e%1e6/1e6}function Vo(){let e=Da()+_i(),t=[B.initCond_1,B.initCond_2,B.initCond_3,B.initCond_4].join(" ");/\bRAND\b/.test(t)&&(e+=ei()),/\bRANDN\b/.test(t)&&(e+=ti()),e+="float u = "+_o(B.initCond_1)+";\n",e+="float v = "+_o(B.initCond_2)+";\n",e+="float w = "+_o(B.initCond_3)+";\n",e+="float q = "+_o(B.initCond_4)+";\n",e+=gi(),e=Br(e),y.fragmentShader=e,y.needsUpdate=!0}function ko(){let e=new Image;e.src=lt.__image.src;let t=new bi.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,W.imageSourceOne.value=t,B.resetOnImageLoad&&mo()}}function Ro(){let e=new Image;e.src=st.__image.src;let t=new bi.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,W.imageSourceTwo.value=t,B.resetOnImageLoad&&mo()},t.dispose()}function Mo(){X=rt,lt=X.addImage(B,"imagePathOne").name("$I_S(x,y)$").onChange(ko),st=X.addImage(B,"imagePathTwo").name("$I_T(x,y)$").onChange(Ro),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Io(){bn=!1,Oo(),Eo(Ue),Eo(Pe),Eo(Ve),Eo(ke),oa(),ca()}function No(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function Lo(){ma();let e=1/0,t=-1/0;for(let n=0;n<mn.length;n+=4)e=Math.min(e,mn[n]),t=Math.max(t,mn[n]);return[e,t]}function Oo(){let e=Da()+An();e+=Tn().replace(/\bXVECFUN\b/,_o(B.arrowX)).replace(/\bYVECFUN\b/,_o(B.arrowY)),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,_o(B.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,_o(B.surfaceFun))}(e),B.domainViaIndicatorFun&&(e+=Un().replace(/indicatorFun/g,_o(B.domainIndicatorFun))),e=e.replaceAll("OVERLAYEXPR",_o(B.overlayExpr)),e=Br(e),Dr(),w.fragmentShader=e+Dn(),w.needsUpdate=!0}function qo(){B.numAlgebraicSpecies=Math.min(parseInt(B.numAlgebraicSpecies),parseInt(B.numSpecies)-1),dn=B.numAlgebraicSpecies>=B.numSpecies-1,fn=B.numAlgebraicSpecies>=B.numSpecies-2&&B.numSpecies>=3,pn=B.numAlgebraicSpecies>=B.numSpecies-3&&B.numSpecies>=4}function Bo(){let e="function of "+Ui.slice(0,B.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+Ui[1]+",",""),i=e.replace(" "+Ui[2]+",",""),o=e.replace(" "+Ui[3]+",","");switch(1==B.dimension?(e=e.replace(" y,",""),$o(ne)):Eo(ne),B.crossDiffusion&&parseInt(B.numSpecies)>1?(Yt||Ia(te,Array.from(Array(parseInt(B.numSpecies)).keys())),Eo(te)):$o(te),B.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),$o(ae),$o(se),$o(ue),$o(Z),$o(Me),$o(Oe),$o(re),$o(ce),$o(fe),$o(pe),$o(me),$o(K),$o(Ie),$o(qe),$o(le),$o(de),$o(he),$o(ge),$o(_e),$o(be),$o(ve),$o(ee),$o(Ne),$o(Be),parseInt(B.numSpecies)){case 4:B.crossDiffusion?(Eo(le),Eo(de),Eo(he),Eo(ge),Eo(_e),Eo(be)):($o(he),$o(ge),$o(de),$o(le),$o(_e),$o(be)),Eo(ve),Eo(ee),Eo(Ne),Eo(Be);case 3:B.crossDiffusion?(Eo(re),Eo(ce),Eo(fe),Eo(pe)):($o(re),$o(ce),$o(fe),$o(pe)),Eo(me),Eo(K),Eo(Ie),Eo(qe);case 2:B.crossDiffusion?(Eo(ae),Eo(se)):($o(ae),$o(se)),Eo(ue),Eo(Z),Eo(Me),Eo(Oe)}B.crossDiffusion?(Ao(oe,Ri.Duu,e),Ao(ae,Ri.Duv,e),Ao(re,Ri.Duw,e),Ao(le,Ri.Duq,e),Ao(se,Ri.Dvu,e),Ao(ue,Ri.Dvv,e),Ao(ce,Ri.Dvw,e),Ao(de,Ri.Dvq,e),Ao(fe,Ri.Dwu,e),Ao(pe,Ri.Dwv,e),Ao(me,Ri.Dww,e),Ao(he,Ri.Dwq,e),Ao(ge,Ri.Dqu,e),Ao(_e,Ri.Dqv,e),Ao(be,Ri.Dqw,e),Ao(ve,Ri.Dqq,e)):(Ao(oe,Ri.Du,e),Ao(ue,Ri.Dv,e),Ao(me,Ri.Dw,e),Ao(ve,Ri.Dq,e)),Ao(Y,Ri.UFUN,e),Ao(Z,Ri.VFUN,e),Ao(K,Ri.WFUN,e),Ao(ee,Ri.QFUN,e),dn&&(Ao(se,Ri.Dvu,t),Ao(ce,Ri.Dvw,t),Ao(de,Ri.Dvq,t),Ao(Z,Ri.VFUN,t),$o(ue)),fn&&(Ao(fe,Ri.Dwu,o),Ao(pe,Ri.Dwv,o),Ao(he,Ri.Dwq,o),Ao(K,Ri.WFUN,o),$o(me)),pn&&(Ao(ge,Ri.Dqu,i),Ao(_e,Ri.Dqv,i),Ao(be,Ri.Dqw,i),Ao(ee,Ri.QFUN,i),$o(ve)),Ao(Le,Ri.u),Ao(Oe,Ri.v),Ao(qe,Ri.w),Ao(Be,Ri.q),Ao(We,Ri.uD),Ao(je,Ri.vD),Ao(Qe,Ri.wD),Ao(ze,Ri.qD),Ao(Ye,Ri.uN),Ao(Ze,Ri.vN),Ao(Ke,Ri.wN),Ao(et,Ri.qN),Ao(nt,Ri.uN),Ao(it,Ri.vN),Ao(ot,Ri.wN),Ao(at,Ri.qN),Ao(Re,Ri.uInit),Ao(Me,Ri.vInit),Ao(Ie,Ri.wInit),Ao(Ne,Ri.qInit),B.domainViaIndicatorFun?Eo(ie):$o(ie),Uo(),"surface"==B.plotType?($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").hide(),mt.name="3D options",mt.domElement.classList.remove("hidden"),$o(xe),Eo(Fe),Eo(Ae),Eo(Te),Eo(De)):"line"==B.plotType?($("#contourButton").hide(),$("#embossButton").hide(),$("#vectorFieldButton").hide(),mt.name="Line options",mt.domElement.classList.remove("hidden"),Eo(xe),Eo(Fe),$o(Ae),$o(Te),$o(De)):($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").show(),mt.domElement.classList.add("hidden"),$o(xe),$o(Fe),$o(Ae),$o(Te),$o(De)),1==B.dimension&&$("#vectorFieldButton").hide(),oa(),sa(),ca(),$("#dataContainer").show(),Rr(),"line"==B.plotType?($o(H),$(":root").css("--ui-button-outline","black")):(Eo(H),$(":root").css("--ui-button-outline","white")),n?$("#interpController").hide():$("#interpController").show(),"relative"==B.arrowScale?Eo(ct):$o(ct),Ia(Ce,Ui.slice(0,B.numSpecies)),Ar(),B.autoPause?Eo(Se):$o(Se),"line"==B.plotType?($o(dt),Eo(ft)):(Eo(dt),$o(ft)),B.fixRandSeed?Eo(we):$o(we),$(".toggle_button").each((function(){Pr(this)})),nr(),xo(z),xo(G),xo(J)}function Wo(){let e;switch(qo(),B.domainViaIndicatorFun&&(["dirichlet","neumann"].includes(B.boundaryConditions_1)||(B.boundaryConditions_1="dirichlet"),["dirichlet","neumann"].includes(B.boundaryConditions_2)||(B.boundaryConditions_2="dirichlet"),["dirichlet","neumann"].includes(B.boundaryConditions_3)||(B.boundaryConditions_3="dirichlet"),["dirichlet","neumann"].includes(B.boundaryConditions_4)||(B.boundaryConditions_4="dirichlet")),parseInt(B.numSpecies)){case 1:B.crossDiffusion=!1,B.whatToDraw=Ui[0],B.whatToPlot=Ui[0],B.diffusionStr_1_2="0",B.diffusionStr_1_3="0",B.diffusionStr_1_4="0",B.diffusionStr_2_1="0",B.diffusionStr_2_2="0",B.diffusionStr_2_3="0",B.diffusionStr_2_4="0",B.diffusionStr_3_1="0",B.diffusionStr_3_2="0",B.diffusionStr_3_3="0",B.diffusionStr_3_4="0",B.diffusionStr_4_1="0",B.diffusionStr_4_2="0",B.diffusionStr_4_3="0",B.diffusionStr_4_4="0",B.boundaryConditions_2="periodic",B.initCond_2="0",B.reactionStr_2="0",B.boundaryConditions_3="periodic",B.initCond_3="0",B.reactionStr_3="0",B.boundaryConditions_4="periodic",B.initCond_4="0",B.reactionStr_4="0",e=new RegExp("\\b("+Vi[1]+")\\b"),e.test(B.reactionStr_1)&&(B.reactionStr_1="0");break;case 2:B.whatToDraw==Ui[2]|B.whatToDraw==Ui[3]&&(B.whatToDraw=Ui[0]),B.whatToPlot==Ui[2]|B.whatToPlot==Ui[3]&&(B.whatToPlot=Ui[0]),B.diffusionStr_1_3="0",B.diffusionStr_1_4="0",B.diffusionStr_2_3="0",B.diffusionStr_2_4="0",B.diffusionStr_3_1="0",B.diffusionStr_3_2="0",B.diffusionStr_3_3="0",B.diffusionStr_3_4="0",B.diffusionStr_4_1="0",B.diffusionStr_4_2="0",B.diffusionStr_4_3="0",B.diffusionStr_4_4="0",B.boundaryConditions_3="periodic",B.initCond_3="0",B.reactionStr_3="0",B.boundaryConditions_4="periodic",B.initCond_4="0",B.reactionStr_4="0",e=new RegExp("\\b("+Vi[2]+")\\b"),e.test(B.reactionStr_1)&&(B.reactionStr_1="0"),e.test(B.reactionStr_2)&&(B.reactionStr_2="0");break;case 3:B.whatToDraw==Ui[3]&&(B.whatToDraw=Ui[0]),B.whatToPlot==Ui[3]&&(B.whatToPlot=Ui[0]),B.diffusionStr_1_4="0",B.diffusionStr_2_4="0",B.diffusionStr_3_4="0",B.diffusionStr_4_1="0",B.diffusionStr_4_2="0",B.diffusionStr_4_3="0",B.diffusionStr_4_4="0",B.boundaryConditions_4="periodic",B.initCond_4="0",B.reactionStr_4="0",e=new RegExp("\\b("+Vi[3]+")\\b"),e.test(B.reactionStr_1)&&(B.reactionStr_1="0"),e.test(B.reactionStr_2)&&(B.reactionStr_2="0"),e.test(B.reactionStr_3)&&(B.reactionStr_3="0")}switch(cn){case 3:B.diffusionStr_2_2="0";break;case 6:B.diffusionStr_3_3="0";break;case 7:B.diffusionStr_2_2="0",B.diffusionStr_3_3="0";break;case 10:B.diffusionStr_4_4="0";break;case 11:B.diffusionStr_3_3="0",B.diffusionStr_4_4="0";break;case 12:B.diffusionStr_2_2="0",B.diffusionStr_3_3="0",B.diffusionStr_4_4="0"}xo(z),xo(G)}function jo(){!function(){switch(qo(),parseInt(B.numSpecies)){case 1:cn=0;break;case 2:cn=B.crossDiffusion?1==B.numAlgebraicSpecies?3:2:1;break;case 3:if(B.crossDiffusion)switch(B.numAlgebraicSpecies){case 0:cn=5;break;case 1:cn=6;break;case 2:cn=7}else cn=4;break;case 4:if(B.crossDiffusion)switch(B.numAlgebraicSpecies){case 0:cn=9;break;case 1:cn=10;break;case 2:cn=11;break;case 3:cn=12}else cn=8}}(),Sa(),wa(),Wo(),Bo(),Aa(),Pa(),Qo()}function Qo(){let e,t=ki[cn];const n={U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(B.typesetCustomEqs){let o={};o.U=B.diffusionStr_1_1,o.UU=B.diffusionStr_1_1,o.V=B.diffusionStr_2_2,o.VV=B.diffusionStr_2_2,o.W=B.diffusionStr_3_3,o.WW=B.diffusionStr_3_3,o.Q=B.diffusionStr_4_4,o.QQ=B.diffusionStr_4_4,o.UV=B.diffusionStr_1_2,o.UW=B.diffusionStr_1_3,o.UQ=B.diffusionStr_1_4,o.VU=B.diffusionStr_2_1,o.VW=B.diffusionStr_2_3,o.VQ=B.diffusionStr_2_4,o.WU=B.diffusionStr_3_1,o.WV=B.diffusionStr_3_2,o.WQ=B.diffusionStr_3_4,o.QU=B.diffusionStr_4_1,o.QV=B.diffusionStr_4_2,o.QW=B.diffusionStr_4_3,o.UFUN=B.reactionStr_1,o.VFUN=B.reactionStr_2,o.WFUN=B.reactionStr_3,o.QFUN=B.reactionStr_4;var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!tr(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=La(o[e],Ui,ln,"_(?:[xy][xybf]?)")})),Lt.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){sn.includes(e)||(t=function(e,t,n,i){null==i&&(i="  ");let o=n.replace(/\s+/g,"  ").trim();return["0","0.0","-0","-0.0","+0","+0.0"].includes(o)?e.replaceAll(t,""):"1"==o||"1.0"==o?e.replaceAll(t,"$2"):"-1"==o||"-1.0"==o?e.replaceAll(t,i[0]+"-"+i[1]+"$2"):e.replaceAll(t,i[0]+n+i[1]+"$2")}(t,n[e],o[e],"[]"))})),t=ya(t,n.UFUN,o.UFUN),t=ya(t,n.VFUN,o.VFUN),t=ya(t,n.WFUN,o.WFUN),t=ya(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}\(\)]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\(\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"\\lap $1"),e=/\\vnabla\s*\\cdot\s*\(\s*((?!\\vnabla).*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b(?:[xy]|[uvwq](?:_[xy])?|(?:I_[ST][RGBA]?))\b/g.test(t)?e:t.trim()+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])[fb]?2?\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else Lt.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{ "+t+" ";return"string"==typeof n&&(i+=n),i+" }"}))})),t=La(t,["UFUN","VFUN","WFUN","QFUN"],sn);1==B.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=La(t,ln.concat(sn),Ui.concat(Pi),"_(?:[xy][xybf]?)"),t=zo(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(ka)}function zo(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Go(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Go(e,"cos",!0),e=Go(e,"tan",!0),e=Go(e,"exp",!0),e=Go(e,"log",!0),e=Go(e,"sqrt",!1),e=Go(e,"sinh",!0),e=Go(e,"cosh",!0),e=Go(e,"tanh",!0),e=Go(e,"max",!0),e=Go(e,"min",!0),e=bo(e=(e=Go(e,"ind",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",l="";for(var s=0;s<e.length;s++)t.includes(e[s])?(i+=1,o+=1):n.includes(e[s])&&(i-=1),0==i&&o>0&&(r=e.slice(a,s+1),l+=Jo(r,o),o=0,a=s+1);return l+=e.slice(a),l}(e=Di(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")).replaceAll(/<=/g," \\leq ")).replaceAll(/>=/g," \\geq ")).replaceAll(/([<>])/g," $1 ")}function Go(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,l,s,u,c,d,f=0;for(const p of o){for(a=p.index,r=a+t.length,s=e.slice(r),d=0,u=0,c=!1;d<=s.length&(!c|!(c&&0==u));)u+=["(","["].includes(s[d]),u-=[")","]"].includes(s[d]),c|=u,d+=1;c&&0==u&&(l=d-1+r,i=Yo(i,"\\",a+f),f+=1,n?(i=Yo(i,"{",r+f),f+=1,i=Yo(i,"}",l+1+f),f+=1):(i=Ho(i,"{",r+f),i=Ho(i,"}",l+f)))}return i}function Jo(e,t){const n=["(","["],i=[")","]"];let o=Xo(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=Ho(e,n[o],a),o+=1,o=Xo(o,n.length)):i.includes(e[a])&&(o-=1,o=Xo(o,n.length),e=Ho(e,i[o],a));return e}function Xo(e,t){return(e%t+t)%t}function Ho(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function Yo(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Zo(e){return e=e.replace(/\s+/g,"  ").trim()}function Ko(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=nn[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);nn[e]=nn[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),xo(kt),ea(),oo(),(Aa()||Gt)&&(Gt=!1,Pa())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)on.push(e),nn[e]="",n=kt.add(nn,e).name(""),Vr(n.domElement),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=on.indexOf(e);let n=Zo(nn[on.at(t)]);if(""==n);else{let e=Ko(on.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);if(i){let t=i[1];qr(t),e.lastName=t,an[t]=e}rn+=1;let o="params"+rn;this.remove(),Ko(o,!0),ea(),(Aa()||Gt)&&(Gt=!1,Pa())}}));else{n=kt.add(nn,e).name(""),Vr(n.domElement),n.domElement.classList.add("params");const t=nn[e].match(/\s*(\w+)\s*=/);if(t){let e=t[1];qr(e),n.lastName=e,an[e]=n}n.onFinishChange((function(){let t=Zo(nn[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=on.indexOf(e);on.splice(t,1),delete nn[e],n.hasOwnProperty("lastName")&&!va(n.lastName)&&delete W[n.lastName]}else{i();const e=Va(t).match(/\s*(\w+)\s*=/);if(e){let t=e[1];qr(t),n.hasOwnProperty("lastName")&&n.lastName!=t&&!va(n.lastName)&&(delete W[n.lastName],n.lastName=t,an[t]=n)}}ea(),Aa()&&Pa()})),ea(),Aa()&&Pa()}return i(),n}function ea(){B.kineticParams=Object.values(nn).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function ta(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function na(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function ia(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function oa(){if(B.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+qa(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==B.whatToPlot?($("#minLabel").html("$"+Ui[0]+"$"),$("#midLabel").html("$"+Ui[1]+"$"),$("#maxLabel").html("$"+Ui[2]+"$")):jt?$("#midLabel").html(B.views[B.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+zo(B.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),xa(),aa()}else $("#colourbar").hide()}function aa(){if("MAX"!=B.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[la(e,n),la(t,n)]}(B.minColourValue,B.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=Ra(qa(0)),t=Ra(qa(.5)),n=Ra(qa(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function ra(e,t){return e.toPrecision(t)}function la(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function sa(){B.timeDisplay?($("#timeDisplay").show(),ua()):$("#timeDisplay").hide(),fa()}function ua(){if(B.timeDisplay){let e=ra(W.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/,"  10<sup>$2$3<sup>"),$("#timeValue").html(e),ha()}}function ca(){if(B.integrate){$("#integralDisplay").show();let e="";1==B.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+zo(B.whatToPlot)+"\\,\\d x",1==B.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();fa()}function da(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function fa(){B.integrate&&B.timeDisplay?da("#timeDisplay",10):da("#timeDisplay",0)}function pa(){let e=Lo();!Wt||isFinite(e[0])&&isFinite(e[1])?St=setTimeout(pa,1e3):(Wt=!1,na("#oops_hit_nan"),fo(),$("#erase").one("pointerdown",(function(){ia("#oops_hit_nan"),Wt=!0,window.clearTimeout(St),St=setTimeout(pa,1e3)})))}function ma(){if(!bn){try{l.readRenderTargetPixels(f,0,0,$t,Et,mn)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}bn=!0}}function ha(){if(B.colourbar&&(B.integrate||B.timeDisplay)){let e,t=$("#colourbar")[0].getBoundingClientRect();e=B.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(da("#dataContainer",40),zt=!0):zt&&(da("#dataContainer",0),zt=!1)}}function ga(){_a()?(Rt.forEach((e=>{e.texture.magFilter=bi.NearestFilter})),f.texture.magFilter=bi.NearestFilter,p.texture.magFilter=bi.NearestFilter):(Rt.forEach((e=>{e.texture.magFilter=bi.LinearFilter})),f.texture.magFilter=bi.LinearFilter,p.texture.magFilter=bi.LinearFilter),Bo()}function _a(){return n||B.forceManualInterpolation}function ba(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function va(e,t){return null==t&&(t=[]),function(e){return[...(kn()+jn()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e).concat(["I_T","I_TR","I_TG","I_TB","I_TA","I_S","I_SR","I_SG","I_SB","I_SA"])}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function ya(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function Sa(){"line"==B.plotType?(Wa(),B.brushType="vline",to(),xo(G),U.visible=!1,k.visible=!0,B.contours=!1,B.emboss=!1,B.vectorField=!1,Lr()):(U.visible=!0,k.visible=!1,"surface"==B.plotType?($("#simCanvas").css("outline","2px #000 solid"),Zt&&(Zt=!1,Qi()),B.vectorField=!1,Lr()):$("#simCanvas").css("outline","")),R.visible=B.overlay&&"line"==B.plotType,no(),zi(),Bo(),jr()}function wa(){Ot||(1!=B.dimension&&"line"==B.plotType&&(B.plotType="plane",lr("plotType"),Sa()),1==B.dimension&&"line"!=B.plotType&&(B.plotType="line",B.vectorField=!1,lr("plotType"),Sa())),1==B.dimension&&(B.minY="0.0"),ji(),vo(),Qo(),Bo(),ca()}function Ca(){const e="line"==B.plotType?0:B.cameraTheta,t="line"==B.plotType?0:B.cameraPhi,n=(new bi.Vector3).setFromSphericalCoords(1,Math.PI/2-e*Math.PI/180,-t*Math.PI/180);i.position.set(n.x,n.y,n.z),i.lookAt(0,0,0)}function xa(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function Fa(){return B.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function $a(e){return Va(e)}function Ea(){const e=/^\s*([a-zA-Z]\w*)\b/;let t=[];return Fa().split(";").filter((e=>e.length>0)).forEach((function(n){n.match(e)&&t.push(n.match(e)[1].trim())})),t}function Aa(){Fa().split(";").filter((e=>e.length>0));const e=function(e){let t={},n={},i=[];const o=function(){const e=/^\s*([a-zA-Z]\w*)\b\s*=\s*(.*)/;let t=[];return Fa().split(";").filter((e=>e.length>0)).forEach((function(n){const i=n.match(e);i?t.push([i[1].trim(),i[2].trim()]):er("Unable to evaluate the parameter definition '"+n+"'. Please check for syntax errors.")})),t}(),a=o.map((e=>e[0]));o.forEach((e=>t[e[0]]=e[1]));for(const e of o){let[o,r]=e;o in n||([n,,i]=Ua(o,t,n,[o],a,[]))}i.length>0&&er("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.");return Object.keys(n).map((e=>[e,n[e]]))}(),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}(Ea());if(t.length>0)return er("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=Ta(t[0],t[1]);n|=e,i|=o}return n&&!i}function Ta(e,t){let n=!1,i=!1;const o=$a(e);return va(o)?(er("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!W.hasOwnProperty(o),W[o]={type:"float",value:t}),[n,i]}function Da(){return $a(Ea().map((e=>"uniform float "+e+";")).join("\n"))}function Ua(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const l of o)r=new RegExp("\\b"+l+"\\b","g"),r.test(t[e])&&(i.includes(l)?(n[l]=0,t[l]="0",t[e]="0",a.push(i.slice(i.indexOf(l)))):([n,,a]=Ua(l,t,n,[...i,l],o,a),t[e]=t[e].replaceAll(r,n[l].toString())));try{n[e]=Ii.evaluate(t[e])}catch(t){er("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function Pa(){vo(),Vo(),to(),Io(),eo(),Oo()}function Va(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+vn[e])););return n}function ka(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function Ra(e){return e.reduce(((e,t)=>e+t),0)/3}function Ma(){let e=Lo();B.minColourValue=e[0],B.maxColourValue=e[1],W.maxColourValue.value=B.maxColourValue,W.minColourValue.value=B.minColourValue,Pe.updateDisplay(),Ue.updateDisplay(),aa()}function Ia(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function Na(){let e;null!=Ui&&(e=Ui);const t=B.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,ln.length),n=t.concat(un.slice(t.length)),i=Ea();let o;for(var a=0;a<n.length;a++)if(va(n[a],i))return o=i.includes(n[a])?"as a parameter":"under the hood",void er("The name '"+n[a]+"' is used "+o+", so can't be used as a species name. Please use a different name for "+n[a]+".");Ui=n,Pi=Ui.map((e=>"f_{"+e+"}")),function(){Vi=[];for(let e=0;e<Ui.length;e++)Vi.push("(?:"+Ui.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let r={...Ei(),...Ti()};if(Object.keys(r).forEach((function(e){Ri[e]=zo(La(r[e],ln,Ui,"_(?:[xy][xybf]?)"))})),r=Ai(),Object.keys(r).forEach((function(e){Ri[e]=zo(La(r[e],sn,Pi))})),Ot)return;const l=["initCond_1","initCond_2","initCond_3","initCond_4","kineticParams"];Object.keys(B).forEach((function(t){Ni.includes(t)&&(l.includes(t)||(B[t]=La(B[t],e,Ui,"_(?:[xy][xybf]?)")))})),B.views=B.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){Ni.includes(i)&&(n[i]=La(t[i],e,Ui,"_(?:[xy][xybf]?)"))})),n})),Object.keys(Q).forEach((function(t){Ni.includes(t)&&(l.includes(t)||(Q[t]=La(Q[t],e,Ui,"_(?:[xy][xybf]?)")))})),Q.views=Q.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){Ni.includes(i)&&(n[i]=La(t[i],e,Ui,"_(?:[xy][xybf]?)"))})),n})),Wo(),Bo(),Pa(),Qo()}function La(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function Oa(e,t){let n,i=e.geometry.attributes.instanceStart,o=e.geometry.attributes.instanceEnd;for(let e=0;e<t.length;e++)n=t[e].toArray(),n[1]*=B.threeDHeightScale*Tt/Dt,e<t.length&&i.setXYZ(e,n[0],n[1],0),e>0&&o.setXYZ(e-1,n[0],n[1],0);i.needsUpdate=!0,o.needsUpdate=!0}function qa(e){e=e.clamp(0,1);let t=0;for(;e>=q[t+1]&&t<O.length-2;)t+=1;return q[t+1]==q[t]?O[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=Ba(e[o],t[o],n);return i}(O[t],O[t+1],(e-q[t])/(q[t+1]-q[t])).map((e=>e.clamp(0,1)))}function Ba(e,t,n){return(1-(n=n.clamp(0,1)))*e+n*t}function Wa(){C.linewidth=.01*B.lineWidthMul,x.linewidth=.01*B.overlayLineWidthMul,C.needsUpdate=!0,x.needsUpdate=!0}function ja(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function Qa(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function za(e){e.forEach((function(e){Lt.add(e)})),Qo()}function Ga(e){e.forEach((function(e){Lt.delete(e)})),Qo()}function Ja(){hn=new Float32Array($t*Et*4),l.readRenderTargetPixels(Rt[1],0,0,$t,Et,hn),Za(hn),Xt=!0}function Xa(){Xt||Ja();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([$t,Et]),hn])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function Ha(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);Za(e.slice(2),e.slice(0,2)),Ya(h),Xt=!0,mo()},t.readAsArrayBuffer(e)}function Ya(e){if(null!=e)if("crop"==B.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=s/t;i>1&&(n=t/s,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function Za(e,t){null!=h&&h.dispose(),null==t&&(t=[$t,Et]),h=new bi.DataTexture(e,t[0],t[1],bi.RGBAFormat,bi.FloatType),h.needsUpdate=!0,h.magFilter=n?bi.NearestFilter:bi.LinearFilter,null!=A&&(A.map=h,A.needsUpdate)}function Ka(){l.setSize(Math.round(devicePixelRatio*Pt),Math.round(devicePixelRatio*Vt),!1)}function er(e){fo(),Ot&&qt||(qt=!0,$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),na("#error")))}function tr(e){if(/\(\s*\)/.test(e))return er("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(er("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(er("A binary operator is missing an operand in "+e.trim()+"."),!1)}function nr(){let e;$("#views_list").empty();for(let t=0;t<B.views.length;t++)e=document.createElement("a"),e.onclick=function(){B.activeViewInd=t,ir(B.views[t])},e.innerHTML="<div class='view_label'>"+B.views[t].name+"</div>",t==B.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);Ht=Math.max(B.views.length,Ht),B.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),B.views.length}function ir(e,t){Object.assign(B,e),delete B.name,xo(J),(null==t||t)&&(Io(),Sa(),no(),Gi(),aa(),oa(),Lr(),Ar(),oo())}function or(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",B.views[B.activeViewInd].name);null!=e&&(B.views[B.activeViewInd].name=e,nr(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function ar(){B.views.length>1?(B.views.splice(B.activeViewInd,1),B.activeViewInd<1?B.activeViewInd=0:B.activeViewInd-=1):B.views[B.activeViewInd].name="Custom",ir(B.views[B.activeViewInd])}function rr(){let e={};return Mi.forEach((function(t){e[t]=Q[t]})),e}function lr(e){B.activeViewInd<B.views.length&&(B.views[B.activeViewInd][e]=B[e])}function sr(e,t){let n="";return n+=To(Mn(t),Ui[e]),B.dimension>1&&(n+=To(In(t),Ui[e])),n}function ur(e,t){let n="";return n+=To(Ln(t),Ui[e]),B.dimension>1&&(n+=To(On(t),Ui[e])),n}function cr(e,t){let n="";return n+=To(qn(t,_o(B.domainIndicatorFun)),Ui[e]),B.dimension>1&&(n+=To(Bn(t,_o(B.domainIndicatorFun)),Ui[e])),n}function dr(e,t){let n="";return n+=To(Mn(t).replaceAll(/updated/g,"gl_FragColor"),Ui[e]),B.dimension>1&&(n+=To(In(t).replaceAll(/updated/g,"gl_FragColor"),Ui[e])),n}function fr(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function pr(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function mr(e,t,n,i,o,a,r,l){const s=document.createElement("a");if(s.classList.add("toggle_button"),s.setAttribute("property",t),null==i&&(i=()=>{}),s.onclick=function(){B[s.getAttribute("property")]=!B[s.getAttribute("property")],Pr(s),i()},null!=o&&(s.id=o),null!=a&&(s.title=a),null!=n&&(s.innerHTML=n),null!=r&&s.setAttribute("folderID",r),null!=l)for(const e of l)s.classList.add(e);return e.appendChild(s),Pr(s),s}function hr(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function gr(){const e=Object.assign(di("default"),di(B.parent));let t=No(B,e);1==B.views.length&&"1"==B.views[0].name&&delete t.views;for(const e of Object.keys(B.views[0]))B.hasOwnProperty(e)&&B.views.map((t=>t[e])).every((t=>t==B[e]))&&B.views.forEach((t=>delete t[e]));t.preset="PRESETNAME";let n=JSON.stringify(t).replaceAll(/(:[^:]*),/g,"$1,\n\t").replaceAll(":",": ").replaceAll("  "," ").replaceAll("{","{\n\t").replaceAll("}",",\n}");n='listOfPresets["PRESETNAME"] = '+n+";\n",navigator.clipboard.writeText(n)}function _r(){let t="";t+=JSON.stringify(B),t+=JSON.stringify(W),t+=JSON.stringify({nXDisc:$t,nYDisc:Et,domainHeight:Tt,domainWidth:At,aspectRatio:s,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(t)}function br(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function vr(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function yr(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function Sr(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function wr(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function Cr(){let e=No(B,di("default"));return e.preset="Custom",e=Ci(e),[location.href.replace(location.search,""),"?options=",Fi.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function xr(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function Fr(e){const t=an[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function $r(){W.embossAmbient.value=B.embossAmbient,W.embossDiffuse.value=B.embossDiffuse,W.embossShiny.value=B.embossShiny,W.embossSmoothness.value=B.embossSmoothness,W.embossSpecular.value=B.embossSpecular,W.embossLightDir.value=new bi.Vector3(Math.sin(B.embossTheta)*Math.cos(B.embossPhi),Math.sin(B.embossTheta)*Math.sin(B.embossPhi),Math.cos(B.embossTheta))}function Er(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function Ar(){for(const e of[...Nt,...It]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function Tr(){W.contourColour.value=new bi.Color(B.contourColour),W.contourEpsilon.value=B.contourEpsilon,W.contourStep.value=1/(B.contourNum+1)}function Dr(){W.overlayColour.value=new bi.Color(B.overlayColour),W.overlayEpsilon.value=B.overlayEpsilon,W.overlayLine.value=B.overlay&&"line"==B.plotType,x.color=new bi.Color(B.overlayColour),x.needsUpdate=!0}function Ur(){_t||oo()}function Pr(e){B[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function Vr(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function kr(){B.customSurface?_.vertexShader=li():_.vertexShader=ri(),_.needsUpdate=!0}function Rr(){"surface"==B.plotType?($(Ee).show(),B.customSurface?(Eo($e),$o(Fe)):($o($e),Eo(Fe))):($(Ee).hide(),$o($e))}function Mr(){L=new bi.Group,a.add(L);const e=Math.max($t,Et),t=Math.round(Ba(3,window.width<629?20:64,B.arrowDensity));let n=Math.max(Math.floor(e/t),1);const i=Math.floor($t/n),o=Math.floor(Et/n),r=Math.floor(($t-n*(i-1))/2),l=Math.floor((Et-n*(o-1))/2);let s,u,c,d,f,p;for(let e=0;e<o;e++){u=l+e*n,p=((u+.5)/Et-.5)*U.geometry.parameters.height;for(let e=0;e<i;e++)c=r+e*n,f=((c+.5)/$t-.5)*U.geometry.parameters.width,s=c+u*$t,d=Ir([f,p,1],[0,0,0]),d.ind=s,L.add(d)}}function Ir(e,t){const n=new bi.Group,i=new bi.Mesh(T,F);i.rotation.x=Math.PI/2;const o=new bi.Mesh(D,F);return o.rotation.x=Math.PI/2,o.rotation.y=Math.PI/4,o.position.z=T.parameters.height/2,n.add(i),n.add(o),n.scale.multiplyScalar(tn),n.position.set(e[0],e[1],e[2]),n.lookAt(e[0]+t[0],e[1]+t[1],e[2]+t[2]),n}function Nr(){if(L)for(a.remove(L);L.children.length;)L.remove(L.children[0])}function Lr(){if(W.vectorField.value=B.vectorField,B.vectorField){if(Nr(),Mr(),Or(),"relative"==B.arrowScale)try{L.customMax=Ii.evaluate(B.arrowLengthMax)}catch(e){er("Unable to evaluate the maximum arrow length. Please check the definition."),L.customMax=1}}else Nr()}function Or(){F.color=new bi.Color(B.arrowColour)}function qr(e){const t=va(e,Ui.concat(Pi));return t&&er("The name '"+e+"' is already in use, so can't be used as a parameter name. Please use a different name for "+e+"."),!t}function Br(e){return e=(e=e.replaceAll(/\bMINX\b/g,(()=>_o(B.minX)))).replaceAll(/\bMINY\b/g,(()=>_o(B.minY)))}function Wr(e,t,n,i,o){if(e in t)return[t,n.slice(0,-1),o];for(const a of i[e])n.includes(a)?o.push(n.slice(n.indexOf(a))):[t,,o]=Wr(a,t,[...n,a],i,o);return t[e]=!0,[t,n.slice(0,-1),o]}function jr(){if($("#simCanvas").css("cursor","auto"),B.brushEnabled&&"surface"!=B.plotType&&"line"!=B.plotType)switch(B.brushType){case"circle":$("#simCanvas").css("cursor","url('images/cursor-circle.svg') 12 12, auto");break;case"hline":$("#simCanvas").css("cursor","url('images/cursor-hline.svg') 32 32, auto");break;case"vline":$("#simCanvas").css("cursor","url('images/cursor-vline.svg') 32 32, auto")}}Bi&&wo("GrayScott"),jt=qi.has("story"),jt&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),pt.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),oa(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),xt=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),(ta()||Bi||B.forceTryClickingPopup)&&!B.suppressTryClickingPopup&&B.brushEnabled&&($("#top_message").html("<p>"+B.tryClickingText+"</p>"),na("#top_message"),setTimeout((()=>ia("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>ia("#top_message")))),$("#settings").click((function(){br(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&Sr(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&wr(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&vr(),$("#views_ui").is(":visible")&&yr()),$("#left_ui").is(":visible")&&ka()})),$("#equations").click((function(){vr(),ka(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&br(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&yr()})),$("#pause").click((function(){fo()})),$("#play").click((function(){po()})),$("#erase").click((function(){mo()})),$("#share").click((function(){wr(),$("#help_panel").is(":visible")&&Sr()})),$("#help").click((function(){Sr(),$("#share_panel").is(":visible")&&wr()})),$("#screenshot").click((function(){_n=!0,oo(),wr()})),$("#link").click((function(){j.copyConfigAsURL(),wr()})),$("#embed").click((function(){!function(){let e=Cr();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}xr('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),wr()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){Sr()})),$("#views").click((function(){yr(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&br(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&vr()})),$("#error_close_button").click((function(){ia("#error")})),$("#oops_hit_nan_close").click((function(){ia("#oops_hit_nan"),Wt=!0})),$(document).on("click","#add_view",(function(){!function(){let e=rr();e.name=++Ht,B.views.push(e),B.activeViewInd=B.views.length-1,nr()}()})),Ot=!1,function e(){requestAnimationFrame(e),vt=bt,bt&&B.brushEnabled&&function(){!B.fixRandSeed&&B.brushValue.includes("RAND")&&Po();P.material=b;for(let e=1;e<Rt.length;e++)W.textureSource.value=Rt[e].texture,l.setRenderTarget(Rt[e-1]),l.render(r,o);Rt.rotate(-1)}();if(_t){!yt||function(){P.material=v;for(let e=1;e<Rt.length;e++)W.textureSource.value=Rt[e].texture,l.setRenderTarget(Rt[e-1]),l.render(r,o);Rt.rotate(-1)}();for(let e=0;e<B.numTimestepsPerFrame;e++){if(B.autoPause&&Bt&&W.t.value>=B.autoPauseAt){Bt=!1,fo();break}Qt&&!B.fixRandSeed&&Po(),io()}}(vt||_t)&&oo()}();