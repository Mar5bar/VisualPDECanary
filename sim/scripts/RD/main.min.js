import{drawShaderTop as e,drawShaderBotReplace as t,drawShaderBotAdd as n,drawShaderShapeDisc as i,drawShaderShapeVLine as o,drawShaderShapeHLine as a,drawShaderFactorSharp as r,drawShaderFactorSmooth as s}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as l,computeDisplayFunShaderMid as u,postGenericShaderBot as c,postShaderDomainIndicator as d,interpolationShader as h,minMaxShader as f}from"./post_shaders.js";import{copyShader as m}from"../copy_shader.js";import{RDShaderTop as p,RDShaderBot as g,RDShaderDirichletX as b,RDShaderDirichletY as v,RDShaderDirichletIndicatorFun as w,RDShaderRobinX as _,RDShaderRobinY as y,RDShaderRobinCustomDomainX as S,RDShaderRobinCustomDomainY as C,RDShaderUpdateNormal as x,RDShaderUpdateCross as D,RDShaderAlgebraicSpecies as F,RDShaderEnforceDirichletTop as E,RDShaderAdvectionPreBC as T,RDShaderAdvectionPostBC as A,RDShaderDiffusionPreBC as P,RDShaderDiffusionPostBC as U,RDShaderGhostX as V,RDShaderGhostY as k,RDShaderMain as q,clampSpeciesToEdgeShader as R}from"./simulation_shaders.js";import{randShader as M,randNShader as I}from"../rand_shader.js";import{fiveColourDisplayTop as L,fiveColourDisplayBot as N,embossShader as B,contourShader as W,surfaceVertexShaderColour as O,surfaceVertexShaderCustom as j,overlayShader as Q}from"./display_shaders.js";import{getColours as G}from"../colourmaps.js";import{genericVertexShader as z}from"../generic_shaders.js";import{getPreset as H,getUserTextFields as Y,getFieldsInView as J,getListOfPresets as X,getOldPresetFieldsToNew as Z,getListOfPresetNames as K}from"./presets.js";import{clearShaderBot as ee,clearShaderTop as te}from"./clear_shader.js";import*as ne from"../three.module.min.js";import{OrbitControls as ie}from"../OrbitControls.js";import{Line2 as oe}from"../lines/Line2.js";import{LineMaterial as ae}from"../lines/LineMaterial.js";import{LineGeometry as re}from"../lines/LineGeometry.js";import{minifyPreset as se,maxifyPreset as le}from"./minify_preset.js";import{LZString as ue}from"../lz-string.min.js";import{equationTEXFun as ce,getDefaultTeXLabelsDiffusion as de,getDefaultTeXLabelsReaction as he,getDefaultTeXLabelsBCsICs as fe,substituteGreek as me}from"./TEX.js";import{closestMatch as pe}from"../../../assets/js/closest-match.js";import{Stats as ge}from"../stats.min.js";!async function(){let be,ve,we,_e,ye,Se,Ce,xe,De,Fe,Ee,$e,Te,Ae,Pe,Ue,Ve,ke,qe,Re,Me,Ie,Le,Ne,Be,We,Oe,je,Qe,Ge,ze,He,Ye,Je,Xe,Ze,Ke,et,tt,nt,it,ot,at,rt,st,lt,ut,ct,dt,ht,ft,mt,pt,gt,bt,vt,wt,_t,yt,St,Ct,xt,Dt,Ft,Et,$t,Tt,At,Pt,Ut,Vt,kt,qt,Rt,Mt,It=[],Lt=[],Nt={},Bt={},Wt=[],Ot=[],jt=[],Qt=new Set,Gt=!0,zt=!1,Ht=!0,Yt=!0,Jt=!1,Xt=!1,Zt=!1,Kt=!1,en=!1,tn=!1,nn=0,on=0,an=performance.now(),rn=!1,sn=null,ln=!0,un=1,cn=1,dn=.15,hn={},fn=[],mn={},pn=0;const gn="GrayScott",bn=["u","v","w","q"],vn=["UFUN","VFUN","WFUN","QFUN"],wn=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"];let _n,yn,Sn,Cn,xn,Dn,Fn,En=!1,$n=!1;const Tn=["zero","one","two","three","four","five","six","seven","eight","nine"];let An,Pn,Un,Vn=ce(),kn={...de(),...he(),...fe()};const qn=J();let Rn=new exprEval.Parser;Rn.consts.pi=Math.PI,Rn.consts.Pi=Math.PI,Rn.consts.e=Math.exp(1);const Mn=new ge;Mn.showPanel(0),Mn.dom.id="stats",document.body.appendChild(Mn.dom),at={};const In=Y();var Ln,Nn;lt={reset:function(){bi()},toggleRunning:function(){yt?pi():gi()},copyConfigAsURL:function(){Ta($a())},saveSimState:function(){Xo()},exportSimState:function(){Zo()},clearCheckpoints:function(){tn&&(Ue.dispose(),Ue=null,tn=!1)}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(Ln=Array.prototype.push,Nn=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,Ln.apply(this,Nn.call(this,0,e)),this}),be=document.getElementById("simCanvas"),console.error=function(e){Kt=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),ia(t.toString().trim()+". Click <a href='/user-guide/FAQ#undeclared' target='blank'>here</a> for more information.")},no()||$("#logo").hide();const Bn=new URLSearchParams(window.location.search);Bn.has("no_ui")?($(".ui").addClass("hidden"),en=!0):$(".ui").removeClass("hidden");const Wn=Bn.has("logo_only");Wn&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),en=!0),Bn.has("sf")&&(cn=parseFloat(Bn.get("sf")),(isNaN(cn)||cn<=0)&&(cn=1)),Ei("default"),function(){rt={brushCoords:{type:"v2",value:new ne.Vector2(.5,.5)},colour1:{type:"v4",value:new ne.Vector4(0,0,0,0)},colour2:{type:"v4",value:new ne.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new ne.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new ne.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new ne.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},overlayLine:{type:"bool",value:!0},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},vectorField:{type:"bool",value:!1}},st={firstFlag:{type:"bool"},srcResolution:{type:"v2"},textureSource:{type:"t"}},St=!1,Ee=new ne.Raycaster,$e=new ne.Vector2;const e=localStorage.getItem("AA")?"true"==localStorage.getItem("AA"):!Ea()&&devicePixelRatio<3;Bt.antialias=e,xe=new ne.WebGLRenderer({canvas:be,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:e,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),xe.autoClear=!0,ve=xe.getContext(),kt=ve.getParameter(ve.MAX_TEXTURE_SIZE),we=!(ve.getExtension("OES_texture_float_linear")&&ve.getExtension("EXT_float_blend")),Pe={format:ne.RGBAFormat,type:ne.FloatType,minFilter:ne.NearestFilter},we|=/android/i.test(navigator.userAgent),Pe.magFilter=we?ne.NearestFilter:ne.LinearFilter,It.push(new ne.WebGLRenderTarget(at.maxDisc,at.maxDisc,Pe)),It.push(It[0].clone()),It.push(It[0].clone()),It.push(It[0].clone()),It.push(It[0].clone()),Te=It[0].clone(),Ae=It[0].clone(),It.forEach((e=>{e.texture.wrapS=ne.RepeatWrapping,e.texture.wrapT=ne.RepeatWrapping})),Te.texture.wrapS=ne.ClampToEdgeWrapping,Te.texture.wrapT=ne.ClampToEdgeWrapping,Ae.texture.wrapS=ne.ClampToEdgeWrapping,Ae.texture.wrapT=ne.ClampToEdgeWrapping,_e=new ne.OrthographicCamera(-.5,.5,.5,-.5,-1,10),Fe=new ie(_e,be),Fe.listenToKeyEvents(document),Fe.addEventListener("change",(function(){"surface"==at.plotType&&(at.cameraTheta=90-180*Math.acos(_e.position.y)/Math.PI,at.cameraPhi=-180*Math.atan2(_e.position.x,_e.position.z)/Math.PI,at.cameraZoom=_e.zoom,ca("cameraTheta"),ca("cameraPhi"),ca("cameraZoom"),$i(ht),Ra())})),ye=new ne.OrthographicCamera(-.5,.5,.5,-.5,-1,10),ye.position.z=1,Se=new ne.Scene,Ce=new ne.Scene,Se.add(_e),Se.background=new ne.Color(at.backgroundColour),Ve=new ne.MeshBasicMaterial({side:ne.DoubleSide}),ke=new ne.ShaderMaterial({uniforms:rt,vertexShader:z(),transparent:!0,side:ne.DoubleSide}),Le=new ne.ShaderMaterial({uniforms:rt,vertexShader:z()}),Oe=new ne.ShaderMaterial({uniforms:rt,vertexShader:z(),fragmentShader:h()}),qe=new ne.ShaderMaterial({uniforms:rt,vertexShader:z()}),Nt.FE=new ne.ShaderMaterial({uniforms:rt,vertexShader:z()}),Nt.AB2=new ne.ShaderMaterial({uniforms:rt,vertexShader:z()});for(let e=1;e<3;e++)Nt["Mid"+e.toString()]=new ne.ShaderMaterial({uniforms:rt,vertexShader:z()});for(let e=1;e<5;e++)Nt["RK4"+e.toString()]=new ne.ShaderMaterial({uniforms:rt,vertexShader:z()});Ie=new ne.ShaderMaterial({uniforms:rt,vertexShader:z(),fragmentShader:m()}),Me=new ne.ShaderMaterial({uniforms:rt,vertexShader:z()}),Re=new ne.ShaderMaterial({uniforms:rt,vertexShader:z()}),Ne=new ae({vertexColors:!0,linewidth:.01}),Be=new ae({color:0,linewidth:.01}),We=new ne.MeshBasicMaterial({color:at.arrowColour,side:ne.DoubleSide}),je=new ne.MeshBasicMaterial,Qe=new ne.ShaderMaterial({uniforms:st,vertexShader:z(),fragmentShader:f()}),Ge=new ne.CylinderGeometry(.008,.008,.1),ze=new ne.ConeGeometry(.04,.04,4);const t=new ne.PlaneGeometry(1,1);Ye=new ne.Mesh(t,Nt[0]),Ye.position.z=0,Ye.matrixWorldAutoUpdate=!1,Ce.add(Ye),Kn(),ei(),Jn(),ni(),Hn(),ii(),Oi(),Qi(),ai(),oi(),qi(),wo(),bi(),be.addEventListener("pointerdown",ci),be.addEventListener("pointerup",di),be.addEventListener("pointermove",hi),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(lt.toggleRunning(),e.preventDefault()),"h"===e.key&&(en?(en=!1,$(".ui").removeClass("hidden"),vt.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",Et),yt?gi():pi(),vo(),Eo(),Mo()):(en=!0,$(".ui").addClass("hidden"))),"s"==e.key&&Xo(),"c"==e.key&&(at.resetFromCheckpoints=!at.resetFromCheckpoints,Ma($("#checkpointButton")[0])))})),window.addEventListener("resize",(function(){Hn(),Ra()}),!1),window.addEventListener("message",Aa),$("#checkpointInput").change((function(){Ko(this.files[0]),this.value=null}))}();let On=!0;if(Bn.has("preset")&&(Fi(Bn.get("preset")),On=!1),Bn.has("options")){var jn=JSON.parse(ue.decompressFromEncodedURIComponent(Bn.get("options")));jn.hasOwnProperty("p")&&(jn=le(jn)),Fi(jn),On=!1}On&&Fi(gn),Jt=Bn.has("story"),Jt&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),vt.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),ao(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#play_pause_placeholder").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),Et=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),$("#settings").click((function(){Sa(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&Da(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&Fa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&Ca(),$("#views_ui").is(":visible")&&xa()),$("#left_ui").is(":visible")&&Mo()})),$("#equations").click((function(){Ca(),Mo(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&Sa(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&xa()})),$("#pause").click((function(){pi()})),$("#play").click((function(){gi()})),$("#erase").click((function(){bi()})),$("#share").click((function(){Fa(),$("#help_panel").is(":visible")&&Da()})),$("#help").click((function(){Da(),$("#share_panel").is(":visible")&&Fa()})),$("#screenshot").click((function(){En=!0,li(),Fa()})),$("#link").click((function(){lt.copyConfigAsURL(),Fa()})),$("#embed").click((function(){!function(){let e=$a();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}Ta('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),Fa()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){Da()})),$("#views").click((function(){xa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&Sa(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&Ca()})),$("#error_close_button").click((function(){oo("#error")})),$("#preset_error_close_button").click((function(){oo("#bad_preset")})),$("#oops_hit_nan_close").click((function(){oo("#oops_hit_nan"),Yt=!0})),$("#start_tour").click((function(){$("#welcome").css("display","none"),Qn.start()})),$(document).on("click","#add_view",(function(){!function(){let e=ua();e.name=++nn,at.views.push(e),at.activeViewInd=at.views.length-1,aa()}()}));const Qn=new Shepherd.Tour({useModalOverlay:!0,defaultStepOptions:{classes:"shadow-md bg-purple-dark",scrollTo:!1,cancelIcon:{enabled:!0},buttons:[{action(){return this.back()},classes:"shepherd-button-secondary",text:"Back"},{action(){return this.next()},text:"Next"}],when:{show(){Xa()}}}});let Gn="Interactivity is at the heart of VisualPDE. In most simulations, clicking on the screen allows you to interact directly with the solution.<br><video autoplay loop playsinline muted disableRemotePlayback poster=\"../assets/images/demo.webp\" width=\"128\" style=\"margin-top:10px\"><source src='../assets/ani/demo.mp4' type='video/mp4'><source src='../assets/ani/demo.webm' type='video/webm'></video><br>This can even kickstart pattern formation or other exciting phenomena.";Ea()&&(Gn=Gn.replaceAll("clicking","tapping"),Gn=Gn.replaceAll("click","tap"),Gn=Gn.replaceAll("Clicking","Tapping"),Gn=Gn.replaceAll("Click","Tap")),Qn.addStep({title:"Playing with PDEs",text:Gn,buttons:[{action(){return this.next()},text:"Next"}]}),Qn.addStep({title:"Equations and definitions",text:"Customise the equations, parameters, boundary and initial conditions of the simulation.<br><video autoplay loop playsinline muted disableRemotePlayback width=\"216\" style=\"margin-top:10px\"><source src='../assets/ani/params.mp4' type='video/mp4'><source src='../assets/ani/params.webm' type='video/webm'></video>",attachTo:{element:"#equations",on:"right"},when:{show(){Xa(),Za("/user-guide/advanced-options.html#equations")}}}),Qn.addStep({title:"Play/pause",text:"Play or pause the simulation. You can still draw when paused.",attachTo:{element:"#play_pause_placeholder",on:"right"}}),Qn.addStep({title:"Reset",text:"Click to restart the simulation. You can change the initial conditions in the equations menu.",attachTo:{element:"#erase",on:"right"},when:{show(){Xa(),Za("/user-guide/advanced-options.html#checkpoints","Advanced")}}}),Qn.addStep({title:"Views",text:"The Views menu lets you customise your view of the solution. This includes everything from contours to colour bars.<br><div class=views_pics><img src='../assets/images/FHNTuringWave.webp'><img src='../assets/images/midnight_soliton.webp'><img src='../assets/images/complexGinzburgLandau.webp'></div>",attachTo:{element:"#views",on:"right"},when:{show(){Xa(),Za("/user-guide/advanced-options.html#views")}}}),Qn.addStep({title:"Settings",text:"Tweak advanced options such as the equation type, the domain resolution and the timestepping scheme.",attachTo:{element:"#settings",on:"right"},when:{show(){Xa(),Za("/user-guide/advanced-options.html#settings")}}}),Qn.addStep({title:"Sharing",text:"VisualPDE is built for sharing. Copy a link that leads straight to the current simulation, download snapshots of your solution or even embed your simulation in your own site.",attachTo:{element:"#share",on:"right"},when:{show(){Xa(),Za("/user-guide/FAQ.html#sharing")}}}),Qn.addStep({title:"Help",text:"Help is always at hand. Access FAQs, detailed documentation and guides explaining how to do everything that's possible in VisualPDE. You can even restart this tour.",attachTo:{element:"#help",on:"right"},buttons:[{action(){return this.back()},classes:"shepherd-button-secondary",text:"Back"},{action(){return this.complete()},text:"Finish"}]});const zn=!(Jt||en);if((!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("visited"==e[t].split("=")[0].trim())return!0}return!1}()||zn&&!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("seenFullWelcome"==e[t].split("=")[0].trim())return!0}return!1}())&&"Banner"!=at.preset&&!Wn){let e=yt;pi();let t="welcome_no";zn||($("#tour_question").hide(),$("#lets_go_cont").show(),t="lets_go"),$("#welcome").css("display","block");const n=await Promise.race([yo(document.getElementById("welcome_ok"),"click",!0),yo(document.getElementById(t),"click",!1)]);$("#welcome").css("display","none"),function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="visited=true;"+t+";path=/"}(),zn&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="seenFullWelcome=true;"+t+";path=/"}(),n&&await new Promise((function(e){["complete","cancel"].forEach((function(t){Shepherd.once(t,(()=>e()))})),Qn.start()})),$("#help").is(":visible")&&($("#get_help").fadeIn(1e3),setTimeout((()=>$("#get_help").fadeOut(1e3)),4e3)),e&&gi()}function Hn(){Kn(),function(){Ye.material=Ie;for(let e=1;e<It.length;e++)rt.textureSource.value=It[e].texture,It[e-1].setSize(Tt,At),xe.setRenderTarget(It[e-1]),xe.render(Ce,ye);It.rotate(-1),It[0].dispose(),It[0]=It[1].clone(),Te.setSize(Tt,At),ui(),Lt.forEach((e=>e.dispose())),Lt=[];let e=Tt,t=At;const n={format:ne.RGBAFormat,type:ne.FloatType,minFilter:ne.NearestFilter,magFilter:ne.NearestFilter,wrapS:ne.ClampToEdgeWrapping,wrapT:ne.ClampToEdgeWrapping};for(;e>1||t>1;)e=Math.max(1,Math.ceil(e/2)),t=Math.max(1,Math.ceil(t/2)),Lt.push(new ne.WebGLRenderTarget(e,t,n));Ae.setSize(Math.round(devicePixelRatio*qt),Math.round(devicePixelRatio*Rt))}(),ea(Ue),Xn(),Yn(),ja(),Jn(),Eo(),Mo()}function Yn(){He.geometry.dispose(),Se.remove(He),Je.geometry.dispose(),Se.remove(Je),Xe.geometry.dispose(),Se.remove(Xe),Ze.geometry.dispose(),Se.remove(Ze),ei()}function Jn(){switch(Zn(),at.plotType){case"line":Fe.enabled=!1,_e.zoom=1,Fo(),ke.vertexShader=O();break;case"plane":Fe.enabled=!1,Fe.reset(),ke.vertexShader=z();break;case"surface":Fe.enabled=!0,_e.zoom=at.cameraZoom,Fo(),La()}ke.needsUpdate=!0,_e.left=-Pt/(2*Vt),_e.right=Pt/(2*Vt),_e.top=Ut/(2*Vt),_e.bottom=-Ut/(2*Vt),_e.updateProjectionMatrix(),ti()}function Xn(){rt.L.value=un,rt.L_y.value=Ut,rt.L_x.value=Pt,rt.L_min.value=Math.min(Ut,Pt),rt.dt.value=at.dt,rt.dx.value=$t,rt.dy.value=$t,rt.heightScale.value=at.threeDHeightScale,rt.maxColourValue.value=at.maxColourValue,rt.minColourValue.value=at.minColourValue,rt.customSurface.value=at.customSurface,rt.vectorField.value=at.vectorField,Pa(),ki()}function Zn(){try{un=Rn.evaluate(at.domainScale)}catch(e){ia("Unable to evaluate the domain length. Please check the definition."),un=100}qt=Math.round(be.getBoundingClientRect().width),Rt=Math.round(be.getBoundingClientRect().height),De=Rt/qt,De<=0&&(De=.1),De>=1?(Ut=un,Pt=Ut/De):(Pt=un,Ut=Pt*De),1==at.dimension&&(Pt=un),rt.L_x.value=Pt,rt.L_y.value=Ut,Vt=Math.max(Pt,Ut)}function Kn(){Zn(),$t=un/100;try{$t=Rn.evaluate(at.spatialStep)}catch(e){ia("Unable to evaluate the spatial step. Please check the definition.")}$t<=0&&(ia("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),$t=un/100),Tt=Math.floor(Pt/$t),At=Math.floor(Ut/$t),(Tt>kt||At>kt)&&(ia("Your device does not support a discretisation this fine (maximum "+kt+"). Please increase the space step to at least "+(Math.ceil(1e4*un/kt)/1e4).toPrecision(4)+" or reduce the domain size to at most "+(Math.floor(1e4*kt*$t)/1e4).toPrecision(4)+"."),Tt=Math.min(Tt,kt),At=Math.min(At,kt)),0==Tt&&(Tt=1),0==At&&(At=1),1==at.dimension&&(At=1),rt.nXDisc.value=Tt,rt.nYDisc.value=At,Ke=new Array(Tt),et=new Array(Tt);let e=-.5,t=Tt>1?1/(Tt-1):.5;for(let n=0;n<Ke.length;n++)Ke[n]=e,e+=t;Ke=Ke.map((e=>e*Pt/Vt)),na(),xn=new Float32Array(Tt*At*4),$n=!1}function ei(){Zn();let e=[1,1];ln||(e=[Tt,At]);const t=new ne.PlaneGeometry(Pt/Vt,Ut/Vt,e[0],e[1]);He=new ne.Mesh(t,ke),He.position.z=0,He.visible="line"!=at.plotType,He.matrixAutoUpdate=!1,Se.add(He);const n=new ne.PlaneGeometry(Pt/Vt,Ut/Vt,1,1);Je=new ne.Mesh(n,Ve),Je.position.z=0,Je.visible=!1,Je.matrixAutoUpdate=!1,Se.add(Je),ti();const i=new re;tt=Math.round(2*devicePixelRatio*qt);const o=new Array(3*tt).fill(0),a=new Array(o.length).fill(0);i.setPositions(o),i.setColors(a),Xe=new oe(i,Ne),Xe.scale.set(1,1,1),Xe.visible="line"==at.plotType,Se.add(Xe);const r=new re,s=new Array(3*tt).fill(0);r.setPositions(s),Ze=new oe(r,Be),Ze.scale.set(1,1,1),Ze.visible="line"==at.plotType&&at.overlay,Se.add(Ze)}function ti(){switch(at.plotType){case"plane":He.rotation.x=0,Je.rotation.x=0;break;case"surface":He.rotation.x=-Math.PI/2,Je.rotation.x=-Math.PI/2}He.updateMatrix(),Je.updateMatrix()}function ni(){at.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function ii(e){ct=new dat.GUI({closeOnTop:!0,autoPlace:!1}),ct.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(ct.domElement),dt=new dat.GUI({closeOnTop:!0,autoPlace:!1}),dt.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(dt.domElement),ht=new dat.GUI({closeOnTop:!0,autoPlace:!1}),ht.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(ht.domElement),ct.open(),dt.open(),ht.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),ft=dt.addFolder("Brush");ba(pa(ft),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',Ya,null,"Toggle the brush on or off"),Wt.brushAction=ft.add(at,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange((function(){ai(),document.activeElement.blur()})),Wt.brushType=ft.add(at,"brushType",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange((function(){ai(),document.activeElement.blur()})),ft.add(at,"brushValue").name("Value").onFinishChange(ai),ft.add(at,"brushRadius").name("Radius").onFinishChange(ai),Wt.whatToDraw=ft.add(at,"whatToDraw",An).name("Species").onChange(ai),ft=dt.addFolder("Domain"),ft.add(at,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){Do(),document.activeElement.blur(),Ra()})),ft.add(at,"domainScale").name("Largest side").onFinishChange((function(){Hn(),Ra()})),ft.add(at,"spatialStep").name("Space step").onFinishChange((function(){Hn(),Ra()})),ft.add(at,"minX").name("Min. $x$").onFinishChange((function(){Qi(),bi()})),Wt.minY=ft.add(at,"minY").name("Min. $y$").onFinishChange((function(){Qi(),bi()}));const t=pa(ft);ba(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){ni(),Hn(),Jn(),Ra()}),null,"Use a square domain"),ba(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Custom',(function(){ji(),Oi(),Ci(),Bi(),Ra()}),null,"Specify a custom domain"),Wt.domainIndicatorFun=ft.add(at,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){ji(),Oi(),Ci(),Li(),Ra()})),ft=dt.addFolder("Timestepping"),Wt.numTimestepsPerFrame=ft.add(at,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),Ua(Wt.numTimestepsPerFrame,1,400,1),Wt.dt=ft.add(at,"dt").name("Timestep").onChange((function(){Xn()})),Wt.dt.__precision=12,Wt.dt.min(0),Wt.dt.updateDisplay(),ft.add(at,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme").onChange((function(){document.activeElement.blur()}));const n=pa(ft);ba(n,"timeDisplay",'<i class="fa-regular fa-hourglass-half"></i> Elapsed time',uo,null,"Show/hide time display"),ba(n,"autoPause",'<i class="fa-regular fa-hourglass-end"></i> Auto pause',(function(){Ht=rt.t.value<at.autoPauseAt,Oi()}),null,"Toggle automatic pausing"),Wt.autoPauseAt=ft.add(at,"autoPauseAt").name("Pause at $t=$").onFinishChange((function(){Ht=rt.t.value<at.autoPauseAt,Wt.autoPauseAt.domElement.blur()})),ft=dt.addFolder("Equations"),ft.add(at,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange((function(){document.activeElement.blur(),Qi(),bi()})),Wt.algebraicSpecies=ft.add(at,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){rn=!0,Qi(),rn=!1,bi()})),ft.add(at,"speciesNames").name("Species names").onFinishChange((function(){Bo()}));ba(pa(ft),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',(function(){Qi()}),"cross_diffusion_controller","Toggle cross diffusion"),ft=ct.addFolder("Definitions");ba(pa(ft),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',Gi,null,"Typeset the specified equations"),Wt.Duu=ft.add(at,"diffusionStr_1_1").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Duu,Yo,["U","UU"]),Ho(Wt.Duu,Jo,["U","UU"]),Wt.Duv=ft.add(at,"diffusionStr_1_2").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Duv,Yo,["UV"]),Ho(Wt.Duv,Jo,["UV"]),Wt.Duw=ft.add(at,"diffusionStr_1_3").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Duw,Yo,["UW"]),Ho(Wt.Duw,Jo,["UW"]),Wt.Duq=ft.add(at,"diffusionStr_1_4").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Duq,Yo,["UQ"]),Ho(Wt.Duq,Jo,["UQ"]),Wt.Dvu=ft.add(at,"diffusionStr_2_1").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dvu,Yo,["VU"]),Ho(Wt.Dvu,Jo,["VU"]),Wt.Dvv=ft.add(at,"diffusionStr_2_2").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dvv,Yo,["V","VV"]),Ho(Wt.Dvv,Jo,["V","VV"]),Wt.Dvw=ft.add(at,"diffusionStr_2_3").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dvw,Yo,["VW"]),Ho(Wt.Dvw,Jo,["VW"]),Wt.Dvq=ft.add(at,"diffusionStr_2_4").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dvq,Yo,["VQ"]),Ho(Wt.Dvq,Jo,["VQ"]),Wt.Dwu=ft.add(at,"diffusionStr_3_1").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dwu,Yo,["WU"]),Ho(Wt.Dwu,Jo,["WU"]),Wt.Dwv=ft.add(at,"diffusionStr_3_2").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dwv,Yo,["WV"]),Ho(Wt.Dwv,Jo,["WV"]),Wt.Dww=ft.add(at,"diffusionStr_3_3").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dww,Yo,["W","WW"]),Ho(Wt.Dww,Jo,["W","WW"]),Wt.Dwq=ft.add(at,"diffusionStr_3_4").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dwq,Yo,["WQ"]),Ho(Wt.Dwq,Jo,["WQ"]),Wt.Dqu=ft.add(at,"diffusionStr_4_1").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dqu,Yo,["QU"]),Ho(Wt.Dqu,Jo,["QU"]),Wt.Dqv=ft.add(at,"diffusionStr_4_2").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dqv,Yo,["QV"]),Ho(Wt.Dqv,Jo,["QV"]),Wt.Dqw=ft.add(at,"diffusionStr_4_3").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dqw,Yo,["QW"]),Ho(Wt.Dqw,Jo,["QW"]),Wt.Dqq=ft.add(at,"diffusionStr_4_4").onFinishChange((function(){Ci(),Gi()})),zo(Wt.Dqq,Yo,["Q","QQ"]),Ho(Wt.Dqq,Jo,["Q","QQ"]),Wt.f=ft.add(at,"reactionStr_1").onFinishChange((function(){Ci(),Gi()})),zo(Wt.f,Yo,["UFUN"]),Ho(Wt.f,Jo,["UFUN"]),Wt.g=ft.add(at,"reactionStr_2").onFinishChange((function(){Ci(),Gi()})),zo(Wt.g,Yo,["VFUN"]),Ho(Wt.g,Jo,["VFUN"]),Wt.h=ft.add(at,"reactionStr_3").onFinishChange((function(){Ci(),Gi()})),zo(Wt.h,Yo,["WFUN"]),Ho(Wt.h,Jo,["WFUN"]),Wt.j=ft.add(at,"reactionStr_4").onFinishChange((function(){Ci(),Gi()})),zo(Wt.j,Yo,["QFUN"]),Ho(Wt.j,Jo,["QFUN"]),Mt=ct.addFolder("Parameters"),function(){let e,t,n=[],i=at.kineticParams.split(";");for(var o=0;o<i.length;o++)t=Ki(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+pn,pn+=1,fn.push(e),hn[e]=t,n.push(e));for(const e of n)eo(e,!1);e="param"+pn,fn.push(e),hn[e]=t,eo(e,!0)}(),ft=ct.addFolder("Boundary conditions"),Wt.uBCs=ft.add(at,"boundaryConditions_1",{}).onChange((function(){Ci(),Vi(),document.activeElement.blur()})),Wt.dirichletU=ft.add(at,"dirichletStr_1").onFinishChange(Ci),Wt.neumannU=ft.add(at,"neumannStr_1").onFinishChange(Ci),Wt.robinU=ft.add(at,"robinStr_1").onFinishChange(Ci),Wt.comboU=ft.add(at,"comboStr_1").name("Details").onFinishChange(Ci),Wt.vBCs=ft.add(at,"boundaryConditions_2",{}).onChange((function(){Ci(),Vi(),document.activeElement.blur()})),Wt.dirichletV=ft.add(at,"dirichletStr_2").onFinishChange(Ci),Wt.neumannV=ft.add(at,"neumannStr_2").onFinishChange(Ci),Wt.robinV=ft.add(at,"robinStr_2").onFinishChange(Ci),Wt.comboV=ft.add(at,"comboStr_2").name("Details").onFinishChange(Ci),Wt.wBCs=ft.add(at,"boundaryConditions_3",{}).onChange((function(){Ci(),Vi(),document.activeElement.blur()})),Wt.dirichletW=ft.add(at,"dirichletStr_3").onFinishChange(Ci),Wt.neumannW=ft.add(at,"neumannStr_3").onFinishChange(Ci),Wt.robinW=ft.add(at,"robinStr_3").onFinishChange(Ci),Wt.comboW=ft.add(at,"comboStr_3").name("Details").onFinishChange(Ci),Wt.qBCs=ft.add(at,"boundaryConditions_4",{}).name("$q$").onChange((function(){Ci(),Vi(),document.activeElement.blur()})),Wt.dirichletQ=ft.add(at,"dirichletStr_4").onFinishChange(Ci),Wt.neumannQ=ft.add(at,"neumannStr_4").onFinishChange(Ci),Wt.robinQ=ft.add(at,"robinStr_4").onFinishChange(Ci),Wt.comboQ=ft.add(at,"comboStr_4").name("Details").onFinishChange(Ci),ft=ct.addFolder("Initial conditions"),Wt.initCond_1=ft.add(at,"initCond_1").onFinishChange(qi),Wt.initCond_2=ft.add(at,"initCond_2").onFinishChange(qi),Wt.initCond_3=ft.add(at,"initCond_3").onFinishChange(qi),Wt.initCond_4=ft.add(at,"initCond_4").onFinishChange(qi),pt=dt.addFolder("Images"),ft=pt,Ii(),ft=dt.addFolder("Checkpoints");const i=pa(ft);ba(i,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),va(i),ga(i,'<i class="fa-regular fa-flag"></i> Set',Xo,null,"Set a checkpoint at the current state",["narrow"]),ga(i,'<i class="fa-regular fa-file-arrow-down"></i> Export',Zo,null,"Download the last checkpoint as a file",["narrow"]),ga(i,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),ft.add(at,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize").onChange((function(){document.activeElement.blur()})),ft=dt.addFolder("Misc."),ft.addColor(at,"backgroundColour").name("Background").onChange((function(){Se.background=new ne.Color(at.backgroundColour),Ra()}));const o=pa(ft);ba(o,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){ho(),Ra()}),null,"Compute the integral of the plotted expression over the domain"),ba(o,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',(function(){wo(),Ra()}),"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),ba(o,"setSeed",'<i class="fa-regular fa-shuffle"></i> Set seed',(function(){at.setSeed&&(an=at.randSeed),ki(),Oi()}),null,"Set the seed for random number generation"),Wt.randSeed=ft.add(at,"randSeed").name("Random seed").onFinishChange((function(){ki()})),ft=ft.addFolder("Dev");const a=pa(ft);ga(a,'<i class="fa-regular fa-copy"></i> Copy code',wa,null,"Copy the simulation configuration as JSON to the clipboard"),ga(a,'<i class="fa-regular fa-bug"></i> Copy debug',_a,null,"Copy debug information to the clipboard"),ba(a,"showStats",'<i class="fa-regular fa-chart-line"></i> Show stats',(function(){ya()}),"interpController","Show performance statistics"),ba(a,"antialias",'<i class="fa-regular fa-display"></i> Antialias',(function(){localStorage.setItem("AA",Bt.antialias),lt.copyConfigAsURL(),alert("Toggling antialiasing requires a page reload. We've copied the current simulation link to your clipboard.")}),void 0,"Antialias the display (useful for vector fields on low-res displays). Requires page reload.",void 0,void 0,Bt);let r=X();var s;Object.keys(r).forEach((function(e){r[e]=e})),r.default=null,ft.add(at,"parent",(s=r,Object.keys(s).sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})).reduce((function(e,t){return e[t]=s[t],e}),{}))).name("Parent preset").onChange((function(){document.activeElement.blur()})),ft.add(at,"guiUpdatePeriod").name("GUI update period)");const l=document.createElement("div");l.innerHTML="Settings",l.classList.add("ui_title"),dt.domElement.prepend(l);const u=document.createElement("div");u.innerHTML="Equations",u.classList.add("ui_title"),ct.domElement.prepend(u);const c=document.createElement("div");c.id="views_list",ht.domElement.prepend(c);const d=document.createElement("div");d.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",d.classList.add("ui_title"),ht.domElement.prepend(d),vt=ht.addFolder("Edit view"),ft=vt;const h=pa(ft,"edit_view_buttons");ga(h,'<i class="fa-solid fa-pen-nib"></i> Rename',sa,null,"Rename the current view"),ga(h,'<i class="fa-solid fa-xmark"></i> Delete',la,"deleteViewButton","Delete view"),Wt.whatToPlot=ft.add(at,"whatToPlot").name("Expression: ").onFinishChange((function(){Li(),Ra(),ca(this.property)})),ft.add(at,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){xo(),document.activeElement.blur(),Ra(),ca(this.property)})),ft.add(at,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){ri(),ao(),document.activeElement.blur(),Ra(),ca(this.property)})).name("Colour map"),Wt.minColourValue=ft.add(at,"minColourValue").name("Min value").onChange((function(){Xn(),ro(),Ra(),ca(this.property)})),Wt.minColourValue.__precision=2,Wt.maxColourValue=ft.add(at,"maxColourValue").name("Max value").onChange((function(){Xn(),ro(),Ra(),ca(this.property)})),Wt.maxColourValue.__precision=2;const f=pa(ft,"colour_map_buttons");ga(f,'<i class="fa-regular fa-arrows-rotate"></i> Flip',(function(){at.flippedColourmap=!at.flippedColourmap,ri(),ao(),Ra(),ca("flippedColourmap")}),null,"Reverse colour map",["narrow"]),ga(f,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){Lo(),li(),ca("minColourValue"),ca("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),ba(f,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){ao(),ca("colourbar")}),null,"Display the colourbar",null,["narrow"]),va(f),ba(f,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){at.autoSetColourRange&&(Lo(),li()),ca("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),ba(f,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){ri(),Ra(),ca("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),ba(f,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){ri(),Ra(),ca("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),ba(f,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){ri(),Ra(),ca("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),ba(f,"vectorField",'<i class="fa-solid fa-arrow-right-arrow-left"></i> Vector field',(function(){ja(),Ra(),ca("vectorField")}),"vectorFieldButton","Toggle vector field","vectorFieldFolder",["wide"]),ft=vt.addFolder("Contours"),ft.domElement.id="contoursFolder",Wt.contourColour=ft.addColor(at,"contourColour").name("Colour").onChange((function(){ka(),Ra(),ca(this.property)})),Wt.contourNum=ft.add(at,"contourNum").name("Number").onChange((function(){ka(),Ra(),ca(this.property)})),Ua(Wt.contourNum,1,20,1),Ot.push(Wt.contourNum),Wt.contourEpsilon=ft.add(at,"contourEpsilon").name("Threshold").onChange((function(){ka(),Ra(),ca(this.property)})),Ua(Wt.contourEpsilon,.001,.05,.001),Ot.push(Wt.contourEpsilon),ft=vt.addFolder("Lighting"),ft.domElement.id="embossFolder",Wt.embossSmoothness=ft.add(at,"embossSmoothness").name("Smoothness").onChange((function(){Pa(),Ra(),ca(this.property)})),Ua(Wt.embossSmoothness,0,2,.001),jt.push(Wt.embossSmoothness),Wt.embossAmbient=ft.add(at,"embossAmbient").name("Ambient").onChange((function(){Pa(),Ra(),ca(this.property)})),Ua(Wt.embossAmbient,0,1,.001),jt.push(Wt.embossAmbient),Wt.embossDiffuse=ft.add(at,"embossDiffuse").name("Diffuse").onChange((function(){Pa(),Ra(),ca(this.property)})),Ua(Wt.embossDiffuse,0,1,.001),jt.push(Wt.embossDiffuse),Wt.embossSpecular=ft.add(at,"embossSpecular").name("Specular").onChange((function(){Pa(),Ra(),ca(this.property)})),Ua(Wt.embossSpecular,0,1,.001),jt.push(Wt.embossSpecular),Wt.embossShiny=ft.add(at,"embossShiny").name("Precision").onChange((function(){Pa(),Ra(),ca(this.property)})),Ua(Wt.embossShiny,0,100,1),jt.push(Wt.embossShiny),Wt.embossTheta=ft.add(at,"embossTheta").name("Inclination").onChange((function(){Pa(),Ra(),ca(this.property)})),Ua(Wt.embossTheta,0,1.5708,.001),jt.push(Wt.embossTheta),Wt.embossPhi=ft.add(at,"embossPhi").name("Direction").onChange((function(){Pa(),Ra(),ca(this.property)})),Ua(Wt.embossPhi,0,3.1456,.001),jt.push(Wt.embossPhi),ft=vt.addFolder("Overlay"),ft.domElement.id="overlayFolder",ft.addColor(at,"overlayColour").name("Colour").onChange((function(){qa(),Ra(),ca(this.property)})),ft.add(at,"overlayExpr").name("Expression").onFinishChange((function(){ri(),"line"==at.plotType&&Bi(),Ra(),ca(this.property)})),Wt.overlayEpsilon=ft.add(at,"overlayEpsilon").name("Threshold").onChange((function(){qa(),Ra(),ca(this.property)})),Wt.overlayLineWidthMul=ft.add(at,"overlayLineWidthMul",.1,2).name("Thickness").onChange((function(){Go(),Ra(),ca(this.property)})),wt=vt.addFolder("3D"),ft=wt,mt=pa(ft),ba(mt,"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){rt.customSurface.value=at.customSurface,La(),Na(),Ra(),ca("customSurface")}),null,"Plot the solution on a custom surface"),Wt.surfaceFun=ft.add(at,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){Li(),Ra(),ca(this.property)})),Wt.threeDHeightScale=ft.add(at,"threeDHeightScale").name("Height scale").onChange((function(){Xn(),Ra(),ca(this.property)})),Wt.cameraTheta=ft.add(at,"cameraTheta").name("View $\\theta$").onChange((function(){Jn(),Ra(),ca(this.property)})),Wt.cameraPhi=ft.add(at,"cameraPhi").name("View $\\phi$").onChange((function(){Jn(),Ra(),ca(this.property)})),Wt.cameraZoom=ft.add(at,"cameraZoom").name("Zoom").onChange((function(){Jn(),Ra(),ca(this.property)})),Wt.lineWidthMul=ft.add(at,"lineWidthMul",.1,2).name("Thickness").onChange((function(){Go(),Ra(),ca(this.property)})),_t=vt.addFolder("Vector field"),ft=_t,ft.domElement.id="vectorFieldFolder",ft.addColor(at,"arrowColour").name("Colour").onChange((function(){Qa(),Ra(),ca(this.property)})),ft.add(at,"arrowX").onFinishChange((function(){Bi(),Ra(),ca(this.property)})).name("$x$ component"),ft.add(at,"arrowY").onFinishChange((function(){Bi(),Ra(),ca(this.property)})).name("$y$ component"),Wt.arrowDensity=ft.add(at,"arrowDensity").onChange((function(){ja(),Ra(),ca(this.property)})).name("Density"),Wt.arrowDensity.__precision=2,Ua(Wt.arrowDensity,0,1,.001),ft.add(at,"arrowScale",{None:"none",Relative:"relative",Auto:"auto"}).onFinishChange((function(){Oi(),Ra(),ca(this.property)})).name("Scaling"),Wt.arrowLengthMax=ft.add(at,"arrowLengthMax").onFinishChange((function(){ja(),Ra(),ca(this.property)})).name("Max length");document.querySelectorAll("input").forEach((e=>Ia(e)))}function oi(){ri(),ao(),Li(),ai()}function ai(){let l=Vo()+e(),u="float brushRadius = "+yi(at.brushRadius.toString())+";\n";switch(u=u.replace(/\buvwq\./g,"uvwqBrush."),u=u.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(at.brushValue)&&(l+=M()),/\bRANDN\b/.test(at.brushValue)&&(l+=I()),l+="float brushValue = "+yi(at.brushValue)+";\n",l+=u,at.brushType){case"circle":l+=i();break;case"hline":l+=a();break;case"vline":l+=o()}switch(at.brushAction){case"replace":l+=r(),l+=t();break;case"add":l+=r(),l+=n();break;case"smoothreplace":l+=s(),l+=t();break;case"smoothadd":l+=s(),l+=n()}Ya(),l=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,Ui(at.whatToDraw)),e}(l),l=za(l),qe.fragmentShader=l,qe.needsUpdate=!0}function ri(){it=G(at.colourmap),at.flippedColourmap&&(it.reverse(),it=it.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),rt.colour1.value=new ne.Vector4(...it[0]),rt.colour2.value=new ne.Vector4(...it[1]),rt.colour3.value=new ne.Vector4(...it[2]),rt.colour4.value=new ne.Vector4(...it[3]),rt.colour5.value=new ne.Vector4(...it[4]);let e=Vo()+L();at.emboss&&(e+=B(),Pa()),at.contours&&(e+=W(),ka()),at.overlay&&(e+=Q().replaceAll("OVERLAYEXPR",yi(at.overlayExpr)),e=za(e),qa()),Ze.visible=at.overlay&&"line"==at.plotType,e+=N(),ke.fragmentShader=e,ke.needsUpdate=!0,Le.needsUpdate=!0,ot=it.map((e=>e[3])),it=it.map((e=>e.slice(0,-1)))}function si(){switch(at.timesteppingScheme){case"Euler":Ye.material=Nt.FE,rt.textureSource.value=It[1].texture,rt.textureSource1.value=It[2].texture,rt.dt.value=at.dt,xe.setRenderTarget(It[0]),xe.render(Ce,ye),It.rotate(-1),rt.t.value+=at.dt;break;case"AB2":Ye.material=Nt.AB2,rt.textureSource.value=It[1].texture,rt.textureSource1.value=It[2].texture,rt.dt.value=at.dt,xe.setRenderTarget(It[0]),xe.render(Ce,ye),It.rotate(-1),rt.t.value+=at.dt;break;case"Mid":Ye.material=Nt.Mid1,rt.textureSource.value=It[1].texture,xe.setRenderTarget(It[2]),xe.render(Ce,ye),Ye.material=Nt.Mid2,rt.textureSource1.value=It[2].texture,rt.t.value+=.5*at.dt,xe.setRenderTarget(It[0]),xe.render(Ce,ye),It.rotate(-1),rt.t.value+=.5*at.dt;break;case"RK4":Ye.material=Nt.RK41,rt.textureSource.value=It[1].texture,xe.setRenderTarget(It[2]),xe.render(Ce,ye),Ye.material=Nt.RK42,rt.textureSource1.value=It[2].texture,rt.t.value+=.5*at.dt,xe.setRenderTarget(It[3]),xe.render(Ce,ye),Ye.material=Nt.RK43,rt.textureSource2.value=It[3].texture,xe.setRenderTarget(It[4]),xe.render(Ce,ye),Ye.material=Nt.RK44,rt.textureSource3.value=It[4].texture,rt.t.value+=.5*at.dt,xe.setRenderTarget(It[0]),xe.render(Ce,ye),It.rotate(-1)}}function li(){if(ui(),!at.autoSetColourRange||on%at.guiUpdatePeriod||Lo(),at.brushEnabled&&"surface"==at.plotType){let e=0;at.maxColourValue-at.minColourValue>0&&(e=(function(){go();let e=0;for(let t=0;t<xn.length;t+=4)e+=xn[t];return e/(Tt*At)}()-at.minColourValue)/(at.maxColourValue-at.minColourValue)-.5,e=e.clamp(-.5,.5)),Je.position.y=at.threeDHeightScale*e,Je.updateWorldMatrix()}if("line"==at.plotType){go();let t=0;var e=at.maxColourValue-at.minColourValue;e=0==e?.5:e;for(let n=0;n<xn.length;n+=4)et[t++]=(xn[n]-at.minColourValue)/e-.5;let n=new ne.SplineCurve(Ke.map(((e,t)=>new ne.Vector2(e,et[t])))),i=n.getSpacedPoints(tt);if(Oo(Xe,i),function(e,t){let n,i=e.geometry.attributes.instanceColorStart,o=e.geometry.attributes.instanceColorEnd;for(let e=0;e<t.length;e++)n=jo(t[e].toArray()[1]+.5),e<t.length&&i.setXYZ(e,n[0],n[1],n[2]),e>0&&o.setXYZ(e-1,n[0],n[1],n[2]);i.needsUpdate=!0}(Xe,i),at.overlay){t=0;for(let n=2;n<4*Tt;n+=4)et[t++]=(xn[n]-at.minColourValue)/e-.5;n=new ne.SplineCurve(Ke.map(((e,t)=>new ne.Vector2(e,et[t])))),i=n.getSpacedPoints(tt),Oo(Ze,i)}}if(at.vectorField&&nt&&!(on%at.guiUpdatePeriod)){Fn=new Float32Array(Tt*At*4),xe.readRenderTargetPixels(Te,0,0,Tt,At,Fn);let e,t,n,i=[];for(const o of nt.children)e=4*o.ind,t=Fn[e+2],n=Fn[e+3],o.visible=Fn[e+1]<=.5,o.lookAt(o.position.x+t,o.position.y+n,o.position.z),o.size=t**2+n**2,i.push(o.size);let o=1;switch(at.arrowScale){case"auto":o=Math.sqrt(Math.max(...i)),0==o&&(o=1);for(const e of nt.children){const t=dn*Qo(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"relative":o=nt.customMax>0?nt.customMax:1;for(const e of nt.children){const t=dn*Qo(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"none":for(const e of nt.children)e.scale.set(dn,dn,dn)}}if(!at.timeDisplay||on%at.guiUpdatePeriod||co(),!at.integrate||on%at.guiUpdatePeriod||function(){if(at.integrate){let e;go(),1==at.dimension?e=rt.dx.value:2==at.dimension&&(e=rt.dx.value*rt.dy.value);let t=0;for(let e=0;e<xn.length;e+=4)t+=xn[e]*(1-xn[e+1]);t*=e,$("#integralValue").html(so(t,4)),vo()}}(),_o()?(Ye.material=Oe,xe.setRenderTarget(Ae),xe.render(Ce,ye),rt.textureSource.value=Ae.texture,rt.dxUpscaledScale.value=devicePixelRatio*qt/Tt,rt.dyUpscaledScale.value=devicePixelRatio*Rt/At):(rt.dxUpscaledScale.value=1,rt.dyUpscaledScale.value=1),xe.setRenderTarget(null),xe.render(Se,_e),En){En=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",xe.render(Se,_e),t.href=xe.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Kn(),li()}on=(on+1)%at.guiUpdatePeriod}function ui(){sn=null,Ye.material=Le,rt.textureSource.value=It[1].texture,xe.setRenderTarget(Te),xe.render(Ce,ye),rt.textureSource.value=Te.texture,$n=!1,rt.textureSource1.value=It[1].texture}function ci(e){St=fi(e,be),St&&(at.brushEnabled&&"surface"==at.plotType?Fe.enabled=!1:at.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),io("#top_message"),window.clearTimeout(Ft),Ft=setTimeout((function(){$("#top_message").hasClass("fading_out")||oo("#top_message")}),3e3)))}function di(e){St=!1,"surface"==at.plotType&&(Fe.enabled=!0)}function hi(e){fi(e,be)}function fi(e,t){var n=t.getBoundingClientRect();let i=(e.clientX-n.x)/n.width,o=1-(e.clientY-n.y)/n.height;if("surface"==at.plotType){$e.x=2*i-1,$e.y=2*o-1,Ee.setFromCamera($e,_e);var a=Ee.intersectObject(Je,!1);a.length>0?(i=a[0].uv.x,o=a[0].uv.y):(i=-1,o=-1)}else"line"==at.plotType&&(i=(i-.5)/_e.zoom+.5,o=.5);return i=Math.round(i*Tt)/Tt,o=Math.round(o*At)/At,rt.brushCoords.value=new ne.Vector2(i,o),0<=i&&i<=1&&0<=o&&o<=1}function mi(){xe.setSize(Tt,At,!1),tn&&at.resetFromCheckpoints?Ye.material=je:Ye.material=Me,It.forEach((e=>{xe.setRenderTarget(e),xe.render(Ce,ye)})),na(),li()}function pi(){en||($("#pause").hide(),$("#play").show()),yt=!1,Ra()}function gi(){en||($("#play").hide(),$("#pause").show()),Yt=!0,window.clearTimeout(Dt),Dt=setTimeout(po,1e3),yt=!0}function bi(){at.setSeed&&(an=at.randSeed),ki(),rt.t.value=0,Ht=!0,co(),mi(),li(),Yt=!0,window.clearTimeout(Dt),po()}function vi(){let e="";return e+="float UFUN = "+yi(at.reactionStr_1)+";\n",e+="float VFUN = "+yi(at.reactionStr_2)+";\n",e+="float WFUN = "+yi(at.reactionStr_3)+";\n",e+="float QFUN = "+yi(at.reactionStr_4)+";\n",e}function wi(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function _i(e){let t="";return t+="float D"+e+"y = D"+e+"x;\n",t+="float D"+e+"yL = D"+e+"xL;\n",t+="float D"+e+"yR = D"+e+"xR;\n",t+="float D"+e+"yT = D"+e+"xT;\n",t+="float D"+e+"yB = D"+e+"xB;\n",t}function yi(e){if(!oa(e=" "+e+" ")||Ja(e))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])?\b/g);let i,o,a,r,s,l,u,c,d,h,f,m,p,g=0;const b={S:"One",T:"Two"},v={R:"r",G:"g",B:"b",A:"a"};for(const w of n){for(i=w.index,m=b[w[1]],o=i+w[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,s=t.slice(o+g+1,a+g),s=Ro(s),l=s.split(","),1!=l.length&&0!=l[1].trim().length||(l[1]="0"),l[0]="("+l[0]+"-MINX)/L_x",l[1]="("+l[1]+"-MINY)/L_y",h="texture(imageSource"+m+",vec2("+l.join(",")+")).",null!=w[2]?(p=v[w[2]],f=h+p):(p=["r","g","b"],f="("+p.map((e=>h+e)).join("+")+")/3.0 "),t=Xi(t,f,i+g,a+1+g),g+=f.length-a+i-1)}return t}(e=(e=To(e=(e=(e=(e=Si(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){if("0"==n)return"1";const i=Number(n);return Number.isInteger(i&&i>0&&i<101)?"(("+t+")"+("*("+t+")").repeat(i-1)+")":"safepow("+t+","+n+")"}))).replaceAll(RegExp("\\b("+Un[0]+")\\b","g"),(function(e,t){return"uvwq."+Ui(t)}))).replaceAll(RegExp("\\b("+Un[0]+")_([xy][fb]?2?)\\b","g"),(function(e,t,n){return n.includes("2")&&(n=n.slice(0,-1).repeat(2)),"uvwq"+n.toUpperCase()+"."+Ui(t)}))).replaceAll(RegExp("\\b("+Un[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+Ui(t)})))).replaceAll(/\b(I_[ST][RBGA]?\b)\s*(?!\()/g,"$1(x,y) "));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e=e.replaceAll(/\bind\b/g,"float")}function Si(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function Ci(){let e="",t="",n="",i="",o="",a="",r="",s=[!1,!1,!1,!1],l=[!1,!1,!1,!1];It.forEach((e=>{e.texture.wrapS=ne.RepeatWrapping,e.texture.wrapT=ne.RepeatWrapping}));const u=[at.boundaryConditions_1,at.boundaryConditions_2,at.boundaryConditions_3,at.boundaryConditions_4],c=[at.neumannStr_1,at.neumannStr_2,at.neumannStr_3,at.neumannStr_4],d=[at.comboStr_1,at.comboStr_2,at.comboStr_3,at.comboStr_4].map((e=>e+";")),h=[at.dirichletStr_1,at.dirichletStr_2,at.dirichletStr_3,at.dirichletStr_4],f=[at.robinStr_1,at.robinStr_2,at.robinStr_3,at.robinStr_4];u.forEach((function(t,n){"neumann"==t?(s[n]=!0,l[n]=!0,e+=xi(c[n],An[n]),at.domainViaIndicatorFun?e+=fa(n):e+=ha(n)):"combo"==t&&[...d[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=xi(t[2],An[n],i),e+=ha(n,i),["L","R"].includes(i)&&(s[n]=!0),["T","B"].includes(i)&&(l[n]=!0)}))})),u.forEach((function(e,n){"combo"==e&&[...d[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=Pi(V(t),An[e]),at.dimension>1&&(i+=Pi(k(t),An[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,yi(e[2])),["L","R"].includes(i)&&(s[n]=!0),["T","B"].includes(i)&&(l[n]=!0)}))})),u.forEach((function(e,t){if("dirichlet"==e)if(s[t]=!0,l[t]=!0,at.domainViaIndicatorFun){let e=w().replace(/indicatorFun/g,yi(at.domainIndicatorFun));n+=Pi(e,An[t])+yi(h[t])+";\n}\n"}else n+=Di(h[t],An[t]),n+=da(t);else if("combo"==e)[...d[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=Di(e[2],An[t],i),n+=da(t,i),["L","R"].includes(i)&&(s[t]=!0),["T","B"].includes(i)&&(l[t]=!0)}));else if(at.domainViaIndicatorFun){let e=w().replace(/indicatorFun/g,yi(at.domainIndicatorFun));n+=Pi(e,An[t])+"0.0;\n}\n"}})),u.forEach((function(e,t){"robin"==e?(s[t]=!0,l[t]=!0,i+=xi(f[t],An[t]),at.domainViaIndicatorFun?i+=fa(t):i+=ha(t)):"combo"==e&&[...d[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=xi(e[2],An[t],n),i+=ha(t,n),["L","R"].includes(n)&&(s[t]=!0),["T","B"].includes(n)&&(l[t]=!0)}))}));let m=Vo();if(o=function(){let e="";const t=[[at.diffusionStr_1_1,"uu"],[at.diffusionStr_2_2,"vv"],[at.diffusionStr_3_3,"ww"],[at.diffusionStr_4_4,"qq"]];for(let[n,i]of t){let t;if(n.includes(";")){let e=n.split(";").filter((e=>e));n=e[0],e.length>1&&at.dimension>1&&(t=e[1])}e+=wi(yi(n)+";\n",i+"x"),e+=t?wi(yi(t)+";\n",i+"y"):_i(i)}return e}()+"\n",at.crossDiffusion?o+=function(){let e="";const t=[[at.diffusionStr_1_2,"uv"],[at.diffusionStr_1_3,"uw"],[at.diffusionStr_1_4,"uq"],[at.diffusionStr_2_1,"vu"],[at.diffusionStr_2_3,"vw"],[at.diffusionStr_2_4,"vq"],[at.diffusionStr_3_1,"wu"],[at.diffusionStr_3_2,"wv"],[at.diffusionStr_3_4,"wq"],[at.diffusionStr_4_1,"qu"],[at.diffusionStr_4_2,"qv"],[at.diffusionStr_4_3,"qw"]];for(let[n,i]of t){let t;if(n.includes(";")){let e=n.split(";").filter((e=>e));n=e[0],e.length>1&&at.dimension>1&&(t=e[1])}e+=wi(yi(n)+";\n",i+"x"),e+=t?wi(yi(t)+";\n",i+"y"):_i(i)}return e}()+"\n"+D():o+=x(),at.numAlgebraicSpecies>=2){const e=at.numSpecies-at.numAlgebraicSpecies;let t={};for(let n=e;n<at.numSpecies;n++){let i=[],o=at["reactionStr_"+(n+1).toString()];for(let t=e;t<at.numSpecies;t++)o=[o,at["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()]].join(" ");for(let t=e;t<at.numSpecies;t++){(new RegExp("\\b"+An[t]+"(_(x|xb|xf|xb2|xf2|xx|y|yb|yf|yb2|yf2|yy))?\\b").test(o)||"0"!=at["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()])&&i.push(An[t])}i!=[]&&(t[An[n]]=i)}let n={},i=[],o=[];for(let a of An.slice(e,at.numSpecies))Ha(a,n,i,t,o);if(o.length>0)return void ia("Cyclic variables detected. Please check the definition(s) of "+o.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.")}if(yn&&at.crossDiffusion&&(a+=Pi(F(),An[1])),Sn&&at.crossDiffusion&&(a+=Pi(F(),An[2])),Cn&&at.crossDiffusion&&(a+=Pi(F(),An[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void ia("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");if(s.every((e=>e)))It.forEach((e=>{e.texture.wrapS=ne.ClampToEdgeWrapping}));else{let e="";s.forEach(((t,n)=>{t&&(e+=Ui(An[n]))})),r+=e?R("H").replaceAll(/\bSPECIES\b/g,e):""}if(l.every((e=>e)))It.forEach((e=>{e.texture.wrapT=ne.ClampToEdgeWrapping}));else{let e="";l.forEach(((t,n)=>{t&&(e+=Ui(An[n]))})),r+=e?R("V").replaceAll(/\bSPECIES\b/g,e):""}let b=[r,T(),P(),e,t,i,A(),U(),vi(),o].join(" "),v=/\bRAND\b/.test(b),_=/\bRANDN\b/.test(b);v&&(b=M()+b),_&&(b=I()+b),Xt=v||_;let y=[n,a,g()].join(" "),S="FE";Nt[S].fragmentShader=za([m,p(S),b,q(S),y].join(" ")),S="AB2",Nt[S].fragmentShader=za([m,p(S),b,q(S),y].join(" ")),S="Mid";for(let e=1;e<3;e++)Nt[S+e.toString()].fragmentShader=za([m,p(S+e.toString()),b,q(S+e.toString()),y].join(" "));S="RK4";for(let e=1;e<5;e++)Nt[S+e.toString()].fragmentShader=za([m,p(S+e.toString()),b,q(S+e.toString()),y].join(" "));if(Object.keys(Nt).forEach((e=>Nt[e].needsUpdate=!0)),xt=at.domainViaIndicatorFun||"dirichlet"==at.boundaryConditions_1||"dirichlet"==at.boundaryConditions_2||"dirichlet"==at.boundaryConditions_3||"dirichlet"==at.boundaryConditions_4||/Dirichlet/.test(at.comboStr_1)||/Dirichlet/.test(at.comboStr_2)||/Dirichlet/.test(at.comboStr_3)||/Dirichlet/.test(at.comboStr_4),xt){if(n=m+E(),at.domainViaIndicatorFun){let e=w().replace(/indicatorFun/,yi(at.domainIndicatorFun)).replace(/updated/,"gl_FragColor");h.forEach((function(t,i){"dirichlet"==u[i]?n+=Pi(e,An[i])+yi(t)+";\n}\n":n+=Pi(e,An[i])+"0.0;\n}\n"}))}else u.forEach((function(e,t){"dirichlet"==e?(n+=Di(h[t],An[t]),n+=ma(t)):"combo"==e&&[...d[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=Di(e[2],An[t],i),n+=ma(t,i)}))}));n+="}",n=za(n),Re.fragmentShader=n,Re.needsUpdate=!0}}function xi(e,t,n){return null==n?["L","R","T","B"].map((n=>xi(e,t,n))).join(""):"float robinRHS"+t+n+" = "+yi(e)+";\n"}function Di(e,t,n){return null==n?["L","R","T","B"].map((n=>Di(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+yi(e)+";\n"}function Fi(e){Ei("default"),Ei(e),null!=at.threeD&&(at.threeD&&(at.dimension=2,null==at.plotType&&(at.plotType="surface")),delete at.threeD),null!=at.oneDimensional&&(at.oneDimensional&&(at.dimension=1,at.plotType="line"),delete at.oneDimensional),un*=cn,function(){if(0==at.views.length){let e=ua();e.name="1",at.views.push(e)}else at.views=at.views.map((function(e){let t=ua();return Object.assign(t,e),t}))}(),Ti(ct,!0),Ti(dt,!0),Ti(ht,!0),ii(),at.activeViewInd>=at.views.length&&(at.activeViewInd=at.views.length-1),ra(at.views[at.activeViewInd],!1),Qi(),ni(),Hn(),Xn(),Se.background=new ne.Color(at.backgroundColour),""!=at.initialState?fetch(at.initialState).then((e=>e.blob())).then((e=>Ko(e))):bi(),Jn(),gt.remove(),bt.remove(),Ii(),wo()}function Ei(e){let t;const n=K(),i=n.map((e=>e.toLowerCase()));if(null==e)t=H(at.preset);else if("string"==typeof e)if(i.includes(e.toLowerCase()))t=H(e);else{const i=pe(e,n,!1);o="We couldn't find a preset called '"+e+"'."+(null!=i?" We've loaded the closest match, '"+i+"'.":"")+" Please check the preset specified in the URL.",pi(),$("#preset_description").html(o),io("#bad_preset"),t=H(i||gn)}else t="object"==typeof e?e:H(gn);var o;t.hasOwnProperty("parent")&&null!=t.parent&&Ei(t.parent),pn=0,fn=[],hn={},Object.assign(at,t),yt=at.runningOnLoad,Bo(),yt?gi():pi(),Ea()?(at.guiUpdatePeriod=Math.max(at.guiUpdatePeriod,3),at.tryClickingText=at.tryClickingText.replaceAll("clicking","tapping")):at.tryClickingText=at.tryClickingText.replaceAll("tapping","clicking"),at.brushRadius=at.brushRadius.toString(),at.hasOwnProperty("drawIn3D")&&(at.brushEnabled=at.drawIn3D);var a=0;a+=at.hasOwnProperty("algebraicV"),a+=at.hasOwnProperty("algebraicW"),(a+=at.hasOwnProperty("algebraicQ"))&&!at.numAlgebraicSpecies&&(at.numAlgebraicSpecies=a),delete at.algebraicV,delete at.algebraicW,delete at.algebraicQ;const r=Z();Object.keys(r).forEach((function(e){at.hasOwnProperty(e)&&(t.hasOwnProperty(r[e])||(at[r[e]]=at[e]),delete at[e])})),null==at.minColourValue&&(at.minColourValue=0),null==at.maxColourValue&&(at.maxColourValue=1),at.domainScale=at.domainScale.toString(),at.spatialStep=at.spatialStep.toString(),ut=JSON.parse(JSON.stringify(at));let s=[at.initCond_1,at.initCond_2,at.initCond_3,at.initCond_4,at.domainIndicatorFun,at.reactionStr_1,at.reactionStr_2,at.reactionStr_3,at.reactionStr_4,at.diffusionStr_1_1,at.diffusionStr_1_2,at.diffusionStr_1_3,at.diffusionStr_1_4,at.diffusionStr_2_1,at.diffusionStr_2_2,at.diffusionStr_2_3,at.diffusionStr_2_4,at.diffusionStr_3_1,at.diffusionStr_3_2,at.diffusionStr_3_3,at.diffusionStr_3_4,at.diffusionStr_4_1,at.diffusionStr_4_2,at.diffusionStr_4_3,at.diffusionStr_4_4,at.dirichletStr_1,at.dirichletStr_2,at.dirichletStr_3,at.dirichletStr_4,at.robinStr_1,at.robinStr_2,at.robinStr_3,at.robinStr_4,at.comboStr_1,at.comboStr_2,at.comboStr_3,at.comboStr_4,at.neumannStr_1,at.neumannStr_2,at.neumannStr_3,at.neumannStr_4,at.brushValue,at.whatToPlot].join(" ");at.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(s)}function $i(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)$i(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Ti(e,t){if(null!=e){for(let t in e.__folders)Ti(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function Ai(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function Pi(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=Ui(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function Ui(e){return"rgba"[function(e){return An.indexOf(e)}(e)]}function Vi(){"dirichlet"==at.boundaryConditions_1?Wt.dirichletU.show():Wt.dirichletU.hide(),"dirichlet"==at.boundaryConditions_2?Wt.dirichletV.show():Wt.dirichletV.hide(),"dirichlet"==at.boundaryConditions_3?Wt.dirichletW.show():Wt.dirichletW.hide(),"dirichlet"==at.boundaryConditions_4?Wt.dirichletQ.show():Wt.dirichletQ.hide(),"neumann"==at.boundaryConditions_1?Wt.neumannU.show():Wt.neumannU.hide(),"neumann"==at.boundaryConditions_2?Wt.neumannV.show():Wt.neumannV.hide(),"neumann"==at.boundaryConditions_3?Wt.neumannW.show():Wt.neumannW.hide(),"neumann"==at.boundaryConditions_4?Wt.neumannQ.show():Wt.neumannQ.hide(),"robin"==at.boundaryConditions_1?Wt.robinU.show():Wt.robinU.hide(),"robin"==at.boundaryConditions_2?Wt.robinV.show():Wt.robinV.hide(),"robin"==at.boundaryConditions_3?Wt.robinW.show():Wt.robinW.hide(),"robin"==at.boundaryConditions_4?Wt.robinQ.show():Wt.robinQ.hide(),"combo"==at.boundaryConditions_1?Wt.comboU.show():Wt.comboU.hide(),"combo"==at.boundaryConditions_2?Wt.comboV.show():Wt.comboV.hide(),"combo"==at.boundaryConditions_3?Wt.comboW.show():Wt.comboW.hide(),"combo"==at.boundaryConditions_4?Wt.comboQ.show():Wt.comboQ.hide();const e=[Wt.uBCs,Wt.vBCs,Wt.wBCs,Wt.qBCs];at.domainViaIndicatorFun?e.forEach((e=>No(e,["Dirichlet","Neumann","Robin"],["dirichlet","neumann","robin"]))):e.forEach((e=>No(e,["Periodic","Dirichlet","Neumann","Robin","Combination"],["periodic","dirichlet","neumann","robin","combo"]))),$i(ct)}function ki(){an=(an+123456789)%1e9,rt.seed.value=an/1e6}function qi(){let e=Vo()+te(),t=[at.initCond_1,at.initCond_2,at.initCond_3,at.initCond_4].join(" ");/\bRAND\b/.test(t)&&(e+=M()),/\bRANDN\b/.test(t)&&(e+=I()),e+="float u = "+yi(at.initCond_1)+";\n",e+="float v = "+yi(at.initCond_2)+";\n",e+="float w = "+yi(at.initCond_3)+";\n",e+="float q = "+yi(at.initCond_4)+";\n",e+=ee(),e=za(e),Me.fragmentShader=e,Me.needsUpdate=!0}function Ri(){let e=new Image;e.src=gt.__image.src;let t=new ne.Texture;t.magFilter=ne.NearestFilter,t.minFilter=ne.NearestFilter,t.image=e,e.onload=function(){t.needsUpdate=!0,rt.imageSourceOne.value=t,at.resetOnImageLoad&&bi()}}function Mi(){let e=new Image;e.src=bt.__image.src;let t=new ne.Texture;t.magFilter=ne.NearestFilter,t.minFilter=ne.NearestFilter,t.image=e,e.onload=function(){t.needsUpdate=!0,rt.imageSourceTwo.value=t,at.resetOnImageLoad&&bi()},t.dispose()}function Ii(){ft=pt,gt=ft.addImage(at,"imagePathOne").name("$I_S(x,y)$").onChange(Ri),bt=ft.addImage(at,"imagePathTwo").name("$I_T(x,y)$").onChange(Mi),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Li(){$n=!1,Bi(),Wt.minColourValue.show(),Wt.maxColourValue.show(),ao(),ho()}function Ni(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function Bi(){let e=Vo()+l();e+=u().replace(/\bXVECFUN\b/,yi(at.arrowX)).replace(/\bYVECFUN\b/,yi(at.arrowY)),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,yi(at.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,yi(at.surfaceFun))}(e),at.domainViaIndicatorFun&&(e+=d().replace(/indicatorFun/g,yi(at.domainIndicatorFun))),e=e.replaceAll("OVERLAYEXPR",yi(at.overlayExpr)),e=za(e),qa(),Le.fragmentShader=e+c(),Le.needsUpdate=!0}function Wi(){at.numAlgebraicSpecies=Math.min(parseInt(at.numAlgebraicSpecies),parseInt(at.numSpecies)-1),yn=at.numAlgebraicSpecies>=at.numSpecies-1,Sn=at.numAlgebraicSpecies>=at.numSpecies-2&&at.numSpecies>=3,Cn=at.numAlgebraicSpecies>=at.numSpecies-3&&at.numSpecies>=4}function Oi(){let e="function of "+An.slice(0,at.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+An[1]+",",""),n=e.replace(" "+An[2]+",",""),i=e.replace(" "+An[3]+",","");switch(1==at.dimension?(e=e.replace(" y,",""),Wt.minY.hide()):Wt.minY.show(),at.crossDiffusion&&parseInt(at.numSpecies)>1?(rn||No(Wt.algebraicSpecies,Array.from(Array(parseInt(at.numSpecies)).keys())),Wt.algebraicSpecies.show()):Wt.algebraicSpecies.hide(),at.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),Wt.Duv.hide(),Wt.Dvu.hide(),Wt.Dvv.hide(),Wt.g.hide(),Wt.initCond_2.hide(),Wt.vBCs.hide(),Wt.Duw.hide(),Wt.Dvw.hide(),Wt.Dwu.hide(),Wt.Dwv.hide(),Wt.Dww.hide(),Wt.h.hide(),Wt.initCond_3.hide(),Wt.wBCs.hide(),Wt.Duq.hide(),Wt.Dvq.hide(),Wt.Dwq.hide(),Wt.Dqu.hide(),Wt.Dqv.hide(),Wt.Dqw.hide(),Wt.Dqq.hide(),Wt.j.hide(),Wt.initCond_4.hide(),Wt.qBCs.hide(),parseInt(at.numSpecies)){case 4:at.crossDiffusion?(Wt.Duq.show(),Wt.Dvq.show(),Wt.Dwq.show(),Wt.Dqu.show(),Wt.Dqv.show(),Wt.Dqw.show()):(Wt.Dwq.hide(),Wt.Dqu.hide(),Wt.Dvq.hide(),Wt.Duq.hide(),Wt.Dqv.hide(),Wt.Dqw.hide()),Wt.Dqq.show(),Wt.j.show(),Wt.initCond_4.show(),Wt.qBCs.show();case 3:at.crossDiffusion?(Wt.Duw.show(),Wt.Dvw.show(),Wt.Dwu.show(),Wt.Dwv.show()):(Wt.Duw.hide(),Wt.Dvw.hide(),Wt.Dwu.hide(),Wt.Dwv.hide()),Wt.Dww.show(),Wt.h.show(),Wt.initCond_3.show(),Wt.wBCs.show();case 2:at.crossDiffusion?(Wt.Duv.show(),Wt.Dvu.show()):(Wt.Duv.hide(),Wt.Dvu.hide()),Wt.Dvv.show(),Wt.g.show(),Wt.initCond_2.show(),Wt.vBCs.show()}at.crossDiffusion?(Ai(Wt.Duu,kn.Duu,e),Ai(Wt.Duv,kn.Duv,e),Ai(Wt.Duw,kn.Duw,e),Ai(Wt.Duq,kn.Duq,e),Ai(Wt.Dvu,kn.Dvu,e),Ai(Wt.Dvv,kn.Dvv,e),Ai(Wt.Dvw,kn.Dvw,e),Ai(Wt.Dvq,kn.Dvq,e),Ai(Wt.Dwu,kn.Dwu,e),Ai(Wt.Dwv,kn.Dwv,e),Ai(Wt.Dww,kn.Dww,e),Ai(Wt.Dwq,kn.Dwq,e),Ai(Wt.Dqu,kn.Dqu,e),Ai(Wt.Dqv,kn.Dqv,e),Ai(Wt.Dqw,kn.Dqw,e),Ai(Wt.Dqq,kn.Dqq,e)):(Ai(Wt.Duu,kn.Du,e),Ai(Wt.Dvv,kn.Dv,e),Ai(Wt.Dww,kn.Dw,e),Ai(Wt.Dqq,kn.Dq,e)),Ai(Wt.f,kn.UFUN,e),Ai(Wt.g,kn.VFUN,e),Ai(Wt.h,kn.WFUN,e),Ai(Wt.j,kn.QFUN,e),yn&&(Ai(Wt.Dvu,kn.Dvu,t),Ai(Wt.Dvw,kn.Dvw,t),Ai(Wt.Dvq,kn.Dvq,t),Ai(Wt.g,kn.VFUN,t),Wt.Dvv.hide()),Sn&&(Ai(Wt.Dwu,kn.Dwu,i),Ai(Wt.Dwv,kn.Dwv,i),Ai(Wt.Dwq,kn.Dwq,i),Ai(Wt.h,kn.WFUN,i),Wt.Dww.hide()),Cn&&(Ai(Wt.Dqu,kn.Dqu,n),Ai(Wt.Dqv,kn.Dqv,n),Ai(Wt.Dqw,kn.Dqw,n),Ai(Wt.j,kn.QFUN,n),Wt.Dqq.hide()),Ai(Wt.uBCs,kn.u),Ai(Wt.vBCs,kn.v),Ai(Wt.wBCs,kn.w),Ai(Wt.qBCs,kn.q),Ai(Wt.dirichletU,kn.uD),Ai(Wt.dirichletV,kn.vD),Ai(Wt.dirichletW,kn.wD),Ai(Wt.dirichletQ,kn.qD),Ai(Wt.neumannU,kn.uN),Ai(Wt.neumannV,kn.vN),Ai(Wt.neumannW,kn.wN),Ai(Wt.neumannQ,kn.qN),Ai(Wt.robinU,kn.uN),Ai(Wt.robinV,kn.vN),Ai(Wt.robinW,kn.wN),Ai(Wt.robinQ,kn.qN),Ai(Wt.initCond_1,kn.uInit),Ai(Wt.initCond_2,kn.vInit),Ai(Wt.initCond_3,kn.wInit),Ai(Wt.initCond_4,kn.qInit),at.domainViaIndicatorFun?Wt.domainIndicatorFun.show():Wt.domainIndicatorFun.hide(),Vi(),"surface"==at.plotType?($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").hide(),wt.name="3D options",wt.domElement.classList.remove("hidden"),Wt.lineWidthMul.hide(),Wt.threeDHeightScale.show(),Wt.cameraTheta.show(),Wt.cameraPhi.show(),Wt.cameraZoom.show()):"line"==at.plotType?($("#contourButton").hide(),$("#embossButton").hide(),$("#vectorFieldButton").hide(),wt.name="Line options",wt.domElement.classList.remove("hidden"),Wt.lineWidthMul.show(),Wt.threeDHeightScale.show(),Wt.cameraTheta.hide(),Wt.cameraPhi.hide(),Wt.cameraZoom.hide()):($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").show(),wt.domElement.classList.add("hidden"),Wt.lineWidthMul.hide(),Wt.threeDHeightScale.hide(),Wt.cameraTheta.hide(),Wt.cameraPhi.hide(),Wt.cameraZoom.hide()),1==at.dimension&&$("#vectorFieldButton").hide(),ao(),uo(),ho(),$("#dataContainer").show(),Na(),"line"==at.plotType?(Wt.brushType.hide(),$(":root").css("--ui-button-outline","black")):(Wt.brushType.show(),$(":root").css("--ui-button-outline","white")),we?$("#interpController").hide():$("#interpController").show(),"relative"==at.arrowScale?Wt.arrowLengthMax.show():Wt.arrowLengthMax.hide(),No(Wt.whatToDraw,An.slice(0,at.numSpecies)),Va(),at.autoPause?Wt.autoPauseAt.show():Wt.autoPauseAt.hide(),"line"==at.plotType?(Wt.overlayEpsilon.hide(),Wt.overlayLineWidthMul.show()):(Wt.overlayEpsilon.show(),Wt.overlayLineWidthMul.hide()),at.setSeed?Wt.randSeed.show():Wt.randSeed.hide(),$(".toggle_button").each((function(){Ma(this)})),aa(),ya(),$i(ct),$i(dt),$i(ht)}function ji(){let e;switch(Wi(),at.domainViaIndicatorFun&&(["dirichlet","neumann"].includes(at.boundaryConditions_1)||(at.boundaryConditions_1="dirichlet"),["dirichlet","neumann"].includes(at.boundaryConditions_2)||(at.boundaryConditions_2="dirichlet"),["dirichlet","neumann"].includes(at.boundaryConditions_3)||(at.boundaryConditions_3="dirichlet"),["dirichlet","neumann"].includes(at.boundaryConditions_4)||(at.boundaryConditions_4="dirichlet")),parseInt(at.numSpecies)){case 1:at.crossDiffusion=!1,at.whatToDraw=An[0],new RegExp("\\b("+Un[1]+")\\b").test(at.whatToPlot)&&(at.whatToPlot=An[0]),at.diffusionStr_1_2="0",at.diffusionStr_1_3="0",at.diffusionStr_1_4="0",at.diffusionStr_2_1="0",at.diffusionStr_2_2="0",at.diffusionStr_2_3="0",at.diffusionStr_2_4="0",at.diffusionStr_3_1="0",at.diffusionStr_3_2="0",at.diffusionStr_3_3="0",at.diffusionStr_3_4="0",at.diffusionStr_4_1="0",at.diffusionStr_4_2="0",at.diffusionStr_4_3="0",at.diffusionStr_4_4="0",at.boundaryConditions_2="periodic",at.initCond_2="0",at.reactionStr_2="0",at.boundaryConditions_3="periodic",at.initCond_3="0",at.reactionStr_3="0",at.boundaryConditions_4="periodic",at.initCond_4="0",at.reactionStr_4="0",e=new RegExp("\\b("+Un[1]+")\\b"),e.test(at.reactionStr_1)&&(at.reactionStr_1="0");break;case 2:at.whatToDraw==An[2]|at.whatToDraw==An[3]&&(at.whatToDraw=An[0]),new RegExp("\\b("+Un[2]+")\\b").test(at.whatToPlot)&&(at.whatToPlot=An[0]),at.diffusionStr_1_3="0",at.diffusionStr_1_4="0",at.diffusionStr_2_3="0",at.diffusionStr_2_4="0",at.diffusionStr_3_1="0",at.diffusionStr_3_2="0",at.diffusionStr_3_3="0",at.diffusionStr_3_4="0",at.diffusionStr_4_1="0",at.diffusionStr_4_2="0",at.diffusionStr_4_3="0",at.diffusionStr_4_4="0",at.boundaryConditions_3="periodic",at.initCond_3="0",at.reactionStr_3="0",at.boundaryConditions_4="periodic",at.initCond_4="0",at.reactionStr_4="0",e=new RegExp("\\b("+Un[2]+")\\b"),e.test(at.reactionStr_1)&&(at.reactionStr_1="0"),e.test(at.reactionStr_2)&&(at.reactionStr_2="0");break;case 3:at.whatToDraw==An[3]&&(at.whatToDraw=An[0]),new RegExp("\\b("+Un[3]+")\\b").test(at.whatToPlot)&&(at.whatToPlot=An[0]),at.diffusionStr_1_4="0",at.diffusionStr_2_4="0",at.diffusionStr_3_4="0",at.diffusionStr_4_1="0",at.diffusionStr_4_2="0",at.diffusionStr_4_3="0",at.diffusionStr_4_4="0",at.boundaryConditions_4="periodic",at.initCond_4="0",at.reactionStr_4="0",e=new RegExp("\\b("+Un[3]+")\\b"),e.test(at.reactionStr_1)&&(at.reactionStr_1="0"),e.test(at.reactionStr_2)&&(at.reactionStr_2="0"),e.test(at.reactionStr_3)&&(at.reactionStr_3="0")}switch(_n){case 3:at.diffusionStr_2_2="0";break;case 6:at.diffusionStr_3_3="0";break;case 7:at.diffusionStr_2_2="0",at.diffusionStr_3_3="0";break;case 10:at.diffusionStr_4_4="0";break;case 11:at.diffusionStr_3_3="0",at.diffusionStr_4_4="0";break;case 12:at.diffusionStr_2_2="0",at.diffusionStr_3_3="0",at.diffusionStr_4_4="0"}$i(ct),$i(dt)}function Qi(){!function(){switch(Wi(),parseInt(at.numSpecies)){case 1:_n=0;break;case 2:_n=at.crossDiffusion?1==at.numAlgebraicSpecies?3:2:1;break;case 3:if(at.crossDiffusion)switch(at.numAlgebraicSpecies){case 0:_n=5;break;case 1:_n=6;break;case 2:_n=7}else _n=4;break;case 4:if(at.crossDiffusion)switch(at.numAlgebraicSpecies){case 0:_n=9;break;case 1:_n=10;break;case 2:_n=11;break;case 3:_n=12}else _n=8}}(),xo(),Do(),ji(),Oi(),Po(),qo(),Gi()}function Gi(){let e,t=Vn[_n];const n={U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(at.typesetCustomEqs){let o={};o.U=at.diffusionStr_1_1,o.UU=at.diffusionStr_1_1,o.V=at.diffusionStr_2_2,o.VV=at.diffusionStr_2_2,o.W=at.diffusionStr_3_3,o.WW=at.diffusionStr_3_3,o.Q=at.diffusionStr_4_4,o.QQ=at.diffusionStr_4_4,o.UV=at.diffusionStr_1_2,o.UW=at.diffusionStr_1_3,o.UQ=at.diffusionStr_1_4,o.VU=at.diffusionStr_2_1,o.VW=at.diffusionStr_2_3,o.VQ=at.diffusionStr_2_4,o.WU=at.diffusionStr_3_1,o.WV=at.diffusionStr_3_2,o.WQ=at.diffusionStr_3_4,o.QU=at.diffusionStr_4_1,o.QV=at.diffusionStr_4_2,o.QW=at.diffusionStr_4_3,o.UFUN=at.reactionStr_1,o.VFUN=at.reactionStr_2,o.WFUN=at.reactionStr_3,o.QFUN=at.reactionStr_4,Object.keys(o).forEach((function(e){Ja(o[e])&&(o[e]="0")}));var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!oa(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=Wo(o[e],An,bn,"_(?:[xy][xybf]?)")})),Object.keys(o).forEach((function(e){o[e]=o[e].trim()})),Object.keys(o).forEach((function(e){if(!vn.includes(e)&&o[e].includes(";")){let t=o[e].split(";").filter((e=>e));t.length>1&&at.dimension>1?o[e]="\\dmat{"+t.slice(0,2).join("}{")+"}":o[e]=t[0]}})),Qt.forEach((function(e){o[e]="\\selected{"+o[e]+"}"})),Object.keys(o).forEach((function(e){if(!vn.includes(e)){let i=o[e].includes("\\dmat")?"  ":"[]";t=function(e,t,n,i){null==i&&(i="  ");let o=n.replace(/\s+/g,"  ").trim();return["0","0.0","-0","-0.0","+0","+0.0"].includes(o)?e.replaceAll(t,""):"1"==o||"1.0"==o?e.replaceAll(t,"$2"):"-1"==o||"-1.0"==o?e.replaceAll(t,i[0]+"-"+i[1]+"$2"):e.replaceAll(t,i[0]+n+i[1]+"$2")}(t,n[e],o[e],i)}})),t=Co(t,n.UFUN,o.UFUN),t=Co(t,n.VFUN,o.VFUN),t=Co(t,n.WFUN,o.WFUN),t=Co(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}\(\)]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\(\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"\\lap $1"),e=/\\vnabla\s*\\cdot\s*\(\s*((?!\\vnabla).*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b(?:[xy]|[uvwq](?:_[xy])?|(?:I_[ST][RGBA]?))\b/g.test(t)||t.includes("\\dmat")?e:t.trim()+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])[fb]?2?\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else Qt.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{"+t+" ";return"string"==typeof n&&(i+=n),i+"}"}))})),t=Wo(t,["UFUN","VFUN","WFUN","QFUN"],vn);1==at.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=Wo(t,bn.concat(vn),An.concat(Pn),"_(?:[xy][xybf]?)"),t=zi(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(Mo)}function zi(e){for(e=e.replaceAll(/\[([^\+\/\[\]-]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Hi(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Hi(e,"cos",!0),e=Hi(e,"tan",!0),e=Hi(e,"exp",!0),e=Hi(e,"log",!0),e=Hi(e,"sqrt",!1),e=Hi(e,"sinh",!0),e=Hi(e,"cosh",!0),e=Hi(e,"tanh",!0),e=Hi(e,"max",!0),e=Hi(e,"min",!0),e=Si(e=(e=Hi(e,"ind",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",s="";for(var l=0;l<e.length;l++)t.includes(e[l])?(i+=1,o+=1):n.includes(e[l])&&(i-=1),0==i&&o>0&&(r=e.slice(a,l+1),s+=Yi(r,o),o=0,a=l+1);return s+=e.slice(a),s}(e=me(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")).replaceAll(/<=/g," \\leq ")).replaceAll(/>=/g," \\geq ")).replaceAll(/([<>])/g," $1 ")}function Hi(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,s,l,u,c,d,h=0;for(const f of o){for(a=f.index,r=a+t.length,l=e.slice(r),d=0,u=0,c=!1;d<=l.length&(!c|!(c&&0==u));)u+=["(","["].includes(l[d]),u-=[")","]"].includes(l[d]),c|=u,d+=1;c&&0==u&&(s=d-1+r,i=Zi(i,"\\",a+h),h+=1,n?(i=Zi(i,"{",r+h),h+=1,i=Zi(i,"}",s+1+h),h+=1):(i=Xi(i,"{",r+h),i=Xi(i,"}",s+h)))}return i}function Yi(e,t){const n=["(","["],i=[")","]"];let o=Ji(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=Xi(e,n[o],a),o+=1,o=Ji(o,n.length)):i.includes(e[a])&&(o-=1,o=Ji(o,n.length),e=Xi(e,i[o],a));return e}function Ji(e,t){return(e%t+t)%t}function Xi(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function Zi(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Ki(e){return e=e.replace(/\s+/g,"  ").trim()}function eo(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=hn[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);hn[e]=hn[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),$i(Mt),to(),li(),(Po()||Kt)&&(Kt=!1,qo())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)fn.push(e),hn[e]="",n=Mt.add(hn,e).name(""),Ia(n.domElement.firstChild),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=fn.indexOf(e);let n=Ki(hn[fn.at(t)]);if(""==n);else{let e=eo(fn.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);if(i){let t=i[1];Ga(t),e.lastName=t,mn[t]=e}pn+=1;let o="params"+pn;this.remove(),eo(o,!0),to(),(Po()||Kt)&&(Kt=!1,qo())}}));else{n=Mt.add(hn,e).name(""),Ia(n.domElement.firstChild),n.domElement.classList.add("params");const t=hn[e].match(/\s*(\w+)\s*=/);if(t){let e=t[1];Ga(e),n.lastName=e,mn[e]=n}n.onFinishChange((function(){let t=Ki(hn[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=fn.indexOf(e);fn.splice(t,1),delete hn[e],n.hasOwnProperty("lastName")&&!So(n.lastName)&&delete rt[n.lastName]}else{i();const e=Ro(t).match(/\s*(\w+)\s*=/);if(e){let t=e[1];Ga(t),n.hasOwnProperty("lastName")&&n.lastName!=t&&!So(n.lastName)&&(delete rt[n.lastName],n.lastName=t,mn[t]=n)}}to(),Po()&&qo()}))}return i(),Ia(n.domElement.firstChild),n}function to(){at.kineticParams=Object.values(hn).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function no(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function io(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function oo(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function ao(){if(at.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+jo(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==at.whatToPlot?($("#minLabel").html("$"+An[0]+"$"),$("#midLabel").html("$"+An[1]+"$"),$("#maxLabel").html("$"+An[2]+"$")):Jt?$("#midLabel").html(at.views[at.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+zi(at.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),Eo(),ro()}else $("#colourbar").hide()}function ro(){if("MAX"!=at.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[lo(e,n),lo(t,n)]}(at.minColourValue,at.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=Io(jo(0)),t=Io(jo(.5)),n=Io(jo(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function so(e,t){return e.toPrecision(t)}function lo(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function uo(){at.timeDisplay?($("#timeDisplay").show(),co()):$("#timeDisplay").hide(),mo()}function co(){if(at.timeDisplay){let e=so(rt.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/,"  10<sup>$2$3<sup>"),$("#timeValue").html(e),vo()}}function ho(){if(at.integrate){$("#integralDisplay").show();let e="";1==at.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+zi(at.whatToPlot)+"\\,\\d x",1==at.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();mo()}function fo(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function mo(){at.integrate&&at.timeDisplay?fo("#timeDisplay",10):fo("#timeDisplay",0)}function po(){bo(),Yt&&(!isFinite(sn[0])||Math.abs(sn[0])>1e37||!isFinite(sn[1]))||Math.abs(sn[1])>1e37?(Yt=!1,io("#oops_hit_nan"),pi(),$("#erase").one("pointerdown",(function(){oo("#oops_hit_nan"),Yt=!0,window.clearTimeout(Dt),Dt=setTimeout(po,1e3)}))):Dt=setTimeout(po,1e3)}function go(){if(!$n){try{xe.readRenderTargetPixels(Te,0,0,Tt,At,xn)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}$n=!0}}function bo(){Ye.material=Qe,st.textureSource.value=Te.texture,st.srcResolution.value=new ne.Vector2(Tt,At),st.firstFlag.value=!0;for(const e of Lt)xe.setRenderTarget(e),xe.render(Ye,ye),st.textureSource.value=e.texture,st.srcResolution.value=new ne.Vector2(e.width,e.height),st.firstFlag.value=!1;try{const e=new Float32Array(4);xe.readRenderTargetPixels(Lt.slice(-1)[0],0,0,1,1,e),sn=[e[0],e[1]]}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}}function vo(){if(at.colourbar&&(at.integrate||at.timeDisplay)){let e,t=$("#colourbar")[0].getBoundingClientRect();e=at.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(fo("#dataContainer",40),Zt=!0):Zt&&(fo("#dataContainer",0),Zt=!1)}}function wo(){_o()?(It.forEach((e=>{e.texture.magFilter=ne.NearestFilter})),Te.texture.magFilter=ne.NearestFilter,Ae.texture.magFilter=ne.NearestFilter):(It.forEach((e=>{e.texture.magFilter=ne.LinearFilter})),Te.texture.magFilter=ne.LinearFilter,Ae.texture.magFilter=ne.LinearFilter),Oi()}function _o(){return we||at.forceManualInterpolation}function yo(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function So(e,t){return null==t&&(t=[]),function(e){return[...(p()+D()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e).concat(["I_T","I_TR","I_TG","I_TB","I_TA","I_S","I_SR","I_SG","I_SB","I_SA"])}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function Co(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function xo(){"line"==at.plotType?(Go(),at.brushType="vline",ai(),$i(dt),He.visible=!1,Xe.visible=!0,at.contours=!1,at.emboss=!1,at.vectorField=!1,ja()):(He.visible=!0,Xe.visible=!1,"surface"==at.plotType?($("#simCanvas").css("outline","2px #000 solid"),ln&&(ln=!1,Yn()),at.vectorField=!1,ja()):$("#simCanvas").css("outline","")),Ze.visible=at.overlay&&"line"==at.plotType,ri(),Jn(),Oi(),Ya()}function Do(){Gt||(1!=at.dimension&&"line"==at.plotType&&(at.plotType="plane",ca("plotType"),xo()),1==at.dimension&&"line"!=at.plotType&&(at.plotType="line",at.vectorField=!1,ca("plotType"),xo())),1==at.dimension&&(at.minY="0.0"),Hn(),Ci(),Gi(),Oi(),ho()}function Fo(){const e="line"==at.plotType?0:at.cameraTheta,t="line"==at.plotType?0:at.cameraPhi,n=(new ne.Vector3).setFromSphericalCoords(1,Math.PI/2-e*Math.PI/180,-t*Math.PI/180);_e.position.set(n.x,n.y,n.z),_e.lookAt(0,0,0)}function Eo(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function $o(){return at.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function To(e){return Ro(e)}function Ao(){const e=/^\s*([a-zA-Z]\w*)\b/;let t=[];return $o().split(";").filter((e=>e.length>0)).forEach((function(n){n.match(e)&&t.push(n.match(e)[1].trim())})),t}function Po(){$o().split(";").filter((e=>e.length>0));const e=function(e){let t={},n={},i=[];const o=function(){const e=/^\s*([a-zA-Z]\w*)\b\s*=\s*(.*)/;let t=[];return $o().split(";").filter((e=>e.length>0)).forEach((function(n){const i=n.match(e);i?t.push([i[1].trim(),i[2].trim()]):ia("Unable to evaluate the parameter definition '"+n+"'. Please check for syntax errors.")})),t}(),a=o.map((e=>e[0]));o.forEach((e=>t[e[0]]=e[1]));for(const e of o){let[o,r]=e;o in n||([n,,i]=ko(o,t,n,[o],a,[]))}i.length>0&&ia("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.");return Object.keys(n).map((e=>[e,n[e]]))}(),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}(Ao());if(t.length>0)return ia("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=Uo(t[0],t[1]);n|=e,i|=o}return n&&!i}function Uo(e,t){let n=!1,i=!1;const o=To(e);return So(o)?(ia("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!rt.hasOwnProperty(o),rt[o]={type:"float",value:t}),[n,i]}function Vo(){return To(Ao().map((e=>"uniform float "+e+";")).join("\n"))}function ko(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const s of o)r=new RegExp("\\b"+s+"\\b","g"),r.test(t[e])&&(i.includes(s)?(n[s]=0,t[s]="0",t[e]="0",a.push(i.slice(i.indexOf(s)))):([n,,a]=ko(s,t,n,[...i,s],o,a),t[e]=t[e].replaceAll(r,n[s].toString())));try{n[e]=Rn.evaluate(t[e])}catch(t){ia("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function qo(){Ci(),qi(),ai(),Li(),oi(),Bi()}function Ro(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+Tn[e])););return n}function Mo(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function Io(e){return e.reduce(((e,t)=>e+t),0)/3}function Lo(){bo(),at.minColourValue=sn[0],at.maxColourValue=sn[1],rt.maxColourValue.value=at.maxColourValue,rt.minColourValue.value=at.minColourValue,Wt.maxColourValue.updateDisplay(),Wt.minColourValue.updateDisplay(),ro()}function No(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function Bo(){let e;null!=An&&(e=An);const t=at.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,bn.length),n=t.concat(wn.slice(t.length)),i=Ao();let o;for(var a=0;a<n.length;a++)if(So(n[a],i))return o=i.includes(n[a])?"as a parameter":"under the hood",void ia("The name '"+n[a]+"' is used "+o+", so can't be used as a species name. Please use a different name for "+n[a]+".");An=n,Pn=An.map((e=>"f_{"+e+"}")),function(){Un=[];for(let e=0;e<An.length;e++)Un.push("(?:"+An.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let r={...de(),...fe()};if(Object.keys(r).forEach((function(e){kn[e]=zi(Wo(r[e],bn,An,"_(?:[xy][xybf]?)"))})),r=he(),Object.keys(r).forEach((function(e){kn[e]=zi(Wo(r[e],vn,Pn))})),Gt)return;const s=["initCond_1","initCond_2","initCond_3","initCond_4","kineticParams"];Object.keys(at).forEach((function(t){In.includes(t)&&(s.includes(t)||(at[t]=Wo(at[t],e,An,"_(?:[xy][xybf]?)")))})),at.views=at.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){In.includes(i)&&(n[i]=Wo(t[i],e,An,"_(?:[xy][xybf]?)"))})),n})),Object.keys(ut).forEach((function(t){In.includes(t)&&(s.includes(t)||(ut[t]=Wo(ut[t],e,An,"_(?:[xy][xybf]?)")))})),ut.views=ut.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){In.includes(i)&&(n[i]=Wo(t[i],e,An,"_(?:[xy][xybf]?)"))})),n})),ji(),Oi(),qo(),Gi()}function Wo(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function Oo(e,t){let n,i=e.geometry.attributes.instanceStart,o=e.geometry.attributes.instanceEnd;for(let e=0;e<t.length;e++)n=t[e].toArray(),n[1]*=at.threeDHeightScale*Ut/Vt,e<t.length&&i.setXYZ(e,n[0],n[1],0),e>0&&o.setXYZ(e-1,n[0],n[1],0);i.needsUpdate=!0,o.needsUpdate=!0}function jo(e){e=e.clamp(0,1);let t=0;for(;e>=ot[t+1]&&t<it.length-2;)t+=1;return ot[t+1]==ot[t]?it[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=Qo(e[o],t[o],n);return i}(it[t],it[t+1],(e-ot[t])/(ot[t+1]-ot[t])).map((e=>e.clamp(0,1)))}function Qo(e,t,n){return(1-(n=n.clamp(0,1)))*e+n*t}function Go(){Ne.linewidth=.01*at.lineWidthMul,Be.linewidth=.01*at.overlayLineWidthMul,Ne.needsUpdate=!0,Be.needsUpdate=!0}function zo(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function Ho(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function Yo(e){e.forEach((function(e){Qt.add(e)})),Gi()}function Jo(e){e.forEach((function(e){Qt.delete(e)})),Gi()}function Xo(){Dn=new Float32Array(Tt*At*4),xe.readRenderTargetPixels(It[1],0,0,Tt,At,Dn),ta(Dn),tn=!0}function Zo(){tn||Xo();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([Tt,At]),Dn])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function Ko(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);ta(e.slice(2),e.slice(0,2)),ea(Ue),tn=!0,bi()},t.readAsArrayBuffer(e)}function ea(e){if(null!=e)if("crop"==at.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=De/t;i>1&&(n=t/De,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function ta(e,t){null!=Ue&&Ue.dispose(),null==t&&(t=[Tt,At]),Ue=new ne.DataTexture(e,t[0],t[1],ne.RGBAFormat,ne.FloatType),Ue.needsUpdate=!0,Ue.magFilter=we?ne.NearestFilter:ne.LinearFilter,null!=je&&(je.map=Ue,je.needsUpdate)}function na(){xe.setSize(Math.round(devicePixelRatio*qt),Math.round(devicePixelRatio*Rt),!1)}function ia(e){pi(),Gt&&zt||(zt=!0,$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),io("#error")))}function oa(e){if(/\(\s*\)/.test(e))return ia("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(ia("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(ia("A binary operator is missing an operand in "+e.trim()+"."),!1)}function aa(){let e;$("#views_list").empty();for(let t=0;t<at.views.length;t++)e=document.createElement("a"),e.onclick=function(){at.activeViewInd=t,ra(at.views[t])},e.innerHTML="<div class='view_label'>"+at.views[t].name+"</div>",t==at.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);nn=Math.max(at.views.length,nn),at.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),at.views.length}function ra(e,t){Object.assign(at,e),delete at.name,$i(ht),(null==t||t)&&(Li(),xo(),ri(),Xn(),ro(),ao(),ja(),Va(),li())}function sa(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",at.views[at.activeViewInd].name);null!=e&&(at.views[at.activeViewInd].name=e,aa(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function la(){at.views.length>1?(at.views.splice(at.activeViewInd,1),at.activeViewInd<1?at.activeViewInd=0:at.activeViewInd-=1):at.views[at.activeViewInd].name="Custom",ra(at.views[at.activeViewInd])}function ua(){let e={};return qn.forEach((function(t){e[t]=at[t]})),e}function ca(e){at.activeViewInd<at.views.length&&(at.views[at.activeViewInd][e]=at[e])}function da(e,t){let n="";return n+=Pi(b(t),An[e]),at.dimension>1&&(n+=Pi(v(t),An[e])),n}function ha(e,t){let n="";return n+=Pi(_(t),An[e]),at.dimension>1&&(n+=Pi(y(t),An[e])),n}function fa(e,t){let n="";return n+=Pi(S(t,yi(at.domainIndicatorFun)),An[e]),at.dimension>1&&(n+=Pi(C(t,yi(at.domainIndicatorFun)),An[e])),n}function ma(e,t){let n="";return n+=Pi(b(t).replaceAll(/updated/g,"gl_FragColor"),An[e]),at.dimension>1&&(n+=Pi(v(t).replaceAll(/updated/g,"gl_FragColor"),An[e])),n}function pa(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function ga(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function ba(e,t,n,i,o,a,r,s,l){const u=document.createElement("a");if(null==l&&(l=at),u.obj=l,u.classList.add("toggle_button"),u.setAttribute("property",t),null==i&&(i=()=>{}),u.onclick=function(){u.obj[u.getAttribute("property")]=!u.obj[u.getAttribute("property")],Ma(u),i()},null!=o&&(u.id=o),null!=a&&(u.title=a),null!=n&&(u.innerHTML=n),null!=r&&u.setAttribute("folderID",r),null!=s)for(const e of s)u.classList.add(e);return e.appendChild(u),Ma(u),u}function va(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function wa(){const e=Object.assign(H("default"),H(at.parent));let t=Ni(at,e);1==at.views.length&&"1"==at.views[0].name&&delete t.views;for(const e of Object.keys(at.views[0]))at.hasOwnProperty(e)&&at.views.map((t=>t[e])).every((t=>t==at[e]))&&at.views.forEach((t=>delete t[e]));t.preset="PRESETNAME";let n=JSON.stringify(t).replaceAll(/(:[^:]*),/g,"$1,\n\t").replaceAll(":",": ").replaceAll("  "," ").replaceAll("{","{\n\t").replaceAll("}",",\n}");n='listOfPresets["PRESETNAME"] = '+n+";\n",Ta(n)}function _a(){let e="";e+=JSON.stringify(at),e+=JSON.stringify(rt),e+=JSON.stringify({nXDisc:Tt,nYDisc:At,domainHeight:Ut,domainWidth:Pt,aspectRatio:De,canvas:be.getBoundingClientRect()}),Ta(e)}function ya(){at.showStats?Mn.domElement.style.visibility="":Mn.domElement.style.visibility="hidden"}function Sa(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function Ca(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function xa(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function Da(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function Fa(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function Ea(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function $a(){let e=Ni(at,H("default"));return e.preset="Custom",e=se(e),[location.href.replace(location.search,""),"?options=",ue.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function Ta(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{ia("For some reason, we couldn't copy to your device's clipboard. You might not be using HTTPS or there's something wrong on our end - sorry!")}))}function Aa(e){const t=mn[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function Pa(){rt.embossAmbient.value=at.embossAmbient,rt.embossDiffuse.value=at.embossDiffuse,rt.embossShiny.value=at.embossShiny,rt.embossSmoothness.value=at.embossSmoothness,rt.embossSpecular.value=at.embossSpecular,rt.embossLightDir.value=new ne.Vector3(Math.sin(at.embossTheta)*Math.cos(at.embossPhi),Math.sin(at.embossTheta)*Math.sin(at.embossPhi),Math.cos(at.embossTheta))}function Ua(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function Va(){for(const e of[...jt,...Ot]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function ka(){rt.contourColour.value=new ne.Color(at.contourColour),rt.contourEpsilon.value=at.contourEpsilon,rt.contourStep.value=1/(at.contourNum+1)}function qa(){rt.overlayColour.value=new ne.Color(at.overlayColour),rt.overlayEpsilon.value=at.overlayEpsilon,rt.overlayLine.value=at.overlay&&"line"==at.plotType,Be.color=new ne.Color(at.overlayColour),Be.needsUpdate=!0}function Ra(){on=0,yt||li()}function Ma(e){e.obj[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function Ia(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function La(){at.customSurface?ke.vertexShader=j():ke.vertexShader=O(),ke.needsUpdate=!0}function Na(){"surface"==at.plotType?($(mt).show(),at.customSurface?(Wt.surfaceFun.show(),Wt.threeDHeightScale.hide()):(Wt.surfaceFun.hide(),Wt.threeDHeightScale.show())):($(mt).hide(),Wt.surfaceFun.hide())}function Ba(){nt=new ne.Group,Se.add(nt);const e=Math.max(Tt,At),t=Math.round(Qo(3,window.width<629?20:64,at.arrowDensity));let n=Math.max(Math.floor(e/t),1);const i=Math.floor(Tt/n),o=Math.floor(At/n),a=Math.floor((Tt-n*(i-1))/2),r=Math.floor((At-n*(o-1))/2);let s,l,u,c,d,h;for(let e=0;e<o;e++){l=r+e*n,h=((l+.5)/At-.5)*He.geometry.parameters.height;for(let e=0;e<i;e++)u=a+e*n,d=((u+.5)/Tt-.5)*He.geometry.parameters.width,s=u+l*Tt,c=Wa([d,h,1],[0,0,0]),c.ind=s,nt.add(c)}}function Wa(e,t){const n=new ne.Group,i=new ne.Mesh(Ge,We);i.rotation.x=Math.PI/2;const o=new ne.Mesh(ze,We);return o.rotation.x=Math.PI/2,o.rotation.y=Math.PI/4,o.position.z=Ge.parameters.height/2,n.add(i),n.add(o),n.scale.multiplyScalar(dn),n.position.set(e[0],e[1],e[2]),n.lookAt(e[0]+t[0],e[1]+t[1],e[2]+t[2]),n}function Oa(){if(nt)for(Se.remove(nt);nt.children.length;)nt.remove(nt.children[0])}function ja(){if(rt.vectorField.value=at.vectorField,at.vectorField){if(Oa(),Ba(),Qa(),"relative"==at.arrowScale)try{nt.customMax=Rn.evaluate(at.arrowLengthMax)}catch(e){ia("Unable to evaluate the maximum arrow length. Please check the definition."),nt.customMax=1}}else Oa()}function Qa(){We.color=new ne.Color(at.arrowColour)}function Ga(e){const t=So(e,An.concat(Pn));return t&&ia("The name '"+e+"' is already in use, so can't be used as a parameter name. Please use a different name for "+e+"."),!t}function za(e){return e=(e=e.replaceAll(/\bMINX\b/g,(()=>yi(at.minX)))).replaceAll(/\bMINY\b/g,(()=>yi(at.minY)))}function Ha(e,t,n,i,o){if(e in t)return[t,n.slice(0,-1),o];for(const a of i[e])n.includes(a)?o.push(n.slice(n.indexOf(a))):[t,,o]=Ha(a,t,[...n,a],i,o);return t[e]=!0,[t,n.slice(0,-1),o]}function Ya(){if($("#simCanvas").css("cursor","auto"),at.brushEnabled&&"surface"!=at.plotType&&"line"!=at.plotType)switch(at.brushType){case"circle":$("#simCanvas").css("cursor","url('images/cursor-circle.svg') 12 12, auto");break;case"hline":$("#simCanvas").css("cursor","url('images/cursor-hline.svg') 32 32, auto");break;case"vline":$("#simCanvas").css("cursor","url('images/cursor-vline.svg') 32 32, auto")}}function Ja(e){return/^\s*$/.test(e)}function Xa(){const e=Shepherd.activeTour?.getCurrentStep(),t=e?.getElement(),n=t?.querySelector(".shepherd-header"),i=document.createElement("span");i.classList.add("shepherd-progress"),i.innerText=`${Shepherd.activeTour?.steps.indexOf(e)+1} / ${Shepherd.activeTour?.steps.length}`,n?.insertBefore(i,t.querySelector(".shepherd-cancel-icon"))}function Za(e,t){const n=Shepherd.activeTour?.getCurrentStep(),i=n?.getElement(),o=i?.querySelector(".shepherd-footer"),a=document.createElement("a");a.setAttribute("href",e),a.setAttribute("target","_blank"),a.classList.add("shepherd-more-info"),a.innerText=t||"More info.",o?.insertBefore(a,o.firstChild)}(no()||On||at.forceTryClickingPopup)&&!at.suppressTryClickingPopup&&at.brushEnabled&&($("#top_message").html("<p>"+at.tryClickingText+"</p>"),io("#top_message"),setTimeout((()=>oo("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>oo("#top_message")))),Gt=!1,function e(){at.showStats&&Mn.begin();Ct=St,St&&at.brushEnabled&&function(){!at.setSeed&&at.brushValue.includes("RAND")&&ki();Ye.material=qe;for(let e=1;e<It.length;e++)rt.textureSource.value=It[e].texture,xe.setRenderTarget(It[e-1]),xe.render(Ce,ye);It.rotate(-1)}();if(yt){!xt||function(){Ye.material=Re;for(let e=1;e<It.length;e++)rt.textureSource.value=It[e].texture,xe.setRenderTarget(It[e-1]),xe.render(Ce,ye);It.rotate(-1)}();for(let e=0;e<at.numTimestepsPerFrame;e++){if(at.autoPause&&Ht&&rt.t.value>=at.autoPauseAt){Ht=!1,pi();break}Xt&&!at.setSeed&&ki(),si()}}(Ct||yt)&&li();at.showStats&&Mn.end();requestAnimationFrame(e)}()}();