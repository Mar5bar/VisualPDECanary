import{drawShaderTop as e,drawShaderBotReplace as t,drawShaderBotAdd as n,drawShaderShapeDisc as i,drawShaderShapeVLine as o,drawShaderShapeHLine as a,drawShaderFactorSharp as r,drawShaderFactorSmooth as s}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as l,computeDisplayFunShaderMid as u,postGenericShaderBot as c,postShaderDomainIndicator as d,interpolationShader as h}from"./post_shaders.js";import{copyShader as f}from"../copy_shader.js";import{RDShaderTop as m,RDShaderBot as p,RDShaderDirichletX as g,RDShaderDirichletY as b,RDShaderDirichletIndicatorFun as v,RDShaderRobinX as w,RDShaderRobinY as _,RDShaderRobinCustomDomainX as y,RDShaderRobinCustomDomainY as S,RDShaderUpdateNormal as C,RDShaderUpdateCross as D,RDShaderAlgebraicSpecies as x,RDShaderEnforceDirichletTop as F,RDShaderAdvectionPreBC as E,RDShaderAdvectionPostBC as T,RDShaderDiffusionPreBC as A,RDShaderDiffusionPostBC as V,RDShaderGhostX as P,RDShaderGhostY as U,RDShaderMain as k}from"./simulation_shaders.js";import{randShader as q,randNShader as M}from"../rand_shader.js";import{fiveColourDisplayTop as R,fiveColourDisplayBot as I,embossShader as L,contourShader as N,surfaceVertexShaderColour as B,surfaceVertexShaderCustom as O,overlayShader as W}from"./display_shaders.js";import{getColours as j}from"../colourmaps.js";import{genericVertexShader as Q}from"../generic_shaders.js";import{getPreset as z,getUserTextFields as G,getFieldsInView as H,getListOfPresets as Y,getOldPresetFieldsToNew as J}from"./presets.js";import{clearShaderBot as X,clearShaderTop as Z}from"./clear_shader.js";import*as K from"../three.module.min.js";import{OrbitControls as ee}from"../OrbitControls.js";import{Line2 as te}from"../lines/Line2.js";import{LineMaterial as ne}from"../lines/LineMaterial.js";import{LineGeometry as ie}from"../lines/LineGeometry.js";import{minifyPreset as oe,maxifyPreset as ae}from"./minify_preset.js";import{LZString as re}from"../lz-string.min.js";import{equationTEXFun as se,getDefaultTeXLabelsDiffusion as le,getDefaultTeXLabelsReaction as ue,getDefaultTeXLabelsBCsICs as ce,substituteGreek as de}from"./TEX.js";!async function(){let he,fe,me,pe,ge,be,ve,we,_e,ye,Se,Ce,De,xe,Fe,Ee,$e,Te,Ae,Ve,Pe,Ue,ke,qe,Me,Re,Ie,Le,Ne,Be,Oe,We,je,Qe,ze,Ge,He,Ye,Je,Xe,Ze,Ke,et,tt,nt,it,ot,at,rt,st,lt,ut,ct,dt,ht,ft,mt,pt,gt,bt,vt,wt,_t,yt,St,Ct,Dt,xt,Ft,Et,$t,Tt,At,Vt=[],Pt={},Ut=[],kt=[],qt=[],Mt=new Set,Rt=!0,It=!1,Lt=!0,Nt=!0,Bt=!1,Ot=!1,Wt=!1,jt=!1,Qt=!1,zt=!1,Gt=0,Ht=performance.now(),Yt=!1,Jt=!0,Xt=1,Zt=1,Kt=.15,en={},tn=[],nn={},on=0;const an=["u","v","w","q"],rn=["UFUN","VFUN","WFUN","QFUN"],sn=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"];let ln,un,cn,dn,hn,fn,mn,pn=!1,gn=!1;const bn=["zero","one","two","three","four","five","six","seven","eight","nine"];let vn,wn,_n,yn=se(),Sn={...le(),...ue(),...ce()};const Cn=H();let Dn=new exprEval.Parser;Dn.consts.pi=Math.PI,Dn.consts.Pi=Math.PI,Dn.consts.e=Math.exp(1),Ke={};const xn=G();var Fn,En;tt={reset:function(){ii()},toggleRunning:function(){mt?ti():ni()},copyConfigAsURL:function(){fa(ha())},saveSimState:function(){Mo()},exportSimState:function(){Ro()},clearCheckpoints:function(){zt&&(Ee.dispose(),Ee=null,zt=!1)}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(Fn=Array.prototype.push,En=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,Fn.apply(this,En.call(this,0,e)),this}),he=document.getElementById("simCanvas"),console.error=function(e){jt=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),Oo(t.toString().trim()+". Click <a href='/user-guide/FAQ#undeclared' target='blank'>here</a> for more information.")},Oi()||$("#logo").hide();const $n=new URLSearchParams(window.location.search);$n.has("no_ui")?($(".ui").addClass("hidden"),Qt=!0):$(".ui").removeClass("hidden"),$n.has("logo_only")&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),Qt=!0),$n.has("sf")&&(Zt=parseFloat($n.get("sf")),(isNaN(Zt)||Zt<=0)&&(Zt=1)),hi("default"),function(){et={brushCoords:{type:"v2",value:new K.Vector2(.5,.5)},colour1:{type:"v4",value:new K.Vector4(0,0,0,0)},colour2:{type:"v4",value:new K.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new K.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new K.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new K.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},overlayLine:{type:"bool",value:!0},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},vectorField:{type:"bool",value:!1}},pt=!1,Se=new K.Raycaster,Ce=new K.Vector2,we=new K.WebGLRenderer({canvas:he,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),we.autoClear=!0,fe=we.getContext(),Et=fe.getParameter(fe.MAX_TEXTURE_SIZE),me=!(fe.getExtension("OES_texture_float_linear")&&fe.getExtension("EXT_float_blend")),Fe={format:K.RGBAFormat,type:K.FloatType,minFilter:K.NearestFilter},me|=/android/i.test(navigator.userAgent),Fe.magFilter=me?K.NearestFilter:K.LinearFilter,Vt.push(new K.WebGLRenderTarget(Ke.maxDisc,Ke.maxDisc,Fe)),Vt.push(Vt[0].clone()),Vt.push(Vt[0].clone()),Vt.push(Vt[0].clone()),Vt.push(Vt[0].clone()),De=Vt[0].clone(),xe=Vt[0].clone(),Vt.forEach((e=>{e.texture.wrapS=K.RepeatWrapping,e.texture.wrapT=K.RepeatWrapping})),De.texture.wrapS=K.ClampToEdgeWrapping,De.texture.wrapT=K.ClampToEdgeWrapping,xe.texture.wrapS=K.ClampToEdgeWrapping,xe.texture.wrapT=K.ClampToEdgeWrapping,pe=new K.OrthographicCamera(-.5,.5,.5,-.5,-1,10),ye=new ee(pe,he),ye.listenToKeyEvents(document),ye.addEventListener("change",(function(){"surface"==Ke.plotType&&(Ke.cameraTheta=90-180*Math.acos(pe.position.y)/Math.PI,Ke.cameraPhi=-180*Math.atan2(pe.position.x,pe.position.z)/Math.PI,Ke.cameraZoom=pe.zoom,Yo("cameraTheta"),Yo("cameraPhi"),Yo("cameraZoom"),fi(at),_a())})),ge=new K.OrthographicCamera(-.5,.5,.5,-.5,-1,10),ge.position.z=1,be=new K.Scene,ve=new K.Scene,be.add(pe),be.background=new K.Color(Ke.backgroundColour),$e=new K.MeshBasicMaterial({side:K.DoubleSide}),Te=new K.ShaderMaterial({uniforms:et,vertexShader:Q(),transparent:!0,side:K.DoubleSide}),ke=new K.ShaderMaterial({uniforms:et,vertexShader:Q()}),Ie=new K.ShaderMaterial({uniforms:et,vertexShader:Q(),fragmentShader:h()}),Ae=new K.ShaderMaterial({uniforms:et,vertexShader:Q()}),Pt.FE=new K.ShaderMaterial({uniforms:et,vertexShader:Q()}),Pt.AB2=new K.ShaderMaterial({uniforms:et,vertexShader:Q()});for(let e=1;e<3;e++)Pt["Mid"+e.toString()]=new K.ShaderMaterial({uniforms:et,vertexShader:Q()});for(let e=1;e<5;e++)Pt["RK4"+e.toString()]=new K.ShaderMaterial({uniforms:et,vertexShader:Q()});Ue=new K.ShaderMaterial({uniforms:et,vertexShader:Q(),fragmentShader:f()}),Pe=new K.ShaderMaterial({uniforms:et,vertexShader:Q()}),Ve=new K.ShaderMaterial({uniforms:et,vertexShader:Q()}),qe=new ne({vertexColors:!0,linewidth:.01}),Me=new ne({color:0,linewidth:.01}),Re=new K.MeshBasicMaterial({color:Ke.arrowColour,side:K.DoubleSide}),Le=new K.MeshBasicMaterial,Ne=new K.CylinderGeometry(.008,.008,.1),Be=new K.ConeGeometry(.04,.04,4);const e=new K.PlaneGeometry(1,1);We=new K.Mesh(e,Pt[0]),We.position.z=0,We.matrixWorldAutoUpdate=!1,ve.add(We),Ln(),Nn(),Mn(),On(),kn(),Wn(),Ti(),Vi(),Qn(),jn(),_i(),io(),ii(),he.addEventListener("pointerdown",Jn),he.addEventListener("pointerup",Xn),he.addEventListener("pointermove",Zn),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(tt.toggleRunning(),e.preventDefault()),"h"===e.key&&(Qt?(Qt=!1,$(".ui").removeClass("hidden"),dt.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",_t),mt?ni():ti(),no(),ho(),So()):(Qt=!0,$(".ui").addClass("hidden"))),"s"==e.key&&Mo(),"c"==e.key&&(Ke.resetFromCheckpoints=!Ke.resetFromCheckpoints,ya($("#checkpointButton")[0])))})),window.addEventListener("resize",(function(){kn(),_a()}),!1),window.addEventListener("message",ma),$("#checkpointInput").change((function(){Io(this.files[0]),this.value=null}))}();let Tn=!0;if($n.has("preset")&&(di($n.get("preset")),Tn=!1),$n.has("options")){var An=JSON.parse(re.decompressFromEncodedURIComponent($n.get("options")));An.hasOwnProperty("p")&&(An=ae(An)),di(An),Tn=!1}Tn&&di("GrayScott"),Bt=$n.has("story"),Bt&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),dt.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),Qi(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#play_pause_placeholder").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),_t=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),$("#settings").click((function(){ra(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&ua(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&ca(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&sa(),$("#views_ui").is(":visible")&&la()),$("#left_ui").is(":visible")&&So()})),$("#equations").click((function(){sa(),So(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&ra(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&la()})),$("#pause").click((function(){ti()})),$("#play").click((function(){ni()})),$("#erase").click((function(){ii()})),$("#share").click((function(){ca(),$("#help_panel").is(":visible")&&ua()})),$("#help").click((function(){ua(),$("#share_panel").is(":visible")&&ca()})),$("#screenshot").click((function(){pn=!0,Hn(),ca()})),$("#link").click((function(){tt.copyConfigAsURL(),ca()})),$("#embed").click((function(){!function(){let e=ha();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}fa('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),ca()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){ua()})),$("#views").click((function(){la(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&ra(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&sa()})),$("#error_close_button").click((function(){ji("#error")})),$("#oops_hit_nan_close").click((function(){ji("#oops_hit_nan"),Nt=!0})),$("#start_tour").click((function(){$("#welcome").css("display","none"),Vn.start()})),$(document).on("click","#add_view",(function(){!function(){let e=Ho();e.name=++Gt,Ke.views.push(e),Ke.activeViewInd=Ke.views.length-1,jo()}()}));const Vn=new Shepherd.Tour({useModalOverlay:!0,defaultStepOptions:{classes:"shadow-md bg-purple-dark",scrollTo:!1,cancelIcon:{enabled:!0},buttons:[{action(){return this.back()},classes:"shepherd-button-secondary",text:"Back"},{action(){return this.next()},text:"Next"}],when:{show(){qa()}}}});let Pn="Interactivity is at the heart of VisualPDE. In most simulations, clicking on the screen allows you to interact directly with the solution.<br><video autoplay loop playsinline width=\"128\" style=\"margin-top:10px\"><source src='../assets/ani/click.mp4' type='video/mp4'><source src='../assets/ani/click.webm' type='video/webm'></video><br>This can even kick-start pattern formation or other exciting phenomena.";da()&&(Pn=Pn.replaceAll("clicking","tapping")),Vn.addStep({title:"Playing with PDEs",text:Pn,buttons:[{action(){return this.next()},text:"Next"}]}),Vn.addStep({title:"Equations and definitions",text:"View and customise the equations, parameters, boundary and initial conditions of the simulation.",attachTo:{element:"#equations",on:"right"},when:{show(){qa(),Ma("/user-guide/advanced-options.html#equations")}}}),Vn.addStep({title:"Play/pause",text:"Play and pause the simulation. You can still draw when paused.",attachTo:{element:"#play_pause_placeholder",on:"right"}}),Vn.addStep({title:"Reset",text:"Restart the simulation from the specified initial conditions (editable in the Equations menu).",attachTo:{element:"#erase",on:"right"},when:{show(){qa(),Ma("/user-guide/advanced-options.html#checkpoints","Advanced use")}}}),Vn.addStep({title:"Views",text:"There are countless ways to visualise solutions in VisualPDE. The Views menu lets you customise every last detail, from contours to colour schemes.",attachTo:{element:"#views",on:"right"},when:{show(){qa(),Ma("/user-guide/advanced-options.html#views")}}}),Vn.addStep({title:"Settings",text:"Tweak advanced settings such as the equation type, the domain resolution and the timestepping scheme.",attachTo:{element:"#settings",on:"right"},when:{show(){qa(),Ma("/user-guide/advanced-options.html#settings")}}}),Vn.addStep({title:"Sharing",text:"VisualPDE is built for sharing. Copy a link to your clipboard that leads straight to the current simulation, download snapshots of your solution and even embed your simulation in your own site.",attachTo:{element:"#share",on:"right"}}),Vn.addStep({title:"Help",text:"Access FAQs, detailed documentation and guides explaining how to do everything that's possible in VisualPDE. You can even restart this tour.",attachTo:{element:"#help",on:"right"},buttons:[{action(){return this.back()},classes:"shepherd-button-secondary",text:"Back"},{action(){return this.complete()},text:"Finish"}]});const Un=!(Bt||Qt);if((!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("visited"==e[t].split("=")[0].trim())return!0}return!1}()||Un&&!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("seenFullWelcome"==e[t].split("=")[0].trim())return!0}return!1}())&&"Banner"!=Ke.preset){let e=mt;ti();let t="welcome_no";Un||($("#tour_question").hide(),$("#lets_go_cont").show(),t="lets_go"),$("#welcome").css("display","block");const n=await Promise.race([ao(document.getElementById("welcome_ok"),"click",!0),ao(document.getElementById(t),"click",!1)]);$("#welcome").css("display","none"),function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="visited=true;"+t+";path=/"}(),Un&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="seenFullWelcome=true;"+t+";path=/"}(),n&&await new Promise((function(e){["complete","cancel"].forEach((function(t){Shepherd.once(t,(()=>e()))})),Vn.start()})),$("#help").is(":visible")&&($("#get_help").fadeIn(1e3),setTimeout((()=>$("#get_help").fadeOut(1e3)),4e3)),e&&ni()}function kn(){Ln(),function(){We.material=Ue;for(let e=1;e<Vt.length;e++)et.textureSource.value=Vt[e].texture,Vt[e-1].setSize(St,Ct),we.setRenderTarget(Vt[e-1]),we.render(ve,ge);Vt.rotate(-1),Vt[0].dispose(),Vt[0]=Vt[1].clone(),De.setSize(St,Ct),Yn(),xe.setSize(Math.round(devicePixelRatio*$t),Math.round(devicePixelRatio*Tt))}(),Lo(Ee),Rn(),qn(),$a(),Mn(),ho(),So()}function qn(){Oe.geometry.dispose(),be.remove(Oe),je.geometry.dispose(),be.remove(je),Qe.geometry.dispose(),be.remove(Qe),ze.geometry.dispose(),be.remove(ze),Nn()}function Mn(){switch(In(),Ke.plotType){case"line":ye.enabled=!1,pe.zoom=1,co(),Te.vertexShader=B();break;case"plane":ye.enabled=!1,ye.reset(),Te.vertexShader=Q();break;case"surface":ye.enabled=!0,pe.zoom=Ke.cameraZoom,co(),Ca()}Te.needsUpdate=!0,pe.left=-Dt/(2*Ft),pe.right=Dt/(2*Ft),pe.top=xt/(2*Ft),pe.bottom=-xt/(2*Ft),pe.updateProjectionMatrix(),Bn()}function Rn(){et.L.value=Xt,et.L_y.value=xt,et.L_x.value=Dt,et.L_min.value=Math.min(xt,Dt),et.dt.value=Ke.dt,et.dx.value=yt,et.dy.value=yt,et.heightScale.value=Ke.threeDHeightScale,et.maxColourValue.value=Ke.maxColourValue,et.minColourValue.value=Ke.minColourValue,et.customSurface.value=Ke.customSurface,et.vectorField.value=Ke.vectorField,pa(),wi()}function In(){try{Xt=Dn.evaluate(Ke.domainScale)}catch(e){Oo("Unable to evaluate the domain length. Please check the definition."),Xt=100}$t=Math.round(he.getBoundingClientRect().width),Tt=Math.round(he.getBoundingClientRect().height),_e=Tt/$t,_e<=0&&(_e=.1),_e>=1?(xt=Xt,Dt=xt/_e):(Dt=Xt,xt=Dt*_e),1==Ke.dimension&&(Dt=Xt),et.L_x.value=Dt,et.L_y.value=xt,Ft=Math.max(Dt,xt)}function Ln(){In(),yt=Xt/100;try{yt=Dn.evaluate(Ke.spatialStep)}catch(e){Oo("Unable to evaluate the spatial step. Please check the definition.")}yt<=0&&(Oo("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),yt=Xt/100),St=Math.floor(Dt/yt),Ct=Math.floor(xt/yt),(St>Et||Ct>Et)&&(Oo("Your device does not support a discretisation this fine (maximum "+Et+"). Please increase the space step to at least "+(Math.ceil(1e4*Xt/Et)/1e4).toPrecision(4)+" or reduce the domain size to at most "+(Math.floor(1e4*Et*yt)/1e4).toPrecision(4)+"."),St=Math.min(St,Et),Ct=Math.min(Ct,Et)),0==St&&(St=1),0==Ct&&(Ct=1),1==Ke.dimension&&(Ct=1),et.nXDisc.value=St,et.nYDisc.value=Ct,Ge=new Array(St),He=new Array(St);let e=-.5,t=St>1?1/(St-1):.5;for(let n=0;n<Ge.length;n++)Ge[n]=e,e+=t;Ge=Ge.map((e=>e*Dt/Ft)),Bo(),hn=new Float32Array(St*Ct*4),gn=!1}function Nn(){In();let e=[1,1];Jt||(e=[St,Ct]);const t=new K.PlaneGeometry(Dt/Ft,xt/Ft,e[0],e[1]);Oe=new K.Mesh(t,Te),Oe.position.z=0,Oe.visible="line"!=Ke.plotType,Oe.matrixAutoUpdate=!1,be.add(Oe);const n=new K.PlaneGeometry(Dt/Ft,xt/Ft,1,1);je=new K.Mesh(n,$e),je.position.z=0,je.visible=!1,je.matrixAutoUpdate=!1,be.add(je),Bn();const i=new ie;Ye=Math.round(2*devicePixelRatio*$t);const o=new Array(3*Ye).fill(0),a=new Array(o.length).fill(0);i.setPositions(o),i.setColors(a),Qe=new te(i,qe),Qe.scale.set(1,1,1),Qe.visible="line"==Ke.plotType,be.add(Qe);const r=new ie,s=new Array(3*Ye).fill(0);r.setPositions(s),ze=new te(r,Me),ze.scale.set(1,1,1),ze.visible="line"==Ke.plotType&&Ke.overlay,be.add(ze)}function Bn(){switch(Ke.plotType){case"plane":Oe.rotation.x=0,je.rotation.x=0;break;case"surface":Oe.rotation.x=-Math.PI/2,je.rotation.x=-Math.PI/2}Oe.updateMatrix(),je.updateMatrix()}function On(){Ke.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Wn(e){it=new dat.GUI({closeOnTop:!0,autoPlace:!1}),it.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(it.domElement),ot=new dat.GUI({closeOnTop:!0,autoPlace:!1}),ot.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(ot.domElement),at=new dat.GUI({closeOnTop:!0,autoPlace:!1}),at.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(at.domElement),it.open(),ot.open(),at.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),rt=ot.addFolder("Brush");na(ea(rt),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',Ua,null,"Toggle the brush on or off"),Ut.brushAction=rt.add(Ke,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange((function(){Qn(),document.activeElement.blur()})),Ut.brushType=rt.add(Ke,"brushType",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange((function(){Qn(),document.activeElement.blur()})),rt.add(Ke,"brushValue").name("Value").onFinishChange(Qn),rt.add(Ke,"brushRadius").name("Radius").onFinishChange(Qn),Ut.whatToDraw=rt.add(Ke,"whatToDraw",vn).name("Species").onChange(Qn),rt=ot.addFolder("Domain"),rt.add(Ke,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){uo(),document.activeElement.blur(),_a()})),rt.add(Ke,"domainScale").name("Largest side").onFinishChange((function(){kn(),_a()})),rt.add(Ke,"spatialStep").name("Space step").onFinishChange((function(){kn(),_a()})),rt.add(Ke,"minX").name("Min. $x$").onFinishChange((function(){Vi(),ii()})),Ut.minY=rt.add(Ke,"minY").name("Min. $y$").onFinishChange((function(){Vi(),ii()}));const t=ea(rt);na(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){On(),kn(),Mn(),_a()}),null,"Use a square domain"),na(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Custom',(function(){Ai(),Ti(),li(),Ei(),_a()}),null,"Specify a custom domain"),Ut.domainIndicatorFun=rt.add(Ke,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){Ai(),Ti(),li(),Di(),_a()})),rt=ot.addFolder("Timestepping"),Ut.numTimestepsPerFrame=rt.add(Ke,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),ga(Ut.numTimestepsPerFrame,1,400,1),Ut.dt=rt.add(Ke,"dt").name("Timestep").onChange((function(){Rn()})),Ut.dt.__precision=12,Ut.dt.min(0),Ut.dt.updateDisplay(),rt.add(Ke,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme").onChange((function(){document.activeElement.blur()}));const n=ea(rt);na(n,"timeDisplay",'<i class="fa-regular fa-hourglass-half"></i> Elapsed time',Yi,null,"Show/hide time display"),na(n,"autoPause",'<i class="fa-regular fa-hourglass-end"></i> Auto pause',(function(){Lt=et.t.value<Ke.autoPauseAt,Ti()}),null,"Toggle automatic pausing"),Ut.autoPauseAt=rt.add(Ke,"autoPauseAt").name("Pause at $t=$").onFinishChange((function(){Lt=et.t.value<Ke.autoPauseAt,Ut.autoPauseAt.domElement.blur()})),rt=ot.addFolder("Equations"),rt.add(Ke,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange((function(){document.activeElement.blur(),Vi(),ii()})),Ut.algebraicSpecies=rt.add(Ke,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Yt=!0,Vi(),Yt=!1,ii()})),rt.add(Ke,"speciesNames").name("Species names").onFinishChange((function(){Fo()}));na(ea(rt),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',(function(){Vi()}),"cross_diffusion_controller","Toggle cross diffusion"),rt=it.addFolder("Definitions");na(ea(rt),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',Pi,null,"Typeset the specified equations"),Ut.Duu=rt.add(Ke,"diffusionStr_1_1").onFinishChange((function(){li(),Pi()})),Po(Ut.Duu,ko,["U","UU"]),Uo(Ut.Duu,qo,["U","UU"]),Ut.Duv=rt.add(Ke,"diffusionStr_1_2").onFinishChange((function(){li(),Pi()})),Po(Ut.Duv,ko,["UV"]),Uo(Ut.Duv,qo,["UV"]),Ut.Duw=rt.add(Ke,"diffusionStr_1_3").onFinishChange((function(){li(),Pi()})),Po(Ut.Duw,ko,["UW"]),Uo(Ut.Duw,qo,["UW"]),Ut.Duq=rt.add(Ke,"diffusionStr_1_4").onFinishChange((function(){li(),Pi()})),Po(Ut.Duq,ko,["UQ"]),Uo(Ut.Duq,qo,["UQ"]),Ut.Dvu=rt.add(Ke,"diffusionStr_2_1").onFinishChange((function(){li(),Pi()})),Po(Ut.Dvu,ko,["VU"]),Uo(Ut.Dvu,qo,["VU"]),Ut.Dvv=rt.add(Ke,"diffusionStr_2_2").onFinishChange((function(){li(),Pi()})),Po(Ut.Dvv,ko,["V","VV"]),Uo(Ut.Dvv,qo,["V","VV"]),Ut.Dvw=rt.add(Ke,"diffusionStr_2_3").onFinishChange((function(){li(),Pi()})),Po(Ut.Dvw,ko,["VW"]),Uo(Ut.Dvw,qo,["VW"]),Ut.Dvq=rt.add(Ke,"diffusionStr_2_4").onFinishChange((function(){li(),Pi()})),Po(Ut.Dvq,ko,["VQ"]),Uo(Ut.Dvq,qo,["VQ"]),Ut.Dwu=rt.add(Ke,"diffusionStr_3_1").onFinishChange((function(){li(),Pi()})),Po(Ut.Dwu,ko,["WU"]),Uo(Ut.Dwu,qo,["WU"]),Ut.Dwv=rt.add(Ke,"diffusionStr_3_2").onFinishChange((function(){li(),Pi()})),Po(Ut.Dwv,ko,["WV"]),Uo(Ut.Dwv,qo,["WV"]),Ut.Dww=rt.add(Ke,"diffusionStr_3_3").onFinishChange((function(){li(),Pi()})),Po(Ut.Dww,ko,["W","WW"]),Uo(Ut.Dww,qo,["W","WW"]),Ut.Dwq=rt.add(Ke,"diffusionStr_3_4").onFinishChange((function(){li(),Pi()})),Po(Ut.Dwq,ko,["WQ"]),Uo(Ut.Dwq,qo,["WQ"]),Ut.Dqu=rt.add(Ke,"diffusionStr_4_1").onFinishChange((function(){li(),Pi()})),Po(Ut.Dqu,ko,["QU"]),Uo(Ut.Dqu,qo,["QU"]),Ut.Dqv=rt.add(Ke,"diffusionStr_4_2").onFinishChange((function(){li(),Pi()})),Po(Ut.Dqv,ko,["QV"]),Uo(Ut.Dqv,qo,["QV"]),Ut.Dqw=rt.add(Ke,"diffusionStr_4_3").onFinishChange((function(){li(),Pi()})),Po(Ut.Dqw,ko,["QW"]),Uo(Ut.Dqw,qo,["QW"]),Ut.Dqq=rt.add(Ke,"diffusionStr_4_4").onFinishChange((function(){li(),Pi()})),Po(Ut.Dqq,ko,["Q","QQ"]),Uo(Ut.Dqq,qo,["Q","QQ"]),Ut.f=rt.add(Ke,"reactionStr_1").onFinishChange((function(){li(),Pi()})),Po(Ut.f,ko,["UFUN"]),Uo(Ut.f,qo,["UFUN"]),Ut.g=rt.add(Ke,"reactionStr_2").onFinishChange((function(){li(),Pi()})),Po(Ut.g,ko,["VFUN"]),Uo(Ut.g,qo,["VFUN"]),Ut.h=rt.add(Ke,"reactionStr_3").onFinishChange((function(){li(),Pi()})),Po(Ut.h,ko,["WFUN"]),Uo(Ut.h,qo,["WFUN"]),Ut.j=rt.add(Ke,"reactionStr_4").onFinishChange((function(){li(),Pi()})),Po(Ut.j,ko,["QFUN"]),Uo(Ut.j,qo,["QFUN"]),At=it.addFolder("Parameters"),function(){let e,t,n=[],i=Ke.kineticParams.split(";");for(var o=0;o<i.length;o++)t=Li(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+on,on+=1,tn.push(e),en[e]=t,n.push(e));for(const e of n)Ni(e,!1);e="param"+on,tn.push(e),en[e]=t,Ni(e,!0)}(),rt=it.addFolder("Boundary conditions"),Ut.uBCs=rt.add(Ke,"boundaryConditions_1",{}).onChange((function(){li(),vi(),document.activeElement.blur()})),Ut.dirichletU=rt.add(Ke,"dirichletStr_1").onFinishChange(li),Ut.neumannU=rt.add(Ke,"neumannStr_1").onFinishChange(li),Ut.robinU=rt.add(Ke,"robinStr_1").onFinishChange(li),Ut.comboU=rt.add(Ke,"comboStr_1").name("Details").onFinishChange(li),Ut.vBCs=rt.add(Ke,"boundaryConditions_2",{}).onChange((function(){li(),vi(),document.activeElement.blur()})),Ut.dirichletV=rt.add(Ke,"dirichletStr_2").onFinishChange(li),Ut.neumannV=rt.add(Ke,"neumannStr_2").onFinishChange(li),Ut.robinV=rt.add(Ke,"robinStr_2").onFinishChange(li),Ut.comboV=rt.add(Ke,"comboStr_2").name("Details").onFinishChange(li),Ut.wBCs=rt.add(Ke,"boundaryConditions_3",{}).onChange((function(){li(),vi(),document.activeElement.blur()})),Ut.dirichletW=rt.add(Ke,"dirichletStr_3").onFinishChange(li),Ut.neumannW=rt.add(Ke,"neumannStr_3").onFinishChange(li),Ut.robinW=rt.add(Ke,"robinStr_3").onFinishChange(li),Ut.comboW=rt.add(Ke,"comboStr_3").name("Details").onFinishChange(li),Ut.qBCs=rt.add(Ke,"boundaryConditions_4",{}).name("$q$").onChange((function(){li(),vi(),document.activeElement.blur()})),Ut.dirichletQ=rt.add(Ke,"dirichletStr_4").onFinishChange(li),Ut.neumannQ=rt.add(Ke,"neumannStr_4").onFinishChange(li),Ut.robinQ=rt.add(Ke,"robinStr_4").onFinishChange(li),Ut.comboQ=rt.add(Ke,"comboStr_4").name("Details").onFinishChange(li),rt=it.addFolder("Initial conditions"),Ut.initCond_1=rt.add(Ke,"initCond_1").onFinishChange(_i),Ut.initCond_2=rt.add(Ke,"initCond_2").onFinishChange(_i),Ut.initCond_3=rt.add(Ke,"initCond_3").onFinishChange(_i),Ut.initCond_4=rt.add(Ke,"initCond_4").onFinishChange(_i),lt=ot.addFolder("Images"),rt=lt,Ci(),rt=ot.addFolder("Checkpoints");const i=ea(rt);na(i,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),ia(i),ta(i,'<i class="fa-regular fa-flag"></i> Set',Mo,null,"Set a checkpoint at the current state",["narrow"]),ta(i,'<i class="fa-regular fa-file-arrow-down"></i> Export',Ro,null,"Download the last checkpoint as a file",["narrow"]),ta(i,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),rt.add(Ke,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize").onChange((function(){document.activeElement.blur()})),rt=ot.addFolder("Misc."),rt.addColor(Ke,"backgroundColour").name("Background").onChange((function(){be.background=new K.Color(Ke.backgroundColour),_a()}));const o=ea(rt);na(o,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){Xi(),_a()}),null,"Compute the integral of the plotted expression over the domain"),na(o,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',(function(){io(),_a()}),"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),na(o,"setSeed",'<i class="fa-regular fa-shuffle"></i> Set seed',(function(){Ke.setSeed&&(Ht=Ke.randSeed),wi(),Ti()}),null,"Set the seed for random number generation"),Ut.randSeed=rt.add(Ke,"randSeed").name("Random seed").onFinishChange((function(){wi()})),rt=rt.addFolder("Dev");const a=ea(rt);ta(a,'<i class="fa-regular fa-copy"></i> Copy code',oa,null,"Copy the simulation configuration as JSON to the clipboard"),ta(a,'<i class="fa-regular fa-bug"></i> Copy debug',aa,null,"Copy debug information to the clipboard");let r=Y();var s;Object.keys(r).forEach((function(e){r[e]=e})),r.default=null,rt.add(Ke,"parent",(s=r,Object.keys(s).sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})).reduce((function(e,t){return e[t]=s[t],e}),{}))).name("Parent preset").onChange((function(){document.activeElement.blur()}));const l=document.createElement("div");l.innerHTML="Settings",l.classList.add("ui_title"),ot.domElement.prepend(l);const u=document.createElement("div");u.innerHTML="Equations",u.classList.add("ui_title"),it.domElement.prepend(u);const c=document.createElement("div");c.id="views_list",at.domElement.prepend(c);const d=document.createElement("div");d.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",d.classList.add("ui_title"),at.domElement.prepend(d),dt=at.addFolder("Edit view"),rt=dt;const h=ea(rt,"edit_view_buttons");ta(h,'<i class="fa-solid fa-pen-nib"></i> Rename',zo,null,"Rename the current view"),ta(h,'<i class="fa-solid fa-xmark"></i> Delete',Go,"deleteViewButton","Delete view"),Ut.whatToPlot=rt.add(Ke,"whatToPlot").name("Expression: ").onFinishChange((function(){Di(),_a(),Yo(this.property)})),rt.add(Ke,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){lo(),document.activeElement.blur(),_a(),Yo(this.property)})),rt.add(Ke,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){zn(),Qi(),document.activeElement.blur(),_a(),Yo(this.property)})).name("Colour map"),Ut.minColourValue=rt.add(Ke,"minColourValue").name("Min value").onChange((function(){Rn(),zi(),_a(),Yo(this.property)})),Ut.minColourValue.__precision=2,Ut.maxColourValue=rt.add(Ke,"maxColourValue").name("Max value").onChange((function(){Rn(),zi(),_a(),Yo(this.property)})),Ut.maxColourValue.__precision=2;const f=ea(rt,"colour_map_buttons");ta(f,'<i class="fa-regular fa-arrows-rotate"></i> Flip',(function(){Ke.flippedColourmap=!Ke.flippedColourmap,zn(),Qi(),_a(),Yo("flippedColourmap")}),null,"Reverse colour map",["narrow"]),ta(f,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){Do(),Hn(),Yo("minColourValue"),Yo("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),na(f,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){Qi(),Yo("colourbar")}),null,"Display the colourbar",null,["narrow"]),ia(f),na(f,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){Ke.autoSetColourRange&&(Do(),Hn()),Yo("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),na(f,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){zn(),_a(),Yo("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),na(f,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){zn(),_a(),Yo("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),na(f,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){zn(),_a(),Yo("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),na(f,"vectorField",'<i class="fa-solid fa-arrow-right-arrow-left"></i> Vector field',(function(){$a(),_a(),Yo("vectorField")}),"vectorFieldButton","Toggle vector field","vectorFieldFolder",["wide"]),rt=dt.addFolder("Contours"),rt.domElement.id="contoursFolder",Ut.contourColour=rt.addColor(Ke,"contourColour").name("Colour").onChange((function(){va(),_a(),Yo(this.property)})),Ut.contourNum=rt.add(Ke,"contourNum").name("Number").onChange((function(){va(),_a(),Yo(this.property)})),ga(Ut.contourNum,1,20,1),kt.push(Ut.contourNum),Ut.contourEpsilon=rt.add(Ke,"contourEpsilon").name("Threshold").onChange((function(){va(),_a(),Yo(this.property)})),ga(Ut.contourEpsilon,.001,.05,.001),kt.push(Ut.contourEpsilon),rt=dt.addFolder("Lighting"),rt.domElement.id="embossFolder",Ut.embossSmoothness=rt.add(Ke,"embossSmoothness").name("Smoothness").onChange((function(){pa(),_a(),Yo(this.property)})),ga(Ut.embossSmoothness,0,2,.001),qt.push(Ut.embossSmoothness),Ut.embossAmbient=rt.add(Ke,"embossAmbient").name("Ambient").onChange((function(){pa(),_a(),Yo(this.property)})),ga(Ut.embossAmbient,0,1,.001),qt.push(Ut.embossAmbient),Ut.embossDiffuse=rt.add(Ke,"embossDiffuse").name("Diffuse").onChange((function(){pa(),_a(),Yo(this.property)})),ga(Ut.embossDiffuse,0,1,.001),qt.push(Ut.embossDiffuse),Ut.embossSpecular=rt.add(Ke,"embossSpecular").name("Specular").onChange((function(){pa(),_a(),Yo(this.property)})),ga(Ut.embossSpecular,0,1,.001),qt.push(Ut.embossSpecular),Ut.embossShiny=rt.add(Ke,"embossShiny").name("Precision").onChange((function(){pa(),_a(),Yo(this.property)})),ga(Ut.embossShiny,0,100,1),qt.push(Ut.embossShiny),Ut.embossTheta=rt.add(Ke,"embossTheta").name("Inclination").onChange((function(){pa(),_a(),Yo(this.property)})),ga(Ut.embossTheta,0,1.5708,.001),qt.push(Ut.embossTheta),Ut.embossPhi=rt.add(Ke,"embossPhi").name("Direction").onChange((function(){pa(),_a(),Yo(this.property)})),ga(Ut.embossPhi,0,3.1456,.001),qt.push(Ut.embossPhi),rt=dt.addFolder("Overlay"),rt.domElement.id="overlayFolder",rt.addColor(Ke,"overlayColour").name("Colour").onChange((function(){wa(),_a(),Yo(this.property)})),rt.add(Ke,"overlayExpr").name("Expression").onFinishChange((function(){zn(),"line"==Ke.plotType&&Ei(),_a(),Yo(this.property)})),Ut.overlayEpsilon=rt.add(Ke,"overlayEpsilon").name("Threshold").onChange((function(){wa(),_a(),Yo(this.property)})),Ut.overlayLineWidthMul=rt.add(Ke,"overlayLineWidthMul",.1,2).name("Thickness").onChange((function(){Vo(),_a(),Yo(this.property)})),ht=dt.addFolder("3D"),rt=ht,st=ea(rt),na(st,"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){et.customSurface.value=Ke.customSurface,Ca(),Da(),_a(),Yo("customSurface")}),null,"Plot the solution on a custom surface"),Ut.surfaceFun=rt.add(Ke,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){Di(),_a(),Yo(this.property)})),Ut.threeDHeightScale=rt.add(Ke,"threeDHeightScale").name("Height scale").onChange((function(){Rn(),_a(),Yo(this.property)})),Ut.cameraTheta=rt.add(Ke,"cameraTheta").name("View $\\theta$").onChange((function(){Mn(),_a(),Yo(this.property)})),Ut.cameraPhi=rt.add(Ke,"cameraPhi").name("View $\\phi$").onChange((function(){Mn(),_a(),Yo(this.property)})),Ut.cameraZoom=rt.add(Ke,"cameraZoom").name("Zoom").onChange((function(){Mn(),_a(),Yo(this.property)})),Ut.lineWidthMul=rt.add(Ke,"lineWidthMul",.1,2).name("Thickness").onChange((function(){Vo(),_a(),Yo(this.property)})),ft=dt.addFolder("Vector field"),rt=ft,rt.domElement.id="vectorFieldFolder",rt.addColor(Ke,"arrowColour").name("Colour").onChange((function(){Ta(),_a(),Yo(this.property)})),rt.add(Ke,"arrowX").onFinishChange((function(){Ei(),_a(),Yo(this.property)})).name("$x$ component"),rt.add(Ke,"arrowY").onFinishChange((function(){Ei(),_a(),Yo(this.property)})).name("$y$ component"),Ut.arrowDensity=rt.add(Ke,"arrowDensity").onChange((function(){$a(),_a(),Yo(this.property)})).name("Density"),Ut.arrowDensity.__precision=2,ga(Ut.arrowDensity,0,1,.001),rt.add(Ke,"arrowScale",{None:"none",Relative:"relative",Auto:"auto"}).onFinishChange((function(){Ti(),_a(),Yo(this.property)})).name("Scaling"),Ut.arrowLengthMax=rt.add(Ke,"arrowLengthMax").onFinishChange((function(){$a(),_a(),Yo(this.property)})).name("Max length");document.querySelectorAll("input").forEach((e=>Sa(e)))}function jn(){zn(),Qi(),Di(),Qn()}function Qn(){let l=vo()+e(),u="float brushRadius = "+ri(Ke.brushRadius.toString())+";\n";switch(u=u.replace(/\buvwq\./g,"uvwqBrush."),u=u.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(Ke.brushValue)&&(l+=q()),/\bRANDN\b/.test(Ke.brushValue)&&(l+=M()),l+="float brushValue = "+ri(Ke.brushValue)+";\n",l+=u,Ke.brushType){case"circle":l+=i();break;case"hline":l+=a();break;case"vline":l+=o()}switch(Ke.brushAction){case"replace":l+=r(),l+=t();break;case"add":l+=r(),l+=n();break;case"smoothreplace":l+=s(),l+=t();break;case"smoothadd":l+=s(),l+=n()}Ua(),l=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,bi(Ke.whatToDraw)),e}(l),l=Va(l),Ae.fragmentShader=l,Ae.needsUpdate=!0}function zn(){Xe=j(Ke.colourmap),Ke.flippedColourmap&&(Xe.reverse(),Xe=Xe.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),et.colour1.value=new K.Vector4(...Xe[0]),et.colour2.value=new K.Vector4(...Xe[1]),et.colour3.value=new K.Vector4(...Xe[2]),et.colour4.value=new K.Vector4(...Xe[3]),et.colour5.value=new K.Vector4(...Xe[4]);let e=vo()+R();Ke.emboss&&(e+=L(),pa()),Ke.contours&&(e+=N(),va()),Ke.overlay&&(e+=W().replaceAll("OVERLAYEXPR",ri(Ke.overlayExpr)),e=Va(e),wa()),ze.visible=Ke.overlay&&"line"==Ke.plotType,e+=I(),Te.fragmentShader=e,Te.needsUpdate=!0,ke.needsUpdate=!0,Ze=Xe.map((e=>e[3])),Xe=Xe.map((e=>e.slice(0,-1)))}function Gn(){switch(Ke.timesteppingScheme){case"Euler":We.material=Pt.FE,et.textureSource.value=Vt[1].texture,et.textureSource1.value=Vt[2].texture,et.dt.value=Ke.dt,we.setRenderTarget(Vt[0]),we.render(ve,ge),Vt.rotate(-1),et.t.value+=Ke.dt;break;case"AB2":We.material=Pt.AB2,et.textureSource.value=Vt[1].texture,et.textureSource1.value=Vt[2].texture,et.dt.value=Ke.dt,we.setRenderTarget(Vt[0]),we.render(ve,ge),Vt.rotate(-1),et.t.value+=Ke.dt;break;case"Mid":We.material=Pt.Mid1,et.textureSource.value=Vt[1].texture,we.setRenderTarget(Vt[2]),we.render(ve,ge),We.material=Pt.Mid2,et.textureSource1.value=Vt[2].texture,et.t.value+=.5*Ke.dt,we.setRenderTarget(Vt[0]),we.render(ve,ge),Vt.rotate(-1),et.t.value+=.5*Ke.dt;break;case"RK4":We.material=Pt.RK41,et.textureSource.value=Vt[1].texture,we.setRenderTarget(Vt[2]),we.render(ve,ge),We.material=Pt.RK42,et.textureSource1.value=Vt[2].texture,et.t.value+=.5*Ke.dt,we.setRenderTarget(Vt[3]),we.render(ve,ge),We.material=Pt.RK43,et.textureSource2.value=Vt[3].texture,we.setRenderTarget(Vt[4]),we.render(ve,ge),We.material=Pt.RK44,et.textureSource3.value=Vt[4].texture,et.t.value+=.5*Ke.dt,we.setRenderTarget(Vt[0]),we.render(ve,ge),Vt.rotate(-1)}}function Hn(){if(Yn(),Ke.autoSetColourRange&&Do(),Ke.brushEnabled&&"surface"==Ke.plotType){let e=0;Ke.maxColourValue-Ke.minColourValue>0&&(e=(function(){to();let e=0;for(let t=0;t<hn.length;t+=4)e+=hn[t];return e/(St*Ct)}()-Ke.minColourValue)/(Ke.maxColourValue-Ke.minColourValue)-.5,e=e.clamp(-.5,.5)),je.position.y=Ke.threeDHeightScale*e,je.updateWorldMatrix()}if("line"==Ke.plotType){to();let t=0;var e=Ke.maxColourValue-Ke.minColourValue;e=0==e?.5:e;for(let n=0;n<hn.length;n+=4)He[t++]=(hn[n]-Ke.minColourValue)/e-.5;let n=new K.SplineCurve(Ge.map(((e,t)=>new K.Vector2(e,He[t])))),i=n.getSpacedPoints(Ye);if($o(Qe,i),function(e,t){let n,i=e.geometry.attributes.instanceColorStart,o=e.geometry.attributes.instanceColorEnd;for(let e=0;e<t.length;e++)n=To(t[e].toArray()[1]+.5),e<t.length&&i.setXYZ(e,n[0],n[1],n[2]),e>0&&o.setXYZ(e-1,n[0],n[1],n[2]);i.needsUpdate=!0}(Qe,i),Ke.overlay){t=0;for(let n=2;n<4*St;n+=4)He[t++]=(hn[n]-Ke.minColourValue)/e-.5;n=new K.SplineCurve(Ge.map(((e,t)=>new K.Vector2(e,He[t])))),i=n.getSpacedPoints(Ye),$o(ze,i)}}if(Ke.vectorField&&Je){mn=new Float32Array(St*Ct*4),we.readRenderTargetPixels(De,0,0,St,Ct,mn);let e,t,n,i=[];for(const o of Je.children)e=4*o.ind,t=mn[e+2],n=mn[e+3],o.visible=mn[e+1]<=.5,o.lookAt(o.position.x+t,o.position.y+n,o.position.z),o.size=t**2+n**2,i.push(o.size);let o=1;switch(Ke.arrowScale){case"auto":o=Math.sqrt(Math.max(...i)),0==o&&(o=1);for(const e of Je.children){const t=Kt*Ao(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"relative":o=Je.customMax>0?Je.customMax:1;for(const e of Je.children){const t=Kt*Ao(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"none":for(const e of Je.children)e.scale.set(Kt,Kt,Kt)}}if(Ke.timeDisplay&&Ji(),Ke.integrate&&function(){if(Ke.integrate){let e;to(),1==Ke.dimension?e=et.dx.value:2==Ke.dimension&&(e=et.dx.value*et.dy.value);let t=0;for(let e=0;e<hn.length;e+=4)t+=hn[e]*(1-hn[e+1]);t*=e,$("#integralValue").html(Gi(t,4)),no()}}(),oo()?(We.material=Ie,we.setRenderTarget(xe),we.render(ve,ge),et.textureSource.value=xe.texture,et.dxUpscaledScale.value=devicePixelRatio*$t/St,et.dyUpscaledScale.value=devicePixelRatio*Tt/Ct):(et.dxUpscaledScale.value=1,et.dyUpscaledScale.value=1),we.setRenderTarget(null),we.render(be,pe),pn){pn=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",we.render(be,pe),t.href=we.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Ln(),Hn()}}function Yn(){We.material=ke,et.textureSource.value=Vt[1].texture,we.setRenderTarget(De),we.render(ve,ge),et.textureSource.value=De.texture,gn=!1,et.textureSource1.value=Vt[1].texture}function Jn(e){pt=Kn(e,he),pt&&(Ke.brushEnabled&&"surface"==Ke.plotType?ye.enabled=!1:Ke.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),Wi("#top_message"),window.clearTimeout(wt),wt=setTimeout((function(){$("#top_message").hasClass("fading_out")||ji("#top_message")}),3e3)))}function Xn(e){pt=!1,"surface"==Ke.plotType&&(ye.enabled=!0)}function Zn(e){Kn(e,he)}function Kn(e,t){var n=t.getBoundingClientRect();let i=(e.clientX-n.x)/n.width,o=1-(e.clientY-n.y)/n.height;if("surface"==Ke.plotType){Ce.x=2*i-1,Ce.y=2*o-1,Se.setFromCamera(Ce,pe);var a=Se.intersectObject(je,!1);a.length>0?(i=a[0].uv.x,o=a[0].uv.y):(i=-1,o=-1)}else"line"==Ke.plotType&&(i=(i-.5)/pe.zoom+.5,o=.5);return i=Math.round(i*St)/St,o=Math.round(o*Ct)/Ct,et.brushCoords.value=new K.Vector2(i,o),0<=i&&i<=1&&0<=o&&o<=1}function ei(){we.setSize(St,Ct,!1),zt&&Ke.resetFromCheckpoints?We.material=Le:We.material=Pe,Vt.forEach((e=>{we.setRenderTarget(e),we.render(ve,ge)})),Bo(),Hn()}function ti(){Qt||($("#pause").hide(),$("#play").show()),mt=!1}function ni(){Qt||($("#play").hide(),$("#pause").show()),Nt=!0,window.clearTimeout(vt),vt=setTimeout(eo,1e3),mt=!0}function ii(){Ke.setSeed&&(Ht=Ke.randSeed),wi(),et.t.value=0,Lt=!0,Ji(),ei(),Hn(),Nt=!0,window.clearTimeout(vt),eo()}function oi(){let e="";return e+="float UFUN = "+ri(Ke.reactionStr_1)+";\n",e+="float VFUN = "+ri(Ke.reactionStr_2)+";\n",e+="float WFUN = "+ri(Ke.reactionStr_3)+";\n",e+="float QFUN = "+ri(Ke.reactionStr_4)+";\n",e}function ai(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function ri(e){if(!Wo(e=" "+e+" ")||ka(e))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])?\b/g);let i,o,a,r,s,l,u,c,d,h,f,m,p,g=0;const b={S:"One",T:"Two"},v={R:"r",G:"g",B:"b",A:"a"};for(const w of n){for(i=w.index,m=b[w[1]],o=i+w[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,s=t.slice(o+g+1,a+g),s=yo(s),l=s.split(","),1!=l.length&&0!=l[1].trim().length||(l[1]="0"),l[0]="("+l[0]+"-MINX)/L_x",l[1]="("+l[1]+"-MINY)/L_y",h="texture(imageSource"+m+",vec2("+l.join(",")+")).",null!=w[2]?(p=v[w[2]],f=h+p):(p=["r","g","b"],f="("+p.map((e=>h+e)).join("+")+")/3.0 "),t=Ri(t,f,i+g,a+1+g),g+=f.length-a+i-1)}return t}(e=(e=mo(e=(e=(e=(e=si(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){if("0"==n)return"1";const i=Number(n);return Number.isInteger(i&&i>0&&i<101)?"(("+t+")"+("*("+t+")").repeat(i-1)+")":"safepow("+t+","+n+")"}))).replaceAll(RegExp("\\b("+_n[0]+")\\b","g"),(function(e,t){return"uvwq."+bi(t)}))).replaceAll(RegExp("\\b("+_n[0]+")_([xy][fb]?2?)\\b","g"),(function(e,t,n){return n.includes("2")&&(n=n.slice(0,-1).repeat(2)),"uvwq"+n.toUpperCase()+"."+bi(t)}))).replaceAll(RegExp("\\b("+_n[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+bi(t)})))).replaceAll(/\b(I_[ST][RBGA]?\b)\s*(?!\()/g,"$1(x,y) "));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e=e.replaceAll(/\bind\b/g,"float")}function si(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function li(){let e="",t="",n="",i="",o="",a="";const r=[Ke.boundaryConditions_1,Ke.boundaryConditions_2,Ke.boundaryConditions_3,Ke.boundaryConditions_4],s=[Ke.neumannStr_1,Ke.neumannStr_2,Ke.neumannStr_3,Ke.neumannStr_4],l=[Ke.comboStr_1,Ke.comboStr_2,Ke.comboStr_3,Ke.comboStr_4].map((e=>e+";")),u=[Ke.dirichletStr_1,Ke.dirichletStr_2,Ke.dirichletStr_3,Ke.dirichletStr_4],c=[Ke.robinStr_1,Ke.robinStr_2,Ke.robinStr_3,Ke.robinStr_4];r.forEach((function(t,n){"neumann"==t?(e+=ui(s[n],vn[n]),Ke.domainViaIndicatorFun?e+=Zo(n):e+=Xo(n)):"combo"==t&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=ui(t[2],vn[n],i),e+=Xo(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=gi(P(t),vn[e]),Ke.dimension>1&&(i+=gi(U(t),vn[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,ri(e[2]))}))})),r.forEach((function(e,t){if("dirichlet"==e)if(Ke.domainViaIndicatorFun){let e=v().replace(/indicatorFun/g,ri(Ke.domainIndicatorFun));n+=gi(e,vn[t])+ri(u[t])+";\n}\n"}else n+=ci(u[t],vn[t]),n+=Jo(t);else if("combo"==e)[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=ci(e[2],vn[t],i),n+=Jo(t,i)}));else if(Ke.domainViaIndicatorFun){let e=v().replace(/indicatorFun/g,ri(Ke.domainIndicatorFun));n+=gi(e,vn[t])+"0.0;\n}\n"}})),r.forEach((function(e,t){"robin"==e?(i+=ui(c[t],vn[t]),Ke.domainViaIndicatorFun?i+=Zo(t):i+=Xo(t)):"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=ui(e[2],vn[t],n),i+=Xo(t,n)}))}));let d=vo();if(o=function(){let e="";return e+=ai(ri(Ke.diffusionStr_1_1)+";\n","uu"),e+=ai(ri(Ke.diffusionStr_2_2)+";\n","vv"),e+=ai(ri(Ke.diffusionStr_3_3)+";\n","ww"),e+=ai(ri(Ke.diffusionStr_4_4)+";\n","qq"),e}()+"\n",Ke.crossDiffusion?o+=function(){let e="";return e+=ai(ri(Ke.diffusionStr_1_2)+";\n","uv"),e+=ai(ri(Ke.diffusionStr_1_3)+";\n","uw"),e+=ai(ri(Ke.diffusionStr_1_4)+";\n","uq"),e+=ai(ri(Ke.diffusionStr_2_1)+";\n","vu"),e+=ai(ri(Ke.diffusionStr_2_3)+";\n","vw"),e+=ai(ri(Ke.diffusionStr_2_4)+";\n","vq"),e+=ai(ri(Ke.diffusionStr_3_1)+";\n","wu"),e+=ai(ri(Ke.diffusionStr_3_2)+";\n","wv"),e+=ai(ri(Ke.diffusionStr_3_4)+";\n","wq"),e+=ai(ri(Ke.diffusionStr_4_1)+";\n","qu"),e+=ai(ri(Ke.diffusionStr_4_2)+";\n","qv"),e+=ai(ri(Ke.diffusionStr_4_3)+";\n","qw"),e}()+"\n"+D():o+=C(),Ke.numAlgebraicSpecies>=2){const e=Ke.numSpecies-Ke.numAlgebraicSpecies;let t={};for(let n=e;n<Ke.numSpecies;n++){let i=[],o=Ke["reactionStr_"+(n+1).toString()];for(let t=e;t<Ke.numSpecies;t++)o=[o,Ke["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()]].join(" ");for(let t=e;t<Ke.numSpecies;t++){(new RegExp("\\b"+vn[t]+"(_(x|xb|xf|xb2|xf2|xx|y|yb|yf|yb2|yf2|yy))?\\b").test(o)||"0"!=Ke["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()])&&i.push(vn[t])}i!=[]&&(t[vn[n]]=i)}let n={},i=[],o=[];for(let a of vn.slice(e,Ke.numSpecies))Pa(a,n,i,t,o);if(o.length>0)return void Oo("Cyclic variables detected. Please check the definition(s) of "+o.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.")}if(un&&Ke.crossDiffusion&&(a+=gi(x(),vn[1])),cn&&Ke.crossDiffusion&&(a+=gi(x(),vn[2])),dn&&Ke.crossDiffusion&&(a+=gi(x(),vn[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void Oo("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let h=[E(),A(),e,t,i,T(),V(),oi(),o].join(" "),f=/\bRAND\b/.test(h),g=/\bRANDN\b/.test(h);f&&(h=q()+h),g&&(h=M()+h),Ot=f||g;let b=[n,a,p()].join(" "),w="FE";Pt[w].fragmentShader=Va([d,m(w),h,k(w),b].join(" ")),w="AB2",Pt[w].fragmentShader=Va([d,m(w),h,k(w),b].join(" ")),w="Mid";for(let e=1;e<3;e++)Pt[w+e.toString()].fragmentShader=Va([d,m(w+e.toString()),h,k(w+e.toString()),b].join(" "));w="RK4";for(let e=1;e<5;e++)Pt[w+e.toString()].fragmentShader=Va([d,m(w+e.toString()),h,k(w+e.toString()),b].join(" "));if(Object.keys(Pt).forEach((e=>Pt[e].needsUpdate=!0)),bt=Ke.domainViaIndicatorFun||"dirichlet"==Ke.boundaryConditions_1||"dirichlet"==Ke.boundaryConditions_2||"dirichlet"==Ke.boundaryConditions_3||"dirichlet"==Ke.boundaryConditions_4||/Dirichlet/.test(Ke.comboStr_1)||/Dirichlet/.test(Ke.comboStr_2)||/Dirichlet/.test(Ke.comboStr_3)||/Dirichlet/.test(Ke.comboStr_4),bt){if(n=d+F(),Ke.domainViaIndicatorFun){let e=v().replace(/indicatorFun/,ri(Ke.domainIndicatorFun)).replace(/updated/,"gl_FragColor");u.forEach((function(t,i){"dirichlet"==r[i]?n+=gi(e,vn[i])+ri(t)+";\n}\n":n+=gi(e,vn[i])+"0.0;\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=ci(u[t],vn[t]),n+=Ko(t)):"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=ci(e[2],vn[t],i),n+=Ko(t,i)}))}));n+="}",n=Va(n),Ve.fragmentShader=n,Ve.needsUpdate=!0}}function ui(e,t,n){return null==n?["L","R","T","B"].map((n=>ui(e,t,n))).join(""):"float robinRHS"+t+n+" = "+ri(e)+";\n"}function ci(e,t,n){return null==n?["L","R","T","B"].map((n=>ci(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+ri(e)+";\n"}function di(e){hi("default"),hi(e),null!=Ke.threeD&&(Ke.threeD&&(Ke.dimension=2,null==Ke.plotType&&(Ke.plotType="surface")),delete Ke.threeD),null!=Ke.oneDimensional&&(Ke.oneDimensional&&(Ke.dimension=1,Ke.plotType="line"),delete Ke.oneDimensional),Xt*=Zt,function(){if(0==Ke.views.length){let e=Ho();e.name="1",Ke.views.push(e)}else Ke.views=Ke.views.map((function(e){let t=Ho();return Object.assign(t,e),t}))}(),mi(it,!0),mi(ot,!0),mi(at,!0),Wn(),Ke.activeViewInd>=Ke.views.length&&(Ke.activeViewInd=Ke.views.length-1),Qo(Ke.views[Ke.activeViewInd],!1),Vi(),On(),kn(),Rn(),be.background=new K.Color(Ke.backgroundColour),""!=Ke.initialState?fetch(Ke.initialState).then((e=>e.blob())).then((e=>Io(e))):ii(),Mn(),ut.remove(),ct.remove(),Ci(),io()}function hi(e){let t;t=null==e?z(Ke.preset):"string"==typeof e?z(e):"object"==typeof e?e:z("default"),t.hasOwnProperty("parent")&&null!=t.parent&&hi(t.parent),on=0,tn=[],en={},Object.assign(Ke,t),mt=Ke.runningOnLoad,Fo(),mt?ni():ti(),da()?Ke.tryClickingText=Ke.tryClickingText.replaceAll("clicking","tapping"):Ke.tryClickingText=Ke.tryClickingText.replaceAll("tapping","clicking"),Ke.brushRadius=Ke.brushRadius.toString(),Ke.hasOwnProperty("drawIn3D")&&(Ke.brushEnabled=Ke.drawIn3D);var n=0;n+=Ke.hasOwnProperty("algebraicV"),n+=Ke.hasOwnProperty("algebraicW"),(n+=Ke.hasOwnProperty("algebraicQ"))&&!Ke.numAlgebraicSpecies&&(Ke.numAlgebraicSpecies=n),delete Ke.algebraicV,delete Ke.algebraicW,delete Ke.algebraicQ;const i=J();Object.keys(i).forEach((function(e){Ke.hasOwnProperty(e)&&(t.hasOwnProperty(i[e])||(Ke[i[e]]=Ke[e]),delete Ke[e])})),null==Ke.minColourValue&&(Ke.minColourValue=0),null==Ke.maxColourValue&&(Ke.maxColourValue=1),Ke.domainScale=Ke.domainScale.toString(),Ke.spatialStep=Ke.spatialStep.toString(),nt=JSON.parse(JSON.stringify(Ke));let o=[Ke.initCond_1,Ke.initCond_2,Ke.initCond_3,Ke.initCond_4,Ke.domainIndicatorFun,Ke.reactionStr_1,Ke.reactionStr_2,Ke.reactionStr_3,Ke.reactionStr_4,Ke.diffusionStr_1_1,Ke.diffusionStr_1_2,Ke.diffusionStr_1_3,Ke.diffusionStr_1_4,Ke.diffusionStr_2_1,Ke.diffusionStr_2_2,Ke.diffusionStr_2_3,Ke.diffusionStr_2_4,Ke.diffusionStr_3_1,Ke.diffusionStr_3_2,Ke.diffusionStr_3_3,Ke.diffusionStr_3_4,Ke.diffusionStr_4_1,Ke.diffusionStr_4_2,Ke.diffusionStr_4_3,Ke.diffusionStr_4_4,Ke.dirichletStr_1,Ke.dirichletStr_2,Ke.dirichletStr_3,Ke.dirichletStr_4,Ke.robinStr_1,Ke.robinStr_2,Ke.robinStr_3,Ke.robinStr_4,Ke.comboStr_1,Ke.comboStr_2,Ke.comboStr_3,Ke.comboStr_4,Ke.neumannStr_1,Ke.neumannStr_2,Ke.neumannStr_3,Ke.neumannStr_4,Ke.brushValue,Ke.whatToPlot].join(" ");Ke.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(o)}function fi(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)fi(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function mi(e,t){if(null!=e){for(let t in e.__folders)mi(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function pi(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function gi(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=bi(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function bi(e){return"rgba"[function(e){return vn.indexOf(e)}(e)]}function vi(){"dirichlet"==Ke.boundaryConditions_1?Ut.dirichletU.show():Ut.dirichletU.hide(),"dirichlet"==Ke.boundaryConditions_2?Ut.dirichletV.show():Ut.dirichletV.hide(),"dirichlet"==Ke.boundaryConditions_3?Ut.dirichletW.show():Ut.dirichletW.hide(),"dirichlet"==Ke.boundaryConditions_4?Ut.dirichletQ.show():Ut.dirichletQ.hide(),"neumann"==Ke.boundaryConditions_1?Ut.neumannU.show():Ut.neumannU.hide(),"neumann"==Ke.boundaryConditions_2?Ut.neumannV.show():Ut.neumannV.hide(),"neumann"==Ke.boundaryConditions_3?Ut.neumannW.show():Ut.neumannW.hide(),"neumann"==Ke.boundaryConditions_4?Ut.neumannQ.show():Ut.neumannQ.hide(),"robin"==Ke.boundaryConditions_1?Ut.robinU.show():Ut.robinU.hide(),"robin"==Ke.boundaryConditions_2?Ut.robinV.show():Ut.robinV.hide(),"robin"==Ke.boundaryConditions_3?Ut.robinW.show():Ut.robinW.hide(),"robin"==Ke.boundaryConditions_4?Ut.robinQ.show():Ut.robinQ.hide(),"combo"==Ke.boundaryConditions_1?Ut.comboU.show():Ut.comboU.hide(),"combo"==Ke.boundaryConditions_2?Ut.comboV.show():Ut.comboV.hide(),"combo"==Ke.boundaryConditions_3?Ut.comboW.show():Ut.comboW.hide(),"combo"==Ke.boundaryConditions_4?Ut.comboQ.show():Ut.comboQ.hide();const e=[Ut.uBCs,Ut.vBCs,Ut.wBCs,Ut.qBCs];Ke.domainViaIndicatorFun?e.forEach((e=>xo(e,["Dirichlet","Neumann","Robin"],["dirichlet","neumann","robin"]))):e.forEach((e=>xo(e,["Periodic","Dirichlet","Neumann","Robin","Combination"],["periodic","dirichlet","neumann","robin","combo"]))),fi(it)}function wi(){Ht=(Ht+123456789)%1e9,et.seed.value=Ht/1e6}function _i(){let e=vo()+Z(),t=[Ke.initCond_1,Ke.initCond_2,Ke.initCond_3,Ke.initCond_4].join(" ");/\bRAND\b/.test(t)&&(e+=q()),/\bRANDN\b/.test(t)&&(e+=M()),e+="float u = "+ri(Ke.initCond_1)+";\n",e+="float v = "+ri(Ke.initCond_2)+";\n",e+="float w = "+ri(Ke.initCond_3)+";\n",e+="float q = "+ri(Ke.initCond_4)+";\n",e+=X(),e=Va(e),Pe.fragmentShader=e,Pe.needsUpdate=!0}function yi(){let e=new Image;e.src=ut.__image.src;let t=new K.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,et.imageSourceOne.value=t,Ke.resetOnImageLoad&&ii()}}function Si(){let e=new Image;e.src=ct.__image.src;let t=new K.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,et.imageSourceTwo.value=t,Ke.resetOnImageLoad&&ii()},t.dispose()}function Ci(){rt=lt,ut=rt.addImage(Ke,"imagePathOne").name("$I_S(x,y)$").onChange(yi),ct=rt.addImage(Ke,"imagePathTwo").name("$I_T(x,y)$").onChange(Si),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Di(){gn=!1,Ei(),Ut.minColourValue.show(),Ut.maxColourValue.show(),Qi(),Xi()}function xi(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function Fi(){to();let e=1/0,t=-1/0;for(let n=0;n<hn.length;n+=4)e=Math.min(e,hn[n]),t=Math.max(t,hn[n]);return[e,t]}function Ei(){let e=vo()+l();e+=u().replace(/\bXVECFUN\b/,ri(Ke.arrowX)).replace(/\bYVECFUN\b/,ri(Ke.arrowY)),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,ri(Ke.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,ri(Ke.surfaceFun))}(e),Ke.domainViaIndicatorFun&&(e+=d().replace(/indicatorFun/g,ri(Ke.domainIndicatorFun))),e=e.replaceAll("OVERLAYEXPR",ri(Ke.overlayExpr)),e=Va(e),wa(),ke.fragmentShader=e+c(),ke.needsUpdate=!0}function $i(){Ke.numAlgebraicSpecies=Math.min(parseInt(Ke.numAlgebraicSpecies),parseInt(Ke.numSpecies)-1),un=Ke.numAlgebraicSpecies>=Ke.numSpecies-1,cn=Ke.numAlgebraicSpecies>=Ke.numSpecies-2&&Ke.numSpecies>=3,dn=Ke.numAlgebraicSpecies>=Ke.numSpecies-3&&Ke.numSpecies>=4}function Ti(){let e="function of "+vn.slice(0,Ke.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+vn[1]+",",""),n=e.replace(" "+vn[2]+",",""),i=e.replace(" "+vn[3]+",","");switch(1==Ke.dimension?(e=e.replace(" y,",""),Ut.minY.hide()):Ut.minY.show(),Ke.crossDiffusion&&parseInt(Ke.numSpecies)>1?(Yt||xo(Ut.algebraicSpecies,Array.from(Array(parseInt(Ke.numSpecies)).keys())),Ut.algebraicSpecies.show()):Ut.algebraicSpecies.hide(),Ke.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),Ut.Duv.hide(),Ut.Dvu.hide(),Ut.Dvv.hide(),Ut.g.hide(),Ut.initCond_2.hide(),Ut.vBCs.hide(),Ut.Duw.hide(),Ut.Dvw.hide(),Ut.Dwu.hide(),Ut.Dwv.hide(),Ut.Dww.hide(),Ut.h.hide(),Ut.initCond_3.hide(),Ut.wBCs.hide(),Ut.Duq.hide(),Ut.Dvq.hide(),Ut.Dwq.hide(),Ut.Dqu.hide(),Ut.Dqv.hide(),Ut.Dqw.hide(),Ut.Dqq.hide(),Ut.j.hide(),Ut.initCond_4.hide(),Ut.qBCs.hide(),parseInt(Ke.numSpecies)){case 4:Ke.crossDiffusion?(Ut.Duq.show(),Ut.Dvq.show(),Ut.Dwq.show(),Ut.Dqu.show(),Ut.Dqv.show(),Ut.Dqw.show()):(Ut.Dwq.hide(),Ut.Dqu.hide(),Ut.Dvq.hide(),Ut.Duq.hide(),Ut.Dqv.hide(),Ut.Dqw.hide()),Ut.Dqq.show(),Ut.j.show(),Ut.initCond_4.show(),Ut.qBCs.show();case 3:Ke.crossDiffusion?(Ut.Duw.show(),Ut.Dvw.show(),Ut.Dwu.show(),Ut.Dwv.show()):(Ut.Duw.hide(),Ut.Dvw.hide(),Ut.Dwu.hide(),Ut.Dwv.hide()),Ut.Dww.show(),Ut.h.show(),Ut.initCond_3.show(),Ut.wBCs.show();case 2:Ke.crossDiffusion?(Ut.Duv.show(),Ut.Dvu.show()):(Ut.Duv.hide(),Ut.Dvu.hide()),Ut.Dvv.show(),Ut.g.show(),Ut.initCond_2.show(),Ut.vBCs.show()}Ke.crossDiffusion?(pi(Ut.Duu,Sn.Duu,e),pi(Ut.Duv,Sn.Duv,e),pi(Ut.Duw,Sn.Duw,e),pi(Ut.Duq,Sn.Duq,e),pi(Ut.Dvu,Sn.Dvu,e),pi(Ut.Dvv,Sn.Dvv,e),pi(Ut.Dvw,Sn.Dvw,e),pi(Ut.Dvq,Sn.Dvq,e),pi(Ut.Dwu,Sn.Dwu,e),pi(Ut.Dwv,Sn.Dwv,e),pi(Ut.Dww,Sn.Dww,e),pi(Ut.Dwq,Sn.Dwq,e),pi(Ut.Dqu,Sn.Dqu,e),pi(Ut.Dqv,Sn.Dqv,e),pi(Ut.Dqw,Sn.Dqw,e),pi(Ut.Dqq,Sn.Dqq,e)):(pi(Ut.Duu,Sn.Du,e),pi(Ut.Dvv,Sn.Dv,e),pi(Ut.Dww,Sn.Dw,e),pi(Ut.Dqq,Sn.Dq,e)),pi(Ut.f,Sn.UFUN,e),pi(Ut.g,Sn.VFUN,e),pi(Ut.h,Sn.WFUN,e),pi(Ut.j,Sn.QFUN,e),un&&(pi(Ut.Dvu,Sn.Dvu,t),pi(Ut.Dvw,Sn.Dvw,t),pi(Ut.Dvq,Sn.Dvq,t),pi(Ut.g,Sn.VFUN,t),Ut.Dvv.hide()),cn&&(pi(Ut.Dwu,Sn.Dwu,i),pi(Ut.Dwv,Sn.Dwv,i),pi(Ut.Dwq,Sn.Dwq,i),pi(Ut.h,Sn.WFUN,i),Ut.Dww.hide()),dn&&(pi(Ut.Dqu,Sn.Dqu,n),pi(Ut.Dqv,Sn.Dqv,n),pi(Ut.Dqw,Sn.Dqw,n),pi(Ut.j,Sn.QFUN,n),Ut.Dqq.hide()),pi(Ut.uBCs,Sn.u),pi(Ut.vBCs,Sn.v),pi(Ut.wBCs,Sn.w),pi(Ut.qBCs,Sn.q),pi(Ut.dirichletU,Sn.uD),pi(Ut.dirichletV,Sn.vD),pi(Ut.dirichletW,Sn.wD),pi(Ut.dirichletQ,Sn.qD),pi(Ut.neumannU,Sn.uN),pi(Ut.neumannV,Sn.vN),pi(Ut.neumannW,Sn.wN),pi(Ut.neumannQ,Sn.qN),pi(Ut.robinU,Sn.uN),pi(Ut.robinV,Sn.vN),pi(Ut.robinW,Sn.wN),pi(Ut.robinQ,Sn.qN),pi(Ut.initCond_1,Sn.uInit),pi(Ut.initCond_2,Sn.vInit),pi(Ut.initCond_3,Sn.wInit),pi(Ut.initCond_4,Sn.qInit),Ke.domainViaIndicatorFun?Ut.domainIndicatorFun.show():Ut.domainIndicatorFun.hide(),vi(),"surface"==Ke.plotType?($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").hide(),ht.name="3D options",ht.domElement.classList.remove("hidden"),Ut.lineWidthMul.hide(),Ut.threeDHeightScale.show(),Ut.cameraTheta.show(),Ut.cameraPhi.show(),Ut.cameraZoom.show()):"line"==Ke.plotType?($("#contourButton").hide(),$("#embossButton").hide(),$("#vectorFieldButton").hide(),ht.name="Line options",ht.domElement.classList.remove("hidden"),Ut.lineWidthMul.show(),Ut.threeDHeightScale.show(),Ut.cameraTheta.hide(),Ut.cameraPhi.hide(),Ut.cameraZoom.hide()):($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").show(),ht.domElement.classList.add("hidden"),Ut.lineWidthMul.hide(),Ut.threeDHeightScale.hide(),Ut.cameraTheta.hide(),Ut.cameraPhi.hide(),Ut.cameraZoom.hide()),1==Ke.dimension&&$("#vectorFieldButton").hide(),Qi(),Yi(),Xi(),$("#dataContainer").show(),Da(),"line"==Ke.plotType?(Ut.brushType.hide(),$(":root").css("--ui-button-outline","black")):(Ut.brushType.show(),$(":root").css("--ui-button-outline","white")),me?$("#interpController").hide():$("#interpController").show(),"relative"==Ke.arrowScale?Ut.arrowLengthMax.show():Ut.arrowLengthMax.hide(),xo(Ut.whatToDraw,vn.slice(0,Ke.numSpecies)),ba(),Ke.autoPause?Ut.autoPauseAt.show():Ut.autoPauseAt.hide(),"line"==Ke.plotType?(Ut.overlayEpsilon.hide(),Ut.overlayLineWidthMul.show()):(Ut.overlayEpsilon.show(),Ut.overlayLineWidthMul.hide()),Ke.setSeed?Ut.randSeed.show():Ut.randSeed.hide(),$(".toggle_button").each((function(){ya(this)})),jo(),fi(it),fi(ot),fi(at)}function Ai(){let e;switch($i(),Ke.domainViaIndicatorFun&&(["dirichlet","neumann"].includes(Ke.boundaryConditions_1)||(Ke.boundaryConditions_1="dirichlet"),["dirichlet","neumann"].includes(Ke.boundaryConditions_2)||(Ke.boundaryConditions_2="dirichlet"),["dirichlet","neumann"].includes(Ke.boundaryConditions_3)||(Ke.boundaryConditions_3="dirichlet"),["dirichlet","neumann"].includes(Ke.boundaryConditions_4)||(Ke.boundaryConditions_4="dirichlet")),parseInt(Ke.numSpecies)){case 1:Ke.crossDiffusion=!1,Ke.whatToDraw=vn[0],new RegExp("\\b("+_n[1]+")\\b").test(Ke.whatToPlot)&&(Ke.whatToPlot=vn[0]),Ke.diffusionStr_1_2="0",Ke.diffusionStr_1_3="0",Ke.diffusionStr_1_4="0",Ke.diffusionStr_2_1="0",Ke.diffusionStr_2_2="0",Ke.diffusionStr_2_3="0",Ke.diffusionStr_2_4="0",Ke.diffusionStr_3_1="0",Ke.diffusionStr_3_2="0",Ke.diffusionStr_3_3="0",Ke.diffusionStr_3_4="0",Ke.diffusionStr_4_1="0",Ke.diffusionStr_4_2="0",Ke.diffusionStr_4_3="0",Ke.diffusionStr_4_4="0",Ke.boundaryConditions_2="periodic",Ke.initCond_2="0",Ke.reactionStr_2="0",Ke.boundaryConditions_3="periodic",Ke.initCond_3="0",Ke.reactionStr_3="0",Ke.boundaryConditions_4="periodic",Ke.initCond_4="0",Ke.reactionStr_4="0",e=new RegExp("\\b("+_n[1]+")\\b"),e.test(Ke.reactionStr_1)&&(Ke.reactionStr_1="0");break;case 2:Ke.whatToDraw==vn[2]|Ke.whatToDraw==vn[3]&&(Ke.whatToDraw=vn[0]),new RegExp("\\b("+_n[2]+")\\b").test(Ke.whatToPlot)&&(Ke.whatToPlot=vn[0]),Ke.diffusionStr_1_3="0",Ke.diffusionStr_1_4="0",Ke.diffusionStr_2_3="0",Ke.diffusionStr_2_4="0",Ke.diffusionStr_3_1="0",Ke.diffusionStr_3_2="0",Ke.diffusionStr_3_3="0",Ke.diffusionStr_3_4="0",Ke.diffusionStr_4_1="0",Ke.diffusionStr_4_2="0",Ke.diffusionStr_4_3="0",Ke.diffusionStr_4_4="0",Ke.boundaryConditions_3="periodic",Ke.initCond_3="0",Ke.reactionStr_3="0",Ke.boundaryConditions_4="periodic",Ke.initCond_4="0",Ke.reactionStr_4="0",e=new RegExp("\\b("+_n[2]+")\\b"),e.test(Ke.reactionStr_1)&&(Ke.reactionStr_1="0"),e.test(Ke.reactionStr_2)&&(Ke.reactionStr_2="0");break;case 3:Ke.whatToDraw==vn[3]&&(Ke.whatToDraw=vn[0]),new RegExp("\\b("+_n[3]+")\\b").test(Ke.whatToPlot)&&(Ke.whatToPlot=vn[0]),Ke.diffusionStr_1_4="0",Ke.diffusionStr_2_4="0",Ke.diffusionStr_3_4="0",Ke.diffusionStr_4_1="0",Ke.diffusionStr_4_2="0",Ke.diffusionStr_4_3="0",Ke.diffusionStr_4_4="0",Ke.boundaryConditions_4="periodic",Ke.initCond_4="0",Ke.reactionStr_4="0",e=new RegExp("\\b("+_n[3]+")\\b"),e.test(Ke.reactionStr_1)&&(Ke.reactionStr_1="0"),e.test(Ke.reactionStr_2)&&(Ke.reactionStr_2="0"),e.test(Ke.reactionStr_3)&&(Ke.reactionStr_3="0")}switch(ln){case 3:Ke.diffusionStr_2_2="0";break;case 6:Ke.diffusionStr_3_3="0";break;case 7:Ke.diffusionStr_2_2="0",Ke.diffusionStr_3_3="0";break;case 10:Ke.diffusionStr_4_4="0";break;case 11:Ke.diffusionStr_3_3="0",Ke.diffusionStr_4_4="0";break;case 12:Ke.diffusionStr_2_2="0",Ke.diffusionStr_3_3="0",Ke.diffusionStr_4_4="0"}fi(it),fi(ot)}function Vi(){!function(){switch($i(),parseInt(Ke.numSpecies)){case 1:ln=0;break;case 2:ln=Ke.crossDiffusion?1==Ke.numAlgebraicSpecies?3:2:1;break;case 3:if(Ke.crossDiffusion)switch(Ke.numAlgebraicSpecies){case 0:ln=5;break;case 1:ln=6;break;case 2:ln=7}else ln=4;break;case 4:if(Ke.crossDiffusion)switch(Ke.numAlgebraicSpecies){case 0:ln=9;break;case 1:ln=10;break;case 2:ln=11;break;case 3:ln=12}else ln=8}}(),lo(),uo(),Ai(),Ti(),go(),_o(),Pi()}function Pi(){let e,t=yn[ln];const n={U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(Ke.typesetCustomEqs){let o={};o.U=Ke.diffusionStr_1_1,o.UU=Ke.diffusionStr_1_1,o.V=Ke.diffusionStr_2_2,o.VV=Ke.diffusionStr_2_2,o.W=Ke.diffusionStr_3_3,o.WW=Ke.diffusionStr_3_3,o.Q=Ke.diffusionStr_4_4,o.QQ=Ke.diffusionStr_4_4,o.UV=Ke.diffusionStr_1_2,o.UW=Ke.diffusionStr_1_3,o.UQ=Ke.diffusionStr_1_4,o.VU=Ke.diffusionStr_2_1,o.VW=Ke.diffusionStr_2_3,o.VQ=Ke.diffusionStr_2_4,o.WU=Ke.diffusionStr_3_1,o.WV=Ke.diffusionStr_3_2,o.WQ=Ke.diffusionStr_3_4,o.QU=Ke.diffusionStr_4_1,o.QV=Ke.diffusionStr_4_2,o.QW=Ke.diffusionStr_4_3,o.UFUN=Ke.reactionStr_1,o.VFUN=Ke.reactionStr_2,o.WFUN=Ke.reactionStr_3,o.QFUN=Ke.reactionStr_4,Object.keys(o).forEach((function(e){ka(o[e])&&(o[e]="0")}));var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!Wo(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=Eo(o[e],vn,an,"_(?:[xy][xybf]?)")})),Mt.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){rn.includes(e)||(t=function(e,t,n,i){null==i&&(i="  ");let o=n.replace(/\s+/g,"  ").trim();return["0","0.0","-0","-0.0","+0","+0.0"].includes(o)?e.replaceAll(t,""):"1"==o||"1.0"==o?e.replaceAll(t,"$2"):"-1"==o||"-1.0"==o?e.replaceAll(t,i[0]+"-"+i[1]+"$2"):e.replaceAll(t,i[0]+n+i[1]+"$2")}(t,n[e],o[e],"[]"))})),t=so(t,n.UFUN,o.UFUN),t=so(t,n.VFUN,o.VFUN),t=so(t,n.WFUN,o.WFUN),t=so(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}\(\)]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\(\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"\\lap $1"),e=/\\vnabla\s*\\cdot\s*\(\s*((?!\\vnabla).*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b(?:[xy]|[uvwq](?:_[xy])?|(?:I_[ST][RGBA]?))\b/g.test(t)?e:t.trim()+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])[fb]?2?\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else Mt.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{ "+t+" ";return"string"==typeof n&&(i+=n),i+" }"}))})),t=Eo(t,["UFUN","VFUN","WFUN","QFUN"],rn);1==Ke.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=Eo(t,an.concat(rn),vn.concat(wn),"_(?:[xy][xybf]?)"),t=Ui(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(So)}function Ui(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=ki(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=ki(e,"cos",!0),e=ki(e,"tan",!0),e=ki(e,"exp",!0),e=ki(e,"log",!0),e=ki(e,"sqrt",!1),e=ki(e,"sinh",!0),e=ki(e,"cosh",!0),e=ki(e,"tanh",!0),e=ki(e,"max",!0),e=ki(e,"min",!0),e=si(e=(e=ki(e,"ind",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",s="";for(var l=0;l<e.length;l++)t.includes(e[l])?(i+=1,o+=1):n.includes(e[l])&&(i-=1),0==i&&o>0&&(r=e.slice(a,l+1),s+=qi(r,o),o=0,a=l+1);return s+=e.slice(a),s}(e=de(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")).replaceAll(/<=/g," \\leq ")).replaceAll(/>=/g," \\geq ")).replaceAll(/([<>])/g," $1 ")}function ki(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,s,l,u,c,d,h=0;for(const f of o){for(a=f.index,r=a+t.length,l=e.slice(r),d=0,u=0,c=!1;d<=l.length&(!c|!(c&&0==u));)u+=["(","["].includes(l[d]),u-=[")","]"].includes(l[d]),c|=u,d+=1;c&&0==u&&(s=d-1+r,i=Ii(i,"\\",a+h),h+=1,n?(i=Ii(i,"{",r+h),h+=1,i=Ii(i,"}",s+1+h),h+=1):(i=Ri(i,"{",r+h),i=Ri(i,"}",s+h)))}return i}function qi(e,t){const n=["(","["],i=[")","]"];let o=Mi(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=Ri(e,n[o],a),o+=1,o=Mi(o,n.length)):i.includes(e[a])&&(o-=1,o=Mi(o,n.length),e=Ri(e,i[o],a));return e}function Mi(e,t){return(e%t+t)%t}function Ri(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function Ii(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Li(e){return e=e.replace(/\s+/g,"  ").trim()}function Ni(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=en[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);en[e]=en[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),fi(At),Bi(),Hn(),(go()||jt)&&(jt=!1,_o())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)tn.push(e),en[e]="",n=At.add(en,e).name(""),Sa(n.domElement.firstChild),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=tn.indexOf(e);let n=Li(en[tn.at(t)]);if(""==n);else{let e=Ni(tn.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);if(i){let t=i[1];Aa(t),e.lastName=t,nn[t]=e}on+=1;let o="params"+on;this.remove(),Ni(o,!0),Bi(),(go()||jt)&&(jt=!1,_o())}}));else{n=At.add(en,e).name(""),Sa(n.domElement.firstChild),n.domElement.classList.add("params");const t=en[e].match(/\s*(\w+)\s*=/);if(t){let e=t[1];Aa(e),n.lastName=e,nn[e]=n}n.onFinishChange((function(){let t=Li(en[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=tn.indexOf(e);tn.splice(t,1),delete en[e],n.hasOwnProperty("lastName")&&!ro(n.lastName)&&delete et[n.lastName]}else{i();const e=yo(t).match(/\s*(\w+)\s*=/);if(e){let t=e[1];Aa(t),n.hasOwnProperty("lastName")&&n.lastName!=t&&!ro(n.lastName)&&(delete et[n.lastName],n.lastName=t,nn[t]=n)}}Bi(),go()&&_o()}))}return i(),Sa(n.domElement.firstChild),n}function Bi(){Ke.kineticParams=Object.values(en).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function Oi(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function Wi(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function ji(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function Qi(){if(Ke.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+To(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==Ke.whatToPlot?($("#minLabel").html("$"+vn[0]+"$"),$("#midLabel").html("$"+vn[1]+"$"),$("#maxLabel").html("$"+vn[2]+"$")):Bt?$("#midLabel").html(Ke.views[Ke.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+Ui(Ke.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),ho(),zi()}else $("#colourbar").hide()}function zi(){if("MAX"!=Ke.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[Hi(e,n),Hi(t,n)]}(Ke.minColourValue,Ke.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=Co(To(0)),t=Co(To(.5)),n=Co(To(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function Gi(e,t){return e.toPrecision(t)}function Hi(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function Yi(){Ke.timeDisplay?($("#timeDisplay").show(),Ji()):$("#timeDisplay").hide(),Ki()}function Ji(){if(Ke.timeDisplay){let e=Gi(et.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/,"  10<sup>$2$3<sup>"),$("#timeValue").html(e),no()}}function Xi(){if(Ke.integrate){$("#integralDisplay").show();let e="";1==Ke.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+Ui(Ke.whatToPlot)+"\\,\\d x",1==Ke.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();Ki()}function Zi(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function Ki(){Ke.integrate&&Ke.timeDisplay?Zi("#timeDisplay",10):Zi("#timeDisplay",0)}function eo(){let e=Fi();!Nt||isFinite(e[0])&&isFinite(e[1])?vt=setTimeout(eo,1e3):(Nt=!1,Wi("#oops_hit_nan"),ti(),$("#erase").one("pointerdown",(function(){ji("#oops_hit_nan"),Nt=!0,window.clearTimeout(vt),vt=setTimeout(eo,1e3)})))}function to(){if(!gn){try{we.readRenderTargetPixels(De,0,0,St,Ct,hn)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}gn=!0}}function no(){if(Ke.colourbar&&(Ke.integrate||Ke.timeDisplay)){let e,t=$("#colourbar")[0].getBoundingClientRect();e=Ke.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(Zi("#dataContainer",40),Wt=!0):Wt&&(Zi("#dataContainer",0),Wt=!1)}}function io(){oo()?(Vt.forEach((e=>{e.texture.magFilter=K.NearestFilter})),De.texture.magFilter=K.NearestFilter,xe.texture.magFilter=K.NearestFilter):(Vt.forEach((e=>{e.texture.magFilter=K.LinearFilter})),De.texture.magFilter=K.LinearFilter,xe.texture.magFilter=K.LinearFilter),Ti()}function oo(){return me||Ke.forceManualInterpolation}function ao(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function ro(e,t){return null==t&&(t=[]),function(e){return[...(m()+D()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e).concat(["I_T","I_TR","I_TG","I_TB","I_TA","I_S","I_SR","I_SG","I_SB","I_SA"])}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function so(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function lo(){"line"==Ke.plotType?(Vo(),Ke.brushType="vline",Qn(),fi(ot),Oe.visible=!1,Qe.visible=!0,Ke.contours=!1,Ke.emboss=!1,Ke.vectorField=!1,$a()):(Oe.visible=!0,Qe.visible=!1,"surface"==Ke.plotType?($("#simCanvas").css("outline","2px #000 solid"),Jt&&(Jt=!1,qn()),Ke.vectorField=!1,$a()):$("#simCanvas").css("outline","")),ze.visible=Ke.overlay&&"line"==Ke.plotType,zn(),Mn(),Ti(),Ua()}function uo(){Rt||(1!=Ke.dimension&&"line"==Ke.plotType&&(Ke.plotType="plane",Yo("plotType"),lo()),1==Ke.dimension&&"line"!=Ke.plotType&&(Ke.plotType="line",Ke.vectorField=!1,Yo("plotType"),lo())),1==Ke.dimension&&(Ke.minY="0.0"),kn(),li(),Pi(),Ti(),Xi()}function co(){const e="line"==Ke.plotType?0:Ke.cameraTheta,t="line"==Ke.plotType?0:Ke.cameraPhi,n=(new K.Vector3).setFromSphericalCoords(1,Math.PI/2-e*Math.PI/180,-t*Math.PI/180);pe.position.set(n.x,n.y,n.z),pe.lookAt(0,0,0)}function ho(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function fo(){return Ke.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function mo(e){return yo(e)}function po(){const e=/^\s*([a-zA-Z]\w*)\b/;let t=[];return fo().split(";").filter((e=>e.length>0)).forEach((function(n){n.match(e)&&t.push(n.match(e)[1].trim())})),t}function go(){fo().split(";").filter((e=>e.length>0));const e=function(e){let t={},n={},i=[];const o=function(){const e=/^\s*([a-zA-Z]\w*)\b\s*=\s*(.*)/;let t=[];return fo().split(";").filter((e=>e.length>0)).forEach((function(n){const i=n.match(e);i?t.push([i[1].trim(),i[2].trim()]):Oo("Unable to evaluate the parameter definition '"+n+"'. Please check for syntax errors.")})),t}(),a=o.map((e=>e[0]));o.forEach((e=>t[e[0]]=e[1]));for(const e of o){let[o,r]=e;o in n||([n,,i]=wo(o,t,n,[o],a,[]))}i.length>0&&Oo("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.");return Object.keys(n).map((e=>[e,n[e]]))}(),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}(po());if(t.length>0)return Oo("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=bo(t[0],t[1]);n|=e,i|=o}return n&&!i}function bo(e,t){let n=!1,i=!1;const o=mo(e);return ro(o)?(Oo("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!et.hasOwnProperty(o),et[o]={type:"float",value:t}),[n,i]}function vo(){return mo(po().map((e=>"uniform float "+e+";")).join("\n"))}function wo(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const s of o)r=new RegExp("\\b"+s+"\\b","g"),r.test(t[e])&&(i.includes(s)?(n[s]=0,t[s]="0",t[e]="0",a.push(i.slice(i.indexOf(s)))):([n,,a]=wo(s,t,n,[...i,s],o,a),t[e]=t[e].replaceAll(r,n[s].toString())));try{n[e]=Dn.evaluate(t[e])}catch(t){Oo("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function _o(){li(),_i(),Qn(),Di(),jn(),Ei()}function yo(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+bn[e])););return n}function So(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function Co(e){return e.reduce(((e,t)=>e+t),0)/3}function Do(){let e=Fi();Ke.minColourValue=e[0],Ke.maxColourValue=e[1],et.maxColourValue.value=Ke.maxColourValue,et.minColourValue.value=Ke.minColourValue,Ut.maxColourValue.updateDisplay(),Ut.minColourValue.updateDisplay(),zi()}function xo(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function Fo(){let e;null!=vn&&(e=vn);const t=Ke.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,an.length),n=t.concat(sn.slice(t.length)),i=po();let o;for(var a=0;a<n.length;a++)if(ro(n[a],i))return o=i.includes(n[a])?"as a parameter":"under the hood",void Oo("The name '"+n[a]+"' is used "+o+", so can't be used as a species name. Please use a different name for "+n[a]+".");vn=n,wn=vn.map((e=>"f_{"+e+"}")),function(){_n=[];for(let e=0;e<vn.length;e++)_n.push("(?:"+vn.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let r={...le(),...ce()};if(Object.keys(r).forEach((function(e){Sn[e]=Ui(Eo(r[e],an,vn,"_(?:[xy][xybf]?)"))})),r=ue(),Object.keys(r).forEach((function(e){Sn[e]=Ui(Eo(r[e],rn,wn))})),Rt)return;const s=["initCond_1","initCond_2","initCond_3","initCond_4","kineticParams"];Object.keys(Ke).forEach((function(t){xn.includes(t)&&(s.includes(t)||(Ke[t]=Eo(Ke[t],e,vn,"_(?:[xy][xybf]?)")))})),Ke.views=Ke.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){xn.includes(i)&&(n[i]=Eo(t[i],e,vn,"_(?:[xy][xybf]?)"))})),n})),Object.keys(nt).forEach((function(t){xn.includes(t)&&(s.includes(t)||(nt[t]=Eo(nt[t],e,vn,"_(?:[xy][xybf]?)")))})),nt.views=nt.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){xn.includes(i)&&(n[i]=Eo(t[i],e,vn,"_(?:[xy][xybf]?)"))})),n})),Ai(),Ti(),_o(),Pi()}function Eo(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function $o(e,t){let n,i=e.geometry.attributes.instanceStart,o=e.geometry.attributes.instanceEnd;for(let e=0;e<t.length;e++)n=t[e].toArray(),n[1]*=Ke.threeDHeightScale*xt/Ft,e<t.length&&i.setXYZ(e,n[0],n[1],0),e>0&&o.setXYZ(e-1,n[0],n[1],0);i.needsUpdate=!0,o.needsUpdate=!0}function To(e){e=e.clamp(0,1);let t=0;for(;e>=Ze[t+1]&&t<Xe.length-2;)t+=1;return Ze[t+1]==Ze[t]?Xe[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=Ao(e[o],t[o],n);return i}(Xe[t],Xe[t+1],(e-Ze[t])/(Ze[t+1]-Ze[t])).map((e=>e.clamp(0,1)))}function Ao(e,t,n){return(1-(n=n.clamp(0,1)))*e+n*t}function Vo(){qe.linewidth=.01*Ke.lineWidthMul,Me.linewidth=.01*Ke.overlayLineWidthMul,qe.needsUpdate=!0,Me.needsUpdate=!0}function Po(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function Uo(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function ko(e){e.forEach((function(e){Mt.add(e)})),Pi()}function qo(e){e.forEach((function(e){Mt.delete(e)})),Pi()}function Mo(){fn=new Float32Array(St*Ct*4),we.readRenderTargetPixels(Vt[1],0,0,St,Ct,fn),No(fn),zt=!0}function Ro(){zt||Mo();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([St,Ct]),fn])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function Io(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);No(e.slice(2),e.slice(0,2)),Lo(Ee),zt=!0,ii()},t.readAsArrayBuffer(e)}function Lo(e){if(null!=e)if("crop"==Ke.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=_e/t;i>1&&(n=t/_e,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function No(e,t){null!=Ee&&Ee.dispose(),null==t&&(t=[St,Ct]),Ee=new K.DataTexture(e,t[0],t[1],K.RGBAFormat,K.FloatType),Ee.needsUpdate=!0,Ee.magFilter=me?K.NearestFilter:K.LinearFilter,null!=Le&&(Le.map=Ee,Le.needsUpdate)}function Bo(){we.setSize(Math.round(devicePixelRatio*$t),Math.round(devicePixelRatio*Tt),!1)}function Oo(e){ti(),Rt&&It||(It=!0,$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),Wi("#error")))}function Wo(e){if(/\(\s*\)/.test(e))return Oo("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(Oo("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(Oo("A binary operator is missing an operand in "+e.trim()+"."),!1)}function jo(){let e;$("#views_list").empty();for(let t=0;t<Ke.views.length;t++)e=document.createElement("a"),e.onclick=function(){Ke.activeViewInd=t,Qo(Ke.views[t])},e.innerHTML="<div class='view_label'>"+Ke.views[t].name+"</div>",t==Ke.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);Gt=Math.max(Ke.views.length,Gt),Ke.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),Ke.views.length}function Qo(e,t){Object.assign(Ke,e),delete Ke.name,fi(at),(null==t||t)&&(Di(),lo(),zn(),Rn(),zi(),Qi(),$a(),ba(),Hn())}function zo(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",Ke.views[Ke.activeViewInd].name);null!=e&&(Ke.views[Ke.activeViewInd].name=e,jo(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function Go(){Ke.views.length>1?(Ke.views.splice(Ke.activeViewInd,1),Ke.activeViewInd<1?Ke.activeViewInd=0:Ke.activeViewInd-=1):Ke.views[Ke.activeViewInd].name="Custom",Qo(Ke.views[Ke.activeViewInd])}function Ho(){let e={};return Cn.forEach((function(t){e[t]=nt[t]})),e}function Yo(e){Ke.activeViewInd<Ke.views.length&&(Ke.views[Ke.activeViewInd][e]=Ke[e])}function Jo(e,t){let n="";return n+=gi(g(t),vn[e]),Ke.dimension>1&&(n+=gi(b(t),vn[e])),n}function Xo(e,t){let n="";return n+=gi(w(t),vn[e]),Ke.dimension>1&&(n+=gi(_(t),vn[e])),n}function Zo(e,t){let n="";return n+=gi(y(t,ri(Ke.domainIndicatorFun)),vn[e]),Ke.dimension>1&&(n+=gi(S(t,ri(Ke.domainIndicatorFun)),vn[e])),n}function Ko(e,t){let n="";return n+=gi(g(t).replaceAll(/updated/g,"gl_FragColor"),vn[e]),Ke.dimension>1&&(n+=gi(b(t).replaceAll(/updated/g,"gl_FragColor"),vn[e])),n}function ea(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function ta(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function na(e,t,n,i,o,a,r,s){const l=document.createElement("a");if(l.classList.add("toggle_button"),l.setAttribute("property",t),null==i&&(i=()=>{}),l.onclick=function(){Ke[l.getAttribute("property")]=!Ke[l.getAttribute("property")],ya(l),i()},null!=o&&(l.id=o),null!=a&&(l.title=a),null!=n&&(l.innerHTML=n),null!=r&&l.setAttribute("folderID",r),null!=s)for(const e of s)l.classList.add(e);return e.appendChild(l),ya(l),l}function ia(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function oa(){const e=Object.assign(z("default"),z(Ke.parent));let t=xi(Ke,e);1==Ke.views.length&&"1"==Ke.views[0].name&&delete t.views;for(const e of Object.keys(Ke.views[0]))Ke.hasOwnProperty(e)&&Ke.views.map((t=>t[e])).every((t=>t==Ke[e]))&&Ke.views.forEach((t=>delete t[e]));t.preset="PRESETNAME";let n=JSON.stringify(t).replaceAll(/(:[^:]*),/g,"$1,\n\t").replaceAll(":",": ").replaceAll("  "," ").replaceAll("{","{\n\t").replaceAll("}",",\n}");n='listOfPresets["PRESETNAME"] = '+n+";\n",navigator.clipboard.writeText(n)}function aa(){let e="";e+=JSON.stringify(Ke),e+=JSON.stringify(et),e+=JSON.stringify({nXDisc:St,nYDisc:Ct,domainHeight:xt,domainWidth:Dt,aspectRatio:_e,canvas:he.getBoundingClientRect()}),navigator.clipboard.writeText(e)}function ra(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function sa(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function la(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function ua(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function ca(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function da(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function ha(){let e=xi(Ke,z("default"));return e.preset="Custom",e=oe(e),[location.href.replace(location.search,""),"?options=",re.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function fa(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function ma(e){const t=nn[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function pa(){et.embossAmbient.value=Ke.embossAmbient,et.embossDiffuse.value=Ke.embossDiffuse,et.embossShiny.value=Ke.embossShiny,et.embossSmoothness.value=Ke.embossSmoothness,et.embossSpecular.value=Ke.embossSpecular,et.embossLightDir.value=new K.Vector3(Math.sin(Ke.embossTheta)*Math.cos(Ke.embossPhi),Math.sin(Ke.embossTheta)*Math.sin(Ke.embossPhi),Math.cos(Ke.embossTheta))}function ga(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function ba(){for(const e of[...qt,...kt]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function va(){et.contourColour.value=new K.Color(Ke.contourColour),et.contourEpsilon.value=Ke.contourEpsilon,et.contourStep.value=1/(Ke.contourNum+1)}function wa(){et.overlayColour.value=new K.Color(Ke.overlayColour),et.overlayEpsilon.value=Ke.overlayEpsilon,et.overlayLine.value=Ke.overlay&&"line"==Ke.plotType,Me.color=new K.Color(Ke.overlayColour),Me.needsUpdate=!0}function _a(){mt||Hn()}function ya(e){Ke[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function Sa(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function Ca(){Ke.customSurface?Te.vertexShader=O():Te.vertexShader=B(),Te.needsUpdate=!0}function Da(){"surface"==Ke.plotType?($(st).show(),Ke.customSurface?(Ut.surfaceFun.show(),Ut.threeDHeightScale.hide()):(Ut.surfaceFun.hide(),Ut.threeDHeightScale.show())):($(st).hide(),Ut.surfaceFun.hide())}function xa(){Je=new K.Group,be.add(Je);const e=Math.max(St,Ct),t=Math.round(Ao(3,window.width<629?20:64,Ke.arrowDensity));let n=Math.max(Math.floor(e/t),1);const i=Math.floor(St/n),o=Math.floor(Ct/n),a=Math.floor((St-n*(i-1))/2),r=Math.floor((Ct-n*(o-1))/2);let s,l,u,c,d,h;for(let e=0;e<o;e++){l=r+e*n,h=((l+.5)/Ct-.5)*Oe.geometry.parameters.height;for(let e=0;e<i;e++)u=a+e*n,d=((u+.5)/St-.5)*Oe.geometry.parameters.width,s=u+l*St,c=Fa([d,h,1],[0,0,0]),c.ind=s,Je.add(c)}}function Fa(e,t){const n=new K.Group,i=new K.Mesh(Ne,Re);i.rotation.x=Math.PI/2;const o=new K.Mesh(Be,Re);return o.rotation.x=Math.PI/2,o.rotation.y=Math.PI/4,o.position.z=Ne.parameters.height/2,n.add(i),n.add(o),n.scale.multiplyScalar(Kt),n.position.set(e[0],e[1],e[2]),n.lookAt(e[0]+t[0],e[1]+t[1],e[2]+t[2]),n}function Ea(){if(Je)for(be.remove(Je);Je.children.length;)Je.remove(Je.children[0])}function $a(){if(et.vectorField.value=Ke.vectorField,Ke.vectorField){if(Ea(),xa(),Ta(),"relative"==Ke.arrowScale)try{Je.customMax=Dn.evaluate(Ke.arrowLengthMax)}catch(e){Oo("Unable to evaluate the maximum arrow length. Please check the definition."),Je.customMax=1}}else Ea()}function Ta(){Re.color=new K.Color(Ke.arrowColour)}function Aa(e){const t=ro(e,vn.concat(wn));return t&&Oo("The name '"+e+"' is already in use, so can't be used as a parameter name. Please use a different name for "+e+"."),!t}function Va(e){return e=(e=e.replaceAll(/\bMINX\b/g,(()=>ri(Ke.minX)))).replaceAll(/\bMINY\b/g,(()=>ri(Ke.minY)))}function Pa(e,t,n,i,o){if(e in t)return[t,n.slice(0,-1),o];for(const a of i[e])n.includes(a)?o.push(n.slice(n.indexOf(a))):[t,,o]=Pa(a,t,[...n,a],i,o);return t[e]=!0,[t,n.slice(0,-1),o]}function Ua(){if($("#simCanvas").css("cursor","auto"),Ke.brushEnabled&&"surface"!=Ke.plotType&&"line"!=Ke.plotType)switch(Ke.brushType){case"circle":$("#simCanvas").css("cursor","url('images/cursor-circle.svg') 12 12, auto");break;case"hline":$("#simCanvas").css("cursor","url('images/cursor-hline.svg') 32 32, auto");break;case"vline":$("#simCanvas").css("cursor","url('images/cursor-vline.svg') 32 32, auto")}}function ka(e){return/^\s*$/.test(e)}function qa(){const e=Shepherd.activeTour?.getCurrentStep(),t=e?.getElement(),n=t?.querySelector(".shepherd-header"),i=document.createElement("span");i.classList.add("shepherd-progress"),i.innerText=`${Shepherd.activeTour?.steps.indexOf(e)+1} / ${Shepherd.activeTour?.steps.length}`,n?.insertBefore(i,t.querySelector(".shepherd-cancel-icon"))}function Ma(e,t){const n=Shepherd.activeTour?.getCurrentStep(),i=n?.getElement(),o=i?.querySelector(".shepherd-footer"),a=document.createElement("a");a.setAttribute("href",e),a.setAttribute("target","_blank"),a.classList.add("shepherd-more-info"),a.innerText=t||"More info.",o?.insertBefore(a,o.firstChild)}(Oi()||Tn||Ke.forceTryClickingPopup)&&!Ke.suppressTryClickingPopup&&Ke.brushEnabled&&($("#top_message").html("<p>"+Ke.tryClickingText+"</p>"),Wi("#top_message"),setTimeout((()=>ji("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>ji("#top_message")))),Rt=!1,function e(){requestAnimationFrame(e),gt=pt,pt&&Ke.brushEnabled&&function(){!Ke.setSeed&&Ke.brushValue.includes("RAND")&&wi();We.material=Ae;for(let e=1;e<Vt.length;e++)et.textureSource.value=Vt[e].texture,we.setRenderTarget(Vt[e-1]),we.render(ve,ge);Vt.rotate(-1)}();if(mt){!bt||function(){We.material=Ve;for(let e=1;e<Vt.length;e++)et.textureSource.value=Vt[e].texture,we.setRenderTarget(Vt[e-1]),we.render(ve,ge);Vt.rotate(-1)}();for(let e=0;e<Ke.numTimestepsPerFrame;e++){if(Ke.autoPause&&Lt&&et.t.value>=Ke.autoPauseAt){Lt=!1,ti();break}Ot&&!Ke.setSeed&&wi(),Gn()}}(gt||mt)&&Hn()}()}();