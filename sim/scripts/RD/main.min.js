let e,t,n,i,o,a,r,l,s,u,c,d,f,p,m,h,g,v,b,S,y,w,C,x,V,F,U,E,_,D,A,T,W,P,Q,R,k,M,I,N,L,q,O,B,j,z,G,J,H,X,Y,Z,K,ee,te,ne,ie,oe,ae,re,le,se,ue,ce,de,fe,pe,me,he,ge,ve,be,Se,ye,we,Ce,xe,Ve,Fe,Ue,$e,Ee,_e,De,Ae,Te,We,Pe,Qe,Re,ke,Me,Ie,Ne,Le,qe,Oe,Be,je,ze,Ge,Je,He,Xe,Ye,Ze,Ke,et,tt,nt,it,ot,at,rt,lt,st,ut,ct,dt,ft,pt,mt,ht,gt,vt,bt,St,yt,wt,Ct,xt,Vt,Ft,Ut,$t,Et,_t=[],Dt={},At=[],Tt=[],Wt=new Set,Pt=!0,Qt=!1,Rt=!0,kt=!0,Mt=!1,It=!1,Nt=!1,Lt=!1,qt=!1,Ot=!1,Bt=0,jt=!1,zt=!0,Gt=1,Jt=1,Ht=.15,Xt={},Yt=[],Zt={},Kt=0;const en=["u","v","w","q"],tn=["UFUN","VFUN","WFUN","QFUN"],nn=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"];let on,an,rn,ln,sn,un,cn,dn=!1,fn=!1;const pn=["zero","one","two","three","four","five","six","seven","eight","nine"];import{drawShaderTop as mn,drawShaderBotReplace as hn,drawShaderBotAdd as gn,drawShaderShapeDisc as vn,drawShaderShapeVLine as bn,drawShaderShapeHLine as Sn,drawShaderFactorSharp as yn,drawShaderFactorSmooth as wn}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as Cn,computeDisplayFunShaderMid as xn,computeMaxSpeciesShaderMid as Vn,postGenericShaderBot as Fn,postShaderDomainIndicator as Un,interpolationShader as $n}from"./post_shaders.js";import{copyShader as En}from"../copy_shader.js";import{RDShaderTop as _n,RDShaderBot as Dn,RDShaderDirichletX as An,RDShaderDirichletY as Tn,RDShaderDirichletIndicatorFun as Wn,RDShaderRobinX as Pn,RDShaderRobinY as Qn,RDShaderUpdateNormal as Rn,RDShaderUpdateCross as kn,RDShaderAlgebraicSpecies as Mn,RDShaderEnforceDirichletTop as In,RDShaderAdvectionPreBC as Nn,RDShaderAdvectionPostBC as Ln,RDShaderDiffusionPreBC as qn,RDShaderDiffusionPostBC as On,RDShaderGhostX as Bn,RDShaderGhostY as jn,RDShaderMain as zn}from"./simulation_shaders.js";import{randShader as Gn,randNShader as Jn}from"../rand_shader.js";import{fiveColourDisplayTop as Hn,fiveColourDisplayBot as Xn,embossShader as Yn,contourShader as Zn,surfaceVertexShaderColour as Kn,surfaceVertexShaderCustom as ei,overlayShader as ti}from"./display_shaders.js";import{getColours as ni}from"../colourmaps.js";import{genericVertexShader as ii}from"../generic_shaders.js";import{getPreset as oi,getUserTextFields as ai,getFieldsInView as ri}from"./presets.js";import{clearShaderBot as li,clearShaderTop as si}from"./clear_shader.js";import*as ui from"../three.module.min.js";import{OrbitControls as ci}from"../OrbitControls.js";import{Line2 as di}from"../lines/Line2.js";import{LineMaterial as fi}from"../lines/LineMaterial.js";import{LineGeometry as pi}from"../lines/LineGeometry.js";import{minifyPreset as mi,maxifyPreset as hi}from"./minify_preset.js";import{LZString as gi}from"../lz-string.min.js";import{equationTEXFun as vi,getDefaultTeXLabelsDiffusion as bi,getDefaultTeXLabelsReaction as Si,getDefaultTeXLabelsBCsICs as yi,substituteGreek as wi}from"./TEX.js";let Ci,xi,Vi,Fi=vi(),Ui={...bi(),...Si(),...yi()};const $i=ri();let Ei=new exprEval.Parser;Ei.consts.pi=Math.PI,Ei.consts.Pi=Math.PI,Ei.consts.e=Math.exp(1),q={};const _i=ai();var Di,Ai;B={reset:function(){oo()},toggleRunning:function(){pt?no():io()},copyConfigAsURL:function(){hr(mr())},saveSimState:function(){Ia()},exportSimState:function(){Na()},clearCheckpoints:function(){Ot&&(h.dispose(),h=null,Ot=!1)},restoreCurrentView:function(){var e;q.activeViewInd<q.views.length&&(e=q.activeViewInd,q.views[e]=St[e],Ja(q.views[e]))}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(Di=Array.prototype.push,Ai=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,Di.apply(this,Ai.call(this,0,e)),this}),Array.prototype.last=function(){return this[this.length-1]},e=document.getElementById("simCanvas"),console.error=function(e){Lt=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),ja(t)},zo()||$("#logo").hide();const Ti=new URLSearchParams(window.location.search);if(Ti.has("no_ui")?($(".ui").addClass("hidden"),qt=!0):$(".ui").removeClass("hidden"),Ti.has("logo_only")&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),qt=!0),Ti.has("sf")&&(Jt=parseFloat(Ti.get("sf")),(isNaN(Jt)||Jt<=0)&&(Jt=1)),!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("warning"==e[t].split("=")[0].trim())return!0}return!1}()&&!qt){$("#warning").css("display","block");await Promise.race([ua(document.getElementById("warning_ok"),"click",!0),ua(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="warning=true;"+t+";path=/"}(),$("#warning").css("display","none")}mo("default"),function(){O={brushCoords:{type:"v2",value:new ui.Vector2(.5,.5)},colour1:{type:"v4",value:new ui.Vector4(0,0,0,0)},colour2:{type:"v4",value:new ui.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new ui.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new ui.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new ui.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},overlayLine:{type:"bool",value:!0},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},vectorField:{type:"bool",value:!1}},mt=!1,c=new ui.Raycaster,d=new ui.Vector2,l=new ui.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),l.autoClear=!0,t=l.getContext(),n=!(t.getExtension("OES_texture_float_linear")&&t.getExtension("EXT_float_blend")),m={format:ui.RGBAFormat,type:ui.FloatType,minFilter:ui.NearestFilter},n|=/android/i.test(navigator.userAgent),m.magFilter=n?ui.NearestFilter:ui.LinearFilter,_t.push(new ui.WebGLRenderTarget(q.maxDisc,q.maxDisc,m)),_t.push(_t[0].clone()),_t.push(_t[0].clone()),_t.push(_t[0].clone()),_t.push(_t[0].clone()),f=_t[0].clone(),p=_t[0].clone(),_t.forEach((e=>{e.texture.wrapS=ui.RepeatWrapping,e.texture.wrapT=ui.RepeatWrapping})),f.texture.wrapS=ui.ClampToEdgeWrapping,f.texture.wrapT=ui.ClampToEdgeWrapping,p.texture.wrapS=ui.ClampToEdgeWrapping,p.texture.wrapT=ui.ClampToEdgeWrapping,i=new ui.OrthographicCamera(-.5,.5,.5,-.5,-1,10),u=new ci(i,e),u.listenToKeyEvents(document),u.addEventListener("change",(function(){"surface"==q.plotType&&(q.cameraTheta=90-180*Math.acos(i.position.y)/Math.PI,q.cameraPhi=-180*Math.atan2(i.position.x,i.position.z)/Math.PI,q.cameraZoom=i.zoom,Za("cameraTheta"),Za("cameraPhi"),Za("cameraZoom"),ho(J),Cr())})),o=new ui.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new ui.Scene,r=new ui.Scene,a.add(i),a.background=new ui.Color(q.backgroundColour),g=new ui.MeshBasicMaterial({side:ui.DoubleSide}),v=new ui.ShaderMaterial({uniforms:O,vertexShader:ii(),transparent:!0,side:ui.DoubleSide}),C=new ui.ShaderMaterial({uniforms:O,vertexShader:ii()}),U=new ui.ShaderMaterial({uniforms:O,vertexShader:ii(),fragmentShader:$n()}),b=new ui.ShaderMaterial({uniforms:O,vertexShader:ii()}),Dt.FE=new ui.ShaderMaterial({uniforms:O,vertexShader:ii()}),Dt.AB2=new ui.ShaderMaterial({uniforms:O,vertexShader:ii()});for(let e=1;e<3;e++)Dt["Mid"+e.toString()]=new ui.ShaderMaterial({uniforms:O,vertexShader:ii()});for(let e=1;e<5;e++)Dt["RK4"+e.toString()]=new ui.ShaderMaterial({uniforms:O,vertexShader:ii()});w=new ui.ShaderMaterial({uniforms:O,vertexShader:ii(),fragmentShader:En()}),y=new ui.ShaderMaterial({uniforms:O,vertexShader:ii()}),S=new ui.ShaderMaterial({uniforms:O,vertexShader:ii()}),x=new fi({vertexColors:!0,linewidth:.01}),V=new fi({color:0,linewidth:.01}),F=new ui.MeshBasicMaterial({color:q.arrowColour,side:ui.DoubleSide}),E=new ui.MeshBasicMaterial,_=new ui.CylinderGeometry(.008,.008,.1),D=new ui.ConeGeometry(.04,.04,4);const s=new ui.PlaneGeometry(1,1);T=new ui.Mesh(s,Dt[0]),T.position.z=0,r.add(T),Ni(),Li(),ki(),Oi(),Qi(),Bi(),Wo(),Qo(),zi(),ji(),Vo(),la(),oo(),e.addEventListener("pointerdown",Yi),e.addEventListener("pointerup",Zi),e.addEventListener("pointermove",Ki),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(B.toggleRunning(),e.preventDefault()),"h"===e.key&&(qt?(qt=!1,$(".ui").removeClass("hidden"),ut.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",yt),pt?io():no(),ra(),ha(),Fa()):(qt=!0,$(".ui").addClass("hidden"))),"s"==e.key&&Ia(),"c"==e.key&&(q.resetFromCheckpoints=!q.resetFromCheckpoints,xr($("#checkpointButton")[0])))})),window.addEventListener("resize",(function(){Qi(),Cr()}),!1),window.addEventListener("message",gr),$("#checkpointInput").change((function(){La(this.files[0]),this.value=null}))}();let Wi=!0;if(Ti.has("preset")&&(po(Ti.get("preset")),Wi=!1),Ti.has("options")){var Pi=JSON.parse(gi.decompressFromEncodedURIComponent(Ti.get("options")));Pi.hasOwnProperty("p")&&(Pi=hi(Pi)),po(Pi),Wi=!1}function Qi(){Ni(),function(){T.material=w;for(let e=1;e<_t.length;e++)O.textureSource.value=_t[e].texture,_t[e-1].setSize(wt,Ct),l.setRenderTarget(_t[e-1]),l.render(r,o);_t.rotate(-1),_t[0].dispose(),_t[0]=_t[1].clone(),f.setSize(wt,Ct),Xi(),p.setSize(Math.round(devicePixelRatio*Ut),Math.round(devicePixelRatio*$t))}(),qa(h),Mi(),Ri(),Dr(),ki(),ha(),Fa()}function Ri(){A.geometry.dispose(),a.remove(A),W.geometry.dispose(),a.remove(W),P.geometry.dispose(),a.remove(P),Q.geometry.dispose(),a.remove(Q),Li()}function ki(){switch(Ii(),q.plotType){case"line":q.cameraTheta=0,q.cameraPhi=0,u.enabled=!1,i.zoom=1,ma(),v.vertexShader=Kn();break;case"plane":u.enabled=!1,u.reset(),v.vertexShader=ii();break;case"surface":u.enabled=!0,i.zoom=q.cameraZoom,ma(),Fr()}v.needsUpdate=!0,i.left=-xt/(2*Ft),i.right=xt/(2*Ft),i.top=Vt/(2*Ft),i.bottom=-Vt/(2*Ft),i.updateProjectionMatrix(),qi()}function Mi(){O.L.value=Gt,O.L_y.value=Vt,O.L_x.value=xt,O.L_min.value=Math.min(Vt,xt),O.dt.value=q.dt,O.dx.value=xt/wt,O.dy.value=Vt/Ct,O.heightScale.value=q.threeDHeightScale,O.maxColourValue.value=q.maxColourValue,O.minColourValue.value=q.minColourValue,O.customSurface.value=q.customSurface,O.vectorField.value=q.vectorField,vr(),q.fixRandSeed||xo()}function Ii(){try{Gt=Ei.evaluate(q.domainScale)}catch(e){ja("Unable to evaluate the domain length. Please check the definition."),Gt=100}Ut=Math.round(e.getBoundingClientRect().width),$t=Math.round(e.getBoundingClientRect().height),s=$t/Ut,s<=0&&(s=.1),s>=1?(Vt=Gt,xt=Vt/s):(xt=Gt,Vt=xt*s),1==q.dimension&&(xt=Gt),O.L_x.value=xt,O.L_y.value=Vt,Ft=Math.max(xt,Vt)}function Ni(){Ii();let e=Gt/100;try{e=Ei.evaluate(q.spatialStep)}catch(e){ja("Unable to evaluate the spatial step. Please check the definition.")}e<=0&&(ja("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),e=Gt/100),wt=Math.floor(xt/e),Ct=Math.floor(Vt/e),0==wt&&(wt=1),0==Ct&&(Ct=1),1==q.dimension&&(Ct=1),O.nXDisc.value=wt,O.nYDisc.value=Ct,R=new Array(wt),k=new Array(wt);let t=-.5,n=1/wt;for(let e=0;e<R.length;e++)R[e]=t,t+=n;R=R.map((e=>e*xt/Ft)),Ba(),sn=new Float32Array(wt*Ct*4),fn=!1}function Li(){Ii();let e=[1,1];zt||(e=[wt,Ct]);const t=new ui.PlaneGeometry(xt/Ft,Vt/Ft,e[0],e[1]);A=new ui.Mesh(t,v),A.position.z=0,A.visible="line"!=q.plotType,A.matrixAutoUpdate=!1,a.add(A);const n=new ui.PlaneGeometry(xt/Ft,Vt/Ft,1,1);W=new ui.Mesh(n,g),W.position.z=0,W.visible=!1,W.matrixAutoUpdate=!1,a.add(W),qi();const i=new pi;M=Math.round(devicePixelRatio*Ut);const o=new Array(3*M).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),P=new di(i,x),P.scale.set(1,1,1),P.visible="line"==q.plotType,a.add(P);const l=new pi,s=new Array(3*M).fill(0);l.setPositions(s),Q=new di(l,V),Q.scale.set(1,1,1),Q.visible="line"==q.plotType&&q.overlay,a.add(Q)}function qi(){switch(q.plotType){case"plane":A.rotation.x=0,W.rotation.x=0;break;case"surface":A.rotation.x=-Math.PI/2,W.rotation.x=-Math.PI/2}A.updateMatrix(),W.updateMatrix()}function Oi(){q.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Bi(e){z=new dat.GUI({closeOnTop:!0,autoPlace:!1}),z.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(z.domElement),G=new dat.GUI({closeOnTop:!0,autoPlace:!1}),G.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(G.domElement),J=new dat.GUI({closeOnTop:!0,autoPlace:!1}),J.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(J.domElement),z.open(),G.open(),J.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),H=G.addFolder("Brush");ar(ir(H),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',null,null,"Toggle the brush on or off");H.add(q,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange((function(){zi(),document.activeElement.blur()}));X=H.add(q,"typeOfBrush",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange(zi),H.add(q,"brushValue").name("Value").onFinishChange(zi),H.add(q,"brushRadius").name("Radius").onFinishChange(zi),we=H.add(q,"whatToDraw",Ci).name("Species").onChange(zi),H=G.addFolder("Domain"),H.add(q,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){pa(),document.activeElement.blur(),Cr()})),H.add(q,"domainScale").name("Largest side").onFinishChange((function(){Qi(),Cr()})),H.add(q,"spatialStep").name("Space step").onFinishChange((function(){Qi(),Cr()}));const t=ir(H);ar(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){Oi(),Qi(),ki(),Cr()}),null,"Use a square domain"),ar(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Implicit',(function(){Po(),Wo(),uo(),Ao(),Cr()}),null,"Determine the domain implicitly"),ne=H.add(q,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){Po(),Wo(),uo(),Eo(),Cr()})),H=G.addFolder("Timestepping"),Ze=H.add(q,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),br(Ze,1,400,1),Se=H.add(q,"dt").name("Timestep").onChange((function(){Mi()})),Se.__precision=12,Se.min(0),Se.updateDisplay(),H.add(q,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme").onChange((function(){document.activeElement.blur()}));const n=ir(H);ar(n,"timeDisplay",'<i class="fa-regular fa-hourglass-half"></i> Elapsed time',Ko,null,"Show/hide time display"),ar(n,"autoPause",'<i class="fa-regular fa-hourglass-end"></i> Auto pause',(function(){Rt=O.t.value<q.autoPauseAt,Wo()}),null,"Toggle automatic pausing"),ye=H.add(q,"autoPauseAt").name("Pause at $t=$").onFinishChange((function(){Rt=O.t.value<q.autoPauseAt,ye.domElement.blur()})),H=G.addFolder("Equations"),H.add(q,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange((function(){document.activeElement.blur(),Qo(),oo()})),te=H.add(q,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){jt=!0,Qo(),jt=!1,oo()})),H.add(q,"speciesNames").name("Species names").onFinishChange((function(){_a()}));ar(ir(H),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',(function(){Qo()}),"cross_diffusion_controller","Toggle cross diffusion"),H=z.addFolder("Definitions");ar(ir(H),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',Ro,null,"Typeset the specified equations"),ie=H.add(q,"diffusionStrUU").onFinishChange((function(){uo(),Ro()})),Qa(ie,ka,["U","UU"]),Ra(ie,Ma,["U","UU"]),oe=H.add(q,"diffusionStrUV").onFinishChange((function(){uo(),Ro()})),Qa(oe,ka,["UV"]),Ra(oe,Ma,["UV"]),ae=H.add(q,"diffusionStrUW").onFinishChange((function(){uo(),Ro()})),Qa(ae,ka,["UW"]),Ra(ae,Ma,["UW"]),re=H.add(q,"diffusionStrUQ").onFinishChange((function(){uo(),Ro()})),Qa(re,ka,["UQ"]),Ra(re,Ma,["UQ"]),le=H.add(q,"diffusionStrVU").onFinishChange((function(){uo(),Ro()})),Qa(le,ka,["VU"]),Ra(le,Ma,["VU"]),se=H.add(q,"diffusionStrVV").onFinishChange((function(){uo(),Ro()})),Qa(se,ka,["V","VV"]),Ra(se,Ma,["V","VV"]),ue=H.add(q,"diffusionStrVW").onFinishChange((function(){uo(),Ro()})),Qa(ue,ka,["VW"]),Ra(ue,Ma,["VW"]),ce=H.add(q,"diffusionStrVQ").onFinishChange((function(){uo(),Ro()})),Qa(ce,ka,["VQ"]),Ra(ce,Ma,["VQ"]),de=H.add(q,"diffusionStrWU").onFinishChange((function(){uo(),Ro()})),Qa(de,ka,["WU"]),Ra(de,Ma,["WU"]),fe=H.add(q,"diffusionStrWV").onFinishChange((function(){uo(),Ro()})),Qa(fe,ka,["WV"]),Ra(fe,Ma,["WV"]),pe=H.add(q,"diffusionStrWW").onFinishChange((function(){uo(),Ro()})),Qa(pe,ka,["W","WW"]),Ra(pe,Ma,["W","WW"]),me=H.add(q,"diffusionStrWQ").onFinishChange((function(){uo(),Ro()})),Qa(me,ka,["WQ"]),Ra(me,Ma,["WQ"]),he=H.add(q,"diffusionStrQU").onFinishChange((function(){uo(),Ro()})),Qa(he,ka,["QU"]),Ra(he,Ma,["QU"]),ge=H.add(q,"diffusionStrQV").onFinishChange((function(){uo(),Ro()})),Qa(ge,ka,["QV"]),Ra(ge,Ma,["QV"]),ve=H.add(q,"diffusionStrQW").onFinishChange((function(){uo(),Ro()})),Qa(ve,ka,["QW"]),Ra(ve,Ma,["QW"]),be=H.add(q,"diffusionStrQQ").onFinishChange((function(){uo(),Ro()})),Qa(be,ka,["Q","QQ"]),Ra(be,Ma,["Q","QQ"]),Y=H.add(q,"reactionStrU").onFinishChange((function(){uo(),Ro()})),Qa(Y,ka,["UFUN"]),Ra(Y,Ma,["UFUN"]),Z=H.add(q,"reactionStrV").onFinishChange((function(){uo(),Ro()})),Qa(Z,ka,["VFUN"]),Ra(Z,Ma,["VFUN"]),K=H.add(q,"reactionStrW").onFinishChange((function(){uo(),Ro()})),Qa(K,ka,["WFUN"]),Ra(K,Ma,["WFUN"]),ee=H.add(q,"reactionStrQ").onFinishChange((function(){uo(),Ro()})),Qa(ee,ka,["QFUN"]),Ra(ee,Ma,["QFUN"]),Et=z.addFolder("Parameters"),function(){let e,t,n=[],i=q.kineticParams.split(";");for(var o=0;o<i.length;o++)t=Oo(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+Kt,Kt+=1,Yt.push(e),Xt[e]=t,n.push(e));for(const e of n)Bo(e,!1);e="param"+Kt,Yt.push(e),Xt[e]=t,Bo(e,!0)}(),H=z.addFolder("Boundary conditions"),Re=H.add(q,"boundaryConditionsU",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){uo(),Co(),document.activeElement.blur()})),Ne=H.add(q,"dirichletStrU").onFinishChange(uo),Je=H.add(q,"neumannStrU").onFinishChange(uo),Ke=H.add(q,"robinStrU").onFinishChange(uo),Be=H.add(q,"comboStrU").name("Details").onFinishChange(uo),ke=H.add(q,"boundaryConditionsV",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){uo(),Co(),document.activeElement.blur()})),Le=H.add(q,"dirichletStrV").onFinishChange(uo),He=H.add(q,"neumannStrV").onFinishChange(uo),et=H.add(q,"robinStrV").onFinishChange(uo),je=H.add(q,"comboStrV").name("Details").onFinishChange(uo),Me=H.add(q,"boundaryConditionsW",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){uo(),Co(),document.activeElement.blur()})),qe=H.add(q,"dirichletStrW").onFinishChange(uo),Xe=H.add(q,"neumannStrW").onFinishChange(uo),tt=H.add(q,"robinStrW").onFinishChange(uo),ze=H.add(q,"comboStrW").name("Details").onFinishChange(uo),Ie=H.add(q,"boundaryConditionsQ",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).name("$q$").onChange((function(){uo(),Co(),document.activeElement.blur()})),Oe=H.add(q,"dirichletStrQ").onFinishChange(uo),Ye=H.add(q,"neumannStrQ").onFinishChange(uo),nt=H.add(q,"robinStrQ").onFinishChange(uo),Ge=H.add(q,"comboStrQ").name("Details").onFinishChange(uo),H=z.addFolder("Initial conditions"),Te=H.add(q,"clearValueU").onFinishChange(Vo),We=H.add(q,"clearValueV").onFinishChange(Vo),Pe=H.add(q,"clearValueW").onFinishChange(Vo),Qe=H.add(q,"clearValueQ").onFinishChange(Vo),it=G.addFolder("Images"),H=it,$o(),H=G.addFolder("Checkpoints");const i=ir(H);ar(i,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),rr(i),or(i,'<i class="fa-regular fa-flag"></i> Set',Ia,null,"Set a checkpoint at the current state",["narrow"]),or(i,'<i class="fa-regular fa-file-arrow-down"></i> Export',Na,null,"Download the last checkpoint as a file",["narrow"]),or(i,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),H.add(q,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize").onChange((function(){document.activeElement.blur()})),H=G.addFolder("Misc."),H.addColor(q,"backgroundColour").name("Background").onChange((function(){a.background=new ui.Color(q.backgroundColour),Cr()}));const o=ir(H);ar(o,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){ta(),Cr()}),null,"Compute the integral of the plotted expression over the domain"),ar(o,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',(function(){la(),Cr()}),"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),ar(o,"fixRandSeed",'<i class="fa-regular fa-shuffle"></i> Fix seed',null,null,"Fix the random seed"),or(o,'<i class="fa-regular fa-copy"></i> Copy code',lr,null,"Copy the simulation configuration as JSON"),H=H.addFolder("Debug");or(ir(H),"Copy debug information",sr);const r=document.createElement("div");r.innerHTML="Settings",r.classList.add("ui_title"),G.domElement.prepend(r);const l=document.createElement("div");l.innerHTML="Equations",l.classList.add("ui_title"),z.domElement.prepend(l);const s=document.createElement("div");s.id="views_list",J.domElement.prepend(s);const u=document.createElement("div");u.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",u.classList.add("ui_title"),J.domElement.prepend(u),ut=J.addFolder("Edit view"),H=ut;const c=ir(H,"edit_view_buttons");or(c,'<i class="fa-solid fa-pen-nib"></i> Rename',Ha,null,"Rename the current view"),or(c,'<i class="fa-solid fa-xmark"></i> Delete',Xa,"deleteViewButton","Delete view"),ft=H.add(q,"whatToPlot").name("Expression: ").onFinishChange((function(){Eo(),Cr(),Za(this.property)})),H.add(q,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){fa(),document.activeElement.blur(),Cr(),Za(this.property)})),H.add(q,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){Gi(),Ho(),document.activeElement.blur(),Cr(),Za(this.property)})).name("Colour map"),Ee=H.add(q,"minColourValue").name("Min value").onChange((function(){Mi(),Xo(),Cr(),Za(this.property)})),Ee.__precision=2,_e=H.add(q,"maxColourValue").name("Max value").onChange((function(){Mi(),Xo(),Cr(),Za(this.property)})),_e.__precision=2;const d=ir(H,"colour_map_buttons");or(d,'<i class="fa-regular fa-arrows-rotate"></i> Flip',(function(){q.flippedColourmap=!q.flippedColourmap,Gi(),Ho(),Cr(),Za("flippedColourmap")}),null,"Reverse colour map",["narrow"]),or(d,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){$a(),Hi(),Za("minColourValue"),Za("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),ar(d,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){Ho(),Za("colourbar")}),null,"Display the colourbar",null,["narrow"]),rr(d),ar(d,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){q.autoSetColourRange&&($a(),Hi()),Za("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),ar(d,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){Gi(),Cr(),Za("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),ar(d,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){Gi(),Cr(),Za("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),ar(d,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){Gi(),Cr(),Za("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),ar(d,"vectorField",'<i class="fa-solid fa-arrow-right-arrow-left"></i> Vector field',(function(){Dr(),Cr(),Za("vectorField")}),"vectorFieldButton","Toggle vector field","vectorFieldFolder",["wide"]),H=ut.addFolder("Contours"),H.domElement.id="contoursFolder",H.addColor(q,"contourColour").name("Colour").onChange((function(){yr(),Cr(),Za(this.property)})),At.push(H.add(q,"contourNum").name("Number").onChange((function(){yr(),Cr(),Za(this.property)}))),br(At.last(),1,20,1),At.push(H.add(q,"contourEpsilon").name("Threshold").onChange((function(){yr(),Cr(),Za(this.property)}))),br(At.last(),.001,.05,.001),H=ut.addFolder("Lighting"),H.domElement.id="embossFolder",Tt.push(H.add(q,"embossSmoothness").name("Smoothness").onChange((function(){vr(),Cr(),Za(this.property)}))),br(Tt.last(),0,2,.001),Tt.push(H.add(q,"embossAmbient").name("Ambient").onChange((function(){vr(),Cr(),Za(this.property)}))),br(Tt.last(),0,1,.001),Tt.push(H.add(q,"embossDiffuse").name("Diffuse").onChange((function(){vr(),Cr(),Za(this.property)}))),br(Tt.last(),0,1,.001),Tt.push(H.add(q,"embossSpecular").name("Specular").onChange((function(){vr(),Cr(),Za(this.property)}))),br(Tt.last(),0,1,.001),Tt.push(H.add(q,"embossShiny").name("Precision").onChange((function(){vr(),Cr(),Za(this.property)}))),br(Tt.last(),0,100,1),Tt.push(H.add(q,"embossTheta").name("Inclination").onChange((function(){vr(),Cr(),Za(this.property)}))),br(Tt.last(),0,1.5708,.001),Tt.push(H.add(q,"embossPhi").name("Direction").onChange((function(){vr(),Cr(),Za(this.property)}))),br(Tt.last(),0,3.1456,.001),H=ut.addFolder("Overlay"),H.domElement.id="overlayFolder",H.addColor(q,"overlayColour").name("Colour").onChange((function(){wr(),Cr(),Za(this.property)})),H.add(q,"overlayExpr").name("Expression").onFinishChange((function(){Gi(),"line"==q.plotType&&Ao(),Cr(),Za(this.property)})),st=H.add(q,"overlayEpsilon").name("Threshold").onChange((function(){wr(),Cr(),Za(this.property)})),ct=ut.addFolder("3D"),H=ct;ar(ir(H),"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){O.customSurface.value=q.customSurface,Fr(),Ur(),Cr(),Za("customSurface")}),"customSurfaceToggle","Plot the solution on a custom surface"),Ve=H.add(q,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){Eo(),Cr(),Za(this.property)})),xe=H.add(q,"threeDHeightScale").name("Max height").onChange((function(){Mi(),Cr(),Za(this.property)})),Fe=H.add(q,"cameraTheta").name("View $\\theta$").onChange((function(){ki(),Cr(),Za(this.property)})),Ue=H.add(q,"cameraPhi").name("View $\\phi$").onChange((function(){ki(),Cr(),Za(this.property)})),$e=H.add(q,"cameraZoom").name("Zoom").onChange((function(){ki(),Cr(),Za(this.property)})),Ce=H.add(q,"lineWidthMul",.1,2).name("Thickness").onChange((function(){Pa(),Cr(),Za(this.property)})),dt=ut.addFolder("Vector field"),H=dt,H.domElement.id="vectorFieldFolder",H.addColor(q,"arrowColour").name("Colour").onChange((function(){Ar(),Cr(),Za(this.property)})),H.add(q,"arrowX").onFinishChange((function(){Ao(),Cr(),Za(this.property)})).name("$x$ component"),H.add(q,"arrowY").onFinishChange((function(){Ao(),Cr(),Za(this.property)})).name("$y$ component"),rt=H.add(q,"arrowDensity").onChange((function(){Dr(),Cr(),Za(this.property)})).name("Density"),rt.__precision=2,br(rt,0,1,.001),H.add(q,"arrowScale",{None:"none",Relative:"relative",Auto:"auto"}).onFinishChange((function(){Wo(),Cr(),Za(this.property)})).name("Scaling"),lt=H.add(q,"arrowLengthMax").onFinishChange((function(){Dr(),Cr(),Za(this.property)})).name("Max length");document.querySelectorAll("input").forEach((e=>Vr(e)))}function ji(){Gi(),Ho(),Eo(),zi()}function zi(){let e=wa()+mn(),t="float brushRadius = "+lo(q.brushRadius.toString())+";\n";switch(t=t.replace(/\buvwq\./g,"uvwqBrush."),t=t.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(q.brushValue)&&(e+=Gn()),/\bRANDN\b/.test(q.brushValue)&&(e+=Jn()),e+="float brushValue = "+lo(q.brushValue)+";\n",e+=t,q.typeOfBrush){case"circle":e+=vn();break;case"hline":e+=Sn();break;case"vline":e+=bn()}switch(q.brushAction){case"replace":e+=yn(),e+=hn();break;case"add":e+=yn(),e+=gn();break;case"smoothreplace":e+=wn(),e+=hn();break;case"smoothadd":e+=wn(),e+=gn()}e=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,wo(q.whatToDraw)),e}(e),b.fragmentShader=e,b.needsUpdate=!0}function Gi(){N=ni(q.colourmap),q.flippedColourmap&&(N.reverse(),N=N.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),O.colour1.value=new ui.Vector4(...N[0]),O.colour2.value=new ui.Vector4(...N[1]),O.colour3.value=new ui.Vector4(...N[2]),O.colour4.value=new ui.Vector4(...N[3]),O.colour5.value=new ui.Vector4(...N[4]);let e=wa()+Hn();q.emboss&&(e+=Yn(),vr()),q.contours&&(e+=Zn(),yr()),q.overlay&&(e+=ti().replaceAll("OVERLAYEXPR",lo(q.overlayExpr)),wr()),Q.visible=q.overlay&&"line"==q.plotType,e+=Xn(),v.fragmentShader=e,v.needsUpdate=!0,C.needsUpdate=!0,L=N.map((e=>e[3])),N=N.map((e=>e.slice(0,-1)))}function Ji(){switch(q.timesteppingScheme){case"Euler":T.material=Dt.FE,O.textureSource.value=_t[1].texture,O.textureSource1.value=_t[2].texture,O.dt.value=q.dt,l.setRenderTarget(_t[0]),l.render(r,o),_t.rotate(-1),O.t.value+=q.dt;break;case"AB2":T.material=Dt.AB2,O.textureSource.value=_t[1].texture,O.textureSource1.value=_t[2].texture,O.dt.value=q.dt,l.setRenderTarget(_t[0]),l.render(r,o),_t.rotate(-1),O.t.value+=q.dt;break;case"Mid":T.material=Dt.Mid1,O.textureSource.value=_t[1].texture,l.setRenderTarget(_t[2]),l.render(r,o),T.material=Dt.Mid2,O.textureSource1.value=_t[2].texture,O.t.value+=.5*q.dt,l.setRenderTarget(_t[0]),l.render(r,o),_t.rotate(-1),O.t.value+=.5*q.dt;break;case"RK4":T.material=Dt.RK41,O.textureSource.value=_t[1].texture,l.setRenderTarget(_t[2]),l.render(r,o),T.material=Dt.RK42,O.textureSource1.value=_t[2].texture,O.t.value+=.5*q.dt,l.setRenderTarget(_t[3]),l.render(r,o),T.material=Dt.RK43,O.textureSource2.value=_t[3].texture,l.setRenderTarget(_t[4]),l.render(r,o),T.material=Dt.RK44,O.textureSource3.value=_t[4].texture,O.t.value+=.5*q.dt,l.setRenderTarget(_t[0]),l.render(r,o),_t.rotate(-1)}}function Hi(){if(q.autoSetColourRange&&$a(),q.brushEnabled&&"surface"==q.plotType){let e=0;q.maxColourValue-q.minColourValue>0&&(e=(function(){aa();let e=0;for(let t=0;t<sn.length;t+=4)e+=sn[t];return e/(wt*Ct)}()-q.minColourValue)/(q.maxColourValue-q.minColourValue)-.5,e=e.clamp(-.5,.5)),W.position.y=q.threeDHeightScale*e,W.updateWorldMatrix()}if(Xi(),"line"==q.plotType){aa();let t,n=0;var e=q.maxColourValue-q.minColourValue;e=0==e?.5:e;for(let i=0;i<sn.length;i+=4)t=(sn[i]-q.minColourValue)/e-.5,k[n++]=t.clamp(-.5,.5)*Vt/Ft;let i=new ui.SplineCurve(R.map(((e,t)=>new ui.Vector2(e,k[t])))),o=i.getSpacedPoints(M);if(Aa(P,o),function(e,t){let n,i=e.geometry.attributes.instanceColorStart,o=e.geometry.attributes.instanceColorEnd;for(let e=0;e<t.length;e++)n=Ta(t[e].toArray()[1]+.5),e<t.length&&i.setXYZ(e,n[0],n[1],n[2]),e>0&&o.setXYZ(e-1,n[0],n[1],n[2]);i.needsUpdate=!0}(P,o),q.overlay){n=0;for(let i=2;i<4*wt;i+=4)t=(sn[i]-q.minColourValue)/e-.5,k[n++]=t.clamp(-.5,.5)*Vt/Ft;i=new ui.SplineCurve(R.map(((e,t)=>new ui.Vector2(e,k[t])))),o=i.getSpacedPoints(M),Aa(Q,o)}}if(q.vectorField&&I){cn=new Float32Array(wt*Ct*4),l.readRenderTargetPixels(f,0,0,wt,Ct,cn);let e,t,n,i=[];for(const o of I.children)e=4*o.ind,t=cn[e+2],n=cn[e+3],o.visible=cn[e+1]<=.5,o.lookAt(o.position.x+t,o.position.y+n,o.position.z),o.size=t**2+n**2,i.push(o.size);let o=1;switch(q.arrowScale){case"auto":o=Math.sqrt(Math.max(...i)),0==o&&(o=1);for(const e of I.children){const t=Ht*Wa(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"relative":o=I.customMax>0?I.customMax:1;for(const e of I.children){const t=Ht*Wa(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"none":for(const e of I.children)e.scale.set(Ht,Ht,Ht)}}if(q.timeDisplay&&ea(),q.integrate&&function(){if(q.integrate){let e;aa(),1==q.dimension?e=O.dx.value:2==q.dimension&&(e=O.dx.value*O.dy.value);let t=0;for(let e=0;e<sn.length;e+=4)t+=sn[e];t*=e,$("#integralValue").html(Yo(t,4)),ra()}}(),sa()?(T.material=U,l.setRenderTarget(p),l.render(r,o),O.textureSource.value=p.texture,O.dxUpscaledScale.value=devicePixelRatio*Ut/wt,O.dyUpscaledScale.value=devicePixelRatio*$t/Ct):(O.dxUpscaledScale.value=1,O.dyUpscaledScale.value=1),l.setRenderTarget(null),l.render(a,i),dn){dn=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",l.render(a,i),t.href=l.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Ni(),Hi()}}function Xi(){T.material=C,O.textureSource.value=_t[1].texture,l.setRenderTarget(f),l.render(r,o),O.textureSource.value=f.texture,fn=!1,O.textureSource1.value=_t[1].texture}function Yi(t){mt=eo(t,e),mt&&(q.brushEnabled&&"surface"==q.plotType?u.enabled=!1:q.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),Go("#top_message"),window.clearTimeout(bt),bt=setTimeout((function(){$("#top_message").hasClass("fading_out")||Jo("#top_message")}),3e3)))}function Zi(e){mt=!1,"surface"==q.plotType&&(u.enabled=!0)}function Ki(t){eo(t,e)}function eo(e,t){var n=t.getBoundingClientRect();let o=(e.clientX-n.x)/n.width,a=1-(e.clientY-n.y)/n.height;if("surface"==q.plotType){d.x=2*o-1,d.y=2*a-1,c.setFromCamera(d,i);var r=c.intersectObject(W,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==q.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*wt)/wt,a=Math.round(a*Ct)/Ct,O.brushCoords.value=new ui.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function to(){l.setSize(wt,Ct,!1),q.fixRandSeed||xo(),Ot&&q.resetFromCheckpoints?T.material=E:T.material=y,_t.forEach((e=>{l.setRenderTarget(e),l.render(r,o)})),Ba(),Hi()}function no(){qt||($("#pause").hide(),$("#play").show()),pt=!1}function io(){qt||($("#play").hide(),$("#pause").show()),kt=!0,window.clearTimeout(vt),vt=setTimeout(oa,1e3),pt=!0}function oo(){to(),O.t.value=0,Rt=!0,ea(),Hi(),kt=!0,window.clearTimeout(vt),oa()}function ao(){let e="";return e+="float UFUN = "+lo(q.reactionStrU)+";\n",e+="float VFUN = "+lo(q.reactionStrV)+";\n",e+="float WFUN = "+lo(q.reactionStrW)+";\n",e+="float QFUN = "+lo(q.reactionStrQ)+";\n",e}function ro(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function lo(e){if(!za(e=" "+e+" "))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])\b/g);let i,o,a,r,l,s,u,c,d,f,p,m,h=0;const g={S:"One",T:"Two"},v={R:"x",G:"y",B:"z",A:"w"};for(const b of n){for(i=b.index,p=g[b[1]],m=v[b[2]],o=i+b[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,l=t.slice(o+h+1,a+h),l=Va(l),s=l.split(","),1!=s.length&&0!=s[1].trim().length||(s[1]="0"),s[0]="("+s[0]+")/L_x",s[1]="("+s[1]+")/L_y",f="texture(imageSource"+p+",vec2("+s.join(",")+"))."+m,t=Lo(t,f,i+h,a+1+h),h+=f.length-a+i-1)}return t}(e=va(e=(e=(e=(e=so(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){if("0"==n)return"1";const i=Number(n);return Number.isInteger(i&&i>0&&i<101)?"(("+t+")"+("*("+t+")").repeat(i-1)+")":"safepow("+t+","+n+")"}))).replaceAll(RegExp("\\b("+Vi[0]+")\\b","g"),(function(e,t){return"uvwq."+wo(t)}))).replaceAll(RegExp("\\b("+Vi[0]+")_([xy][fb]?2?)\\b","g"),(function(e,t,n){return n.includes("2")&&(n=n.slice(0,-1).repeat(2)),"uvwq"+n.toUpperCase()+"."+wo(t)}))).replaceAll(RegExp("\\b("+Vi[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+wo(t)}))));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e}function so(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function uo(){let e="",t="",n="",i="",o="",a="";const r=[q.boundaryConditionsU,q.boundaryConditionsV,q.boundaryConditionsW,q.boundaryConditionsQ],l=[q.neumannStrU,q.neumannStrV,q.neumannStrW,q.neumannStrQ],s=[q.comboStrU,q.comboStrV,q.comboStrW,q.comboStrQ].map((e=>e+";")),u=[q.dirichletStrU,q.dirichletStrV,q.dirichletStrW,q.dirichletStrQ],c=[q.robinStrU,q.robinStrV,q.robinStrW,q.robinStrQ];if(r.forEach((function(t,n){"neumann"==t?(e+=co(l[n],Ci[n]),e+=Ka(n)):"combo"==t&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=co(t[2],Ci[n],i),e+=Ka(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=yo(Bn(t),Ci[e]),q.dimension>1&&(i+=yo(jn(t),Ci[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,lo(e[2]))}))})),q.domainViaIndicatorFun){let e=Wn().replace(/indicatorFun/g,lo(q.domainIndicatorFun));u.forEach((function(t,i){n+=yo(e,Ci[i])+lo(t)+";\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=fo(u[t],Ci[t]),n+=er(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=fo(e[2],Ci[t],i),n+=er(t,i)}))}));r.forEach((function(e,t){"robin"==e?(i+=co(c[t],Ci[t]),i+=tr(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=co(e[2],Ci[t],n),i+=tr(t,n)}))}));let d=wa();if(o=function(){let e="";return e+=ro(lo(q.diffusionStrUU)+";\n","uu"),e+=ro(lo(q.diffusionStrVV)+";\n","vv"),e+=ro(lo(q.diffusionStrWW)+";\n","ww"),e+=ro(lo(q.diffusionStrQQ)+";\n","qq"),e}()+"\n",q.crossDiffusion?o+=function(){let e="";return e+=ro(lo(q.diffusionStrUV)+";\n","uv"),e+=ro(lo(q.diffusionStrUW)+";\n","uw"),e+=ro(lo(q.diffusionStrUQ)+";\n","uq"),e+=ro(lo(q.diffusionStrVU)+";\n","vu"),e+=ro(lo(q.diffusionStrVW)+";\n","vw"),e+=ro(lo(q.diffusionStrVQ)+";\n","vq"),e+=ro(lo(q.diffusionStrWU)+";\n","wu"),e+=ro(lo(q.diffusionStrWV)+";\n","wv"),e+=ro(lo(q.diffusionStrWQ)+";\n","wq"),e+=ro(lo(q.diffusionStrQU)+";\n","qu"),e+=ro(lo(q.diffusionStrQV)+";\n","qv"),e+=ro(lo(q.diffusionStrQW)+";\n","qw"),e}()+"\n"+kn():o+=Rn(),an&&q.crossDiffusion&&(a+=yo(Mn(),Ci[1])),rn&&q.crossDiffusion&&(a+=yo(Mn(),Ci[2])),ln&&q.crossDiffusion&&(a+=yo(Mn(),Ci[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void ja("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let f=[Nn(),qn(),e,t,i,Ln(),On(),ao(),o].join(" "),p=/\bRAND\b/.test(f),m=/\bRANDN\b/.test(f);p&&(f=Gn()+f),m&&(f=Jn()+f),It=p||m;let h=[n,a,Dn()].join(" "),g="FE";Dt[g].fragmentShader=[d,_n(g),f,zn(g),h].join(" "),g="AB2",Dt[g].fragmentShader=[d,_n(g),f,zn(g),h].join(" "),g="Mid";for(let e=1;e<3;e++)Dt[g+e.toString()].fragmentShader=[d,_n(g+e.toString()),f,zn(g+e.toString()),h].join(" ");g="RK4";for(let e=1;e<5;e++)Dt[g+e.toString()].fragmentShader=[d,_n(g+e.toString()),f,zn(g+e.toString()),h].join(" ");if(Object.keys(Dt).forEach((e=>Dt[e].needsUpdate=!0)),gt=q.domainViaIndicatorFun||"dirichlet"==q.boundaryConditionsU||"dirichlet"==q.boundaryConditionsV||"dirichlet"==q.boundaryConditionsW||"dirichlet"==q.boundaryConditionsQ||/Dirichlet/.test(q.comboStrU)||/Dirichlet/.test(q.comboStrV)||/Dirichlet/.test(q.comboStrW)||/Dirichlet/.test(q.comboStrQ),gt){if(n=d+In(),q.domainViaIndicatorFun){let e=Wn().replace(/indicatorFun/g,lo(q.domainIndicatorFun)).replace(/updated/g,"gl_FragColor");u.forEach((function(t,i){n+=yo(e,Ci[i])+lo(t)+";\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=fo(u[t],Ci[t]),n+=nr(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=fo(e[2],Ci[t],i),n+=nr(t,i)}))}));n+="}",S.fragmentShader=n,S.needsUpdate=!0}}function co(e,t,n){return null==n?["L","R","T","B"].map((n=>co(e,t,n))).join(""):"float robinRHS"+t+n+" = "+lo(e)+";\n"}function fo(e,t,n){return null==n?["L","R","T","B"].map((n=>fo(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+lo(e)+";\n"}function po(e){mo("default"),mo(e),null!=q.threeD&&(q.threeD&&(q.dimension=2,q.plotType="surface"),delete q.threeD),null!=q.oneDimensional&&(q.oneDimensional&&(q.dimension=1,q.plotType="line"),delete q.oneDimensional),Gt*=Jt,function(){if(0==q.views.length){let e=Ya();e.name="1",q.views.push(e)}else q.views=q.views.map((function(e){let t=Ya();return Object.assign(t,e),t}));St=q.views}(),go(z,!0),go(G,!0),go(J,!0),Bi(),q.activeViewInd<q.views.length?Ja(q.views[q.activeViewInd],!1):Ja({},!0),Qo(),Oi(),Qi(),Mi(),a.background=new ui.Color(q.backgroundColour),""!=q.initialState?fetch(q.initialState).then((e=>e.blob())).then((e=>La(e))):oo(),ki(),ot.remove(),at.remove(),$o(),la()}function mo(e){let t;t=null==e?oi(q.preset):"string"==typeof e?oi(e):"object"==typeof e?e:oi("default"),t.hasOwnProperty("parent")&&null!=t.parent&&mo(t.parent),Kt=0,Yt=[],Xt={},Object.assign(q,t),pt=q.runningOnLoad,_a(),pt?io():no(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?q.tryClickingText=q.tryClickingText.replaceAll("clicking","tapping"):q.tryClickingText=q.tryClickingText.replaceAll("tapping","clicking"),q.brushRadius=q.brushRadius.toString(),q.hasOwnProperty("drawIn3D")&&(q.brushEnabled=q.drawIn3D);var n=0;n+=q.hasOwnProperty("algebraicV"),n+=q.hasOwnProperty("algebraicW"),(n+=q.hasOwnProperty("algebraicQ"))&&!q.numAlgebraicSpecies&&(q.numAlgebraicSpecies=n),delete q.algebraicV,delete q.algebraicW,delete q.algebraicQ,null==q.minColourValue&&(q.minColourValue=0),null==q.maxColourValue&&(q.maxColourValue=1),q.domainScale=q.domainScale.toString(),q.spatialStep=q.spatialStep.toString(),j=JSON.parse(JSON.stringify(q));let i=[q.clearValueU,q.clearValueV,q.clearValueW,q.clearValueQ,q.domainIndicatorFun,q.reactionStrU,q.reactionStrV,q.reactionStrW,q.reactionStrQ,q.diffusionStrUU,q.diffusionStrUV,q.diffusionStrUW,q.diffusionStrUQ,q.diffusionStrVU,q.diffusionStrVV,q.diffusionStrVW,q.diffusionStrVQ,q.diffusionStrWU,q.diffusionStrWV,q.diffusionStrWW,q.diffusionStrWQ,q.diffusionStrQU,q.diffusionStrQV,q.diffusionStrQW,q.diffusionStrQQ,q.dirichletStrU,q.dirichletStrV,q.dirichletStrW,q.dirichletStrQ,q.robinStrU,q.robinStrV,q.robinStrW,q.robinStrQ,q.comboStrU,q.comboStrV,q.comboStrW,q.comboStrQ,q.neumannStrU,q.neumannStrV,q.neumannStrW,q.neumannStrQ,q.brushValue,q.whatToPlot].join(" ");q.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(i)}function ho(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)ho(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function go(e,t){if(null!=e){for(let t in e.__folders)go(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function vo(e){null!=e&&(e.__li.style.display="none")}function bo(e){null!=e&&(e.__li.style.display="")}function So(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function yo(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=wo(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function wo(e){return"rgba"[function(e){return Ci.indexOf(e)}(e)]}function Co(){"dirichlet"==q.boundaryConditionsU?bo(Ne):vo(Ne),"dirichlet"==q.boundaryConditionsV?bo(Le):vo(Le),"dirichlet"==q.boundaryConditionsW?bo(qe):vo(qe),"dirichlet"==q.boundaryConditionsQ?bo(Oe):vo(Oe),"neumann"==q.boundaryConditionsU?bo(Je):vo(Je),"neumann"==q.boundaryConditionsV?bo(He):vo(He),"neumann"==q.boundaryConditionsW?bo(Xe):vo(Xe),"neumann"==q.boundaryConditionsQ?bo(Ye):vo(Ye),"robin"==q.boundaryConditionsU?bo(Ke):vo(Ke),"robin"==q.boundaryConditionsV?bo(et):vo(et),"robin"==q.boundaryConditionsW?bo(tt):vo(tt),"robin"==q.boundaryConditionsQ?bo(nt):vo(nt),"combo"==q.boundaryConditionsU?bo(Be):vo(Be),"combo"==q.boundaryConditionsV?bo(je):vo(je),"combo"==q.boundaryConditionsW?bo(ze):vo(ze),"combo"==q.boundaryConditionsQ?bo(Ge):vo(Ge),q.domainViaIndicatorFun?(vo(Re),vo(ke),vo(Me),vo(Ie)):bo(Re)}function xo(){O.seed.value=performance.now()%1e6/1e6}function Vo(){let e=wa()+si(),t=[q.clearValueU,q.clearValueV,q.clearValueW,q.clearValueQ].join(" ");/\bRAND\b/.test(t)&&(e+=Gn()),/\bRANDN\b/.test(t)&&(e+=Jn()),e+="float u = "+lo(q.clearValueU)+";\n",e+="float v = "+lo(q.clearValueV)+";\n",e+="float w = "+lo(q.clearValueW)+";\n",e+="float q = "+lo(q.clearValueQ)+";\n",e+=li(),y.fragmentShader=e,y.needsUpdate=!0}function Fo(){let e=new Image;e.src=ot.__image.src;let t=new ui.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,O.imageSourceOne.value=t,q.resetOnImageLoad&&oo()}}function Uo(){let e=new Image;e.src=at.__image.src;let t=new ui.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,O.imageSourceTwo.value=t,q.resetOnImageLoad&&oo()},t.dispose()}function $o(){H=it,ot=H.addImage(q,"imagePathOne").name("$I_S(x,y)$").onChange(Fo),at=H.addImage(q,"imagePathTwo").name("$I_T(x,y)$").onChange(Uo),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Eo(){"MAX"==q.whatToPlot?(C.fragmentShader=Vn()+Un().replace(/indicatorFun/g,lo(q.domainIndicatorFun))+Fn(),C.needsUpdate=!0,q.minColourValue=0,q.maxColourValue=1,Mi(),vo(Ee),vo(_e),vo(De),vo(Ae),q.autoSetColourRange=!1,ho(G)):(Ao(),bo(Ee),bo(_e),bo(De),bo(Ae)),Ho(),ta()}function _o(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function Do(){aa();let e=1/0,t=-1/0;for(let n=0;n<sn.length;n+=4)e=Math.min(e,sn[n]),t=Math.max(t,sn[n]);return[e,t]}function Ao(){let e=wa()+Cn();e+=xn().replace(/\bXVECFUN\b/,lo(q.arrowX)).replace(/\bYVECFUN\b/,lo(q.arrowY)),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,lo(q.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,lo(q.surfaceFun))}(e),q.domainViaIndicatorFun&&(e+=Un().replace(/indicatorFun/g,lo(q.domainIndicatorFun))),e=e.replaceAll("OVERLAYEXPR",lo(q.overlayExpr)),wr(),C.fragmentShader=e+Fn(),C.needsUpdate=!0}function To(){q.numAlgebraicSpecies=Math.min(parseInt(q.numAlgebraicSpecies),parseInt(q.numSpecies)-1),an=q.numAlgebraicSpecies>=q.numSpecies-1,rn=q.numAlgebraicSpecies>=q.numSpecies-2&&q.numSpecies>=3,ln=q.numAlgebraicSpecies>=q.numSpecies-3&&q.numSpecies>=4}function Wo(){let e="function of "+Ci.slice(0,q.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+Ci[1]+",",""),i=e.replace(" "+Ci[2]+",",""),o=e.replace(" "+Ci[3]+",","");switch(1==q.dimension&&(e=e.replace(" y,","")),q.crossDiffusion&&parseInt(q.numSpecies)>1?(jt||Ea(te,Array.from(Array(parseInt(q.numSpecies)).keys())),bo(te)):vo(te),q.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),vo(oe),vo(le),vo(se),vo(Z),vo(We),vo(ke),vo(ae),vo(ue),vo(de),vo(fe),vo(pe),vo(K),vo(Pe),vo(Me),vo(re),vo(ce),vo(me),vo(he),vo(ge),vo(ve),vo(be),vo(ee),vo(Qe),vo(Ie),parseInt(q.numSpecies)){case 4:q.crossDiffusion?(bo(re),bo(ce),bo(me),bo(he),bo(ge),bo(ve)):(vo(me),vo(he),vo(ce),vo(re),vo(ge),vo(ve)),bo(be),bo(ee),bo(Qe),bo(Ie);case 3:q.crossDiffusion?(bo(ae),bo(ue),bo(de),bo(fe)):(vo(ae),vo(ue),vo(de),vo(fe)),bo(pe),bo(K),bo(Pe),bo(Me);case 2:q.crossDiffusion?(bo(oe),bo(le)):(vo(oe),vo(le)),bo(se),bo(Z),bo(We),bo(ke)}q.crossDiffusion?(So(ie,Ui.Duu,e),So(oe,Ui.Duv,e),So(ae,Ui.Duw,e),So(re,Ui.Duq,e),So(le,Ui.Dvu,e),So(se,Ui.Dvv,e),So(ue,Ui.Dvw,e),So(ce,Ui.Dvq,e),So(de,Ui.Dwu,e),So(fe,Ui.Dwv,e),So(pe,Ui.Dww,e),So(me,Ui.Dwq,e),So(he,Ui.Dqu,e),So(ge,Ui.Dqv,e),So(ve,Ui.Dqw,e),So(be,Ui.Dqq,e)):(So(ie,Ui.Du,e),So(se,Ui.Dv,e),So(pe,Ui.Dw,e),So(be,Ui.Dq,e)),So(Y,Ui.UFUN,e),So(Z,Ui.VFUN,e),So(K,Ui.WFUN,e),So(ee,Ui.QFUN,e),an&&(So(le,Ui.Dvu,t),So(ue,Ui.Dvw,t),So(ce,Ui.Dvq,t),So(Z,Ui.VFUN,t),vo(se)),rn&&(So(de,Ui.Dwu,o),So(fe,Ui.Dwv,o),So(me,Ui.Dwq,o),So(K,Ui.WFUN,o),vo(pe)),ln&&(So(he,Ui.Dqu,i),So(ge,Ui.Dqv,i),So(ve,Ui.Dqw,i),So(ee,Ui.QFUN,i),vo(be)),So(Re,Ui.u),So(ke,Ui.v),So(Me,Ui.w),So(Ie,Ui.q),So(Ne,Ui.uD),So(Le,Ui.vD),So(qe,Ui.wD),So(Oe,Ui.qD),So(Je,Ui.uN),So(He,Ui.vN),So(Xe,Ui.wN),So(Ye,Ui.qN),So(Ke,Ui.uN),So(et,Ui.vN),So(tt,Ui.wN),So(nt,Ui.qN),So(Te,Ui.uInit),So(We,Ui.vInit),So(Pe,Ui.wInit),So(Qe,Ui.qInit),q.domainViaIndicatorFun?bo(ne):vo(ne),Co(),"surface"==q.plotType?($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").hide(),ct.name="3D options",ct.domElement.classList.remove("hidden"),q.customSurface&&bo(Ve),vo(Ce),bo(xe),bo(Fe),bo(Ue),bo($e)):"line"==q.plotType?($("#contourButton").hide(),$("#embossButton").hide(),$("#vectorFieldButton").hide(),ct.name="Line options",ct.domElement.classList.remove("hidden"),bo(Ce),bo(xe),vo(Fe),vo(Ue),vo($e)):($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").show(),ct.domElement.classList.add("hidden"),vo(Ce),vo(xe),vo(Fe),vo(Ue),vo($e)),Ho(),Ko(),ta(),$("#dataContainer").show(),Ur(),"line"==q.plotType?(vo(X),$(":root").css("--ui-button-outline","black")):(bo(X),$(":root").css("--ui-button-outline","white")),n?$("#interpController").hide():$("#interpController").show(),"relative"==q.arrowScale?bo(lt):vo(lt),Ea(we,Ci.slice(0,q.numSpecies)),Sr(),q.autoPause?bo(ye):vo(ye),q.overlay&&"line"==q.plotType?vo(st):bo(st),$(".toggle_button").each((function(){xr(this)})),Ga(),ho(z),ho(G),ho(J)}function Po(){let e;switch(To(),q.domainViaIndicatorFun&&(q.boundaryConditionsU="dirichlet",q.boundaryConditionsV="dirichlet",q.boundaryConditionsW="dirichlet",q.boundaryConditionsQ="dirichlet"),parseInt(q.numSpecies)){case 1:q.crossDiffusion=!1,q.whatToDraw=Ci[0],q.whatToPlot=Ci[0],q.diffusionStrUV="0",q.diffusionStrUW="0",q.diffusionStrUQ="0",q.diffusionStrVU="0",q.diffusionStrVV="0",q.diffusionStrVW="0",q.diffusionStrVQ="0",q.diffusionStrWU="0",q.diffusionStrWV="0",q.diffusionStrWW="0",q.diffusionStrWQ="0",q.diffusionStrQU="0",q.diffusionStrQV="0",q.diffusionStrQW="0",q.diffusionStrQQ="0",q.boundaryConditionsV="periodic",q.clearValueV="0",q.reactionStrV="0",q.boundaryConditionsW="periodic",q.clearValueW="0",q.reactionStrW="0",q.boundaryConditionsQ="periodic",q.clearValueQ="0",q.reactionStrQ="0",e=new RegExp("\\b("+Vi[1]+")\\b"),e.test(q.reactionStrU)&&(q.reactionStrU="0");break;case 2:q.whatToDraw==Ci[2]|q.whatToDraw==Ci[3]&&(q.whatToDraw=Ci[0]),q.whatToPlot==Ci[2]|q.whatToPlot==Ci[3]&&(q.whatToPlot=Ci[0]),q.diffusionStrUW="0",q.diffusionStrUQ="0",q.diffusionStrVW="0",q.diffusionStrVQ="0",q.diffusionStrWU="0",q.diffusionStrWV="0",q.diffusionStrWW="0",q.diffusionStrWQ="0",q.diffusionStrQU="0",q.diffusionStrQV="0",q.diffusionStrQW="0",q.diffusionStrQQ="0",q.boundaryConditionsW="periodic",q.clearValueW="0",q.reactionStrW="0",q.boundaryConditionsQ="periodic",q.clearValueQ="0",q.reactionStrQ="0",e=new RegExp("\\b("+Vi[2]+")\\b"),e.test(q.reactionStrU)&&(q.reactionStrU="0"),e.test(q.reactionStrV)&&(q.reactionStrV="0");break;case 3:q.whatToDraw==Ci[3]&&(q.whatToDraw=Ci[0]),q.whatToPlot==Ci[3]&&(q.whatToPlot=Ci[0]),q.diffusionStrUQ="0",q.diffusionStrVQ="0",q.diffusionStrWQ="0",q.diffusionStrQU="0",q.diffusionStrQV="0",q.diffusionStrQW="0",q.diffusionStrQQ="0",q.boundaryConditionsQ="periodic",q.clearValueQ="0",q.reactionStrQ="0",e=new RegExp("\\b("+Vi[3]+")\\b"),e.test(q.reactionStrU)&&(q.reactionStrU="0"),e.test(q.reactionStrV)&&(q.reactionStrV="0"),e.test(q.reactionStrW)&&(q.reactionStrW="0")}switch(on){case 3:q.diffusionStrVV="0";break;case 6:q.diffusionStrWW="0";break;case 7:q.diffusionStrVV="0",q.diffusionStrWW="0";break;case 10:q.diffusionStrQQ="0";break;case 11:q.diffusionStrWW="0",q.diffusionStrQQ="0";break;case 12:q.diffusionStrVV="0",q.diffusionStrWW="0",q.diffusionStrQQ="0"}ho(z),ho(G)}function Qo(){!function(){switch(To(),parseInt(q.numSpecies)){case 1:on=0;break;case 2:on=q.crossDiffusion?1==q.numAlgebraicSpecies?3:2:1;break;case 3:if(q.crossDiffusion)switch(q.numAlgebraicSpecies){case 0:on=5;break;case 1:on=6;break;case 2:on=7}else on=4;break;case 4:if(q.crossDiffusion)switch(q.numAlgebraicSpecies){case 0:on=9;break;case 1:on=10;break;case 2:on=11;break;case 3:on=12}else on=8}}(),fa(),pa(),Po(),Wo(),Sa(),xa(),Ro()}function Ro(){let e,t=Fi[on];const n={U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(q.typesetCustomEqs){let o={};o.U=q.diffusionStrUU,o.UU=q.diffusionStrUU,o.V=q.diffusionStrVV,o.VV=q.diffusionStrVV,o.W=q.diffusionStrWW,o.WW=q.diffusionStrWW,o.Q=q.diffusionStrQQ,o.QQ=q.diffusionStrQQ,o.UV=q.diffusionStrUV,o.UW=q.diffusionStrUW,o.UQ=q.diffusionStrUQ,o.VU=q.diffusionStrVU,o.VW=q.diffusionStrVW,o.VQ=q.diffusionStrVQ,o.WU=q.diffusionStrWU,o.WV=q.diffusionStrWV,o.WQ=q.diffusionStrWQ,o.QU=q.diffusionStrQU,o.QV=q.diffusionStrQV,o.QW=q.diffusionStrQW,o.UFUN=q.reactionStrU,o.VFUN=q.reactionStrV,o.WFUN=q.reactionStrW,o.QFUN=q.reactionStrQ;var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!za(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=Da(o[e],Ci,en,"_(?:x+|y+)")})),Wt.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){tn.includes(e)||(t=function(e,t,n,i){let o=n.replace(/\s+/g,"  ").trim();if("0"==o||"0.0"==o)return e.replaceAll(t,"");if("1"==o||"1.0"==o)return e.replaceAll(t,"$2");if("-1"==o||"-1.0"==o)return e.replaceAll(t,"-$2");if(n.match(/[a-zA-Z]/))return n.match(/[\+-]/)&&null!=i?e.replaceAll(t,i[0]+n+i[1]+"$2"):e.replaceAll(t,n+"$2");return e}(t,n[e],o[e],"[]"))})),t=da(t,n.UFUN,o.UFUN),t=da(t,n.VFUN,o.VFUN),t=da(t,n.WFUN,o.WFUN),t=da(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\((D_\{\w+(?: \w+)?\})\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"$1 \\lap $2"),e=/\\vnabla\s*\\cdot\s*\(([\w\{\}\*\^]*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b[xy]|[uvwq]\b/g.test(t)?e:t+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])[fb]?2?\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else Wt.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{ "+t+" ";return"string"==typeof n&&(i+=n),i+" }"}))})),t=Da(t,["UFUN","VFUN","WFUN","QFUN"],tn);1==q.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=Da(t,en.concat(tn),Ci.concat(xi),"_(?:x+|y+)"),t=ko(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(Fa)}function ko(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Mo(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Mo(e,"cos",!0),e=Mo(e,"tan",!0),e=Mo(e,"exp",!0),e=Mo(e,"log",!0),e=Mo(e,"sqrt",!1),e=Mo(e,"sinh",!0),e=Mo(e,"cosh",!0),e=Mo(e,"tanh",!0),e=Mo(e,"max",!0),e=so(e=(e=Mo(e,"min",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",l="";for(var s=0;s<e.length;s++)t.includes(e[s])?(i+=1,o+=1):n.includes(e[s])&&(i-=1),0==i&&o>0&&(r=e.slice(a,s+1),l+=Io(r,o),o=0,a=s+1);return l+=e.slice(a),l}(e=wi(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")}function Mo(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,l,s,u,c,d,f=0;for(const p of o){for(a=p.index,r=a+t.length,s=e.slice(r),d=0,u=0,c=!1;d<=s.length&(!c|!(c&&0==u));)u+=["(","["].includes(s[d]),u-=[")","]"].includes(s[d]),c|=u,d+=1;c&&0==u&&(l=d-1+r,i=qo(i,"\\",a+f),f+=1,n?(i=qo(i,"{",r+f),f+=1,i=qo(i,"}",l+1+f),f+=1):(i=Lo(i,"{",r+f),i=Lo(i,"}",l+f)))}return i}function Io(e,t){const n=["(","["],i=[")","]"];let o=No(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=Lo(e,n[o],a),o+=1,o=No(o,n.length)):i.includes(e[a])&&(o-=1,o=No(o,n.length),e=Lo(e,i[o],a));return e}function No(e,t){return(e%t+t)%t}function Lo(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function qo(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Oo(e){return e=e.replace(/\s+/g,"  ").trim()}function Bo(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=Xt[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);Xt[e]=Xt[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),ho(Et),jo(),Hi(),(Sa()||Lt)&&(Lt=!1,xa())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)Yt.push(e),Xt[e]="",n=Et.add(Xt,e).name(""),Vr(n.domElement),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=Yt.indexOf(e);let n=Oo(Xt[Yt.at(t)]);if(""==n);else{let e=Bo(Yt.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);if(i){let t=i[1];Tr(t),e.lastName=t,Zt[t]=e}Kt+=1;let o="params"+Kt;this.remove(),Bo(o,!0),jo(),(Sa()||Lt)&&(Lt=!1,xa())}}));else{n=Et.add(Xt,e).name(""),Vr(n.domElement),n.domElement.classList.add("params");const t=Xt[e].match(/\s*(\w+)\s*=/);if(t){let e=t[1];Tr(e),n.lastName=e,Zt[e]=n}n.onFinishChange((function(){let t=Oo(Xt[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=Yt.indexOf(e);Yt.splice(t,1),delete Xt[e],n.hasOwnProperty("lastName")&&!ca(n.lastName)&&delete O[n.lastName]}else{i();const e=Va(t).match(/\s*(\w+)\s*=/);if(e){let t=e[1];Tr(t),n.hasOwnProperty("lastName")&&n.lastName!=t&&!ca(n.lastName)&&(delete O[n.lastName],n.lastName=t,Zt[t]=n)}}jo(),Sa()&&xa()})),jo(),Sa()&&xa()}return i(),n}function jo(){q.kineticParams=Object.values(Xt).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function zo(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function Go(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function Jo(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function Ho(){if(q.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+Ta(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==q.whatToPlot?($("#minLabel").html("$"+Ci[0]+"$"),$("#midLabel").html("$"+Ci[1]+"$"),$("#maxLabel").html("$"+Ci[2]+"$")):Mt?$("#midLabel").html(q.views[q.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+ko(q.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),ha(),Xo()}else $("#colourbar").hide()}function Xo(){if("MAX"!=q.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[Zo(e,n),Zo(t,n)]}(q.minColourValue,q.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=Ua(Ta(0)),t=Ua(Ta(.5)),n=Ua(Ta(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function Yo(e,t){return e.toPrecision(t)}function Zo(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function Ko(){q.timeDisplay?($("#timeDisplay").show(),ea()):$("#timeDisplay").hide(),ia()}function ea(){if(q.timeDisplay){let e=Yo(O.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/,"  10<sup>$2$3<sup>"),$("#timeValue").html(e),ra()}}function ta(){if(q.integrate){$("#integralDisplay").show();let e="";1==q.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+ko(q.whatToPlot)+"\\,\\d x",1==q.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();ia()}function na(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function ia(){q.integrate&&q.timeDisplay?na("#timeDisplay",10):na("#timeDisplay",0)}function oa(){let e=Do();!kt||isFinite(e[0])&&isFinite(e[1])?vt=setTimeout(oa,1e3):(kt=!1,Go("#oops_hit_nan"),no(),$("#oops_hit_nan").one("click",(function(){Jo("#oops_hit_nan"),kt=!0})),$("#erase").one("pointerdown",(function(){Jo("#oops_hit_nan"),kt=!0,window.clearTimeout(vt),vt=setTimeout(oa,1e3)})))}function aa(){if(!fn){try{l.readRenderTargetPixels(f,0,0,wt,Ct,sn)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}fn=!0}}function ra(){if(q.colourbar&&q.integrate|q.timeDisplay){let e,t=$("#colourbar")[0].getBoundingClientRect();e=q.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(na("#dataContainer",40),Nt=!0):Nt&&(na("#dataContainer",0),Nt=!1)}}function la(){sa()?(_t.forEach((e=>{e.texture.magFilter=ui.NearestFilter})),f.texture.magFilter=ui.NearestFilter,p.texture.magFilter=ui.NearestFilter):(_t.forEach((e=>{e.texture.magFilter=ui.LinearFilter})),f.texture.magFilter=ui.LinearFilter,p.texture.magFilter=ui.LinearFilter),Wo()}function sa(){return n||q.forceManualInterpolation}function ua(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function ca(e,t){return null==t&&(t=[]),function(e){return[...(_n()+kn()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e)}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function da(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function fa(){"line"==q.plotType?(Pa(),q.typeOfBrush="vline",zi(),ho(G),A.visible=!1,P.visible=!0,q.contours=!1,q.emboss=!1,q.vectorField=!1,Dr()):(A.visible=!0,P.visible=!1,"surface"==q.plotType?($("#simCanvas").css("outline","2px #000 solid"),zt&&(zt=!1,Ri()),q.vectorField=!1,Dr()):$("#simCanvas").css("outline","")),Q.visible=q.overlay&&"line"==q.plotType,Gi(),ki(),Wo()}function pa(){Pt||(1!=q.dimension&&"line"==q.plotType&&(q.plotType="plane",fa()),1==q.dimension&&"line"!=q.plotType&&(q.plotType="line",fa())),Qi(),uo(),Ro(),Wo(),ta()}function ma(){const e=(new ui.Vector3).setFromSphericalCoords(1,Math.PI/2-q.cameraTheta*Math.PI/180,-q.cameraPhi*Math.PI/180);i.position.set(e.x,e.y,e.z),i.lookAt(0,0,0)}function ha(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function ga(){return q.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function va(e){return Va(e)}function ba(){const e=/(\w+)\s*=/;return ga().split(";").filter((e=>e.length>0)).map((t=>t.match(e)[1].trim()))}function Sa(){const e=function(e){let t={},n={},i=[];e.forEach((function(e){const[n,i]=e.split("=").map((e=>e.trim()));t[n]=i}));const o=e.map((e=>e.split("=").map((e=>e.trim())))),a=o.map((e=>e[0]));for(const e of o){let[o,r]=e;o in n||([n,,i]=Ca(o,t,n,[o],a,[]))}i.length>0&&ja("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+".");return Object.keys(n).map((e=>[e,n[e]]))}(ga().split(";").filter((e=>e.length>0))),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}(ba());if(t.length>0)return ja("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=ya(t[0],t[1]);n|=n,i|=o}return n&&!i}function ya(e,t){let n=!1,i=!1;const o=va(e);return ca(o)?(ja("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!O.hasOwnProperty(o),O[o]={type:"float",value:t}),[n,i]}function wa(){return va(ba().map((e=>"uniform float "+e+";")).join("\n"))}function Ca(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const l of o)r=new RegExp("\\b"+l+"\\b","g"),r.test(t[e])&&(i.includes(l)?(n[l]=0,t[l]="0",t[e]="0",a.push(l)):([n,,a]=Ca(l,t,n,[...i,l],o,a),t[e]=t[e].replaceAll(r,n[l].toString())));try{n[e]=Ei.evaluate(t[e])}catch(t){ja("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function xa(){uo(),Vo(),zi(),Eo(),ji(),Ao()}function Va(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+pn[e])););return n}function Fa(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function Ua(e){return e.reduce(((e,t)=>e+t),0)/3}function $a(){let e=Do();q.minColourValue=e[0],q.maxColourValue=e[1],O.maxColourValue.value=q.maxColourValue,O.minColourValue.value=q.minColourValue,_e.updateDisplay(),Ee.updateDisplay(),Xo()}function Ea(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function _a(){let e;null!=Ci&&(e=Ci);const t=q.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,en.length),n=t.concat(nn.slice(t.length)),i=ba();let o;for(var a=0;a<n.length;a++)if(ca(n[a],i))return o=i.includes(n[a])?"as a parameter":"under the hood",void ja("The name '"+n[a]+"' is used "+o+", so can't be used as a species name. Please use a different name for "+n[a]+".");Ci=n,xi=Ci.map((e=>"f_{"+e+"}")),function(){Vi=[];for(let e=0;e<Ci.length;e++)Vi.push("(?:"+Ci.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let r={...bi(),...yi()};Object.keys(r).forEach((function(e){Ui[e]=ko(Da(r[e],en,Ci,"_(?:x+|y+)"))})),r=Si(),Object.keys(r).forEach((function(e){Ui[e]=ko(Da(r[e],tn,xi))})),Pt||(Object.keys(q).forEach((function(t){_i.includes(t)&&(q[t]=Da(q[t],e,Ci,"_(?:x+|y+)"))})),q.views=q.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){_i.includes(i)&&(n[i]=Da(t[i],e,Ci,"_(?:x+|y+)"))})),n})),Object.keys(j).forEach((function(t){_i.includes(t)&&(j[t]=Da(j[t],e,Ci,"_(?:x+|y+)"))})),j.views=j.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){_i.includes(i)&&(n[i]=Da(t[i],e,Ci,"_(?:x+|y+)"))})),n})),Po(),Wo(),xa(),Ro())}function Da(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function Aa(e,t){let n,i=e.geometry.attributes.instanceStart,o=e.geometry.attributes.instanceEnd;for(let e=0;e<t.length;e++)n=t[e].toArray(),n[1]*=q.threeDHeightScale,e<t.length&&i.setXYZ(e,n[0],n[1],0),e>0&&o.setXYZ(e-1,n[0],n[1],0);i.needsUpdate=!0,o.needsUpdate=!0}function Ta(e){e=e.clamp(0,1);let t=0;for(;e>=L[t+1]&&t<N.length-2;)t+=1;return L[t+1]==L[t]?N[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=Wa(e[o],t[o],n);return i}(N[t],N[t+1],(e-L[t])/(L[t+1]-L[t])).map((e=>e.clamp(0,1)))}function Wa(e,t,n){return(1-(n=n.clamp(0,1)))*e+n*t}function Pa(){x.linewidth=.01*q.lineWidthMul,V.linewidth=.01*q.lineWidthMul,x.needsUpdate=!0,V.needsUpdate=!0}function Qa(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function Ra(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function ka(e){e.forEach((function(e){Wt.add(e)})),Ro()}function Ma(e){e.forEach((function(e){Wt.delete(e)})),Ro()}function Ia(){un=new Float32Array(wt*Ct*4),l.readRenderTargetPixels(_t[1],0,0,wt,Ct,un),Oa(un),Ot=!0}function Na(){Ot||Ia();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([wt,Ct]),un])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function La(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);Oa(e.slice(2),e.slice(0,2)),qa(h),Ot=!0,oo()},t.readAsArrayBuffer(e)}function qa(e){if(null!=e)if("crop"==q.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=s/t;i>1&&(n=t/s,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function Oa(e,t){null!=h&&h.dispose(),null==t&&(t=[wt,Ct]),h=new ui.DataTexture(e,t[0],t[1],ui.RGBAFormat,ui.FloatType),h.needsUpdate=!0,h.magFilter=n?ui.NearestFilter:ui.LinearFilter,null!=E&&(E.map=h,E.needsUpdate)}function Ba(){l.setSize(Math.round(devicePixelRatio*Ut),Math.round(devicePixelRatio*$t),!1)}function ja(e){no(),Pt&&Qt||(Qt=!0,$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),Go("#error"),$("#error").one("click",(function(){Jo("#error")}))))}function za(e){if(/\(\s*\)/.test(e))return ja("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(ja("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(ja("A binary operator is missing an operand in "+e.trim()+"."),!1)}function Ga(){let e;$("#views_list").empty();for(let t=0;t<q.views.length;t++)e=document.createElement("a"),e.onclick=function(){q.activeViewInd=t,Ja(q.views[t])},e.innerHTML="<div class='view_label'>"+q.views[t].name+"</div>",t==q.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);Bt=Math.max(q.views.length,Bt),q.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),q.views.length}function Ja(e,t){Object.assign(q,e),delete q.name,ho(J),(null==t||t)&&(Eo(),fa(),Gi(),Mi(),Xo(),Ho(),Dr(),Sr(),Hi())}function Ha(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",q.views[q.activeViewInd].name);null!=e&&(q.views[q.activeViewInd].name=e,Ga(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function Xa(){q.views.length>1?(q.views.splice(q.activeViewInd,1),q.activeViewInd<1?q.activeViewInd=0:q.activeViewInd-=1):q.views[q.activeViewInd].name="Custom",Ja(q.views[q.activeViewInd])}function Ya(){let e={};return $i.forEach((function(t){e[t]=j[t]})),e}function Za(e){q.activeViewInd<q.views.length&&(q.views[q.activeViewInd][e]=q[e])}function Ka(e,t){let n="";return n+=yo(Pn(t),Ci[e]),q.dimension>1&&(n+=yo(Qn(t),Ci[e])),n}function er(e,t){let n="";return n+=yo(An(t),Ci[e]),q.dimension>1&&(n+=yo(Tn(t),Ci[e])),n}function tr(e,t){let n="";return n+=yo(Pn(t),Ci[e]),q.dimension>1&&(n+=yo(Qn(t),Ci[e])),n}function nr(e,t){let n="";return n+=yo(An(t).replaceAll(/updated/g,"gl_FragColor"),Ci[e]),q.dimension>1&&(n+=yo(Tn(t).replaceAll(/updated/g,"gl_FragColor"),Ci[e])),n}function ir(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function or(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function ar(e,t,n,i,o,a,r,l){const s=document.createElement("a");if(s.classList.add("toggle_button"),s.setAttribute("property",t),null==i&&(i=()=>{}),s.onclick=function(){q[s.getAttribute("property")]=!q[s.getAttribute("property")],xr(s),i()},null!=o&&(s.id=o),null!=a&&(s.title=a),null!=n&&(s.innerHTML=n),null!=r&&s.setAttribute("folderID",r),null!=l)for(const e of l)s.classList.add(e);return e.appendChild(s),xr(s),s}function rr(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function lr(){let e=_o(q,oi("default"));1==q.views.length&&"1"==q.views[0].name&&delete e.views;for(const e of Object.keys(q.views[0]))q.hasOwnProperty(e)&&q.views.map((t=>t[e])).every((t=>t==q[e]))&&q.views.forEach((t=>delete t[e]));e.preset="PRESETNAME";let t=JSON.stringify(e).replaceAll(/\s*,\s*([^0-9-\.\s])/g,",\n\t$1").replaceAll(":",": ").replaceAll("  "," ").replace("{","{\n\t").replace("}",",\n}");t='case "PRESETNAME":\n\toptions = '+t+";\nbreak;",navigator.clipboard.writeText(t)}function sr(){let t="";t+=JSON.stringify(q),t+=JSON.stringify(O),t+=JSON.stringify({nXDisc:wt,nYDisc:Ct,domainHeight:Vt,domainWidth:xt,aspectRatio:s,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(t)}function ur(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function cr(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function dr(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function fr(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function pr(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function mr(){let e=_o(q,oi("default"));return e.preset="Custom",e=mi(e),[location.href.replace(location.search,""),"?options=",gi.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function hr(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function gr(e){const t=Zt[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function vr(){O.embossAmbient.value=q.embossAmbient,O.embossDiffuse.value=q.embossDiffuse,O.embossShiny.value=q.embossShiny,O.embossSmoothness.value=q.embossSmoothness,O.embossSpecular.value=q.embossSpecular,O.embossLightDir.value=new ui.Vector3(Math.sin(q.embossTheta)*Math.cos(q.embossPhi),Math.sin(q.embossTheta)*Math.sin(q.embossPhi),Math.cos(q.embossTheta))}function br(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function Sr(){for(const e of[...Tt,...At]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function yr(){O.contourColour.value=new ui.Color(q.contourColour),O.contourEpsilon.value=q.contourEpsilon,O.contourStep.value=1/(q.contourNum+1)}function wr(){O.overlayColour.value=new ui.Color(q.overlayColour),O.overlayEpsilon.value=q.overlayEpsilon,O.overlayLine.value=q.overlay&&"line"==q.plotType,V.color=new ui.Color(q.overlayColour),V.needsUpdate=!0}function Cr(){pt||Hi()}function xr(e){q[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function Vr(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function Fr(){q.customSurface?v.vertexShader=ei():v.vertexShader=Kn(),v.needsUpdate=!0}function Ur(){"surface"==q.plotType?($("#customSurfaceToggle").show(),q.customSurface?(bo(Ve),vo(xe)):(vo(Ve),bo(xe))):($("#customSurfaceToggle").hide(),vo(Ve))}function $r(){I=new ui.Group,a.add(I);const e=Math.max(wt,Ct),t=Math.round(Wa(3,window.width<629?20:32,q.arrowDensity));let n=Math.max(Math.floor(e/t),1);const i=Math.floor(wt/n),o=Math.floor(Ct/n),r=Math.floor((wt-n*(i-1))/2),l=Math.floor((Ct-n*(o-1))/2);let s,u,c,d,f,p;for(let e=0;e<o;e++){u=l+e*n,p=((u+.5)/Ct-.5)*A.geometry.parameters.height;for(let e=0;e<i;e++)c=r+e*n,f=((c+.5)/wt-.5)*A.geometry.parameters.width,s=c+u*wt,d=Er([f,p,1],[0,0,0]),d.ind=s,I.add(d)}}function Er(e,t){const n=new ui.Group,i=new ui.Mesh(_,F);i.rotation.x=Math.PI/2;const o=new ui.Mesh(D,F);return o.rotation.x=Math.PI/2,o.rotation.y=Math.PI/4,o.position.z=_.parameters.height/2,n.add(i),n.add(o),n.scale.multiplyScalar(Ht),n.position.set(e[0],e[1],e[2]),n.lookAt(e[0]+t[0],e[1]+t[1],e[2]+t[2]),n}function _r(){if(I)for(a.remove(I);I.children.length;)I.remove(I.children[0])}function Dr(){if(O.vectorField.value=q.vectorField,q.vectorField){if(_r(),$r(),Ar(),"relative"==q.arrowScale)try{I.customMax=Ei.evaluate(q.arrowLengthMax)}catch(e){ja("Unable to evaluate the maximum arrow length. Please check the definition."),I.customMax=1}}else _r()}function Ar(){F.color=new ui.Color(q.arrowColour)}function Tr(e){const t=ca(e,Ci.concat(xi));return t&&ja("The name '"+e+"' is already in use, so can't be used as a parameter name. Please use a different name for "+e+"."),!t}Wi&&po("GrayScott"),Mt=Ti.has("story"),Mt&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),ut.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),Ho(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),yt=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),(zo()||Wi||q.forceTryClickingPopup)&&!q.suppressTryClickingPopup&&q.brushEnabled&&($("#top_message").html("<p>"+q.tryClickingText+"</p>"),Go("#top_message"),setTimeout((()=>Jo("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>Jo("#top_message")))),$("#settings").click((function(){ur(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&fr(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&pr(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&cr(),$("#views_ui").is(":visible")&&dr()),$("#left_ui").is(":visible")&&Fa()})),$("#equations").click((function(){cr(),Fa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&ur(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&dr()})),$("#pause").click((function(){no()})),$("#play").click((function(){io()})),$("#erase").click((function(){oo()})),$("#share").click((function(){pr(),$("#help_panel").is(":visible")&&fr()})),$("#help").click((function(){fr(),$("#share_panel").is(":visible")&&pr()})),$("#screenshot").click((function(){dn=!0,Hi(),pr()})),$("#link").click((function(){B.copyConfigAsURL(),pr()})),$("#embed").click((function(){!function(){let e=mr();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}hr('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),pr()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){fr()})),$("#views").click((function(){dr(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&ur(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&cr()})),$(document).on("click","#add_view",(function(){!function(){let e=Ya();e.name=++Bt,q.views.push(e),q.activeViewInd=q.views.length-1,Ga()}()})),Pt=!1,function e(){requestAnimationFrame(e),ht=mt,mt&&q.brushEnabled&&function(){!q.fixRandSeed&&q.brushValue.includes("RAND")&&xo();T.material=b;for(let e=1;e<_t.length;e++)O.textureSource.value=_t[e].texture,l.setRenderTarget(_t[e-1]),l.render(r,o);_t.rotate(-1)}();if(pt){!gt||function(){T.material=S;for(let e=1;e<_t.length;e++)O.textureSource.value=_t[e].texture,l.setRenderTarget(_t[e-1]),l.render(r,o);_t.rotate(-1)}();for(let e=0;e<q.numTimestepsPerFrame;e++){if(q.autoPause&&Rt&&O.t.value>=q.autoPauseAt){Rt=!1,no();break}It&&!q.fixRandSeed&&xo(),Ji()}}(ht||pt)&&Hi()}();