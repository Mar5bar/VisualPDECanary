let e,n,t,i,o,a,r,l,s,u,c,d,f,m,p,h,g,b,v,S,y,w,C,V,x,U,_,F,E,D,W,T,A,Q,R,P,k,N,I,M,L,O,q,B,j,G,z,J,H,X,Y,Z,K,ee,ne,te,ie,oe,ae,re,le,se,ue,ce,de,fe,me,pe,he,ge,be,ve,Se,ye,we,Ce,Ve,xe,Ue,_e,Fe,$e,Ee,De,We,Te,Ae,Qe,Re,Pe,ke,Ne,Ie,Me,Le,Oe,qe,Be,je,Ge,ze,Je,He,Xe,Ye,Ze,Ke,en,nn,tn,on,an,rn,ln,sn,un,cn,dn,fn,mn,pn,hn,gn,bn,vn,Sn,yn,wn,Cn,Vn,xn,Un,_n,Fn,$n,En,Dn=[],Wn={},Tn=new Set,An=!1,Qn=!1,Rn=!1,Pn=!1,kn=!1,Nn=!1,In=0,Mn=!1,Ln=!0,On=1,qn={},Bn=[],jn={},Gn=0;const zn=["u","v","w","q"],Jn=["UFUN","VFUN","WFUN","QFUN"],Hn=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"],Xn=["REACT1","REACT2","REACT3","REACT4"];let Yn,Zn,Kn,et,nt,tt,it=!1,ot=!1;const at=["zero","one","two","three","four","five","six","seven","eight","nine"];import{drawShaderTop as rt,drawShaderBotReplace as lt,drawShaderBotAdd as st,drawShaderShapeDisc as ut,drawShaderShapeVLine as ct,drawShaderShapeHLine as dt,drawShaderFactorSharp as ft,drawShaderFactorSmooth as mt}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as pt,computeDisplayFunShaderMid as ht,computeMaxSpeciesShaderMid as gt,postGenericShaderBot as bt,postShaderDomainIndicator as vt,interpolationShader as St}from"./post_shaders.js";import{copyShader as yt}from"../copy_shader.js";import{RDShaderTop as wt,RDShaderBot as Ct,RDShaderDirichletX as Vt,RDShaderDirichletY as xt,RDShaderDirichletIndicatorFun as Ut,RDShaderRobinX as _t,RDShaderRobinY as Ft,RDShaderUpdateNormal as $t,RDShaderUpdateCross as Et,RDShaderAlgebraicSpecies as Dt,RDShaderEnforceDirichletTop as Wt,RDShaderAdvectionPreBC as Tt,RDShaderAdvectionPostBC as At,RDShaderDiffusionPreBC as Qt,RDShaderDiffusionPostBC as Rt,RDShaderGhostX as Pt,RDShaderGhostY as kt,RDShaderMain as Nt}from"./simulation_shaders.js";import{randShader as It,randNShader as Mt}from"../rand_shader.js";import{fiveColourDisplayTop as Lt,fiveColourDisplayBot as Ot,embossShader as qt,contourShader as Bt,surfaceVertexShader as jt,overlayShader as Gt}from"./display_shaders.js";import{getColours as zt}from"../colourmaps.js";import{genericVertexShader as Jt}from"../generic_shaders.js";import{getPreset as Ht,getUserTextFields as Xt,getFieldsInView as Yt}from"./presets.js";import{clearShaderBot as Zt,clearShaderTop as Kt}from"./clear_shader.js";import*as ei from"../three.module.min.js";import{OrbitControls as ni}from"../OrbitControls.js";import{Line2 as ti}from"../lines/Line2.js";import{LineMaterial as ii}from"../lines/LineMaterial.js";import{LineGeometry as oi}from"../lines/LineGeometry.js";import{minifyPreset as ai,maxifyPreset as ri}from"./minify_preset.js";import{LZString as li}from"../lz-string.min.js";import{equationTEXFun as si,getDefaultTeXLabelsDiffusion as ui,getDefaultTeXLabelsReaction as ci,getDefaultTeXLabelsBCsICs as di,substituteGreek as fi}from"./TEX.js";let mi,pi,hi,gi=si(),bi={...ui(),...ci(),...di()};const vi=Yt();P={};const Si=Xt();var yi,wi;N={reset:function(){Ji()},toggleRunning:function(){pn?Gi():zi()},copyConfigAsURL:function(){Ya(Xa())},saveSimState:function(){xa()},exportSimState:function(){Ua()},clearCheckpoints:function(){Nn&&(h.dispose(),h=null,Nn=!1)},restoreCurrentView:function(){var e;P.activeViewInd<P.views.length&&(e=P.activeViewInd,P.views[e]=yn[e],Aa(P.views[e]))}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,n){return Math.min(Math.max(this,e),n)},Array.prototype.rotate=(yi=Array.prototype.push,wi=Array.prototype.splice,function(e){var n=this.length>>>0;return e=((e>>=0)%n+n)%n,yi.apply(this,wi.call(this,0,e)),this}),e=document.getElementById("simCanvas"),console.error=function(e){Pn=!0;let n=e.toString();console.log(n);let t=/ERROR.*/;!t.test(n)||(n=n.match(t)),Da(n)},Po()||$("#logo").hide();const Ci=new URLSearchParams(window.location.search);if(Ci.has("no_ui")?($(".ui").addClass("hidden"),kn=!0):$(".ui").removeClass("hidden"),Ci.has("sf")&&(On=parseFloat(Ci.get("sf")),(isNaN(On)||On<=0)&&(On=1)),!function(){for(var e=document.cookie.split(";"),n=0;n<e.length;n++){if("warning"==e[n].split("=")[0].trim())return!0}return!1}()&&!kn){$("#warning").css("display","block");await Promise.race([Ko(document.getElementById("warning_ok"),"click",!0),Ko(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let n="expires="+e.toUTCString();document.cookie="warning=true;"+n+";path=/"}(),$("#warning").css("display","none")}io("default"),function(){k={brushCoords:{type:"v2",value:new ei.Vector2(.5,.5)},colour1:{type:"v4",value:new ei.Vector4(0,0,0,0)},colour2:{type:"v4",value:new ei.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new ei.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new ei.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new ei.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0}},hn=!1,c=new ei.Raycaster,d=new ei.Vector2,l=new ei.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),l.autoClear=!0,n=l.getContext(),t=!(n.getExtension("OES_texture_float_linear")&&n.getExtension("EXT_float_blend")),p={format:ei.RGBAFormat,type:ei.FloatType,minFilter:ei.NearestFilter},t|=/android/i.test(navigator.userAgent),p.magFilter=t?ei.NearestFilter:ei.LinearFilter,Dn.push(new ei.WebGLRenderTarget(P.maxDisc,P.maxDisc,p)),Dn.push(Dn[0].clone()),Dn.push(Dn[0].clone()),Dn.push(Dn[0].clone()),Dn.push(Dn[0].clone()),f=Dn[0].clone(),m=Dn[0].clone(),Dn.forEach((e=>{e.texture.wrapS=ei.RepeatWrapping,e.texture.wrapT=ei.RepeatWrapping})),f.texture.wrapS=ei.ClampToEdgeWrapping,f.texture.wrapT=ei.ClampToEdgeWrapping,m.texture.wrapS=ei.ClampToEdgeWrapping,m.texture.wrapT=ei.ClampToEdgeWrapping,i=new ei.OrthographicCamera(-.5,.5,.5,-.5,-1,10),u=new ni(i,e),u.listenToKeyEvents(document),u.addEventListener("change",(function(){"surface"==P.plotType&&(P.cameraTheta=90-180*Math.atan2(i.position.z,i.position.y)/Math.PI,P.cameraPhi=180*Math.atan2(i.position.x,i.position.z)/Math.PI,P.cameraZoom=i.zoom,oo(L),Ii())})),o=new ei.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new ei.Scene,r=new ei.Scene,a.add(i),a.background=new ei.Color(P.backgroundColour),g=new ei.MeshBasicMaterial({side:ei.DoubleSide}),b=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt(),transparent:!0,side:ei.DoubleSide}),C=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt()}),x=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt(),fragmentShader:St()}),v=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt()}),Wn.FE=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt()}),Wn.AB2=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt()});for(let e=1;e<3;e++)Wn["Mid"+e.toString()]=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt()});for(let e=1;e<5;e++)Wn["RK4"+e.toString()]=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt()});w=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt(),fragmentShader:yt()}),y=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt()}),S=new ei.ShaderMaterial({uniforms:k,vertexShader:Jt()}),V=new ii({vertexColors:!0,linewidth:.01}),U=new ei.MeshBasicMaterial;const s=new ei.PlaneGeometry(1,1);F=new ei.Mesh(s,Wn[0]),F.position.z=0,r.add(F),Di(),Wi(),Fi(),Ai(),Ui(),Qi(),Vo(),Uo(),Pi(),Ri(),po(),Yo(),Ji(),e.addEventListener("pointerdown",Li),e.addEventListener("pointerup",Oi),e.addEventListener("pointermove",qi),document.addEventListener("keypress",(function(e){var n=(e=e||window.event).target,t=1==n.nodeType?n.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(t)||("r"===e.key&&$("#erase").click()," "===e.key&&N.toggleRunning(),"h"===e.key&&(kn?(kn=!1,$(".ui").removeClass("hidden"),fn.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",wn),pn?zi():Gi(),Xo(),aa(),da()):(kn=!0,$(".ui").addClass("hidden"))),"s"==e.key&&xa(),"c"==e.key&&(P.resetFromCheckpoints=!P.resetFromCheckpoints,oo(L)))})),window.addEventListener("resize",Ui,!1),window.addEventListener("message",Za),$("#checkpointInput").change((function(){_a(this.files[0]),this.value=null}))}();let Vi=!0;if(Ci.has("preset")&&(to(Ci.get("preset")),Vi=!1),Ci.has("options")){var xi=JSON.parse(li.decompressFromEncodedURIComponent(Ci.get("options")));xi.hasOwnProperty("p")&&(xi=ri(xi)),to(xi),Vi=!1}function Ui(){Di(),function(){F.material=w;for(let e=1;e<Dn.length;e++)k.textureSource.value=Dn[e].texture,Dn[e-1].setSize(Cn,Vn),l.setRenderTarget(Dn[e-1]),l.render(r,o);Dn.rotate(-1),Dn[0].dispose(),Dn[0]=Dn[1].clone(),f.setSize(Cn,Vn),Mi(),m.setSize(Math.round(devicePixelRatio*Fn),Math.round(devicePixelRatio*$n))}(),Fa(h),$i(),_i(),Fi(),aa(),da(),Ii()}function _i(){_.geometry.dispose(),a.remove(_),E.geometry.dispose(),a.remove(E),D.geometry.dispose(),a.remove(D),Wi()}function Fi(){switch(Ei(),P.plotType){case"line":P.cameraTheta=0,P.cameraPhi=0,u.enabled=!1,i.zoom=1,oa(),b.vertexShader=jt();break;case"plane":u.enabled=!1,u.reset(),b.vertexShader=Jt();break;case"surface":u.enabled=!0,i.zoom=P.cameraZoom,oa(),b.vertexShader=jt()}b.needsUpdate=!0,i.left=-xn/(2*_n),i.right=xn/(2*_n),i.top=Un/(2*_n),i.bottom=-Un/(2*_n),i.updateProjectionMatrix(),Ti()}function $i(){k.L.value=P.domainScale,k.L_y.value=Un,k.L_x.value=xn,k.L_min.value=Math.min(Un,xn),k.dt.value=P.dt,k.dx.value=xn/Cn,k.dy.value=Un/Vn,k.heightScale.value=P.threeDHeightScale,k.maxColourValue.value=P.maxColourValue,k.minColourValue.value=P.minColourValue,Ka(),P.fixRandSeed||mo()}function Ei(){Fn=Math.round(e.getBoundingClientRect().width),$n=Math.round(e.getBoundingClientRect().height),s=$n/Fn,s<=0&&(s=.1),s>=1?(Un=P.domainScale,xn=Un/s):(xn=P.domainScale,Un=xn*s),1==P.dimension&&(xn=P.domainScale),k.L_x.value=xn,k.L_y.value=Un,_n=Math.max(xn,Un)}function Di(){Ei(),0==P.spatialStep&&(alert("Oops! A spatial step of 0 would almost certainly crash your device. We've reset it to 1% of the maximum domain length to prevent this."),P.spatialStep=P.domainScale/100),Cn=Math.floor(xn/P.spatialStep),Vn=Math.floor(Un/P.spatialStep),0==Cn&&(Cn=1),0==Vn&&(Vn=1),1==P.dimension&&(Vn=1),k.nXDisc.value=Cn,k.nYDisc.value=Vn,W=new Array(Cn),T=new Array(Cn);let e=-.5,n=1/Cn;for(let t=0;t<W.length;t++)W[t]=e,e+=n;Ea(),nt=new Float32Array(Cn*Vn*4),ot=!1}function Wi(){Ei();let e=[1,1];Ln||(e=[Cn,Vn]);const n=new ei.PlaneGeometry(xn/_n,Un/_n,e[0],e[1]);_=new ei.Mesh(n,b),_.position.z=0,_.visible="line"!=P.plotType,_.matrixAutoUpdate=!1,a.add(_);const t=new ei.PlaneGeometry(xn/_n,Un/_n,1,1);E=new ei.Mesh(t,g),E.position.z=0,E.visible=!1,E.matrixAutoUpdate=!1,a.add(E),Ti();const i=new oi;A=Math.round(devicePixelRatio*Fn);const o=new Array(3*A).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),D=new ti(i,V),D.scale.set(1,1,1),D.visible="line"==P.plotType,a.add(D)}function Ti(){switch(P.plotType){case"plane":_.rotation.x=0,E.rotation.x=0;break;case"surface":_.rotation.x=-Math.PI/2,E.rotation.x=-Math.PI/2}_.updateMatrix(),E.updateMatrix()}function Ai(){P.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Qi(e){M=new dat.GUI({closeOnTop:!0,autoPlace:!1}),M.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(M.domElement),L=new dat.GUI({closeOnTop:!0,autoPlace:!1}),L.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(L.domElement),O=new dat.GUI({closeOnTop:!0,autoPlace:!1}),O.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(O.domElement),M.open(),L.open(),O.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),q=L.addFolder("Brush"),q.add(P,"brushEnabled").name("Enabled"),q.add(P,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange(Pi),B=q.add(P,"typeOfBrush",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange(Pi),q.add(P,"brushValue").name("Value").onFinishChange(Pi),q.add(P,"brushRadius").name("Radius").onChange(Pi),he=q.add(P,"whatToDraw",mi).name("Species").onChange(Pi),q=L.addFolder("Domain"),q.add(P,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){ia(),Ii()})),q.add(P,"domainScale").name("Largest side").onChange(Ui);const n=q.add(P,"spatialStep").name("Space step").onChange((function(){Ui()}));n.__precision=12,n.min(0),n.updateDisplay(),q.add(P,"squareCanvas").name("Square").onFinishChange((function(){Ai(),Ui(),Fi()})),q.add(P,"domainViaIndicatorFun").name("Implicit").onFinishChange((function(){xo(),Vo(),Ki(),wo()})),Y=q.add(P,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){xo(),Vo(),Ki(),vo()})),q=L.addFolder("Timestepping"),on=q.add(P,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),er(on,1,400,1),pe=q.add(P,"dt").name("Timestep").onChange((function(){$i()})),pe.__precision=12,pe.min(0),pe.updateDisplay(),q.add(P,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme"),q.add(P,"timeDisplay").name("Show time").onChange(qo),q=L.addFolder("Equations"),q.add(P,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange(Uo),X=q.add(P,"crossDiffusion").name("Cross diffusion").onChange(Uo),H=q.add(P,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Mn=!0,Uo(),Mn=!1})),q.add(P,"speciesNames").name("Species names").onFinishChange((function(){ha()})),q.add(P,"reactionNames").name("Reactions").onFinishChange((function(){ha()})),q=M.addFolder("Definitions"),q.add(P,"typesetCustomEqs").name("Typeset").onChange(_o),Z=q.add(P,"diffusionStrUU").onFinishChange((function(){Ki(),_o()})),ya(Z,Ca,["D","U","UU"]),wa(Z,Va,["D","U","UU"]),K=q.add(P,"diffusionStrUV").onFinishChange((function(){Ki(),_o()})),ya(K,Ca,["UV"]),wa(K,Va,["UV"]),ee=q.add(P,"diffusionStrUW").onFinishChange((function(){Ki(),_o()})),ya(ee,Ca,["UW"]),wa(ee,Va,["UW"]),ne=q.add(P,"diffusionStrUQ").onFinishChange((function(){Ki(),_o()})),ya(ne,Ca,["UQ"]),wa(ne,Va,["UQ"]),te=q.add(P,"diffusionStrVU").onFinishChange((function(){Ki(),_o()})),ya(te,Ca,["VU"]),wa(te,Va,["VU"]),ie=q.add(P,"diffusionStrVV").onFinishChange((function(){Ki(),_o()})),ya(ie,Ca,["V","VV"]),wa(ie,Va,["V","VV"]),oe=q.add(P,"diffusionStrVW").onFinishChange((function(){Ki(),_o()})),ya(oe,Ca,["VW"]),wa(oe,Va,["VW"]),ae=q.add(P,"diffusionStrVQ").onFinishChange((function(){Ki(),_o()})),ya(ae,Ca,["VQ"]),wa(ae,Va,["VQ"]),re=q.add(P,"diffusionStrWU").onFinishChange((function(){Ki(),_o()})),ya(re,Ca,["WU"]),wa(re,Va,["WU"]),le=q.add(P,"diffusionStrWV").onFinishChange((function(){Ki(),_o()})),ya(le,Ca,["WV"]),wa(le,Va,["WV"]),se=q.add(P,"diffusionStrWW").onFinishChange((function(){Ki(),_o()})),ya(se,Ca,["W","WW"]),wa(se,Va,["W","WW"]),ue=q.add(P,"diffusionStrWQ").onFinishChange((function(){Ki(),_o()})),ya(ue,Ca,["WQ"]),wa(ue,Va,["WQ"]),ce=q.add(P,"diffusionStrQU").onFinishChange((function(){Ki(),_o()})),ya(ce,Ca,["QU"]),wa(ce,Va,["QU"]),de=q.add(P,"diffusionStrQV").onFinishChange((function(){Ki(),_o()})),ya(de,Ca,["QV"]),wa(de,Va,["QV"]),fe=q.add(P,"diffusionStrQW").onFinishChange((function(){Ki(),_o()})),ya(fe,Ca,["QW"]),wa(fe,Va,["QW"]),me=q.add(P,"diffusionStrQQ").onFinishChange((function(){Ki(),_o()})),ya(me,Ca,["Q","QQ"]),wa(me,Va,["Q","QQ"]),j=q.add(P,"reactionStrU").onFinishChange((function(){Ki(),_o()})),ya(j,Ca,["UFUN"]),wa(j,Va,["UFUN"]),G=q.add(P,"reactionStrV").onFinishChange((function(){Ki(),_o()})),ya(G,Ca,["VFUN"]),wa(G,Va,["VFUN"]),z=q.add(P,"reactionStrW").onFinishChange((function(){Ki(),_o()})),ya(z,Ca,["WFUN"]),wa(z,Va,["WFUN"]),J=q.add(P,"reactionStrQ").onFinishChange((function(){Ki(),_o()})),ya(J,Ca,["QFUN"]),wa(J,Va,["QFUN"]),En=M.addFolder("Parameters"),function(){let e,n,t=P.kineticParams.split(";");for(var i=0;i<t.length;i++)n=Ao(t[i]),""==n||(n=n.replace(/(\S)=/,"$1 ="),n=n.replace(/=(\S)/,"= $1"),n=n.replaceAll(/,(\S)/g,", $1"),e="param"+Gn,Gn+=1,Bn.push(e),qn[e]=n,Qo(e,!1));e="param"+Gn,Bn.push(e),qn[e]=n,Qo(e,!0)}(),q=M.addFolder("Boundary conditions"),Le=q.add(P,"boundaryConditionsU",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){Ki(),fo()})),je=q.add(P,"dirichletStrU").onFinishChange(Ki),Ke=q.add(P,"neumannStrU").onFinishChange(Ki),an=q.add(P,"robinStrU").onFinishChange(Ki),He=q.add(P,"comboStrU").name("Details").onFinishChange(Ki),Oe=q.add(P,"boundaryConditionsV",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){Ki(),fo()})),Ge=q.add(P,"dirichletStrV").onFinishChange(Ki),en=q.add(P,"neumannStrV").onFinishChange(Ki),rn=q.add(P,"robinStrV").onFinishChange(Ki),Xe=q.add(P,"comboStrV").name("Details").onFinishChange(Ki),qe=q.add(P,"boundaryConditionsW",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){Ki(),fo()})),ze=q.add(P,"dirichletStrW").onFinishChange(Ki),nn=q.add(P,"neumannStrW").onFinishChange(Ki),ln=q.add(P,"robinStrW").onFinishChange(Ki),Ye=q.add(P,"comboStrW").name("Details").onFinishChange(Ki),Be=q.add(P,"boundaryConditionsQ",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).name("$q$").onChange((function(){Ki(),fo()})),Je=q.add(P,"dirichletStrQ").onFinishChange(Ki),tn=q.add(P,"neumannStrQ").onFinishChange(Ki),sn=q.add(P,"robinStrQ").onFinishChange(Ki),Ze=q.add(P,"comboStrQ").name("Details").onFinishChange(Ki),q=M.addFolder("Initial conditions"),ke=q.add(P,"clearValueU").onFinishChange(po),Ne=q.add(P,"clearValueV").onFinishChange(po),Ie=q.add(P,"clearValueW").onFinishChange(po),Me=q.add(P,"clearValueQ").onFinishChange(po);let t=L.addFolder("Plotting");q=t,ge=q.add(P,"lineWidthMul",.1,2).name("Thickness").onChange((function(){Sa(),Ii()})),be=q.add(P,"threeDHeightScale").name("Max height").onChange($i),ve=q.add(P,"cameraTheta").name("View $\\theta$").onChange(Fi),Se=q.add(P,"cameraPhi").name("View $\\phi$").onChange(Fi),ye=q.add(P,"cameraZoom").name("Zoom").onChange(Fi),we=q.add(P,"forceManualInterpolation").name("Manual interp").onChange(Yo),q=q.addFolder("Contours"),Ue=q.add(P,"contourNum").name("Number").onChange((function(){nr(),ir()})),er(Ue,1,20,1),xe=q.add(P,"contourEpsilon").name("Threshold").onChange((function(){nr(),ir()})),er(xe,.001,.05,.001),q=t.addFolder("Overlay"),q.add(P,"overlayExpr").name("Overlay expr.").onFinishChange((function(){ki(),ka(this.property)})),q.add(P,"overlayEpsilon").name("Threshold").onChange((function(){tr(),ir()})),q=L.addFolder("Colour"),q.add(P,"colourbar").name("Colour bar").onChange(Io),q.addColor(P,"backgroundColour").name("Background").onChange((function(){a.background=new ei.Color(P.backgroundColour),Ii()})),q.addColor(P,"contourColour").name("Contours").onChange((function(){nr(),ir()})),q.addColor(P,"overlayColour").name("Overlay").onChange((function(){tr(),ir()})),q=q.addFolder("Lighting"),We=q.add(P,"embossSmoothness").name("Smoothness").onChange((function(){Ka(),ir()})),er(We,0,2,.001),Te=q.add(P,"embossAmbient").name("Ambient").onChange((function(){Ka(),ir()})),er(Te,0,1,.001),Ae=q.add(P,"embossDiffuse").name("Diffuse").onChange((function(){Ka(),ir()})),er(Ae,0,1,.001),Qe=q.add(P,"embossSpecular").name("Specular").onChange((function(){Ka(),ir()})),er(Qe,0,1,.001),De=q.add(P,"embossShiny").name("Precision").onChange((function(){Ka(),ir()})),er(De,0,100,1),Re=q.add(P,"embossTheta").name("Inclination").onChange((function(){Ka(),ir()})),er(Re,0,1.5708,.001),Pe=q.add(P,"embossPhi").name("Direction").onChange((function(){Ka(),ir()})),er(Pe,0,3.1456,.001),un=L.addFolder("Images"),q=un,bo(),q=L.addFolder("Checkpoints"),q.add(P,"resetFromCheckpoints").name("Enabled"),q.add(P,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize");const i=document.createElement("li");i.classList.add("button_list"),q.domElement.children[0].appendChild(i),Oa(i,"Set",xa),Oa(i,"Export",Ua),Oa(i,"Import",(function(){$("#checkpointInput").click()})),q=L.addFolder("Misc."),q.add(P,"integrate").name("Integrate").onChange((function(){jo(),Ii()})),q.add(P,"fixRandSeed").name("Fix random seed");const o=document.createElement("li");o.classList.add("button_list"),q.domElement.children[0].appendChild(o),Oa(o,'<i class="fa-regular fa-copy"></i> Copy code',qa),q=q.addFolder("Debug");const r=document.createElement("li");r.classList.add("button_list"),q.domElement.children[0].appendChild(r),Oa(r,"Copy debug information",Ba);const l=document.createElement("div");l.innerHTML="Settings",l.classList.add("ui_title"),L.domElement.prepend(l);const s=document.createElement("div");s.innerHTML="Equations",s.classList.add("ui_title"),M.domElement.prepend(s);const u=document.createElement("div");u.id="views_list",O.domElement.prepend(u);const c=document.createElement("div");c.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",c.classList.add("ui_title"),O.domElement.prepend(c),fn=O.addFolder("Edit view"),q=fn;const d=document.createElement("li");d.id="edit_view_buttons",d.classList.add("button_list"),q.domElement.children[0].appendChild(d),Oa(d,'<i class="fa-solid fa-pen-nib"></i> Rename',Qa,null,"Rename view"),Oa(d,'<i class="fa-solid fa-xmark"></i> Delete',Ra,"deleteViewButton","Delete view"),mn=q.add(P,"whatToPlot").name("Expression: ").onFinishChange((function(){vo(),Ii(),ka(this.property)})),q.add(P,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){ta(),document.activeElement.blur(),Ii(),ka(this.property)})),q.add(P,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){ki(),Io(),ka(this.property)})).name("Colour map"),_e=q.add(P,"minColourValue").name("Min value").onChange((function(){$i(),Mo(),Ii(),ka(this.property)})),_e.__precision=2,Fe=q.add(P,"maxColourValue").name("Max value").onChange((function(){$i(),Mo(),Ii(),ka(this.property)})),Fe.__precision=2,Ee=q.add(P,"autoSetColourRange").name("Auto snap").onChange((function(){P.autoSetColourRange&&(ma(),Ii()),ka(this.property)})),Ve=q.add(P,"contours").name("Contours").onChange((function(){ki(),ka(this.property)})),Ce=q.add(P,"emboss").name("Lighting").onChange((function(){ki(),ka(this.property)})),q.add(P,"overlay").name("Overlay").onChange((function(){ki(),ka(this.property)}));const f=document.createElement("li");f.id="colour_map_buttons",f.classList.add("button_list"),q.domElement.children[0].appendChild(f),Oa(f,'<i class="fa-solid fa-arrow-right-arrow-left"></i> Reverse',(function(){P.flippedColourmap=!P.flippedColourmap,ki(),Io(),ka("flippedColourmap")}),null,"Reverse colour map"),Oa(f,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){ma(),Ii(),ka("minColourValue"),ka("maxColourValue")}),null,"Snap min/max to visible")}function Ri(){ki(),Io(),vo(),Pi()}function Pi(){let e=sa()+rt(),n="float brushRadius = "+Yi(P.brushRadius.toString())+";\n";switch(n=n.replace(/\buvwq\./g,"uvwqBrush."),n=n.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(P.brushValue)&&(e+=It()),/\bRANDN\b/.test(P.brushValue)&&(e+=Mt()),e+="float brushValue = "+Yi(P.brushValue)+";\n",e+=n,P.typeOfBrush){case"circle":e+=ut();break;case"hline":e+=dt();break;case"vline":e+=ct()}switch(P.brushAction){case"replace":e+=ft(),e+=lt();break;case"add":e+=ft(),e+=st();break;case"smoothreplace":e+=mt(),e+=lt();break;case"smoothadd":e+=mt(),e+=st()}e=function(e){let n=/COLOURSPEC/g;return e=e.replace(n,co(P.whatToDraw)),e}(e),v.fragmentShader=e,v.needsUpdate=!0}function ki(){Q=zt(P.colourmap),P.flippedColourmap&&(Q.reverse(),Q=Q.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),k.colour1.value=new ei.Vector4(...Q[0]),k.colour2.value=new ei.Vector4(...Q[1]),k.colour3.value=new ei.Vector4(...Q[2]),k.colour4.value=new ei.Vector4(...Q[3]),k.colour5.value=new ei.Vector4(...Q[4]);let e=sa()+Lt();console.log(e),P.emboss&&(e+=qt(),Ka()),P.contours&&(e+=Bt(),nr()),P.overlay&&(e+=Gt().replaceAll("OVERLAYEXPR",Yi(P.overlayExpr)),tr()),e+=Ot(),b.fragmentShader=e,b.needsUpdate=!0,C.needsUpdate=!0,R=Q.map((e=>e[3])),Q=Q.map((e=>e.slice(0,-1))),Ii()}function Ni(){switch(P.timesteppingScheme){case"Euler":F.material=Wn.FE,k.textureSource.value=Dn[1].texture,k.textureSource1.value=Dn[2].texture,k.dt.value=P.dt,l.setRenderTarget(Dn[0]),l.render(r,o),Dn.rotate(-1),k.t.value+=P.dt;break;case"AB2":F.material=Wn.AB2,k.textureSource.value=Dn[1].texture,k.textureSource1.value=Dn[2].texture,k.dt.value=P.dt,l.setRenderTarget(Dn[0]),l.render(r,o),Dn.rotate(-1),k.t.value+=P.dt;break;case"Mid":F.material=Wn.Mid1,k.textureSource.value=Dn[1].texture,l.setRenderTarget(Dn[2]),l.render(r,o),F.material=Wn.Mid2,k.textureSource1.value=Dn[2].texture,k.t.value+=.5*P.dt,l.setRenderTarget(Dn[0]),l.render(r,o),Dn.rotate(-1),k.t.value+=.5*P.dt;break;case"RK4":F.material=Wn.RK41,k.textureSource.value=Dn[1].texture,l.setRenderTarget(Dn[2]),l.render(r,o),F.material=Wn.RK42,k.textureSource1.value=Dn[2].texture,k.t.value+=.5*P.dt,l.setRenderTarget(Dn[3]),l.render(r,o),F.material=Wn.RK43,k.textureSource2.value=Dn[3].texture,l.setRenderTarget(Dn[4]),l.render(r,o),F.material=Wn.RK44,k.textureSource3.value=Dn[4].texture,k.t.value+=.5*P.dt,l.setRenderTarget(Dn[0]),l.render(r,o),Dn.rotate(-1)}}function Ii(){if(P.autoSetColourRange&&ma(),P.brushEnabled&&"surface"==P.plotType){let e=(function(){Ho();let e=0;for(let n=0;n<nt.length;n+=4)e+=nt[n];return e/(Cn*Vn)}()-P.minColourValue)/(P.maxColourValue-P.minColourValue)-.5;E.position.y=P.threeDHeightScale*e.clamp(-.5,.5),E.updateWorldMatrix()}if(Mi(),"line"==P.plotType){Ho();let e,n=0;for(let t=0;t<nt.length;t+=4)e=(nt[t]-P.minColourValue)/(P.maxColourValue-P.minColourValue)-.5,T[n++]=e.clamp(-.5,.5);const t=new ei.SplineCurve(W.map(((e,n)=>new ei.Vector2(e,T[n])))),i=t.getSpacedPoints(A);!function(e){let n,t=D.geometry.attributes.instanceStart,i=D.geometry.attributes.instanceEnd;for(let o=0;o<e.length;o++)n=e[o].toArray(),n[1]*=P.threeDHeightScale,o<e.length&&t.setXYZ(o,n[0],n[1],0),o>0&&i.setXYZ(o-1,n[0],n[1],0);t.needsUpdate=!0,i.needsUpdate=!0}(i),function(e){let n,t=D.geometry.attributes.instanceColorStart,i=D.geometry.attributes.instanceColorEnd;for(let o=0;o<e.length;o++)n=ba(e[o].toArray()[1]+.5),o<e.length&&t.setXYZ(o,n[0],n[1],n[2]),o>0&&i.setXYZ(o-1,n[0],n[1],n[2]);t.needsUpdate=!0}(i)}if(P.timeDisplay&&Bo(),P.integrate&&function(){if(P.integrate){let e;Ho(),1==P.dimension?e=k.dx.value:2==P.dimension&&(e=k.dx.value*k.dy.value);let n=0;for(let e=0;e<nt.length;e+=4)n+=nt[e];n*=e,$("#integralValue").html(Lo(n,4)),Xo()}}(),Zo()?(F.material=x,l.setRenderTarget(m),l.render(r,o),k.textureSource.value=m.texture,k.dxUpscaledScale.value=devicePixelRatio*Fn/Cn,k.dyUpscaledScale.value=devicePixelRatio*$n/Vn):(k.dxUpscaledScale.value=1,k.dyUpscaledScale.value=1),l.setRenderTarget(null),l.render(a,i),it){it=!1;var e=document.createElement("a");e.download="VisualPDEScreenshot",l.render(a,i),e.href=l.domElement.toDataURL(),document.body.appendChild(e),e.click(),document.body.removeChild(e),Di(),Ii()}}function Mi(){F.material=C,k.textureSource.value=Dn[1].texture,l.setRenderTarget(f),l.render(r,o),k.textureSource.value=f.texture,ot=!1,k.textureSource1.value=Dn[1].texture}function Li(n){hn=Bi(n,e),hn&&(P.brushEnabled&&"surface"==P.plotType?u.enabled=!1:P.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),ko("#top_message"),window.clearTimeout(Sn),Sn=setTimeout((function(){$("#top_message").hasClass("fading_out")||No("#top_message")}),3e3)))}function Oi(e){hn=!1,"surface"==P.plotType&&(u.enabled=!0)}function qi(n){Bi(n,e)}function Bi(e,n){var t=n.getBoundingClientRect();let o=(e.clientX-t.x)/t.width,a=1-(e.clientY-t.y)/t.height;if("surface"==P.plotType){d.x=2*o-1,d.y=2*a-1,c.setFromCamera(d,i);var r=c.intersectObject(E,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==P.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*Cn)/Cn,a=Math.round(a*Vn)/Vn,k.brushCoords.value=new ei.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function ji(){l.setSize(Cn,Vn,!1),P.fixRandSeed||mo(),Nn&&P.resetFromCheckpoints?F.material=U:F.material=y,Dn.forEach((e=>{l.setRenderTarget(e),l.render(r,o)})),Ea(),Ii()}function Gi(){kn||($("#pause").hide(),$("#play").show()),pn=!1}function zi(){kn||($("#play").hide(),$("#pause").show()),pn=!0}function Ji(){ji(),k.t.value=0,Bo(),Ii(),window.clearTimeout(vn),Jo()}function Hi(){let e="";return e+="float UFUN = "+Yi(P.reactionStrU)+";\n",e+="float VFUN = "+Yi(P.reactionStrV)+";\n",e+="float WFUN = "+Yi(P.reactionStrW)+";\n",e+="float QFUN = "+Yi(P.reactionStrQ)+";\n",e}function Xi(e,n){let t="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return t+="float D"+n+" = "+e,t+="float D"+n+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),t+="float D"+n+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),t+="float D"+n+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),t+="float D"+n+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),t}function Yi(e){if(!Wa(e=" "+e+" "))return" 0.0 ";for(e=ca(e=(e=(e=(e=Zi(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,n,t){switch(t){case"0":return"1";case"1":return"("+n+")";case"2":return"(("+n+")*("+n+"))";case"3":return"(("+n+")*("+n+")*("+n+"))";case"4":return"(("+n+")*("+n+")*("+n+")*("+n+"))";case"5":return"(("+n+")*("+n+")*("+n+")*("+n+")*("+n+"))";default:return"safepow("+n+","+t+")"}}))).replaceAll(RegExp("\\b("+hi[0]+")\\b","g"),(function(e,n){return"uvwq."+co(n)}))).replaceAll(RegExp("\\b("+hi[0]+")_([xy])\\b","g"),(function(e,n,t){return"uvwq"+t.toUpperCase()+"."+co(n)}))).replaceAll(RegExp("\\b("+hi[0]+")_(xx|yy)\\b","g"),(function(e,n,t){return"uvwq"+t.toUpperCase()+"."+co(n)})));e!=(e=e.replace(/([^.0-9])(\d+)([^.0-9])/g,"$1$2.$3")););return e}function Zi(e,n,t){const i="^*".includes(n);if(e.indexOf(n)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,n){return a.push(n),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+n+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+n+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,n){return a[n].replace(o,t)}))}return e}function Ki(){let e="",n="",t="",i="",o="",a="";const r=[P.boundaryConditionsU,P.boundaryConditionsV,P.boundaryConditionsW,P.boundaryConditionsQ],l=[P.neumannStrU,P.neumannStrV,P.neumannStrW,P.neumannStrQ],s=[P.comboStrU,P.comboStrV,P.comboStrW,P.comboStrQ].map((e=>e+";")),u=[P.dirichletStrU,P.dirichletStrV,P.dirichletStrW,P.dirichletStrQ],c=[P.robinStrU,P.robinStrV,P.robinStrW,P.robinStrQ];if(r.forEach((function(n,t){"neumann"==n?(e+=eo(l[t],mi[t]),e+=Na(t)):"combo"==n&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(n){const i=n[1][0].toUpperCase();e+=eo(n[2],mi[t],i),e+=Na(t,i)}))})),r.forEach((function(e,t){"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=function(e,n,t){let i="";i+=uo(Pt(n),mi[e]),P.dimension>1&&(i+=uo(kt(n),mi[e]));return i=i.replaceAll("GHOSTSPECIES",t),i}(t,i,Yi(e[2]))}))})),P.domainViaIndicatorFun){let e=Ut().replace(/indicatorFun/g,Yi(P.domainIndicatorFun));u.forEach((function(n,i){t+=uo(e,mi[i])+Yi(n)+";\n}\n"}))}else r.forEach((function(e,n){"dirichlet"==e?(t+=no(u[n],mi[n]),t+=Ia(n)):"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=no(e[2],mi[n],i),t+=Ia(n,i)}))}));r.forEach((function(e,n){"robin"==e?(i+=eo(c[n],mi[n]),i+=Ma(n)):"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const t=e[1][0].toUpperCase();i+=eo(e[2],mi[n],t),i+=Ma(n,t)}))}));let d=sa();if(o=function(){let e="";return e+=Xi(Yi(P.diffusionStrUU)+";\n","uu"),e+=Xi(Yi(P.diffusionStrVV)+";\n","vv"),e+=Xi(Yi(P.diffusionStrWW)+";\n","ww"),e+=Xi(Yi(P.diffusionStrQQ)+";\n","qq"),e}()+"\n",P.crossDiffusion?o+=function(){let e="";return e+=Xi(Yi(P.diffusionStrUV)+";\n","uv"),e+=Xi(Yi(P.diffusionStrUW)+";\n","uw"),e+=Xi(Yi(P.diffusionStrUQ)+";\n","uq"),e+=Xi(Yi(P.diffusionStrVU)+";\n","vu"),e+=Xi(Yi(P.diffusionStrVW)+";\n","vw"),e+=Xi(Yi(P.diffusionStrVQ)+";\n","vq"),e+=Xi(Yi(P.diffusionStrWU)+";\n","wu"),e+=Xi(Yi(P.diffusionStrWV)+";\n","wv"),e+=Xi(Yi(P.diffusionStrWQ)+";\n","wq"),e+=Xi(Yi(P.diffusionStrQU)+";\n","qu"),e+=Xi(Yi(P.diffusionStrQV)+";\n","qv"),e+=Xi(Yi(P.diffusionStrQW)+";\n","qw"),e}()+"\n"+Et():o+=$t(),Zn&&P.crossDiffusion&&(a+=uo(Dt(),mi[1])),Kn&&P.crossDiffusion&&(a+=uo(Dt(),mi[2])),et&&P.crossDiffusion&&(a+=uo(Dt(),mi[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void alert("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let f=[Tt(),Qt(),e,n,i,At(),Rt(),Hi(),o].join(" "),m=/\bRAND\b/.test(f),p=/\bRANDN\b/.test(f);m&&(f=It()+f),p&&(f=Mt()+f),Qn=m||p;let h=[t,a,Ct()].join(" "),g="FE";Wn[g].fragmentShader=[d,wt(g),f,Nt(g),h].join(" "),g="AB2",Wn[g].fragmentShader=[d,wt(g),f,Nt(g),h].join(" "),g="Mid";for(let e=1;e<3;e++)Wn[g+e.toString()].fragmentShader=[d,wt(g+e.toString()),f,Nt(g+e.toString()),h].join(" ");g="RK4";for(let e=1;e<5;e++)Wn[g+e.toString()].fragmentShader=[d,wt(g+e.toString()),f,Nt(g+e.toString()),h].join(" ");if(Object.keys(Wn).forEach((e=>Wn[e].needsUpdate=!0)),bn=P.domainViaIndicatorFun||"dirichlet"==P.boundaryConditionsU||"dirichlet"==P.boundaryConditionsV||"dirichlet"==P.boundaryConditionsW||"dirichlet"==P.boundaryConditionsQ||/Dirichlet/.test(P.comboStrU)||/Dirichlet/.test(P.comboStrV)||/Dirichlet/.test(P.comboStrW)||/Dirichlet/.test(P.comboStrQ),bn){if(t=d+Wt(),P.domainViaIndicatorFun){let e=Ut().replace(/indicatorFun/g,Yi(P.domainIndicatorFun)).replace(/updated/g,"gl_FragColor");u.forEach((function(n,i){t+=uo(e,mi[i])+Yi(n)+";\n}\n"}))}else r.forEach((function(e,n){"dirichlet"==e?(t+=no(u[n],mi[n]),t+=La(n)):"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=no(e[2],mi[n],i),t+=La(n,i)}))}));t+="}",S.fragmentShader=t,S.needsUpdate=!0}}function eo(e,n,t){return null==t?["L","R","T","B"].map((t=>eo(e,n,t))).join(""):"float robinRHS"+n+t+" = "+Yi(e)+";\n"}function no(e,n,t){return null==t?["L","R","T","B"].map((t=>no(e,n,t))).join(""):"float dirichletRHS"+n+t+" = "+Yi(e)+";\n"}function to(e){io("default"),io(e),null!=P.threeD&&(P.threeD&&(P.dimension=2,P.plotType="surface"),delete P.threeD),null!=P.oneDimensional&&(P.oneDimensional&&(P.dimension=1,P.plotType="line"),delete P.oneDimensional),P.domainScale*=On,function(){if(0==P.views.length){let e=Pa();e.name="1",P.views.push(e)}else P.views=P.views.map((function(e){let n=Pa();return Object.assign(n,e),n}));yn=P.views}(),ao(M,!0),ao(L,!0),ao(O,!0),Qi(),P.activeViewInd<P.views.length?Aa(P.views[P.activeViewInd],!1):Aa({},!0),Uo(),Ai(),Ui(),$i(),a.background=new ei.Color(P.backgroundColour),""!=P.initialState?fetch(P.initialState).then((e=>e.blob())).then((e=>_a(e))):Ji(),Fi(),cn.remove(),dn.remove(),bo(),Yo()}function io(e){let n;if(n=null==e?Ht(P.preset):"string"==typeof e?Ht(e):"object"==typeof e?e:Ht("default"),n.hasOwnProperty("parent")&&null!=n.parent&&io(n.parent),Gn=0,Bn=[],qn={},Object.assign(P,n),ha(!0),pn=P.runningOnLoad,pn?zi():Gi(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?P.tryClickingText=P.tryClickingText.replaceAll("clicking","tapping"):P.tryClickingText=P.tryClickingText.replaceAll("tapping","clicking"),P.brushRadius=P.brushRadius.toString(),P.hasOwnProperty("drawIn3D")&&(P.brushEnabled=P.drawIn3D),mi.includes("T")||Object.keys(P).forEach((function(e){Si.includes(e)&&(P[e]=ga(P[e],["T"],["I_T"],"[RGBA]"))})),!mi.includes("S")){Object.keys(P).forEach((function(e){Si.includes(e)&&(P[e]=ga(P[e],["S"],["I_S"],"[RGBA]"))}));var t=0;t+=P.hasOwnProperty("algebraicV"),t+=P.hasOwnProperty("algebraicW"),(t+=P.hasOwnProperty("algebraicQ"))&&!P.numAlgebraicSpecies&&(P.numAlgebraicSpecies=t),delete P.algebraicV,delete P.algebraicW,delete P.algebraicQ,null==P.minColourValue&&(P.minColourValue=0),null==P.maxColourValue&&(P.maxColourValue=1),I=P}let i=[P.clearValueU,P.clearValueV,P.clearValueW,P.clearValueQ,P.domainIndicatorFun,P.reactionStrU,P.reactionStrV,P.reactionStrW,P.reactionStrQ,P.diffusionStrUU,P.diffusionStrUV,P.diffusionStrUW,P.diffusionStrUQ,P.diffusionStrVU,P.diffusionStrVV,P.diffusionStrVW,P.diffusionStrVQ,P.diffusionStrWU,P.diffusionStrWV,P.diffusionStrWW,P.diffusionStrWQ,P.diffusionStrQU,P.diffusionStrQV,P.diffusionStrQW,P.diffusionStrQQ,P.dirichletStrU,P.dirichletStrV,P.dirichletStrW,P.dirichletStrQ,P.robinStrU,P.robinStrV,P.robinStrW,P.robinStrQ,P.comboStrU,P.comboStrV,P.comboStrW,P.comboStrQ,P.neumannStrU,P.neumannStrV,P.neumannStrW,P.neumannStrQ,P.brushValue,P.whatToPlot].join(" ");P.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(i)}function oo(e,n){if(null==n&&(n=!0),null!=e){for(let n in e.__folders)oo(e.__folders[n],!1);for(let n=0;n<e.__controllers.length;n++)e.__controllers[n].updateDisplay()}n&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function ao(e,n){if(null!=e){for(let n in e.__folders)ao(e.__folders[n]),e.removeFolder(e.__folders[n]);for(let n=0;n<e.__controllers.length;n++)e.__controllers[n].remove();null!=n&&n&&(e.domElement.remove(),e.destroy())}}function ro(e){null!=e&&(e.__li.style.display="none")}function lo(e){null!=e&&(e.__li.style.display="")}function so(e,n,t){null!=e&&(e.name(n),null!=t&&e.title(t))}function uo(e,n){if(0==n.length)return"";let t=/\bSPECIES\b/g,i=co(n);return e=e.replace(t,i),t=/\brobinRHSSPECIES/g,e=e.replace(t,"robinRHS"+n),t=/\bdirichletRHSSPECIES/g,e=e.replace(t,"dirichletRHS"+n)}function co(e){return"rgba"[function(e){return mi.indexOf(e)}(e)]}function fo(){"dirichlet"==P.boundaryConditionsU?lo(je):ro(je),"dirichlet"==P.boundaryConditionsV?lo(Ge):ro(Ge),"dirichlet"==P.boundaryConditionsW?lo(ze):ro(ze),"dirichlet"==P.boundaryConditionsQ?lo(Je):ro(Je),"neumann"==P.boundaryConditionsU?lo(Ke):ro(Ke),"neumann"==P.boundaryConditionsV?lo(en):ro(en),"neumann"==P.boundaryConditionsW?lo(nn):ro(nn),"neumann"==P.boundaryConditionsQ?lo(tn):ro(tn),"robin"==P.boundaryConditionsU?lo(an):ro(an),"robin"==P.boundaryConditionsV?lo(rn):ro(rn),"robin"==P.boundaryConditionsW?lo(ln):ro(ln),"robin"==P.boundaryConditionsQ?lo(sn):ro(sn),"combo"==P.boundaryConditionsU?lo(He):ro(He),"combo"==P.boundaryConditionsV?lo(Xe):ro(Xe),"combo"==P.boundaryConditionsW?lo(Ye):ro(Ye),"combo"==P.boundaryConditionsQ?lo(Ze):ro(Ze),P.domainViaIndicatorFun?(ro(Le),ro(Oe),ro(qe),ro(Be)):lo(Le)}function mo(){k.seed.value=performance.now()%1e6/1e6}function po(){let e=sa()+Kt(),n=[P.clearValueU,P.clearValueV,P.clearValueW,P.clearValueQ].join(" ");/\bRAND\b/.test(n)&&(e+=It()),/\bRANDN\b/.test(n)&&(e+=Mt()),e+="float u = "+Yi(P.clearValueU)+";\n",e+="float v = "+Yi(P.clearValueV)+";\n",e+="float w = "+Yi(P.clearValueW)+";\n",e+="float q = "+Yi(P.clearValueQ)+";\n",e+=Zt(),y.fragmentShader=e,y.needsUpdate=!0}function ho(){let e=new Image;e.src=cn.__image.src;let n=new ei.Texture;n.image=e,e.onload=function(){n.needsUpdate=!0,k.imageSourceOne.value=n,P.resetOnImageLoad&&Ji()}}function go(){let e=new Image;e.src=dn.__image.src;let n=new ei.Texture;n.image=e,e.onload=function(){n.needsUpdate=!0,k.imageSourceTwo.value=n,P.resetOnImageLoad&&Ji()},n.dispose()}function bo(){q=un,cn=q.addImage(P,"imagePathOne").name("$I_S(x,y)$").onChange(ho),dn=q.addImage(P,"imagePathTwo").name("$I_T(x,y)$").onChange(go),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function vo(){"MAX"==P.whatToPlot?(C.fragmentShader=gt()+vt().replace(/indicatorFun/g,Yi(P.domainIndicatorFun))+bt(),C.needsUpdate=!0,P.minColourValue=0,P.maxColourValue=1,$i(),ro(_e),ro(Fe),ro($e),ro(Ee),P.autoSetColourRange=!1,oo(L)):(wo(),lo(_e),lo(Fe),lo($e),lo(Ee)),Io(),jo(),Ii()}function So(e,n){return Object.fromEntries(Object.entries(e).filter((([e,t])=>JSON.stringify(n[e])!==JSON.stringify(t))))}function yo(){Ho();let e=1/0,n=-1/0;for(let t=0;t<nt.length;t+=4)e=Math.min(e,nt[t]),n=Math.max(n,nt[t]);return[e,n]}function wo(){let e=sa()+pt();e+=ht(),e=function(e){return e.replace(/FUN/g,Yi(P.whatToPlot))}(e),P.domainViaIndicatorFun&&(e+=vt().replace(/indicatorFun/g,Yi(P.domainIndicatorFun))),C.fragmentShader=e+bt(),C.needsUpdate=!0}function Co(){P.numAlgebraicSpecies=Math.min(parseInt(P.numAlgebraicSpecies),parseInt(P.numSpecies)-1),Zn=P.numAlgebraicSpecies>=P.numSpecies-1,Kn=P.numAlgebraicSpecies>=P.numSpecies-2&&P.numSpecies>=3,et=P.numAlgebraicSpecies>=P.numSpecies-3&&P.numSpecies>=4}function Vo(){let e="function of "+mi.slice(0,P.numSpecies).join(", ")+", x, y, t",n=e.replace(" "+mi[1]+",",""),i=e.replace(" "+mi[2]+",",""),o=e.replace(" "+mi[3]+",","");switch(1==P.dimension&&(e=e.replace(" y,","")),P.crossDiffusion&&parseInt(P.numSpecies)>1?(Mn||pa(H,Array.from(Array(parseInt(P.numSpecies)).keys())),lo(H)):ro(H),P.numSpecies>1?lo(X):ro(X),ro(K),ro(te),ro(ie),ro(G),ro(Ne),ro(Oe),ro(ee),ro(oe),ro(re),ro(le),ro(se),ro(z),ro(Ie),ro(qe),ro(ne),ro(ae),ro(ue),ro(ce),ro(de),ro(fe),ro(me),ro(J),ro(Me),ro(Be),parseInt(P.numSpecies)){case 4:P.crossDiffusion?(lo(ne),lo(ae),lo(ue),lo(ce),lo(de),lo(fe)):(ro(ue),ro(ce),ro(ae),ro(ne),ro(de),ro(fe)),lo(me),lo(J),lo(Me),lo(Be);case 3:P.crossDiffusion?(lo(ee),lo(oe),lo(re),lo(le)):(ro(ee),ro(oe),ro(re),ro(le)),lo(se),lo(z),lo(Ie),lo(qe);case 2:P.crossDiffusion?(lo(K),lo(te)):(ro(K),ro(te)),lo(ie),lo(G),lo(Ne),lo(Oe)}1==P.numSpecies?so(Z,bi.D,e):P.crossDiffusion?(so(Z,bi.Duu,e),so(K,bi.Duv,e),so(ee,bi.Duw,e),so(ne,bi.Duq,e),so(te,bi.Dvu,e),so(ie,bi.Dvv,e),so(oe,bi.Dvw,e),so(ae,bi.Dvq,e),so(re,bi.Dwu,e),so(le,bi.Dwv,e),so(se,bi.Dww,e),so(ue,bi.Dwq,e),so(ce,bi.Dqu,e),so(de,bi.Dqv,e),so(fe,bi.Dqw,e),so(me,bi.Dqq,e)):(so(Z,bi.Du,e),so(ie,bi.Dv,e),so(se,bi.Dw,e),so(me,bi.Dq,e)),so(j,bi.UFUN,e),so(G,bi.VFUN,e),so(z,bi.WFUN,e),so(J,bi.QFUN,e),Zn&&(so(te,bi.Dvu,n),so(oe,bi.Dvw,n),so(ae,bi.Dvq,n),so(G,bi.VFUN,n),ro(ie)),Kn&&(so(re,bi.Dwu,o),so(le,bi.Dwv,o),so(ue,bi.Dwq,o),so(z,bi.WFUN,o),ro(se)),et&&(so(ce,bi.Dqu,i),so(de,bi.Dqv,i),so(fe,bi.Dqw,i),so(J,bi.QFUN,i),ro(me)),so(Le,bi.u),so(Oe,bi.v),so(qe,bi.w),so(Be,bi.q),so(je,bi.uD),so(Ge,bi.vD),so(ze,bi.wD),so(Je,bi.qD),so(Ke,bi.uN),so(en,bi.vN),so(nn,bi.wN),so(tn,bi.qN),so(an,bi.uN),so(rn,bi.vN),so(ln,bi.wN),so(sn,bi.qN),so(ke,bi.uInit),so(Ne,bi.vInit),so(Ie,bi.wInit),so(Me,bi.qInit),P.domainViaIndicatorFun?lo(Y):ro(Y),fo(),"surface"==P.plotType?(ro(Ve),lo(Ce),ro(ge),lo(be),lo(ve),lo(Se),lo(ye)):"line"==P.plotType?(ro(Ve),ro(Ce),lo(ge),lo(be),ro(ve),ro(Se),ro(ye)):(lo(Ve),lo(Ce),ro(ge),ro(be),ro(ve),ro(Se),ro(ye)),Io(),qo(),jo(),$("#dataContainer").show(),"line"==P.plotType?(ro(B),$(":root").css("--ui-button-outline","black")):(lo(B),$(":root").css("--ui-button-outline","white")),t?ro(we):lo(we),pa(he,mi.slice(0,P.numSpecies)),De.slider.style.setProperty("--value",P.embossShiny),We.slider.style.setProperty("--value",P.embossSmoothness),Te.slider.style.setProperty("--value",P.embossAmbient),Ae.slider.style.setProperty("--value",P.embossDiffuse),Qe.slider.style.setProperty("--value",P.embossSpecular),Re.slider.style.setProperty("--value",P.embossTheta),Pe.slider.style.setProperty("--value",P.embossPhi),Ta(),oo(M),oo(L),oo(O)}function xo(){let e;switch(Co(),P.domainViaIndicatorFun&&(P.boundaryConditionsU="dirichlet",P.boundaryConditionsV="dirichlet",P.boundaryConditionsW="dirichlet",P.boundaryConditionsQ="dirichlet"),parseInt(P.numSpecies)){case 1:P.crossDiffusion=!1,P.whatToDraw=mi[0],P.whatToPlot=mi[0],P.diffusionStrUV="0",P.diffusionStrUW="0",P.diffusionStrUQ="0",P.diffusionStrVU="0",P.diffusionStrVV="0",P.diffusionStrVW="0",P.diffusionStrVQ="0",P.diffusionStrWU="0",P.diffusionStrWV="0",P.diffusionStrWW="0",P.diffusionStrWQ="0",P.diffusionStrQU="0",P.diffusionStrQV="0",P.diffusionStrQW="0",P.diffusionStrQQ="0",P.boundaryConditionsV="periodic",P.clearValueV="0",P.reactionStrV="0",P.boundaryConditionsW="periodic",P.clearValueW="0",P.reactionStrW="0",P.boundaryConditionsQ="periodic",P.clearValueQ="0",P.reactionStrQ="0",e=new RegExp("\\b("+hi[1]+")\\b"),e.test(P.reactionStrU)&&(P.reactionStrU="0");break;case 2:P.whatToDraw==mi[2]|P.whatToDraw==mi[3]&&(P.whatToDraw=mi[0]),P.whatToPlot==mi[2]|P.whatToPlot==mi[3]&&(P.whatToPlot=mi[0]),P.diffusionStrUW="0",P.diffusionStrUQ="0",P.diffusionStrVW="0",P.diffusionStrVQ="0",P.diffusionStrWU="0",P.diffusionStrWV="0",P.diffusionStrWW="0",P.diffusionStrWQ="0",P.diffusionStrQU="0",P.diffusionStrQV="0",P.diffusionStrQW="0",P.diffusionStrQQ="0",P.boundaryConditionsW="periodic",P.clearValueW="0",P.reactionStrW="0",P.boundaryConditionsQ="periodic",P.clearValueQ="0",P.reactionStrQ="0",e=new RegExp("\\b("+hi[2]+")\\b"),e.test(P.reactionStrU)&&(P.reactionStrU="0"),e.test(P.reactionStrV)&&(P.reactionStrV="0");break;case 3:P.whatToDraw==mi[3]&&(P.whatToDraw=mi[0]),P.whatToPlot==mi[3]&&(P.whatToPlot=mi[0]),P.diffusionStrUQ="0",P.diffusionStrVQ="0",P.diffusionStrWQ="0",P.diffusionStrQU="0",P.diffusionStrQV="0",P.diffusionStrQW="0",P.diffusionStrQQ="0",P.boundaryConditionsQ="periodic",P.clearValueQ="0",P.reactionStrQ="0",e=new RegExp("\\b("+hi[3]+")\\b"),e.test(P.reactionStrU)&&(P.reactionStrU="0"),e.test(P.reactionStrV)&&(P.reactionStrV="0"),e.test(P.reactionStrW)&&(P.reactionStrW="0")}switch(Yn){case 3:P.diffusionStrVV="0";break;case 6:P.diffusionStrWW="0";break;case 7:P.diffusionStrVV="0",P.diffusionStrWW="0";break;case 10:P.diffusionStrQQ="0";break;case 11:P.diffusionStrWW="0",P.diffusionStrQQ="0";break;case 12:P.diffusionStrVV="0",P.diffusionStrWW="0",P.diffusionStrQQ="0"}oo(M),oo(L)}function Uo(){!function(){switch(Co(),parseInt(P.numSpecies)){case 1:Yn=0;break;case 2:Yn=P.crossDiffusion?1==P.numAlgebraicSpecies?3:2:1;break;case 3:if(P.crossDiffusion)switch(P.numAlgebraicSpecies){case 0:Yn=5;break;case 1:Yn=6;break;case 2:Yn=7}else Yn=4;break;case 4:if(P.crossDiffusion)switch(P.numAlgebraicSpecies){case 0:Yn=9;break;case 1:Yn=10;break;case 2:Yn=11;break;case 3:Yn=12}else Yn=8}}(),ta(),ia(),xo(),Vo(),function(){const e=ra().split(";");let n=!1;for(const t of e)n|=la(t)}(),ua(),_o(),Ji()}function _o(){let e,n=gi[Yn];const t={D:/\b(D) (\\vnabla u)/g,U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(P.typesetCustomEqs){let o={};o.D=P.diffusionStrUU,o.U=P.diffusionStrUU,o.UU=P.diffusionStrUU,o.V=P.diffusionStrVV,o.VV=P.diffusionStrVV,o.W=P.diffusionStrWW,o.WW=P.diffusionStrWW,o.Q=P.diffusionStrQQ,o.QQ=P.diffusionStrQQ,o.UV=P.diffusionStrUV,o.UW=P.diffusionStrUW,o.UQ=P.diffusionStrUQ,o.VU=P.diffusionStrVU,o.VW=P.diffusionStrVW,o.VQ=P.diffusionStrVQ,o.WU=P.diffusionStrWU,o.WV=P.diffusionStrWV,o.WQ=P.diffusionStrWQ,o.QU=P.diffusionStrQU,o.QV=P.diffusionStrQV,o.QW=P.diffusionStrQW,o.UFUN=P.reactionStrU,o.VFUN=P.reactionStrV,o.WFUN=P.reactionStrW,o.QFUN=P.reactionStrQ;var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!Wa(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=ga(o[e],mi,zn,"_[xy]")})),Tn.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){Jn.includes(e)||(n=function(e,n,t,i){let o=t.replace(/\s+/g,"  ").trim();if("0"==o||"0.0"==o)return e.replaceAll(n,"");if("1"==o||"1.0"==o)return e.replaceAll(n,"$2");if("-1"==o||"-1.0"==o)return e.replaceAll(n,"-$2");if(t.match(/[a-zA-Z]/))return t.match(/[\+-]/)&&null!=i?e.replaceAll(n,i[0]+t+i[1]+"$2"):e.replaceAll(n,t+"$2");return e}(n,t[e],o[e],"[]"))})),n=na(n,t.UFUN,o.UFUN),n=na(n,t.VFUN,o.VFUN),n=na(n,t.WFUN,o.WFUN),n=na(n,t.QFUN,o.QFUN),e=/\(\s*\+/g;n!=(n=n.replace(e,"(")););for(e=/\[\s*\+/g;n!=(n=n.replace(e,"[")););for(e=/\+\s*\)/g;n!=(n=n.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,n=n.replaceAll(e,""),e=/=\s*\+/g,n=n.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,n=n.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,n=n.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,n=n.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\((D_\{\w+(?: \w+)?\})\s*\\vnabla\s*([uvwq])\s*\)/g,n=n.replaceAll(e,"$1 \\lap $2"),e=/\\vnabla\s*\\cdot\s*\(([\w\{\}\*\^]*)\s*\\vnabla\s*([uvwq])\s*\)/g,n=n.replaceAll(e,(function(e,n,t){return/\b[xy]|[uvwq]\b/g.test(n)?e:n+" \\lap "+t})),e=/\b([uvwq])_([xy])\b/g,n=n.replaceAll(e,"\\textstyle \\pd{$1}{$2}"),e=/\b([uvwq])_(xx|yy)\b/g,n=n.replaceAll(e,(function(e,n,t){return"\\textstyle \\pdd{"+n+"}{"+t[0]+"}"})),e=/\bRAND\b/g,n=n.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,n=n.replaceAll(e,"\\mathcal{Z}")}else Tn.forEach((function(e){n=n.replaceAll(t[e],(function(e,n,t){let i="\\selected{ "+n+" ";return"string"==typeof t&&(i+=t),i+" }"}))})),n=ga(n,["UFUN","VFUN","WFUN","QFUN"],pi,"_[xy]");1==P.dimension&&(n=n.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,n=n.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,n=n.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),n=ga(n,zn.concat(Jn),mi.concat(pi),"_[xy]"),n=Fo(n),$("#typeset_equation").html(n),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(da)}function Fo(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=$o(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=$o(e,"cos",!0),e=$o(e,"tan",!0),e=$o(e,"exp",!0),e=$o(e,"log",!0),e=$o(e,"sqrt",!1),e=$o(e,"sinh",!0),e=$o(e,"cosh",!0),e=$o(e,"tanh",!0),e=$o(e,"max",!0),e=Zi(e=(e=$o(e,"min",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=function(e){const n=["(","["],t=[")","]"];let i=0,o=0,a=0,r="",l="";for(var s=0;s<e.length;s++)n.includes(e[s])?(i+=1,o+=1):t.includes(e[s])&&(i-=1),0==i&&o>0&&(r=e.slice(a,s+1),l+=Eo(r,o),o=0,a=s+1);return l+=e.slice(a),l}(e=fi(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")}function $o(e,n,t){var i=e;const o=e.matchAll(new RegExp("\\b"+n+"\\b","g"));let a,r,l,s,u,c,d,f=0;for(const m of o){for(a=m.index,r=a+n.length,s=e.slice(r),d=0,u=0,c=!1;d<=s.length&(!c|!(c&&0==u));)u+=["(","["].includes(s[d]),u-=[")","]"].includes(s[d]),c|=u,d+=1;c&&0==u&&(l=d-1+r,i=To(i,"\\",a+f),f+=1,t?(i=To(i,"{",r+f),f+=1,i=To(i,"}",l+1+f),f+=1):(i=Wo(i,"{",r+f),i=Wo(i,"}",l+f)))}return i}function Eo(e,n){const t=["(","["],i=[")","]"];let o=Do(1-n,t.length);for(var a=0;a<e.length;a++)t.includes(e[a])?(e=Wo(e,t[o],a),o+=1,o=Do(o,t.length)):i.includes(e[a])&&(o-=1,o=Do(o,t.length),e=Wo(e,i[o],a));return e}function Do(e,n){return(e%n+n)%n}function Wo(e,n,t){return e.slice(0,t)+n+e.slice(t+1,e.length)}function To(e,n,t){return e.slice(0,t)+n+e.slice(t,e.length)}function Ao(e){return e=e.replace(/\s+/g,"  ").trim()}function Qo(e,n){let t;function i(){t.hasOwnProperty("slider")&&(t.slider.remove(),delete t.slider,t.domElement.closest("li").classList.remove("parameterSlider"));let n=qn[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(n){let i;t.domElement.parentElement.parentElement.classList.add("parameterSlider"),t.slider=document.createElement("input"),t.slider.classList.add("styled-slider"),t.slider.classList.add("slider-progress"),t.slider.type="range",t.slider.min=n[3],t.slider.max=n[5],null==n[4]?(n[4]="",!qn[e].includes(".")&parseFloat(n[5])-parseFloat(n[3])>1?i=1:(t.slider.precision=Math.max(parseFloat(n[2]).countDecimals(),parseFloat(n[3]).countDecimals(),parseFloat(n[5]).countDecimals())+1,i=Math.min((parseFloat(n[5])-parseFloat(n[3]))/20,10**-t.slider.precision))):(t.slider.precision=Math.max(parseFloat(n[2]).countDecimals(),parseFloat(n[3]).countDecimals(),parseFloat(n[4]).countDecimals(),parseFloat(n[5]).countDecimals())+1,i=n[4],n[4]+=", "),t.slider.step=i.toString(),t.slider.value=n[2],t.slider.addEventListener("input",(function(){t.slider.style.setProperty("--value",t.slider.value);qn[e]=qn[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,n[1]+" = "+parseFloat(t.slider.value).toFixed(t.slider.precision).toString()+" "),oo(En),Ro(),Ii(),(la(qn[e])||Pn)&&(Pn=!1,ua())})),t.__oldOnFinishChange=t.onFinishChange,t.onFinishChange=function(){t.__oldOnFinishChange(),t.slider.value=n[2]},t.slider.style.setProperty("--value",t.slider.value),t.slider.style.setProperty("--min",t.slider.min),t.slider.style.setProperty("--max",t.slider.max),t.domElement.appendChild(t.slider)}}if(n)Bn.push(e),qn[e]="",t=En.add(qn,e).name(""),t.domElement.classList.add("params"),t.onFinishChange((function(){const n=Bn.indexOf(e);let t=Ao(qn[Bn.at(n)]);if(""==t);else{let e=Qo(Bn.at(n),!1);const i=t.match(/\s*(\w+)\s*=/);i&&(e.lastName=i[1],jn[e.lastName]=e),Gn+=1;let o="params"+Gn;this.remove(),Qo(o,!0),Ro(),(la(t)||Pn)&&(Pn=!1,ua())}}));else{t=En.add(qn,e).name(""),t.domElement.classList.add("params");const n=qn[e].match(/\s*(\w+)\s*=/);n&&(t.lastName=n[1],jn[t.lastName]=t),t.onFinishChange((function(){let n=Ao(qn[e]);if(""==n){t.domElement.closest("li").hasOwnProperty("parameterSlider")&&(t.slider.remove(),t.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const n=Bn.indexOf(e);Bn.splice(n,1),delete qn[e],t.hasOwnProperty("lastName")&&delete k[t.lastName]}else{i();const e=ca(n).match(/\s*(\w+)\s*=/);e&&t.hasOwnProperty("lastName")&&t.lastName!=e[1]&&(delete k[t.lastName],t.lastName=e[1],jn[t.lastName]=t)}Ro(),la(n)&&ua()}))}return i(),t}function Ro(){P.kineticParams=Object.values(qn).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function Po(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function ko(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function No(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function Io(){if(P.colourbar){$("#colourbar").show();let n="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)n+="rgb("+ba(e).map((e=>255*e))+") "+100*e+"%,";n=n.slice(0,-1)+")",$("#colourbar").css("background",n),"MAX"==P.whatToPlot?($("#minLabel").html("$"+mi[0]+"$"),$("#midLabel").html("$"+mi[1]+"$"),$("#maxLabel").html("$"+mi[2]+"$")):An?$("#midLabel").html(P.views[P.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+Fo(P.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),aa(),Mo()}else $("#colourbar").hide()}function Mo(){if("MAX"!=P.whatToPlot){let e,n;[e,n]=function(e,n){const t=3;if(Math.abs(e)<.001&&Math.abs(n)<.001)return[e.toExponential(t-1),n.toExponential(t-1)];return[Oo(e,t),Oo(n,t)]}(P.minColourValue,P.maxColourValue);const t=/[1-9]/;t.test(e)||(e="0"),t.test(n)||(n="0"),$("#minLabel").html(e),$("#maxLabel").html(n)}let e=fa(ba(0)),n=fa(ba(.5)),t=fa(ba(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),n<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),t<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function Lo(e,n){return e.toPrecision(n)}function Oo(e,n){const t=e.toFixed(n),i=e.toPrecision(n);return t.length<i.length?t:i}function qo(){P.timeDisplay?($("#timeDisplay").show(),Bo()):$("#timeDisplay").hide(),zo()}function Bo(){if(P.timeDisplay){let e=Lo(k.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/,"  10<sup>$2$3<sup>"),$("#timeValue").html(e),Xo()}}function jo(){if(P.integrate){$("#integralDisplay").show();let e="";1==P.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+Fo(P.whatToPlot)+"\\,\\d x",1==P.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();zo()}function Go(e,n){$(e).css("bottom",""),$(e).css("bottom","+="+n.toString())}function zo(){P.integrate&&P.timeDisplay?Go("#timeDisplay",10):Go("#timeDisplay",0)}function Jo(){let e=yo();isFinite(e[0])&&isFinite(e[1])?vn=setTimeout(Jo,1e3):(ko("#oops_hit_nan"),Gi(),$("#erase").one("click",(()=>No("#oops_hit_nan"))))}function Ho(){if(!ot){try{l.readRenderTargetPixels(f,0,0,Cn,Vn,nt)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}ot=!0}}function Xo(){if(P.colourbar&&P.integrate|P.timeDisplay){let e,n=$("#colourbar")[0].getBoundingClientRect();e=P.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let t=e.getBoundingClientRect();n.right>=t.left?n.top<=t.bottom&&(Go("#dataContainer",40),Rn=!0):Rn&&(Go("#dataContainer",0),Rn=!1)}}function Yo(){Zo()?(Dn.forEach((e=>{e.texture.magFilter=ei.NearestFilter})),f.texture.magFilter=ei.NearestFilter,m.texture.magFilter=ei.NearestFilter):(Dn.forEach((e=>{e.texture.magFilter=ei.LinearFilter})),f.texture.magFilter=ei.LinearFilter,m.texture.magFilter=ei.LinearFilter),Vo(),Ii()}function Zo(){return t||P.forceManualInterpolation}function Ko(e,n,t){return new Promise((function(i,o){var a=o=>{e.removeEventListener(n,a),i(t)};e.addEventListener(n,a)}))}function ea(e,n){return null==n&&(n=[]),function(e){return[...(wt()+Et()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e)}(n).some((function(n){return new RegExp("\\b"+n+"\\b","g").test(e)}))}function na(e,n,t){return"0"==t.replace(/\s+/g,"  ").trim()?e.replaceAll(n,""):t.match(/[a-zA-Z]/)?e.replaceAll(n,t):e}function ta(){"line"==P.plotType?(Sa(),P.typeOfBrush="vline",Pi(),oo(L),_.visible=!1,D.visible=!0,P.contours=!1,P.emboss=!1):(_.visible=!0,D.visible=!1,"surface"==P.plotType?(P.contours=!1,$("#simCanvas").css("outline","2px #000 solid"),Ln&&(Ln=!1,_i())):$("#simCanvas").css("outline","")),ki(),Fi(),Vo()}function ia(){1!=P.dimension&&"line"==P.plotType&&(P.plotType="plane",ta()),1==P.dimension&&"line"!=P.plotType&&(P.plotType="line",ta()),Ui(),Ki(),_o(),Vo(),jo()}function oa(){const e=(new ei.Vector3).setFromSphericalCoords(1,Math.PI/2-P.cameraTheta*Math.PI/180,P.cameraPhi*Math.PI/180);i.position.set(e.x,e.y,e.z),i.lookAt(0,0,0)}function aa(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function ra(){let e=P.kineticParams.replaceAll(/\bin[^;]*;?/g,";");return e=ca(e),e}function la(e){const n=e.match(/(\w+)\s*=\s*([\+\-]?)\s*([0-9\.]+)/);let t=!1;return n&&(n[1]=ca(n[1]),ea(n[1])?alert("The name '"+n[1]+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+n[1]+"."):(t=!k.hasOwnProperty(n[1]),k[n[1]]={type:"float",value:parseFloat(n[2]+n[3])})),t}function sa(){return ca(ra().replaceAll(/;?\s*(\w+)\s*=\s*[\+\-]?\s*([0-9\.]+)\s*;?/g,"uniform float $1;\n"))}function ua(){Ki(),po(),Pi(),vo(),Ri(),wo()}function ca(e){let n,t=e;for(let e=0;e<10;e++)for(n=new RegExp("([a-zA-Z_]+)("+e.toString()+")","g");t!=(t=t.replace(n,"$1"+at[e])););return t}function da(){const e=$("#equation_display div mjx-container").children("mjx-math");var n;e.css("font-size","");var t=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);t<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)n=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",n),t+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function fa(e){return e.reduce(((e,n)=>e+n),0)/3}function ma(){let e=yo();if(Math.abs(e[0]-e[1])<.005){const n=(e[0]+e[1])/2;e[0]=n-.0025,e[1]=n+.0025}P.minColourValue=e[0],P.maxColourValue=e[1],k.maxColourValue.value=P.maxColourValue,k.minColourValue.value=P.minColourValue,Fe.updateDisplay(),_e.updateDisplay(),Mo()}function pa(e,n,t){null==t&&(t=n);let i="";for(var o=0;o<n.length;o++){i+="<option value='"+t[o].toString()+"'>"+n[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function ha(e){let n;null!=mi&&(n=mi);const t=P.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,zn.length),i=P.reactionNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,Jn.length),o=t.concat(Hn.slice(t.length)),a=i.concat(Xn.slice(i.length)),r=function(){const e=/(\w+)\s*=\s*([\+\-]?)\s*([0-9\.]+)/;return ra().split(";").filter((e=>e.length>0)).map((n=>n.replace(e,"$1").trim()))}();let l;for(var s=0;s<o.length;s++)if(ea(o[s],r.concat(a)))return l=r.includes(o[s])?"as a parameter":a.includes(o[s])?"as a reaction":"under the hood",void alert("The name '"+o[s]+"' is used "+l+", so can't be used as a species name. Please use a different name for "+o[s]+".");for(s=0;s<a.length;s++)if(ea(a[s],r.concat(o[s])))return l=r.includes(a[s])?"as a parameter":o.includes(a[s])?"as a reaction":"under the hood",void alert("The name '"+a[s]+"' is used "+l+", so can't be used as a function name. Please use a different name for "+a[s]+".");mi=o,pi=a,function(){hi=[];for(let e=0;e<mi.length;e++)hi.push("(?:"+mi.slice(e).sort(((e,n)=>n.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let u={...ui(),...di()};Object.keys(u).forEach((function(e){bi[e]=Fo(ga(u[e],zn,mi,"_[xy]"))})),u=ci(),Object.keys(u).forEach((function(e){bi[e]=Fo(ga(u[e],Jn,pi))})),e||(Object.keys(P).forEach((function(e){Si.includes(e)&&(P[e]=ga(P[e],n,mi,"_[xy]"))})),P.views=P.views.map((function(e){let t={};return t.name=e.name,Object.keys(e).forEach((function(i){Si.includes(i)&&(t[i]=ga(e[i],n,mi,"_[xy]"))})),t})),Object.keys(I).forEach((function(e){Si.includes(e)&&(I[e]=ga(I[e],n,mi,"_[xy]"))})),I.views=I.views.map((function(e){let t={};return t.name=e.name,Object.keys(e).forEach((function(i){Si.includes(i)&&(t[i]=ga(e[i],n,mi,"_[xy]"))})),t})),xo(),Vo(),ua(),_o())}function ga(e,n,t,i){null==i&&(i="");const o=new Array(n.length).fill(0).map(((e,n)=>"PLACE"+n.toString()));let a;for(var r=0;r<n.length;r++)a=new RegExp("\\b("+n[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,t[r]+"$2");return e}function ba(e){e=e.clamp(0,1);let n=0;for(;e>=R[n+1]&&n<Q.length-2;)n+=1;return R[n+1]==R[n]?Q[n]:function(e,n,t){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=va(e[o],n[o],t);return i}(Q[n],Q[n+1],(e-R[n])/(R[n+1]-R[n])).map((e=>e.clamp(0,1)))}function va(e,n,t){return(1-t)*e+t*n}function Sa(){V.linewidth=.01*P.lineWidthMul,V.needsUpdate=!0}function ya(e,n,t){e.domElement.firstChild.onfocus=()=>n(t)}function wa(e,n,t){e.domElement.firstChild.onblur=()=>n(t)}function Ca(e){e.forEach((function(e){Tn.add(e)})),_o()}function Va(e){e.forEach((function(e){Tn.delete(e)})),_o()}function xa(){tt=new Float32Array(Cn*Vn*4),l.readRenderTargetPixels(Dn[1],0,0,Cn,Vn,tt),$a(tt),Nn=!0}function Ua(){Nn||xa();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([Cn,Vn]),tt])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function _a(e){const n=new FileReader;n.onload=function(){const e=new Float32Array(n.result);$a(e.slice(2),e.slice(0,2)),Fa(h),Nn=!0,Ji()},n.readAsArrayBuffer(e)}function Fa(e){if(null!=e)if("crop"==P.resizeCheckpoints){let n=e.source.data.height/e.source.data.width,t=1,i=s/n;i>1&&(t=n/s,i=1),e.repeat.set(t,i),e.offset.set((1-t)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function $a(e,n){null!=h&&h.dispose(),null==n&&(n=[Cn,Vn]),h=new ei.DataTexture(e,n[0],n[1],ei.RGBAFormat,ei.FloatType),h.needsUpdate=!0,h.magFilter=t?ei.NearestFilter:ei.LinearFilter,null!=U&&(U.map=h,U.needsUpdate)}function Ea(){l.setSize(Math.round(devicePixelRatio*Fn),Math.round(devicePixelRatio*$n),!1)}function Da(e){$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),ko("#error"),$("#error").one("click",(function(){No("#error")})))}function Wa(e){if(/\(\s*\)/.test(e))return Da("Empty parentheses in "+e.trim()+"."),!1;let n=0;for(var t=0;t<e.length;t++)"("==e[t]?n+=1:")"==e[t]&&(n-=1);return 0!=n?(Da("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(Da("A binary operator is missing an operand in "+e.trim()+"."),!1)}function Ta(){let e;$("#views_list").empty();for(let n=0;n<P.views.length;n++)e=document.createElement("a"),e.onclick=function(){P.activeViewInd=n,Aa(P.views[n])},e.innerHTML="<div class='view_label'>"+P.views[n].name+"</div>",n==P.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);In=Math.max(P.views.length,In),P.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),P.views.length}function Aa(e,n){Object.assign(P,e),delete P.name,oo(O),(null==n||n)&&(vo(),ta(),ki(),$i(),Mo(),Io(),Ii())}function Qa(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",P.views[P.activeViewInd].name);null!=e&&(P.views[P.activeViewInd].name=e,Ta(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function Ra(){P.views.length>1?(P.views.splice(P.activeViewInd,1),P.activeViewInd<1?P.activeViewInd=0:P.activeViewInd-=1):P.views[P.activeViewInd].name="Custom",Aa(P.views[P.activeViewInd])}function Pa(){let e={};return vi.forEach((function(n){e[n]=I[n]})),e}function ka(e){P.activeViewInd<P.views.length&&(P.views[P.activeViewInd][e]=P[e])}function Na(e,n){let t="";return t+=uo(_t(n),mi[e]),P.dimension>1&&(t+=uo(Ft(n),mi[e])),t}function Ia(e,n){let t="";return t+=uo(Vt(n),mi[e]),P.dimension>1&&(t+=uo(xt(n),mi[e])),t}function Ma(e,n){let t="";return t+=uo(_t(n),mi[e]),P.dimension>1&&(t+=uo(Ft(n),mi[e])),t}function La(e,n){let t="";return t+=uo(Vt(n).replaceAll(/updated/g,"gl_FragColor"),mi[e]),P.dimension>1&&(t+=uo(xt(n).replaceAll(/updated/g,"gl_FragColor"),mi[e])),t}function Oa(e,n,t,i,o){const a=document.createElement("a");null!=t&&(a.onclick=t),null!=i&&(a.id=i),null!=o&&(a.title=o),null!=n&&(a.innerHTML=n),e.appendChild(a)}function qa(){let e=So(P,Ht("default"));e.preset="PRESETNAME";let n=JSON.stringify(e).replaceAll(/\s*,\s*([^0-9-\.\s])/g,",\n\t$1").replaceAll(":",": ").replaceAll("  "," ").replace("{","{\n\t").replace("}",",\n}");n='case "PRESETNAME":\n\toptions = '+n+";\nbreak;",navigator.clipboard.writeText(n)}function Ba(){let n="";n+=JSON.stringify(P),n+=JSON.stringify(k),n+=JSON.stringify({nXDisc:Cn,nYDisc:Vn,domainHeight:Un,domainWidth:xn,aspectRatio:s,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(n)}function ja(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function Ga(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function za(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function Ja(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function Ha(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function Xa(){let e=So(P,Ht("default"));return e.preset="Custom",e=ai(e),[location.href.replace(location.search,""),"?options=",li.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function Ya(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function Za(e){const n=jn[e.data.name];if(null!=n)if(null!=n.slider)n.slider.value=e.data.value,n.slider.dispatchEvent(new Event("input"));else{const t=n.object[n.property].split("=")[0]+"= "+e.data.value.toString();n.setValue(t),n.__onFinishChange(n,t)}}function Ka(){k.embossAmbient.value=P.embossAmbient,k.embossDiffuse.value=P.embossDiffuse,k.embossShiny.value=P.embossShiny,k.embossSmoothness.value=P.embossSmoothness,k.embossSpecular.value=P.embossSpecular,k.embossLightDir.value=new ei.Vector3(Math.sin(P.embossTheta)*Math.cos(P.embossPhi),Math.sin(P.embossTheta)*Math.sin(P.embossPhi),Math.cos(P.embossTheta))}function er(e,n,t,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=n,e.slider.max=t,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function nr(){k.contourColour.value=new ei.Color(P.contourColour),k.contourEpsilon.value=P.contourEpsilon,k.contourStep.value=1/(P.contourNum+1)}function tr(){k.overlayColour.value=new ei.Color(P.overlayColour),k.overlayEpsilon.value=P.overlayEpsilon}function ir(){pn||Ii()}Vi&&to("GrayScott"),An=Ci.has("story"),An&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),fn.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),Io(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),wn=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),(Po()||Vi||P.forceTryClickingPopup)&&!P.suppressTryClickingPopup&&P.brushEnabled&&($("#top_message").html("<p>"+P.tryClickingText+"</p>"),ko("#top_message"),setTimeout((()=>No("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>No("#top_message")))),$("#settings").click((function(){ja(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&Ja(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&Ha(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&Ga(),$("#views_ui").is(":visible")&&za()),$("#left_ui").is(":visible")&&da()})),$("#equations").click((function(){Ga(),da(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&ja(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&za()})),$("#pause").click((function(){Gi()})),$("#play").click((function(){zi()})),$("#erase").click((function(){Ji()})),$("#warning_restart").click((function(){$("#oops_hit_nan").hide(),Ji()})),$("#share").click((function(){Ha(),$("#help_panel").is(":visible")&&Ja()})),$("#help").click((function(){Ja(),$("#share_panel").is(":visible")&&Ha()})),$("#screenshot").click((function(){it=!0,Ii(),Ha()})),$("#link").click((function(){N.copyConfigAsURL(),Ha()})),$("#embed").click((function(){!function(){let e=Xa();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&no_ui"}Ya('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),Ha()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){Ja()})),$("#views").click((function(){za(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&ja(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&Ga()})),$(document).on("click","#add_view",(function(){!function(){let e=Pa();e.name=++In,P.views.push(e),P.activeViewInd=P.views.length-1,Ta()}()})),function e(){requestAnimationFrame(e),gn=hn,hn&&P.brushEnabled&&function(){!P.fixRandSeed&&P.brushValue.includes("RAND")&&mo();F.material=v;for(let e=1;e<Dn.length;e++)k.textureSource.value=Dn[e].texture,l.setRenderTarget(Dn[e-1]),l.render(r,o);Dn.rotate(-1)}();if(pn){!bn||function(){F.material=S;for(let e=1;e<Dn.length;e++)k.textureSource.value=Dn[e].texture,l.setRenderTarget(Dn[e-1]),l.render(r,o);Dn.rotate(-1)}();for(let e=0;e<P.numTimestepsPerFrame;e++)Qn&&!P.fixRandSeed&&mo(),Ni()}(gn||pn)&&Ii()}();