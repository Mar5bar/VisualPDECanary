<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">

  {%- include head.html -%}
  <script src="{{ site.baseurl }}/assets/js/load_manifests.js"></script>
  <link rel="stylesheet" href="{{ site.baseurl }}/assets/css/explore.css">

  <body>

    {%- include header.html -%}

    <main class="page-content" aria-label="Content">
      <div class="wrapper">

        <header class="post-header">
          <h1 class="post-title">{{ page.title }}</h1>
        </header>

        {{ content }}
  

        <h2>Curated collections</h2>
        Looking for a place to start? Check out these curated collections of articles and examples.
        <div class='topic_tiles'>
        </div>
        
        <h2>The library</h2>
        <p>Browse the complete VisualPDE library below, or streamline your search using filters.</p>
        <div class="filter_buttons">
        </div>
        <div id="library" class='topic_tiles'>
          <p id="no_results">Sorry! Nothing in the library matches this combination of filters.</p>
        </div>

      </div>
    </main>

    {%- include footer.html -%}
    {%- include mathjax.html -%}

  </body>

  <script>
    (async () => {
        // Build the list of pages to display.
        let documents;
        if (
        !localStorage.getItem("documents") ||
        !localStorage.getItem("documentsExpiryTime") ||
        parseInt(localStorage.getItem("documentsExpiryTime")) < Date.now()
        ) {
        documents = await getDocs();
        localStorage.setItem(
            "documentsExpiryTime",
            Date.now() + 1000 * 60 * 60 * 24 * 1,
        );
        localStorage.setItem("documents", JSON.stringify(documents));
        } else {
        documents = JSON.parse(localStorage.getItem("documents"));
        }

        // Exclude user guide and topic pages.
        let pages = documents
        .filter((doc) => doc.layout === "page")
        .filter((doc) => doc.url.indexOf("/user-guide/") === -1);

        // Sort the pages by title.
        function removeThePrefix(title) {
        return title.replace(/^The\s/i, "");
        }
        pages.sort((a, b) => removeThePrefix(a.title).localeCompare(removeThePrefix(b.title)));

        // For each page, add a topic tile and store the tags.
        let topicTiles = document.getElementById("library");
        let tags = new Set();
        pages.forEach((page) => {
            let topicTile = document.createElement("a");
            topicTile.classList.add("topic_tile");
            topicTile.href = page.url;
            let topicBanner = document.createElement("div");
            topicBanner.classList.add("topic_banner");
            topicBanner.style.backgroundImage = `url(${page.thumbnail})`;
            topicTile.appendChild(topicBanner);
            let container = document.createElement("div");
            container.classList.add("container");
            let title = document.createElement("div");
            title.classList.add("title");
            title.textContent = page.title;
            container.appendChild(title);
            let subtitle = document.createElement("div");
            subtitle.classList.add("subtitle");
            subtitle.textContent = page.extract;
            container.appendChild(subtitle);
            topicTile.appendChild(container);
            topicTile.tags = page.tags ? new Set(page.tags.map((tag) => tag.toLowerCase())) : new Set();
            tags = tags.union(topicTile.tags);
            topicTiles.appendChild(topicTile);
        });

        // Sort the tags alphabetically.
        tags = new Set(Array.from(tags).sort());
				let activeTags = new Set();

        // For each tag, add a filter button.
				// First, define a function for refreshing the list of pages.
				function refreshLibrary() {
					// Check if no filter buttons are active.
                let noneActive = activeTags.size == 0;
                let somethingShowing = false;
                // Loop through topic tiles and display or hide them.
                document.querySelectorAll(".topic_tile").forEach((tile) => {
                if (noneActive || tile.tags.isSupersetOf(activeTags)) {
                    tile.style.display = "block";
                    somethingShowing = true;
                } else {
                    tile.style.display = "none";
                }
                });
                document.getElementById("no_results").style.display = somethingShowing ? "none" : "block";
                document.getElementById("library").classList.toggle("no_results", !somethingShowing);
                allButton.dataset.active = noneActive;
				}
				
        let container = document.querySelector(".filter_buttons");
				// Create an All button that disables all filters.
				let allButton = document.createElement("button");
				allButton.classList.add("filter_button");
        allButton.id = "allButton"
        allButton.textContent = "All";
        allButton.dataset.active = true;
				allButton.addEventListener("click", () => {
          // Deselect all buttons.
          document.querySelectorAll(".filter_button").forEach((button) => {
            button.dataset.active = false;
          });
          // Clear all active filters.
          activeTags.clear();
          // Enable the All button.
          allButton.dataset.active = true;
          // Refresh the library.
          refreshLibrary();
				});
        container.appendChild(allButton);
				
				// Create filter buttons for each tag.
        tags.forEach((tag) => {
          let filterButton = document.createElement("button");
          filterButton.classList.add("filter_button");
          filterButton.textContent = tag.charAt(0).toUpperCase() + tag.slice(1);
          filterButton.dataset.active = false;
          filterButton.addEventListener("click", () => {
              filterButton.dataset.active = filterButton.dataset.active != "true";
              if (filterButton.dataset.active == "true") {
                  activeTags.add(tag);
              } else {
                  activeTags.delete(tag);
              }
              refreshLibrary();
          });
          container.appendChild(filterButton);
        })
    })();
  </script>

</html>